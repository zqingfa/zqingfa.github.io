<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-linux/advanced/linux-advanced-2">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">第 2 章 Linux 防火墙 - Linux技术分享</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://zhangqf.com/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://zhangqf.com/img/logo.png"><meta data-rh="true" property="og:url" content="https://zhangqf.com/docs/linux-advanced-2"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="第 2 章 Linux 防火墙 - Linux技术分享"><meta data-rh="true" name="description" content="所谓防火墙就是 &quot;防火的墙&quot;，如果过来的是 &quot;火&quot; 就得挡住，如果过来的不是 &quot;火&quot; 就放行，但什么是 &quot;火&quot;，这由人为自行定义。"><meta data-rh="true" property="og:description" content="所谓防火墙就是 &quot;防火的墙&quot;，如果过来的是 &quot;火&quot; 就得挡住，如果过来的不是 &quot;火&quot; 就放行，但什么是 &quot;火&quot;，这由人为自行定义。"><meta data-rh="true" name="keywords" content="linux,Firewall"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://zhangqf.com/docs/linux-advanced-2"><link data-rh="true" rel="alternate" href="https://zhangqf.com/en/docs/linux-advanced-2" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/linux-advanced-2" hreflang="zh"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/linux-advanced-2" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9B0V5WT2X8-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S4SD5NXWXF"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S4SD5NXWXF",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Linux技术分享" href="/opensearch.xml">
<link rel="preconnect" href="https://zhangqf.com/">
<script>var _paq=window._paq=window._paq||[];_paq.push(["setRequestMethod","POST"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),_paq.push(["enableHeartBeatTimer"]),function(){var e="https://zhangqf.com/";_paq.push(["setRequestMethod","POST"]),_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]);var a=document,t=a.createElement("script"),p=a.getElementsByTagName("script")[0];t.type="text/javascript",t.async=!0,t.src=e+"matomo.js",p.parentNode.insertBefore(t,p)}()</script>


<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c9a3849aa75f9c4a4e65f846cd1a5155",e.defer=!0;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<meta name="baidu-site-verification" content="code-rqLUw5reVS">
<script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",t.defer=!0;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script>
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="zhangqf RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="zhangqf Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="zhangqf JSON Feed">

<link rel="icon" href="/img/logo.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(51 139 255)"><link rel="stylesheet" href="/assets/css/styles.86c9ae18.css">
<link rel="preload" href="/assets/js/runtime~main.839460ba.js" as="script">
<link rel="preload" href="/assets/js/main.6b7778c5.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><span>更新 <a href="/website">网址导航</a> 带你发现感兴趣的技术</span></div><button type="button" aria-label="关闭" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">zhangqf</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/linux">Linux</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/category/Linux基础">Linux 基础</a></li><li><a class="dropdown__link" href="/docs/category/Linux进阶">Linux 进阶</a></li><li><a class="dropdown__link" href="/docs/category/Linux测试">Linux 测试</a></li><li><a class="dropdown__link" href="/docs/category/LinuxCICD">Linux CICD研发</a></li><li><a class="dropdown__link" href="/docs/skill/">笔记</a></li><li><a class="dropdown__link" href="/docs/tools/">工具推荐</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Blog</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tags">标签</a></li><li><a class="dropdown__link" href="/archive">归档</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">工具</a><ul class="dropdown__menu"><li><a href="https://api.kuizuo.cn" target="_blank" rel="noopener noreferrer" class="dropdown__link">API服务</a></li><li><a href="https://js-de-obfuscator.vercel.app" target="_blank" rel="noopener noreferrer" class="dropdown__link">JS代码还原</a></li><li><a href="https://cipher.kuizuo.cn" target="_blank" rel="noopener noreferrer" class="dropdown__link">CyberChef加密</a></li><li><a href="https://pan.kuizuo.cn" target="_blank" rel="noopener noreferrer" class="dropdown__link">网盘</a></li></ul></div><a class="navbar__item navbar__link" href="/website">导航</a><a class="navbar__item navbar__link" href="/project">项目</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"><b>zhangqf</b></a><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/linux">linux</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/linux基础">Linux基础</a><button aria-label="打开/收起侧边栏菜单「Linux基础」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/linux进阶">Linux进阶</a><button aria-label="打开/收起侧边栏菜单「Linux进阶」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-1">第 1 章 Linux 进阶命令</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/linux-advanced-2">第 2 章 Linux 防火墙</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-3">第 3 章 Linux NFS 网络文件系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-4">第 4 章 Linux DHCP 服务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-5">第 5 章 Linux DNS 服务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-6">第 6 章 Linux httpd 服务基础配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-7">第 7 章 Linux httpd 服务进阶配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-8">第 8 章 Linux httpd 服务高级配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-9">第 9 章 Linux Nginx 服务配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-10">第 10 章 Linux Tomcat 服务基础配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-11">第 11 章 Linux Tomcat 服务实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-12">第 12 章 Linux haproxy 服务基础配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-13">第 13 章 Linux haproxy 服务进阶配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-14">第 14 章 Linux haproxy 服务高级配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-15">第 15 章 Linux LVS 服务配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-16">第 16 章 Linux Keepalived 服务配置</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/linux测试">Linux测试</a><button aria-label="打开/收起侧边栏菜单「Linux测试」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/linuxcicd">Linux CICD研发</a><button aria-label="打开/收起侧边栏菜单「Linux CICD研发」" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/linux进阶"><span itemprop="name">Linux进阶</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">第 2 章 Linux 防火墙</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>第 2 章 Linux 防火墙</h1></header><p>所谓防火墙就是 &quot;防火的墙&quot;，如果过来的是 &quot;火&quot; 就得挡住，如果过来的不是 &quot;火&quot; 就放行，但什么是 &quot;火&quot;，这由人为自行定义。</p><p>但无论如何，所谓的 &quot;火&quot; 都是基于 OSI 七层模型的，简单的划分为四层：最高的应用层(HTTP/FTP/SMTP)，往下一层是传输层(TCP/UDP)，再往下一层是网络层，最后是链路层。可以基于整个 7 层模型的每一层来定制防火墙，但是默认防火墙（没有编译内核源码定制七层防火墙）一般认为工作在以上的 4 层中。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="21数据传输流程">2.1、数据传输流程<a class="hash-link" href="#21数据传输流程" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="211网络数据传输过程">2.1.1、网络数据传输过程<a class="hash-link" href="#211网络数据传输过程" title="标题的直接链接">​</a></h3><p>首先看看网络数据传输的基本流程。</p><p><img loading="lazy" alt="network package flow encapsulated" src="/assets/images/network package flow encapsulated-69156003742a7a5976e036a94c2613a8.png" width="1070" height="557" class="img_ev3q"></p><ol><li>国际通用的 OSI 标准网络七层模型包括：应用层、表示层、会话层、传输层、网络层、数据链路层、物理层，很多时候人们为了针对某个场景想要说透一个问题，会简化这七层模型，比如将应用层、表示层、会话层合并成应用层。此图为了过渡到防火墙的专业知识，不深入应用层，所以合并上三层，另外物理层指的就是物理设备，省略。</li><li>应用层通过通用的协议(比如 http，ftp 等)封装好数据，进入传输层。</li><li>传输层基于 tcp 或 udp 协议将源端口和目标端口继续封装，然后过渡到网络层。</li><li>网络层加上源 IP 和目标 IP 成为数据包，再进入链路层。</li><li>链路层加上源 MAC 地址和目标 MAC 地址成为数据帧。</li><li>以上整个过程是一种 &quot;加头&quot; 封装数据的过程。数据经过网络传输到达目标主机后，逐层 &quot;剃头&quot; 解包，最终得到 data 纯数据内容。</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="212本机数据路由决策">2.1.2、本机数据路由决策<a class="hash-link" href="#212本机数据路由决策" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="networking" src="/assets/images/networking-c82624047f0f52d2b7d6f24540689c3a.png" width="869" height="619" class="img_ev3q"></p><p>数据包的流转是个很复杂的过程，期间主要由多种 hook 函数和路由策略决定数据包从哪里来到哪里去：</p><ol><li>数据包从网卡流入后需要对它做路由决策，根据其目标决定是流入本机数据还是转发给其他主机，如果是流入本机的数据，则数据会从内核空间进入用户空间(被应用程序接收、处理)。</li><li>当用户空间响应(应用程序生成新的数据包)时，响应数据包是本机产生的新数据包，在响应包流出之前，需要做路由决策，根据目标决定从哪个网卡流出。</li><li>如果不是流入本机的，而是要转发给其他主机的，则必然涉及到另一个流出网卡，此时数据包必须从流入网卡完整地转发给流出网卡，这要求 Linux 主机能够完成这样的转发。</li><li>但 Linux 主机默认未开启 ip<!-- -->_<!-- -->forward 功能，这使得数据包无法转发而被丢弃。<ul><li>Linux 主机和路由器不同，路由器本身就是为了转发数据包，所以路由器内部默认就能在不同网卡间转发数据包，而 Linux 主机默认则不能转发。</li></ul></li></ol><p><em>注意：IP 地址是属于内核的，不尽如此，整个 tcp/ip 协议栈都属于内核，包括端口号；这个概念在使用 iptables 时尤其要注意，可能会疑惑，为什么 ip<!-- -->_<!-- -->forward 没有打开，两个不同的 ip 地址段之间可以通信，因为 IP 地址是属于内核的，不是属于网卡的。</em></p><ul><li><p><em>举例：某 Linux 主机有两网卡 eth0:172.16.10.5 和 eth1:192.168.100.20，某 192.168.100.22 主机网关指向 192.168.100.20，若它 ping 172.16.10.5，结果将是通的，因为地址属于内核，从 eth1 进来的数据包被内核分析时，发现目标地址为本机地址，直接就回应 192.168.100.22，回应数据包继续从 eth1 出去。</em></p></li><li><p><em>举例：Linux 主机 A 有两网卡 eth0:172.16.10.5 和 eth1:192.168.100.20，某 192.168.100.22 主机网关指向 192.168.100.20，某 172.16.10.7 主机网关指向 172.16.10.5；若 192.168.100.22 直接 ping 172.16.10.7 是不通的，必须开启 Linux 主机 A 的 ip<!-- -->_<!-- -->forward 功能才能通起来。</em></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">方法1： </span><span class="token comment" style="color:rgb(0, 128, 0)"># echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">方法2： </span><span class="token comment" style="color:rgb(0, 128, 0)"># sysctl -w net.ipv4.ip_forward=1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><em>以上两种方法是临时生效的，若要永久生效，则应该写入配置文件，建议写在 /etc/sysctl.d/<!-- -->*<!-- -->.conf 中，这是 systemd 提供自定义内核修改项的目录。</em></li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># echo &quot;net.ipv4.ip_forward=1&quot; &gt; /etc/sysctl.d/ip_forward.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>可以使用以下几种方式查看是否开启了转发功能。</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># sysctl net.ipv4.ip_forward</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">net.ipv4.ip_forward </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /proc/sys/net/ipv4/ip_forward</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># sysctl -a | grep ip_forward</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">net.ipv4.ip_forward </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">net.ipv4.ip_forward_use_pmtu </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="22tcp-重要概念">2.2、TCP 重要概念<a class="hash-link" href="#22tcp-重要概念" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="221tcp-三次握手">2.2.1、TCP 三次握手<a class="hash-link" href="#221tcp-三次握手" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="tcp establish" src="/assets/images/tcp establish-a97f01afcff42d0f3aa9d26bc9f3de7f.png" width="1148" height="1382" class="img_ev3q"></p><ol><li>客户端和服务端都处于 CLOSED 状态，发起 TCP 请求的称为客户端，接受请求的称为服务端。</li><li>服务端打开服务端口，处于 listen 状态。</li><li>客户端向服务器发送报文段 1，其中的 SYN 标志位的值为 1，表示这是一个用于请求发起连接的报文段，其中的序号字段 (Sequence Number，图中简写为 seq)被设置为初始序号 x (Initial Sequence Number，ISN)，TCP 连接双方均可随机选择初始序号。发送完报文段 1 之后，客户端进入 SYN-SENT 状态，等待服务器的确认。</li><li>服务器在收到客户端的连接请求后，向客户端发送报文段 2 作为应答，其中 ACK 标志位设置为 1，表示对客户端做出应答，其确认序号字段 (Acknowledgment Number，图中简写为小写 ack) 生效，该字段值为 x + 1，也就是从客户端收到的报文段的序号加一，代表服务器期望下次收到客户端的数据的序号。此外，报文段 2 的 SYN 标志位也设置为 1，代表这同时也是一个用于发起连接的报文段，序号 seq 设置为服务器初始序号 y。发送完报文段 2 后，服务器进入 SYN-RECEIVED 状态。</li><li>客户端在收到报文段 2 后，向服务器发送报文段 3，其 ACK 标志位为 1，代表对服务器做出应答，确认序号字段 ack 为 y + 1，序号字段 seq 为 x + 1。此报文段发送完毕后，双方都进入 ESTABLISHED 状态，表示连接已建立。</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="222tcp-四次挥手">2.2.2、TCP 四次挥手<a class="hash-link" href="#222tcp-四次挥手" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="tcp break" src="/assets/images/tcp break-f6fe708dac6c5f2dd506a64a6d33a8c2.png" width="1304" height="1470" class="img_ev3q"></p><ol><li>当前客户端和服务器端处于 established 已连接状态，而且可以正常相互传输文件。</li><li>客户端发送关闭连接的报文段，FIN 标志位 1，请求关闭连接，并停止发送数据。序号字段 seq = x (等于之前发送的所有数据的最后一个字节的序号加一)，然后客户端会进入 FIN-WAIT-1 状态，等待来自服务器的确认报文。</li><li>服务器收到 FIN 报文后，发回确认报文，ACK = 1， ack = x + 1，并带上自己的序号 seq = y，然后服务器就进入 CLOSE-WAIT 状态。服务器还会通知上层的应用程序对方已经释放连接，此时 TCP 处于半关闭状态，也就是说客户端已经没有数据要发送了，但是服务器还可以发送数据，客户端也还能够接收。</li><li>客户端收到服务器的 ACK 报文段后随即进入 FIN-WAIT-2 状态，此时还能收到来自服务器的数据，直到收到 FIN 报文段。</li><li>服务器发送完所有数据后，会向客户端发送 FIN 报文段，各字段值如图所示，随后服务器进入 LAST-ACK 状态，等待来自客户端的确认报文段。</li><li>客户端收到来自服务器的 FIN 报文段后，向服务器发送 ACK 报文，随后进入 TIME-WAIT 状态，等待 2MSL(2 <!-- -->*<!-- --> Maximum Segment Lifetime，两倍的报文段最大存活时间) ，这是任何报文段在被丢弃前能在网络中存在的最长时间，常用值有 30 秒、1 分钟和 2 分钟。如无特殊情况，客户端会进入 CLOSED 状态。<ul><li>按照常理，在网络正常的情况下，四个报文段发送完后，双方就可以关闭连接进入 CLOSED 状态了，但是网络并不总是可靠的，如果客户端发送的 ACK 报文段丢失，服务器在接收不到 ACK 的情况下会一直重发 FIN 报文段，这显然不是我们想要的。</li><li>因此客户端为了确保服务器收到了 ACK，会设置一个定时器，并在 TIME-WAIT 状态等待 2MSL 的时间，如果在此期间又收到了来自服务器的 FIN 报文段，那么客户端会重新设置计时器并再次等待 2MSL 的时间，如果在这段时间内没有收到来自服务器的 FIN 报文，那就说明服务器已经成功收到了 ACK 报文，此时客户端就可以进入 CLOSED 状态了。</li></ul></li><li>服务器在接收到客户端的 ACK 报文后会随即进入 CLOSED 状态，由于没有等待时间，一般而言，服务器比客户端更早进入 CLOSED 状态。</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="223syn-flood-攻击">2.2.3、syn flood 攻击<a class="hash-link" href="#223syn-flood-攻击" title="标题的直接链接">​</a></h3><p>syn 洪水攻击是一种常见的 DDos 攻击手段。</p><ol><li>攻击者可以通过工具在极短时间内伪造大量随机不存在的 ip 向服务器指定端口发送 tcp 连接请求，也就是发送了大量 syn=1 ack=0 的数据包。</li><li>服务器收到了该数据包后会回复并同样发送 syn 请求 tcp 连接，也就是发送 ack=1 syn=1 的数据包，此后服务器进入 SYN-RECV 状态。</li><li>正常情况下，服务器期待收到客户端的 ACK 回复。但问题是服务器回复的目标 ip 是不存在的，所以回复的数据包总被丢弃，也一直无法收到 ACK 回复，于是不断重发 ack=1 syn=1 的回复包直至超时。</li></ol><p>在服务器被 syn flood 攻击时，由于不断收到大量伪造的 syn=1 ack=0 请求包，它们将长时间占用资源队列，使得正常的 SYN 请求无法得到正确处理，而且服务器一直处于重传响应包的状态，使得 cpu 资源也被消耗。</p><p>因此，防范 syn flood 攻击非常重要。当然，首先需要判断出是否受到了 syn flood 攻击。可以通过抓包工具或者 netstat 等工具获取处于 SYN<!-- -->_<!-- -->RECV 状态的半连接，如果有大量处于 SYN<!-- -->_<!-- -->RECV 且源地址都是乱七八糟的，说明受到了 syn 洪水攻击。</p><p>例如使用 netstat 工具判断的方法如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># netstat -tnlpa | grep tcp | awk &#x27;{print $6}&#x27; | sort | uniq -c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="23防火墙的应用">2.3、防火墙的应用<a class="hash-link" href="#23防火墙的应用" title="标题的直接链接">​</a></h2><p>从设备上分类，防火墙分为软件防火墙、硬件防火墙、芯片级防火墙。后文所说的可能是软件防火墙、也可能是硬件防火墙，在理解上它们没什么区别，只是将防火墙剥离成了独自的服务器而已。</p><p>从技术上分类，防火墙分为数据包过滤型防火墙、应用代理型防火墙。这是因为四层模型的每一层都可以应用防火墙。</p><blockquote><p>从链路层判断是否处理</p></blockquote><p>基于链路层的防火墙是控制 MAC 的。例如，可以将公司内网员工电脑的 MAC 地址全部记录到防火墙上，从而限制他们上外网。再例如，可以将公司电脑的 MAC 地址全部记录到防火墙使他们能够上网，但是非本公司的电脑就无法从本公司上网。</p><p>但是，基本上不会有公司这样做，这样的行为太死板，而且记录 MAC 地址本身就是一件很麻烦的事。</p><blockquote><p>从网络层判断是否处理</p></blockquote><p>网络层的核心是 IP（也包括 icmp 等）。所以从网络层来判断，可以基于源 IP、目标 IP 来指定防火墙的规则。例如，来自 38.68.100.61 的主机不能穿过防火墙；访问目标是 192.168.109.19 的服务器的请求不能让其穿过防火墙；还可以设置 icmp 协议作为判断依据，使得外网人员的 ping 包被挡住。</p><p>在网络层可以用来制定防火墙规则的内容有很多。如下表。最常用的也就是后三个而已。</p><p><img loading="lazy" alt="ip package" src="/assets/images/ip package-b27272d7de492ee7c798df6ed1ae5709.png" width="556" height="167" class="img_ev3q"></p><blockquote><p>从传输层判断是否处理</p></blockquote><p>可以从 TCP 或者 UDP 来判断。以 TCP 为例，例如限制目标端口是 22 端口的请求，这样 SSH 就无法连接上服务器了。</p><p>下表是 TCP 数据包中可以用来制定防火墙规则的字段。</p><p><img loading="lazy" alt="tcp package" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAhkAAABzCAYAAAA16hCeAAAgAElEQVR4Ae1dS6xk1XU974NbGRIls4zATYcMIkUKii1lFMvC0CYWRJHcREIyNm2wSZzGdgyyTTdtWzGyMbFjQwP+SFEEJFIwGGjIwMowjoUUZRKLprtRpAyjMIxa/alo3fdWvf32O7/7q7r13rpS9Tlnf9beZ93b9+x36lbV2mw2m4UQwjsXLobDN96Arg4xMCkGdG1O6nQoGTEgBsRAkgF/v15PWkohBsSAGBADYkAMiIEeDGzCd21trdnFQAWiQwxMjQHssOnanNpZUT5iQAyIgb0M8H595cqVsLGxETa5tXHu/IW91pKIATEgBsSAGBADYqAFAzcfuSmcv/huWF9fD2t4JgM7GXg04yO//1stYGQqBhbDwJtv/beuzcVQrShiQAyIgV4MnP3lf4X3ve9QuHTp0tZOhkc78cy/eZHGYmCpDKAIRqGhQwyIATEgBqbLwN888ME9yTXPZOyRSpBkgLs9XRe9vv7JxPax4vpbjoX/+N9f28cz1NRWnYGHb/2NZjf4m//8P80zbn6M+cVkpXnTJ2bHWDGdZGJg0Qz87q//XzSkiowoLWkht+5RLNQUGiwqLCIxrAz9Gjzvo7EYEAPLZwALPgoCvND3Y+zGpY5UIQEMHugTI2VPW7ViYEoMqMjInI1YgWDNU/pYsRCTAStVcNg46osBMbDaDLAwsMWCnxF1tPV6jcXAKjKgIqPirKUKBO+aKjq8ncZiQAzsPwbszoMtFNDnwT4LCsrVioH9yoCKjAWdWVuA1BYtC0pNYcSAGOjBgC0ofueDHwn3nPr7OZovJqzt3Kiiw+KkwlQmYmBSDKjIyJwOFgO2QEiZw5b2MRurIx5laCHz8hiOZGJADEyLAe5g9C0Ecv62WOlaqEyLNWVzUBhQkVFxplkMeNOuRUEMLybz8TQWA2Jg/zLAQkJFxP49xwdxZioyOp71tgUG7Y+feDQ8++TpZFQVG0lqpBADK8dAbndi5SajhMVABwZUZHQgjQVDm4LA2t71Z8f3vDVCzA7pyEUMiIGJMYBdCe5IoP/IR35z1/dotE1XxUpbxmQ/FQZUZGTORGnhT+ltQZGBl0oMiIF9yAAKgo8ePx1mLeeWKyT4VgogWby0hJe5GFgKAyoyMrSnigUWFyl9DJI+1MEXMitvg0cctWJADEyHgf/81zebZP7wTz4TXn/uZKtCwxYSAGEx4eXTma0yEQNlBlRklDnqbGELCID4IoKFRkzXOagcxYAYWBoD/Ahr7u0RXzygiNAhBvYrAyoyRjyzpSLCFiHo+yJkxNQELQbEwMAMDFks+EJk4FQFJwYWxoCKjBZU26KghdseU4vDwgIyyinb4yiBGBADk2cgViCgAIEcr9IR84cP5SV/6cXAlBhQkdHibHRZ/GM+tbIWqclUDIiBiTCQ2tFIyX3aKbuU3PtrLAamxMDaufMXZkdv/XA4d/5Ckxd+6Q8/ra1DDIgBMSAGxIAYEAM1DLz31ovhyuXLYWNjI9x85Kbw8mtnw/r6elibzWYzFBaz2az5KWG0b56vgZSNGFgMA3fffXd4/vnnFxNMUcSAGBADYqA1A7e+P4TrNjfDpUuXwqFDh5oWBcd6ayQ5iAExIAbEgBgQA2KgggE9k1FBkkz2LwO3HV5rJvfGO3u/OimnG4oRxijhvXHuWghrW7mWbKUXA2JADEyFARUZUzkTyqM1A1ygWSBwnAOiLW0whh9e7EPn7Yjt5cTp26Zwb7tpPYTZ3gKobzz5iwExIAYWwYCKjEWwrBijMMCigAUCghw9dn948PTTTbyxCwPi104uVUjU+stODIgBMbBqDBSLjNSNdD/fMFNzxsndz/NetYuX5wPn66Uff2dX+jyHqfNFvXXyGFaX66di0CcWizq2NTa0VSsGxIAYWBUGskUGb3z2JkrZqkywS56YL+fp5w65lXXBT/nEYqZsJd9hgOfjub/+fCMkjxjYPu0gt/0dpBBKGNZ2iH4qjyGwhSEGxIAYWDYD2SJj2ckpvhhIMcDiIbdIU0fbFBbksPnAh/44WXzkfKUTA2JADIiBOAOtiwzeuD2cvZFbm5jcy+wYN/pf/Pxnu+AtHhTWHuOSPmazK0DPgc3H5mLluXlZO6TCscXqmeK+cwc34AmvFE/kMTZ56rwv5TEfyLx9yq4kL8VJ+etTJilmJBcDYmCKDGS/J4M3VNwQczdF6qw9J0sZx2i9DGPKWGBwbP3Qt7FoQ1lMH7PxmLkxsPmCHfHow9iUc0xbynPzgg3tvB/jqN3LAHkD57HnKajf67lzHr//6AO71Nbn2Ge+0pwXytAOdVhMi+vlfqyPsQ51BoQjBsTAIhgo7mTwBphaaLmo0g4tbSlrMxH8xX/yzCuNi/f3sWDkbRiLthx3bVP4wGMM2qBNzT03r665yS/PAM9P3mrnPOK6sz4vPPX1gJc9eK6trG+fMcfA7pub/MWAGBADfRjI7mRYYNwAeRPkTdHqp9ZnvradWo7Kpz8DvBbvuvehORjPOQV+THmqxQ4GDraf+8ZzKdPecuYPIPRTL31XRm+qBSAGxMASGMjuZPAGiJu0DjGwKgzgur3vkSfm6aauY17X/F6NucMCO8whFVJfxpViRnIxIAZWgYHqnYzUZHiT5I2cLeUxP9rEdDkZMa0/+nYc86+xifmVZD4f5kF5yV/6fgxYvtG3X8RlkXk+aG916EOOV+y5Dm8bG9M/1cZ8JBMDYkAMHAQGsjsZJAA3T3vwpk0ZxrzBQlbSn3r21XDq+B2Nu8fGA5KUeRxi21iUNWDbsb3e29A21TI+9OjH8qBvbu4WpzQv4OWwGE9tngFyjrdP+J0XMQ/aUcdznPOhrW/p6+Uc+1iUqxUDYkAM7HcG9FPv+/0M74P5lX7qnYu4Xewpw/StvEQH/PAsxj0nvjY37Yo1B+jQ2RVTP47WgUG5iAExsEgGUj/1XrWTschEFUsMtGUgVkTEZDW4Mb+YrAarj80yYvbJV75iQAyIgRgDm+9cuBgO33hDo5vNZmFtbS1cf8uxmK1kYmBpDGA3Q4cYEANiQAxMk4H33noxXLl8OWxsbDQ1xfmL74b19fWgt0umeb6UlWGg9HaJMVVXDIgBMSAGlsBA6u2S3p8uWcJcFFIMiAExIAbEgBhYAQb0TMYKnCSlGGfAPhwZt9gtjT3nAAz7bay7Pcoj5pDCBkJMV0aus6j9Hg395kkdn7ISA2JgWAZUZAzLp9CWwEBpEWchUEqtZBeLAxn88GIfcbwtsb28lFOtPlVE1BYhtXFkJwbEgBhow4CKjDZsyXZfMzBWAZAijYVHSu/lqULC22ksBsSAGJgKA8kiI3UDXPSN2BNl81p2LshtKvnYPDxnU+DJ57TsseWr5ovSfL7Wn7qu3xhaOj81uxGNDRNRKwbEgBiYCAPJIgM3Pt5IeRPEGC+Ox5iDjzlGjDaYU8snlXvsfMF27HM2BX6YQ4qbmJzXMHy7PJNBf4/Nbwy1Odm+t+87bnY3+oLIXwyIATEwEgPJIiMWjwsZbpqpm2zMb0jZsuKm5jC1fFJ57md56RzULPI1NuAwFQv+KFZS+v3Mv+YmBsSAGEgx0KrISIHEbtD+Zluy8XqOLQ5lzMPqIKMeN3tsgdsjZUubkp7Y1o6yFAblaK1tDKMmZ4vXt1/KB/i5nKy/nZ+dW98cx/bnHHit2NypszKbT0pPubW1/RSetanp17yFEsPRcx0xViQTA2JgLAZ6f08Gb6q4efKFZCm3fav3E/I6P4Z9TGZxoMdhFw3KSvlYfSxWLHZMZvNhn9ixXCgr5Uysmhbx+II9Y9C3lA/tbU70ZQsb2jGGHdNuFVoUUzjwTAW4sc9WWB7tXDjX7z/6gBXvukbxGyjkie0u4x4DFAvEbHJZ2/oRQy+3NtauR2i5igExIAaqGRhkJwPRuHDVRG5udjWGHW2waJw880rSm/Hb5JwEKygYgzHRcuGiDBClnAthdqkt7i6FOU+0SeXjc6K9x5vCmBy3yQU+9teAOT8+U0GsHD+0YXxcc+xD98JTX29etEPLOFbWt89dDe1S9GVS/mJADAzNwGBFRu7maW/UnEDOnjZjtlwMmNuYsYQ9LgOla4nn2mYR86Fd6WfiLU6sjx0MFBhsP/eN58J3v3xfzLS3jAUGgHKfMFEB0ptqAYgBMdCBgcGKjFJse1PHzRwvKyv5D6nnYrKs+EPORVjjM4DrJHbN8vp58PTT4yeRiNAUDwkdxLYIyZhJJQbEgBgYhYFWRUbt4uzt/HiUmUwU1C9Qy+ZiavlM5bT1OS/0ve+RJzpNh/6dnOUkBsSAGJgwA8kiw974bJ9/vXFOdtGiDK23gyyHQ1+PZ3Gsv8WjDfV4YBF9YhGbMspp7/Uco/W2jAVdzJ8+bTFKOVu8WN/mwnnG7CCrnRNzok8ML4cVsx9DZufeFd+e1xiG1/uY1PtnOmJYXkZfL+dYuxFkQq0YEAOrxkCyyCjd+OxES7YlvcVCP2WfktM/po/JcjGIZdtFY6Ti2Zx8v61Pyj4l9/HsuIuP9e/bL8X3BUEuXq1tKSb195z42p5ilPFpw3GqLb0lEvOzhYmex4gxJJkYEAOLYCBZZCwiuGKIgT4MVC/S2x9tjsXyGH4c88nJYv4xWQ5jCF2XwmSIuMIQA2JADFgGNt+5cDEcvvGGRjabzcLa2lq4/pZj1kZ9MbB0Bu6+++6l56AExIAYEANiIM7Ae2+9GK5cvhw2NjaamuL8xXfD+vp6WJvNZjMUFiww0L55Pg4iqRhYBgMoMJ5//vllhFZMMSAGxIAYqGDg1veHcN3mZrh06VI4dOhQ06Lg6P2NnxWxZSIGxIAYEANiQAwcQAZUZBzAk64pd2cAD4bWPhyaiuIx/DjlBzke6Gziz7a+Qj8lS2HA/++e/OoudQxzl4EZ3L4dHzuePCB77P6PhRB2ZNT5NuZPm5yONrZta2991RcDYmAxDKjIWAzPiiIG5gzwQdC+xcocsNBhEcHiBN9GysKm+Z0WUzAUoEZTo2BA4XL23LXmubCaQLSlb42PbMSAGFgsA/p0yWL5VrR9wkCpQGAhMeR0USyE2SykPpLa6E1A2tlPmsDm2ANfDvhoLY/nvvmFBtf7cxGn3Vgti4RSPNrF8oDOHyU8b6+xGBADwzOQLDLsTRTfZOi/ZGiMm6idno0/diwbF30bG+NFx/f51IxtzquQb82cUjZ2rjEbO/+ULWxSOmBaDMagfUznbTi2rfXPYVgf9llgYOyLAchYUMz1bnfC+vOH2/jbKtafC3lsgba6o0c2mp0H+OLY+uK23Qt9DGPbfN5YTDyAXnMAl/FtjC5YNfFkIwbEQHcGdt8VDI69CeIHo+zY9o3LoN1FxEglbGPbfsp+kXIsVFysbNyp5WlzG6tv52z7jEeeoOOLOrTWh3rK6Et7jqmnvE1LX2K18aUtiokGxyzItsCgXaz9wav/HkJYa364DXoUGzxQhCCv2rcssLgjD7xQHOBXhN94Z0dGOfFjbdeigH7ARB95M3crs8+NxOJLJgbEwPgMJHcyxg+tCGKgGwPNIhtxtXIu5FYWcakSAYs/C0/cmOMQsWK4OVltgQGMz97xew0UiwvsZPBtE+502J0BG9cu7DE5dzJS/taHfdh2OeCnnYwuzMlHDCyegUGKjNiN199wvY3XY+reJkZHzIZYVoe/rHDjswftrKxv38YkFuNQV5MLbYnB1mNRTnvqKUdLHWUxG+oOWtuFC+/jx57vHKfeN2dbq2OBkCs4oKMdce/5y9NN18pRTPhCAbKTz7wSTh2v+wQJ8dnGChTISofPI2ZfgxPzk0wMiIHFMFBVZORuotTZmydkeFHmbbweU/U2VkYqUjaQI5aNxwIDMvoRZ6iWuIzLnG0+6NtcvA3HaIkTw83p4OsPa898vI3GOwyQc0rIH8d9Wo+dwvJ2saKhKQgcAAsI6Bofp8fQFhJ8FuOlnzw5f9aKsbBoc+HmIo8WB96hsY96wO4vvv5s+O6X72veLsF1Dhn9mAb9MYaeb8nEdiPoU2otZslWejEgBpbHQFWRwRuuvwnatHO6Gn+LVernYtEXuwcnz7zSDBmfuqHbUj42l6Fjx/DGnm8s5qrLxuQsh41r5+ix+8ODp5+uopDFgC0aSo60bYqRIxuNOXPC81b2WOTijVgoOmKFic3J92FfOoBd+yBpCUt6MSAGujNQVWTUwPOmlbLlQgw79lO2JXkpVsl/aH3ffMiJ5aUv5tBzFN4OA/Y87Uj79YjZ9byndjCQVVNc4AHJ7cWZny7JZVxapLkjceuffjJ87yvHGyg8+Hn7TRutioYuhQZ8YrsgzKmUe27e0okBMTAsA+U/CQaI1/cGOkAKk4aw/GCR6brQTHqSE0kOXJPvrinxHNkWWMStPX+0xy4GfSjrmlvKD4WGzbeJt/0JlZgutwuAxRzPaOCTKlzY8VbJbYfXt3YP13bkqXysnEUBsawu1fc+9KU85Se5GBADi2VgsJ0MmzZvlLxxWl1tnxgle9r1iVWKQX1NrBob4rFF7vCjr5Wzr7YdA5ZTXhvkl+N2iHlri1kTJ2YTyzkftb3WvnVCb+5wcFxaqKnHzgUOLPB/8Ed3hJNnXm4Kj9yuCmPABwex0EKGF2W0RQs5n+VgAWR9LJb1U18MiIHlMpDcyeBNEOnhq4ft2PZ5c4WML/hQbvtWD3kOBx8Z5EE7YhInJYff1l9WexduYuZa4sLGx7J+NfnAnrkQjxiMwxZ4fHlb+viYlBPD+sVktN8PbWl+Ma4oszz5/pjcIGfmbXNhTMoaG/uU5bYBCoKUjhhtW7+TwUW8LU5be19McIyCAnPMfc+FtWnj1zZH2YsBMdCPAf3Uez/+BvGOLTox2SDBVhBkSj/1zvNSQyMLBthaPyuP4dC22RHYfktj1w7E2tr80yIxG2Cm5LF4KRkXb+pjuwnQQW53Mmgfa1MYMVvKrA+fxYDO5wcZbVN6YqoVA2JgWAZSP/WuImNYnjujcWGxAKXFyNru5/6Uioz9zLPmJgbEgBjoykCyyDh3/sLs6K0fDufOX2iwsVV6/S3HusaRnxgQA2JADIgBMXDAGHjvrRfDlcuXw8bGRrj5yE3h5dfOhvX19aCdjAN2IazidLWTsYpnTTmLATFwkBhI7WQkH/w8SORormJADIgBMSAGxMDwDKjIGJ5TIe5jBvDsTOz5mTZT9hh+XIvV5ZMmMZ+YrDYHPGiJ/HOfBCEWbB+7/2O7vpu8rb+P1cbf5uFxanXIv2auxMu1XXLP4dXo8GVpW3Pv9uN0NTFks1oMHD2y2VwT165dHSVxFRmj0CpQMZBmgA/04ma/KsdYCyI/IQL8Lot3rf/Q+RMP5zD26jKXVbkWFp3n7Ue2C6Nr0yiM8AknnPNrE8mn7/l4/e0rYX19I6DYGKPQGOXLuPpOWv5iYOoMlAoEFhJTmof/GKzPrdEbIRdwiNDHwvqDk58Jr79wxlhtdaGzh/W1cvZh7xdii9HXH3FiGDYG+/c9/O3w3ONfDPd96VthxgQLLbBrj9hcrS/zsDL0Y/l7m75j7GzMZvG5nD13Nayt7T6vfeO19UeBMbt2LZx9+2pYW19uLsgdBQaKi9ffvto81Nh2Psu2LxUS0McOFiIxXUkWRyx5SS8GlshAmwU+ZYsiIKXD1GJFAu1jOtJBG45tSx38cxjWh30WCBzb1hcH1KW+KyNmb21LiyJzp11pMaQd8mq+mO6m9XDqmZ+FU9tvndCfdhxzHpRz/NOffGf+a7DeFjbenmPa+jF8fvj4Fwm/p6U9FMgfYxzE2+PgBLCLHcStxYlh1MhihQRkn3r42yFsl1W2oEjZx4oR+B09ct28UAHmjx7/4q4CEgXC0Zuva4oF5PuBD90RfvHz1+axIetSRJQKEBYEniMUCHfcfN18JyKWc20RkYqBmBYjZUcbq8d3zvzyX17bxSHt/Fy6jG//+KfDg6efqiogS0VJTfzll4Y1WcpGDEQY4GIHle3T1C/q3saO0ecL/vSNYVHWtmU8j90GB8XAPM/Eb480v8meAKW/tbEFRsKtEWMx5K/F2gUSN0jMye9MEAt+yBkfj8cvEiMebqRoIQMW/WMLrvUH5p2feCjgK82BaWMTBzdkxoO992deta31R/52XIuxTDsUAlt8sDhqt0PBooM4FgvzsgXKXZ84sVV8be86sHhgSx4aH2dD3RAtF21eC8gZH6fkYRftO7dzpt7qaJ9qra2PxRzgS52NYXOyOFv2eAtjK1+vS+XSRo7iAf/nxnh7xOehnQzPiMaTZwD/OWOHlXMht7KYT40MWPia+1PH79hTfFj/IWJZvEX0awuMIXOJ7aQQH4UCDyzmua84t4UO7GAPGV7Wl3bEZQs5DrxdEr+iaLm7pd9u6d6RzWGvVpISA7mdCuj+/PSZ8Ldf/XRA3xYxXNzbLM41PkPZlOY9ph5ve+B48x9/GGaz8oOetO+Tk4qMPuzJd+UY6FIIeB8/ZkFTQ4b3rfGJ2di3T9DvUywQK4VhF2n8JY+3DHjYBdf2cwusjUPsnD1j2TblBxzo8CImWnvEfHNvl8CXPpw7sa3Oymw8a+Pl1Hl5DsvbLmOMnQh7YIwdDyz4POzCTxm26t/4h2ebRW7+nheVI7coOmIHigccbYqSGM4QMstP5KeLhghRxLBvkfR5FoOBVGSQCbUHmgFfKAxVDIBUj50i2tvZxdj6+KIA49pCo/G1YNu/c0IMvyDDlDIstDi2fn1155MxXIBrFkY+k1Fj69KcDxEv58985w4Ddlhk/fTH39nzsCj5ieU2Zk4107NvebR9mHNeQNy0tRg3b3WM/EBobhejZr5D29TuYgwdd1F4trBAzCGKC+auIoNMqD3QDAxZVHgic9goLI4eu3/+rIP39WMWCbYAQZ9FQiP3TmZMvwZnQX8qsQhBGlykuSAzNT+GnIu19c/JiWVtKPMYkDMmcko9T0K7R8+8Ek7jQVWTl9/9QL5YjIDL3BuHyD/Mp2QXce0tYsFx170nwo8e/6tdD2CmwLlz0exWJIqNphiZ2KdBUvMZQ46dEPtA6RgxhsZEccFjyMKCmGh3Ilip+mJADCQZ8DsOScMWCmLmChLCsVDgGC0LjZd+8uSuL7uyNrl+qTixvrcd3nluwsq5aFPGBRQtDuqZv19o/dji0N8WAxYXcsajX6yFDQoB2nOrPGZLGeNwjJa53nnvQ80nU9o80wF/YAIDr5q8GZtxiZF7ZoU+W7bbb2dsFwhW16bvi40uuxpYjI/+9ma2sMvlxF2O733l+NzMP5cxV1R0WBzgWpjCWybI4aMNP7vf5vNTQb78ro6ueY9VWNhc43cLa6G+GNhHDGAx54LedVooBPwLWMStKRSsPT6xQR9ipHLjAh3TQ3fXvQ8F+8mRmF1fGT/ZQQ640GGxpAwt5bF4drGEnuM2C24Mt6sMce/65OfDzptA3ZCYP+dDFIz/6UdPNPPEObbFEm3Qwi6nt7Zt+7YgsP0SDnYvtnLKL3olnFo9i4jYMx0WA/rmOjOfGrF638eijHlwYfb61JiLec1CDhvkxE+GpDBXQT7UJ1BUZKzC2VaOrRnAf3QcuKnwYJ86yodogckX4jBWCpt6mwv71KV894OcBQkKES7IXKCnPr+h8rUccM7kgDEoZ0s9x21avk0CH9vnmNdt7Psw2sRZti2LARYHyId96nyOlNPO66c4Zs5TzM3mlCwyeMHFWgvg9VanvhgYkwFcezxsnzK7aFNPGWwo8336j9EiJuPaXBiLssZmhGcmmmc3wFtLbC56zYObh/d+Wyfzb9MSkwsnxph36q/8Ntg1toxfY2ttYsVBTs84zS6TNTT92rkTi5wZiGyXRQV2MHCN4eHPl3785Px5DMqpi4FxR2PrHF3b9f0YsG9ibH/VNncjiMPx2RefaYrK1391OfoNnnO7xDd8Ug9cvDXY8GFicpeCCzCKBuTrv6XTFhM/3cahr9WxTzzOhy31GNs+9WyhYx609WPEJz+v/upycTeE8VK5Mfay2+xPvYMEHLzxoR+T5eQNgP4RAz0YmNJPvfP6r5lO7P8N/Kw8hsMY9q0RPqhpZd6XNpRbW+oo82P4UIa+XcT8wsYx46RaYlh7PvhJH9pwTFsrp4w20OEGWypGLAZ90RLP6imjndVRBht8idijT788/xIxm0PMh7629bGsLodBv5yNxWLfFhhtP1lCjEW1LCJKb5UsKp+pLuRD5OU/UZLitPa5jdRPvVcXGfMbX+KLkEr61AQkFwMlBqZUZJRylV4MiAExcBAZSBUZC/t0CYsQkh/7a87bxGxjNjEs+qoVA2JADIgBMSAGlsNA8pkMm05sYbf6Up/+KAZYEFBGX46tDXS0Rz9lQwy1YkAMiAExIAbEwHQYqNrJwELPBb5L6iwU+mDE4hI3ppNMDIgBMSAGxIAYWC4DVUXGECmywEgVLJTTDjF9EVFjM0SuwlgtBnDN4FszX3/hTJO4v25ys7HXW86uDWYOp6+OD2fyAc4ueB7Dj2sxuzyICB/+1HTo/a0UOw9x+pztw5HM09uUxhaDtsSyupiM9r71tn7s7VPjrn4pPMnFwFgMVBcZfW6yvJHnMGpsQILFgA9eVjYWUcKdPgO4DrpeE6lriNfl9GdfnyEKFBQWeDXFSr3rYJapbw1FALuAMyAXVY5tG7P3ejsmFv382NqO3UcOiI8X8ynFXGa+pdykFwOegeoiwzsOPbYLhMW2N3/e8K3M2qp/8BjgNYFvzcTBa4Nyzwj1Xp6y93ZTGTe7D5lk+ux0xGC5sKV0Xh5bMInx2ceear4PAB//tHbUeyyMYeePnL23HWLMeDZniwu9Pbwd/WHjbWOynH/MnrHbfJsnfdSKgbEYSBYZ9qaLfu3NmX7WHn3IqeNkLC511o8+VgZf2qLvdcRWe/AY4HWBa8JfF9SlWPH2tIv5xWS0R2uxUrawSek8BrFr3tagDX1sSx0KkK47GJL2vZEAAAT9SURBVHbh46IZk9m46MdsvU1qTN+cPqYr5eUXeju2vsC2OVg7xrX21pZ621pbK6/tp/xLcWvxZScGhmQgWWTYG2Uu4NB2Q8TKYUi3fxjILdJtZ9kFyxYKts/YxLT/RyiDjfXxNrCzuxG2QOj62yTAAw5eFpv5jtVy8cPiiC8R+tTD355/kVZswfZ5wC92WNzc76RYX+Zgd1EsTulLvrjA0wfYlNk4vm/tofNjb5/DhK8OMbAqDCSLjEVPgDdcexNGDvbmu+icFG+6DOA6OfXsq+HU8Tt6Jdnl+kr5WDmvYyvrmiiKglPP/KyZa1NsJIC67k4k4AYTY8FMHXYxLS28Kb1fdC1mKu5Q8ppYyI8/Fc9vCM1xUsotFTPFTwlPejEwJgOTKTIwySFuyGOSJezpMND3WmER0HZGfeN28Z8XD2tbvznidyGawqPyt0jmWG0nPoA9F8E7P3Ei/PCbX5jvZrSF5iJLPD/O4cGHh+1D5se0K7U+D28fKyjo42055pw4tm3XPC2G+mJgUQxMqshY1KQVRwykFnsWHyn9WMwxLvGHjF9bhPhdktxCxzxr29Si2mXB9D5+HMvJL/TMp+0cY7GAATlePk4sF8hq7WL+qZw5p5iPZGJgWQyoyFgW84o7CQa4uA+5qHeZ2Jjxc7sXKCyOfvzTgZ/OKeUeW2RjMosD/ckzr4RT939sz6+/YsHkcxDswz61kAKXOtjFnq2wsdGnnZdTF5NDxjhWT1kO09qn+iV/xon5w1eHGFgVBlRkrMqZUp4LZYDFB4OOWQQwRm3rdxxq/XJ2nG9ucYO/1XOhjMlsLOhx4DedZ1bh+lw8LZ4zaYa0o86PKWfL+Bzn8i7FJoZvfQyvT419POYWs/cxaOsxYr6SiYFlMaAiY1nMK+6kGRirqOBi3gffP5MBIlF4sPiI6WNkN/azWXjwsaeanQyMsXDFFi2/wMXwIKu1s/7wqVkwPXaNj42DPn2snDLg135Kxfovsm9zJW+QMfdV+ln3RfKmWMtjQEXG8rhX5H3MAIoIFBR4saAYosBIUWbfEmHxkCs2Yjawx4JlF61UvKHkiHXfI08UHwKFHT+Z4WND5w8uujE5ZPCxfil777+sMXL95Je+VQyPL+JCoYGXvpSrSJcMFsCAiowFkKwQ02SAiz6ys8VAbbYlf1toEJMFB2NS3iU+fdu0LC7gEytCYn8dt8HvYotPm9x170PzhT+24EPmDyy89pkMr4+N6QMd40CGFw/KObattbPyrv2+eOQFOFtcXO2aivzEQG8Grly5EjY3N8OlS5fCxsZGg7c2m81m2CLEBcq2dyQBiIEBGchdl9ze5vWLsOjzoJ5j6ij3Y9qlWtqn9GPL19fTf9H72Neu7Wz/Wz8r9z4Y03YoO8awuLgBgUsfw9rwHFFGnNqW2N6f8hgObb2Nl/sxsChD3/tbPXRd5k9MG8fP4erVq00eXq6xGBibARQXuP5QaBw6dGje31NkjJ2I8MVAWwawGHHBaesrezEgBsSAGBiXAV9Y2CJj850LF8PhG29oMlj2X2nj0iD0VWZA1+Yqnz3lLgbEwH5mwL9FgpoCuxrnL74b5jsZEKLg0CEGpsaArs2pnRHlIwbEgBjYYcDuZNj7dfOMBszwV6Ld0dhxVU8MLJ8BXZvLPwfKQAyIATHQhQF9uqQLa/IRA2JADIgBMSAG5gxg1wKH/6Pw/wHp2CrfYKQyuAAAAABJRU5ErkJggg==" width="537" height="115" class="img_ev3q"></p><blockquote><p>从应用层判断是否处理</p></blockquote><p>到了这一层的处理就属于应用代理型的防火墙了。他需要解开数据包并还原数据，也就是说它可以获取到数据包中的所有内容，但也因此负担很重，所需 CPU 和内存较大。这种防火墙在企业当中很常见，便于管理企业员工上网行为，企业级应用防火墙非常昂贵，由企业实力决定。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="24linux-防火墙">2.4、Linux 防火墙<a class="hash-link" href="#24linux-防火墙" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="241netfilter-与其模块">2.4.1、netfilter 与其模块<a class="hash-link" href="#241netfilter-与其模块" title="标题的直接链接">​</a></h3><p>Linux 是一个极其模块化的内核。netfilter 也是以模块化的形式存在于 Linux 中，所以每添加一个和 netfilter 相关的模块，代表着 netfilter 就多一个功能。</p><p>但是有些模块是使用 netfilter 所必须的，所以这些模块已经默认编译到内核中而非需要时加载。</p><p>存放 netfilter 模块的目录有三个：<code>/lib/modules/$kernel_ver/net/{netfilter,ipv4/netfilter,ipv6/netfilter}</code>。<code>$kernel_ver</code> 代表内核版本号。</p><p>其中 ipv4/netfilter/ 存放的 ipv4 的 netfilter，ipv6/netfilter/ 存放的 ipv6 的 netfilter，<code>/lib/modules/$kernel_net/kernel/netnetfilter/</code> 存放的是同时满足 ipv4 和 ipv6 的 netfilter。在最后一个目录中放入更多的模块，是 netfilter 团队发展的目标，因为要维护 ipv4 和 ipv6 两个版本挺累的。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="242iptables-和-netfilter-的关系">2.4.2、iptables 和 netfilter 的关系<a class="hash-link" href="#242iptables-和-netfilter-的关系" title="标题的直接链接">​</a></h3><p>Linux 中最常用的基本防火墙软件叫做 iptables。iptables 防火墙通过与 Linux 内核网络堆栈中的包过滤钩子交互来工作。这些内核钩子被称为 netfilter 框架。</p><p>防火墙起作用的是 Netfilter，而 <strong>iptables 只是管理控制 netfilter 的工具</strong>，可以使用该工具进行相关规则的制定以及其他的动作。iptables 是用户层的程序，netfilter 是内核空间的，在 netfilter 刚加入到 Linux 中时，netfilter 是一个 Linux 的一个内核模块，要实现其他的防火墙行为还需要加载其他对应的模块，到了后来 netfilter 一部分必须的模块已经加入到内核中了。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="243netfilter-的结构">2.4.3、netfilter 的结构<a class="hash-link" href="#243netfilter-的结构" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="iptables" src="/assets/images/iptables-e59e35333c97d15fed01fad21dabb58d.png" width="1772" height="2255" class="img_ev3q"></p><p>想要完全理解这个图，得有一定的基础知识，下面我们需要理解几个概念：</p><ol><li><p>Netfilter Hooks：有五个 netfilter 钩子程序可以注册。当包通过堆栈时，它们将触发已经注册了这些钩子的内核模块。数据包触发的钩子取决于数据包是传入还是传出、数据包的目的地以及数据包是否在前一个点被丢弃或拒绝。</p><ul><li>NF<!-- -->_<!-- -->IP<!-- -->_<!-- -->PRE<!-- -->_<!-- -->ROUTING：在进入网络堆栈后不久，任何传入的流量都会触发这个钩子。这个钩子在决定将包发送到哪里之前被处理。</li><li>NF<!-- -->_<!-- -->IP<!-- -->_<!-- -->LOCAL<!-- -->_<!-- -->IN：如果传入的数据包的目的地是本地系统，则在该数据包被路由后触发该钩子。</li><li>NF<!-- -->_<!-- -->IP<!-- -->_<!-- -->FORWARD：如果传入的数据包要转发到另一个主机，则在路由完成后触发该钩子。</li><li>NF<!-- -->_<!-- -->IP<!-- -->_<!-- -->LOCAL<!-- -->_<!-- -->OUT：任何本地创建的出站流量一旦到达网络堆栈就会触发这个钩子。</li><li>NF<!-- -->_<!-- -->IP<!-- -->_<!-- -->POST<!-- -->_<!-- -->ROUTING：路由发生后和在线路上发出之前的任何传出或转发的流量会触发该钩子。</li></ul></li><li><p>IPTables Chains：正如你所看到的，内置链的名称反映了它们关联的 netfilter 钩子的名称：</p><ul><li>PREROUTING：由 NF<!-- -->_<!-- -->IP<!-- -->_<!-- -->PRE<!-- -->_<!-- -->ROUTING 钩子触发。</li><li>INPUT：由 NF<!-- -->_<!-- -->IP<!-- -->_<!-- -->LOCAL<!-- -->_<!-- -->IN 钩子触发。</li><li>FORWARD：由 NF<!-- -->_<!-- -->IP<!-- -->_<!-- -->FORWARD 钩子触发。</li><li>OUTPUT：由 NF<!-- -->_<!-- -->IP<!-- -->_<!-- -->LOCAL<!-- -->_<!-- -->OUT 钩子触发。</li><li>POSTROUTING：由 NF<!-- -->_<!-- -->IP<!-- -->_<!-- -->POST<!-- -->_<!-- -->ROUTING 钩子触发。</li></ul></li><li><p>IPTables Tables：iptables 防火墙使用表来组织其规则。这些表根据规则所使用的决策类型对规则进行分类。例如，如果一个规则处理网络地址转换，它将被放入 nat 表中。如果使用该规则来决定是否允许数据包继续到达它的目的地，它可能会被添加到 filter 表中。</p><ul><li><p>Filter Table：filter 表是 iptables 中使用最广泛的表之一。filter 表用于决定是让数据包继续到达预期目的地还是拒绝它的请求。用防火墙的说法，这被称为 &quot;过滤&quot; 包。该表提供了人们在讨论防火墙时想到的大部分功能。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 查看表中的链和规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -t filter -L</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain INPUT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain FORWARD </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain OUTPUT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>NAT Table：nat 表用于实现网络地址转换规则。可以转换源地址、源端口、目标地址、目标端口等。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 查看表中的链和规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -t nat -L</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain PREROUTING </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain INPUT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain OUTPUT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain POSTROUTING </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Mangle Table：mangle 表用于以各种方式改变数据包的 IP 头。例如，可以调整数据包的 TTL(生存时间)值，可以延长或缩短数据包维持的有效网络跳数。其他 IP 报头可以用类似的方式更改。</p><p>该表还可以在包上放置一个内部内核 &quot;标记&quot;，以便在其他表和其他网络工具中进行进一步处理。这个标记不接触实际的包，而是将标记添加到内核对包的表示中。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 查看表中的链和规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -t mangle -L</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain PREROUTING </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain INPUT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain FORWARD </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain OUTPUT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain POSTROUTING </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Raw Table：iptables 防火墙是有状态的，这意味着数据包根据它们与前一个数据包的关系进行评估。建立在 netfilter 框架之上的连接跟踪特性，允许 iptables 将数据包视为正在进行的连接或会话的一部分，而不是作为离散的、不相关的数据包流。通常在数据包到达网络接口后很快进行连接跟踪。</p><p>raw 表有一个定义非常狭窄的函数。它的唯一目的是提供一种机制来标记数据包，以便选择退出连接跟踪。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 查看表中的链和规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -t raw -L</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain PREROUTING </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain OUTPUT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Security Table：security 表用于在数据包上设置内部 SELinux 安全上下文标记，这将影响 SELinux 或其他可以解释 SELinux 安全上下文的系统处理包的方式。这些标记可以应用在每个包或每个连接的基础上。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 查看表中的链和规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -t security -L</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain INPUT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain FORWARD </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain OUTPUT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li></ol><p>到这里，再看上面这个图，可以非常清晰地看出 5 种彩色对应的 5 个表；每一种彩色都有该表对应的自己的多个链，也就是 hook 函数；另外，此图从 incoming package 和 locally generated package 两个角度分析了数据包的流转过程，并且整个过程中，经历了哪些 hook 函数关卡，根据用户的需求，可以在这些关卡设置规则。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="25iptables-命令">2.5、iptables 命令<a class="hash-link" href="#25iptables-命令" title="标题的直接链接">​</a></h2><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">Usage: iptables </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">-t TABLE</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> COMMAND CHAIN </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> expressions -j target </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这表示要操作 TABLE 表中的链，操作动作由 COMMAND 决定，例如添加一条规则、删除一条规则、列出规则列表等。</p><p>如果是向链中增加规则，则需要写出规则表达式用来检查数据包，并指明数据包被规则匹配上时应该做什么操作，例如允许该数据包 ACCEPT、拒绝该数据包 REJECT、丢弃该数据包 DROP，这些操作称为 target，由 &quot;-j&quot; 选项来指定。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="251iptables-语法">2.5.1、iptables 语法<a class="hash-link" href="#251iptables-语法" title="标题的直接链接">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">Commands:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Either long or short options are allowed.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --append  -A chain                       链尾部追加一条规则</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --delete  -D chain                       从链中删除能匹配到的规则</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --delete  -D chain rulenum               从链中删除第几条链，从1开始计算</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --insert  -I chain </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">rulenum</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">             向链中插入一条规则使其成为第rulenum条规则，从1开始计算</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --replace -R chain rulenum               替换链中的地rulenum条规则，从1开始计算</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --list    -L </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">chain </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">rulenum</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">           列出某条链或所有链中的规则</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --list-rules -S </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">chain </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">rulenum</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">        打印出链中或所有链中的规则</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --flush   -F </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">chain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">                     删除指定链或所有链中的所有规则</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --zero    -Z </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">chain </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">rulenum</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">           置零指定链或所有链的规则计数器</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --new     -N chain                       创建一条用户自定义的链</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --delete-chain  -X </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">chain</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">               删除用户自定义的链</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --policy  -P chain target                设置指定链的默认策略</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">为指定的target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --rename-chain  -E old new               重命名链名称，从old到new</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Options:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --proto  -p proto                      指定要检查哪个协议的数据包：可以是协议代码也可以是协议名称，</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                           如tcp,udp,icmp等。协议名和代码对应关系存放在/etc/protocols中</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                           省略该选项时默认检查所有协议的数据包，等价于all和协议代码0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --source -s address</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">/mask</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">        指定检查数据包的源地址，或者使用</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;--src&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --destination -d address</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">/mask</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">   指定检查数据包的目标地址，或者使用</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;--dst&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --in-interface  -i input name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">+</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">       指定数据包流入接口，若接口名后加</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;+&quot;</span><span class="token plain">，表示匹配该接口开头的所有接口</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --out-interface -o output name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">+</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">      指定数据包流出接口，若接口名后加</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;+&quot;</span><span class="token plain">，表示匹配该接口开头的所有接口</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --jump        -j target                  为规则指定要做的target动作，例如数据包匹配上规则时将要如何处理</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --goto        -g chain                   直接跳转到自定义链上</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --match       -m match                   指定扩展模块</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --numeric     -n                         输出数值格式的ip地址和端口号。默认会尝试反解为主机名和端口号对应的服务名</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --table       -t table                   指定要操作的table，默认table为filter</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --verbose     -v                         输出更详细的信息</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --line-numbers                           当list规则时，同时输出行号</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  --exact       -x                         默认统计流量时是以1000为单位的，使用此选项则使用1024为单位</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>iptables 支持 extension 匹配。支持两种扩展匹配：使用 &quot;-p&quot; 时的隐式扩展和使用 &quot;-m&quot; 时的显式扩展。根据指定的扩展，随后可使用不同的选项。在指定扩展项的后面可使用 &quot;-h&quot; 来获取该扩展项的语法帮助。</p><p>&quot;-p&quot; 选项指定的是隐式扩展，用于指定协议类型，每种协议类型都有一些子选项。常见协议和子选项如下说明：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">-p tcp 子选项</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    子选项：</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --source-port,--sport port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">:port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            指定源端口号或源端口范围。指定端口范围时格式为</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;range_start:range_end&quot;</span><span class="token plain">，最大范围为0:65535。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --destination-port,--dport port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">:port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            指定目标端口号或目标端口号范围。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --tcp-flags mask comp</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            匹配已指定的tcp flags。mask指定的是需要检查的flag列表，comp指定的是必须设置的flag。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            mask列表和comp列表之间用空格隔开，各自列表用逗号隔开，mask是列表范围，comp指定mask里面相同的标记都为1其余为0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            有效的flag值为：SYN ACK FIN RST URG PSH ALL NONE。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            例如：iptables -A FORWARD -p tcp --tcp-flags SYN,ACK,FIN,RST SYN</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            表示只匹配设置了SYN</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">而ACK、FIN和RST都为0数据包，也即只匹配TCP三次握手的第一次握手。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --syn</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            是</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;--tcp-flags SYN,ACK,FIN,RST SYN&quot;</span><span class="token plain">的简写格式。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-p udp 子选项</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    子选项：</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --source-port,--sport port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">:port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            指定源端口号或源端口范围。指定端口范围时格式为</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;range_start:range_end&quot;</span><span class="token plain">，最大范围为0:65535。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --destination-port,--dport port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">:port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            指定目标端口号或目标端口号范围。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-p icmp 子选项</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            子选项：</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --icmp-type </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">type</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">/code</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">typename</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            用于指定ICMP类型，可以是ICMP类型的数值代码或类型名称。有效的ICMP类型</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            可由iptables -p icmp -h获取。常用的是</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;echo-request&quot;</span><span class="token plain">和</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;echo-reply&quot;</span><span class="token plain">，分别</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            表示ping和pong，数值代号分别是8和0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            ping时先请求后响应：ping别人先出去8后进来0；别人ping自己，先进来8后出去0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>&quot;-m&quot; 选项指定的是显式扩展。其实隐式扩展也是要指定扩展名的，只不过默认已经知道所使用的扩展，于是可以省略。例如：<code>-p tcp --dport</code> = <code>-p tcp -m tcp --dport</code>。</p><p>常用的扩展和它们常用的选项如下：</p><ol><li><p><strong>iprange：匹配给定的 IP 地址范围。</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --src-range from</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">-to</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">：匹配给定的源地址范围</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --dst-range from</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">-to</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">：匹配给定的目标地址范围</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>multiport：离散的多端口匹配模块，如将 21、22、80 三个端口的规则合并成一条。</strong></p><p>最多支持写 15 个端口，其中 &quot;555:999&quot; 算 2 个端口。只有指定了 -p tcp 或 -p udp 时该选项才生效。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --source-ports,--sports port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">,port</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">,port:port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --destination-ports,--dports port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">,port</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">,port:port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --ports port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">,port</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">,port:port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">. ：不区分源和目标，只要是端口就行</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>state：状态扩展。结合 ip<!-- -->_<!-- -->conntrack 追踪会话的状态。</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --state state</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中 state 有如下 4 种：</p><ol><li>INVALID：非法连接（如 syn=1 fin=1 ）</li><li>ESTABLISHED：数据包处于已建立的连接中，它和连接的两端都相关联</li><li>NEW：新建连接请求的数据包，且该数据包没有和任何已有连接相关联</li><li>RELATED：表示数据包正在新建连接， 但它和已有连接是相关联的(如被动模式的 ftp 的命令连接和数据连接)</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">-m state --state NEW,ESTABLISHED -j ACCEPT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>string：匹配报文中的字符串。</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">--algo </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">kmp</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">bm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain">：两种算法，随便指定一种</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--string </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;string_pattern&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">iptables -A OUTPUT -m string --algo bm --sting </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;taobao.com&quot;</span><span class="token plain"> -j DROP</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>mac：匹配 MAC 地址，格式必须为 XX:XX:XX:XX:XX:XX。</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --mac-source address</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>limit：使用令牌桶(token bucket)来限制过滤连接请求数。</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">--limit RATE</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">/second/minute/hour/day</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">：允许的平均数量。如每分钟允许10次ping，即6秒一次ping。默认为3/hour。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--limit-burst：允许第一次涌进的并发数量。第一次涌进超出后就按RATE指定数来给出响应。默认值为5。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>例如：允许每分钟 6 次 ping，但第一次可以 ping 10 次。10 次之后按照 RATE 计算。所以，前 10 个 ping 包每秒能正常返回，从第 11 个 ping 包开始，每 10 秒允许一次 ping</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">iptables -A INPUT -d ServerIP -p icmp --icmp-type </span><span class="token number" style="color:rgb(9, 134, 88)">8</span><span class="token plain"> -m limit --limit </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain">/minute --limit-burst </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token plain"> -j ACCEPT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>connlimit：限制每个客户端的连接上限。</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">--connlimit-above n：连接数量高于上限n个时就执行TARGET</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如最多只允许某 ssh 客户端建立 3 个 ssh 连接，超出就拒绝。两种写法：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">iptables -A INPUT -d ServerIP -p tcp --dport </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"> -m connlimit --connlimit-above </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> -j DROP</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -A INPUT -d ServerIP -p tcp --dport </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"> -m connlimit </span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token plain"> --connlimit-above </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> -j  ACCEPT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这个模块虽然限制能力不错，但要根据环境计算出网页正常访问时需要建立的连接数，另外还要考虑使用 NAT 转换地址时连接数会翻倍的问题。</p><p>最后剩下 &quot;-j&quot; 指定的 target 还未说明，target 表示对匹配到的数据包要做什么处理，比如丢弃 DROP、拒绝 REJECT、接受 ACCEPT 等，除这 3 个 target 外，还支持很多种 target。以下是其中几种：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">DNAT：目标地址转换</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">SNAT:源地址转换</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">REDIRECT：端口重定向</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">MASQUERADE：地址伪装</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">其实也是源地址转换</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">RETURN：用于自定义链，自定义链中匹配完毕后返回到自定义的前一个链中继续向下匹配</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="252ip_conntrack-功能和-iptstate-命令">2.5.2、ip<!-- -->_<!-- -->conntrack 功能和 iptstate 命令<a class="hash-link" href="#252ip_conntrack-功能和-iptstate-命令" title="标题的直接链接">​</a></h3><p>ip<!-- -->_<!-- -->conntrack 提供追踪功能，后来改称为 nf<!-- -->_<!-- -->conntrack，由 nf<!-- -->_<!-- -->conntrack 模块提供。</p><p>只要一加载该模块，/proc/net/nf<!-- -->_<!-- -->conntrack 文件中就会记录下追踪的连接状态。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># yum install iptables-services</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl start iptables.service </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># modprobe nf_conntrack</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /proc/net/nf_conntrack</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ipv4     </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> tcp      </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">299</span><span class="token plain"> ESTABLISHED </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">src</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">dst</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.188 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">sport</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">dport</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">5464</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">src</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.188 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">dst</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">sport</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">5464</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">dport</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">ASSURED</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">mark</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">zone</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ipv4     </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> tcp      </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">431999</span><span class="token plain"> ESTABLISHED </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">src</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.188 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">dst</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">sport</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">5798</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">dport</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">src</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">dst</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.188 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">sport</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">dport</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">5798</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">ASSURED</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">mark</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">zone</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>这两条都是 ESTABLISH 状态的连接，分别是 192.168.0.181:22 &lt;-&gt; 192.168.0.188:5464 通信，192.168.0.188:5798 &lt;-&gt; 192.168.0.181:22 通信。</li></ul><p>也可以使用 iptstate 命令实时显示连接状态，它是像 top 工具一样的显示。该命令工具在 iptstate 包中，可能需要手动安装。如图为 iptstate 的一次结果。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">                                         IPTState - IPTables State Top</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Version: </span><span class="token number" style="color:rgb(9, 134, 88)">2.2</span><span class="token plain">.5        Sort: SrcIP           b: change sorting   h: </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">help</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Source                                      Destination                                 Prt State       TTL</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181:22                            </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.188:5464                          tcp ESTABLISHED   </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">:04:05</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.188:6117                          </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181:22                            tcp ESTABLISHED </span><span class="token number" style="color:rgb(9, 134, 88)">119</span><span class="token plain">:59:59</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.188:6126                          </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181:22                            tcp ESTABLISHED </span><span class="token number" style="color:rgb(9, 134, 88)">119</span><span class="token plain">:49:52</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.188:5798                          </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181:22                            tcp ESTABLISHED </span><span class="token number" style="color:rgb(9, 134, 88)">119</span><span class="token plain">:59:59</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 /proc/sys/net/netfilter/ 目录下的文件中定义了很多跟踪连接状态的规范，比如 nf<!-- -->_<!-- -->conntrack<!-- -->_<!-- -->tcp<!-- -->_<!-- -->timeout<!-- -->_<!-- -->time<!-- -->_<!-- -->wait 定义了 TCP 连接 4 次挥手主动断开方的倒数第二个阶段 TIME<!-- -->_<!-- -->WAIT 的值。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ls /proc/sys/net/netfilter/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_acct                        nf_conntrack_sctp_timeout_cookie_wait</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_buckets                     nf_conntrack_sctp_timeout_established</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_checksum                    nf_conntrack_sctp_timeout_heartbeat_acked</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_count                       nf_conntrack_sctp_timeout_heartbeat_sent</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_dccp_loose                  nf_conntrack_sctp_timeout_shutdown_ack_sent</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_dccp_timeout_closereq       nf_conntrack_sctp_timeout_shutdown_recd</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_dccp_timeout_closing        nf_conntrack_sctp_timeout_shutdown_sent</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_dccp_timeout_open           nf_conntrack_tcp_be_liberal</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_dccp_timeout_partopen       nf_conntrack_tcp_loose</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_dccp_timeout_request        nf_conntrack_tcp_max_retrans</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_dccp_timeout_respond        nf_conntrack_tcp_timeout_close</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_dccp_timeout_timewait       nf_conntrack_tcp_timeout_close_wait</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_events                      nf_conntrack_tcp_timeout_established</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_expect_max                  nf_conntrack_tcp_timeout_fin_wait</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_frag6_high_thresh           nf_conntrack_tcp_timeout_last_ack</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_frag6_low_thresh            nf_conntrack_tcp_timeout_max_retrans</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_frag6_timeout               nf_conntrack_tcp_timeout_syn_recv</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_generic_timeout             nf_conntrack_tcp_timeout_syn_sent</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_helper                      nf_conntrack_tcp_timeout_time_wait</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_icmp_timeout                nf_conntrack_tcp_timeout_unacknowledged</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_icmpv6_timeout              nf_conntrack_timestamp</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_log_invalid                 nf_conntrack_udp_timeout</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_max                         nf_conntrack_udp_timeout_stream</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_sctp_timeout_closed         nf_log</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nf_conntrack_sctp_timeout_cookie_echoed  nf_log_all_netns</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /proc/sys/net/netfilter/nf_conntrack_tcp_timeout_time_wait</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">120</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>nf<!-- -->_<!-- -->conntrack 在增加便利的同时会带来性能问题，nf<!-- -->_<!-- -->conntrack 会消耗一定的资源，所以在设计的时候默认给出了其最大的追踪数量，最大追踪数量值由 /proc/sys/net/netfilter/nf<!-- -->_<!-- -->conntrack<!-- -->_<!-- -->max 文件决定。默认是 262144 个。</p><p>这个值可能无法满足较高并发量的服务器的，所以可以将其增大一些，否则追踪数达到了最大值后，后续的所有连接都将排队被阻塞，可能会因此给出警告。但是无论如何要明白的是追踪是会消耗性能的，所以该值应该酌情考虑。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /proc/sys/net/netfilter/nf_conntrack_max</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">262144</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong><em>注意：nf<!-- -->_<!-- -->conntrack 模块不是一定需要显式装载才会被装载的，有些依赖它的模块被装载时该模块也会被装载。例如 iptables 命令中包含 iptables -t nat 时，就会装载该模块自动开启追踪，进而可能导致达到追踪 max 值而出错。</em></strong></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="253-m-state-的状态解释">2.5.3、-m state 的状态解释<a class="hash-link" href="#253-m-state-的状态解释" title="标题的直接链接">​</a></h3><p>使用 -m state 表示使用简称为 &quot;state&quot; 的模块。该模块提供 4 种状态：NEW、ESTABLISHED、RELATED 和 INVALID。但是这些状态和 TCP 三次握手四次挥手的十几种状态没任何关系。而且 state 提供的 4 种状态对于 tcp/udp/icmp 类型的数据包都是通用的。</p><p><em>注意：这四种状态是数据包的状态，不是客户端或者服务器当时所处的状态。也可以认为是防火墙 state 模块的状态，因为 state 模块在收到对应状态的包时会设置为相同的状态。</em></p><ol><li><p><strong>NEW 状态与 TCP/UDP/ICMP 数据包的关系</strong></p><p>为了建立一条连接，发送的第一个数据包(如 tcp 三次握手的第一次 SYN 数据包)的状态为 NEW。如果第一次连接没建立成功，则第二个继续请求的数据包已经不是 NEW 数据包了。</p><p>所以，如果不允许 NEW 状态的数据包表示不允许主动和对方建立连接，也不允许外界和本机建立连接。</p></li><li><p><strong>ESTABLISHED 状态与 tcp/udp/icmp 数据包的关系</strong></p><p>无论是 tcp 数据包、udp 数据包还是 icmp 数据包，只要发送的请求数据包穿过了防火墙，那么接下来双方传输的数据包状态都是 ESTABLISHED，也就是说发过去的和返回回来的都是 ESTABLISHED 状态数据包。</p></li><li><p><strong>RELATED 数据包的解释</strong></p><p>对于 RELATED 数据包的解释是：与当前任何连接都无关，完全是被动或临时建立的连接之间传输的数据包。</p><p>例如，图中客户端为了探测服务器的地址发送了 tracert 命令。</p><p><img loading="lazy" alt="conntrack related" src="/assets/images/conntrack related-21d069ab537ca40c64fc2f77e7d62f19.png" width="802" height="381" class="img_ev3q"></p><ol><li>这个命令首先会标记一个 tcp 数据包的 TTL 值为 1，当数据包到达第一个路由器该值就减 1，所以 TTL 变为 0 表示该数据包到了寿终正寝该 DROP 掉的时候。</li><li>然后该路由器就会发送一个 icmp 数据包（icmp-type=11）返回给客户端，这样客户端就知道了第一个路由器的地址。</li><li>接着客户端的 tracert 命令继续标记一个 TTL 为 2 的数据包向外发送，直到第二个路由器才被丢弃，第二个路由器又发送一个 icmp 包给客户端，这样客户端就知道了第二个路由器的地址。同理第三次也一样。</li></ol><p>在 tracert 探测的过程中，由路由器返回的 icmp 包都是 RELATED 状态的数据包。因为可以肯定的说，客户端发送给路由器的 tcp 数据包是走的一条连接，数据包被路由器丢弃后路由器发送的 icmp 数据包与原来的连接已经无关了，这是另外一条返回的连接。但是之所以有这个数据包，完全是因为前面的连接结束而产生的应答数据包。</p><p><strong>不过 RELATED 状态和协议无关，只要数据包是因为本机先送出一个数据包而导致另一条连接的产生，那么这个新连接的所有数据包都属于 RELATED 状态的数据包。</strong></p><p>这样就容易理解 ftp 被动模式设置的 related 状态了。在 ftp 服务器上的 21 号端口上开启了命令通道（也就是命令连接）后，以后无论是被动模式的随机数据端口还是主动模式的固定 20 数据端口，可以肯定的是数据通道的建立是由命令通道指定要开启的，所以这个数据通道中传输的数据包都是 RELATED 状态的。</p></li><li><p><strong>INVALID 状态的数据包</strong></p><p>所谓的 INVALID 状态，就是恶意的数据包。只要不是 ESTABLISHED、NEW、RELATED 状态的数据包，那么就一定是 INVALID 状态。对于 INVALID 数据包最应该放在链中的第一条，以防止恶意的循环攻击。</p></li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="254filter-表示例">2.5.4、filter 表示例<a class="hash-link" href="#254filter-表示例" title="标题的直接链接">​</a></h3><p>实验主机：ip 地址 192.168.0.181，安装 iptables-services 软件包，启动 iptables 服务。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># yum install iptables-services -y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl start iptables.service </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl enable iptables.service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li><p><strong>清空自定义链、清空规则、清空规则计数器。</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -X</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -F</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -Z</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>允许 192.168.0.0/24 网段连接 ssh(端口22)。</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A INPUT -s 192.168.0.0/24 -d 192.168.0.181 -p tcp --dport 22 -j ACCEPT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A OUTPUT -s 192.168.0.181 -p tcp --sport 22 -j ACCEPT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>设置 filter 表默认规则为 DROP。</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -P INPUT DROP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -P FORWARD DROP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -P OUTPUT DROP</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>一般防火墙对外是 ACCEPT 的，所以 OUTPUT 链采用默认的 ACCEPT。</p><p>由于将 INPUT 链设置为全部 DROP，因此除了前面设置的目标为 22 端口的数据包允许通过，其余全部丢弃，即使是 ping 环回地址。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ping -c 4 127.0.0.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">PING </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">56</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">84</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> bytes of data.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--- </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1 </span><span class="token function" style="color:rgb(0, 0, 255)">ping</span><span class="token plain"> statistics ---</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain"> packets transmitted, </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> received, </span><span class="token number" style="color:rgb(9, 134, 88)">100</span><span class="token plain">% packet loss, </span><span class="token function" style="color:rgb(0, 0, 255)">time</span><span class="token plain"> 3156ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>查看规则列表和统计数据。</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -L -n</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain INPUT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy DROP</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ACCEPT     tcp  --  </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.0/24       </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        tcp dpt:22</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain FORWARD </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy DROP</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain OUTPUT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy ACCEPT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ACCEPT     tcp  --  </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            tcp spt:22</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果加上 &quot;-v&quot; 选项，则会显示每条规则上的流量统计数据。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -L -n -v</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain INPUT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy DROP </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain"> packets, </span><span class="token number" style="color:rgb(9, 134, 88)">336</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">pkts bytes target     prot opt </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain">     out     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">269</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">19900</span><span class="token plain"> ACCEPT     tcp  --  *      *       </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.0/24       </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        tcp dpt:22</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain FORWARD </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy DROP </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> packets, </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">pkts bytes target     prot opt </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain">     out     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain OUTPUT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy ACCEPT </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain"> packets, </span><span class="token number" style="color:rgb(9, 134, 88)">336</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">pkts bytes target     prot opt </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain">     out     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">92</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">10904</span><span class="token plain"> ACCEPT     tcp  --  *      *       </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            tcp spt:22</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>放行环回设备的进出数据包(环回地址的放行很重要)。</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A INPUT -i lo -s 127.0.0.1 -d 127.0.0.1 -j ACCEPT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A OUTPUT -o lo -s 127.0.0.1 -d 127.0.0.1 -j ACCEPT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ping 127.0.0.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">PING </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">56</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">84</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> bytes of data.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0.041</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0.015</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--- </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1 </span><span class="token function" style="color:rgb(0, 0, 255)">ping</span><span class="token plain"> statistics ---</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> packets transmitted, </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> received, </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">% packet loss, </span><span class="token function" style="color:rgb(0, 0, 255)">time</span><span class="token plain"> 1044ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">rtt min/avg/max/mdev </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0.015</span><span class="token plain">/0.028/0.041/0.013 ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>但是不建议直接写 127.0.0.1，而是省略目标地址和源地址，因为 ping 本机 ip 地址最后交给环回设备但是不是交给 127.0.0.1 的，而是交给 127.0.0 网段的其他地址。所以应该这么写：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A INPUT -i lo -j ACCEPT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A OUTPUT -o lo -j ACCEPT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>所以可以将前面多余的规则删除掉。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -D INPUT 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -D OUTPUT 2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>能自己 ping 自己的 IP，也能 ping 别人的 IP，但是别人不能 ping 自己。</strong></p><p>ping 的过程实际上是 ping 请求对方，然后对方 pong 回应，协议类型为 icmp。其中 ping 请求时，icmp 类型为 echo-request，数值代号为 8，pong 回应时的 icmp 类型为 echo-reply，数值代号为 0。</p><p>所以本机向外 ping 时，流出的是 echo-request 数据包，流入的是 echo-reply 数据包。而外界 ping 本机时，则是流入 echo-request 数据包，流出 echo-reply 数据包。因此，要允许本机向外 ping，只需允许 icmp-type=8 的流出包、icmp-type=0 的流入包即可，又由于前面的试验中设置了 INPUT 和 OUTPUT 链的默认规则为 DROP，所以外界主机无法 ping 本机。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A OUTPUT -p icmp --icmp-type=8 -j ACCEPT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A INPUT -p icmp --icmp-type=0 -j ACCEPT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>安装 httpd，让外界能够访问 web 页面(端口为80)。</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A INPUT -d 192.168.0.181 -p tcp --dport 80 -j ACCEPT </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A OUTPUT -s 192.168.0.181 -p tcp --sport 80 -j ACCEPT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>替换 ssh 服务和 web 服务的规则，并写出基于 ip<!-- -->_<!-- -->conntrack 放行 ssh 和 web 的规则(进入的数据包的状态只可能会是 NEW 和 ESTABLISHED，出去的状态只可能是 ESTABLISHED)</strong></p><p>放行 ssh：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -R INPUT 1 -s 192.168.0.0/24 -d 192.168.0.181 -p tcp --dport 22 -m state --state=NEW,ESTABLISHED -j ACCEPT </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -R OUTPUT 1 -s 192.168.0.181 -p tcp --sport 22 -m state --state=ESTABLISHED -j ACCEPT </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>放行 web：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -R INPUT 4 -d 192.168.0.181 -p tcp --dport 80 -m state --state=NEW,ESTABLISHED -j ACCEPT </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -R OUTPUT 4 -s 192.168.0.181 -p tcp --sport 80 -m state --state=ESTABLISHED -j ACCEPT </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -L -n --line-number</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain INPUT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy DROP</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">num  target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">    ACCEPT     tcp  --  </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.0/24       </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        tcp dpt:22 state NEW,ESTABLISHED</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">    ACCEPT     all  --  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0         </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain">    ACCEPT     icmp --  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            icmptype </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain">    ACCEPT     tcp  --  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        tcp dpt:80 state NEW,ESTABLISHED</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain FORWARD </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy DROP</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">num  target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain OUTPUT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy DROP</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">num  target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">    ACCEPT     tcp  --  </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            tcp spt:22 state ESTABLISHED</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">    ACCEPT     all  --  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0         </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain">    ACCEPT     icmp --  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            icmptype </span><span class="token number" style="color:rgb(9, 134, 88)">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain">    ACCEPT     tcp  --  </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            tcp spt:80 state ESTABLISHED</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这样的设置使得外界可以和主机建立会话，但是由主机出去的数据包则一定只能是 ESTABLISHED 状态的服务发出的，这样本机想主动和外界建立会话是不可能的。这样就实现了状态监测的功能，防止黑客通过开放的 22 端口或 80 端口植入木马并主动联系黑客。</p></li><li><p><strong>放行外界 ping 自己，但是要基于 ip<!-- -->_<!-- -->conntrack 来放行。</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A INPUT -d 192.168.0.181 -p icmp --icmp-type=8 -m state --state=NEW,ESTABLISHED -j ACCEPT </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A OUTPUT -s 192.168.0.181 -p icmp --icmp-type=0 -m state --state=ESTABLISHED -j ACCEPT </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>安装 vsftpd，并设置其防火墙。</strong></p><p>由于 ftp 有主动模式和被动模式，被动模式的数据端口不定，且使用哪种模式是由客户端决定的，这使得 ftp的防火墙设置比较复杂，但是借助 netfilter 的 state 模块，设置就简单的多了。</p><p>首先装载其专门的模块 nf<!-- -->_<!-- -->conntrack<!-- -->_<!-- -->ftp。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># modprobe nf_conntrack_ftp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>也可以写入 /etc/sysconfig/iptables-config 的 &quot;IPTABLES<!-- -->_<!-- -->MODULES=&quot;nf<!-- -->_<!-- -->conntrack<!-- -->_<!-- -->ftp&quot;。</p><p>然后编写规则：放行 21 端口的进入数据包，放行 related 关联数据包，放行出去的包。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A INPUT -d 192.168.0.181 -p tcp --dport 21 -m state --state=NEW,ESTABLISHED -j ACCEPT </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A INPUT -d 192.168.0.181 -m state --state=RELATED,ESTABLISHED -j ACCEPT </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A OUTPUT -s 192.168.0.181 -m state --state=ESTABLISHED -j ACCEPT </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><p>以上示例完成后，得到的总规则集如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -L -n --line-numbers </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain INPUT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy DROP</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">num  target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">    ACCEPT     tcp  --  </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.0/24       </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        tcp dpt:22 state NEW,ESTABLISHED</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">    ACCEPT     all  --  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0         </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain">    ACCEPT     icmp --  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            icmptype </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain">    ACCEPT     tcp  --  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        tcp dpt:80 state NEW,ESTABLISHED</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">    ACCEPT     icmp --  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        icmptype </span><span class="token number" style="color:rgb(9, 134, 88)">8</span><span class="token plain"> state NEW,ESTABLISHED</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain">    ACCEPT     tcp  --  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        tcp dpt:21 state NEW,ESTABLISHED</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token plain">    ACCEPT     all  --  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        state RELATED,ESTABLISHED</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain FORWARD </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy DROP</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">num  target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain OUTPUT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy DROP</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">num  target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">    ACCEPT     tcp  --  </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            tcp spt:22 state ESTABLISHED</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">    ACCEPT     all  --  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0         </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain">    ACCEPT     icmp --  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            icmptype </span><span class="token number" style="color:rgb(9, 134, 88)">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain">    ACCEPT     tcp  --  </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            tcp spt:80 state ESTABLISHED</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">    ACCEPT     icmp --  </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            icmptype </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> state ESTABLISHED</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain">    ACCEPT     all  --  </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            state ESTABLISHED</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>现在 iptables 已经有很多规则，但是也足够乱的。不仅想看懂挺复杂，在数据包检查的时候性能也更差，所以有必要将它们合并成简单易懂的规则。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="255优化规则">2.5.5、优化规则<a class="hash-link" href="#255优化规则" title="标题的直接链接">​</a></h3><p>执行 iptables-save 命令，可以 dump 出当前内核维护的 netfilter 指定表中的规则，默认导出 filter 表。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables-save -t filter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Generated by iptables-save v1.4.21 on Wed Sep 29 06:17:54 2021</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">*filter</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">:INPUT DROP </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain">:885</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">:FORWARD DROP </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">:0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">:OUTPUT DROP </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">66</span><span class="token plain">:21100</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A INPUT -s </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.0/24 -d </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -p tcp -m tcp --dport </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"> -m state --state NEW,ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A INPUT -i lo -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A INPUT -p icmp -m icmp --icmp-type </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A INPUT -d </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -p tcp -m tcp --dport </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"> -m state --state NEW,ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A INPUT -d </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -p icmp -m icmp --icmp-type </span><span class="token number" style="color:rgb(9, 134, 88)">8</span><span class="token plain"> -m state --state NEW,ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A INPUT -d </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -p tcp -m tcp --dport </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain"> -m state --state NEW,ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A INPUT -d </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A OUTPUT -s </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -p tcp -m tcp --sport </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"> -m state --state ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A OUTPUT -o lo -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A OUTPUT -p icmp -m icmp --icmp-type </span><span class="token number" style="color:rgb(9, 134, 88)">8</span><span class="token plain"> -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A OUTPUT -s </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -p tcp -m tcp --sport </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"> -m state --state ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A OUTPUT -s </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -p icmp -m icmp --icmp-type </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> -m state --state ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A OUTPUT -s </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -m state --state ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">COMMIT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Completed on Wed Sep 29 06:17:54 2021</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从导出结果中可以看到，input 链中有好几条规则都是针对 state=NEW,ESTABLISHED 而建立的，同理 OUTPUT 链中的 state=ESTABLISHED，且他们的 target 都是一样的，这样的规则可以考虑是否能够合并。</p><p><em>注意：环回接口 lo 一定要显式指定所有类型的数据都通过。</em></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># INPUT:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A INPUT -s </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.0/24 -d </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -p tcp -m tcp --dport </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"> -m state --state NEW,ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A INPUT -i lo -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A INPUT -p icmp -m icmp --icmp-type </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A INPUT -d </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -p tcp -m tcp --dport </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"> -m state --state NEW,ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A INPUT -d </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -p icmp -m icmp --icmp-type </span><span class="token number" style="color:rgb(9, 134, 88)">8</span><span class="token plain"> -m state --state NEW,ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A INPUT -d </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -p tcp -m tcp --dport </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain"> -m state --state NEW,ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A INPUT -d </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 可以考虑合并如下：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># INPUT:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A INPUT -d </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -p tcp -m multiport --destination-ports </span><span class="token number" style="color:rgb(9, 134, 88)">21,22</span><span class="token plain">,80 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A INPUT -d </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -p icmp -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A INPUT -i lo -j ACCEPT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># OUTPUT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A OUTPUT -s </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -p tcp -m tcp --sport </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"> -m state --state ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A OUTPUT -o lo -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A OUTPUT -p icmp -m icmp --icmp-type </span><span class="token number" style="color:rgb(9, 134, 88)">8</span><span class="token plain"> -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A OUTPUT -s </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -p tcp -m tcp --sport </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"> -m state --state ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A OUTPUT -s </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -p icmp -m icmp --icmp-type </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> -m state --state ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A OUTPUT -s </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -m state --state ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 可以考虑合并如下：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># OUTPUT:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A OUTPUT -s </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -m state --state ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A OUTPUT -s </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -p icmp -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-A OUTPUT -o lo -j ACCEPT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过上述思路的净化，最终可以得到如下的规则集</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -L -n --line-numbers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain INPUT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy DROP</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">num  target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">    ACCEPT     tcp  --  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        multiport dports </span><span class="token number" style="color:rgb(9, 134, 88)">21,22</span><span class="token plain">,80 state NEW,RELATED,ESTABLISHED</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">    ACCEPT     icmp --  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181     </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain">    ACCEPT     all  --  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0         </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain FORWARD </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy DROP</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">num  target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Chain OUTPUT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">policy DROP</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">num  target     prot opt </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain">               destination       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">    ACCEPT     all  --  </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            state ESTABLISHED</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">    ACCEPT     icmp --  </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181        </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0         </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain">    ACCEPT     all  --  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0            </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0/0         </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其实学到这里，可以算是已经触及到 iptables filter 表的核心了，针对用户不同的需求，可以灵活定制了，后面会给出最佳实践。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="256保存规则">2.5.6、保存规则<a class="hash-link" href="#256保存规则" title="标题的直接链接">​</a></h3><p>使用 iptables 写的规则都存放在内存中，内核会维护 netfilter 的每张表中的规则，所以重启 iptables &quot;服务&quot; 会使内存中的规则列表全部被清空。</p><p>要想手动写的规则长期有效，需要将规则保存到持久存储文件中，例如 iptables &quot;服务&quot; 启动时默认加载的脚本配置文件 /etc/sysconfig/iptables。</p><p>有两种方法保存规则：</p><ol><li><p>直接保存到 /etc/sysconfig/iptables 中</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">service</span><span class="token plain"> iptables save</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>可自定义保存位置</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">iptables-save </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /etc/sysconfig/iptables</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables-save </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /etc/sysconfig/iptables.20211005</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><p>恢复规则的方法：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">iptables-restore </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain"> /etc/sysconfig/iptables</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables-restore </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain"> /etc/sysconfig/iptables.20211005</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="257自定义链">2.5.7、自定义链<a class="hash-link" href="#257自定义链" title="标题的直接链接">​</a></h3><p>自定义链是被主链引用的。引用位置由 &quot;-j&quot; 指定自定义链名称，表示跳转到自定义链并匹配其内部规则列表。</p><p>例如，在 INPUT 链中的第三条规则为自定义链的引用规则，则数据包匹配到了第三条时进入自定义链匹配，匹配完自定义链后如果定义了返回主链的 RETURN 动作，则返回主链继续向下匹配，如果没有定义 RETURN 动作，则匹配结束。</p><p><img loading="lazy" alt="self defined chains" src="/assets/images/self defined chains-73e846a7efa95d4be9654ba42b555ce3.png" width="551" height="545" class="img_ev3q"></p><p>创建一条自定义链。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -N mychain</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>向其中加入一些基于安全的攻防规则，让每次数据包进入都匹配一次攻防链。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A mychain -d 255.255.255.255 -p icmp -j DROP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A mychain -d 192.168.255.255 -p icmp -j DROP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A mychain -p tcp ! --syn -m state --state NEW -j DROP </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A mychain -p tcp --tcp-flags ALL ALL -j DROP </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A mychain -p tcp --tcp-flags ALL NONE -j DROP </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在自定义链中的最后一条加上一条返回主链的规则，表示匹配完自定义后继续回到主链进行匹配。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A mychain -d 192.168.0.181/32 -j RETURN</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在主链的适当位置加上一条引用主链的规则。表示数据包匹配到了这个位置开始进入自定义链匹配，如果自定义链都没被匹配而是被最后的 RETURN 规则匹配，则回到主链再次匹配。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -I INPUT -d 192.168.0.181/32 -j mychain </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>如果不指定插入到第几条规则，默认插入第一条。</li></ul><p>删除自定义链：需要先清空自定义链，去除被引用记录，然后使用 -X 删除空的自定义链。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -F mychain </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -D INPUT 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -X mychain</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以使用 -E 命令重命名自定义链。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2571自定义链示例">2.5.7.1、自定义链示例<a class="hash-link" href="#2571自定义链示例" title="标题的直接链接">​</a></h4><p>如果我们在云服务厂商那里买了一台云服务器，经常会遇到别人暴力破解我们的 sshd 服务，为了抑制这种情况的发生，我们通过下面几个步骤实现。
第一步：编写检测恶意 IP 的脚本</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@brinnatt ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /security/deny_sshcrack.sh </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#! /bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 提取所有的IP到black.list文件中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">cat</span><span class="token plain"> /var/log/secure</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token function" style="color:rgb(0, 0, 255)">awk</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;/Failed/{print $(NF-3)}&#x27;</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token function" style="color:rgb(0, 0, 255)">sort</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token function" style="color:rgb(0, 0, 255)">uniq</span><span class="token plain"> -c</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token function" style="color:rgb(0, 0, 255)">awk</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;{print $2&quot;=&quot;$1;}&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /usr/local/bin/black.list</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 设定次数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">define</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:rgb(9, 134, 88)">i</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token variable function" style="color:rgb(0, 0, 255)">cat</span><span class="token variable" style="color:rgb(9, 134, 88)">  /usr/local/bin/black.list</span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">IP</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token variable builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token variable" style="color:rgb(9, 134, 88)"> $i </span><span class="token variable operator" style="color:rgb(0, 0, 0)">|</span><span class="token variable function" style="color:rgb(0, 0, 255)">awk</span><span class="token variable" style="color:rgb(9, 134, 88)"> -F</span><span class="token variable operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable string" style="color:rgb(163, 21, 21)">&#x27;{print $1}&#x27;</span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">NUM</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token variable builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token variable" style="color:rgb(9, 134, 88)"> $i</span><span class="token variable operator" style="color:rgb(0, 0, 0)">|</span><span class="token variable function" style="color:rgb(0, 0, 255)">awk</span><span class="token variable" style="color:rgb(9, 134, 88)"> -F</span><span class="token variable operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable string" style="color:rgb(163, 21, 21)">&#x27;{print $2}&#x27;</span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$NUM</span><span class="token plain"> -gt </span><span class="token variable" style="color:rgb(9, 134, 88)">$define</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    /usr/sbin/iptables -C DENY_SSHCRACK -s </span><span class="token variable" style="color:rgb(9, 134, 88)">$IP</span><span class="token plain"> -j DROP </span><span class="token operator" style="color:rgb(0, 0, 0)">&amp;&gt;</span><span class="token plain"> /dev/null</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$?</span><span class="token plain"> -gt </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token keyword" style="color:rgb(0, 0, 255)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        /usr/sbin/iptables -I DENY_SSHCRACK </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> -s </span><span class="token variable" style="color:rgb(9, 134, 88)">$IP</span><span class="token plain"> -j DROP</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token keyword" style="color:rgb(0, 0, 255)">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@brinnatt ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># chmod +x /security/deny_sshcrack.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第二步：创建自定义链专门用来过滤恶意 IP</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@brinnatt ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -N DENY_SSHCRACK</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@brinnatt ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A DENY_SSHCRACK -i eth0 -j RETURN</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>脚本会自动向该自定义链中插入过滤规则</li></ul><p>第三步：创建任务计划</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@brinnatt ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># crontab -l</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">*/3 * * * * /security/deny_sshcrack.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>注意，先要熟练撑握任务计划应用，不然很有可能任务不生效，特别是要注意 crontab 的配置文件，里面的 PATH 如果没有包含脚本中的命令，会出现 command not found，从而任务计划失败。</li><li>本来通过 tcp<!-- -->_<!-- -->wrapper 可以更简单实现，可惜由于安全原因 openssh v6.7 以后不支持 tcp<!-- -->_<!-- -->wrapper。</li><li>这种脚本实现的方式固然可以，但是有些繁琐，有一个开源项目 fail2ban，实现起来简单而且功能强大。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="258nat-表">2.5.8、NAT 表<a class="hash-link" href="#258nat-表" title="标题的直接链接">​</a></h3><p>NAT 依赖于 ip<!-- -->_<!-- -->forward，因此需要先开启它。NAT 的基础是 nf<!-- -->_<!-- -->conntrack，用来记录 NAT 表的映射关系。</p><p>NAT 有三个作用：</p><ol><li><strong>地址转换</strong>：让内网(私有地址)可以共用一个或几个公网地址连接 Internet。这是从内向外的，需要在网关式防火墙的 POSTROUTING 处修改源地址，这是 SNAT 功能。</li><li><strong>保护内网服务器</strong>：内网主机连接 Internet 使用的是公网地址，对外界而言是看不到内网服务器地址的，所以外界想要访问内部主机只能经过防火墙主机的公网地址，然后将目标地址转换为内网服务器地址，这起到了保护内网服务器的作用。转换目标地址需要在网关式防火墙的 PREROUTING 链处修改，这是 DNAT 功能。</li><li><strong>端口映射</strong>：DNAT 是修改目标地址，端口映射是修改目标端口。如将 web 服务器的 8080 端口映射为防火墙的 80 端口。</li></ol><p>外网主机和内网主机通信有两种情况的数据包：一种情况是建立NEW状态的新请求连接数据包，一种是回应的数据包。</p><p>无论哪种情况，在 NEW 状态数据包经过地址转换之后会在防火墙内存中维护一张 NAT 表，保存未完成连接的地址转换记录，这样当回应数据包到达防火墙时可以根据这些记录路由给正确的主机。</p><p>也就是说，SNAT 主要应付的是内部主机连接到 Internet 的源地址转换，转换的位置是 POSTROUTING 链；DNAT 主要应付的是外部主机连接内部服务器防止内部服务器被攻击的目标地址转换，转换位置在 PREROUTING；端口映射可以在多个地方转换。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2581配置网关以及转发">2.5.8.1、配置网关以及转发<a class="hash-link" href="#2581配置网关以及转发" title="标题的直接链接">​</a></h4><p><img loading="lazy" alt="ipv4_forward" src="/assets/images/ipv4_forward-1caba53cf2e9ef632a91e701642f54ca.png" width="750" height="293" class="img_ev3q"></p><p>实验环境如上图所示：</p><ul><li>arm64v8 作为转发主机有两个网卡两个网段，一个是 192.168.0.0/24 网段和 172.16.100.0/24 网段；</li><li>x86 主机网关指向 arm64v8 主机；</li><li>aarch64 主机网关指向 arm64v8 主机 ；</li></ul><p>实验步骤：</p><ol><li><p>x86 主机 ping arm64v8 主机 192.168.0.181 网卡，aarch64 主机 ping arm64v8 主机 172.16.100.11 网卡。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># route -n                   # 查看路由</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Kernel IP routing table</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0         </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181   </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0         UG    </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">      </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">        </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> ens32</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">169.254</span><span class="token plain">.0.0     </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0         </span><span class="token number" style="color:rgb(9, 134, 88)">255.255</span><span class="token plain">.0.0     U     </span><span class="token number" style="color:rgb(9, 134, 88)">1002</span><span class="token plain">   </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">        </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> ens32</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.0     </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0         </span><span class="token number" style="color:rgb(9, 134, 88)">255.255</span><span class="token plain">.255.0   U     </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">      </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">        </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> ens32</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ping 192.168.0.181     # 可以通</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">PING </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">56</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">84</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> bytes of data.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2.49</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1.70</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2.15</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--- </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181 </span><span class="token function" style="color:rgb(0, 0, 255)">ping</span><span class="token plain"> statistics ---</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> packets transmitted, </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> received, </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">% packet loss, </span><span class="token function" style="color:rgb(0, 0, 255)">time</span><span class="token plain"> 2004ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">rtt min/avg/max/mdev </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1.703</span><span class="token plain">/2.118/2.498/0.325 ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># route -n               # 查看路由</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Kernel IP routing table</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0         </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.11   </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0         UG    </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">      </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">        </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> eth0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">169.254</span><span class="token plain">.0.0     </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0         </span><span class="token number" style="color:rgb(9, 134, 88)">255.255</span><span class="token plain">.0.0     U     </span><span class="token number" style="color:rgb(9, 134, 88)">1002</span><span class="token plain">   </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">        </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> eth0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.0    </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">.0.0         </span><span class="token number" style="color:rgb(9, 134, 88)">255.255</span><span class="token plain">.255.0   U     </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">      </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">        </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> eth0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ping 172.16.100.11 # 可以通</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">PING </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.11 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.11</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">56</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">84</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> bytes of data.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.11: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0.558</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.11: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0.591</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.11: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0.587</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--- </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.11 </span><span class="token function" style="color:rgb(0, 0, 255)">ping</span><span class="token plain"> statistics ---</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> packets transmitted, </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> received, </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">% packet loss, </span><span class="token function" style="color:rgb(0, 0, 255)">time</span><span class="token plain"> 2097ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">rtt min/avg/max/mdev </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0.558</span><span class="token plain">/0.578/0.591/0.031 ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>结论：对于中间的 arm64v8 这台主机来说，有两个直连网段，192.168.0.0/24 网段和 172.16.100.0/24 网段，同一网段内的主机可以相互通信是理所当然的。</p></li><li><p>x86 主机 ping arm64v8 主机 172.16.100.11 网卡，x86 主机 ping aarch64 主机 172.16.100.12 网卡。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ping 172.16.100.11 # 可以通</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">PING </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.11 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.11</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">56</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">84</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> bytes of data.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.11: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">3.44</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.11: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1.60</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.11: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1.66</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--- </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.11 </span><span class="token function" style="color:rgb(0, 0, 255)">ping</span><span class="token plain"> statistics ---</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> packets transmitted, </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> received, </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">% packet loss, </span><span class="token function" style="color:rgb(0, 0, 255)">time</span><span class="token plain"> 2004ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">rtt min/avg/max/mdev </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1.606</span><span class="token plain">/2.239/3.446/0.855 ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ping 172.16.100.12 # 不可以通</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">PING </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">56</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">84</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> bytes of data.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--- </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12 </span><span class="token function" style="color:rgb(0, 0, 255)">ping</span><span class="token plain"> statistics ---</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">32</span><span class="token plain"> packets transmitted, </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> received, </span><span class="token number" style="color:rgb(9, 134, 88)">100</span><span class="token plain">% packet loss, </span><span class="token function" style="color:rgb(0, 0, 255)">time</span><span class="token plain"> 31011ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>结论：这个实验可能会让人疑惑，因为它涉及一个很重要的知识点，<strong>IP 地址属于内核，不属于网卡</strong>。</p><ul><li><p>对于 arm64v8 这台主机来说，内核手里握着两个 IP 地址，192.168.0.181 和 172.16.100.11，x86 主机的 192.168.0.124 跟 arm64v8 主机的 192.168.0.181 属于直连，也就是说可以直达 arm64v8 主机的内核网络栈，所以可以 ping 通 172.16.100.11。</p></li><li><p>而 172.16.100.12 并不在 arm64v8 主机内核手上，而在另外一个主机 aarch64 内核手上，x86 主机想要通过 arm64v8 主机 ping 通 aarch64 主机，必须要求 arm64v8 这个主机<strong>开启转发功能</strong>。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">方法：echo </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /proc/sys/net/ipv4/ip_forward</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li><li><p>开启 arm64v8 主机的转发功能，x86 主机再 ping aarch64 主机的 172.16.100.12 试试</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /proc/sys/net/ipv4/ip_forward</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ping 172.16.100.12         # 可以通</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">PING </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">56</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">84</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> bytes of data.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">63</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">4.17</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">63</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2.96</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">63</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2.35</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">63</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">3.16</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">63</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2.16</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--- </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12 </span><span class="token function" style="color:rgb(0, 0, 255)">ping</span><span class="token plain"> statistics ---</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain"> packets transmitted, </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain"> received, </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">% packet loss, </span><span class="token function" style="color:rgb(0, 0, 255)">time</span><span class="token plain"> 4006ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">rtt min/avg/max/mdev </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">2.163</span><span class="token plain">/2.963/4.175/0.711 ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2582配置网关防火墙">2.5.8.2、配置网关防火墙<a class="hash-link" href="#2582配置网关防火墙" title="标题的直接链接">​</a></h4><p>打开转发后就可以对 filter 表的 FORWARD 链进行设置了，只要是被 forward 的数据包都会受到防火墙的 &quot;钩子伺候&quot;，并进行一番检查。</p><p><img loading="lazy" alt="ipv4_forward1" src="/assets/images/ipv4_forward1-c7198b4263341a75e0c7b40bdc201a35.png" width="750" height="265" class="img_ev3q"></p><p>要注意的是，此时防火墙是负责两个网段的，转发后的数据包状态并不会因为经过 FORWARD 而改变。</p><p>比如 x86 主机发送 NEW 状态的数据包到 aarch64 主机，经过 arm64v8 主机 FORWARD 链到达 aarch64 主机，数据包的状态还是 NEW。</p><p>实验步骤(延续上一个实验)：</p><ol><li><p>当前 arm64v8 主机已打开转发，192.168.0.124 可以 ping 通 172.16.100.12；设置 arm64v8 主机 FORWARD 链为 DROP，看能否 ping 通。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ping 172.16.100.12         # 当前可以 Ping 通</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">PING </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">56</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">84</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> bytes of data.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">63</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1.74</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">63</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2.22</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">63</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2.81</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--- </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12 </span><span class="token function" style="color:rgb(0, 0, 255)">ping</span><span class="token plain"> statistics ---</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> packets transmitted, </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> received, </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">% packet loss, </span><span class="token function" style="color:rgb(0, 0, 255)">time</span><span class="token plain"> 2003ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">rtt min/avg/max/mdev </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1.745</span><span class="token plain">/2.259/2.810/0.437 ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -P FORWARD DROP   # 设置 FORWARD 默认 DROP</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ping 172.16.100.12         # 不通</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">PING </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">56</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">84</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> bytes of data.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--- </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12 </span><span class="token function" style="color:rgb(0, 0, 255)">ping</span><span class="token plain"> statistics ---</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token plain"> packets transmitted, </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> received, </span><span class="token number" style="color:rgb(9, 134, 88)">100</span><span class="token plain">% packet loss, </span><span class="token function" style="color:rgb(0, 0, 255)">time</span><span class="token plain"> 6004ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>arm64v8 主机 FORWARD 链设置如下规则，再 ping。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A FORWARD -m state --state NEW,ESTABLISHED -j ACCEPT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ping 172.16.100.12         # 可以通</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">PING </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">56</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">84</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> bytes of data.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">63</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">4.14</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">63</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">4.27</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.12: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">63</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">7.98</span><span class="token plain"> ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>转发过程中，数据包的状态是不会变的，所以在 FORWARD 链中定义规则类似其它链，只是数据包的来回都是通过 FORWARD 链。</li></ul></li></ol><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2583snat">2.5.8.3、SNAT<a class="hash-link" href="#2583snat" title="标题的直接链接">​</a></h4><p><img loading="lazy" alt="SNAT" src="/assets/images/SNAT-9a5a284adbf148c22ba340bb7c16b3bf.png" width="901" height="466" class="img_ev3q"></p><p>该实验环境是我当前的生产环境：aarch64 主机和 arm64v8 主机都是办公台式机，网络拓扑和关键信息如图所示。由于移动运营商不再为用户提供动态公网 IP 地址，所以路由器 WAN 口也是私有地址；我的办公 Router 和运营商的 Router 都默认设置 SNAT，因此，当前可以连入互联网的节点截止到 arm64v8 这台主机，aarch64 主机不能上网。</p><p>现在使用 SNAT 技术使 aarch64 主机也可以上网，很明显需要在 arm64v8 这台主机上面配置。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ping baidu.com        # 当前是 ping 不通 baidu.com</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /proc/sys/net/ipv4/ip_forward</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -t nat -A POSTROUTING -s 172.16.100.0/24 -j SNAT --to-source 192.168.0.181</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ping baidu.com        # 现在 ping baidu.com 可以通</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">PING baidu.com </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">220.181</span><span class="token plain">.38.251</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">56</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">84</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> bytes of data.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">220.181</span><span class="token plain">.38.251 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">220.181</span><span class="token plain">.38.251</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">46</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">48.9</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">220.181</span><span class="token plain">.38.251 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">220.181</span><span class="token plain">.38.251</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">46</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">146</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"> bytes from </span><span class="token number" style="color:rgb(9, 134, 88)">220.181</span><span class="token plain">.38.251 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">220.181</span><span class="token plain">.38.251</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">icmp_seq</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ttl</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">46</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">time</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">145</span><span class="token plain"> ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>另外，设置 SNAT 的写法有多种方式，如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">iptables -t NAT -A POSTROUTING -s </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.0/24 -o wlp6s0u1 -j SNAT --to-source </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -t NAT -A POSTROUTING -s </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.0/24 -o wlp6s0u1 -j SNAT --to-source </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.100-192.168.0.200</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -t NAT -A POSTROUTING -s </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.0/24 -o wlp6s0u1 -j MASQUERADE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>第一条语句表示将内网1向外发出的数据包进行处理，将源地址转换为 192.168.0.181。</li><li>第二条语句表示将源地址转换成 192.168.0.{100-200} 之间的某个地址。</li><li>第三条语句表示动态获取流出接口 wlp6s0u1 的地址，并将源地址转换为此地址。这称为地址伪装(ip masquerade)，地址伪装功能很实用，但是相比前两种，性能要稍差一些，因为处理每个数据包时都要获取 wlp6s0u1 的地址，也就是说多了一个查找动作。</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2584dnat">2.5.8.4、DNAT<a class="hash-link" href="#2584dnat" title="标题的直接链接">​</a></h4><p><img loading="lazy" alt="ipv4_forward1" src="/assets/images/ipv4_forward1-c7198b4263341a75e0c7b40bdc201a35.png" width="750" height="265" class="img_ev3q"></p><p>该实验把 x86 主机当作公网主机，arm64v8 主机当作防火墙，aarch64 主机当作内网私有服务器。</p><p>使用 DNAT 技术实现映射 <code>192.168.0.181:7422 --&gt; 172.16.100.12:22</code>，从 x86 主机 ssh 到 <code>192.168.0.181:7422</code> 如果最终是 ssh 到 aarch64 主机，则实验成功。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -t nat -A PREROUTING -d 192.168.0.181/32 -p tcp --dport 7422 -j DNAT --to-destination 172.16.100.12:22</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ssh -p 7422 192.168.0.181</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@192.168.0.181&#x27;s password: </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Last login: Thu Oct  </span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token plain"> 04:25:39 </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain"> from </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.124</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#                           # 很明显，实验成功；</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>提示</strong>：在生产应用环境中，一般是使用公网 <code>IP:PORT</code> 映射到私网 <code>IP:PORT</code> 才具有实际生产意义。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="259mangle-表">2.5.9、mangle 表<a class="hash-link" href="#259mangle-表" title="标题的直接链接">​</a></h3><p>mangle 表的主要功能是根据规则修改数据包的一些标志位，以便其他规则或程序可以利用这种标志对数据包进行过滤或策略路由。</p><p>一般来说，mangle 表的使用概率还是比较小的，在大型框架设计当中才有可能使用到 mangle 表，用来制定一些策略路由，无论是代码实现还是手动实现，大致思路如下：</p><ol><li><p><strong>创建路由表</strong></p><p>编辑 /etc/iproute2/rt<!-- -->_<!-- -->tables，注意不要动里面默认的路由表。添加路由表条目格式如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">ID of your Table</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Name of your table</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>默认的路由表如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># grep -v &quot;^#&quot; /etc/iproute2/rt_tables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">255</span><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">local</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">254</span><span class="token plain">  main</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">253</span><span class="token plain">  default</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    unspec</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用 ip route 命令查看路由表：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ip route show table 254</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">default via </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.1 dev wlp6s0u1 proto dhcp metric </span><span class="token number" style="color:rgb(9, 134, 88)">600</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.0/24 dev eth0 proto kernel scope </span><span class="token function" style="color:rgb(0, 0, 255)">link</span><span class="token plain"> src </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.11 metric </span><span class="token number" style="color:rgb(9, 134, 88)">100</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.0/24 dev wlp6s0u1 proto kernel scope </span><span class="token function" style="color:rgb(0, 0, 255)">link</span><span class="token plain"> src </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181 metric </span><span class="token number" style="color:rgb(9, 134, 88)">600</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ip route show table main</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">default via </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.1 dev wlp6s0u1 proto dhcp metric </span><span class="token number" style="color:rgb(9, 134, 88)">600</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.0/24 dev eth0 proto kernel scope </span><span class="token function" style="color:rgb(0, 0, 255)">link</span><span class="token plain"> src </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.11 metric </span><span class="token number" style="color:rgb(9, 134, 88)">100</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.0/24 dev wlp6s0u1 proto kernel scope </span><span class="token function" style="color:rgb(0, 0, 255)">link</span><span class="token plain"> src </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181 metric </span><span class="token number" style="color:rgb(9, 134, 88)">600</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ip route show</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">default via </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.1 dev wlp6s0u1 proto dhcp metric </span><span class="token number" style="color:rgb(9, 134, 88)">600</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.0/24 dev eth0 proto kernel scope </span><span class="token function" style="color:rgb(0, 0, 255)">link</span><span class="token plain"> src </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.11 metric </span><span class="token number" style="color:rgb(9, 134, 88)">100</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.0/24 dev wlp6s0u1 proto kernel scope </span><span class="token function" style="color:rgb(0, 0, 255)">link</span><span class="token plain"> src </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181 metric </span><span class="token number" style="color:rgb(9, 134, 88)">600</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>为路由表指定默认的路由设备：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> route </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> default dev </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">${TUNDEV}</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token plain"> src </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">${INTERNAL_IP4_ADDRESS}</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token plain"> table </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">${TABLENAME}</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 在路由表100上添加一个默认路由(对所有地址), 使用本地网关192.168.1.1, 这是一个可以从eth0到达的地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> route </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> default via </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.1.1 dev eth0 table </span><span class="token number" style="color:rgb(9, 134, 88)">100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 对10.1.1.0/30这个目的地址范围添加路由规则, 并添加MPLS标签</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> route </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">10.1</span><span class="token plain">.1.0/30 encap mpls </span><span class="token number" style="color:rgb(9, 134, 88)">200</span><span class="token plain">/300 via </span><span class="token number" style="color:rgb(9, 134, 88)">10.1</span><span class="token plain">.1.1 dev eth0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>数据包走哪个路由表</strong></p><p>默认每个数据报文走的路由表都是 main，你可以给满足一定规则的数据报文指定不同的路由表, 而未满足的还继续使用默认的路由表。</p></li><li><p><strong>路由规则</strong></p><p>通过 man ip rule 可以获取参数列表， 如果还不够，你可以使用 fwmark 给数据报文打 fwmark 标签，可以通过 iptables 来处理，然后通过 ip rule 来处理。例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 来源于 167.99.208.0/24 的用指定table</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> rule </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> from </span><span class="token number" style="color:rgb(9, 134, 88)">167.99</span><span class="token plain">.208.0/24 table </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">table-name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 所有来源都用 table ztable1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> rule </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> from all table ztable1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 所有来源中带标签2的都用table 20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> rule </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> from all fwmark </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> table </span><span class="token number" style="color:rgb(9, 134, 88)">20</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>iptables 打标签</strong></p><p>使用的格式为 <code>-j MARK --set-mark &lt;Your marknumber in decimal form&gt;</code>。MARK 这个 target 只在 mangle 中有效。</p><p>对于流入的数据报文可以使用 <code>-t mangle -A PREROUTING</code>，对于流出的数据报文可以使用 <code>-t mangle -A OUTPUT</code>。</p><p><em>注意：当数据报文被进程(例如 apache)处理过之后，标签就丢失了。所以如果打过标签的报文在返回时不正确，只给流入的报文打标签是不够的，你必须给产生的流出报文也打上标签。</em></p></li></ol><p><strong>案例一：</strong></p><p>内网的客户机通过 Linux 主机连入 Internet，而 Linux 主机有两个网口与 Internet 连接，分别有两条线路，它们的网关分别为 10.10.1.1 和 10.10.2.1。现要求对内网进行策略路由，所有通过 TCP 协议访问 80 端口的数据包都从 10.10.1.1 线路出去，而所有访问 UDP 协议 53 号端口的数据包都从 10.10.2.1 线路出去。</p><p>这是一个策略路由的问题，为了达到目的，在对数据包进行路由前，要先根据数据包的协议和目的端口给数据包做上一种标志，然后再指定相应规则，根据数据包的标志进行策略路由。</p><p>为了给特定的数据包做上标志，需要使用 mangle 表，mangle 表共有 5 条链，由于需要在路由选择前做标志，因此应该使用 PREROUTING 链，下面是具体的命令。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">iptables -t mangle -A PREROUTING -i eth0 -p tcp --dport </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"> -j MARK --set-mark </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -t mangle -A PREROUTING -i eth0 -p udp --dprot </span><span class="token number" style="color:rgb(9, 134, 88)">53</span><span class="token plain"> -j MARK --set-mark </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上命令在 mangle 表的 PREROUTING 链中添加规则，为来自 eth0 接口的数据包做标志，其匹配规则分别是 TCP 协议、目的端口号是 80 和 UDP 协议、目的端口号是 53，标志的值分别是 1 和 2。数据包经过 PREROUTING 链后，将要进入路由选择模块，为了对其进行策略路由，执行以下两条命令，添加相应的规则。</p><p>编辑 <code>/etc/iproute2/rt_tables</code>，添加对应的路由表：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> -e </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">${TABLEID}</span><span class="token string entity" style="color:rgb(163, 21, 21)">\t</span><span class="token string variable" style="color:rgb(9, 134, 88)">${TABLENAME}</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;&gt;</span><span class="token plain"> /etc/iproute2/rt_tables</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>添加路由：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> rule </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> from all fwmark </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> table </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> rule </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> from all fwmark </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> table </span><span class="token number" style="color:rgb(9, 134, 88)">20</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>两条命令表示所有标志是 1 的数据包使用路由表 10 进行路由，而所有标志是 2 的数据包使用路由表 20 进行路由。</li><li>路由表 10 和 20 分别使用了 10.10.1.1 和 10.10.2.1 作为默认网关。</li><li>fwmark 实际上就是 netfilter mark，一种打标签的方式或者实现，没有特殊的含义。</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> route </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> default via </span><span class="token number" style="color:rgb(9, 134, 88)">10.10</span><span class="token plain">.1.1 dev eth1 table </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> route </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> default via </span><span class="token number" style="color:rgb(9, 134, 88)">10.10</span><span class="token plain">.2.1 dev eth2 table </span><span class="token number" style="color:rgb(9, 134, 88)">20</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>两条命令在路由表 10 和 20 上分别指定了 10.10.1.1 和 10.10.2.1 作为默认网关，于是使用路由表 10 的数据包将通过 10.10.1.1 线路出去，而使用路由表 20 的数据包将通过 10.10.2.1 线路出去。</li></ul><p><strong>案例二：</strong></p><p>网关服务器有三块网卡：</p><ul><li>eth0 网通 ip：10.0.0.1</li><li>eth1 电信 ip：20.0.0.1</li><li>eth2 网关 ip：192.168.10.1</li></ul><p>内网要求 192.168.10.1---100 以内的 ip 使用 10.0.0.1 网关上网，其他 IP 使用 20.0.0.1 上网。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 设置默认路由</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> route </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> default gw </span><span class="token number" style="color:rgb(9, 134, 88)">20.0</span><span class="token plain">.0.1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># eth0 是 10.0.0.1 所在的网卡, 10是路由表的编号</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> route </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> table </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token plain"> via </span><span class="token number" style="color:rgb(9, 134, 88)">10.0</span><span class="token plain">.0.1 dev eth0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># fwmark 10 是标记, table 10 是路由表10, 标记了10的数据使用table 10路由表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> rule </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> fwmark </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token plain"> table </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 使用iptables给相应的数据打上标记, 对于这种IP范围需要用到iprange模块</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -A PREROUTING -t mangle -i eth2 -m iprange --src-range </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.10.1-192.168.10.100 -j MARK --set-mark </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>案例三：</strong></p><p>网关服务器有三块网卡：</p><ul><li>eth0 网通 ip：10.0.0.1</li><li>eth1 电信 ip：20.0.0.1</li><li>eth2 网关 ip：192.168.10.1</li></ul><p>内网要求员工访问外面的网站使用 10.0.0.1 网关上网，其他 IP 使用 20.0.0.1 上网。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">iptables -t mangle -A PREROUTING -i eth2 -p tcp --dport </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"> -j MARK --set-mark </span><span class="token number" style="color:rgb(9, 134, 88)">20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> route </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> default gw </span><span class="token number" style="color:rgb(9, 134, 88)">20.0</span><span class="token plain">.0.1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> route </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> table </span><span class="token number" style="color:rgb(9, 134, 88)">20</span><span class="token plain"> via </span><span class="token number" style="color:rgb(9, 134, 88)">10.0</span><span class="token plain">.0.1 dev eth0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> rule </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> fwmark </span><span class="token number" style="color:rgb(9, 134, 88)">20</span><span class="token plain"> table </span><span class="token number" style="color:rgb(9, 134, 88)">20</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2510raw-表">2.5.10、raw 表<a class="hash-link" href="#2510raw-表" title="标题的直接链接">​</a></h3><p>RAW 表只使用在 PREROUTING 链和 OUTPUT 链上，因为优先级最高，从而可以对收到的数据包在连接跟踪前进行处理。一但用户使用了 RAW 表处理完后，将跳过 NAT 表和 nf<!-- -->_<!-- -->conntrack 处理，即不再做地址转换和数据包的链接跟踪处理了。</p><p>RAW 表可以应用在那些不需要做 nat 的情况下，以提高性能。如大量访问的 web 服务器，可以让 80 端口不再让 iptables 做数据包的链接跟踪处理，以提高用户的访问速度。</p><p>增加 raw 表，在其他表处理之前，-j NOTRACK 跳过其它表处理，对应的 state 为 UNTRACKED。</p><p>例如：可以使用 &quot;NOTRACK&quot; target 允许规则指定 80 端口的包不进入链接跟踪或 NAT 子系统。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -t raw -A PREROUTING -d 192.168.0.181/32 -p tcp --dport 80 -j NOTRACK</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -t raw -A PREROUTING -s 192.168.0.181/32 -p tcp --sport 80 -j NOTRACK</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># iptables -A FORWARD -m state --state UNTRACKED -j ACCEPT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>在启用了 iptables web 服务器上，流量高的时候经常会出现错误：<code>ip_conntrack: table full, dropping packet</code>。</p><ul><li>这个问题的原因是由于 web 服务器收到了大量的连接，在启用了 iptables 的情况下，iptables 会把所有的连接都做链接跟踪处理，这样 iptables 就会有一个链接跟踪表，当这个表满的时候，就会出现上面的错误。</li><li>iptables 的链接跟踪表最大容量为 <code>/proc/sys/net/ipv4/ip_conntrack_max</code>，链接碰到各种状态的超时后就会从表中删除。</li></ul></li><li><p>解决该问题的思路一般有三个：</p><ul><li>加大 ip<!-- -->_<!-- -->conntrack<!-- -->_<!-- -->max 值</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">vi</span><span class="token plain"> /etc/sysctl.conf</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">net.ipv4.ip_conntrack_max </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">393216</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">net.ipv4.netfilter.ip_conntrack_max </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">393216</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>降低 ip<!-- -->_<!-- -->conntrack timeout 时间</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">vi</span><span class="token plain"> /etc/sysctl.conf</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">net.ipv4.netfilter.ip_conntrack_tcp_timeout_established </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">300</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">net.ipv4.netfilter.ip_conntrack_tcp_timeout_time_wait </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">120</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">net.ipv4.netfilter.ip_conntrack_tcp_timeout_close_wait </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">60</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">net.ipv4.netfilter.ip_conntrack_tcp_timeout_fin_wait </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">120</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>使用 raw 表制定不跟踪链接</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">iptables -t raw -A PREROUTING -d </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -p tcp --dport </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"> -j NOTRACK</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -t raw -A PREROUTING -s </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.181/32 -p tcp --sport </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain"> -j NOTRACK</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -A FORWARD -m state --state UNTRACKED -j ACCEPT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2511防火墙最佳实践">2.5.11、防火墙最佳实践<a class="hash-link" href="#2511防火墙最佳实践" title="标题的直接链接">​</a></h3><p>这里说的最佳实践只是针对某个服务器，对外提供服务时，在没有专业硬件防火墙的前提下，通过 iptables 实现比较严格的流量控制。</p><ol><li><p>安装 iptables-services 软件包，启动 iptables 服务。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">yum </span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> iptables-services -y</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl start iptables.service </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"> iptables.service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>避免 flush 后默认规则都是 DROP 无法远程</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">iptables -P INPUT ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -P OUTPUT ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -P FORWARD ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -F</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -t nat -F</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -X</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -t nat -X</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>首先可以让 ssh 能连接</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">iptables -A INPUT -p tcp --dport </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"> -m state --state NEW,ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -A OUTPUT -p tcp --sport </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"> -m state --state ESTABLISHED -j ACCEPT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>保证 apt-get 或 yum 可以使用</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">iptables -A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -A OUTPUT -p tcp -m multiport --destination-ports </span><span class="token number" style="color:rgb(9, 134, 88)">80,53</span><span class="token plain">,443 -m state --state NEW -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -A OUTPUT -p udp --dport </span><span class="token number" style="color:rgb(9, 134, 88)">53</span><span class="token plain"> -m state --state NEW -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>正常情况这个总是要配置的，自己要能跟自己通信</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">iptables -A INPUT -i lo -j ACCEPT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -A OUTPUT -o lo -j ACCEPT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>以上配置都正确则可以设置默认 DROP，这个比较危险，没有把握时，建议在写 iptables 前写个 at 计划或者 crontab 来清空规则</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">iptables -P INPUT DROP</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -P OUTPUT DROP</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables -P FORWARD DROP</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>保存规则</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">centos7:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables-save </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /etc/sysconfig/iptables         </span><span class="token comment" style="color:rgb(0, 128, 0)"># 启动 iptables 服务后自动生效</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ubuntu </span><span class="token number" style="color:rgb(9, 134, 88)">16.04</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">iptables-save </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /etc/iptables-rules             </span><span class="token comment" style="color:rgb(0, 128, 0)"># 不会自动生效</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">post-up iptables-restore </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain"> /etc/iptables-rules  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 在 /etc/network/interface 后面加上一行</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="26tcp_wrapper-过滤">2.6、tcp<!-- -->_<!-- -->wrapper 过滤<a class="hash-link" href="#26tcp_wrapper-过滤" title="标题的直接链接">​</a></h2><p>wrap 工作在内核空间和应用程序中间的库层次中。在内核接受到数据包准备传送到用户空间时都会经过库层次，对于部分（只是部分）应用程序会在经过库层次时会被 wrap 库文件阻挡下来检查一番，如果允许通过则交给应用程序。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="261查看是否支持-wrapper">2.6.1、查看是否支持 wrapper<a class="hash-link" href="#261查看是否支持-wrapper" title="标题的直接链接">​</a></h3><p>wrap 只会检查 tcp 数据包，所以称为 tcpwrapper。但还不是检查所有类型的 tcp 数据包，例如 httpd 就不支持。是否支持，可以通过查看应用程序是否依赖于 libwrap.so 库文件。(路径 /lib64/libwrap.so)</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ldd $(which sshd) | grep wrap</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    libwrap.so.0 </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /lib64/libwrap.so.0 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">0x0000ffffb7360000</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ldd $(which vsftpd) | grep wrap</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    libwrap.so.0 </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /lib64/libwrap.so.0 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">0x0000ffffa0494000</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ldd $(which httpd) | grep wrap</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>说明 sshd 和 vsftpd 都支持 wrap 机制，而 apache 的 httpd 不支持。</p><p>当然上面 grep 不出结果只能说明不支持这样的动态链接的方式，有些应用程序可能静态编译进程序中了，如旧版本的 rpc 应用程序 portmap。</p><p>是否将 wrap 功能静态编译到应用程序中，可以通过以下方式查看。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">strings </span><span class="token variable" style="color:rgb(9, 134, 88)">$(</span><span class="token variable function" style="color:rgb(0, 0, 255)">which</span><span class="token variable" style="color:rgb(9, 134, 88)"> portmap</span><span class="token variable" style="color:rgb(9, 134, 88)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">grep</span><span class="token plain"> hosts</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果筛选出的结果中有 hosts<!-- -->_<!-- -->access 或者 /etc/hosts.allow 和 /etc/hosts.deny 这两个文件，则说明是支持的。后两个文件正是 wrap 访问控制的文件。</p><p>要注意的是，如果超级守护进程 xinetd 被 wrap 控制了，则其下的瞬时守护进程都受 wrap 控制。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="262配置文件格式">2.6.2、配置文件格式<a class="hash-link" href="#262配置文件格式" title="标题的直接链接">​</a></h3><p>hosts.allow 和 hosts.deny 两个文件的语法格式是一样的，如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">daemon_list:   client_list  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">:options</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>daemon<!-- -->_<!-- -->list 表示方法</strong>：程序名必须是 which 查出来同名的名称，例如此处的 in.telnetd</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">sshd:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sshd,vsftpd,in.telnetd:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ALL</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">daemon@host:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最后一项 daemon@host 指定连接 IP 地址，针对多个 IP 的情况。如本机有 192.168.100.8 和 172.16.100.1 两个地址，但是只想控制从其中一个 ip 连接的 vsftpd 服务，可以写 &quot;<a href="mailto:vsftpd@192.168.100.8" target="_blank" rel="noopener noreferrer">vsftpd@192.168.100.8</a>:&quot;。</p><p><strong>client<!-- -->_<!-- -->list 表示方法</strong>：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">单IP：192.168.100.8</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">网段：两种写法：</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;172.16.&quot;</span><span class="token plain">和10.0.0.0/255.0.0.0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">主机名或域匹配：fqdn或</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;.a.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">宏：ALL、KNOWN、UNKNOWN、PARANOID、EXCEPT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ALL 表示所有主机；LOCAL 表示和主机在同一网段的主机；(UN)KNOWN 表示 DNS 是否可以解析成功的；PARANOID 表示正解反解不匹配的；EXCEPT 表示 &quot;除了&quot;。</p><p>它们的语法可以 man hosts<!-- -->_<!-- -->access。</p><p>tcpwrapper 的检查顺序：<strong>hosts.allow --&gt;</strong> <strong>hosts.deny --&gt;</strong> <strong>允许(默认规则)</strong></p><p>例如 sshd 仅允许 172.16 网段主机访问。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">hosts.allow:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sshd: </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">hosts.deny:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sshd: ALL</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>telnet 服务不允许 172.16 网段访问但允许 172.16.100.200 访问。有几种表达方式：</p><p>表达方式一：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">hosts.allow:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">in.telnetd: </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.200</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">hosts.deny:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">in.telnetd: </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>表达方式二：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">hosts.deny:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">in.telnetd: </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">. EXCEPT </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.200</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>此法不能写入 hosts.allow：&quot;in.telnetd: 172.16.100.200 EXCEPT 172.16.&quot;</li></ul><p>表达方式三：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">hosts.allow:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    in.telnetd: ALL EXCEPT </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">. EXCEPT </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.200</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">hosts.deny:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    in.telnetd: ALL</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>EXCEPT 的最形象描述是 “在其前面的范围内挖一个洞，在洞范围内的都不匹配”。所以 hosts.allow 中，ALL 内有一个 172.16 的洞是不被 allow 的，在 172.16 中又有小洞 172.16.100.200 是被排除在 172.16 洞外的，所以 172.16.100.200 是被 allow 的。</p><p>注意：被 EXCEPT 匹配到的表示不经过此条规则的检查，而不是反意。例如在 allows 中指明一个 EXCEPT，当有 except 中的主机被匹配到，表示的不是该主机被拒绝。而是跳过 allow 检测进入 deny 的检测。</p><p><strong>:options 表达方式</strong>：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">:ALLOW</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">:DENY</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">:spawn</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ALLOW 和 DENY 可以分别写入 deny 文件和 allow 文件，表示在 allow 文件中拒绝在 deny 文件中接受。如 allow 文件中：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">in.telnetd: </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">. :DENY</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>spawn 表示启动某程序的意思(/etc/inittab 中的 respawn 表示重启指定程序)。例如启动一个 echo 程序。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">in.telnetd: </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain"> :spawn </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;we are good </span><span class="token string variable" style="color:rgb(9, 134, 88)">$(</span><span class="token string variable function" style="color:rgb(0, 0, 255)">date</span><span class="token string variable" style="color:rgb(9, 134, 88)">)</span><span class="token string" style="color:rgb(163, 21, 21)"> &gt;&gt; /var/log/telnetd.log&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/linux-advanced-1"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">第 1 章 Linux 进阶命令</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/linux-advanced-3"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">第 3 章 Linux NFS 网络文件系统</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#21数据传输流程" class="table-of-contents__link toc-highlight">2.1、数据传输流程</a><ul><li><a href="#211网络数据传输过程" class="table-of-contents__link toc-highlight">2.1.1、网络数据传输过程</a></li><li><a href="#212本机数据路由决策" class="table-of-contents__link toc-highlight">2.1.2、本机数据路由决策</a></li></ul></li><li><a href="#22tcp-重要概念" class="table-of-contents__link toc-highlight">2.2、TCP 重要概念</a><ul><li><a href="#221tcp-三次握手" class="table-of-contents__link toc-highlight">2.2.1、TCP 三次握手</a></li><li><a href="#222tcp-四次挥手" class="table-of-contents__link toc-highlight">2.2.2、TCP 四次挥手</a></li><li><a href="#223syn-flood-攻击" class="table-of-contents__link toc-highlight">2.2.3、syn flood 攻击</a></li></ul></li><li><a href="#23防火墙的应用" class="table-of-contents__link toc-highlight">2.3、防火墙的应用</a></li><li><a href="#24linux-防火墙" class="table-of-contents__link toc-highlight">2.4、Linux 防火墙</a><ul><li><a href="#241netfilter-与其模块" class="table-of-contents__link toc-highlight">2.4.1、netfilter 与其模块</a></li><li><a href="#242iptables-和-netfilter-的关系" class="table-of-contents__link toc-highlight">2.4.2、iptables 和 netfilter 的关系</a></li><li><a href="#243netfilter-的结构" class="table-of-contents__link toc-highlight">2.4.3、netfilter 的结构</a></li></ul></li><li><a href="#25iptables-命令" class="table-of-contents__link toc-highlight">2.5、iptables 命令</a><ul><li><a href="#251iptables-语法" class="table-of-contents__link toc-highlight">2.5.1、iptables 语法</a></li><li><a href="#252ip_conntrack-功能和-iptstate-命令" class="table-of-contents__link toc-highlight">2.5.2、ip_conntrack 功能和 iptstate 命令</a></li><li><a href="#253-m-state-的状态解释" class="table-of-contents__link toc-highlight">2.5.3、-m state 的状态解释</a></li><li><a href="#254filter-表示例" class="table-of-contents__link toc-highlight">2.5.4、filter 表示例</a></li><li><a href="#255优化规则" class="table-of-contents__link toc-highlight">2.5.5、优化规则</a></li><li><a href="#256保存规则" class="table-of-contents__link toc-highlight">2.5.6、保存规则</a></li><li><a href="#257自定义链" class="table-of-contents__link toc-highlight">2.5.7、自定义链</a><ul><li><a href="#2571自定义链示例" class="table-of-contents__link toc-highlight">2.5.7.1、自定义链示例</a></li></ul></li><li><a href="#258nat-表" class="table-of-contents__link toc-highlight">2.5.8、NAT 表</a><ul><li><a href="#2581配置网关以及转发" class="table-of-contents__link toc-highlight">2.5.8.1、配置网关以及转发</a></li><li><a href="#2582配置网关防火墙" class="table-of-contents__link toc-highlight">2.5.8.2、配置网关防火墙</a></li><li><a href="#2583snat" class="table-of-contents__link toc-highlight">2.5.8.3、SNAT</a></li><li><a href="#2584dnat" class="table-of-contents__link toc-highlight">2.5.8.4、DNAT</a></li></ul></li><li><a href="#259mangle-表" class="table-of-contents__link toc-highlight">2.5.9、mangle 表</a></li><li><a href="#2510raw-表" class="table-of-contents__link toc-highlight">2.5.10、raw 表</a></li><li><a href="#2511防火墙最佳实践" class="table-of-contents__link toc-highlight">2.5.11、防火墙最佳实践</a></li></ul></li><li><a href="#26tcp_wrapper-过滤" class="table-of-contents__link toc-highlight">2.6、tcp_wrapper 过滤</a><ul><li><a href="#261查看是否支持-wrapper" class="table-of-contents__link toc-highlight">2.6.1、查看是否支持 wrapper</a></li><li><a href="#262配置文件格式" class="table-of-contents__link toc-highlight">2.6.2、配置文件格式</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">学习</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/tags">标签</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">归档</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/skill">技术笔记</a></li><li class="footer__item"><a class="footer__link-item" href="/project">实战项目</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/linux">Linux</a></li></ul></div><div class="col footer__col"><div class="footer__title">社交媒体</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/about">关于我</a></li><li class="footer__item"><a href="https://github.com/zqingfa" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://juejin.cn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">掘金<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" position="right" href="/friends">友链</a></li><li class="footer__item"><a class="footer__link-item" position="right" href="/website">导航</a></li><li class="footer__item"><a href="https://docusaurus.io/zh-CN/" target="_blank"><img style="height:50px;margin-top:0.5rem" src="/img/buildwith.png"><a></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p><a href="http://beian.miit.gov.cn/">浙ICP备20024502号-1</a></p><p>Copyright © 2022 - PRESENT zhangqf Built with Docusaurus.</p></div></div></div></footer></div>
<script src="/assets/js/runtime~main.839460ba.js"></script>
<script src="/assets/js/main.6b7778c5.js"></script>
</body>
</html>