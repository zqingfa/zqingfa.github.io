<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-linux/primary/linux-primary-4">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">第 4 章 Linux ext 文件系统 - Linux技术分享</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://zhangqf.com/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://zhangqf.com/img/logo.png"><meta data-rh="true" property="og:url" content="https://zhangqf.com/docs/linux-primary-4"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="第 4 章 Linux ext 文件系统 - Linux技术分享"><meta data-rh="true" name="description" content="磁盘分区是指将磁盘按柱面进行物理上的划分。划分好分区后需要格式化，然后挂载使用。格式化的过程就是创建文件系统。"><meta data-rh="true" property="og:description" content="磁盘分区是指将磁盘按柱面进行物理上的划分。划分好分区后需要格式化，然后挂载使用。格式化的过程就是创建文件系统。"><meta data-rh="true" name="keywords" content="linux,FileSystem"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://zhangqf.com/docs/linux-primary-4"><link data-rh="true" rel="alternate" href="https://zhangqf.com/en/docs/linux-primary-4" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/linux-primary-4" hreflang="zh"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/linux-primary-4" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9B0V5WT2X8-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S4SD5NXWXF"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S4SD5NXWXF",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Linux技术分享" href="/opensearch.xml">
<link rel="preconnect" href="https://zhangqf.com/">
<script>var _paq=window._paq=window._paq||[];_paq.push(["setRequestMethod","POST"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),_paq.push(["enableHeartBeatTimer"]),function(){var e="https://zhangqf.com/";_paq.push(["setRequestMethod","POST"]),_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]);var a=document,t=a.createElement("script"),p=a.getElementsByTagName("script")[0];t.type="text/javascript",t.async=!0,t.src=e+"matomo.js",p.parentNode.insertBefore(t,p)}()</script>


<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c9a3849aa75f9c4a4e65f846cd1a5155",e.defer=!0;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<meta name="baidu-site-verification" content="code-rqLUw5reVS">
<script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",t.defer=!0;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script>
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="zhangqf RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="zhangqf Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="zhangqf JSON Feed">

<link rel="icon" href="/img/logo.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(51 139 255)"><link rel="stylesheet" href="/assets/css/styles.86c9ae18.css">
<link rel="preload" href="/assets/js/runtime~main.839460ba.js" as="script">
<link rel="preload" href="/assets/js/main.6b7778c5.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><span>更新 <a href="/website">网址导航</a> 带你发现感兴趣的技术</span></div><button type="button" aria-label="关闭" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">zhangqf</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/linux">Linux</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/category/Linux基础">Linux 基础</a></li><li><a class="dropdown__link" href="/docs/category/Linux进阶">Linux 进阶</a></li><li><a class="dropdown__link" href="/docs/category/Linux测试">Linux 测试</a></li><li><a class="dropdown__link" href="/docs/category/LinuxCICD">Linux CICD研发</a></li><li><a class="dropdown__link" href="/docs/skill/">笔记</a></li><li><a class="dropdown__link" href="/docs/tools/">工具推荐</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Blog</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tags">标签</a></li><li><a class="dropdown__link" href="/archive">归档</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">工具</a><ul class="dropdown__menu"><li><a href="https://api.kuizuo.cn" target="_blank" rel="noopener noreferrer" class="dropdown__link">API服务</a></li><li><a href="https://js-de-obfuscator.vercel.app" target="_blank" rel="noopener noreferrer" class="dropdown__link">JS代码还原</a></li><li><a href="https://cipher.kuizuo.cn" target="_blank" rel="noopener noreferrer" class="dropdown__link">CyberChef加密</a></li><li><a href="https://pan.kuizuo.cn" target="_blank" rel="noopener noreferrer" class="dropdown__link">网盘</a></li></ul></div><a class="navbar__item navbar__link" href="/website">导航</a><a class="navbar__item navbar__link" href="/project">项目</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"><b>zhangqf</b></a><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/linux">linux</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/linux基础">Linux基础</a><button aria-label="打开/收起侧边栏菜单「Linux基础」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-1">第 1 章 Linux 基础命令</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-2">第 2 章 Linux 系统用户</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-3">第 3 章 Linux 文件权限</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/linux-primary-4">第 4 章 Linux ext 文件系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-5">第 5 章 Linux 磁盘管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-6">第 6 章 Linux LVM 存储管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-7">第 7 章 Linux Raid 存储管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-8">第 8 章 Linux 包管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-9">第 9 章 Linux 进程和信号</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-10">第 10 章 Linux 系统资源监控</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-11">第 11 章 Linux 服务管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-12">第 12 章 Linux 定时任务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-13">第 13 章 Linux 网络管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-14">第 14 章 Linux 开机启动流程(UEFI+systemd)</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/linux进阶">Linux进阶</a><button aria-label="打开/收起侧边栏菜单「Linux进阶」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/linux测试">Linux测试</a><button aria-label="打开/收起侧边栏菜单「Linux测试」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/linuxcicd">Linux CICD研发</a><button aria-label="打开/收起侧边栏菜单「Linux CICD研发」" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/linux基础"><span itemprop="name">Linux基础</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">第 4 章 Linux ext 文件系统</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>第 4 章 Linux ext 文件系统</h1></header><p>磁盘分区是指将磁盘按柱面进行物理上的划分。划分好分区后需要格式化，然后挂载使用。格式化的过程就是创建文件系统。</p><p>文件系统的类型有很多种，CentOS 5-6 默认使用 ext2/ext3/ext4，CentOS 7上默认使用的xfs，windows上的NTFS，光盘类的文件系统ISO9660，MAC上的混合文件系统HFS等。</p><p>ext 文件系统根据历史改进分 ext2、ext3、ext4 几个版本。ext3是有日志的ext2改进版，ext4对相比ext3做了非常多的改进。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="41文件系统组件">4.1、文件系统组件<a class="hash-link" href="#41文件系统组件" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="411block-概念">4.1.1、block 概念<a class="hash-link" href="#411block-概念" title="标题的直接链接">​</a></h3><p><strong>磁盘逻辑块</strong></p><p>硬盘最底层的读写 IO 一次是一个扇区512字节，为了提升性能硬盘使用了一个称作逻辑块的概念。</p><p>逻辑块是逻辑的，由磁盘驱动器负责维护和操作，它并非是像扇区一样物理划分的。</p><p>一个逻辑块的大小可能包含一个或多个扇区，每个逻辑块都有唯一的地址，称为 <strong>LBA</strong>。</p><p>磁盘控制器对数据的操作以逻辑块为单位，将逻辑块翻译成对应的扇区读写数据。</p><p><strong>文件系统逻辑块</strong></p><p>文件系统提供了一个也称为块的读写单元，文件系统数据块的大小一般为 1024 bytes(1K) 或 2048 bytes(2K) 或 4096 bytes(4K)。</p><p>文件系统数据块也是逻辑概念，是文件系统层次维护的，而磁盘上的逻辑数据块是由磁盘控制器维护的，文件系统的 IO 管理器知道如何将它的数据块翻译成磁盘维护的数据块地址 LBA。</p><p>对于使用文件系统的 IO 操作来说，比如读写文件，这些 IO 的基本单元是文件系统上的数据块，一次读写一个文件系统数据块。</p><p>举例：开始读 --&gt; IO 管理器计算 LAB --&gt; 磁盘控制器计算磁盘逻辑块对应哪些扇区 --&gt; 数据从磁盘到内存</p><p><em>注意：本文重点介绍文件系统逻辑块，不是磁盘逻辑块，所以后文出现的 block 均表示的是文件系统的数据块而不是磁盘维护的逻辑块。</em></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="412inode-概念">4.1.2、inode 概念<a class="hash-link" href="#412inode-概念" title="标题的直接链接">​</a></h3><p>block 的大小默认为 4KB，如果存储 1GB 大小的文件，如何组织 block 的存储，全盘扫描肯定不现实。为了更好地组织 block 进行数据读写，设计了索引技术，在文件系统上索引技术具体化为索引节点(index node)。</p><p>一般来说索引占用的空间相比其索引的文件数据而言占用的空间就小得多，扫描它比扫描整个数据要快得多。</p><p>在文件系统上的术语中，索引节点称为 inode。在 inode 中存储了 inode 号、文件类型、权限、文件所有者、大小、时间戳等元数据信息，最重要的是还存储了指向属于该文件 block 的指针，这样读取 inode 就可以找到属于该文件的 block，进而读取这些 block 并获得该文件的数据。</p><ul><li>文件都存储在目录当中，inode num 在目录 data block 当中，然后对应到 inode，inode 中并未存储 inode num，既然它们有一一对应关系，姑且理解为 inode num 就在 inode 当中。</li></ul><p>后面还会介绍一种指针，为了方便称呼和区分，暂且将这个 inode 记录中指向文件 data block 的指针称之为 block 指针。</p><p>一般 inode 大小为 128 字节或 256 字节，相比那些 MB 或 GB 计算的文件数据而言小得多的多，但也要知道可能一个文件大小小于 inode 大小，例如只占用 1 个字节的文件。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="413bmap-概念">4.1.3、bmap 概念<a class="hash-link" href="#413bmap-概念" title="标题的直接链接">​</a></h3><p>在向硬盘存储数据时，文件系统需要知道哪些块是空闲的，哪些块是已经占用了的。</p><p>位图使用 0 和 1 标识对应 block 是空闲还是被占用，0 和 1 在位图中的位置和 block 的位置一一对应，第一位标识第一个块，第二个位标识第二个块，依次下去直到标记完所有的 block。</p><p><strong>位图的优势</strong></p><p>在位图中 1 个字节 8 个位，可以标识 8 个 block。</p><p>对于一个 block 大小为 1KB、容量为 1G 的文件系统而言，block 数量有 1024<!-- -->*<!-- -->1024 个，所以在位图中使用 1024<!-- -->*<!-- -->1024 个位共 1024<!-- -->*<!-- -->1024/8=131072 字节即 128K，即 1G 的文件只需要 128 个 block 做位图就能完成一一对应。通过扫描这 100 多个 block 就能知道哪些 block 是空闲的，速度提高了非常多。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="414inode-table-概念">4.1.4、inode table 概念<a class="hash-link" href="#414inode-table-概念" title="标题的直接链接">​</a></h3><p>每一个文件都对应一个 inode，一个 block 默认设为 1KB(2KB 或 4KB)，一个 inode 默认 128B(或 256B) 占用一个 block 吗，这显然太浪费了。</p><p>所以更优的方法是将多个 inode 合并存储在 block 中，对于 128 字节的 inode，一个 block 存储 8 个 inode，对于 256 字节的inode，一个 block 存储 4 个 inode。这就使得每个存储 inode 的块都不浪费。</p><p>在 ext 文件系统上，将这些物理上存储 inode 的 block 组合起来，在逻辑上形成一张 inode 表(inode table) 来记录所有的 inode。</p><p><img loading="lazy" alt="inode table" src="/assets/images/File Permission-d128d6497d49b5ccff3ac8128141041a.png" width="759" height="330" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="415imap-概念">4.1.5、imap 概念<a class="hash-link" href="#415imap-概念" title="标题的直接链接">​</a></h3><p>bmap 是块位图，用于标识文件系统中哪些 block 是空闲哪些 block 是占用的。</p><p>imap 是 inode 位图，用于标识文件系统中哪些 inode 是空闲哪些 inode 是占用的。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="416block-group-概念">4.1.6、block group 概念<a class="hash-link" href="#416block-group-概念" title="标题的直接链接">​</a></h3><p>无论是 block、 inode、bmap 还是 imap，全盘组织没有问题，每个文件都可以找到，但是如果文件太大，全盘查找 inode、bmap、imap 一样性能比较差。</p><p>优化方法是将文件系统占用的 block 划分成块组(block group)，解决 bmap、inode table 和 imap 太大的问题。</p><p>在物理层面上的划分是将磁盘按柱面划分为多个分区，即多个文件系统；在逻辑层面上的划分是将文件系统划分成块组。</p><p>每个文件系统包含多个块组，每个块组包含多个元数据区和数据区</p><ul><li>元数据区就是存储 bmap、inode table、imap 等的数据；</li><li>数据区就是存储文件数据的区域。</li></ul><p><em>注意：块组是逻辑层面的概念，所以并不会真的在磁盘上按柱面、按扇区、按磁道等概念进行划分。</em></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="417划分-block-group">4.1.7、划分 block group<a class="hash-link" href="#417划分-block-group" title="标题的直接链接">​</a></h3><p>块组在文件系统创建完成后就已经划分完成了，也就是说元数据区 bmap、inode table 和 imap 等信息占用的 block 以及数据区占用的 block 都已经划分好了。</p><p>那么文件系统如何知道一个块组元数据区包含多少个 block，数据区又包含多少 block 呢？</p><ol><li>确定每个 block 的大小，每个 block 的大小在创建文件系统时可以人为指定，不指定也有默认值。</li><li>根据 bmap 最少要占用一个完整的 block 的标准就能计算出块组如何划分。<ul><li>如果文件系统非常小，所有的 bmap 总共都不能占用完一个 block，那么也只能空闲 bmap 的 block 了。</li></ul></li><li>假如现在 block 的大小是 1KB，一个 bmap 完整占用一个 block 能标识 1024<!-- -->*<!-- -->8= 8192 个 block。<ul><li>这 8192 个 block 是数据区和元数据区共 8192 个，因为元数据区分配的 block 也需要通过 bmap 来标识。</li></ul></li><li>每个 block 是 1KB，每个块组是 8192KB 即 8MB，创建 1GB 的文件系统需要划分 1024/8=128 个块组。</li><li>如果是 1.1G 的文件系统呢？<ul><li>128 + 12.8 = 128 + 13 = 141个块组。</li></ul></li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="418划分-inode">4.1.8、划分 inode<a class="hash-link" href="#418划分-inode" title="标题的直接链接">​</a></h3><p>inode 大小为 128 字节的倍数，最小为 128 字节。它有默认值大小，它的默认值由 /etc/mke2fs.conf 文件中指定。不同的文件系统默认值可能不同。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /etc/mke2fs.conf </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">defaults</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    base_features </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> sparse_super,large_file,filetype,resize_inode,dir_index,ext_attr</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    default_mntopts </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> acl,user_xattr</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    enable_periodic_fsck </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    blocksize </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    inode_size </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">256</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    inode_ratio </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">16384</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">fs_types</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ext3 </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        features </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> has_journal</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ext4 </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        features </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> has_journal,extent,huge_file,flex_bg,uninit_bg,dir_nlink,extra_isize</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        auto_64-bit_support </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        inode_size </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">256</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>blocksize 的默认值 4096 字节即 4KB</li><li>inode<!-- -->_<!-- -->size 的默认值 256 字节</li><li>blocksize 的默认值和 inode 分配比率 inode<!-- -->_<!-- -->ratio 默认值 16384 字节，表示每 16384 个字节即 16KB 就分配一个 inode 号，由于默认 blocksize=4KB，所以每 4 个 block 就分配一个 inode 号。<ul><li>分配的这些 inode 号只是预分配，并不真的代表会全部使用，毕竟每个文件才会分配一个 inode 号。</li><li>如果存储的都是电影这样的大文件，一个 inode 号对应成千上万个 block 完成一个大文件存储，inode 号就浪费很多，inode 占用的空间也浪费很多。</li><li>当然 inode size、inode 分配比例、block size 都可以在创建文件系统的时候人为指定。</li></ul></li></ul><p>分配的 inode 自身会占用 block，而且其自身大小 256 字节还不算小，所以 inode 号的浪费代表着空间的浪费。</p><p>既然知道了 inode 分配比率，就能计算出每个块组分配多少个 inode 号，也就能计算出 inode table 占用多少个 block。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="419查看文件系统组件">4.1.9、查看文件系统组件<a class="hash-link" href="#419查看文件系统组件" title="标题的直接链接">​</a></h3><p>使用 dumpe2fs 可以将 ext 类的文件系统信息(super block 和 GDT)全部显示出来，当然 bmap 是每个块组固定一个 block 的不用显示，imap 比 bmap 更小所以也只占用 1 个 block 不用显示。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># dumpe2fs /dev/vdb2 | grep -A 26 &quot;^Inode count&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">dumpe2fs </span><span class="token number" style="color:rgb(9, 134, 88)">1.42</span><span class="token plain">.13 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">17</span><span class="token plain">-May-2015</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Inode count:              </span><span class="token number" style="color:rgb(9, 134, 88)">1310720</span><span class="token plain">                   </span><span class="token comment" style="color:rgb(0, 128, 0)"># 文件系统 inode 号数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Block count:              </span><span class="token number" style="color:rgb(9, 134, 88)">5242880</span><span class="token plain">                   </span><span class="token comment" style="color:rgb(0, 128, 0)"># 文件系统 block 总数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Reserved block count:     </span><span class="token number" style="color:rgb(9, 134, 88)">262144</span><span class="token plain">                    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 保留的 block 数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Free blocks:              </span><span class="token number" style="color:rgb(9, 134, 88)">5116558</span><span class="token plain">                   </span><span class="token comment" style="color:rgb(0, 128, 0)"># 空闲的 block 数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Free inodes:              </span><span class="token number" style="color:rgb(9, 134, 88)">1310709</span><span class="token plain">                   </span><span class="token comment" style="color:rgb(0, 128, 0)"># 空闲的 inode 数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">First block:              </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">                         </span><span class="token comment" style="color:rgb(0, 128, 0)"># 第一个 block 号</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Block size:               </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain">                      </span><span class="token comment" style="color:rgb(0, 128, 0)"># block 大小 4KB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Fragment size:            </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Reserved GDT blocks:      </span><span class="token number" style="color:rgb(9, 134, 88)">1022</span><span class="token plain">                      </span><span class="token comment" style="color:rgb(0, 128, 0)"># 保留 GDT 的块总数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Blocks per group:         </span><span class="token number" style="color:rgb(9, 134, 88)">32768</span><span class="token plain">                     </span><span class="token comment" style="color:rgb(0, 128, 0)"># 每个块组的 block 数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Fragments per group:      </span><span class="token number" style="color:rgb(9, 134, 88)">32768</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Inodes per group:         </span><span class="token number" style="color:rgb(9, 134, 88)">8192</span><span class="token plain">                      </span><span class="token comment" style="color:rgb(0, 128, 0)"># 每个块组的 inode 号数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Inode blocks per group:   </span><span class="token number" style="color:rgb(9, 134, 88)">512</span><span class="token plain">                       </span><span class="token comment" style="color:rgb(0, 128, 0)"># 每个块组inode占用的块数量(inode表数量)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Filesystem created:       Wed Jun  </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">16</span><span class="token plain">:09:05 </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Last </span><span class="token function" style="color:rgb(0, 0, 255)">mount</span><span class="token plain"> time:          n/a</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Last </span><span class="token function" style="color:rgb(0, 0, 255)">write</span><span class="token plain"> time:          Wed Jun  </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">16</span><span class="token plain">:09:05 </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Mount count:              </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Maximum </span><span class="token function" style="color:rgb(0, 0, 255)">mount</span><span class="token plain"> count:      -1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Last checked:             Wed Jun  </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">16</span><span class="token plain">:09:05 </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Check interval:           </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Reserved blocks uid:      </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">user root</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Reserved blocks gid:      </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">group root</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">First inode:              </span><span class="token number" style="color:rgb(9, 134, 88)">11</span><span class="token plain">                        </span><span class="token comment" style="color:rgb(0, 128, 0)"># 文件系统的第一个 inode 号</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Inode size:               </span><span class="token number" style="color:rgb(9, 134, 88)">256</span><span class="token plain">                       </span><span class="token comment" style="color:rgb(0, 128, 0)"># 每个 inode 的大小为 256 字节</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Required extra isize:     </span><span class="token number" style="color:rgb(9, 134, 88)">28</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Desired extra isize:      </span><span class="token number" style="color:rgb(9, 134, 88)">28</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Journal inode:            </span><span class="token number" style="color:rgb(9, 134, 88)">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>根据查看文件系统的数据，可以计算出文件系统的大小，共 5242880 个 blocks，每个 block 大小为 4KB，所以文件系统的大小为 5242880 <!-- -->*<!-- --> 4 / 1024 / 1024 = 20GB</p></li><li><p>根据查看文件系统的数据，可以计算出分了多少个块组，每一个块组的 block 数量为 32768，所以块组的数量为 5242880 / 32768 = 160 即 160 个块组。由于块组从 0 开始编号，所以最后一个块组编号为 Group 159。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">Group </span><span class="token number" style="color:rgb(9, 134, 88)">159</span><span class="token plain">: </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">Blocks </span><span class="token number" style="color:rgb(9, 134, 88)">5210112</span><span class="token plain">-5242879</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Block bitmap at </span><span class="token number" style="color:rgb(9, 134, 88)">5210112</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">+0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">, Inode bitmap at </span><span class="token number" style="color:rgb(9, 134, 88)">5210113</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">+1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Inode表位于 </span><span class="token number" style="color:rgb(9, 134, 88)">5210114</span><span class="token plain">-5210625 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">+2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">32254</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">free</span><span class="token plain"> blocks, </span><span class="token number" style="color:rgb(9, 134, 88)">8192</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">free</span><span class="token plain"> inodes, </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> directories</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">可用块数: </span><span class="token number" style="color:rgb(9, 134, 88)">5210626</span><span class="token plain">-5242879</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">可用inode数: </span><span class="token number" style="color:rgb(9, 134, 88)">1302529</span><span class="token plain">-1310720</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="42文件系统完整结构">4.2、文件系统完整结构<a class="hash-link" href="#42文件系统完整结构" title="标题的直接链接">​</a></h2><p>将上文描述的 bmap、inode table、imap、数据区的 blocks 和块组的概念组合起来就形成了一个文件系统，当然这还不是完整的文件系统。完整的文件系统如下图</p><p><img loading="lazy" alt="ext filesystem construction" src="/assets/images/ext filesystem construction-0db6f63642bef8c14b0a1780db1c138b.png" width="999" height="361" class="img_ev3q"></p><p>首先，该图中多了 Boot Block、Super Block、GDT、Reserver GDT 这几个概念。下面会分别介绍它们。</p><p>然后，图中指明了块组中每个部分占用的 block 数量，除了 superblock、bmap、imap 能确定占用 1 个 block，其他的部分都不能确定占用几个 block。</p><p>最后，图中指明了 Superblock、GDT 和 Reserved GDT 是同时出现且不一定存在于每一个块组中的，也指明了 bmap、imap、inode table 和 data blocks 是每个块组都有的。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="421boot-block">4.2.1、Boot Block<a class="hash-link" href="#421boot-block" title="标题的直接链接">​</a></h3><p>上图中的 Boot Block 部分，也称为 boot sector。</p><p>它位于分区上的第一个块，占用 1024 字节，并非所有分区都有这个 boot sector，只有装了操作系统的主分区和装了操作系统的逻辑分区才有。</p><p>里面存放的也是 boot loader，这段 boot loader 称为 VBR(主分区装操作系统时) 或 EBR(扩展分区装操作系统时)，这里的 Boot loader 和 mbr 上的 boot loader 是存在交错关系的。</p><p>开机启动的时候，首先加载 mbr 中的 bootloader，然后定位到操作系统所在分区的 boot serctor 上加载此处的 boot loader。</p><p>如果是多系统，加载 mbr 中的 bootloader 后会列出操作系统菜单，菜单上的各操作系统指向它们所在分区的 boot sector 上。</p><p><img loading="lazy" alt="Boot sector" src="/assets/images/Boot sector-1072a67b8a056a9f85b8329e053e2124.png" width="725" height="412" class="img_ev3q"></p><p>这种操作系统的管理方式是早期传统 BIOS 下的管理方式，现在的服务器都进化到了 UEFI 的启动方式，使用 grub 的方案管理操作系统启动，与传统的 BIOS 管理方式在逻辑上是一致的，UEFI 新加了很多特性，俨然成了一个小型的操作系统，所以在系统启动之前可以做很多事情，比如硬件管理、网络管理等。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="422super-block">4.2.2、Super Block<a class="hash-link" href="#422super-block" title="标题的直接链接">​</a></h3><p>超级块 super block 记录了整个文件系统的块组信息，包括 block 数量、inode 信息、文件系统时间戳等。在 4.1.9 小节使用 dumpe2fs 查看的就包括 super block 中记录的信息，可想而知 super block 多么重要。</p><ul><li><p>dumpe2fs 不加选项显示的是 super block 和 GDT 信息，使用 dumpe2fs -h 只显示 super block 信息。</p></li><li><p>存储这些信息占用 1024 字节，所以也要一个 block，这个 block 称为超级块(superblock)，它的 block 号可能为 0 也可能为 1。</p><ul><li>如果 block 大小为 1K，则引导块正好占用一个 block，这个 block 号为 0，所以 superblock 的号为 1；</li><li>如果 block 大小大于 1K，则引导块和超级块同置在一个 block 中，这个 block 号为 0。总之 superblock 的起止位置是第二个 1024(1024-2047) 字节。</li></ul></li><li><p>除了 dumpe2fs 命令外，df 命令读取的也是 super block，速度非常快；du 命令需要遍历整个目录的所有文件，速度非常慢。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># df -hT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Filesystem     Type      Size  Used Avail Use% Mounted on</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">devtmpfs       devtmpfs   16G     </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">   16G   </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">% /dev</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">tmpfs          tmpfs      16G     </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">   16G   </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">% /dev/shm</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">tmpfs          tmpfs      16G  147M   16G   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">% /run</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">tmpfs          tmpfs      16G     </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">   16G   </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">% /sys/fs/cgroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/dev/vda4      xfs       483G  </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">.2G  482G   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">% /</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/dev/vda2      xfs      1014M  108M  907M  </span><span class="token number" style="color:rgb(9, 134, 88)">11</span><span class="token plain">% /boot</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/dev/vda1      vfat      200M  </span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token plain">.6M  193M   </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain">% /boot/efi</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">tmpfs          tmpfs     </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain">.2G     </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain">.2G   </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">% /run/user/0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><p>superblock 对于文件系统而言是至关重要的，超级块丢失或损坏必将导致文件系统的损坏。</p><p>旧式的文件系统将超级块备份到每一个块组中，但是这又有所空间浪费，所以 ext2 文件系统只在块组 0、1 和 3、5、7 幂次方的块组中保存超级块的信息，如 Group9、Group25 等。</p><p>尽管保存了这么多的 superblock，但是文件系统只使用第一个块组即 Group0 中超级块信息来获取文件系统属性，只有当 Group0 上的 superblock 损坏或丢失才会找下一个备份超级块复制到 Group0 中来恢复文件系统。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="423gdt">4.2.3、GDT<a class="hash-link" href="#423gdt" title="标题的直接链接">​</a></h3><p>ext 文件系统每一个块组信息使用 32 字节描述，这 32 个字节称为块组描述符，所有块组的块组描述符组成块组描述符表 GDT(group descriptor table)。</p><p>虽然每个块组都需要块组描述符来记录块组的信息和属性元数据，但是不是每个块组中都存放了块组描述符。</p><p>ext 文件系统的存储方式是将它们组成一个 GDT，并将该 GDT 存放于某些块组中，存放 GDT 的块组和存放 superblock 和备份 superblock 的块相同，也就是说它们是<strong>同时出现</strong>在某一个块组中的。读取时也总是读取 Group0 中的块组描述符表信息。</p><p>假如 block 大小为 4KB 的文件系统划分了 160 个块组，每个块组描述符 32 字节，那么 GDT 就需要 160 <!-- -->*<!-- --> 32 = 5120 字节即两个 block 来存放。这两个 GDT block 中记录了所有块组的块组信息，且存放 GDT 的块组中的 GDT 都是完全相同的。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 通过 dumpe2fs 获取 GDT 信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># dumpe2fs /dev/vdb2 | grep -A 100 &quot;Group 159&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">dumpe2fs </span><span class="token number" style="color:rgb(9, 134, 88)">1.42</span><span class="token plain">.13 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">17</span><span class="token plain">-May-2015</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Group </span><span class="token number" style="color:rgb(9, 134, 88)">159</span><span class="token plain">: </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">Blocks </span><span class="token number" style="color:rgb(9, 134, 88)">5210112</span><span class="token plain">-5242879</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  Block bitmap at </span><span class="token number" style="color:rgb(9, 134, 88)">5210112</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">+0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">, Inode bitmap at </span><span class="token number" style="color:rgb(9, 134, 88)">5210113</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">+1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  Inode表位于 </span><span class="token number" style="color:rgb(9, 134, 88)">5210114</span><span class="token plain">-5210625 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">+2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">32254</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">free</span><span class="token plain"> blocks, </span><span class="token number" style="color:rgb(9, 134, 88)">8192</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">free</span><span class="token plain"> inodes, </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> directories</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  可用块数: </span><span class="token number" style="color:rgb(9, 134, 88)">5210626</span><span class="token plain">-5242879</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  可用inode数: </span><span class="token number" style="color:rgb(9, 134, 88)">1302529</span><span class="token plain">-1310720</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="424reserved-gdt">4.2.4、Reserved GDT<a class="hash-link" href="#424reserved-gdt" title="标题的直接链接">​</a></h3><p>保留 GDT 用于以后扩容文件系统使用，防止扩容后块组太多，使得块组描述符超出当前存储 GDT 的 blocks。</p><p>保留 GDT 和 GDT 总是同时出现，当然也就和 superblock 同时出现了。</p><p>例如前面 160 个块组使用了 2 个 block 来存放 GDT，但是此时第二个 block 还空余很多空间，当扩容到一定程度时 2 个 block 已经无法再记录块组描述符了，这时就需要分配一个或多个 Reserved GDT 的 block 来存放超出的块组描述符。</p><p>由于新增加了 GDT block，所以应该让每一个保存 GDT 的块组都同时增加这一个 GDT block，所以将保留 GDT 和 GDT 存放在同一个块组中可以直接将保留 GDT 变换为 GDT 而无需使用低效的复制手段备份到每个存放 GDT 的块组。</p><p>同理，新增加了 GDT 需要修改每个块组中 superblock 中的文件系统属性，所以将 superblock 和 Reserved GDT/GDT 放在一起又能提升效率。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="43data-block">4.3、Data Block<a class="hash-link" href="#43data-block" title="标题的直接链接">​</a></h2><p><img loading="lazy" alt="ext filesystem construction" src="/assets/images/ext filesystem construction-0db6f63642bef8c14b0a1780db1c138b.png" width="999" height="361" class="img_ev3q"></p><p>如上图，除了 Data Blocks 其他的部分都解释过了。data block 是直接存储数据的 block，但事实上并非如此简单。</p><p>数据所占用的 block 由文件对应 inode 记录中的 block 指针找到，不同的文件类型，数据 block 中存储的内容是不一样的。以下是 Linux 中不同类型文件的存储方式。</p><ol><li>对于目录，该目录下的所有文件和一级子目录的目录名存储在数据块中。<ul><li><strong>文件名和 inode 号不是存储在其自身的 inode 中，而是存储在其所在目录的 data block 中</strong>。</li></ul></li><li>对于常规文件，文件的数据正常存储在数据块中。</li><li>对于符号链接，如果目标路径名较短则直接保存在 inode 中以便更快地查找，如果目标路径名较长则分配一个数据块来保存。</li><li>设备文件、FIFO 和 socket 等特殊文件没有数据块，设备文件的主设备号和次设备号保存在 inode 中。</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="431目录文件-data-block">4.3.1、目录文件 data block<a class="hash-link" href="#431目录文件-data-block" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="directory data block" src="/assets/images/directory data block-b5d7d3895298d1a8b6d9d9f23280dd4e.png" width="641" height="431" class="img_ev3q"></p><p>由图可知，在目录文件的数据块中存储了其下的文件名、目录名、目录本身的相对名称 &quot;.&quot; 和上级目录的相对名称 &quot;..&quot;，还存储了这些文件名对应的 inode 号、目录项长度 rec<!-- -->_<!-- -->len、文件名长度 name<!-- -->_<!-- -->len 和文件类型 file<!-- -->_<!-- -->type。</p><p>注意到除了文件本身的 inode 记录了文件类型，其所在的目录的数据块也记录了文件类型。</p><p>由于 rec<!-- -->_<!-- -->len 只能是 4 的倍数，所以需要使用 &quot;<!-- -->\<!-- -->0&quot; 来填充 name<!-- -->_<!-- -->len 不够凑满 4 倍数的部分。至于 rec<!-- -->_<!-- -->len 具体是什么，只需知道它是一种偏移即可。</p><p>需要注意的是，inode table 中的 inode 自身并没有存储每个 inode 的 inode 号，它是存储在目录的 data block 中的，通过 inode 号可以计算并索引到 inode table 中该 inode 号对应的 inode 记录，可以认为这个 inode 号是一个 inode 指针。</p><ul><li>并非真的是指针，但有助于理解通过 inode 号索引找到对应 inode 的这个过程，后文将在需要的时候使用 inode 指针这个词来表示 inode 号。</li><li>至此，已经知道了两种指针。<ul><li>一种是 inode table 中每个 inode 记录指向其对应 data block 的 block 指针</li><li>一种是 inode 指针。</li></ul></li></ul><p>除了 inode 号，目录的 data block 中还使用数字格式记录了文件类型，数字格式和文件类型的对应关系如下</p><table><thead><tr><th>编码</th><th>文件类型</th></tr></thead><tbody><tr><td>0</td><td>Unknown</td></tr><tr><td>1</td><td>Regular file</td></tr><tr><td>2</td><td>Directory</td></tr><tr><td>3</td><td>Character device</td></tr><tr><td>4</td><td>Block device</td></tr><tr><td>5</td><td>Named pipe</td></tr><tr><td>6</td><td>Socket</td></tr><tr><td>7</td><td>Symbolic link</td></tr></tbody></table><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="432通过-inode-号找到-inode">4.3.2、通过 inode 号找到 inode<a class="hash-link" href="#432通过-inode-号找到-inode" title="标题的直接链接">​</a></h3><p>前面提到过，inode 结构自身并没有保存 inode 号，也没有保存文件名，那么 inode 号保存在哪里呢？</p><ul><li>答：目录的 data block 中保存了该目录中每个文件的 inode 号和文件名。</li></ul><p>既然 inode 中没有 inode 号，那么如何根据目录 data block 中的 inode 号找到 inode table 中对应的 inode 呢？</p><ul><li>答：实际上，只要有了 inode 号，就可以计算出 inode 表中对应该 inode 号的 inode 结构。<ul><li>在创建文件系统的时候，每个块组中的起始 inode 号以及 inode table 的起始地址都已经确定了。</li><li>所以只要知道 inode 号，就能知道这个 inode 号和该块组起始 inode 号的偏移数量。</li><li>再根据每个 inode 结构的大小(256字节或其它大小)，就能计算出来对应的 inode 结构。</li><li>所以，目录的 data block 中的 inode number 和 inode table 中的 inode 是通过计算的方式一一映射起来的。</li><li>从另一个角度上看，目录 data block 中的 inode number 是找到 inode table 中对应 inode 记录的唯一方式。</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="433符号链接存储方式">4.3.3、符号链接存储方式<a class="hash-link" href="#433符号链接存储方式" title="标题的直接链接">​</a></h3><p>符号链接即为软链接，类似于 Windows 操作系统中的快捷方式，它的作用是指向原文件或目录。</p><p>软链接一般情况下不占用 data block，仅仅通过它对应的 inode 记录就能将其信息描述完成。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># ll /etc | grep &quot;^l&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">lrwxrwxrwx   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root  root       </span><span class="token number" style="color:rgb(9, 134, 88)">19</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">2020</span><span class="token plain"> mtab -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">/proc/self/mounts</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">lrwxrwxrwx   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root  root       </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">2020</span><span class="token plain"> os-release -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">/usr/lib/os-release</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">lrwxrwxrwx   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root  root       </span><span class="token number" style="color:rgb(9, 134, 88)">35</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain"> 07:25 resolv.conf -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /var/run/NetworkManager/resolv.conf</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">lrwxrwxrwx   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root  root       </span><span class="token number" style="color:rgb(9, 134, 88)">23</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">2020</span><span class="token plain"> vtrgb -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /etc/alternatives/vtrgb</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>符号链接的大小是其指向目标路径占用的字符个数。</p><ul><li>只有当符号链接指向的目标的路径名较长(60个字节)时，文件系统才会划分一个 data block 给它。</li></ul></li><li><p>符号链接权限为 777，它的权限如何也不重要，最终决定是否能读写执行的权限由原文件决定。</p></li><li><p>软链接的 block 指针存储的是目标文件名，也就是说链接文件的一切都依赖于其目标文件名。</p></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="434设备文件fifo套接字文件">4.3.4、设备文件、FIFO、套接字文件<a class="hash-link" href="#434设备文件fifo套接字文件" title="标题的直接链接">​</a></h3><p>关于这 3 种文件类型的文件只需要通过 inode 就能完全保存它们的信息，它们不占用任何数据块，所以它们是特殊文件。</p><p>设备文件的主设备号和次设备号也保存在 inode 中。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># ll /dev/ | grep &quot;^c&quot; | tail</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">crw-rw----   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root </span><span class="token function" style="color:rgb(0, 0, 255)">tty</span><span class="token plain">       </span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token plain">, </span><span class="token number" style="color:rgb(9, 134, 88)">132</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain"> 07:24 vcsa4</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">crw-rw----   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root </span><span class="token function" style="color:rgb(0, 0, 255)">tty</span><span class="token plain">       </span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token plain">, </span><span class="token number" style="color:rgb(9, 134, 88)">133</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain"> 07:24 vcsa5</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">crw-rw----   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root </span><span class="token function" style="color:rgb(0, 0, 255)">tty</span><span class="token plain">       </span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token plain">, </span><span class="token number" style="color:rgb(9, 134, 88)">134</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain"> 07:24 vcsa6</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">crw-rw----   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root </span><span class="token function" style="color:rgb(0, 0, 255)">tty</span><span class="token plain">       </span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token plain">, </span><span class="token number" style="color:rgb(9, 134, 88)">135</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain"> 07:24 vcsa7</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">crw-------   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root root     </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token plain">,  </span><span class="token number" style="color:rgb(9, 134, 88)">63</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain"> 07:24 vga_arbiter</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">crw-------   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root root     </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token plain">, </span><span class="token number" style="color:rgb(9, 134, 88)">137</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain"> 07:24 vhci</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">crw-------   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root root     </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token plain">, </span><span class="token number" style="color:rgb(9, 134, 88)">238</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain"> 07:24 vhost-net</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">crw-------   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root root     </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token plain">,  </span><span class="token number" style="color:rgb(9, 134, 88)">57</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain"> 07:24 vndbinder</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">crw-------   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root root    </span><span class="token number" style="color:rgb(9, 134, 88)">248</span><span class="token plain">,   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain"> 07:24 vport2p1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">crw-rw-rw-   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root root      </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">,   </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain"> 07:24 zero</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>第 5 列和第 6 列分别是主设备号和次设备号。<ul><li>主设备号标识每一种设备的类型；</li><li>次设备号标识同种设备类型的不同编号；</li></ul></li><li>这些信息中没有大小的信息，因为设备文件不占用数据块所以没有大小的概念。</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="44inode-机制">4.4、inode 机制<a class="hash-link" href="#44inode-机制" title="标题的直接链接">​</a></h2><p>每个文件都有一个 inode，在将 inode 关联到文件后系统将通过 inode 号来识别文件，而不是文件名。</p><p>并且访问文件时将先找到 inode，通过 inode 中记录的 block 位置找到该文件。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="441硬链接">4.4.1、硬链接<a class="hash-link" href="#441硬链接" title="标题的直接链接">​</a></h3><p>inode 相同的文件在 Linux 中被称为 &quot;硬链接&quot;。</p><ul><li>inode 号、元数据、block 位置都相同。</li><li>使用的都是同一条 inode 记录，所以代表的都是同一个文件。</li><li>这些文件所在目录的 data block 中的 inode 号都是一样的，只不过各 inode 号对应的文件名互不相同</li></ul><p>每个文件都有一个 &quot;硬链接数&quot; 的属性，使用 ls -l 的第二列就是被硬链接数，它表示的就是该文件有几个硬链接。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 查看硬链接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># ls -l /etc/app* -d</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> root root </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">月   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">2020</span><span class="token plain"> /etc/apparmor/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain"> root root </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">月   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">2020</span><span class="token plain"> /etc/apparmor.d/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain"> root root </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">月   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">2020</span><span class="token plain"> /etc/apport/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 目录不能创建硬链接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># mkdir dir_a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ln -v dir_a/ dir_b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ln: ‘dir_a/’: hard </span><span class="token function" style="color:rgb(0, 0, 255)">link</span><span class="token plain"> not allowed </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> directory   </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">dir_a</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 文件创建硬链接示例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># touch file_a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ll file_a </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root root </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> Oct </span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:35 file_a</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ln -v file_a file_b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">‘file_b’ </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> ‘file_a’</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ll</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">total </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> root root </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"> Oct </span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:33 dir_a</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> root root    </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> Oct </span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:35 file_a</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> root root    </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> Oct </span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:35 file_b</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ln -v file_a file_c</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">‘file_c’ </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> ‘file_a’</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ln -v file_a file_d</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">‘file_d’ </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> ‘file_a’</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ln -v file_a file_e</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">‘file_e’ </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> ‘file_a’</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ll</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">total </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> root root </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"> Oct </span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:33 dir_a</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain"> root root    </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> Oct </span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:35 file_a</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain"> root root    </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> Oct </span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:35 file_b</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain"> root root    </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> Oct </span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:35 file_c</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain"> root root    </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> Oct </span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:35 file_d</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain"> root root    </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> Oct </span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:35 file_e</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>每创建一个文件的硬链接，实质上是多一个指向该 inode 记录的 inode 指针，并且硬链接数加 1。</p><p>删除文件的实质是删除该文件所在目录 data block 中的对应的 inode 行，所以也是减少硬链接次数。</p><ul><li>block 指针是存储在 inode 中的，所以不是真的删除数据。</li><li>如果仍有其他 inode 号链接到该 inode，那么该文件的 block 指针仍然是可用的。</li><li>当硬链接次数为 1 时再删除文件就是真的删除文件了，此时 inode 记录中 block 指针也将被删除。</li></ul><p>不能跨分区创建硬链接，因为不同文件系统的inode号可能会相同，冲突。</p><p>硬链接只能对文件创建，无法对目录创建硬链接。</p><ul><li>因为文件系统已经把每个目录的硬链接创建好了，它们就是相对路径中的 &quot;.&quot; 和 &quot;..&quot;，分别标识当前目录的硬链接和上级目录的硬链接。</li><li>每一个目录中都会包含这两个硬链接，它包含了两个信息。<ol><li>一个没有子目录的目录文件的硬链接数是 2，其一是目录本身，即该目录 datablock 中的 &quot;.&quot;，其二是其父目录 datablock 中该目录的记录，这两者都指向同一个 inode 号；</li><li>一个包含子目录的目录文件，其硬链接数是 2+ 子目录数，因为每个子目录都关联一个父目录的硬链接 &quot;..&quot;。<ul><li>很多人在计算目录的硬链接数时认为由于包含了 &quot;.&quot; 和 &quot;..&quot;，所以空目录的硬链接数是 2，这是错误的，因为 &quot;..&quot; 不是本目录的硬链接。</li><li>另外，还有一个特殊的目录应该纳入考虑，即 &quot;/&quot; 目录，它自身是一个文件系统的入口，是自引用的，所以 &quot;/&quot; 目录下的 &quot;.&quot; 和 &quot;..&quot; 的 inode 号相同，它自身不占用硬链接。</li></ul></li></ol></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="442软链接">4.4.2、软链接<a class="hash-link" href="#442软链接" title="标题的直接链接">​</a></h3><p>软链接就是字符链接，链接文件默认指的就是字符链接文件(注意不是字符设备)，使用 &quot;l&quot; 表示其类型。</p><p>硬链接不能跨文件系统创建，否则 inode 号可能会冲突。于是实现了软链接以便跨文件系统建立链接。既然是跨文件系统，那么软链接必须得有自己的 inode 号。</p><p>软链接指向原文件，原文件损坏或消失，软链接文件就损坏。可以认为软链接 inode 记录中的指针内容是目标路径的字符串。</p><p><strong>ln 命令</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">ln</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">options</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">dest</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">ln</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">options</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> source</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.directory</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">选项说明：</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-s, --symbolic  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 建立符号连接以替代硬连接，没有指定此选项就是硬链接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-f, --force     </span><span class="token comment" style="color:rgb(0, 128, 0)"># 删除已存在的目的文件。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-n              </span><span class="token comment" style="color:rgb(0, 128, 0)"># 把符号链接视为一般目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-v, --verbose   </span><span class="token comment" style="color:rgb(0, 128, 0)"># 在建立连接前显示所操作的文件名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># ln -sv -f /usr/share/zoneinfo/Asia/Shanghai /etc/localtime </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;/etc/localtime&#x27;</span><span class="token plain"> -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;/usr/share/zoneinfo/Asia/Shanghai&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 好好感受一下这个实验，生产环境遇到的</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># mkdir dir_a dir_b dir_c dir_d   # 创建四个目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ls                              # 查看已有这四个目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">dir_a  dir_b  dir_c  dir_d</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ln -svf dir_b dir_a             # 我想让dir_a作为软链接指向dir_b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">‘dir_a/dir_b’ -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> ‘dir_b’                         </span><span class="token comment" style="color:rgb(0, 128, 0)"># 很显然不是我想要的，因为dir_a是个已存在目录，只能在dir_a中建立一个与dir_b同名的软链接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ln -svnf dir_b dir_c            # 加 -n 选项也不行，因为dir_c是个已存在目录，不是软链接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">‘dir_c/dir_b’ -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> ‘dir_b’</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ln -sv dir_b dir_new            # dir_new不存在，正好创建dir_new软链接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">‘dir_new’ -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> ‘dir_b’</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ll</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">total </span><span class="token number" style="color:rgb(9, 134, 88)">16</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> root root </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"> Oct </span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:41 dir_a</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> root root </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"> Oct </span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:40 dir_b</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> root root </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"> Oct </span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:42 dir_c</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> root root </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"> Oct </span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:40 dir_d</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">lrwxrwxrwx </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root root    </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain"> Oct </span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:43 dir_new -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> dir_b</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ln -snvf dir_d dir_new          # dir_new已存在，但它是一个软链接，不是真目录，所以可以使用-n选项替换掉目标目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">‘dir_new’ -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> ‘dir_d’</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 tmp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="443ext-文件系统预留的-inode-号">4.4.3、ext 文件系统预留的 inode 号<a class="hash-link" href="#443ext-文件系统预留的-inode-号" title="标题的直接链接">​</a></h3><p>Ext 预留了一些 inode 做特殊特性使用，如下：某些可能并非总是准确，具体的inode号对应什么文件可以使用 &quot;find / -inum NUM&quot; 查看。</p><table><thead><tr><th>Inode 号</th><th>用途</th></tr></thead><tbody><tr><td>0</td><td>不存在 0 号 inode，可用于标识目录 data block 中已删除的文件</td></tr><tr><td>1</td><td>虚拟文件系统，如 /proc 和 /sys</td></tr><tr><td><strong>2</strong></td><td><strong>根目录</strong></td></tr><tr><td>3</td><td>ACL 索引</td></tr><tr><td>4</td><td>ACL 数据</td></tr><tr><td>5</td><td>Boot loader</td></tr><tr><td>6</td><td>未删除的目录</td></tr><tr><td>7</td><td>预留的块组描述符 inode</td></tr><tr><td>8</td><td>日志 inode</td></tr><tr><td>11</td><td>第一个非预留的 inode，通常是 lost+found 目录</td></tr></tbody></table><p>在 ext4 文件系统的 dumpe2fs 信息中，能观察到 fisrt inode 号可能为 11 也可能为 12。</p><p>并且注意到 &quot;/&quot; 的 inode 号为 2，这个特性在文件访问时会用上。</p><p>需要注意的是，每个文件系统都会分配自己的 inode 号，不同文件系统之间是可能会出现使用相同 inode 号文件的。例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># find / -ignore_readdir_race -inum 2 -ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">      </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain"> drwxr-xr-x  </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"> root     root         </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">月 </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">2020</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">      </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain"> drwxr-xr-x   </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain"> root     root         </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">月 </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">2020</span><span class="token plain"> /boot</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">      </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> -rw-r--r--   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root     root            </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">月 </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain"> 07:24 /proc/sys/fs/binfmt_misc/status</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">      </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> c---------   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root     root       </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">,   </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">1970</span><span class="token plain"> /dev/pts/ptmx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">      </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> drwxr-xr-x   </span><span class="token number" style="color:rgb(9, 134, 88)">8</span><span class="token plain"> root     root            </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">11</span><span class="token plain">:10 /sys/fs</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">      </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> -rw-r--r--   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root     root            </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">月 </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain"> 07:24 /sys/fs/cgroup/memory/cgroup.procs</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">      </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> -rw-r--r--   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root     root            </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">11</span><span class="token plain">:10 /sys/fs/cgroup/debug/cgroup.procs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>除了根的 Inode 号为 2，还有几个文件的 inode 号也是 2，它们都属于独立的文件系统，有些是虚拟文件系统，如 /proc 和 /sys。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="444inode-寻址">4.4.4、inode 寻址<a class="hash-link" href="#444inode-寻址" title="标题的直接链接">​</a></h3><p>前文说过，inode 中保存了 blocks 指针，但是一条 inode 记录中能保存的指针数量是有限的，否则就会超出 inode 大小(128字节或256字节)。</p><p>在 ext2 和 ext3 文件系统中，一个 inode 中最多只能有 15 个指针，每个指针使用 i<!-- -->_<!-- -->block<!-- -->[<!-- -->n<!-- -->]<!-- --> 表示。</p><p><img loading="lazy" alt="block pointer adressing" src="/assets/images/block pointer addressing-764ef55b4d5d73fd0c160a5f00f846ee.png" width="909" height="721" class="img_ev3q"></p><ul><li>前 12 个指针 i<!-- -->_<!-- -->block<!-- -->[<!-- -->0<!-- -->]<!-- --> 到 i<!-- -->_<!-- -->block<!-- -->[<!-- -->11<!-- -->]<!-- --> 是直接寻址指针，每个指针指向一个数据区的 block。</li><li>第 13 个指针 i<!-- -->_<!-- -->block<!-- -->[<!-- -->12<!-- -->]<!-- --> 是一级间接寻址指针，它指向一个仍然存储了指针的 block 即 i<!-- -->_<!-- -->block<!-- -->[<!-- -->12<!-- -->]<!-- --> --&gt; Pointerblock --&gt; datablock。</li><li>第 14 个指针 i<!-- -->_<!-- -->block<!-- -->[<!-- -->13<!-- -->]<!-- --> 是二级间接寻址指针，它指向一个仍然存储了指针的 block，但是这个 block 中的指针还继续指向其他存储指针的 block，即 i<!-- -->_<!-- -->block<!-- -->[<!-- -->13<!-- -->]<!-- --> --&gt; Pointerblock1 --&gt; PointerBlock2 --&gt; datablock。</li><li>第 15 个指针 i<!-- -->_<!-- -->block<!-- -->[<!-- -->14<!-- -->]<!-- --> 是三级间接寻址指针，它指向一个任然存储了指针的 block，这个指针 block 下还有两次指针指向。即 i<!-- -->_<!-- -->block<!-- -->[<!-- -->13<!-- -->]<!-- --> --&gt; Pointerblock1 --&gt; PointerBlock2 --&gt; PointerBlock3 --&gt; datablock。</li></ul><p>其中由于每个指针大小为 4 字节，所以每个指针 block 能存放的指针数量为 BlockSize/4byte。例如 blocksize 为 4KB，那么一个 Block 可以存放 4096/4=1024 个指针。</p><p>为什么要分间接和直接指针呢？</p><ul><li>如果一个 inode 中 15 个指针全是直接指针，假如每个 block 的大小为 1KB，那么 15 个指针只能指向 15 个 block 即 15KB 的大小，由于每个文件对应一个 inode 号，所以就限制了每个文件最大为 15 <!-- -->*<!-- --> 1 = 15KB，这显然是不合理的。</li><li>如果存储大于 15KB 的文件而又不太大的时候，就占用一级间接指针 i<!-- -->_<!-- -->block<!-- -->[<!-- -->12<!-- -->]<!-- -->，这时可以存放指针数量为 1024/4+12=268，所以能存放 268KB 的文件。</li><li>如果存储大于 268K 的文件而又不太大的时候，就继续占用二级指针 i<!-- -->_<!-- -->block<!-- -->[<!-- -->13<!-- -->]<!-- -->，这时可以存放指针数量为 <!-- -->[<!-- -->1024/4<!-- -->]<!-- -->^2+1024/4+12=65804，所以能存放 65804KB=64M 左右的文件。</li><li>如果存放的文件大于 64M，那么就继续使用三级间接指针 i<!-- -->_<!-- -->block<!-- -->[<!-- -->14<!-- -->]<!-- -->，存放的指针数量为 <!-- -->[<!-- -->1024/4<!-- -->]<!-- -->^3+<!-- -->[<!-- -->1024/4<!-- -->]<!-- -->^2+<!-- -->[<!-- -->1024/4<!-- -->]<!-- -->+12=16843020 个指针，所以能存放 16843020KB=16GB 左右的文件。</li><li>如果 blocksize=4KB 呢？那么最大能存放的文件大小为 (<!-- -->[<!-- -->4096/4<!-- -->]<!-- -->^3+<!-- -->[<!-- -->4096/4<!-- -->]<!-- -->^2+<!-- -->[<!-- -->4096/4<!-- -->]<!-- -->+12)<!-- -->*<!-- -->4/1024/1024/1024=4T 左右。</li></ul><p>ext2 和 ext3 对超大文件的存取效率是低下的，ext4 针对这一点就进行了优化，ext4 使用 extent 的管理方式取代 ext2 和 ext3 的块映射，大大提高了效率也降低了碎片。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="45单文件系统文件操作机制">4.5、单文件系统文件操作机制<a class="hash-link" href="#45单文件系统文件操作机制" title="标题的直接链接">​</a></h2><p>在 Linux 上执行删除、复制、重命名、移动等操作时，它们是怎么进行的呢？还有访问文件时是如何找到它的呢？</p><p>其实只要理解了前文中介绍的几个术语以及它们的作用就很容易知道文件操作的原理了。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="451读文件">4.5.1、读文件<a class="hash-link" href="#451读文件" title="标题的直接链接">​</a></h3><p>当执行 &quot;cat /var/log/messages&quot; 命令在系统内部进行了什么样的步骤呢？</p><ol><li>找到根文件系统的块组描述符表所在的 blocks，读取 GDT(已在内存中) 找到 inode table 的 block号。<ul><li>因为 GDT 总是和 superblock 在同一个块组，而 superblock 总是在分区的第 1024-2047 个字节，所以很容易就知道第一个 GDT 所在的块组以及 GDT 在这个块组中占用了哪些 block。</li><li>其实 GDT 早已经在内存中了，在系统开机的时候会挂载根文件系统，挂载的时候就已经将所有的 GDT 放进内存中。</li></ul></li><li>在 inode table 的 block 中定位到根 &quot;/&quot; 的 inode，找出 &quot;/&quot; 指向的 data block。<ul><li>前文说过，ext 文件系统预留了一些 inode 号，其中 &quot;/&quot; 的 inode 号为 2，所以可以根据 inode 号直接定位根目录文件的 data block。</li></ul></li><li>在 &quot;/&quot; 的 datablock 中记录了 var 目录名和 var 的 inode 号，找到该 inode 记录，inode 记录中存储了指向 var 的 block 指针，所以也就找到了 var 目录文件的 data block。<ul><li>通过 var 目录的 inode 号，可以寻找到 var 目录的 inode 记录，但是在寻找的过程中，还需要知道该 inode 记录所在的块组以及所在的 inode table，所以需要读取 GDT，同样，GDT 已经缓存到了内存中。</li></ul></li><li>在 var 的 data block 中记录了 log 目录名和其 inode 号，通过该 inode 号定位到该 inode 所在的块组及所在的 inode table，并根据该 inode 记录找到 log 的 data block。</li><li>在 log 目录文件的 data block 中记录了 messages 文件名和对应的 inode 号，通过该 inode 号定位到该 inode 所在的块组及所在的 inode table，并根据该 inode 记录找到 messages 的 data block。</li><li>最后读取 messages 对应的 datablock。</li></ol><p><em>注意：该命令能被成功执行涉及了 cat 命令的寻找、权限判断以及 messages 文件的寻找和权限判断等等复杂的过程。上面只是介绍怎么找到 message 文件这一步。</em></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="452删除重命名和移动文件">4.5.2、删除、重命名和移动文件<a class="hash-link" href="#452删除重命名和移动文件" title="标题的直接链接">​</a></h3><p><strong>删除</strong>文件分为普通文件和目录文件，知道了这两种类型的文件的删除原理，就知道了其他类型特殊文件的删除方法。</p><ul><li>删除普通文件<ol><li>找到文件的 inode 和 data block(根据前一个小节中的方法寻找)；</li><li>将 inode table 中该 inode 记录中的 data block 指针删除；</li><li>在 imap 中将该文件的 inode 号标记为未使用；</li><li>在其所在目录的 data block 中将该文件名所在的记录行删除，删除了记录就丢失了指向 inode 的指针；<ul><li>实际上不是真的删除，直接删除的话会在目录 data block 的数据结构中产生空洞，所以实际的操作是将待删除文件的 inode 号设置为特殊的值 0，这样下次新建文件时就可以重用该行记录。</li></ul></li><li>将 bmap 中 data block 对应的 block 号标记为未使用。</li></ol></li><li>删除目录文件<ol><li>找到目录和目录下所有文件、子目录、子文件的 inode 和 data block；</li><li>在 imap 中将这些 inode 号标记为未使用；</li><li>将 bmap 中将这些文件占用的 block号标记为未使用；</li><li>在该目录的父目录的 data block 中将该目录名所在的记录行删除。<ul><li>需要注意的是，删除父目录 data block 中的记录是最后一步，如果该步骤提前，将报目录非空的错误，因为在该目录中还有文件占用。</li></ul></li></ol></li></ul><p><strong>重命名</strong>文件分为同目录内重命名和非同目录内重命名。非同目录内重命名实际上是移动文件的过程。</p><ul><li>同目录内重命名文件的动作仅仅只是修改所在目录 data block 中该文件记录的文件名部分，不是删除再重建的过程。</li><li>如果重命名时有文件名冲突(该目录内已经存在该文件名)，则提示是否覆盖。覆盖的过程是覆盖目录 data block 中冲突文件的记录。</li></ul><p><strong>移动文件</strong></p><ul><li>同文件系统下移动文件实际上是修改目标文件所在目录的 data block，向其中添加一行指向 inode table 中待移动文件的 inode 指针；</li><li>如果目标路径下有同名文件，则会提示是否覆盖，实际上是覆盖目录 data block 中冲突文件的记录，由于同名文件的 inode 记录指针被覆盖，所以无法再找到该文件的 data block，也就是说该文件被标记为删除。</li><li>所以在同文件系统内移动文件相当快，仅仅在所在目录 data block 中添加或覆盖了一条记录而已。也因此，移动文件时，文件的 inode 号是不会改变的。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="453存储文件">4.5.3、存储文件<a class="hash-link" href="#453存储文件" title="标题的直接链接">​</a></h3><ol><li>读取 GDT，找到各个(或部分)块组 imap 中未使用的 inode 号，并为待存储文件分配 inode 号；</li><li>在 inode table 中完善该 inode 号所在行的记录；</li><li>在目录的 data block 中添加一条该文件的相关记录；</li><li>将数据填充到 data block 中。<ul><li>注意，填充到 data block 中的时候会调用 block 分配器：一次分配 4KB 大小的 block 数量，当填充完 4KB 的 data block 后会继续调用 block 分配器分配 4KB 的 block，然后循环直到填充完所有数据。也就是说，如果存储一个 100M 的文件需要调用 block 分配器 100<!-- -->*<!-- -->1024/4=25600 次。</li><li>另一方面，在 block 分配器分配 block 时，block 分配器并不知道真正有多少 block 要分配，只是每次需要分配时就分配，在每存储一个 data block 前，就去 bmap 中标记一次该 block 已使用，它无法实现一次标记多个 bmap 位。这一点在 ext4 中进行了优化。</li></ul></li><li>填充完之后，去 inode table 中更新该文件 inode 记录中指向 data block 的寻址指针。</li></ol><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="46多文件系统关联">4.6、多文件系统关联<a class="hash-link" href="#46多文件系统关联" title="标题的直接链接">​</a></h2><p>在单个文件系统中的文件操作和多文件系统中的操作有所不同。本文将对此做出非常详细的说明。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="461根文件系统的特殊性">4.6.1、根文件系统的特殊性<a class="hash-link" href="#461根文件系统的特殊性" title="标题的直接链接">​</a></h3><p>首先明确的是，任何一个文件系统要在 Linux 上能正常使用，必须挂载在某个已经挂载好的文件系统中的某个目录下，例如 /dev/cdrom 挂载在 /mnt 上，/mnt 目录本身是在 &quot;/&quot; 文件系统下的。</p><p>而且任意文件系统的一级挂载点必须是在根文件系统的某个目录下，因为只有 &quot;/&quot; 是自引用的。这里要说明挂载点的级别和自引用的概念。</p><ul><li><p>挂载点的级别</p><ul><li>假如 /dev/sdb1 挂载在 /mydata 上，/dev/cdrom 挂载在 /mydata/cdrom 上，那么 /mydata 就是一级挂载点。</li><li>此时 /mydata 已经是文件系统 /dev/sdb1 的入口了，而 /dev/cdrom 所挂载的目录 /mydata/cdrom 是文件系统 /dev/sdb1 中的某个目录，那么 /mydata/cdrom 就是二级挂载点。</li><li>所以可简述为，文件系统 2 挂载在文件系统 1 中的某个目录下，而文件系统 1 又挂载在根文件系统中的某个目录下。</li></ul></li><li><p>自引用的概念</p><ul><li>首先要说的是，自引用的只能是文件系统，而文件系统表现形式是一个目录。</li><li>自引用是指该目录的 data block 中，&quot;.&quot; 和 &quot;..&quot; 的记录中的 inode 号都对应 inode table 中同一个 inode 记录，所以它们 inode 号是相同的，即互为硬链接。</li><li>根文件系统是唯一可以自引用的文件系统。</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># ll -ai /</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">总用量 </span><span class="token number" style="color:rgb(9, 134, 88)">524</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> drwxr-xr-x  </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"> root root   </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">2020</span><span class="token plain"> ./</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> drwxr-xr-x  </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"> root root   </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">2020</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># cd /.和cd /..的结果都还是在根下，这是自引用最直接的表现形式。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># cd /.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:/</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:/</span><span class="token comment" style="color:rgb(0, 128, 0)"># cd /..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:/</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><em>注意：根目录下的 &quot;.&quot; 和 &quot;..&quot; 都是 &quot;/&quot; 目录的硬链接，且其 datablock 中不记录名为 &quot;/&quot; 的条目，因此除去根目录下子目录数后的硬链接数为 2。</em></p></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="462挂载文件系统过程">4.6.2、挂载文件系统过程<a class="hash-link" href="#462挂载文件系统过程" title="标题的直接链接">​</a></h3><p>挂载文件系统到某个目录下，例如 &quot;mount /dev/vdb2 /mnt/&quot;，挂载成功后 /mnt 目录中的文件全都暂时不可见了，且挂载后权限和所有者(如果指定允许普通用户挂载)等都改变了。</p><p>下图是原始的文件系统结构，/mnt 是根文件系统中的一个目录，&quot;/&quot; 的 data block 中记录了 /mnt 的一些信息，其中包括 inode 号 n(inode指针)，而在 inode table 中，/mnt 对应的 inode 记录中又存储了 block 指针 Block<!-- -->_<!-- -->n，此时这两个指针还是普通的指针。</p><p><img loading="lazy" alt="mount" src="/assets/images/mount-c4567f7e0d4a69365721d8d5e448526e.png" width="728" height="447" class="img_ev3q"></p><p>当文件系统 /dev/vdb2 挂载到 /mnt 上后，/mnt 此时就已经成为另一个文件系统的入口了，因此它需要连接两边文件系统的 inode 和 data block。但是如何连接呢？如下图。</p><p><img loading="lazy" alt="mount1" src="/assets/images/mount1-5f11e1544153bcd2d30f1b417dd24f46.png" width="772" height="730" class="img_ev3q"></p><ol><li>在根文件系统的 inode table 中，为 /mnt 重新分配一个 inode 记录 m，该记录的 block 指针 block<!-- -->_<!-- -->m 指向文件系统 /dev/vdb2 中的 data block。</li><li>既然为 /mnt 分配了新的 inode 记录 m，那么在 &quot;/&quot; 目录的 data block 中，也需要修改其 inode 指针为 m 以指向 m 记录。同时，原来 inode table 中的 inode 记录 n 就被标记为暂时不可用(转成黑色表示)。</li><li>Block<!-- -->_<!-- -->m 指向的是文件系统 /dev/vdb2 的 data block，所以严格说起来，除了 /mnt 的元数据信息即 inode 记录 m 还在根文件系统上，/mnt 的 data block 已经是在 /dev/vdb2 中的了。</li><li>这就是挂载新文件系统后实现的跨文件系统，它将挂载点的元数据信息和数据信息分别存储在不同的文件系统上。</li><li>挂载完成后，将在 /proc/self/{mounts,mountstats,mountinfo} 这三个文件中写入挂载记录和相关的挂载信息，并会将 /proc/self/mounts 中的信息同步到 /etc/mtab 文件中，当然，如果挂载时加了 -n 参数，将不会同步到 /etc/mtab。</li><li>而卸载文件系统，其实质是移除临时新建的 inode 记录(当然，在移除前会检查是否正在使用)及其指针，并将指针指回原来的 inode 记录，这样 inode 记录中的 block 指针也就同时生效而找回对应的 data block 了。</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 挂载前后/mnt的inode号会变</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># ll -id /mnt/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">1700609</span><span class="token plain"> drwxr-xr-x </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain"> root root </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain">月   </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">15</span><span class="token plain">:10 /mnt//</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># mount /dev/vdb2 /mnt/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># ll -id /mnt/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> drwxr-xr-x </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> root root </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain">月   </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">16</span><span class="token plain">:09 /mnt//</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 挂载后/mnt里面原来的文件不可见</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># ll /mnt/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">总用量 </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">drwxr-xr-x  </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> root root </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain">月   </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain">:02 ./</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"> root root </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">2020</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-rw-r--r--  </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root root  </span><span class="token number" style="color:rgb(9, 134, 88)">187</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain">月   </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain">:01 wpplog</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-rw-r--r--  </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root root    </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain">月   </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain">:01 wpsd1000.log</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">srwxr-xr-x  </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root root    </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain">月   </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain">:01 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">wps_startup_ipcsvr</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># mount /dev/vdb2 /mnt/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># ll /mnt/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">总用量 </span><span class="token number" style="color:rgb(9, 134, 88)">24</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">drwxr-xr-x  </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> root root  </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain">月   </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">16</span><span class="token plain">:09 ./</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"> root root  </span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">月  </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">2020</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">drwx------  </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> root root </span><span class="token number" style="color:rgb(9, 134, 88)">16384</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain">月   </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">16</span><span class="token plain">:09 lost+found/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root@arm64v8:~</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>挂载文件系统后，挂载点原来的 inode 记录暂时被标记为不可用，关键是没有指向该 inode 记录的 inode 指针了，所以原文件不可见。</li><li>在卸载文件系统后，又重新启用挂载点原来的 inode 记录，&quot;/&quot; 目录下的 mnt 的 inode 指针又重新指向该 inode 记录，原文件恢复可见。</li><li>挂载后，挂载点的元数据和 data block 是分别存放在不同文件系统上的。</li><li>挂载点即使在挂载后，也还是属于原文件系统的文件。</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="47ext3-文件系统的日志功能">4.7、ext3 文件系统的日志功能<a class="hash-link" href="#47ext3-文件系统的日志功能" title="标题的直接链接">​</a></h2><p>ext2 文件系统中，只有两个区，数据区和元数据区。</p><ul><li>如果正在向 data block 中填充数据时突然断电，那么下一次启动时就会检查文件系统中数据和状态的一致性，这段检查和修复可能会消耗大量时间，甚至检查后无法修复。</li></ul><p>ext3 文件系统中，划分三个区，数据区、日志区和元数据区。</p><ul><li>每次存储数据时，先在日志区中进行 ext2 中元数据区的活动，直到文件存储完成后标记上 commit 才将日志区中的数据转存到元数据区。</li><li>当存储文件时突然断电，下一次检查修复文件系统时，只需要检查日志区的记录，将 bmap 对应的 data block 标记为未使用，并把 inode 号标记未使用，这样就不需要扫描整个文件系统而耗费大量时间。</li></ul><p>虽说 ext3 相比 ext2 多了一个日志区转写元数据区的动作而导致 ext3 相比 ext2 性能要差一点，特别是写众多小文件时。但是由于 ext3 其他方面的优化使得 ext3 和 ext2 性能几乎没有差距。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="48ext4-文件系统改进">4.8、ext4 文件系统改进<a class="hash-link" href="#48ext4-文件系统改进" title="标题的直接链接">​</a></h2><p>Ext4 文件系统文件数据管理参考了现代文件系统的实现方式，也即 extent 方式。如下图所示，其数据管理的入口仍然是 inode 节点的 i<!-- -->_<!-- -->block 成员。</p><p>差异是此时 i<!-- -->_<!-- -->block 并非一个 32 位整数数组，而是一个描述 B 树结构的数据结构（包含 ext4<!-- -->_<!-- -->extent<!-- -->_<!-- -->header 和 ext4<!-- -->_<!-- -->extent<!-- -->_<!-- -->idx）。</p><p>在该数据结构中，只有叶子节点中存储的数据包含文件逻辑地址与磁盘物理地址的映射关系。</p><p><img loading="lazy" alt="ext4" src="/assets/images/ext4-16028abd8464aeb3d36e0f4e8b20077c.png" width="1068" height="702" class="img_ev3q"></p><p>在数据管理中有 3 个关键的数据结构，分别是 ext4<!-- -->_<!-- -->extent<!-- -->_<!-- -->header、ext4<!-- -->_<!-- -->extent<!-- -->_<!-- -->idx 和 ext4<!-- -->_<!-- -->extent。</p><blockquote><p>ext4<!-- -->_<!-- -->extent<!-- -->_<!-- -->header</p></blockquote><p>该数据结构在一个磁盘逻辑块的最开始的位置，描述该磁盘逻辑块的 B 树属性，也即该逻辑块中数据的类型（例如是否为叶子节点）和数量。</p><p>如果 eh<!-- -->_<!-- -->depth 为 0，则该逻辑块中数据项为B树的叶子节点，此时其中存储的是 ext4<!-- -->_<!-- -->extent 数据结构实例。</p><p>如果 eh<!-- -->_<!-- -->depth&gt;0，则其中存储的是非叶子节点，也即 ext4<!-- -->_<!-- -->extent<!-- -->_<!-- -->idx，用于存储指向下一级的索引。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">struct ext4_extent_header </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        __le16  eh_magic</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">       /* 魔数 */</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        __le16  eh_entries</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">     /* 可用的项目的数量 */</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        __le16  eh_max</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">         /* 本区域可以存储最大项目数量 */</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        __le16  eh_depth</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">       /* 当前层树的深度 */</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        __le32  eh_generation</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>ext4<!-- -->_<!-- -->extent<!-- -->_<!-- -->idx</p></blockquote><p>该数据结构是 B 树中的索引节点，该数据结构用于指向下一级，下一级可以仍然是索引节点，或者叶子节点。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">struct ext4_extent_idx </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        __le32  ei_block</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">       /* 索引覆盖的逻辑块的数量，以块为单位 */</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        __le32  ei_leaf_lo</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">     /* 指向下一级物理块的位置，*/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        __le16  ei_leaf_hi</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">     /* 物理块位置的高16位 */</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        __u16   ei_unused</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>ext4<!-- -->_<!-- -->extent</p></blockquote><p>描述了文件逻辑地址与磁盘物理地址的关系。通过该数据结构，可以找到文件某个偏移的一段数据在磁盘的具体位置。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">struct ext4_extent </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        __le32  ee_block</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">       /* 该extent覆盖的第一个逻辑地址，以块为单位 */     </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        __le16  ee_len</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">         /* 该extent覆盖的逻辑块的位置 */  </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        __le16  ee_start_hi</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">    /* 物理块的高16位 */ </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        __le32  ee_start_lo</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">    /* 物理块的低16位 */       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="49ext-文件系统不足">4.9、ext 文件系统不足<a class="hash-link" href="#49ext-文件系统不足" title="标题的直接链接">​</a></h2><p>最大的缺点是它在创建文件系统的时候就划分好一切需要划分的东西，以后用到的时候可以直接进行分配，也就是说它不支持动态划分和动态分配。</p><p>对于较小的分区来说速度还好，但是对于一个超大的磁盘，速度很慢。</p><p>除了格式化速度超慢以外，ext4 文件系统还是非常可取的。当然，不同公司开发的文件系统都各有特色，最主要的还是根据需求选择合适的文件系统类型。</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/linux-primary-3"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">第 3 章 Linux 文件权限</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/linux-primary-5"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">第 5 章 Linux 磁盘管理</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#41文件系统组件" class="table-of-contents__link toc-highlight">4.1、文件系统组件</a><ul><li><a href="#411block-概念" class="table-of-contents__link toc-highlight">4.1.1、block 概念</a></li><li><a href="#412inode-概念" class="table-of-contents__link toc-highlight">4.1.2、inode 概念</a></li><li><a href="#413bmap-概念" class="table-of-contents__link toc-highlight">4.1.3、bmap 概念</a></li><li><a href="#414inode-table-概念" class="table-of-contents__link toc-highlight">4.1.4、inode table 概念</a></li><li><a href="#415imap-概念" class="table-of-contents__link toc-highlight">4.1.5、imap 概念</a></li><li><a href="#416block-group-概念" class="table-of-contents__link toc-highlight">4.1.6、block group 概念</a></li><li><a href="#417划分-block-group" class="table-of-contents__link toc-highlight">4.1.7、划分 block group</a></li><li><a href="#418划分-inode" class="table-of-contents__link toc-highlight">4.1.8、划分 inode</a></li><li><a href="#419查看文件系统组件" class="table-of-contents__link toc-highlight">4.1.9、查看文件系统组件</a></li></ul></li><li><a href="#42文件系统完整结构" class="table-of-contents__link toc-highlight">4.2、文件系统完整结构</a><ul><li><a href="#421boot-block" class="table-of-contents__link toc-highlight">4.2.1、Boot Block</a></li><li><a href="#422super-block" class="table-of-contents__link toc-highlight">4.2.2、Super Block</a></li><li><a href="#423gdt" class="table-of-contents__link toc-highlight">4.2.3、GDT</a></li><li><a href="#424reserved-gdt" class="table-of-contents__link toc-highlight">4.2.4、Reserved GDT</a></li></ul></li><li><a href="#43data-block" class="table-of-contents__link toc-highlight">4.3、Data Block</a><ul><li><a href="#431目录文件-data-block" class="table-of-contents__link toc-highlight">4.3.1、目录文件 data block</a></li><li><a href="#432通过-inode-号找到-inode" class="table-of-contents__link toc-highlight">4.3.2、通过 inode 号找到 inode</a></li><li><a href="#433符号链接存储方式" class="table-of-contents__link toc-highlight">4.3.3、符号链接存储方式</a></li><li><a href="#434设备文件fifo套接字文件" class="table-of-contents__link toc-highlight">4.3.4、设备文件、FIFO、套接字文件</a></li></ul></li><li><a href="#44inode-机制" class="table-of-contents__link toc-highlight">4.4、inode 机制</a><ul><li><a href="#441硬链接" class="table-of-contents__link toc-highlight">4.4.1、硬链接</a></li><li><a href="#442软链接" class="table-of-contents__link toc-highlight">4.4.2、软链接</a></li><li><a href="#443ext-文件系统预留的-inode-号" class="table-of-contents__link toc-highlight">4.4.3、ext 文件系统预留的 inode 号</a></li><li><a href="#444inode-寻址" class="table-of-contents__link toc-highlight">4.4.4、inode 寻址</a></li></ul></li><li><a href="#45单文件系统文件操作机制" class="table-of-contents__link toc-highlight">4.5、单文件系统文件操作机制</a><ul><li><a href="#451读文件" class="table-of-contents__link toc-highlight">4.5.1、读文件</a></li><li><a href="#452删除重命名和移动文件" class="table-of-contents__link toc-highlight">4.5.2、删除、重命名和移动文件</a></li><li><a href="#453存储文件" class="table-of-contents__link toc-highlight">4.5.3、存储文件</a></li></ul></li><li><a href="#46多文件系统关联" class="table-of-contents__link toc-highlight">4.6、多文件系统关联</a><ul><li><a href="#461根文件系统的特殊性" class="table-of-contents__link toc-highlight">4.6.1、根文件系统的特殊性</a></li><li><a href="#462挂载文件系统过程" class="table-of-contents__link toc-highlight">4.6.2、挂载文件系统过程</a></li></ul></li><li><a href="#47ext3-文件系统的日志功能" class="table-of-contents__link toc-highlight">4.7、ext3 文件系统的日志功能</a></li><li><a href="#48ext4-文件系统改进" class="table-of-contents__link toc-highlight">4.8、ext4 文件系统改进</a></li><li><a href="#49ext-文件系统不足" class="table-of-contents__link toc-highlight">4.9、ext 文件系统不足</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">学习</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/tags">标签</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">归档</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/skill">技术笔记</a></li><li class="footer__item"><a class="footer__link-item" href="/project">实战项目</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/linux">Linux</a></li></ul></div><div class="col footer__col"><div class="footer__title">社交媒体</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/about">关于我</a></li><li class="footer__item"><a href="https://github.com/zqingfa" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://juejin.cn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">掘金<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" position="right" href="/friends">友链</a></li><li class="footer__item"><a class="footer__link-item" position="right" href="/website">导航</a></li><li class="footer__item"><a href="https://docusaurus.io/zh-CN/" target="_blank"><img style="height:50px;margin-top:0.5rem" src="/img/buildwith.png"><a></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p><a href="http://beian.miit.gov.cn/">浙ICP备20024502号-1</a></p><p>Copyright © 2022 - PRESENT zhangqf Built with Docusaurus.</p></div></div></div></footer></div>
<script src="/assets/js/runtime~main.839460ba.js"></script>
<script src="/assets/js/main.6b7778c5.js"></script>
</body>
</html>