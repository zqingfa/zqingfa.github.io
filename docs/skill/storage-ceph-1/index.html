<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-skill/storage/storage-ceph-1">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">01. ceph架构简介及使用场景介绍 - Linux技术分享</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://zhangqf.com/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://zhangqf.com/img/logo.png"><meta data-rh="true" property="og:url" content="https://zhangqf.com/docs/skill/storage-ceph-1"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="01. ceph架构简介及使用场景介绍 - Linux技术分享"><meta data-rh="true" name="description" content="1. Ceph架构简介及使用场景介绍"><meta data-rh="true" property="og:description" content="1. Ceph架构简介及使用场景介绍"><meta data-rh="true" name="keywords" content="storage,ceph"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://zhangqf.com/docs/skill/storage-ceph-1"><link data-rh="true" rel="alternate" href="https://zhangqf.com/en/docs/skill/storage-ceph-1" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/skill/storage-ceph-1" hreflang="zh"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/skill/storage-ceph-1" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9B0V5WT2X8-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S4SD5NXWXF"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S4SD5NXWXF",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Linux技术分享" href="/opensearch.xml">
<link rel="preconnect" href="https://zhangqf.com/">
<script>var _paq=window._paq=window._paq||[];_paq.push(["setRequestMethod","POST"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),_paq.push(["enableHeartBeatTimer"]),function(){var e="https://zhangqf.com/";_paq.push(["setRequestMethod","POST"]),_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]);var a=document,t=a.createElement("script"),p=a.getElementsByTagName("script")[0];t.type="text/javascript",t.async=!0,t.src=e+"matomo.js",p.parentNode.insertBefore(t,p)}()</script>


<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?77dc6b24cf1d939292e9fe13be271a96",e.defer=!0;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<meta name="baidu-site-verification" content="code-rqLUw5reVS">
<script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",t.defer=!0;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script>
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="zhangqf RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="zhangqf Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="zhangqf JSON Feed">

<link rel="icon" href="/img/logo.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(51 139 255)"><link rel="stylesheet" href="/assets/css/styles.bf38107f.css">
<link rel="preload" href="/assets/js/runtime~main.7dd3723b.js" as="script">
<link rel="preload" href="/assets/js/main.389df9ef.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><span>更新 <a href="/website">网址导航</a> 带你发现感兴趣的技术</span></div><button type="button" aria-label="关闭" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">zhangqf</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/linux">Linux</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/category/Linux基础">Linux 基础</a></li><li><a class="dropdown__link" href="/docs/category/Linux进阶">Linux 进阶</a></li><li><a class="dropdown__link" href="/docs/category/Linux测试">Linux 测试</a></li><li><a class="dropdown__link" href="/docs/category/LinuxCICD">Linux CICD研发</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/skill/">笔记</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tags">标签</a></li><li><a class="dropdown__link" href="/archive">归档</a></li><li><a class="dropdown__link" href="/docs/category/存储">存储</a></li></ul></div><a class="navbar__item navbar__link" href="/website">导航</a><a class="navbar__item navbar__link" href="/project">项目</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中文</a><ul class="dropdown__menu"><li><a href="/en/docs/skill/storage-ceph-1" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-GB">English</a></li><li><a href="/docs/skill/storage-ceph-1" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh">中文</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"><b>zhangqf</b></a><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/skill">技术笔记简介</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/存储">存储</a><button aria-label="打开/收起侧边栏菜单「存储」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/skill/storage-ceph-1">01. ceph架构简介及使用场景介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/skill/storage-ceph-2">02. Cephadm在麒麟V10搭建ceph集群</a></li></ul></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/存储"><span itemprop="name">存储</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">01. ceph架构简介及使用场景介绍</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>01. ceph架构简介及使用场景介绍</h1></header><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-ceph架构简介及使用场景介绍"><strong>1. Ceph架构简介及使用场景介绍</strong><a href="#1-ceph架构简介及使用场景介绍" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11-ceph简介"><strong>1.1 Ceph简介</strong><a href="#11-ceph简介" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>Ceph是一个统一的分布式存储系统，设计初衷是提供较好的性能、可靠性和可扩展性。</p><p>Ceph项目最早起源于Sage就读博士期间的工作（最早的成果于2004年发表），并随后贡献给开源社区。在经过了数年的发展之后，目前已得到众多云计算厂商的支持并被广泛应用。RedHat及OpenStack都可与Ceph整合以支持虚拟机镜像的后端存储。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="12-ceph特点"><strong>1.2 Ceph特点</strong><a href="#12-ceph特点" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><ul><li><p>高性能
a. 摒弃了传统的集中式存储元数据寻址的方案，采用CRUSH算法，数据分布均衡，并行度高。
b.考虑了容灾域的隔离，能够实现各类负载的副本放置规则，例如跨机房、机架感知等。
c. 能够支持上千个存储节点的规模，支持TB到PB级的数据。</p></li><li><p>高可用性
a. 副本数可以灵活控制。
b. 支持故障域分隔，数据强一致性。
c. 多种故障场景自动进行修复自愈。
d. 没有单点故障，自动管理。</p></li><li><p>高可扩展性
a. 去中心化。
b. 扩展灵活。
c. 随着节点增加而线性增长。</p></li><li><p>特性丰富
a. 支持三种存储接口：块存储、文件存储、对象存储。
b. 支持自定义接口，支持多种语言驱动。</p></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="13-ceph架构"><strong>1.3 Ceph架构</strong><a href="#13-ceph架构" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>支持三种接口：</p><ul><li>Object：有原生的API，而且也兼容Swift和S3的API。</li><li>Block：支持精简配置、快照、克隆。</li><li>File：Posix接口，支持快照。</li></ul><p><img loading="lazy" alt="img" src="/assets/images/v2-78227d8ecfec1cf6a01a87172a85da2c_720w-b76ed53ea94b43fcd1e7defac9b99521.webp" width="700" height="297" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="14-ceph核心组件及概念介绍"><strong>1.4 Ceph核心组件及概念介绍</strong><a href="#14-ceph核心组件及概念介绍" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><ul><li><p>Monitor
一个Ceph集群需要多个Monitor组成的小集群，它们通过Paxos同步数据，用来保存OSD的元数据。</p></li><li><p>OSD
OSD全称Object Storage Device，也就是负责响应客户端请求返回具体数据的进程。一个Ceph集群一般都有很多个OSD。</p></li><li><p>MDS
MDS全称Ceph Metadata Server，是CephFS服务依赖的元数据服务。</p></li><li><p>Object
Ceph最底层的存储单元是Object对象，每个Object包含元数据和原始数据。</p></li><li><p>PG
PG全称Placement Grouops，是一个逻辑的概念，一个PG包含多个OSD。引入PG这一层其实是为了更好的分配数据和定位数据。</p></li><li><p>RADOS
RADOS全称Reliable Autonomic Distributed Object Store，是Ceph集群的精华，用户实现数据分配、Failover等集群操作。</p></li><li><p>Libradio
Librados是Rados提供库，因为RADOS是协议很难直接访问，因此上层的RBD、RGW和CephFS都是通过librados访问的，目前提供PHP、Ruby、Java、Python、C和C++支持。</p></li><li><p>CRUSH
CRUSH是Ceph使用的数据分布算法，类似一致性哈希，让数据分配到预期的地方。</p></li><li><p>RBD
RBD全称RADOS block device，是Ceph对外提供的块设备服务。</p></li><li><p>RGW
RGW全称RADOS gateway，是Ceph对外提供的对象存储服务，接口与S3和Swift兼容。</p></li><li><p>CephFS
CephFS全称Ceph File System，是Ceph对外提供的文件系统服务。</p></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="15-三种存储类型-块存储"><strong>1.5 三种存储类型-块存储</strong><a href="#15-三种存储类型-块存储" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="img" src="data:image/webp;base64,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" width="700" height="278" class="img_ev3q"></p><p>典型设备：磁盘阵列，硬盘</p><p>主要是将裸磁盘空间映射给主机使用的。</p><p>优点：</p><ul><li>通过Raid与LVM等手段，对数据提供了保护。</li><li>多块廉价的硬盘组合起来，提高容量。</li><li>多块磁盘组合出来的逻辑盘，提升读写效率。</li></ul><p>缺点：</p><ul><li>采用SAN架构组网时，光纤交换机，造价成本高。</li><li>主机之间无法共享数据。</li></ul><p>使用场景：</p><ul><li>docker容器、虚拟机磁盘存储分配。</li><li>日志存储。</li><li>文件存储。</li><li>…</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="16-三种存储类型-文件存储"><strong>1.6 三种存储类型-文件存储</strong><a href="#16-三种存储类型-文件存储" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="img" src="/assets/images/v2-977bde949bfa5412ed1ced473f8b3302_720w-173b843cb9e09cdf35e5802b85cc4f6f.webp" width="700" height="401" class="img_ev3q"></p><p>典型设备：FTP、NFS服务器</p><p>为了克服块存储文件无法共享的问题，所以有了文件存储。</p><p>在服务器上架设FTP与NFS服务，就是文件存储。</p><p>优点：</p><ul><li>造价低，随便一台机器就可以了。</li><li>方便文件共享。</li></ul><p>缺点：</p><ul><li>读写速率低。</li><li>传输速率慢。</li></ul><p>使用场景：</p><ul><li>日志存储。</li><li>有目录结构的文件存储。</li><li>…</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="17-三种存储类型-对象存储"><strong>1.7 三种存储类型-对象存储</strong><a href="#17-三种存储类型-对象存储" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="img" src="/assets/images/v2-d294e3735cff0c13bc0137a0b1b7e060_720w-2dd83f817bd36b6bdf073ceae2e6aed7.webp" width="700" height="523" class="img_ev3q"></p><p>典型设备：内置大容量硬盘的分布式服务器(swift, s3)</p><p>多台服务器内置大容量硬盘，安装上对象存储管理软件，对外提供读写访问功能。</p><p>优点：</p><ul><li>具备块存储的读写高速。</li><li>具备文件存储的共享等特性。</li></ul><p>使用场景：(适合更新变动较少的数据)</p><ul><li>图片存储。</li><li>视频存储。</li><li>…</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-ceph-io流程及数据分布"><strong>2. Ceph IO流程及数据分布</strong><a href="#2-ceph-io流程及数据分布" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><p><img loading="lazy" alt="img" src="/assets/images/v2-30ec2b6fe84fcb8777df98c8c3653deb_720w-1baa1bf8bad9630fe5372e4c063db7f3.webp" width="700" height="335" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="21-正常io流程图"><strong>2.1 正常IO流程图</strong><a href="#21-正常io流程图" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="img" src="/assets/images/v2-26d01aef9118a65d1584307712989517_720w-d8412dda73f354589745fb0d73627a98.webp" width="700" height="346" class="img_ev3q"></p><p>步骤：</p><ol><li>client 创建cluster handler。</li><li>client 读取配置文件。</li><li>client 连接上monitor，获取集群map信息。</li><li>client 读写io 根据crshmap 算法请求对应的主osd数据节点。</li><li>主osd数据节点同时写入另外两个副本节点数据。</li><li>等待主节点以及另外两个副本节点写完数据状态。</li><li>主节点及副本节点写入状态都成功后，返回给client，io写入完成。</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="22-新主io流程图"><strong>2.2 新主IO流程图</strong><a href="#22-新主io流程图" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>说明：</p><p>如果新加入的OSD1取代了原有的 OSD4成为 Primary OSD, 由于 OSD1 上未创建 PG , 不存在数据，那么 PG 上的 I/O 无法进行，怎样工作的呢？</p><p><img loading="lazy" alt="img" src="/assets/images/v2-9043345f43ad2aed2a95129557cfd628_720w-f64f1d8e2ee28b6295b66db1914b73d0.webp" width="700" height="349" class="img_ev3q"></p><p>步骤：</p><ol><li>client连接monitor获取集群map信息。</li><li>同时新主osd1由于没有pg数据会主动上报monitor告知让osd2临时接替为主。</li><li>临时主osd2会把数据全量同步给新主osd1。</li><li>client IO读写直接连接临时主osd2进行读写。</li><li>osd2收到读写io，同时写入另外两副本节点。</li><li>等待osd2以及另外两副本写入成功。</li><li>osd2三份数据都写入成功返回给client, 此时client io读写完毕。</li><li>如果osd1数据同步完毕，临时主osd2会交出主角色。</li><li>osd1成为主节点，osd2变成副本。</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="23-ceph-io算法流程"><strong>2.3 Ceph IO算法流程</strong><a href="#23-ceph-io算法流程" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="img" src="/assets/images/v2-8d44a37ae741452c401786e5d6cb08a4_720w-3b85a7655a4e88fe54382e80b8ccf49f.webp" width="700" height="426" class="img_ev3q"></p><ol><li>File用户需要读写的文件。File-&gt;Object映射：</li></ol><p>​		a.  ino (File的元数据，File的唯一id)。
​		b.  ono(File切分产生的某个object的序号，默认以4M切分一个块大小)。
​		c.  oid(object id: ino + ono)。</p><ol start="2"><li>Object是RADOS需要的对象。Ceph指定一个静态hash函数计算oid的值，将oid映射成一个近似均匀分布的伪随机值，然后和mask按位相与，得到pgid。Object-&gt;PG映射：</li></ol><p>​		a. hash(oid) &amp; mask-&gt; pgid 。
​		b. mask = PG总数m(m为2的整数幂)-1 。</p><ol start="3"><li>PG(Placement Group),用途是对object的存储进行组织和位置映射, (类似于redis cluster里面的slot的概念) 一个PG里面会有很多object。采用CRUSH算法，将pgid代入其中，然后得到一组OSD。PG-&gt;OSD映射：</li></ol><p>​		a. CRUSH(pgid)-&gt;(osd1,osd2,osd3) 。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="24-ceph-io伪代码流程"><strong>2.4 Ceph IO伪代码流程</strong><a href="#24-ceph-io伪代码流程" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">locator = object_name</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">obj_hash =  hash(locator)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">pg = obj_hash % num_pg</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">osds_for_pg = crush(pg)    # returns a list of osdsprimary = osds_for_pg[0]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">replicas = osds_for_pg[1:]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="25-ceph-rbd-io流程"><strong>2.5 Ceph RBD IO流程</strong><a href="#25-ceph-rbd-io流程" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="img" src="/assets/images/v2-6910d551c6c63cde34b2a8a66c1690ec_720w-0997bc5642a131803a1046e8dcc7da53.webp" width="700" height="669" class="img_ev3q"></p><p>步骤：</p><ol><li><p>客户端创建一个pool，需要为这个pool指定pg的数量。</p></li><li><p>建pool/image rbd设备进行挂载。</p></li><li><p>用户写入的数据进行切块，每个块的大小默认为4M，并且每个块都有一个名字，名字就是object+序号。</p></li><li><p>将每个object通过pg进行副本位置的分配。</p></li><li><p>pg根据cursh算法会寻找3个osd，把这个object分别保存在这三个osd上。</p></li><li><p>osd上实际是把底层的disk进行了格式化操作，一般部署工具会将它格式化为xfs文件系统。</p></li><li><p>object的存储就变成了存储一个文rbd0.object1.file。</p></li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="26-ceph-rbd-io框架图"><strong>2.6 Ceph RBD IO框架图</strong><a href="#26-ceph-rbd-io框架图" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="img" src="/assets/images/v2-6969bdd994bbb3e6f296beeaca24449d_720w-9557791c7b7d5af62467b6256296e329.webp" width="467" height="867" class="img_ev3q"></p><p>客户端写数据osd过程：</p><ol><li><p>采用的是librbd的形式，使用librbd创建一个块设备，向这个块设备中写入数据。</p></li><li><p>在客户端本地同过调用librados接口，然后经过pool，rbd，object、pg进行层层映射,在PG这一层中，可以知道数据保存在哪3个OSD上，这3个OSD分为主从的关系。</p></li><li><p>客户端与primay OSD建立SOCKET 通信，将要写入的数据传给primary OSD，由primary OSD再将数据发送给其他replica OSD数据节点。</p></li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="27-ceph-pool和pg分布情况"><strong>2.7 Ceph Pool和PG分布情况</strong><a href="#27-ceph-pool和pg分布情况" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="img" src="/assets/images/v2-1606da46a6ca0f51783194a529a8b4dc_720w-ce576cfdcbc19ee1dded9f41d284ef34.webp" width="700" height="348" class="img_ev3q"></p><p>说明：</p><ul><li>pool是ceph存储数据时的逻辑分区，它起到namespace的作用。</li><li>每个pool包含一定数量(可配置)的PG。</li><li>PG里的对象被映射到不同的Object上。</li><li>pool是分布到整个集群的。</li><li>pool可以做故障隔离域，根据不同的用户场景不一进行隔离。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="28-ceph-数据扩容pg分布"><strong>2.8 Ceph 数据扩容PG分布</strong><a href="#28-ceph-数据扩容pg分布" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>场景数据迁移流程：</p><ul><li>现状3个OSD, 4个PG</li><li>扩容到4个OSD, 4个PG</li></ul><p>现状：</p><p><img loading="lazy" alt="img" src="/assets/images/v2-8958fcca478d852b78b03c2bb7b2d792_720w-da5d4392eaed2b78fbbe09b9401218ca.webp" width="700" height="170" class="img_ev3q"></p><p>扩容后：</p><p><img loading="lazy" alt="img" src="/assets/images/v2-29e33168cc598934817f7997932b0dcb_720w-1fbb3e8471a54a5edd72949821434c99.webp" width="700" height="118" class="img_ev3q"></p><p>说明</p><p>每个OSD上分布很多PG, 并且每个PG会自动散落在不同的OSD上。如果扩容那么相应的PG会进行迁移到新的OSD上，保证PG数量的均衡。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3-ceph心跳机制"><strong>3. Ceph心跳机制</strong><a href="#3-ceph心跳机制" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="31-心跳介绍"><strong>3.1 心跳介绍</strong><a href="#31-心跳介绍" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>心跳是用于节点间检测对方是否故障的，以便及时发现故障节点进入相应的故障处理流程。</p><p>问题：</p><ul><li>故障检测时间和心跳报文带来的负载之间做权衡。</li><li>心跳频率太高则过多的心跳报文会影响系统性能。</li><li>心跳频率过低则会延长发现故障节点的时间，从而影响系统的可用性。</li></ul><p>故障检测策略应该能够做到：</p><ul><li>及时：节点发生异常如宕机或网络中断时，集群可以在可接受的时间范围内感知。</li><li>适当的压力：包括对节点的压力，和对网络的压力。</li><li>容忍网络抖动：网络偶尔延迟。</li><li>扩散机制：节点存活状态改变导致的元信息变化需要通过某种机制扩散到整个集群。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="32-ceph-心跳检测"><strong>3.2 Ceph 心跳检测</strong><a href="#32-ceph-心跳检测" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="img" src="/assets/images/v2-5992d7bdfb5f2a723e3af5b9cc1f36d3_720w-49ca695104bab6ecd39d63667222c8b6.webp" width="700" height="315" class="img_ev3q"></p><p>OSD节点会监听public、cluster、front和back四个端口</p><ul><li>public端口：监听来自Monitor和Client的连接。</li><li>cluster端口：监听来自OSD Peer的连接。</li><li>front端口：供客户端连接集群使用的网卡, 这里临时给集群内部之间进行心跳。</li><li>back端口：供客集群内部使用的网卡。集群内部之间进行心跳。</li><li>hbclient：发送ping心跳的messenger。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="33-ceph-osd之间相互心跳检测"><strong>3.3 Ceph OSD之间相互心跳检测</strong><a href="#33-ceph-osd之间相互心跳检测" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="img" src="/assets/images/v2-5ffb3557276b420b1d7eb9b25dfa7d16_720w-773b4bbed0cb100a2e6e7ab18e9855e7.webp" width="700" height="511" class="img_ev3q"></p><p>步骤：</p><ul><li>同一个PG内OSD互相心跳，他们互相发送PING/PONG信息。</li><li>每隔6s检测一次(实际会在这个基础上加一个随机时间来避免峰值)。</li><li>20s没有检测到心跳回复，加入failure队列。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="34-ceph-osd与mon心跳检测"><strong>3.4 Ceph OSD与Mon心跳检测</strong><a href="#34-ceph-osd与mon心跳检测" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="img" src="/assets/images/v2-d152de7aa24f078453498330e78473e1_720w-fb8409ec4aff81d624348ed3b6031509.webp" width="700" height="528" class="img_ev3q"></p><p>OSD报告给Monitor：</p><ul><li><p>OSD有事件发生时（比如故障、PG变更）。</p></li><li><p>自身启动5秒内。</p></li><li><p>OSD周期性的上报给Monito</p></li><li><ul><li>OSD检查failure_queue中的伙伴OSD失败信息。</li><li>向Monitor发送失效报告，并将失败信息加入failure_pending队列，然后将其从failure_queue移除。</li><li>收到来自failure_queue或者failure_pending中的OSD的心跳时，将其从两个队列中移除，并告知Monitor取消之前的失效报告。</li><li>当发生与Monitor网络重连时，会将failure_pending中的错误报告加回到failure_queue中，并再次发送给Monitor。</li></ul></li><li><p>Monitor统计下线OSD</p></li><li><ul><li>Monitor收集来自OSD的伙伴失效报告。</li><li>当错误报告指向的OSD失效超过一定阈值，且有足够多的OSD报告其失效时，将该OSD下线。</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="35-ceph心跳检测总结"><strong>3.5 Ceph心跳检测总结</strong><a href="#35-ceph心跳检测总结" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>Ceph通过伙伴OSD汇报失效节点和Monitor统计来自OSD的心跳两种方式判定OSD节点失效。</p><ul><li><p>及时：伙伴OSD可以在秒级发现节点失效并汇报Monitor，并在几分钟内由Monitor将失效OSD下线。</p></li><li><p>适当的压力：由于有伙伴OSD汇报机制，Monitor与OSD之间的心跳统计更像是一种保险措施，因此OSD向Monitor发送心跳的间隔可以长达600秒，Monitor的检测阈值也可以长达900秒。Ceph实际上是将故障检测过程中中心节点的压力分散到所有的OSD上，以此提高中心节点Monitor的可靠性，进而提高整个集群的可扩展性。</p></li><li><p>容忍网络抖动：Monitor收到OSD对其伙伴OSD的汇报后，并没有马上将目标OSD下线，而是周期性的等待几个条件：</p></li><li><ul><li>目标OSD的失效时间大于通过固定量osd_heartbeat_grace和历史网络条件动态确定的阈值。</li><li>来自不同主机的汇报达到mon_osd_min_down_reporters。</li><li>满足前两个条件前失效汇报没有被源OSD取消。</li></ul></li><li><p>扩散：作为中心节点的Monitor并没有在更新OSDMap后尝试广播通知所有的OSD和Client，而是惰性的等待OSD和Client来获取。以此来减少Monitor压力并简化交互逻辑。</p></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4-ceph通信框架"><strong>4. Ceph通信框架</strong><a href="#4-ceph通信框架" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="41-ceph通信框架种类介绍"><strong>4.1 Ceph通信框架种类介绍</strong><a href="#41-ceph通信框架种类介绍" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>网络通信框架三种不同的实现方式：</p><ul><li>Simple线程模式
特点：每一个网络链接，都会创建两个线程，一个用于接收，一个用于发送。
缺点：大量的链接会产生大量的线程，会消耗CPU资源，影响性能。</li><li>Async事件的I/O多路复用模式
特点：这种是目前网络通信中广泛采用的方式。k版默认已经使用Asnyc了。</li><li>XIO方式使用了开源的网络通信库accelio来实现
特点：这种方式需要依赖第三方的库accelio稳定性，目前处于试验阶段。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="42-ceph通信框架设计模式"><strong>4.2 Ceph通信框架设计模式</strong><a href="#42-ceph通信框架设计模式" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>设计模式(Subscribe/Publish)：</p><p>订阅发布模式又名观察者模式，它意图是“定义对象间的一种一对多的依赖关系，
当一个对象的状态发生改变时，所有依赖于它的对象都得到通知并被自动更新”。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="43-ceph通信框架流程图"><strong>4.3 Ceph通信框架流程图</strong><a href="#43-ceph通信框架流程图" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="img" src="/assets/images/v2-7d78ef94a18205602ca65600eca95992_720w-11e7c3d4c94ee932de888f5cc912104f.webp" width="700" height="310" class="img_ev3q"></p><p>步骤：</p><ul><li><p>Accepter监听peer的请求, 调用 SimpleMessenger::add_accept_pipe() 创建新的 Pipe 到 SimpleMessenger::pipes 来处理该请求。</p></li><li><p>Pipe用于消息的读取和发送。该类主要有两个组件，Pipe::Reader，Pipe::Writer用来处理消息读取和发送。</p></li><li><p>Messenger作为消息的发布者, 各个 Dispatcher 子类作为消息的订阅者, Messenger 收到消息之后， 通过 Pipe 读取消息，然后转给 Dispatcher 处理。</p></li><li><p>Dispatcher是订阅者的基类，具体的订阅后端继承该类,初始化的时候通过 Messenger::add_dispatcher_tail/head 注册到 Messenger::dispatchers. 收到消息后，通知该类处理。</p></li><li><p>DispatchQueue该类用来缓存收到的消息, 然后唤醒 DispatchQueue::dispatch_thread 线程找到后端的 Dispatch 处理消息。</p></li></ul><p><img loading="lazy" alt="img" src="/assets/images/v2-654933261b88cf7179f1b405fb70ef02_720w-5220a709af76b478639e1caed5a2ae43.webp" width="700" height="459" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="44-ceph通信框架类图"><strong>4.4 Ceph通信框架类图</strong><a href="#44-ceph通信框架类图" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="img" src="/assets/images/v2-fe35ae53748c3b82cd0b3cb0bbb62d41_720w-aa43768ccd73ca18c48652edd9e33651.webp" width="700" height="407" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="45-ceph通信数据格式"><strong>4.5 Ceph通信数据格式</strong><a href="#45-ceph通信数据格式" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>通信协议格式需要双方约定数据格式。</p><p>消息的内容主要分为三部分：</p><ul><li><p>header //消息头，类型消息的信封</p></li><li><p>user data //需要发送的实际数据</p></li><li><ul><li>payload //操作保存元数据</li><li>middle //预留字段</li><li>data //读写数据</li></ul></li><li><p>footer //消息的结束标记</p></li></ul><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">class Message </span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> public RefCountedObject </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">protected</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  ceph_msg_header  header</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">      </span><span class="token comment" style="color:rgb(0, 128, 0)">// 消息头</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  ceph_msg_footer  footer</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">      </span><span class="token comment" style="color:rgb(0, 128, 0)">// 消息尾</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  bufferlist       payload</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)">// &quot;front&quot; unaligned blob</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  bufferlist       middle</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">   </span><span class="token comment" style="color:rgb(0, 128, 0)">// &quot;middle&quot; unaligned blob</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  bufferlist       data</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">     </span><span class="token comment" style="color:rgb(0, 128, 0)">// data payload (page-alignment will be preserved where possible)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)">/* recv_stamp is set when the Messenger starts reading the</span><br></span><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)">   * Message off the wire */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token class-name" style="color:rgb(38, 127, 153)">utime_t</span><span class="token plain"> recv_stamp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">       </span><span class="token comment" style="color:rgb(0, 128, 0)">//开始接收数据的时间戳</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)">/* dispatch_stamp is set when the Messenger starts calling dispatch() on</span><br></span><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)">   * its endpoints */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token class-name" style="color:rgb(38, 127, 153)">utime_t</span><span class="token plain"> dispatch_stamp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">   </span><span class="token comment" style="color:rgb(0, 128, 0)">//dispatch 的时间戳</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)">/* throttle_stamp is the point at which we got throttle */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token class-name" style="color:rgb(38, 127, 153)">utime_t</span><span class="token plain"> throttle_stamp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">   </span><span class="token comment" style="color:rgb(0, 128, 0)">//获取throttle 的slot的时间戳</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)">/* time at which message was fully read */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token class-name" style="color:rgb(38, 127, 153)">utime_t</span><span class="token plain"> recv_complete_stamp</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)">//接收完成的时间戳</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  ConnectionRef connection</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">     </span><span class="token comment" style="color:rgb(0, 128, 0)">//网络连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token class-name" style="color:rgb(38, 127, 153)">uint32_t</span><span class="token plain"> magic </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">           </span><span class="token comment" style="color:rgb(0, 128, 0)">//消息的魔术字</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  bi</span><span class="token operator" style="color:rgb(0, 0, 0)">::</span><span class="token plain">list_member_hook</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> dispatch_q</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">//boost::intrusive 成员字段</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(38, 127, 153)">ceph_msg_header</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    __le64 seq</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">       </span><span class="token comment" style="color:rgb(0, 128, 0)">// 当前session内 消息的唯一 序号</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    __le64 tid</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">       </span><span class="token comment" style="color:rgb(0, 128, 0)">// 消息的全局唯一的 id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    __le16 type</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">      </span><span class="token comment" style="color:rgb(0, 128, 0)">// 消息类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    __le16 priority</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)">// 优先级</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    __le16 version</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">   </span><span class="token comment" style="color:rgb(0, 128, 0)">// 版本号</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    __le32 front_len</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)">// payload 的长度</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    __le32 middle_len</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token comment" style="color:rgb(0, 128, 0)">// middle 的长度</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    __le32 data_len</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)">// data 的 长度</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    __le16 data_off</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)">// 对象的数据偏移量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(38, 127, 153)">ceph_entity_name</span><span class="token plain"> src</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)">//消息源</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">/* oldest code we think can decode this.  unknown if zero. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    __le16 compat_version</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    __le16 reserved</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    __le32 crc</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">       </span><span class="token comment" style="color:rgb(0, 128, 0)">/* header crc32c */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">__attribute__</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">packed</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(38, 127, 153)">ceph_msg_footer</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    __le32 front_crc</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> middle_crc</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> data_crc</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)">//crc校验码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    __le64  sig</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)">//消息的64位signature</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    __u8 flags</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)">//结束标志</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">__attribute__</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">packed</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5-ceph-crush算法"><strong>5. Ceph CRUSH算法</strong><a href="#5-ceph-crush算法" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="51-数据分布算法挑战"><strong>5.1 数据分布算法挑战</strong><a href="#51-数据分布算法挑战" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><ul><li>数据分布和负载均衡：
a. 数据分布均衡，使数据能均匀的分布到各个节点上。
b. 负载均衡，使数据访问读写操作的负载在各个节点和磁盘的负载均衡。</li><li>灵活应对集群伸缩
a. 系统可以方便的增加或者删除节点设备，并且对节点失效进行处理。
b. 增加或者删除节点设备后，能自动实现数据的均衡，并且尽可能少的迁移数据。</li><li>支持大规模集群
a. 要求数据分布算法维护的元数据相对较小，并且计算量不能太大。随着集群规模的增 加，数据分布算法开销相对比较小。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="52-ceph-crush算法说明"><strong>5.2 Ceph CRUSH算法说明</strong><a href="#52-ceph-crush算法说明" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><ul><li><p>CRUSH算法的全称为：Controlled Scalable Decentralized Placement of Replicated Data，可控的、可扩展的、分布式的副本数据放置算法。</p></li><li><p>pg到OSD的映射的过程算法叫做CRUSH 算法。(一个Object需要保存三个副本，也就是需要保存在三个osd上)。</p></li><li><p>CRUSH算法是一个伪随机的过程，他可以从所有的OSD中，随机性选择一个OSD集合，但是同一个PG每次随机选择的结果是不变的，也就是映射的OSD集合是固定的。</p></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="53-ceph-crush算法原理"><strong>5.3 Ceph CRUSH算法原理</strong><a href="#53-ceph-crush算法原理" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>CRUSH算法因子：</p><ul><li><p>层次化的Cluster Map
反映了存储系统层级的物理拓扑结构。定义了OSD集群具有层级关系的 静态拓扑结构。OSD层级使得 CRUSH算法在选择OSD时实现了机架感知能力，也就是通过规则定义， 使得副本可以分布在不同的机 架、不同的机房中、提供数据的安全性 。</p></li><li><p>Placement Rules
决定了一个PG的对象副本如何选择的规则，通过这些可以自己设定规则，用户可以自定义设置副本在集群中的分布。</p></li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="531-层级化的cluster-map"><strong>5.3.1 层级化的Cluster Map</strong><a href="#531-层级化的cluster-map" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h4><p><img loading="lazy" alt="img" src="/assets/images/v2-2c45752b2ec773caddeaef9377b590a9_720w-1191dd3c92ea1afb8b73b30b43c1d289.webp" width="700" height="520" class="img_ev3q"></p><p>CRUSH Map是一个树形结构，OSDMap更多记录的是OSDMap的属性(epoch/fsid/pool信息以及osd的ip等等)。</p><p>叶子节点是device（也就是osd），其他的节点称为bucket节点，这些bucket都是虚构的节点，可以根据物理结构进行抽象，当然树形结构只有一个最终的根节点称之为root节点，中间虚拟的bucket节点可以是数据中心抽象、机房抽象、机架抽象、主机抽象等。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="532-数据分布策略placement-rules"><em>5.3.2 数据分布策略Placement Rules</em><a href="#532-数据分布策略placement-rules" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h4><p>数据分布策略Placement Rules主要有特点：</p><p>a. 从CRUSH Map中的哪个节点开始查找
b. 使用那个节点作为故障隔离域
c. 定位副本的搜索模式（广度优先 or 深度优先）</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">rule replicated_ruleset  #规则集的命名，创建pool时可以指定rule集</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">{</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ruleset 0                #rules集的编号，顺序编即可   </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    type replicated          #定义pool类型为replicated(还有erasure模式)   </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    min_size 1                #pool中最小指定的副本数量不能小1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    max_size 10               #pool中最大指定的副本数量不能大于10       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    step take default         #查找bucket入口点，一般是root类型的bucket    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    step chooseleaf  firstn  0  type  host #选择一个host,并递归选择叶子节点osd     </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    step emit        #结束</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="533-bucket随机算法类型"><em>5.3.3 Bucket随机算法类型</em><a href="#533-bucket随机算法类型" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h4><p><img loading="lazy" alt="img" src="/assets/images/v2-615356cbccbdfdeb73747b6c436d0e34_720w-a1dfc0cf604a01b340dc86fc52ae6cb7.webp" width="700" height="410" class="img_ev3q"></p><ul><li><p>一般的buckets：适合所有子节点权重相同，而且很少添加删除item。</p></li><li><p>list buckets：适用于集群扩展类型。增加item，产生最优的数据移动，查找item，时间复杂度O(n)。</p></li><li><p>tree buckets：查找负责度是O (log n), 添加删除叶子节点时，其他节点node_id不变。</p></li><li><p>straw buckets：允许所有项通过类似抽签的方式来与其他项公平“竞争”。定位副本时，bucket中的每一项都对应一个随机长度的straw，且拥有最长长度的straw会获得胜利（被选中），添加或者重新计算，子树之间的数据移动提供最优的解决方案。</p></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="54-crush算法案例"><strong>5.4 CRUSH算法案例</strong><a href="#54-crush算法案例" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>说明：</p><p>集群中有部分sas和ssd磁盘，现在有个业务线性能及可用性优先级高于其他业务线，能否让这个高优业务线的数据都存放在ssd磁盘上。</p><p>普通用户：</p><p><img loading="lazy" alt="img" src="/assets/images/v2-ba80b1d9c1c2aa22cd91b09fd3abe73f_720w-9d5dd4a44344b4c348d31a9103199996.webp" width="700" height="296" class="img_ev3q"></p><p>高优用户：</p><p><img loading="lazy" alt="img" src="data:image/webp;base64,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" width="700" height="297" class="img_ev3q"></p><p>配置规则：</p><p><img loading="lazy" alt="img" src="/assets/images/v2-3fef8dc3ffa10ea502554b88c836792a_720w-a69073894245fdff78ea6ab60ffa72ac.webp" width="700" height="390" class="img_ev3q"></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="6-定制化ceph-rbd-qos"><strong>6. 定制化Ceph RBD QOS</strong><a href="#6-定制化ceph-rbd-qos" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="61-qos介绍"><strong>6.1 QOS介绍</strong><a href="#61-qos介绍" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p>QoS （Quality of Service，服务质量）起源于网络技术，它用来解决网络延迟和阻塞等问题，能够为指定的网络通信提供更好的服务能力。</p><p>问题：</p><p>我们总的Ceph集群的iIO能力是有限的，比如带宽，IOPS。如何避免用户争取资源，如果保证集群所有用户资源的高可用性，以及如何保证高优用户资源的可用性。所以我们需要把有限的IO能力合理分配。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="62-ceph-io操作类型"><strong>6.2 Ceph IO操作类型</strong><a href="#62-ceph-io操作类型" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><ul><li><p>ClientOp：来自客户端的读写I/O请求。</p></li><li><p>SubOp：osd之间的I/O请求。主要包括由客户端I/O产生的副本间数据读写请求，以及由数据同步、数据扫描、负载均衡等引起的I/O请求。</p></li><li><p>SnapTrim：快照数据删除。从客户端发送快照删除命令后，删除相关元数据便直接返回，之后由后台线程删除真实的快照数据。通过控制snaptrim的速率间接控制删除速率。</p></li><li><p>Scrub：用于发现对象的静默数据错误，扫描元数据的Scrub和对象整体扫描的deep Scrub。</p></li><li><p>Recovery：数据恢复和迁移。集群扩/缩容、osd失效/从新加入等过程。</p></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="63-ceph-官方qos原理"><strong>6.3 Ceph 官方QOS原理</strong><a href="#63-ceph-官方qos原理" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><p><img loading="lazy" alt="img" src="/assets/images/v2-d4626ee848ffe4bfdbdc19ce4c6c3a5f_720w-871d0d28c38397a6c068739e35952313.webp" width="700" height="256" class="img_ev3q"></p><p>mClock是一种基于时间标签的I/O调度算法，最先被Vmware提出来的用于集中式管理的存储系统。(目前官方QOS模块属于半成品)。</p><p>基本思想：</p><ul><li>reservation 预留，表示客户端获得的最低I/O资源。</li><li>weight 权重，表示客户端所占共享I/O资源的比重。</li><li>limit 上限，表示客户端可获得的最高I/O资源。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="64-定制化qos原理"><strong>6.4 定制化QOS原理</strong><a href="#64-定制化qos原理" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="641-令牌桶算法介绍"><em>6.4.1 令牌桶算法介绍</em><a href="#641-令牌桶算法介绍" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h4><p><img loading="lazy" alt="img" src="data:image/webp;base64,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" width="700" height="373" class="img_ev3q"></p><p>基于令牌桶算法(TokenBucket)实现了一套简单有效的qos功能，满足了云平台用户的核心需求。</p><p>基本思想：</p><ul><li><p>按特定的速率向令牌桶投放令牌。</p></li><li><p>根据预设的匹配规则先对报文进行分类，不符合匹配规则的报文不需要经过令牌桶的处理，直接发送。</p></li><li><p>符合匹配规则的报文，则需要令牌桶进行处理。当桶中有足够的令牌则报文可以被继续发送下去，同时令牌桶中的令牌量按报文的长度做相应的减少。</p></li><li><p>当令牌桶中的令牌不足时，报文将不能被发送，只有等到桶中生成了新的令牌，报文才可以发送。这就可以限制报文的流量只能是小于等于令牌生成的速度，达到限制流量的目的。</p></li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="642-rbd令牌桶算法流程"><em>6.4.2 RBD令牌桶算法流程</em><a href="#642-rbd令牌桶算法流程" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h4><p><img loading="lazy" alt="img" src="/assets/images/v2-46eaf451416e4e50134a27841f93211d_720w-31aaa1074f6fa4fd55321f7db91c4c56.webp" width="700" height="360" class="img_ev3q"></p><p>步骤：</p><ul><li>用户发起请求异步IO到达Image中。</li><li>请求到达ImageRequestWQ队列中。</li><li>在ImageRequestWQ出队列的时候加入令牌桶算法TokenBucket。</li><li>通过令牌桶算法进行限速，然后发送给ImageRequest进行处理。</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="643-rbd令牌桶算法框架图"><em>6.4.3 RBD令牌桶算法框架图</em><a href="#643-rbd令牌桶算法框架图" class="hash-link" aria-label="标题的直接链接" title="标题的直接链接">​</a></h4><p>现有框架图：</p><p><img loading="lazy" alt="img" src="/assets/images/v2-667926a27a61f7e2f3b0b38e822a3400_720w-ec4fe4f9ccdf69b077a50ce8ef4bca65.webp" width="700" height="622" class="img_ev3q"></p><p>令牌图算法框架图：</p><p><img loading="lazy" alt="img" src="/assets/images/v2-df8c51b5a4921e18e2d9cfe038379ed1_720w-b6a3c4ed14ae0d27e8af93d9a2b93e24.webp" width="700" height="623" class="img_ev3q"></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/category/存储"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">存储</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/skill/storage-ceph-2"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">02. Cephadm在麒麟V10搭建ceph集群</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-ceph架构简介及使用场景介绍" class="table-of-contents__link toc-highlight"><strong>1. Ceph架构简介及使用场景介绍</strong></a><ul><li><a href="#11-ceph简介" class="table-of-contents__link toc-highlight"><strong>1.1 Ceph简介</strong></a></li><li><a href="#12-ceph特点" class="table-of-contents__link toc-highlight"><strong>1.2 Ceph特点</strong></a></li><li><a href="#13-ceph架构" class="table-of-contents__link toc-highlight"><strong>1.3 Ceph架构</strong></a></li><li><a href="#14-ceph核心组件及概念介绍" class="table-of-contents__link toc-highlight"><strong>1.4 Ceph核心组件及概念介绍</strong></a></li><li><a href="#15-三种存储类型-块存储" class="table-of-contents__link toc-highlight"><strong>1.5 三种存储类型-块存储</strong></a></li><li><a href="#16-三种存储类型-文件存储" class="table-of-contents__link toc-highlight"><strong>1.6 三种存储类型-文件存储</strong></a></li><li><a href="#17-三种存储类型-对象存储" class="table-of-contents__link toc-highlight"><strong>1.7 三种存储类型-对象存储</strong></a></li></ul></li><li><a href="#2-ceph-io流程及数据分布" class="table-of-contents__link toc-highlight"><strong>2. Ceph IO流程及数据分布</strong></a><ul><li><a href="#21-正常io流程图" class="table-of-contents__link toc-highlight"><strong>2.1 正常IO流程图</strong></a></li><li><a href="#22-新主io流程图" class="table-of-contents__link toc-highlight"><strong>2.2 新主IO流程图</strong></a></li><li><a href="#23-ceph-io算法流程" class="table-of-contents__link toc-highlight"><strong>2.3 Ceph IO算法流程</strong></a></li><li><a href="#24-ceph-io伪代码流程" class="table-of-contents__link toc-highlight"><strong>2.4 Ceph IO伪代码流程</strong></a></li><li><a href="#25-ceph-rbd-io流程" class="table-of-contents__link toc-highlight"><strong>2.5 Ceph RBD IO流程</strong></a></li><li><a href="#26-ceph-rbd-io框架图" class="table-of-contents__link toc-highlight"><strong>2.6 Ceph RBD IO框架图</strong></a></li><li><a href="#27-ceph-pool和pg分布情况" class="table-of-contents__link toc-highlight"><strong>2.7 Ceph Pool和PG分布情况</strong></a></li><li><a href="#28-ceph-数据扩容pg分布" class="table-of-contents__link toc-highlight"><strong>2.8 Ceph 数据扩容PG分布</strong></a></li></ul></li><li><a href="#3-ceph心跳机制" class="table-of-contents__link toc-highlight"><strong>3. Ceph心跳机制</strong></a><ul><li><a href="#31-心跳介绍" class="table-of-contents__link toc-highlight"><strong>3.1 心跳介绍</strong></a></li><li><a href="#32-ceph-心跳检测" class="table-of-contents__link toc-highlight"><strong>3.2 Ceph 心跳检测</strong></a></li><li><a href="#33-ceph-osd之间相互心跳检测" class="table-of-contents__link toc-highlight"><strong>3.3 Ceph OSD之间相互心跳检测</strong></a></li><li><a href="#34-ceph-osd与mon心跳检测" class="table-of-contents__link toc-highlight"><strong>3.4 Ceph OSD与Mon心跳检测</strong></a></li><li><a href="#35-ceph心跳检测总结" class="table-of-contents__link toc-highlight"><strong>3.5 Ceph心跳检测总结</strong></a></li></ul></li><li><a href="#4-ceph通信框架" class="table-of-contents__link toc-highlight"><strong>4. Ceph通信框架</strong></a><ul><li><a href="#41-ceph通信框架种类介绍" class="table-of-contents__link toc-highlight"><strong>4.1 Ceph通信框架种类介绍</strong></a></li><li><a href="#42-ceph通信框架设计模式" class="table-of-contents__link toc-highlight"><strong>4.2 Ceph通信框架设计模式</strong></a></li><li><a href="#43-ceph通信框架流程图" class="table-of-contents__link toc-highlight"><strong>4.3 Ceph通信框架流程图</strong></a></li><li><a href="#44-ceph通信框架类图" class="table-of-contents__link toc-highlight"><strong>4.4 Ceph通信框架类图</strong></a></li><li><a href="#45-ceph通信数据格式" class="table-of-contents__link toc-highlight"><strong>4.5 Ceph通信数据格式</strong></a></li></ul></li><li><a href="#5-ceph-crush算法" class="table-of-contents__link toc-highlight"><strong>5. Ceph CRUSH算法</strong></a><ul><li><a href="#51-数据分布算法挑战" class="table-of-contents__link toc-highlight"><strong>5.1 数据分布算法挑战</strong></a></li><li><a href="#52-ceph-crush算法说明" class="table-of-contents__link toc-highlight"><strong>5.2 Ceph CRUSH算法说明</strong></a></li><li><a href="#53-ceph-crush算法原理" class="table-of-contents__link toc-highlight"><strong>5.3 Ceph CRUSH算法原理</strong></a><ul><li><a href="#531-层级化的cluster-map" class="table-of-contents__link toc-highlight"><strong>5.3.1 层级化的Cluster Map</strong></a></li><li><a href="#532-数据分布策略placement-rules" class="table-of-contents__link toc-highlight"><em>5.3.2 数据分布策略Placement Rules</em></a></li><li><a href="#533-bucket随机算法类型" class="table-of-contents__link toc-highlight"><em>5.3.3 Bucket随机算法类型</em></a></li></ul></li><li><a href="#54-crush算法案例" class="table-of-contents__link toc-highlight"><strong>5.4 CRUSH算法案例</strong></a></li></ul></li><li><a href="#6-定制化ceph-rbd-qos" class="table-of-contents__link toc-highlight"><strong>6. 定制化Ceph RBD QOS</strong></a><ul><li><a href="#61-qos介绍" class="table-of-contents__link toc-highlight"><strong>6.1 QOS介绍</strong></a></li><li><a href="#62-ceph-io操作类型" class="table-of-contents__link toc-highlight"><strong>6.2 Ceph IO操作类型</strong></a></li><li><a href="#63-ceph-官方qos原理" class="table-of-contents__link toc-highlight"><strong>6.3 Ceph 官方QOS原理</strong></a></li><li><a href="#64-定制化qos原理" class="table-of-contents__link toc-highlight"><strong>6.4 定制化QOS原理</strong></a><ul><li><a href="#641-令牌桶算法介绍" class="table-of-contents__link toc-highlight"><em>6.4.1 令牌桶算法介绍</em></a></li><li><a href="#642-rbd令牌桶算法流程" class="table-of-contents__link toc-highlight"><em>6.4.2 RBD令牌桶算法流程</em></a></li><li><a href="#643-rbd令牌桶算法框架图" class="table-of-contents__link toc-highlight"><em>6.4.3 RBD令牌桶算法框架图</em></a></li></ul></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">笔记</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/category/存储">存储</a></li><li class="footer__item"><a class="footer__link-item" href="/tags">标签</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">归档</a></li><li class="footer__item"><a class="footer__link-item" href="/project">实战项目</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/linux">Linux</a></li></ul></div><div class="col footer__col"><div class="footer__title">社交媒体</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/about">关于我</a></li><li class="footer__item"><a href="https://github.com/zqingfa" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://juejin.cn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">掘金<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" position="right" href="/friends">友链</a></li><li class="footer__item"><a class="footer__link-item" position="right" href="/website">导航</a></li><li class="footer__item"><a href="https://docusaurus.io/zh-CN/" target="_blank"><img style="height:50px;margin-top:0.5rem" src="/img/buildwith.png"><a></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p><a href="http://beian.miit.gov.cn/">浙ICP备20024502号-1</a></p><p>Copyright © 2023 - PRESENT zhangqf Built with Docusaurus.</p></div></div></div></footer></div>
<script src="/assets/js/runtime~main.7dd3723b.js"></script>
<script src="/assets/js/main.389df9ef.js"></script>
</body>
</html>