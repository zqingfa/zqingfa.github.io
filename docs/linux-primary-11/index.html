<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-linux/primary/linux-primary-11">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">第 11 章 Linux 服务管理 - Linux技术分享</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://zhangqf.com/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://zhangqf.com/img/logo.png"><meta data-rh="true" property="og:url" content="https://zhangqf.com/docs/linux-primary-11"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="第 11 章 Linux 服务管理 - Linux技术分享"><meta data-rh="true" name="description" content="开篇前要先做一下说明，Centos 操作系统从 7.x 版本才开始支持 arm64 架构，也就是 Centos 6.x 及以前的版本都不支持 arm64 架构。Centos 7.x 和 Centos 6.x 管理服务的方式截然不同，而 Centos 7.x 又兼容 Centos 6.x 的服务管理方式，所以有必要都介绍一下，会用到 x86 架构的 centos 6.4。"><meta data-rh="true" property="og:description" content="开篇前要先做一下说明，Centos 操作系统从 7.x 版本才开始支持 arm64 架构，也就是 Centos 6.x 及以前的版本都不支持 arm64 架构。Centos 7.x 和 Centos 6.x 管理服务的方式截然不同，而 Centos 7.x 又兼容 Centos 6.x 的服务管理方式，所以有必要都介绍一下，会用到 x86 架构的 centos 6.4。"><meta data-rh="true" name="keywords" content="linux,Service"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://zhangqf.com/docs/linux-primary-11"><link data-rh="true" rel="alternate" href="https://zhangqf.com/en/docs/linux-primary-11" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/linux-primary-11" hreflang="zh"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/linux-primary-11" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9B0V5WT2X8-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S4SD5NXWXF"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S4SD5NXWXF",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Linux技术分享" href="/opensearch.xml">
<link rel="preconnect" href="https://zhangqf.com/">
<script>var _paq=window._paq=window._paq||[];_paq.push(["setRequestMethod","POST"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),_paq.push(["enableHeartBeatTimer"]),function(){var e="https://zhangqf.com/";_paq.push(["setRequestMethod","POST"]),_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]);var a=document,t=a.createElement("script"),p=a.getElementsByTagName("script")[0];t.type="text/javascript",t.async=!0,t.src=e+"matomo.js",p.parentNode.insertBefore(t,p)}()</script>


<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?77dc6b24cf1d939292e9fe13be271a96",e.defer=!0;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<meta name="baidu-site-verification" content="code-rqLUw5reVS">
<script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",t.defer=!0;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script>
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="zhangqf RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="zhangqf Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="zhangqf JSON Feed">

<link rel="icon" href="/img/logo.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(51 139 255)"><link rel="stylesheet" href="/assets/css/styles.86c9ae18.css">
<link rel="preload" href="/assets/js/runtime~main.6d616132.js" as="script">
<link rel="preload" href="/assets/js/main.26bbf6d2.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><span>更新 <a href="/website">网址导航</a> 带你发现感兴趣的技术</span></div><button type="button" aria-label="关闭" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">zhangqf</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/linux">Linux</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/category/Linux基础">Linux 基础</a></li><li><a class="dropdown__link" href="/docs/category/Linux进阶">Linux 进阶</a></li><li><a class="dropdown__link" href="/docs/category/Linux测试">Linux 测试</a></li><li><a class="dropdown__link" href="/docs/category/LinuxCICD">Linux CICD研发</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Blog</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tags">标签</a></li><li><a class="dropdown__link" href="/archive">归档</a></li></ul></div><a class="navbar__item navbar__link" href="/website">导航</a><a class="navbar__item navbar__link" href="/project">项目</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中文</a><ul class="dropdown__menu"><li><a href="/en/docs/linux-primary-11" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-GB">English</a></li><li><a href="/docs/linux-primary-11" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh">中文</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"><b>zhangqf</b></a><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/linux">linux</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/linux基础">Linux基础</a><button aria-label="打开/收起侧边栏菜单「Linux基础」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-1">第 1 章 Linux 基础命令</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-2">第 2 章 Linux 系统用户</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-3">第 3 章 Linux 文件权限</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-4">第 4 章 Linux ext 文件系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-5">第 5 章 Linux 磁盘管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-6">第 6 章 Linux LVM 存储管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-7">第 7 章 Linux Raid 存储管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-8">第 8 章 Linux 包管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-9">第 9 章 Linux 进程和信号</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-10">第 10 章 Linux 系统资源监控</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/linux-primary-11">第 11 章 Linux 服务管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-12">第 12 章 Linux 定时任务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-13">第 13 章 Linux 网络管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-primary-14">第 14 章 Linux 开机启动流程(UEFI+systemd)</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/linux进阶">Linux进阶</a><button aria-label="打开/收起侧边栏菜单「Linux进阶」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/linux测试">Linux测试</a><button aria-label="打开/收起侧边栏菜单「Linux测试」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/linuxcicd">Linux CICD研发</a><button aria-label="打开/收起侧边栏菜单「Linux CICD研发」" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/linux基础"><span itemprop="name">Linux基础</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">第 11 章 Linux 服务管理</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>第 11 章 Linux 服务管理</h1></header><p>开篇前要先做一下说明，Centos 操作系统从 7.x 版本才开始支持 arm64 架构，也就是 Centos 6.x 及以前的版本都不支持 arm64 架构。Centos 7.x 和 Centos 6.x 管理服务的方式截然不同，而 Centos 7.x 又兼容 Centos 6.x 的服务管理方式，所以有必要都介绍一下，会用到 x86 架构的 centos 6.4。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="111服务的概念">11.1、服务的概念<a class="hash-link" href="#111服务的概念" title="标题的直接链接">​</a></h2><p>服务是向外提供服务的进程，一般来说都会放在后台，既然要持续不断的提供外界随时发来的服务请求，服务进程就需要常驻在内存中，且不应该和终端有关，否则终端退出服务程序就退出了。</p><p>另外，要能够接待外界的请求为外界提供服务，那么就需要有个专属于这个服务的 &quot;服务窗口&quot;，这个服务窗口就是端口号，通过端口号就能找到服务的提供者。</p><p>提供服务的一端叫做服务端，向服务端请求服务的叫做客户端。两端的交互过程如下：</p><ol><li>服务端启动服务进程，此时将开放对应的端口号；</li><li>客户端指定服务端 IP 地址和端口号向该服务端发起请求；</li><li>服务端所在主机的内核接收到请求数据包，然后分析数据包发现请求的是某某端口号，内核知道该端口号是哪个应用程序监听的端口，所以将请求报文发送给对应的应用程序；</li><li>应用程序收到报文后，将和客户端建立连接，并进行数据传输。</li></ol><p><em>注意：并非所有服务都总是提供端口号的，例如 xinetd 这个服务，只有在需要的时候才接管相应的端口，如 rsync 监听端口为 222 时，那么请求 rsync 时，xinetd 在监听过程中的端口号就是 222。在不被请求的时候，xinetd 是没有端口号的。</em></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="112服务类型">11.2、服务类型<a class="hash-link" href="#112服务类型" title="标题的直接链接">​</a></h2><p>在 Linux 中，服务分为独立守护进程和超级守护进程。</p><ul><li>独立守护进程是自行监听在后台的，基本上所有的服务都是独立守护进程类的服务。</li><li>超级守护进程专指 xinetd 这个服务，这个服务代为管理着一些特殊的服务，这类服务在被请求的时候才会由 xinetd 通知它启动服务，服务提供完毕后就关闭服务，这类服务称为瞬时守护进程，即只存在于瞬时。<ul><li>但要明白，超级守护进程 xinetd 本身是一个常驻内存的独立守护进程，因为它要监听来自外界对其管理的瞬时守护进程的请求。</li><li>不过一般不工作的时候，xinetd 不占用端口号，在工作的时候它占用被请求的瞬时守护进程的端口号，并处于监听状态。</li></ul></li></ul><p><strong>在 11.2.X 这一小节将使用 x86 Centos 6.4 做所有实验，其它的没有做说明的都是使用 ARM64 架构的操作系统做所有实验。</strong></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1121独立守护进程">11.2.1、独立守护进程<a class="hash-link" href="#1121独立守护进程" title="标题的直接链接">​</a></h3><p>在 x86 CentOS 6.4 上，所有的服务脚本都在 /etc/rc.d/init.d/ 目录下，/etc/init.d/ 是它的软链接。在此目录下的脚本都是 LSB 风格的脚本，它们基本上都能接受 start/stop/restart/reload/status 等参数。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ls /etc/init.d/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">auditd            </span><span class="token function" style="color:rgb(0, 0, 255)">halt</span><span class="token plain">       lvm2-lvmetad  network      rsyslog    sshd</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">blk-availability  ip6tables  lvm2-monitor  postfix      sandbox    udev-post</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">crond             iptables   netconsole    rdisc        saslauthd</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">functions         </span><span class="token function" style="color:rgb(0, 0, 255)">killall</span><span class="token plain">    netfs         restorecond  single</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>要管理独立守护进程类的服务</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># /etc/init.d/service_name   restart|start|stop|status      # 方法一</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># service  service_name      restart|start|stop|status      # 方法二</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>要让服务能够被 service 命令管理，将其服务脚本放在 /etc/init.d 目录下即可。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1122xinetd-超级守护进程">11.2.2、xinetd 超级守护进程<a class="hash-link" href="#1122xinetd-超级守护进程" title="标题的直接链接">​</a></h3><p>xinetd 即 extended internet daemon，xinetd 是新一代的网络守护进程服务程序，又叫超级 Internet 服务器。经常用来管理多种轻量级 Internet 服务。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11221管理瞬时守护进程">11.2.2.1、管理瞬时守护进程<a class="hash-link" href="#11221管理瞬时守护进程" title="标题的直接链接">​</a></h4><p>该类服务不能直接使用 service 命令来启动。只能去 /etc/xinetd.d/ 目录下的对应文件中进行设置(当然，也可以在 /etc/xinetd.conf 中配置)，然后由 xinetd 进行管理。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 安装 xinetd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># yum install xinetd -y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 安装 rsync，默认归于 xinetd 成为瞬时守护进程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># yum install rsync -y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># chkconfig --list</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">xinetd          </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">:off   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">:off   </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">:off   </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain">:on    </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain">:on    </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">:on    </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain">:off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">xinetd based services:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    chargen-dgram:  off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    chargen-stream: off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    daytime-dgram:  off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    daytime-stream: off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    discard-dgram:  off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    discard-stream: off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    echo-dgram:     off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    echo-stream:    off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    rsync:          off </span><span class="token comment" style="color:rgb(0, 128, 0)"># 默认归于 xinetd 成为瞬时守护进程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    tcpmux-server:  off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    time-dgram:     off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    time-stream:    off</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>首先得保证 xinetd 是已经工作在后台的。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># service xinetd start</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Starting xinetd:                                           </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">  OK  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后管理瞬时守护进程，该类服务比较特别，其自启动状态和服务运行状态是同步的，也就是说 chkconfig 设置了其自启动则表示启动该服务，否则为停止该服务。</p><p>另外，对其指定级别是无效的，它们的启动级别继承于 xinetd 的启动级别，并且 xinetd 会接管其触发的瞬时守护进程的端口号。</p><p>例如启动 rsync 这个瞬时守护进程。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># chkconfig rsync on</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># chkconfig --list</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">xinetd          </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">:off   </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">:off   </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">:off   </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain">:on    </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain">:on    </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">:on    </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain">:off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">xinetd based services:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    chargen-dgram:  off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    chargen-stream: off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    daytime-dgram:  off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    daytime-stream: off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    discard-dgram:  off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    discard-stream: off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    echo-dgram:     off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    echo-stream:    off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    rsync:          on  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 已启动</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    tcpmux-server:  off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    time-dgram:     off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    time-stream:    off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11222瞬时守护进程的配置">11.2.2.2、瞬时守护进程的配置<a class="hash-link" href="#11222瞬时守护进程的配置" title="标题的直接链接">​</a></h4><p>瞬时守护进程关联三个配置文件，一个是 xinetd 的配置文件 /etc/xinetd.conf 提供默认配置；一个是 /etc/xinetd.d/ 下的配置文件针对对应的服务提供配置；最后一个 /etc/services，设置了 xinetd 下的 service 对应的端口号。</p><p>例如配置 rsync</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># /etc/xinetd.d/rsync 的默认配置。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /etc/xinetd.d/rsync</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># default: off    </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># description: The rsync server is a good addition to an ftp server, as it \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#       allows crc checksumming etc.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">service</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">rsync</span><span class="token plain">                               </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定义rsync服务，名称要和/etc/xinetd.d/下的文件同名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        disable         </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">yes</span><span class="token plain">               </span><span class="token comment" style="color:rgb(0, 128, 0)"># yes表示不启动，no表示启动，等价于chkconfig rsync {on|off}，所以这里设置后将直接在chkconfig中生效</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        flags           </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> IPv6              </span><span class="token comment" style="color:rgb(0, 128, 0)"># 不用管</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        socket_type     </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> stream            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 这代表的是tcp类型的套接字</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token function" style="color:rgb(0, 0, 255)">wait</span><span class="token plain">            </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> no                </span><span class="token comment" style="color:rgb(0, 128, 0)"># 该服务是单线程还是多线程的，yes表示该服务为单线程，xinetd只启动服务器不处理请求，服务器处理请求连接；no表示该服务为多线程，xinetd继续处理新服务请求并处理连接。一般udp为yes，tcp为no。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        user            </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> root              </span><span class="token comment" style="color:rgb(0, 128, 0)"># 以什么身份运行rsync</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server          </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /usr/bin/rsync    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 启动服务对应的二进制文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server_args     </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> --daemon          </span><span class="token comment" style="color:rgb(0, 128, 0)"># 服务程序启动时传递的参数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        log_on_failure  </span><span class="token operator" style="color:rgb(0, 0, 0)">+=</span><span class="token plain"> USERID           </span><span class="token comment" style="color:rgb(0, 128, 0)"># 连接失败的日志记录，+表示在全局对应的条目上新增此处指定的USERID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># /etc/services 定义 rsync 端口号</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># grep &quot;\&lt;rsync\&gt;&quot; /etc/services </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">rsync</span><span class="token plain">           </span><span class="token number" style="color:rgb(9, 134, 88)">873</span><span class="token plain">/tcp                         </span><span class="token comment" style="color:rgb(0, 128, 0)"># rsync</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">rsync</span><span class="token plain">           </span><span class="token number" style="color:rgb(9, 134, 88)">873</span><span class="token plain">/udp                         </span><span class="token comment" style="color:rgb(0, 128, 0)"># rsync</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># grep -v &quot;^#&quot; /etc/xinetd.conf </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">defaults</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    log_type    </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> SYSLOG daemon info            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 登录文件的记录服务类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    log_on_failure  </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> HOST                      </span><span class="token comment" style="color:rgb(0, 128, 0)"># 发生错误时需要记录的信息为主机 (HOST)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    log_on_success  </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> PID HOST DURATION EXIT    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 成功启动或登陆时的记录信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    cps     </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">50</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token plain">     </span><span class="token comment" style="color:rgb(0, 128, 0)"># 表示每秒50个入站连接，如果超过限制，则等待10秒。主要用于对付拒绝服务攻击。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    instances   </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">50</span><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 表示最大连接进程数为50个</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    per_source  </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 接受一个整数或“UNLIMITED”作为参数。指定每个源IP地址的最大服务实例数。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    v6only      </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> no    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 是否仅允许 IPv6 ？可以先暂时不启动 IPv6 支持！</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">groups</span><span class="token plain">      </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">yes</span><span class="token plain">   </span><span class="token comment" style="color:rgb(0, 128, 0)"># 如果groups属性被设置为“yes”，那么服务器执行时将访问服务器的有效UID所访问的组。或者，如果设置了group属性，则执行服务器并访问指定的组。如果将groups属性设置为“no”，则服务器不带补充组运行。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">umask</span><span class="token plain">       </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> 002   </span><span class="token comment" style="color:rgb(0, 128, 0)"># 这个选项可以在&quot;defaults&quot;部分设置，为所有服务设置一个umask。xinetd将自己的掩码设置为先前的掩码或022。如果没有使用umask选项，所有子进程将继承这个umask。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">includedir /etc/xinetd.d</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11223xinetd-守护-sshd">11.2.2.3、xinetd 守护 sshd<a class="hash-link" href="#11223xinetd-守护-sshd" title="标题的直接链接">​</a></h4><p>sshd 本身是个独立守护进程，为了增强 sshd 的功能，我们把 sshd 托管到 xinetd 下面，注意要先关闭 sshd 服务进程，并禁止开机自启，如果你是远程操作，请一定要把握操作顺序，并知道自己在干什么。</p><ol><li><p>关闭 sshd 服务，禁止开机自启</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># service sshd stop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># chkconfig sshd off</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>在 /etc/xinetd.d/ 目录下面创建 sshd 的配置文件，默认是没有的，手动创建</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /etc/xinetd.d/sshd </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">service</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">ssh</span><span class="token plain">                          </span><span class="token comment" style="color:rgb(0, 128, 0)"># 代表被托管服务的名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       disable </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> no             </span><span class="token comment" style="color:rgb(0, 128, 0)"># 是否禁用托管服务，no 表示开启托管服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       log_on_failure </span><span class="token operator" style="color:rgb(0, 0, 0)">+=</span><span class="token plain"> USERID </span><span class="token comment" style="color:rgb(0, 128, 0)"># 设置失败时，UID 添加到系统登记表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       socket_type </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> stream     </span><span class="token comment" style="color:rgb(0, 128, 0)"># socket连接方式，stream是tcp，dgram是udp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       cps </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">25</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">30</span><span class="token plain">                  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 每秒25个入站连接，如果超过限制，则等待30秒。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       protocol </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> tcp               </span><span class="token comment" style="color:rgb(0, 128, 0)"># 代表ssh走的是tcp协议连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       </span><span class="token function" style="color:rgb(0, 0, 255)">wait</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> no                    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 该服务是单线程还是多线程的，一般udp为yes，tcp为no</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       user </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> root                  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 以什么用户进行启动</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       server </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /usr/sbin/sshd      </span><span class="token comment" style="color:rgb(0, 128, 0)"># 被托管服务的二进制启动脚本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       server_args </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> -i         </span><span class="token comment" style="color:rgb(0, 128, 0)"># sshd 是独立守护进程，必须传入 -i 参数，否则无法被xinetd托管</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       server_args </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> -D </span><span class="token variable" style="color:rgb(9, 134, 88)">$OPTIONS</span><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 如果还要给server传参，该参数必须在 -i 参数下面，否则会出现连接闪退情况</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>xinetd 启动的服务们有一个与独立守护进程不兼容的特定接口，这些服务不能打开和监听套接字，它们必须通过 stdin/stdout 与客户端通信。<strong>需要指定 server<!-- -->_<!-- -->args = -i 传给独立守护进程，才能被 xinetd 托管</strong>。</li><li>socket<!-- -->_<!-- -->type 和 protocol 至少要有一个指定 tcp 协议，否则无法启动 sshd 服务。</li><li>这里的 /usr/sbin/sshd 二进制脚本启动时有自己的配置文件 /etc/ssh/sshd<!-- -->_<!-- -->config，也就是说 sshd 原有的功能是不变的。</li></ul></li><li><p>查看 sshd 22 号端口是否由 xinetd 托管</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># lsof -i :22</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">COMMAND  PID </span><span class="token environment constant" style="color:rgb(129, 31, 63)">USER</span><span class="token plain">   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sshd    </span><span class="token number" style="color:rgb(9, 134, 88)">1427</span><span class="token plain"> root    3r  IPv4  </span><span class="token number" style="color:rgb(9, 134, 88)">12622</span><span class="token plain">      0t0  TCP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.114.131:ssh-</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.114.1:60477 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">ESTABLISHED</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">xinetd  </span><span class="token number" style="color:rgb(9, 134, 88)">9959</span><span class="token plain"> root    5u  IPv6  </span><span class="token number" style="color:rgb(9, 134, 88)">24146</span><span class="token plain">      0t0  TCP *:ssh </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">LISTEN</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>在 /etc/xinetd.d/sshd 里面添加访问控制</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /etc/xinetd.d/sshd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">service</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">ssh</span><span class="token plain">                           </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       disable </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> no</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       log_on_failure </span><span class="token operator" style="color:rgb(0, 0, 0)">+=</span><span class="token plain"> USERID</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       cps </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">25</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       </span><span class="token function" style="color:rgb(0, 0, 255)">wait</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> no</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       user </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> root</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       protocol </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> tcp</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       server_args </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> -i</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       server_args </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> -D </span><span class="token variable" style="color:rgb(9, 134, 88)">$OPTIONS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       server </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /usr/sbin/sshd</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    only_from </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.114.0/24    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 表示允许114网段访问</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       no_access </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.1.128        </span><span class="token comment" style="color:rgb(0, 128, 0)"># 但是不允许128访问</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 测试，这台服务器地址就是 192.168.114.128</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@mysql ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ip -4 add | grep inet</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   inet </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1/8 scope </span><span class="token function" style="color:rgb(0, 0, 255)">host</span><span class="token plain"> lo</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   inet </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.114.128/24 brd </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.114.255 scope global dynamic ens32</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@mysql ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 试验成功，拒绝连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@mysql ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ssh 192.168.114.131</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ssh_exchange_identification: read: Connection reset by peer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@mysql ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>注释不要加在配置文件里面，我是为了说明意思，加在里面启动不了服务的。</li></ul></li><li><p>再添加多个控制</p><ul><li>控制这个服务最多只能 3 个连接，每个源 IP 只能 1 个连接</li><li>控制只能 9：00 到 18：00 才能 ssh 连接</li><li>指定日志记录到 /var/log/xinetd<!-- -->_<!-- -->ssh.log 里</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /etc/xinetd.d/sshd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">service</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">ssh</span><span class="token plain">                           </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       disable </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> no</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       log_on_failure </span><span class="token operator" style="color:rgb(0, 0, 0)">+=</span><span class="token plain"> USERID</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       cps </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">25</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       </span><span class="token function" style="color:rgb(0, 0, 255)">wait</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> no</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       user </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> root</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       protocol </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> tcp</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       server_args </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> -i</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       server_args </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> -D </span><span class="token variable" style="color:rgb(9, 134, 88)">$OPTIONS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       server </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /usr/sbin/sshd</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    only_from </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.114.0/24</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       no_access </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.114.128</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    instances </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain">                               </span><span class="token comment" style="color:rgb(0, 128, 0)"># 最大连接数为3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       per_source </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">                               </span><span class="token comment" style="color:rgb(0, 128, 0)"># 每个源IP只能有1个连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       access_times </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">:00-18:00                    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 只能9：00到18：00才能ssh连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       log_type </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">file</span><span class="token plain"> /var/log/xinetd_ssh.log      </span><span class="token comment" style="color:rgb(0, 128, 0)"># 指定日志记录到/var/log/xinetd_ssh.log里</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@x86 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1123管理服务开机自启">11.2.3、管理服务开机自启<a class="hash-link" href="#1123管理服务开机自启" title="标题的直接链接">​</a></h3><p>chkconfig 命令能管理 /etc/init.d/ 目录下存在且脚本的内容满足一定条件的服务。</p><p>要能让 chkconfig 管理服务的开机是否自启动行为，只需将脚本放在 /etc/init.d 目录下，然后在脚本的前部加上 chkconfig 行和 description 行。如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># chkconfig: - 85 15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># description: The Apache HTTP Server is an efficient and extensible</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>这两行必须在所有非注释行的前面，且这两行必须得被&quot;注释&quot;。</li><li>其中 chkconfig 行 &quot;-&quot; 表示适用于运行级别 123456 上，85 表示开机启动时，它的启动顺序为 85，15 表示关机停止服务时，它的停止顺序为 15。description 行随便给一点描述信息就可以，但是必须得给 &quot;description:&quot; 关键字。</li></ul><p>然后，就可以有 chkconfig 来管理服务的开机自启动了。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">chkconfig</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">--add </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> --del</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">name</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 将/etc/init.d中可以被chkconfig管理的服务添加到chkconfig的管理列表中，或者从列表中删除</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">chkconfig</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">--list</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">         </span><span class="token comment" style="color:rgb(0, 128, 0)"># 列出指定名称的服务的开启自启动信息。name可以使用all来表示列出所有chkconfig管理列表中的服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">chkconfig</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">--level </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">levels</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">name</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">on</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">off</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">reset</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 将指定名称的服务在指定级别上打开开机自启动或关闭开机自启动功能。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                                    </span><span class="token comment" style="color:rgb(0, 128, 0)"># reset则表示重置为脚本中指定的级别</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当然，除了 chkconfig 可以管理开机自启动，将启动命令放在 /etc/rc.d/rc.local 文件中也是可以的。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="113systemd-服务">11.3、systemd 服务<a class="hash-link" href="#113systemd-服务" title="标题的直接链接">​</a></h2><p>下面会分一些子章节来介绍 systemd 服务，Linux 操作系统启动加载完内核后，启动第一个初代进程就是 systemd 进程。实际上从 centos 5、centos6 再到 centos 7 经历过 init、upstart 和 systemd 三个阶段，毫无疑问 systemd 作为初代进程是目前最好的选择。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1131初识-systemd">11.3.1、初识 systemd<a class="hash-link" href="#1131初识-systemd" title="标题的直接链接">​</a></h3><p>使用 systemd 做服务管理时，需要了解一些基本知识：</p><ol><li>了解 systemd 可管理哪些服务</li><li>了解 systemd 所管理服务的状态</li><li>了解 systemctl 管理服务的基本命令</li><li>学会编写、修改、看懂服务 Unit 配置文件</li></ol><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11311systemd-可管理哪些服务">11.3.1.1、systemd 可管理哪些服务<a class="hash-link" href="#11311systemd-可管理哪些服务" title="标题的直接链接">​</a></h4><p>操作系统使用 systemd 后，所有用户进程都是 systemd 的后代进程。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># pstree -ph | more</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">-+-agetty</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">804</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-agetty</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">16547</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-auditd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">747</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">---</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">auditd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">748</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-chronyd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">791</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-crond</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">784</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-dbus-daemon</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">775</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">---</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">dbus-daemon</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">777</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-firewalld</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">811</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">---</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">firewalld</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">950</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-irqbalance</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">773</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-master</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">1970</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">---qmgr</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">2002</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-polkitd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">780</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">-+-</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">polkitd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">805</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">              </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">polkitd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">806</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">              </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">polkitd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">807</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">              </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">polkitd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">808</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">              </span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token variable" style="color:rgb(9, 134, 88)">-</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token variable" style="color:rgb(9, 134, 88)">polkitd</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token variable number" style="color:rgb(9, 134, 88)">809</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token variable" style="color:rgb(9, 134, 88)"></span><br></span><span class="token-line" style="color:#000000"><span class="token variable" style="color:rgb(9, 134, 88)">           </span><span class="token variable operator" style="color:rgb(0, 0, 0)">|</span><span class="token variable" style="color:rgb(9, 134, 88)">-rsyslogd</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token variable number" style="color:rgb(9, 134, 88)">1122</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token variable" style="color:rgb(9, 134, 88)">-+-</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token variable" style="color:rgb(9, 134, 88)">rsyslogd</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token variable number" style="color:rgb(9, 134, 88)">1127</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token variable" style="color:rgb(9, 134, 88)"></span><br></span><span class="token-line" style="color:#000000"><span class="token variable" style="color:rgb(9, 134, 88)">           </span><span class="token variable operator" style="color:rgb(0, 0, 0)">|</span><span class="token variable" style="color:rgb(9, 134, 88)">                </span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">rsyslogd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">1128</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-sshd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">1118</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">---sshd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">16844</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">---bash</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">16849</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">-+-more</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">16881</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">                                        </span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token variable" style="color:rgb(9, 134, 88)">-pstree</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token variable number" style="color:rgb(9, 134, 88)">16880</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token variable" style="color:rgb(9, 134, 88)"></span><br></span><span class="token-line" style="color:#000000"><span class="token variable" style="color:rgb(9, 134, 88)">           </span><span class="token variable operator" style="color:rgb(0, 0, 0)">|</span><span class="token variable" style="color:rgb(9, 134, 88)">-systemd-journal</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token variable number" style="color:rgb(9, 134, 88)">561</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token variable" style="color:rgb(9, 134, 88)"></span><br></span><span class="token-line" style="color:#000000"><span class="token variable" style="color:rgb(9, 134, 88)">           </span><span class="token variable operator" style="color:rgb(0, 0, 0)">|</span><span class="token variable" style="color:rgb(9, 134, 88)">-systemd-logind</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token variable number" style="color:rgb(9, 134, 88)">774</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token variable" style="color:rgb(9, 134, 88)"></span><br></span><span class="token-line" style="color:#000000"><span class="token variable" style="color:rgb(9, 134, 88)">           </span><span class="token variable operator" style="color:rgb(0, 0, 0)">|</span><span class="token variable" style="color:rgb(9, 134, 88)">-systemd-udevd</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token variable number" style="color:rgb(9, 134, 88)">585</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token variable" style="color:rgb(9, 134, 88)"></span><br></span><span class="token-line" style="color:#000000"><span class="token variable" style="color:rgb(9, 134, 88)">           </span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token plain">-tuned</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">1119</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">-+-</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">tuned</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">1653</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                         </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">tuned</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">1654</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                         </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">tuned</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">1666</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                         `-</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">tuned</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">1696</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当某个进程不在某个绑定终端的 Shell 进程下，该进程必然是脱离终端脱离 Shell 的 Daemon 类进程或其子孙进程。</p><p>虽然从进程树关系来看，所有进程都直接或间接地受到 systemd 的管理，但是，并非所有 systemd 的子进程都受 Systemd Unit 管理单元的管理。</p><p>只有那些由 systemd 方式启动的服务进程(比如 systemctl 命令启动) 才受到 Systemd Unit 管理单元的监控和管理。为了简化描述，后面均直接以 <code>systemd 管理</code> 来描述受 systemd unit 管理单元的管理。</p><p>比如，用户可以通过下面两种方式启动 Nginx 服务进程：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># nginx                             # (1)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl start nginx.service     # (2)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>systemd 只能监控、管理第 (2) 种方式启动的 nginx 服务。比如第一种方式启动的 nginx，无法使用 systemctl stop nginx 来停止。</li></ul><p>所以，systemd 下的直系子进程可分为两类：受 systemd 管理的子进程和不受 systemd 管理的子进程。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11312systemd-管理服务的命令">11.3.1.2、systemd 管理服务的命令<a class="hash-link" href="#11312systemd-管理服务的命令" title="标题的直接链接">​</a></h4><p>启动、停止服务:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">systemctl start Service_Name1 Service_Name2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl stop  Service_Name</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>服务重载、重启相关操作：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 重载服务：服务未运行时不做任何事</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl reload Service_Name</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 重启服务：服务已运行时重启之，服务未运行时启动之</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl restart Service_Name</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 服务已运行时重启之，未运行时不启动之</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl try-restart Service_Name</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 服务已运行时，如果支持reload，则reload，如果不支持则restart</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 服务未运行时，启动之</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl reload-or-restart Service_Name</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 服务已运行时，如果支持reload，则reload，如果不支持则restart</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 服务未运行时，不做任何事</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl reload-or-try-restart Service_Name</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>服务状态查看操作：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 查看服务状态</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl status Service_Name</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 检查服务是否active: 服务是否已启动</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 至少一个服务active时，返回0，否则返回非0退出状态码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl is-active Service_Name1 Service_Name2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl --quiet is-active Service_Name  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 静默模式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 检查服务是否failed: 服务启动命令退出状态码非0或启动超时</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl is-failed Service_Name</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11313systemd-所管理服务的状态">11.3.1.3、systemd 所管理服务的状态<a class="hash-link" href="#11313systemd-所管理服务的状态" title="标题的直接链接">​</a></h4><p>当使用 systemd 管理服务时，有必要了解服务的各种状态信息。</p><p>使用 <code>systemctl list-units --type=service</code> 可以列出 Service Unit 的状态信息：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl list-units --type=service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">UNIT                                LOAD   ACTIVE SUB     DESCRIPTION</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">auditd.service                      loaded active running Security Auditing Service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">chronyd.service                     loaded active running NTP client/server</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">crond.service                       loaded active running Command Scheduler</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">serial-getty@ttyS0.service          loaded active running Serial Getty on ttyS0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sshd-keygen.service                 loaded active exited  OpenSSH Server Key Generation</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sshd.service                        loaded active running OpenSSH server daemon</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">LOAD   </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> Reflects whether the unit definition was properly loaded.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ACTIVE </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> The high-level unit activation state, i.e. generalization of SUB.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">SUB    </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> The low-level unit activation state, values depend on unit type.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">41</span><span class="token plain"> loaded </span><span class="token function" style="color:rgb(0, 0, 255)">units</span><span class="token plain"> listed. Pass --all to see loaded but inactive units, too.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">To show all installed unit files use </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;systemctl list-unit-files&#x27;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用 <code>systemctl status Service_Name</code> 命令可以查看到服务的状态信息。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl status sshd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">● sshd.service - OpenSSH server daemon</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Loaded: loaded </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">/usr/lib/systemd/system/sshd.service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> enabled</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> vendor preset: enabled</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Active: active </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">running</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> since Tue </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-03 06:16:18 EDT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> 1h 21min ago</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">     Docs: man:sshd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">8</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           man:sshd_config</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> Main PID: </span><span class="token number" style="color:rgb(9, 134, 88)">1118</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">sshd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   CGroup: /system.slice/sshd.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           └─1118 /usr/sbin/sshd -D</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>重点在 Active 行，它描述了服务的运行状态。上面 active 位置可能的状态值有：</p><ul><li>active</li><li>inactive</li><li>activating 或 deactivating</li><li>reloading</li><li>failed</li></ul><p>如果一个服务已经启动成功，它将成功加入到 systemd 监控队列(job queue)，此后它将受到 systemd 监控和管理，此时该服务的状态为 active。</p><p>如果一个服务在启动过程中失败，比如负责服务启动的命令(ExecStart 指令所指定) 在启动时以非 0 状态码退出、服务启动过程耗时过久导致超时、进程崩溃等，此时该服务的状态将处于 failed 状态，表示加入监控队列失败，事实上它加入到了某个描述启动失败的队列中。</p><p>当一个服务未启动，或者服务已停止时，该服务的状态将处于 inactive 状态。</p><p>有些服务启动、停止可能会消耗一点时间，在启动或停止的过程中去查看服务的状态，看到的状态信息可能会是 activating 或 deactivating 或 reloading。</p></li><li><p>括号中的 running 位置可能的值有很多：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl --state=help</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Available unit load states:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">stub</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Available unit active states:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">active</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Available unit </span><span class="token function" style="color:rgb(0, 0, 255)">file</span><span class="token plain"> states:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">enabled</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Available automount unit substates:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">dead</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Available </span><span class="token function" style="color:rgb(0, 0, 255)">mount</span><span class="token plain"> unit substates:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">failed</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Available path unit substates:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">waiting</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><p>虽然有很多种状态，但用户通常只需关注其中几项常见的即可。并且这些状态的存在通常都依赖于第一项 active 状态，比如 active(running)、active(exited)。</p><p><code>running</code> 状态表明被 systemd 监控的服务进程正在运行。</p><p><code>dead</code> 状态表明被 systemd 监控的进程已经死了(终结了)，systemd 识别到这种状态后就会将其从监控队列中释放并不再监控它，所以它的第一项状态也会随之变为 inactive。</p><p><code>exited</code> 表明被 systemd 监控的服务进程已经退出了或者 systemd 找不到它本该要监控的进程，但是管理者 systemd 认为它还没有死，只是认为它暂时退出了，所以通常会结合 active 状态一起出现，即 active(exited)。</p><ul><li>这种状态表明了一种意愿，服务进程已经消失了，但依然认为服务进程是活动的且正被监控。<ul><li>例如，当服务配置文件中配置了 RemainAfterExit=true 时，服务在退出后会进入 active(exited) 状态，还有多种其它可能会进入这种状态，通常来说意味着服务启动不正常(比如配置文件错误)，但并非一定代表服务是失败的，它仍然可能会正常提供服务。</li></ul></li></ul><p><code>auto-restart</code> 表明服务正在被 systemd 自动重启中，当服务配置文件设置了 Restart 且符合 Restart 规则时 systemd 会自动重启服务。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1132systemd-服务配置文件">11.3.2、systemd 服务配置文件<a class="hash-link" href="#1132systemd-服务配置文件" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11321systemd-service">11.3.2.1、systemd service<a class="hash-link" href="#11321systemd-service" title="标题的直接链接">​</a></h4><p>Systemd Service 是 systemd 提供的用于管理服务启动、停止和相关操作的功能，它极大的简化了服务管理的配置过程，用户只需要配置几项指令即可。</p><p>相比于 SysV 的服务管理脚本，用户不需要去编写服务的启动、停止、重启、状态查看等等一系列复杂的脚本代码。</p><p>systemd service 是 systemd 所管理的其中一项内容。实际上，systemd service 是 Systemd Unit 的一种，除了 Service，systemd 还有其他几种类型的 unit，比如 socket、slice、scope、target 等等。在这里，暂时了解两项内容：</p><ul><li>Service 类型，定义服务程序的启动、停止、重启等操作和进程相关属性</li><li>Target 类型，主要目的是对 Service(也可以是其它 Unit) 进行分组、归类，可以包含一个或多个 Service Unit(也可以是其它 Unit)</li></ul><p>此外，Systemd 作为管家，还将一些功能集成到了 Systemd Service 中，个人觉得比较出彩的两个集成功能是：</p><ul><li>用户可以直接在 Service 配置文件中定义 CGroup 相关指令来对该服务程序做资源限制。在以前，对服务程序做 CGroup 资源控制的步骤是比较繁琐的</li><li>用户可以选择 Journal 日志而非采用 rsyslog，这意味着用户可以不用单独去配置 rsyslog，而且可以直接通过 systemctl 或 journalctl 命令来查看某服务的日志信息。当然，该功能并不适用于所有情况，比如用户需要管理日志时</li></ul><p>Systemd Service 还有其它一些特性，比如可以动态修改服务管理配置文件，比如可以并行启动非依赖的服务，从而加速开机过程，等等。例如，使用 systemd-analyze blame 可分析开机启动各服务占用的时长：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemd-analyze blame </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">         </span><span class="token number" style="color:rgb(9, 134, 88)">32</span><span class="token plain">.216s kdump.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token number" style="color:rgb(9, 134, 88)">8</span><span class="token plain">.040s NetworkManager-wait-online.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">.341s network.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">.272s postfix.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">.127s dev-sda3.device</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           975ms firewalld.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           838ms tuned.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           703ms NetworkManager.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           611ms systemd-hwdb-update.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           466ms sshd-keygen.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           368ms systemd-fsck-root.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           351ms plymouth-start.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           343ms chronyd.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           296ms nginx.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           269ms systemd-vconsole-setup.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           130ms polkit.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           104ms systemd-logind.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            98ms sshd.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 从内核启动开始至开机结束所花时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemd-analyze time</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Startup finished </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain">.863s </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">kernel</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> + </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">.738s </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">initrd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> + </span><span class="token number" style="color:rgb(9, 134, 88)">44</span><span class="token plain">.161s </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">userspace</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">51</span><span class="token plain">.763s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11322systemd-配置文件路径">11.3.2.2、systemd 配置文件路径<a class="hash-link" href="#11322systemd-配置文件路径" title="标题的直接链接">​</a></h4><p>systemd service 配置文件都以 .service 结尾，systemd 将服务管理配置文件统一隐藏在 /usr/lib/systemd/system 目录下，同时暴露一个可供用户存放服务配置文件的目录 /etc/systemd/system。</p><p>如果用户需要，可以将服务配置文件手动存放至用户配置目录 /etc/systemd/system 下。该目录下的服务配置文件可以是普通 .service 文件，也可以是链接至 /usr/lib/systemd/system 目录下服务配置文件的软链接。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 位于/usr/lib/systemd/system下的服务配置文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 注意带有`@`符号的文件名，它有特殊意义</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ls /usr/lib/systemd/system -1 | tail</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">system-update.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">teamd@.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">timers.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">timers.target.wants</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">time-sync.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">tmp.mount</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">tuned.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">umount.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">user.slice</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">wpa_supplicant.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下面这些目录(<!-- -->*<!-- -->.target.wants) 定义各种类型下需要运行的服务</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ls -1dF /etc/systemd/system/*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/etc/systemd/system/basic.target.wants/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service@</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/etc/systemd/system/default.target@</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/etc/systemd/system/default.target.wants/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/etc/systemd/system/getty.target.wants/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/etc/systemd/system/local-fs.target.wants/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/etc/systemd/system/multi-user.target.wants/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/etc/systemd/system/network-online.target.wants/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/etc/systemd/system/sysinit.target.wants/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/etc/systemd/system/system-update.target.wants/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>sysinit.target.wants 目录下的是系统初始化过程运行的服务</li><li>getty.target.wants 目录下的是开机后启动虚拟终端时运行的服务</li><li>multi-user.target.wants 目录下的是多用户模式(对应运行级别2、3、4) 下运行的服务</li><li>这里不一一介绍，其实大部分可以见名知义。</li></ul><p>/etc/systemd/system/multi-user.target.wants 下的服务配置文件，几乎都是软链接</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ls -l /etc/systemd/system/multi-user.target.wants/ | awk &#x27;{print $9,$10,$11}&#x27; | tail</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">crond.service -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /usr/lib/systemd/system/crond.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">firewalld.service -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /usr/lib/systemd/system/firewalld.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">irqbalance.service -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /usr/lib/systemd/system/irqbalance.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kdump.service -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /usr/lib/systemd/system/kdump.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">postfix.service -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /usr/lib/systemd/system/postfix.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">remote-fs.target -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /usr/lib/systemd/system/remote-fs.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">rhel-configure.service -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /usr/lib/systemd/system/rhel-configure.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">rsyslog.service -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /usr/lib/systemd/system/rsyslog.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sshd.service -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /usr/lib/systemd/system/sshd.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">tuned.service -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /usr/lib/systemd/system/tuned.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11323systemd-service-文件格式">11.3.2.3、systemd service 文件格式<a class="hash-link" href="#11323systemd-service-文件格式" title="标题的直接链接">​</a></h4><p>一个 Systemd Service 的服务配置文件大概长这样：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> some descriptions</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Documentation </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> man:xxx</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">8</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> man:xxx_config</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Requires </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> xxx1.target xxx2.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">After </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> yyy1.target yyy2.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Type </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">TYPE</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ExecStart </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">CMD_for_START</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ExecStop </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">CMD_for_STOP</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ExecReload </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">CMD_for_RELOAD</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Restart </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">WHEN_TO_RESTART</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">RestartSec </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">TIME</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">WantedBy </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> xxx.target yyy.target</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>一个 .Service 配置文件分为三部分：</p><ol><li>Unit：定义该服务作为 Unit 角色时相关的属性</li><li>Service：定义本服务相关的属性</li><li>Install：定义本服务在设置服务开机自启动时相关的属性。换句话说，只有在 创建/移除 服务配置文件的软链接时，Install 段才会派上用场。这一配置段不是必须的，当未配置 <!-- -->[<!-- -->Install<!-- -->]<!-- --> 时，设置开机自启动或禁止开机自启动的操作将无任何效果</li></ol><p>[<!-- -->Unit<!-- -->]<!-- --> 和 <!-- -->[<!-- -->Install<!-- -->]<!-- --> 段的配置指令都来自于 man systemd.unit，这些指令都用于描述作为 Unit 时的属性，<!-- -->[<!-- -->Service<!-- -->]<!-- --> 段则专属于 .Service 服务配置文件。</p><p>这里先介绍一些常见的 <!-- -->[<!-- -->Unit<!-- -->]<!-- --> 和 <!-- -->[<!-- -->Install<!-- -->]<!-- --> 相关的指令(虽然支持的配置指令很多，但只需熟悉几个即可)，之后再专门介绍 Service 段落的配置指令。</p><blockquote><p><strong>[<!-- -->Unit<!-- -->]<!-- --> 段落指令</strong></p></blockquote><table><thead><tr><th>Unit指令</th><th>含义</th></tr></thead><tbody><tr><td>Description</td><td>Unit 的描述信息</td></tr><tr><td>Documentation</td><td>本 Unit 的 man 文档路径</td></tr><tr><td>After</td><td>本服务在哪些服务启动之后启动，仅定义启动顺序，不定义服务依赖关系，即使要求先启动的服务启动失败，本服务也依然会启动</td></tr><tr><td>Before</td><td>本服务在哪些服务启动之前启动，仅定义启动顺序，不定义服务依赖关系。通常用于定义在关机前要关闭的服务，如 Before=shutdown.target</td></tr><tr><td>Wants</td><td>本服务在哪些服务启动之后启动，定义服务依赖关系，不定义服务启动顺序。启动本服务时，如果被依赖服务未启动，则也会启动被依赖服务。如果被依赖服务启动失败，本服务不会受之影响，因此本服务会继续启动。如果未结合 After 使用，则本服务和被依赖服务同时启动。当配置在<!-- -->[<!-- -->Install<!-- -->]<!-- --> 段落中时，systemctl enable 操作将会将本服务安装到对应的 .wants 目录下(在该目录下创建一个软链接)，在开机自启动时，.wants 目录中的服务会被隐式添加至目标 Unit 的 Wants 指令后。</td></tr><tr><td>Requires</td><td>本服务在哪些服务启动之后启动，定义服务强依赖关系，不定义服务启动顺序。启动本服务时，如果被依赖服务未启动，则也会启动被依赖服务。如果结合了 After，当存在非 active 状态的被依赖服务时，本服务不会启动。且当被依赖服务被手动停止时，本服务也会被停止，但有例外。如果要保证两服务之间状态必须一致，使用 BindsTo 指令。当配置在<!-- -->[<!-- -->Install<!-- -->]<!-- --> 段落中时，systemctl enable 操作将会将本服务安装到对应的 .requires 目录下(在该目录下创建一个软链接)，在开机自启动时，.requires 目录中的服务会被隐式添加至目标 Unit 的 Requires 指令后。</td></tr><tr><td>Requisite</td><td>本服务在哪些服务启动之后启动，定义服务依赖关系，不定义服务启动顺序。启动本服务时，如果被依赖服务处于尚未启动状态，则不会主动去启动这些服务，所以本服务直接启动失败。该指令一般结合 After 一起使用，以便保证启动顺序。</td></tr><tr><td>BindsTo</td><td>绑定两个服务，两服务的状态保证一致。如服务 1 为 active，则本服务也一定为 active。</td></tr><tr><td>PartOf</td><td>本服务是其它服务的一部分，定义了单向的依赖关系，且只对 stop 和 restart 操作有效。当被依赖服务执行 stop 或 restart 操作时，本服务也会执行操作，但本服务执行这些操作，不会影响被依赖服务。一般用于组合 target 使用，比如 a.service 和 b.service 都配置 PartOf=c.target，那么 stop c 的时候，也会同时 stop a 和 b。</td></tr><tr><td>Conflicts</td><td>定义冲突的服务，本服务和被冲突服务的状态必须相反。当本服务要启动时，将会停止目标服务，当启动目标服务时，将会停止本服务。启动和停止的操作同时进行，所以，如果想要让本服务在目标服务启动之前就已经处于停止状态，则必须定义 After/Before。</td></tr><tr><td>OnFailure</td><td>当本服务处于 failed 时，将启动目标服务。如果本服务配置了 Restart 重启指令，则在耗尽重启次数之后，本服务才会进入 failed。有时候这是非常有用的，一个典型用法是本服务失败时调用定义了邮件发送功能的 service 来发送邮件，特别地，可以结合 systemd.timer 定时任务实现 cron 的 MAILTO 功能。</td></tr><tr><td>RefuseManualStart<br>RefuseManualStop</td><td>本服务不允许手动启动和手动停止，只能被依赖时的启动和停止，如果手动启动或停止，则会报错。有些特殊的服务非常关键，或者某服务作为一个大服务的一部分，为了保证安全，都可以使用该特性。例如，系统审计服务 auditd.service 中配置了不允许手动停止指令 RefuseManualStop，network.target 中配置了不允许手动启动指令 RefuseManualStart。</td></tr><tr><td>AllowIsolated</td><td>允许使用 systemctl isolate 切换到本服务，只配置在 target 中。一般来说，用户服务是绝不可能用到这一项的。</td></tr><tr><td>ConditionPathExists<br> AssertPathExists</td><td>要求给定的绝对路径文件已经存在，否则不做任何事(condition) 或进入 failed 状态(assert)，可在路径前使用!表示条件取反，即不存在时才启动服务。</td></tr><tr><td>ConditionPathIsDirectory<br>AssertPathIsDirectory</td><td>如上，路径存在且是目录时启动。</td></tr><tr><td>ConditionPathIsReadWrite<br>AssertPathIsReadWrite</td><td>如上，路径存在且可读可写时启动。</td></tr><tr><td>ConditionFileIsExecutable<br>AssertFileIsExecutable</td><td>如上，路径存在且是可执行普通文件时启动。</td></tr></tbody></table><p>对于自定义的服务配置文件来说，需要定义的常见指令包括 Description、After、Wants 及可能需要的条件判断类指令。所以，Unit 段落是非常简单的。</p><blockquote><p>[<em>Install</em>]<!-- --> 段落指令</p></blockquote><p>下面是 <!-- -->[<em>Install</em>]<!-- --> 段落相关的指令，它们只在 systemctl enable/disable 操作时有效。如果期望服务开机自启动，一般只配置一个 WantedBy 指令，如果不期望服务开机自启动，则 Install 段落通常省略。</p><table><thead><tr><th>Install 指令</th><th>含义</th></tr></thead><tbody><tr><td>WantedBy</td><td>本服务设置开机自启动时，在被依赖目标的 .wants 目录下创建本服务的软链接。例如 WantedBy = multi-user.target 时，将在 /etc/systemd/multi-user.target.wants 目录下创建本服务的软链接。</td></tr><tr><td>RequiredBy</td><td>类似 WantedBy，但是是在 .requires 目录下创建软链接。</td></tr><tr><td>Alias</td><td>指定创建软链接时链接至本服务配置文件的别名文件。例如 reboot.target 中配置了 Alias=ctrl-alt-del.target，当执行 enable 时，将创建 /etc/systemd/system/ctrl-alt-del.service 软链接并指向 reboot.target。</td></tr><tr><td>DefaultInstance</td><td>当是一个模板服务配置文件时(即文件名为 Service<!-- -->_<a href="mailto:Name@.service" target="_blank" rel="noopener noreferrer">Name@.service</a>)，该指令指定该模板的默认实例。例如 <a href="mailto:trojan@.service" target="_blank" rel="noopener noreferrer">trojan@.service</a> 中配置了 DefaultInstall=server 时，systemctl enable <a href="mailto:trojan@.service" target="_blank" rel="noopener noreferrer">trojan@.service</a> 时将创建名为 <a href="mailto:trojan@server.service" target="_blank" rel="noopener noreferrer">trojan@server.service</a> 的软链接。</td></tr></tbody></table><p>例如，下面是 sshd 的服务配置文件 /usr/lib/systemd/system/sshd.service，只看 Unit 段落和 Install 段落，是否很简单。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/sshd.service </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Description</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">OpenSSH server daemon</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Documentation</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">man:sshd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">8</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> man:sshd_config</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">After</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">network.target sshd-keygen.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Wants</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">sshd-keygen.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">WantedBy</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">multi-user.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>[<!-- -->Service<!-- -->]<!-- --> 段配置</p></blockquote><p>Systemd Service 配置文件中的 <!-- -->[<!-- -->Service<!-- -->]<!-- --> 段落可配置的指令很多，可配置在此段落中的指令来源有多处，包括：</p><ul><li>man systemd.service 中描述的专属于 Service Unit 的指令，一般是定义服务进程启动、停止、重启等管理行为的指令。比如 ExecStart 指令指定服务启动时执行的命令。</li><li>man systemd.exec 中描述的指令，一般是定义服务进程的启动环境、运行环境的指令。例如指定工作目录、指定服务进程的运行用户、指定环境变量、指定服务 OOM 相关属性等。</li><li>man systemd.kill 中描述的指令，一般是定义终止服务进程相关的指令，比如终止服务时发送什么信号、服务进程没杀死时如何处理等。</li><li>man resource-control 中描述的指令，一般是定义服务进程关于资源控制相关的指令，即配置服务进程的 CGroup。比如该服务进程最多允许使用多少内存、使用哪些 CPU、最多占用多少百分比的 CPU 时间等。</li></ul><p>例如，/usr/lib/systemd/system/rsyslog.service 文件的内容：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">EnvironmentFile</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">-/etc/sysconfig/rsyslog             </span><span class="token comment" style="color:rgb(0, 128, 0)"># 来自systemd.exec</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">UMask</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">0066                                          </span><span class="token comment" style="color:rgb(0, 128, 0)"># 来自systemd.exec</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">StandardOutput</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">null                                 </span><span class="token comment" style="color:rgb(0, 128, 0)"># 来自systemd.exec</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">notify                                         </span><span class="token comment" style="color:rgb(0, 128, 0)"># 来自systemd.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecStart</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/usr/sbin/rsyslogd -n </span><span class="token variable" style="color:rgb(9, 134, 88)">$SYSLOGD_OPTIONS</span><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 来自systemd.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Restart</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">on-failure                                  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 来自systemd.service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>再比如，想要限制一个服务最多允许使用 300M 内存(比如 512M 的 vps 主机运行一个比较耗内存的博客系统时，可设置内存使用限制)，最多 30% CPU 时间：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">MemoryLimit</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">300M</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">CPUQuota</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">30</span><span class="token plain">%</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecStart</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">xxx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此外还需要了解 systemd 的一项功能，systemctl set-property，它可以在线修改已启动服务的属性。例如</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 直接限制，且写入配置文件，所以下次启动服务也会被限制</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ll /etc/systemd/system/sshd.service.d/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">total </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl set-property sshd.service CPUQuota=20% </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl set-property sshd.service MemoryLimit=100M </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ll /etc/systemd/system/sshd.service.d/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">total </span><span class="token number" style="color:rgb(9, 134, 88)">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root root </span><span class="token number" style="color:rgb(9, 134, 88)">23</span><span class="token plain"> Aug  </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> 08:58 </span><span class="token number" style="color:rgb(9, 134, 88)">50</span><span class="token plain">-CPUQuota.conf</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-rw-r--r--. </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> root root </span><span class="token number" style="color:rgb(9, 134, 88)">32</span><span class="token plain"> Aug  </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> 08:58 </span><span class="token number" style="color:rgb(9, 134, 88)">50</span><span class="token plain">-MemoryLimit.conf</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 直接限制，不写入配置文件，所以下次启动服务不会被限制</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl set-property nginx MemoryLimit=100M --runtime</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>目前来说，可以不用过多关注来自其它位置的指令，应该给予重点关注的是来自 systemd.service 自身的指令，比如：</p><ul><li>Type：指定服务的管理类型</li><li>ExecStart：指定启动服务时执行的命令行</li><li>ExecStop：指定停止服务时运行的命令</li><li>ExecReload：指定重载服务进程时运行的命令</li><li>Restart：指定 systemd 是否要自动重启服务进程以及什么情况下重启</li></ul><p>特别是 Type 指令，它直接影响 <!-- -->[<!-- -->Service<!-- -->]<!-- --> 段中的多项配置方式。</p><ul><li>simple</li><li>exec</li><li>forking</li><li>oneshot</li><li>dbus</li><li>notify</li><li>idle</li></ul><p>如果配置的是服务进程，Type 的值很可能是 forking 或 simple，如果是普通命令的进程，Type 的值可能是 simple、oneshot。</p><p>而 dbus 类型一般情况下用不上，notify 要求服务程序中使用代码对 systemd notify 进行支持，所以多数情况下可能也用不上。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11324systemd-servicetypeforking">11.3.2.4、systemd service：Type=forking<a class="hash-link" href="#11324systemd-servicetypeforking" title="标题的直接链接">​</a></h4><p>当使用 systemd 去管理一个长久运行的服务进程时，最常用的 Type 是 forking 类型。</p><p>使用 Type=forking 时，要求 ExecStart 启动的命令自身就是以 daemon 模式运行的。而以 daemon 模式运行的进程都有一个特性：总是会有一个瞬间退出的中间父进程。</p><p>例如，nginx 命令默认以 daemon 模式运行，所以可直接将其配置为 forking 类型：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cp /usr/lib/systemd/system/nginx.service /usr/lib/systemd/system/nginx.service.backup</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/nginx.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> Rewrite by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> understanding </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">forking</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Type </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> forking</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ExecStart </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /usr/sbin/nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl daemon-reload</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl start nginx.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl status nginx.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">● nginx.service - Rewrite by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> understanding </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">forking</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Loaded: loaded </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">/usr/lib/systemd/system/nginx.service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> static</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> vendor preset: disabled</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Active: active </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">running</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> since Tue </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-03 09:11:49 EDT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> 6s ago</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  Process: </span><span class="token number" style="color:rgb(9, 134, 88)">18029</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecStart</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/usr/sbin/nginx </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">code</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">exited, </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">status</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">/SUCCESS</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> Main PID: </span><span class="token number" style="color:rgb(9, 134, 88)">18030</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">nginx</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Memory: </span><span class="token number" style="color:rgb(9, 134, 88)">59</span><span class="token plain">.4M</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   CGroup: /system.slice/nginx.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18030 nginx: master process /usr/sbin/nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18031 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18032 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18033 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18034 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18035 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18036 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18037 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18038 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18039 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18040 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18041 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18042 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18043 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18044 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18045 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           └─18046 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>注意上面 status 报告的信息中，ExecStart 启动的 nginx 的进程 PID=18029，且该进程的状态是已退出，退出状态码为 0，这个进程是 daemon 类进程创建过程中瞬间退出的中间父进程。</li><li>在 forking 类型中，该进程称为初始化进程。同时还有一行 Main PID: 18030 (nginx)，这是 systemd 真正监控的 nginx 服务主进程，其 PID=18030，是 PID=18029 进程的子进程。</li></ul><p>Type=forking 类型代表什么呢？要解释清楚该 type，需从进程创建开始说起。</p><p><img loading="lazy" alt="systemd fork daemon" src="/assets/images/systemd fork daemon-8c72d2eea58f2346b3596e7879afd041.png" width="717" height="805" class="img_ev3q"></p><p>下面我们来梳理一下这个过程：</p><ol><li>systemd 作为用户空间第一个进程由内核加载。</li><li>systemd 负责加载所有的 daemon 进程。<ol><li>以 nginx 为例，在 nginx 服务进程启动时，由 pid=1 的 systemd 进程 fork() 一个子 systemd 进程(pid=18029)。</li><li>子 systemd 进程分支通过 systemd.exec 配置该子进程环境，然后使用 exec() 去调用 ExecStart 指定的 nginx 服务启动命令。</li><li>exec() 调用程序时会替换当前进程，所以启动后的 nginx 服务进程(pid=18030) 将会替代子 systemd 进程(pid=18029)，最终 nginx 服务进程自身成为 systemd(pid=1) 进程的子进程。</li></ol></li></ol><p>对于 Type=forking 来说，pid=1 的 systemd 进程 fork 出来的子进程正是瞬间退出的中间父进程，且 systemd 会在中间父进程退出后就认为服务启动成功，此时 systemd 可以立即去启动后续需要启动的服务。</p><p>如果 Type=forking 服务中的启动命令是一个前台命令会如何呢？比如将 sleep 配置为 forking 模式，将 nginx daemon off 配置为 forking 模式等。</p><p>答案是 systemd 会一直等待中间 ExecStart 启动的进程作为中间父进程退出，在等待过程中，systemctl start 会一直卡住，直到等待超时而失败，在此阶段中，systemctl status 将会查看到服务处于 activating 状态。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/nginx.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> Rewrite by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> understanding </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">forking</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Type </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> forking</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ExecStart </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /usr/sbin/nginx -g </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;daemon off;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl daemon-reload </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl start nginx.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token variable" style="color:rgb(9, 134, 88)">卡住了</span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 复制一个会话终端</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl status nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">● nginx.service - Rewrite by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> understanding </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">forking</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Loaded: loaded </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">/usr/lib/systemd/system/nginx.service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> static</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> vendor preset: disabled</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Active: activating </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">start</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> since Tue </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-03 09:37:43 EDT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> 20s ago</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  Control: </span><span class="token number" style="color:rgb(9, 134, 88)">18118</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">nginx</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Memory: </span><span class="token number" style="color:rgb(9, 134, 88)">43</span><span class="token plain">.7M</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   CGroup: /system.slice/nginx.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18118 nginx: master process /usr/sbin/nginx -g daemon off</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18119 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18120 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18121 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18122 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18123 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18124 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18125 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18126 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18127 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18128 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18129 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18130 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18131 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18132 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─18133 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           └─18134 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当设置 Type=forking 时，有一个 GuessMainPID 指令其默认值为 yes，它表示 systemd 会通过一些算法去猜测Main PID，因为 Main PID 的父进程已瞬间退出，如果猜错了将导致服务启动异常，这也是有可能的。</p><p>好在，Type=forking 时的 systemd 提供了 PIDFile 指令( Type=forking 通常都会结合 PIDFile 指令)，systemd 会从 PIDFile 指令所指定的 PID 文件中获取服务的主进程 PID。</p><p>例如，编写一个 nginx 的服务配置文件：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/nginx.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> Rewrite by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> understanding </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">forking</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Type </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> forking</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">PIDFile </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /run/nginx.pid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ExecStartPre </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /usr/bin/rm -f /run/nginx.pid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ExecStart </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /usr/sbin/nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ExecStartPost </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /usr/bin/sleep </span><span class="token number" style="color:rgb(9, 134, 88)">0.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>关于 PIDFile，有必要去了解一些注意事项，否则它们可能就会成为你的坑：</p><ul><li><p>首先，PIDFile 只适合在 Type=forking 模式下使用，其它时候没必要使用，因为其它类型的 Service 主进程的 PID 都是确定的。</p><ul><li>systemd 推荐 PIDFile 指定的 PID 文件在 /run 目录下，所以，可能需要修改服务程序的配置文件，将其 PID 文件路径修改为 /run 目录之下，当然这并非必须。但有一点必须注意，PIDFile 指令的值要和服务程序的 PID 文件路径保持一致。</li></ul><p>例如 nginx 的相关配置：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># grep -i &quot;nginx.pid&quot; /etc/nginx/nginx.conf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">pid /run/nginx.pid</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># grep -i &quot;nginx.pid&quot; /usr/lib/systemd/system/nginx.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">PIDFile </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /run/nginx.pid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ExecStartPre </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /usr/bin/rm -f /run/nginx.pid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>其次，systemd 会在中间父进程退出后立即读取这个 PID 文件，读取成功后就认为该服务已经启动成功。systemd 读取 PIDFile 的时候，服务主进程可能还未将 PID 写入到 PID 文件中，这时 systemd 将出现问题。</p><ul><li>所以，对于服务程序的开发人员来说，应尽早将主进程写入到 PID 文件中，比如可以在中间父进程 fork 完之后立即写入 PID 文件，然后再退出，而不是在 fork 出来的服务主进程内部由主进程负责写入。</li><li>万一某个版本的 nginx 出现该问题，解决办法是使用 ExecStartPost=/usr/bin/sleep 0.1，让 systemd 在初始化进程(即中间父进程)退出之后耽搁 0.1 秒再继续向下执行，即推迟了 systemd 读取 PID 的过程，保证能让 systemd 从 PID 文件中读取到值。</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/nginx.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Description</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">The nginx HTTP and reverse proxy server</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">After</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">network.target remote-fs.target nss-lookup.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">forking</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">PIDFile</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/run/nginx.pid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Nginx will fail to start if /run/nginx.pid already exists but has the wrong</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># SELinux context. This might happen when running nginx -t from the cmdline.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># https://bugzilla.redhat.com/show_bug.cgi?id=1268621</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecStartPre</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/usr/bin/rm -f /run/nginx.pid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecStartPre</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/usr/sbin/nginx -t</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecStart</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/usr/sbin/nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecStartPost</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/usr/bin/sleep </span><span class="token number" style="color:rgb(9, 134, 88)">0.1</span><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 加这一行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecReload</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/bin/kill -s HUP </span><span class="token variable" style="color:rgb(9, 134, 88)">$MAINPID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">KillSignal</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">SIGQUIT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">TimeoutStopSec</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">KillMode</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">PrivateTmp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">true</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">WantedBy</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">multi-user.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><p>最后，systemd 只会读 PIDFile 文件而不会写，也不会创建它。但是在停止服务的时候，systemd 会尝试删除 PID 文件。但是服务进程可能会异常终止，导致已终止的服务进程的 PID 文件仍然保留着，所以在使用 PIDFile 指令时，通常还会使用 ExecStartPre 指令来删除可能已经存在的 PID 文件。正如上面给出的 nginx 配置文件一样。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11325systemd-servicetypesimple">11.3.2.5、systemd service：Type=simple<a class="hash-link" href="#11325systemd-servicetypesimple" title="标题的直接链接">​</a></h4><p>Type=simple 是一种最常见的通过 systemd 服务系统运行用户自定义命令的类型，也是省略 Type 指令时的默认类型。适合那些在 shell 下运行在前台的命令。</p><p>例如，编写一个 /usr/lib/systemd/system/sleep.service 运行 sleep 进程：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/sleep.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> written by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> testing </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">simple</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Type </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> simple</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ExecStart </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /usr/bin/sleep </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 命令必须使用绝对路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用 daemon-reload 重载并启动该服务进程：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl daemon-reload </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl start sleep.service </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl status sleep.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">● sleep.service - written by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> testing </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">simple</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Loaded: loaded </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">/usr/lib/systemd/system/sleep.service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> static</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> vendor preset: disabled</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Active: active </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">running</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> since Tue </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-03 </span><span class="token number" style="color:rgb(9, 134, 88)">23</span><span class="token plain">:54:54 EDT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> 6s ago</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> Main PID: </span><span class="token number" style="color:rgb(9, 134, 88)">22677</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">sleep</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Memory: </span><span class="token number" style="color:rgb(9, 134, 88)">512</span><span class="token plain">.0K</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   CGroup: /system.slice/sleep.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           └─22677 /usr/bin/sleep </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>10 秒内，sleep 进程以 daemon 模式运行在后台，就像一个服务进程一样。10 秒之后，sleep 退出，于是 systemd 将该进程从监控队列中踢出。再次查看进程的状态将是 inactive：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl status sleep.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">● sleep.service - written by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> testing </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">simple</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Loaded: loaded </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">/usr/lib/systemd/system/sleep.service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> static</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> vendor preset: disabled</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Active: inactive </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">dead</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的服务配置文件中的 <code>ExecStart</code> 指令指定启动本服务时执行的命令，即启动一个本该前台运行的 sleep 进程作为服务进程在后台运行。</p><p><em>注意：systemd service 的命令行中必须使用绝对路径，且只能编写单条命令(Type=oneshot时除外)，如果要命令续行，可在尾部使用反斜线符号 <!-- -->\<!-- --> 等。此外，命令行中支持部分类似 Shell 的特殊符号，但不支持重定向 &gt; &gt;&gt; &lt;&lt; &lt;、管道 |、后台符号 &amp;，具体可参考 man systemd.service 中 command line 段落的解释说明。</em></p><p>当 Type=simple 时，systemd 将会认为在 main service process 被 fork 之后 unit 就已经启动了；而服务配置文件中 ExecStart 指定的服务就是 main service process。</p><p>在这种模式下，如果 main sevice process 要为其它系统进程提供功能，那么沟通通道就应该在 service 启动之前建立起来；因为 systemd 就在创建 main service process 之后，在执行 service 的二进制程序之前，要继续启动下一批 units。</p><p>这就意味着使用 <code>systemctl start</code> 命令行启动的 Type=simple 服务，即便是 services 的二进制程序不能成功执行，也会报告成功。</p><ul><li>不能成功执行 services 二进制程序的情况，比如说 User= 不存在，services 二进制文件丢失等。</li></ul><p>如果 simple 类型下 ExecStart 启动的命令本身就是以 daemon 模式运行的呢？</p><ul><li>其结果是 systemd 默认会立刻杀掉所有属于服务的进程。</li><li>原因也很简单，daemon 类进程总是会有一个瞬间退出的中间父进程，而在 simple 类型下，systemd 所 fork 出来的子进程正是这个中间父进程，所以 systemd 会立即发现这个中间父进程的退出，于是杀掉其它所有服务进程。</li></ul><p>例如，以运行 bash -c &#x27;(sleep 3000 &amp;)&#x27; 的 simple 类型的服务，被 systemd 监控的 bash 进程会在启动 sleep 后立即退出，于是 systemd 会立即杀掉属于该服务的 sleep 进程。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/sleep.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> written by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> testing </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">simple</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">simple</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecStart</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/usr/bin/bash -c </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;( /usr/bin/sleep 30 &amp;)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl daemon-reload </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl start sleep.service </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl status sleep.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">● sleep.service - written by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> testing </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">simple</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Loaded: loaded </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">/usr/lib/systemd/system/sleep.service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> static</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> vendor preset: disabled</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Active: inactive </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">dead</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>再例如，nginx 命令默认是以 daemon 模式运行的，simple 类型下直接使用 nginx 命令启动服务，systemd 会立刻杀掉所有 nginx，即 nginx 无法启动成功。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/nginx.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> Rewrite by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> understanding </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">forking</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Type </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> simple</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ExecStart </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /usr/sbin/nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl daemon-reload </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl start nginx.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl status nginx.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">● nginx.service - Rewrite by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> understanding </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">forking</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Loaded: loaded </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">/usr/lib/systemd/system/nginx.service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> static</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> vendor preset: disabled</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Active: inactive </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">dead</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>但如果将 nginx 进程以非 daemon 模式运行，simple 类型的 nginx 服务将正常启动：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/nginx.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> Rewrite by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> understanding </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">forking</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Type </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> simple</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ExecStart </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /usr/sbin/nginx -g </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;daemon off;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl daemon-reload </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl start nginx.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl status nginx.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">● nginx.service - Rewrite by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> understanding </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">forking</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Loaded: loaded </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">/usr/lib/systemd/system/nginx.service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> static</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> vendor preset: disabled</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Active: active </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">running</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> since Thu </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-05 01:16:27 EDT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> 7s ago</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> Main PID: </span><span class="token number" style="color:rgb(9, 134, 88)">26463</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">nginx</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Memory: </span><span class="token number" style="color:rgb(9, 134, 88)">58</span><span class="token plain">.7M</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   CGroup: /system.slice/nginx.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─26463 nginx: master process /usr/sbin/nginx -g daemon off</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─26464 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─26465 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─26466 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─26467 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─26468 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─26469 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─26470 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─26471 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─26472 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─26473 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─26474 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─26475 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─26476 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─26477 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─26478 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           └─26479 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11326systemd-service其它-type">11.3.2.6、Systemd Service：其它 Type<a class="hash-link" href="#11326systemd-service其它-type" title="标题的直接链接">​</a></h4><p>除了 simple 和 forking 类型，还有 exec、oneshot、idle、notify 和 dbus 类型，这里不考虑 notify 和 dbus，剩下的 exec、oneshot 和 idle 都类似于 simple 类型。</p><ul><li>simple：在 fork 出子 systemd 进程后，systemd 就认为该服务启动成功了</li><li>exec：在 fork 出子 systemd 进程且子 systemd 进程 exec() 调用 ExecStart 命令成功后，systemd 认为该服务启动成功</li><li>oneshot：在 ExecStart 命令执行完成退出后，systemd 才认为该服务启动成功<ul><li>因为服务进程退出后 systemd 才继续工作，所以在未配置 RemainAfterExit 指令时，oneshot 类型的服务永远无法出现 active 状态，它直接从启动状态到 activating 到 deactivating 再到 dead 状态</li><li>当结合 RemainAfterExit 指令时，在服务进程退出后，systemd 会继续监控该 Unit，所以服务的状态为 active(exited)，通过这个状态可以让用户知道，该服务曾经已经运行成功，而不是从未运行过</li><li>通常来说，对于那些执行单次但无需长久运行的进程来说，可以采用 type=oneshot，比如启动 iptables，挂载文件系统的操作、关机或重启的服务等</li></ul></li><li>idle：idle 的表现行为跟 simple 很像，但是 service 程序的实际执行会延迟，直到所有 active jobs 被派遣完成。这可以用来避免 shell 服务的输出与控制台上的状态输出相交叉。此类型仅用于改进控制台输出，很少会有人用。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1133模板型服务配置文件">11.3.3、模板型服务配置文件<a class="hash-link" href="#1133模板型服务配置文件" title="标题的直接链接">​</a></h3><p>systemd service 支持简单的模板型 Unit 配置文件，在 Unit 配置文件中可以使用 %n %N %p %i... 等特殊符号进行占位，在 systemd 读取配置文件时会将这些特殊符号解析并替换成对应的值。</p><p>这些特殊符号的含义可参见 man systemd.unit。通常情况下只会使用到 %i 或 %I，其它特殊符号用到的机会较少。</p><ul><li>使用 %i %I 这两个特殊符号时，要求 Unit 的文件名以 @ 为后缀，即文件名格式为 Service<!-- -->_<a href="mailto:Name@.service" target="_blank" rel="noopener noreferrer">Name@.service</a>。当使用 systemctl 管理这类服务时，@ 符号后面的字符会传参到 Unit 模板文件中的 %i 或 %I，官方称之为实例化。</li></ul><p>有时候这是很实用的。比如有些程序既是服务端程序又是客户端程序，区分客户端和服务端的方式是使用不同配置文件。</p><p>假设用户想在一个机器上同时运行 trojan 程序的服务端和客户端，可编写如下 Unit 服务配置文件：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/trojan@.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> trojan to flee</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Type </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> forking</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ExecStart </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /usr/local/bin/trojan --config /etc/trojan/%i.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>现在用户可以在 /etc/trojan 目录下同时提供服务程序的服务端配置文件和客户端配置文件。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">/etc/trojan/server.conf</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/etc/trojan/client.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果要管理该主机上的服务端：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">systemctl start trojan@server.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl status trojan@server.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl stop trojan@server.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"> trojan@server.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl disable trojan@server.service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果要管理该主机上的客户端：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">systemctl start trojan@client.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl status trojan@client.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl stop trojan@client.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"> trojan@client.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl disable trojan@client.service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><em>注意：Systemd 在运行服务时，总是会先尝试找到一个完全匹配的 Unit 文件，如果没有找到，才会尝试选择匹配模板。比如 systemctl start <a href="mailto:trojan@server.service" target="_blank" rel="noopener noreferrer">trojan@server.service</a>，systemd 会先去找完全匹配的 <a href="mailto:trojan@server.service" target="_blank" rel="noopener noreferrer">trojan@server.service</a> 这个 Unit 文件；如果找不到，才会使用 <a href="mailto:trojan@.service" target="_blank" rel="noopener noreferrer">trojan@.service</a> 这个模板文件将服务实例化。</em></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1134使用-target-组合多个服务">11.3.4、使用 target 组合多个服务<a class="hash-link" href="#1134使用-target-组合多个服务" title="标题的直接链接">​</a></h3><p>有些时候，一个大型服务可能由多个小服务组成。</p><p>比如 c 服务由 a.service 和 b.service 组成，因为组合了两个服务，所以 c 服务可以定义为 c.target。</p><p>a.service 内容：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/a.service </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> a.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">PartOf </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> c.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Before </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> c.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ExecStart </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /usr/local/bin/pinga.sh</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>b.service 内容：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/b.service </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> b.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">PartOf </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> c.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Before </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> c.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ExecStart </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /usr/local/bin/pingb.sh</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>c.target 内容：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/c.target </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> c.service, consists of a.service and b.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">After </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> a.service b.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Wants </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> a.service b.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl start c.target</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl status c.target a.service b.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">● c.target - c.service, consists of a.service and b.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Loaded: loaded </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">/usr/lib/systemd/system/c.target</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> static</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> vendor preset: disabled</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Active: active since Thu </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-05 </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:40:52 EDT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> 13s ago</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Aug 05 </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:40:52 arm64v8 systemd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">: Reached target c.service, consists of a.service and</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.ce.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Aug 05 </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:40:52 arm64v8 systemd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">: Starting c.service, consists of a.service and b.service.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">● a.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Loaded: loaded </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">/usr/lib/systemd/system/a.service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> static</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> vendor preset: disabled</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Active: active </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">running</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> since Thu </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-05 </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:40:52 EDT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> 13s ago</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> Main PID: </span><span class="token number" style="color:rgb(9, 134, 88)">28788</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">pinga.sh</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Memory: </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain">.6M</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   CGroup: /system.slice/a.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─28788 /bin/bash /usr/local/bin/pinga.sh</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           └─28790 </span><span class="token function" style="color:rgb(0, 0, 255)">ping</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">10.60</span><span class="token plain">.20.74</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Aug 05 </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:40:52 arm64v8 systemd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">: Started a.service.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Aug 05 </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:40:52 arm64v8 systemd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">: Starting a.service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">● b.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Loaded: loaded </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">/usr/lib/systemd/system/b.service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> static</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> vendor preset: disabled</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Active: active </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">running</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> since Thu </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-05 </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:40:52 EDT</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> 13s ago</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> Main PID: </span><span class="token number" style="color:rgb(9, 134, 88)">28789</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">pingb.sh</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Memory: </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain">.9M</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   CGroup: /system.slice/b.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           ├─28789 /bin/bash /usr/local/bin/pingb.sh</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           └─28791 </span><span class="token function" style="color:rgb(0, 0, 255)">ping</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">10.60</span><span class="token plain">.20.75</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Aug 05 </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:40:52 arm64v8 systemd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">: Started b.service.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Aug 05 </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain">:40:52 arm64v8 systemd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">: Starting b.service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Hint: Some lines were ellipsized, use -l to show </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> full.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>c 中配置 Wants 表示 a 和 b 先启动，但启动失败不会影响 c 的启动。如果要求 c.target 和 a.service、b.service 的启动状态一致，可将 Wants 替换成 Requires 或 BindsTo 指令。</p><p>PartOf 指令表明 a.service 和 b.service 是 c.target 的一部分，停止或重启 c.target 的同时，也会停止或重启 a 和 b。再加上 c.target 中配置了 Wants 指令(也可以改成 Requires 或 BindsTo)，使得启动 c 的时候，a 和 b 也已经启动完成。</p><p>但是要注意，PartOf 是单向的，停止和重启 a 或 b 的时候不会影响 c。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1135systemd-开机自启任务">11.3.5、systemd 开机自启任务<a class="hash-link" href="#1135systemd-开机自启任务" title="标题的直接链接">​</a></h3><p>如果要让任务开机自启动，需将对应的 Unit 文件存放于 /etc/systemd/system 下。本文以 Service Unit 为例，但也支持让 path Unit、timer Unit 等类型的任务开机自启动。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11351systemd-服务开机自启">11.3.5.1、systemd 服务开机自启<a class="hash-link" href="#11351systemd-服务开机自启" title="标题的直接链接">​</a></h4><p>用户可以手动将服务配置文件存放至此路径，但更建议采用 systemd 系统提供的上层工具 systemctl 来操作。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 将服务加入开机自启动</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"> Service_Name</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 禁止服务开机自启动</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl disable Service_Name</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 查看服务是否开机自启动</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl is-enabled Service_Name</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 查看所有开机自启动服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl list-unit-files --type </span><span class="token function" style="color:rgb(0, 0, 255)">service</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;enabled&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用 systemctl 命令时，可以指定服务名称，也可以指定服务对应的服务配置 unit 文件。</p><p>例如下面两条命令是等价的。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">systemctl </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"> sshd          </span><span class="token comment" style="color:rgb(0, 128, 0)"># 服务名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"> sshd.service  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 服务对应的unit文件</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>systemctl 的很多操作都具备幂等性，这意味着如果要操作的服务已经处于目标状态，则什么都不会做。</p><p>如果是未开机自启动的服务加入开机自启动呢？比如，拷贝 sshd 服务的配置文件，并将拷贝后的服务 sshd1 加入开机自启动：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cp /usr/lib/systemd/system/{sshd,sshd1}.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl enable sshd1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Created symlink from /etc/systemd/system/multi-user.target.wants/sshd1.service to /usr/lib/systemd/system/sshd1.service.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从结果可看到，systemctl 将服务加入开机自启动的操作，实际上是在 /etc/systemd/system 某个 target.wants 目录下创建服务配置文件的软链接文件。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># readlink /etc/systemd/system/multi-user.target.wants/sshd1.service </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/sshd1.service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>显然，禁用服务开机自启动的操作是移除软链接。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl disable sshd1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Removed symlink /etc/systemd/system/multi-user.target.wants/sshd1.service.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最后，如果服务已经加入开机自启动，但想要再次加入(比如更新了 /usr/lib/systemd/system 下的服务配置文件)，可在 enable 时加上 –force 选项：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl --force enable Service_Name</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11352systemd-中自定义开机自启动命令脚本">11.3.5.2、systemd 中自定义开机自启动命令/脚本<a class="hash-link" href="#11352systemd-中自定义开机自启动命令脚本" title="标题的直接链接">​</a></h4><p>在 SysV 系统中，要让某个命令或某个脚本开机自启动，可以将命令或执行脚本的命令行写入 /etc/rc.local。</p><p>在 systemd 中，要让某个命令或某个脚本开机自启动，要么将其编写成一个开机自启动服务，要么通过 systemd 兼容的 /etc/rc.local。</p><p>下面是一个简单的让命令(脚本)开机自启动的配置文件：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/local/bin/ping.sh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">ping</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">10.60</span><span class="token plain">.20.72 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;&gt;</span><span class="token plain"> /tmp/ping.txt</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/ping.service </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">ping</span><span class="token plain"> shell script</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ConditionFileIsExecutable </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /usr/local/bin/ping.sh  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 要求脚本具有可执行权限</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ExecStart </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /usr/local/bin/ping.sh  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 指定要运行的命令、脚本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">WantedBy </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> multi-user.target    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 这段不能少</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl daemon-reload </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl enable ping.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Created symlink from /etc/systemd/system/multi-user.target.wants/ping.service to /usr/lib/systemd/system/ping.service.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl start ping.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果要使用 /etc/rc.local 的方式呢？systemd 提供了 rc-local.service 服务来加载 /etc/rc.d/rc.local 文件中的命令。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/rc-local.service </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#  This file is part of systemd.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#  systemd is free software; you can redistribute it and/or modify it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#  under the terms of the GNU Lesser General Public License as published by</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#  the Free Software Foundation; either version 2.1 of the License, or</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#  (at your option) any later version.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># This unit gets pulled automatically into multi-user.target by</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># systemd-rc-local-generator if /etc/rc.d/rc.local is executable.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Description</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/etc/rc.d/rc.local Compatibility</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ConditionFileIsExecutable</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/etc/rc.d/rc.local</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">After</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">network.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">forking</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecStart</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/etc/rc.d/rc.local start</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">TimeoutSec</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">RemainAfterExit</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">yes</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>这个文件缺少了 <!-- -->[<!-- -->Install<!-- -->]<!-- --> 段且没有 WantedBy，后面将会解释 Install 中的 WantedBy 表示设置该服务开机自启动时，该服务加入到哪个 <code>运行级别</code> 中启动。</li><li>但这个文件的注释中说明了，如果 /etc/rc.d/rc.local 文件存在且具有可执行权限，则 systemd-rc-local-generator 将会自动添加到 multi-user.target 中，所以，即使没有 Install 和 WantedBy 也无关紧要。</li></ul><p>另一方面需要注意，和 SysV 风格系统在系统启动的最后阶段运行 rc.local 不太一样，systemd 兼容的 rc.local 是在 network.target 即网络相关服务启动完成之后就启动的，这意味着 rc.local 可能在开机启动过程中较早的阶段就开始运行。</p><p>如果想要将命令加入到 /etc/rc.local 中实现开机自启动，直接写入该文件，并设置该文件可执行权限即可。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> -e </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;#!/bin/bash\ndate +&quot;%F %T&quot; &gt;/tmp/a.log&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;&gt;</span><span class="token plain">/etc/rc.d/rc.local</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">chmod</span><span class="token plain"> +x /etc/rc.d/rc.local</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1136systemd-运行级别">11.3.6、systemd 运行级别<a class="hash-link" href="#1136systemd-运行级别" title="标题的直接链接">​</a></h3><p>在 CentOS 6 及之前的版本中有运行级别的概念，Systemd 系统内没有直接定义运行级别的概念，但是通过 Target Unit 兼容模拟了运行级别。</p><p>可以查看 /usr/lib/systemd/system/ 下的一些 target 文件。为了节省篇幅，下面我列出了部分 target：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ls -l /usr/lib/systemd/system/*.target | grep -o &#x27;/.*&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># /usr/lib/systemd/system/下定义的默认运行级别：graphical</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/default.target -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> graphical.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 紧急模式、救援模式、多用户模式和图形界面模式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/emergency.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/rescue.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/multi-user.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/graphical.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 关机和重启相关操作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/ctrl-alt-del.target -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> reboot.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/shutdown.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/poweroff.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/reboot.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/halt.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 运行级别0-6，注意多用户模式为multi-user.target</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/runlevel0.target -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> poweroff.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/runlevel1.target -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> rescue.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/runlevel2.target -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> multi-user.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/runlevel3.target -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> multi-user.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/runlevel4.target -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> multi-user.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/runlevel5.target -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> graphical.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/runlevel6.target -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> reboot.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意上面有一个 /usr/lib/systemd/system/default.target 指向 graphical.target，但它不一定就是默认运行级别，因为有可能 /etc/systemd/system 下也有一个 default.target。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># readlink /etc/systemd/system/default.target</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/lib/systemd/system/multi-user.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>因为 /etc/systemd/system 下的 unit 都是开机时加载的，所以 <code>优先级</code> 更高。这就意味着上面的示例默认运行级别为 multi-user.target，而非 graphical.target。</li></ul><p>target 是如何模拟运行级别的呢？理解了运行级别的本质含义后，就很容易理解了。所谓运行级别，无非是定义几种系统的运行模式，在不同运行模式下，启动不同服务或执行不同程序。比如图形界面下会运行图形界面服务。</p><p>而 target 的主要作用是对服务进行分组、归类。所以，只需要定义几个代表不同运行级别的 target，并在不同的 target 中放入不同的服务程序即可(除了服务程序还可以包含其它的 Unit)。</p><p>target 又是如何对服务进行分组、归类的呢？作为初步了解，可在 /etc/systemd/system 中寻找答案。在此目录下，有一些 <code>*.target.wants</code> 目录，该目录定义了该 target 中包含了哪些 Unit，systemd 会在处理到对应 target 时会寻找 wants 后缀的目录，并加载启动该目录下的所有 Unit，这就是 target 对服务(及其它 Unit) 分组的方式。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ls -1F /etc/systemd/system/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">basic.target.wants/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">dbus-org.fedoraproject.FirewallD1.service@</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">default.target@</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">default.target.wants/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">getty.target.wants/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">local-fs.target.wants/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">multi-user.target.wants/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">network-online.target.wants/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sshd.service.d/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sysinit.target.wants/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">system-update.target.wants/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 系统环境初始化相关服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ls -1 /etc/systemd/system/sysinit.target.wants/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">rhel-autorelabel.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">rhel-domainname.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">rhel-import-state.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">rhel-loadmodules.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 多用户模式下开机自启动的服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ls -1 /etc/systemd/system/multi-user.target.wants/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">auditd.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">chronyd.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">crond.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">firewalld.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">irqbalance.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">kdump.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx@server.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">postfix.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">remote-fs.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">rhel-configure.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">rsyslog.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sshd.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">tuned.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>之所以有这些 wants 目录，并且其中有一些 Unit 文件，是因为在 Service 配置文件(或其它 Unit) 中的 <!-- -->[<!-- -->Install<!-- -->]<!-- --> 段落使用了 WantedBy 指令。例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/sshd.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">WantedBy</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">multi-user.target  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 关键句</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当使用 systemctl enable Unit<!-- -->_<!-- -->Name 让 Unit<!-- -->_<!-- -->Name 开机自启动时，会寻找该 <!-- -->[<!-- -->Install<!-- -->]<!-- --> 中的 WantedBy 和 RequiredBy，并在对应的 /etc/systemd/system/xxx.target.wants 或 /etc/systemd/system/xxx.target.requires 目录下创建软链接。</p><p>如果 Service 配置文件中没有定义 WantedBy 和 RequiredBy，则 systemctl enable 操作不会有任何效果。</p><p>此外，可以在 target 配置文件内部使用 Wants、Requires 等表示依赖含义的指令来定义该 target 依赖哪些 Unit。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/sysinit.target</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Description</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">System Initialization</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Documentation</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">man:systemd.special</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Conflicts</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">emergency.service emergency.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Wants</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">local-fs.target swap.target           </span><span class="token comment" style="color:rgb(0, 128, 0)"># 关键句</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">After</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">local-fs.target swap.target emergency.service emergency.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>.target 文件中 Wants 指令定义的更符合依赖的含义，而 .target.wants 目录更倾向于表明该 target 中归类了哪些要运行的服务。</p><p>比如负责系统环境初始化的 sysinit.target，其中的 Wants 指令定义了必须先运行且成功运行文件系统相关任务(local-fs.target 和 swap.target) 后才运行 sysinit.target，也就是开始启动 .target.wants 目录下的 Unit。</p><p>执行 systemctl list-units --type target 可以查看系统当前已经加载的所有 target，包括那些开机自启动过程中启动的。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl list-units --type target </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">UNIT                  LOAD   ACTIVE SUB    DESCRIPTION</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">basic.target          loaded active active Basic System</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">c.target              loaded active active c.service, consists of a.service and b.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">cryptsetup.target     loaded active active Local Encrypted Volumes</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">getty.target          loaded active active Login Prompts</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">local-fs-pre.target   loaded active active Local File Systems </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">Pre</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">local-fs.target       loaded active active Local File Systems</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">multi-user.target     loaded active active Multi-User System</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">network-online.target loaded active active Network is Online</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">network-pre.target    loaded active active Network </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">Pre</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">network.target        loaded active active Network</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">paths.target          loaded active active Paths</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">remote-fs.target      loaded active active Remote File Systems</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">slices.target         loaded active active Slices</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sockets.target        loaded active active Sockets</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">swap.target           loaded active active Swap</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sysinit.target        loaded active active System Initialization</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">timers.target         loaded active active Timers</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">LOAD   </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> Reflects whether the unit definition was properly loaded.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ACTIVE </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> The high-level unit activation state, i.e. generalization of SUB.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">SUB    </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> The low-level unit activation state, values depend on unit type.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">17</span><span class="token plain"> loaded </span><span class="token function" style="color:rgb(0, 0, 255)">units</span><span class="token plain"> listed. Pass --all to see loaded but inactive units, too.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">To show all installed unit files use </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;systemctl list-unit-files&#x27;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>除了上面展示的 target，在 /usr/lib/systemd/system 目录下还有很多 target。而且，只要用户想要对一类 Unit 进行分组归类，那么也可以自己定义 target。</p><p>但需要明确的是，target 可分为两类：</p><ol><li>可直接切换的 target(模拟运行级别)</li><li>不可直接切换的 target</li></ol><p>切换是什么意思？比如从当前的运行级别 3 切换到运行级别 5，将会启动运行级别 5 上的所有程序以及依赖程序，并停止当前已启动但运行级别 5 不需要的服务程序。这就是运行级别的切换，只是停止一些服务(或程序)、并启动另外一些服务而已。</p><p>切换 target 也一样，比如切换到 graphical.target 时，会启动目标 graphical.target 需要的所有服务，并停止当前已运行但目标 target 不需要的服务。</p><p>切换 target 的方式如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 切换到对应的target</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl isolate Target_Name</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 如：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl isolate default.target  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 切换到默认运行级别</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl isolate rescue.target   </span><span class="token comment" style="color:rgb(0, 128, 0)"># 切换到救援模式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 还支持如下命令</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl default</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl resuce</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl emergency</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl </span><span class="token function" style="color:rgb(0, 0, 255)">halt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl poweroff</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl </span><span class="token function" style="color:rgb(0, 0, 255)">reboot</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可查看或设置默认的运行级别：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">systemctl get-default</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl set-default Target_Name</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>设置默认运行级别，实际上是创建 /etc/systemd/system/default.target 指向对应 target 配置文件的软链接。</p><p>比如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl set-default multi-user.target </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Removed /etc/systemd/system/default.target.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Created symlink /etc/systemd/system/default.target → /usr/lib/systemd/system/multi-user.target.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>target 是否可直接切换，取决于 target 配置文件中是否定义了 AllowIsolate=yes 指令。比如 multi-user.target 是模拟运行级别的 target，肯定允许直接切换，而 network.target 定义的是网络启动任务，肯定不可以直接切换。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl cat multi-user.target </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Description</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">Multi-User System</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Documentation</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">man:systemd.special</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Requires</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">basic.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Conflicts</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">rescue.service rescue.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">After</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">basic.target rescue.service rescue.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">AllowIsolate</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">yes</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl show -p AllowIsolate network.target</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">AllowIsolate</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">no</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1137systemd-timer-定时任务">11.3.7、systemd timer 定时任务<a class="hash-link" href="#1137systemd-timer-定时任务" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11371cron-和-systemd-timer">11.3.7.1、Cron 和 Systemd Timer<a class="hash-link" href="#11371cron-和-systemd-timer" title="标题的直接链接">​</a></h4><p>Linux 环境下，cron 是使用最广泛的定时任务工具，但它有一些不方便的地方。比如它默认：</p><ul><li>只支持分钟级别精度的定时任务</li><li>定时规则太死板</li><li>当调度到本次任务时，如果上次调度的任务仍在执行，无法阻止本次任务重复执行(需结合 flock)</li><li>无法对定时任务可能消耗的大量资源做出限制</li><li>不支持只执行一次的定时点的计划任务</li><li>日志不直观，不方便调试任务</li></ul><p>因为 cron 不原生支持以上功能，所以当有以上相关需求时，只能在要调度的命令层次上寻找解决方案。</p><p>systemd 系统中包含了 timer 计时器组件，timer 可以完全替代 cron + at，它具有以下特性：</p><ul><li>可精确到微妙级别，其支持的时间单位包括：<ul><li>us(微秒)、ms(毫秒)、s(秒)、m(分)、h(时)、d(日)、w(周)</li><li>类似 cron 定义时间的方式(某年某月某日某时某分某秒以及时间段)</li></ul></li><li>可对定时任务做资源限制</li><li>可替代 cron 和 at 工具，且支持比 cron 更加灵活丰富的定时规则</li><li>不会重复执行定时任务<ul><li>如果触发定时任务时发现上次触发的任务还未执行完，那么本次触发的任务不会执行</li><li>而且 systemd 启动服务的操作具有幂等性，如果服务正在运行，启动操作将不做任何事，所以，甚至可以疯狂到每秒或每几秒启动一次服务，免去判断进程是否存在的过程</li></ul></li><li>集成到 journal 日志，方便调试任务，方便查看任务调度情况</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11372systemd-timer-示例每-3-秒运行一次">11.3.7.2、systemd timer 示例：每 3 秒运行一次<a class="hash-link" href="#11372systemd-timer-示例每-3-秒运行一次" title="标题的直接链接">​</a></h4><p>使用 systemd timer 定时任务时，需要同时编写两个文件：</p><ul><li>编写一个以 <code>.timer</code> 为后缀的 Systemd Unit，该文件描述定时任务如何定时</li><li>编写一个以 <code>.service</code> 为后缀的 Systemd Service Unit，该文件描述定时任务要执行的操作</li></ul><p>这两个文件名称通常保持一致(除了后缀部分)，它们可以放在：</p><ul><li>/etc/systemd/system 目录下</li><li>/usr/lib/systemd/system 目录下</li><li>~/.config/systemd/user 目录下，表示定义用户定时任务，用户登录后才触发</li></ul><p>例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/foo.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/lib/systemd/system/foo.timer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/etc/systemd/system/foo.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/etc/systemd/system/foo.timer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">~/.config/systemd/user/foo.timer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">~/.config/systemd/user/foo.service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>假设定义一个每 3 秒执行一次的任务，该任务用于检测页面是否正常，对应命令为 curl -s -o /dev/null -w &#x27;%{http<!-- -->_<!-- -->code}&#x27; &#x27;<a href="https://github.xn--com%27%2C-l73kl4vl2ix41a7uty2eso7dob0akh7bjgxblqfjtf/" target="_blank" rel="noopener noreferrer">https://github.com<!-- -->&#x27;<!-- -->，其结果为访问页面时响应的</a> HTTP 状态码。</p><p>先编写对应服务配置文件：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/curl_github.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> Written by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> testing timer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ExecStart </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /usr/bin/curl -s -o /dev/null -w </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;%{http_code}&#x27;</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;https://github.com&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>因为命令每次调用都只执行一次且快速退出，所以 Service 中使用了默认的 Type=simple。当然，也可以使用 Type=oneshot。</p><p>再编写定时器配置文件：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/curl_github.timer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> Written by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> testing timer, </span><span class="token function" style="color:rgb(0, 0, 255)">curl</span><span class="token plain"> per 3s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Timer</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">OnActiveSec </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> 1s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">OnUnitInactiveSec </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> 3s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">AccuracySec </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> 1us</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">RandomizedDelaySec </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">WantedBy </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> timers.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>再执行如下命令即可让定时器生效：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl daemon-reload </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl start curl_github.timer  # 启动定时器</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>显然，还支持如下命令来管理定时器：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">systemctl status xxx.timer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl stop xxx.timer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl restart xxx.timer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 和WantedBy的值有关，若WantedBy=timers.target，则本命令多余</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">systemctl </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"> xxx.timer</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>回头来分析一下定时器配置文件中涉及到的指令。</p><p>首先是该文件 <!-- -->[<!-- -->Install<!-- -->]<!-- --> 段中的最后一行 WantedBy=timers.target，它表示在开机时会自动启动该定时器，之所以会开机自动执行这些 timers 定时计划，是因为在 basic.target 中定义了 timer.target 依赖。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl list-dependencies --reverse timers.target | head -2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">timers.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">● └─basic.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>再看 Timer 段中定义定时器属性的指令。</p><ul><li>OnActiveSec 表示从该定时器启动(即systemctl start xxx.timer) 之后，多长时间触发定时器对应的任务，即执行对应的 Service 服务。本例是启动定时器后 1 秒，开始第一次执行任务单元 curl<!-- -->_<!-- -->github.service。</li><li>OnUnitInactiveSec 表示从上一次任务单元退出后，多长时间再次触发定时器对应的任务。比如在本例中，表示的含义是每次 curl<!-- -->_<!-- -->github.service 执行完成(即页面检测完成后退出)后 3 秒，再次触发该任务。</li><li>剩余两个指令 AccuracySec 和 RandomizedDelaySec，稍后再详细解释。因为在解释它们之前，需要学会观察定时任务的执行情况。</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11373定时任务的执行时间点">11.3.7.3、定时任务的执行时间点<a class="hash-link" href="#11373定时任务的执行时间点" title="标题的直接链接">​</a></h4><p>使用 systemctl list-timers 可以列出当前已经生效的定时器(即如果不停止它，则迟早会触发对应的定时任务)。它会按照下次要执行的时间点先后进行排序，最快要执行的任务在最前面。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl list-timers --no-pager</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">NEXT                         LEFT          LAST                         PASSED       UNIT                         ACTIVATES</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-06 00:36:40 EDT  1min 44s ago  Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-06 00:36:40 EDT  1min 44s ago curl_github.timer            curl_github.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-06 02:37:58 EDT  1h 59min left Thu </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-05 02:37:58 EDT  22h ago      systemd-tmpfiles-clean.timer systemd-tmpfiles-clean.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">n/a                          n/a           Tue </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-03 09:58:56 EDT  </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> days ago   systemd-readahead-done.timer systemd-readahead-done.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> timers listed.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Pass --all to see loaded but inactive timers, too.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>NEXT 表示下一次要触发定时任务的时间点</li><li>LEFT 表示现在距离下次执行任务还剩多长时间(已经确定了下一次执行的时间点)，或者显示最近一次执行任务已经过去了多长时间(还不确定下一次执行的时间点)，稍后解释了 AccuracySec 和 RandomizedDelaySec 就知道为什么会有这两种表示方式</li><li>LAST 表示上次触发定时任务的时间点</li><li>PASSED 表示距离上一次执行任务已经过去多久</li><li>UNIT 表示是哪个定时器</li><li>ACTIVATES 表示该定时器所触发的任务</li></ul><p>虽然上面的含义都比较清晰，但是想要理解透彻，还真不容易。</p><p>不过，还有其它观察定时任务执行情况的方式。由于 systemd service 默认集成了 journald 日志系统，命令的标准输出和标准错误都会输出到 journal 日志中。</p><p>比如，可以使用 systemctl status xxx.service 观察定时器对应任务的执行状况，即每次执行任务的时间点以及定时任务执行过程中的标准输出、标准错误信息。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl status curl_github.service  # 注意是.service不是.timer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">● curl_github.service - Written by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> testing timer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Loaded: loaded </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">/usr/lib/systemd/system/curl_github.service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> static</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> vendor preset: disabled</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   Active: active </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">running</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> since Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-06 </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:42:42 CST</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> 1min 32s ago</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> Main PID: </span><span class="token number" style="color:rgb(9, 134, 88)">12172</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">curl</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   CGroup: /system.slice/curl_github.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           └─12172 /usr/bin/curl -s -o /dev/null -w %</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">http_code</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"> https://github.com</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Aug 06 </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:42:42 arm64v8 systemd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">: Started Written by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> testing timer.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Aug 06 </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:42:42 arm64v8 systemd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">: Starting Written by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> testing </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Hint: Some lines were ellipsized, use -l to show </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> full.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>还可以使用 journalctl 工具来查看定时任务的日志信息：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 查看指定服务的所有journal日志信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># xxx.service是定时任务的名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">journalctl -u xxx.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 实时监控尾部日志，类似tail -f</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">journalctl -f -u xxx.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 显示指定时间段内的日志</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># --since：从指定时间点内开始的日志</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># --until：到指定时间点为止的日志</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">journalctl -u xxx.service --since</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;2021-08-06 12:56:23&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">journalctl -u xxx.service --since</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;60s ago&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">journalctl -u xxx.service --since</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;1min ago&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">journalctl -u curl_github.service --since</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;-120s&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@arm64v8 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># journalctl -u curl_github.service --since=&quot;-30s&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-- Logs begin at Tue </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-03 </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain">:58:10 CST, end at Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-06 </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:59:36 CST. --</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Aug 06 </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:59:08 arm64v8 systemd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">: Started Written by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> testing timer.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Aug 06 </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:59:08 arm64v8 systemd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">: Starting Written by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> testing timer.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Aug 06 </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:59:14 arm64v8 curl</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">12355</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">: </span><span class="token number" style="color:rgb(9, 134, 88)">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Aug 06 </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:59:17 arm64v8 systemd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">: Started Written by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> testing timer.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Aug 06 </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:59:17 arm64v8 systemd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">: Starting Written by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> testing timer.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Aug 06 </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:59:25 arm64v8 curl</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">12359</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">: </span><span class="token number" style="color:rgb(9, 134, 88)">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Aug 06 </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:59:28 arm64v8 systemd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">: Started Written by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> testing timer.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Aug 06 </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:59:28 arm64v8 systemd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">: Starting Written by Brinnatt@gmail.com </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> testing timer.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Aug 06 </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:59:36 arm64v8 curl</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">12363</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">: </span><span class="token number" style="color:rgb(9, 134, 88)">200</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从结果可以看出，在 Aug 06 12:59:08、Aug 06 12:59:17 都执行了 page<!-- -->_<!-- -->test 任务。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11374accuracysec-和-randomizeddelaysec">11.3.7.4、AccuracySec 和 RandomizedDelaySec<a class="hash-link" href="#11374accuracysec-和-randomizeddelaysec" title="标题的直接链接">​</a></h4><p>AccuracySec 表示任务推迟执行的延迟范围，即从每次指定要执行任务的精确时间点到延迟时间段内的一个随机时间点启动任务。使用这种延迟，主要是为了避免 systemd 频繁触发定时器事件而频繁唤醒 CPU，从而让一定时间段内附近的定时任务可以集中在这个时间段内启动。</p><ul><li>比如说有多个定时任务都设置了每分钟执行一次，那么在每分钟时间段内，systemd 可能在这一分钟的第 10 秒执行一个定时任务，第 11 秒执行下一个定时任务，第 12 秒再执行下一个，依次类推。</li><li>所以，AccuracySec 的目的便是将一定范围内的定时器事件合并到这个时间段内的同一个时间点上，然后一次性触发所有在范围内的定时器任务。</li></ul><p>例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 定时器启动后，再过10分钟第一次触发定时任务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">OnActiveSec</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">10m</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 每次执行完任务后，再过15分钟后再次触发定时任务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">OnUnitInactiveSec</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">15m</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 触发事件后，允许推迟0-10分钟再执行被触发的任务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">AccuracySec</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">10m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>所以，以上指令的效果是：</p><ul><li>启动定时器后的 10m - 20m 内的任一时间点触发第一次定时任务</li><li>之后每隔 15m - 25m 再次触发定时任务</li></ul><p>AccuracySec 的默认值为 1 分钟，所以如果不定义 AccuracySec 的话，即使用户期待的是每秒触发一次定时任务，但事实却是会在 1s - 61s 时间段内的一个随机时间点触发一次定时任务。</p><p>但是，触发定时任务的时间点并不表示这是执行任务的时间点。触发了定时任务，还需要根据 RandomizedDelaySec 的值来决定何时执行定时任务。</p><p>RandomizedDelaySec 指定触发定时任务后还需延迟一个指定范围内的随机时长才执行任务。该指令默认值为 0，表示触发后立即执行任务。</p><p>使用 RandomizedDelaySec，主要是为了在一个时间范围内分散大量被同时触发的定时任务，从而避免这些定时任务集中在同一时间点执行而 CPU 争抢。</p><p>可见，AccuracySec 和 RandomizedDelaySec 的目的是相反的：</p><ul><li>前者让指定范围内的定时器集中在同一个时间点一次性触发它们的定时任务</li><li>后者让触发的、将要被执行的任务均匀分散在一个时间段范围内</li></ul><p>根据以上描述，如果用户想要让定时任务非常精确度地执行，需要将它们设置的足够小。例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">AccuracySec </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> 1ms        </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定时器到点就触发定时任务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">RandomizedDelaySec </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">   </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定时任务一触发就立刻执行任务</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11375systemd-timer-支持的单调定时规则">11.3.7.5、systemd timer 支持的单调定时规则<a class="hash-link" href="#11375systemd-timer-支持的单调定时规则" title="标题的直接链接">​</a></h4><p>systemd timer 还支持几种其它的定时器规则。</p><table><thead><tr><th>定时器指令</th><th>含义</th></tr></thead><tbody><tr><td>OnBootSec</td><td>从开机启动后，即从内核开始运行算起，多长时间触发定时器对应任务</td></tr><tr><td>OnStartupSec</td><td>从 systemd 启动后，即内核启动 init 进程算起，多长时间触发定时器对应任务</td></tr><tr><td>OnActiveSec</td><td>从该定时器启动后，多长时间触发定时器对应的任务</td></tr><tr><td>OnUnitInactiveSec</td><td>从上次任务单元退出后，多长时间再次触发定时器对应的任务</td></tr><tr><td>OnUnitActiveSec</td><td>从上次触发的任务开始执行(状态达到 active) 算起，多长时间再次触发定时器对应的任务</td></tr><tr><td>(1) 当 Service 文件中 Type=oneshot，这类任务不会出现 active 状态，除非配置了 RemainAfterExit 指令(参考 man systemd.service)</td><td></td></tr><tr><td>(2) 这个定时器用的不如 OnUnitInactiveSec 多，因为这个定时器是以启动时间为基准的，有可能下次触发任务时，上次任务还没有执行完成，systemd 会忽略下次任务</td><td></td></tr></tbody></table><p>其中 OnBootSec 和 OnStartupSec 比较特殊，因为定时器自身的启动比这两个时间点要晚，如果定时器配置文件中以这两个指令为定时任务的触发基准，可能会出现超期现象。</p><ul><li>比如某定时器设置 OnBootSec=1s，但如果从启动内核到启动定时器已经过了 2s，那么这个定时任务就超期了。</li><li>好在，systemd 会对这两个特殊的指令特殊对待，如果这类定时任务超期了，将立即执行定时任务实现补救。</li></ul><p>但对其它三个指令定义的定时器，超期了就超期了，不会再尝试去补救。也就是说，即使过了有效期，这两类定时任务还是有效的，而其它定时任务则失效。</p><p>事实上，这几个定时器指令都是单调定时器，即：这些任务的触发时机，总是以某个时间点为基准单调增加的。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11376更为灵活的定时规则oncalendar">11.3.7.6、更为灵活的定时规则：OnCalendar<a class="hash-link" href="#11376更为灵活的定时规则oncalendar" title="标题的直接链接">​</a></h4><p>cron 定时任务支持 <!-- -->*<!-- --> <!-- -->*<!-- --> <!-- -->*<!-- --> <!-- -->*<!-- --> <!-- -->*<!-- --> 来定义定时任务，这 5 个位置分别表示分 时 日 月 周。</p><p>前面已经介绍的 systemd timer 的定时规则已经能够实现只执行一次和每隔多久执行一次的定时规则。下面要介绍的 OnCalendar 基于日历的定时规则完全可以胜任 cron 的定时规则。</p><p>例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">OnCalendar </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> Thu,Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-*-1,5 </span><span class="token number" style="color:rgb(9, 134, 88)">11</span><span class="token plain">:12:13</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>这表示 2012 年每个月的 1 或 5 号的 11 点 12 分 13 秒，同时要求是周四或周五。</li></ul><p>systemd timer 可识别的时间单位包括以下几种：</p><ul><li>微秒级单位：usec, us, µs</li><li>毫秒级单位：msec, ms</li><li>秒级单位(省略单位时的默认单位)：seconds, second, sec, s</li><li>分钟级单位：minutes, minute, min, m</li><li>小时级单位：hours, hour, hr, h</li><li>天的单位：days, day, d</li><li>周的单位：weeks, week, w<ul><li>使用周单位时，必须使用三字母表示法或英文全称，如 Fri、Sun、Monday</li></ul></li><li>月的单位：months, month, M</li><li>年的单位(一年以365.25天算)：years, year, y</li></ul><p>多个时间单位可结合使用，且时间的出现顺序无关。</p><p>例如下面的时间单位都是有效的：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> h              --</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">小时</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">2hours           --</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">小时</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">48hr             --</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">48</span><span class="token plain">小时</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">1y 12month       --</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">年12个月，即2年</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">55s500ms         --</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">55</span><span class="token plain">秒+500毫秒</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">300ms20s 5day    --</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">天+20秒+300毫秒，顺序无关</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在定时器里，还会经常用到表示某年某月某日、某时某分某秒的时间戳格式。systemd 内部的标准时间戳格式为：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 </span><span class="token number" style="color:rgb(9, 134, 88)">11</span><span class="token plain">:12:13</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 </span><span class="token number" style="color:rgb(9, 134, 88)">11</span><span class="token plain">:12:13 UTC</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>涉及到时区格式，可以设计得更复杂，但实际上没有必要，要么不带时区即默认本地，要么只带 UTC。</p><p>最前面的周几可以省略，但如果不省略，则必须只能使用三字母表示法或英文全称，即合理的周几符号包括：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">Monday      Mon</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Tuesday     Tue</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Wednesday   Wed</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Thursday    Thu</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Friday      Fri</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Saturday    Sat</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Sunday      Sun</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>年-月-日</code> 与 <code>时:分:秒</code> 二者可省其一，但不可全省。若省前者，则表示使用当前日期，若省后者则表示使用 <code>00:00:00</code>。</p><p><code>时:分:秒</code> 可以省略 <code>:秒</code>，相当于使用 <code>:00</code>。</p><p><code>年-月-日</code> 中的 <code>年</code> 可以省略为2位数字表示，相当于 <code>20xx</code>，但强烈建议不要使用这种方式。</p><p>如果指定的 <code>星期</code> 与 <code>年-月-日</code>(即使此部分已被省略) 与实际不相符，那么该时间戳无效。</p><p>还可以使用一些时间戳关键字：<code>now</code>, <code>today</code>, <code>yesterday</code>, <code>tomorrow</code>。</p><p>还可以使用一些相对时间表示法：时长加上 <code>+</code> 前缀或者 <code>&#x27; left&#x27;</code> 后缀(注意有空格)，表示以此时间为基准向未来前进指定的时长，时长加上 <code>-</code> 前缀或者 <code>&#x27; ago&#x27;</code> 后缀(注意有空格)，表示以此时间为基准向过去倒退指定的时长。</p><p>最后，时长加上 <code>@</code> 前缀表示相对于UNIX时间原点(1970-01-01 00:00:00 UTC) 之后多长时间。</p><p>以下都是有效时间：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 假设当前时间为2012-11-23 18:15:22，时区为UTC+8，例如“TZ=:Asia/Shanghai”):</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 </span><span class="token number" style="color:rgb(9, 134, 88)">11</span><span class="token plain">:12:13 → Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 </span><span class="token number" style="color:rgb(9, 134, 88)">11</span><span class="token plain">:12:13</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 </span><span class="token number" style="color:rgb(9, 134, 88)">11</span><span class="token plain">:12:13 → Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 </span><span class="token number" style="color:rgb(9, 134, 88)">11</span><span class="token plain">:12:13</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 </span><span class="token number" style="color:rgb(9, 134, 88)">11</span><span class="token plain">:12:13 UTC → Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 </span><span class="token number" style="color:rgb(9, 134, 88)">19</span><span class="token plain">:12:13</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">               </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 → Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                 </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">-11-23 → Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                 </span><span class="token number" style="color:rgb(9, 134, 88)">11</span><span class="token plain">:12:13 → Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 </span><span class="token number" style="color:rgb(9, 134, 88)">11</span><span class="token plain">:12:13</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token number" style="color:rgb(9, 134, 88)">11</span><span class="token plain">:12 → Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 </span><span class="token number" style="color:rgb(9, 134, 88)">11</span><span class="token plain">:12:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                      now → Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 </span><span class="token number" style="color:rgb(9, 134, 88)">18</span><span class="token plain">:15:22</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    today → Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                today UTC → Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 </span><span class="token number" style="color:rgb(9, 134, 88)">16</span><span class="token plain">:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                yesterday → Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-22 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                 tomorrow → Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-24 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">tomorrow Pacific/Auckland → Thu </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 </span><span class="token number" style="color:rgb(9, 134, 88)">19</span><span class="token plain">:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                 +3h30min → Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 </span><span class="token number" style="color:rgb(9, 134, 88)">21</span><span class="token plain">:45:22</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                      -5s → Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 </span><span class="token number" style="color:rgb(9, 134, 88)">18</span><span class="token plain">:15:17</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                11min ago → Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-11-23 </span><span class="token number" style="color:rgb(9, 134, 88)">18</span><span class="token plain">:04:22</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              @1395716396 → Tue </span><span class="token number" style="color:rgb(9, 134, 88)">2014</span><span class="token plain">-03-25 03:59:56</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>OnCalendar 指令使用基于日历的定时规则，基于日历的格式是对 systemd 标准时间戳的扩展：在标准时间戳的基础上，可以使用一些额外的语法。这些额外的语法包括：</p><ul><li><p>可使用 <code>,</code> 列出离散值，可使用 <code>..</code> 表示一个范围</p></li><li><p>对于 <code>年-月-日</code> 和 <code>时:分:秒</code> 这两部分的每个子部分：</p><ul><li>可使用 <code>*</code> 表示匹配任意值</li><li>可使用 <code>/N</code>(N是整数) 后缀表示每隔 N 个单位，特别地 <code>/1</code> 表示每次增加一个单位</li></ul></li><li><p>对于 <code>年-月-日</code> 部分，可使用 <code>月~日</code> 替代 <code>月-日</code> 表示一个月中的倒数第 N 天</p></li><li><p>对于 <code>秒</code>，可使用小数表示更高精度，最高精度为 6 位小数</p></li><li><p>以下特殊表达式可以作为较长的规范化形式的简写：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">  minutely → *-*-* *:*:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    hourly → *-*-* *:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">     daily → *-*-* 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   monthly → *-*-01 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    weekly → Mon *-*-* 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    yearly → *-01-01 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> quarterly → *-01,04,07,10-01 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">semiannually → *-01,07-01 00:00:00</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>minutely：每分钟</li><li>hourly：每小时</li><li>daily：每天</li><li>monthly：每月</li><li>weekly：每周</li><li>yearly：每年</li><li>quarterly：每季度</li><li>semiannually：每半年</li></ul></li></ul><p>有效时间戳及其规范化形式的示例：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">  Sat,Thu,Mon</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">Wed,Sat</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">Sun → Mon</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">Thu,Sat,Sun *-*-* 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      Mon,Sun </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">-*-* </span><span class="token number" style="color:rgb(9, 134, 88)">2,1</span><span class="token plain">:23 → Mon,Sun </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-*-* 01,02:23:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    Wed *-1 → Wed *-*-01 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           Wed</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">Wed,Wed *-1 → Wed *-*-01 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                 Wed, </span><span class="token number" style="color:rgb(9, 134, 88)">17</span><span class="token plain">:48 → Wed *-*-* </span><span class="token number" style="color:rgb(9, 134, 88)">17</span><span class="token plain">:48:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Wed</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">Sat,Tue </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">-10-15 </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">:2:3 → Tue</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">Sat </span><span class="token number" style="color:rgb(9, 134, 88)">2012</span><span class="token plain">-10-15 01:02:03</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                *-*-7 </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">:0:0 → *-*-07 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                      </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token plain">-15 → *-10-15 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        monday *-12-* </span><span class="token number" style="color:rgb(9, 134, 88)">17</span><span class="token plain">:00 → Mon *-12-* </span><span class="token number" style="color:rgb(9, 134, 88)">17</span><span class="token plain">:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  Mon,Fri *-*-3,1,2 *:30:45 → Mon,Fri *-*-01,02,03 *:30:45</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       </span><span class="token number" style="color:rgb(9, 134, 88)">12,14</span><span class="token plain">,13,12:20,10,30 → *-*-* </span><span class="token number" style="color:rgb(9, 134, 88)">12,13</span><span class="token plain">,14:10,20,30:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token number" style="color:rgb(9, 134, 88)">14</span><span class="token plain">:10,20,30 → *-*-* </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token number" style="color:rgb(9, 134, 88)">14</span><span class="token plain">:10,20,30:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  mon,fri *-1/2-1,3 *:30:45 → Mon,Fri *-01/2-01,03 *:30:45</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">             03-05 08:05:40 → *-03-05 08:05:40</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                   08:05:40 → *-*-* 08:05:40</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                      05:40 → *-*-* 05:40:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">     Sat,Sun </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">-05 08:05:40 → Sat,Sun *-12-05 08:05:40</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           Sat,Sun 08:05:40 → Sat,Sun *-*-* 08:05:40</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           </span><span class="token number" style="color:rgb(9, 134, 88)">2003</span><span class="token plain">-03-05 05:40 → </span><span class="token number" style="color:rgb(9, 134, 88)">2003</span><span class="token plain">-03-05 05:40:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> 05:40:23.4200004/3.1700005 → *-*-* 05:40:23.420000/3.170001</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">             </span><span class="token number" style="color:rgb(9, 134, 88)">2003</span><span class="token plain">-02</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">04-05 → </span><span class="token number" style="color:rgb(9, 134, 88)">2003</span><span class="token plain">-02</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">04-05 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       </span><span class="token number" style="color:rgb(9, 134, 88)">2003</span><span class="token plain">-03-05 05:40 UTC → </span><span class="token number" style="color:rgb(9, 134, 88)">2003</span><span class="token plain">-03-05 05:40:00 UTC</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                 </span><span class="token number" style="color:rgb(9, 134, 88)">2003</span><span class="token plain">-03-05 → </span><span class="token number" style="color:rgb(9, 134, 88)">2003</span><span class="token plain">-03-05 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                      03-05 → *-03-05 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                     hourly → *-*-* *:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                      daily → *-*-* 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                  daily UTC → *-*-* 00:00:00 UTC</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    monthly → *-*-01 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                     weekly → Mon *-*-* 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    weekly Pacific/Auckland → Mon *-*-* 00:00:00 Pacific/Auckland</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                     yearly → *-01-01 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                   annually → *-01-01 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                      *:2/3 → *-*-* *:02/3:00</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当不明确一个基于日历表示法的时间时，可使用神器 <code>systemd-analyize calendar</code> 命令来分析(早期 systemd 版本不支持 calendar 子命令)。</p><p>例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemd-analyze calendar Sat,Mon..Wed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  Original form: Sat,Mon</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">Wed             </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Normalized form: Mon</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">Wed,Sat *-*-* 00:00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Next elapse: Sat </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-07 00:00:00 CST</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">in UTC</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">: Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-06 </span><span class="token number" style="color:rgb(9, 134, 88)">16</span><span class="token plain">:00:00 UTC</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       From now: 9h left                  </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemd-analyze calendar &quot;*-05~07/1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  Original form: *-05~07/1                </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Normalized form: *-05~07/1 00:00:00       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Next elapse: Wed </span><span class="token number" style="color:rgb(9, 134, 88)">2022</span><span class="token plain">-05-25 00:00:00 CST</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">in UTC</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">: Tue </span><span class="token number" style="color:rgb(9, 134, 88)">2022</span><span class="token plain">-05-24 </span><span class="token number" style="color:rgb(9, 134, 88)">16</span><span class="token plain">:00:00 UTC</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       From now: </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain"> months </span><span class="token number" style="color:rgb(9, 134, 88)">17</span><span class="token plain"> days left    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemd-analyze calendar &quot;Mon *-05~07/1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  Original form: Mon *-05~07/1            </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Normalized form: Mon *-05~07/1 00:00:00   </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Next elapse: Mon </span><span class="token number" style="color:rgb(9, 134, 88)">2022</span><span class="token plain">-05-30 00:00:00 CST</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">in UTC</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">: Sun </span><span class="token number" style="color:rgb(9, 134, 88)">2022</span><span class="token plain">-05-29 </span><span class="token number" style="color:rgb(9, 134, 88)">16</span><span class="token plain">:00:00 UTC</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       From now: </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain"> months </span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"> days left    </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11377unit-和-persistent">11.3.7.7、Unit 和 Persistent<a class="hash-link" href="#11377unit-和-persistent" title="标题的直接链接">​</a></h4><p><code>[Timer]</code> 段中还可以使用 <code>Unit</code> 指令和 <code>Persistent</code> 指令。</p><ul><li>Unit=xxx.service：默认情况下，a.timer 对应要执行的任务文件是 a.service，使用 Unit 指令可以明确指定触发定时任务事件时要执行的文件</li><li>Persistent=yes/no：只在使用了 OnCalendar 时有效，默认值 no。设置 yes 时，会将上次执行任务的时间点保存在磁盘上，使得定时器再次被启动时，可以立即判断是否要执行丢失的任务<ul><li>以空文件方式保存，以该空文件的 atime/mtime/ctime 信息记录执行任务的时间点</li><li>文件保存路径：/var/lib/systemd/timers，或 ~/.local/share/systemd/(用户级定时器保存路径)</li><li>可删除这些时间戳文件，使得不会立即触发丢失的任务</li></ul></li></ul><p>比如下面的定时任务表示每天凌晨执行任务。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">OnCalendar </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> 00:00</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Persistent </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">yes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>因为使用了 Persistent，所以每次执行完任务后都会将本次执行的时间点记录在磁盘文件中，如果在 23:59:50 时遇到一次重启耽搁 1 分钟，那么在重启成功后会立即执行该任务。</p><p>如果 Persistent=no，则在重启后不会立即执行任务，而是等到下一个凌晨才执行任务。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11378systemd-timer-用户级定时任务">11.3.7.8、systemd timer 用户级定时任务<a class="hash-link" href="#11378systemd-timer-用户级定时任务" title="标题的直接链接">​</a></h4><p>用户级定时器在用户登录后开始启动，用户退出时(所有使用该用户启动的终端的会话都断开) 停止。</p><p>用户级定时器要求将 .timer 和对应的 .service 定义在 ~/.config/systemd/user/ 目录下。如果使用了 OnCalendar 和 Persisten 指令，时间戳文件保存在 ~/.local/share/systemd/ 目录下。</p><p>例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># mkdir -p ~/.config/systemd/user</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat ~/.config/systemd/user/test.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> current </span><span class="token function" style="color:rgb(0, 0, 255)">time</span><span class="token plain"> when task is been executed</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ExecStart </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /bin/bash -c </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;/usr/bin/date +&quot;%%T&quot; &gt;&gt;/tmp/a.log&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat ~/.config/systemd/user/test.timer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> user login timer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Timer</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">AccuracySec </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> 1ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">RandomizedDelaySec </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">OnCalendar </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> *:*:*</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">WantedBy </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> timer.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>再启动用户定时器：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl --user daemon-reload </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl --user start test.timer </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl --user list-timers </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">NEXT                         LEFT       LAST                         PASSED    UNIT       AC</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-06 </span><span class="token number" style="color:rgb(9, 134, 88)">15</span><span class="token plain">:01:57 CST  510ms left Fri </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain">-08-06 </span><span class="token number" style="color:rgb(9, 134, 88)">15</span><span class="token plain">:01:56 CST  488ms ago test.timer te</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> timers listed.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Pass --all to see loaded but inactive timers, too.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>查看定时器触发的任务状态：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl --user status test.service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>停止定时器：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl --user stop test.timer</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11379systemd-临时定时任务">11.3.7.9、systemd 临时定时任务<a class="hash-link" href="#11379systemd-临时定时任务" title="标题的直接链接">​</a></h4><p>systemd-run 命令支持定时器类选项，所以通过 systemd-run 可以启动临时的定时任务。systemd-run 支持的定时器选项有：</p><ul><li>–on-boot</li><li>–on-startup</li><li>–on-unit-active</li><li>–on-unit-inactive</li><li>–on-active</li><li>–on-calendar</li></ul><p>此外还支持 --timer-property 选项定义 <!-- -->[<!-- -->Timer<!-- -->]<!-- --> 中的指令。</p><p>例如：定时 30 秒，执行一次任务后自动退出</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 执行完该命令后，再过 30 秒执行 sed，精确触发</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /tmp/testfile </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemd-run --on-active=30 --timer-property=AccuracySec=100ms sed -i &quot;/^#$/a \# hello world&quot; /tmp/testfile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Running timer as unit: run-r8bfd007edb734b399027a2b1441a09a7.timer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Will run </span><span class="token function" style="color:rgb(0, 0, 255)">service</span><span class="token plain"> as unit: run-r8bfd007edb734b399027a2b1441a09a7.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 30秒后</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /tmp/testfile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># hello world</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>例如：每隔 2 秒，执行一次任务</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemd-run --on-calendar=&quot;*:*:1/2&quot; --timer-property=&quot;AccuracySec=1us&quot; --timer-property=&quot;RandomizedDelaySec=0&quot; sed -i &quot;/^#$/a \# hello world&quot; /tmp/testfile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Running timer as unit: run-r0235cfa3d8b34083ab5c5f68f5f7bf29.timer</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Will run </span><span class="token function" style="color:rgb(0, 0, 255)">service</span><span class="token plain"> as unit: run-r0235cfa3d8b34083ab5c5f68f5f7bf29.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># wc -l /tmp/testfile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain"> /tmp/testfile</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># wc -l /tmp/testfile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain"> /tmp/testfile</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># wc -l /tmp/testfile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain"> /tmp/testfile</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>执行完成后，会报告所执行的 timer unit 和 service unit，可通过这个值来查看状态或管理它们。例如，停止这个临时定时器：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl stop run-r0235cfa3d8b34083ab5c5f68f5f7bf29.timer</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong><em>注意：上面两个例子使用 sed 是为了达到实验效果，千万要小心，使用 systemd-run 命令生成的 service 默认是使用 Type=simple 类型，如果想要自定义类型请使用 -u 选项指定 service 文件。</em></strong></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="113710限制定时任务的资源使用量">11.3.7.10、限制定时任务的资源使用量<a class="hash-link" href="#113710限制定时任务的资源使用量" title="标题的直接链接">​</a></h4><p>有些定时任务可能会消耗大量资源，比如执行 rsync 的定时任务、执行数据库备份的定时任务，等等，它们可能会消耗网络带宽，消耗 IO 带宽，消耗 CPU 等资源。</p><p>想要控制这些定时任务的资源使用量也非常简单，因为真正执行任务的是 .service，而 Service 配置文件中可以轻松地配置一些资源控制指令或直接使用 Slice 定义的 CGroup。这些资源控制类的指令可参考 man systemd.resource-control。</p><p>例如，直接在 <!-- -->[<!-- -->Service<!-- -->]<!-- --> 中定义资源控制指令：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">simple</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">MemoryLimit</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">20M</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecStart</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/usr/bin/backup.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>又或者让 Service 使用定义好的 Slice：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecStart</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/usr/bin/backup.sh</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Slice</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">backup.slice</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中 backup.slice 的内容为：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@kylinv10 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/lib/systemd/system/backup.slice</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Description</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">Limited resources Slice</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">DefaultDependencies</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">no</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Before</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">slices.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Slice</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">CPUQuota</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">50</span><span class="token plain">%</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">MemoryLimit</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">20M</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/linux-primary-10"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">第 10 章 Linux 系统资源监控</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/linux-primary-12"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">第 12 章 Linux 定时任务</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#111服务的概念" class="table-of-contents__link toc-highlight">11.1、服务的概念</a></li><li><a href="#112服务类型" class="table-of-contents__link toc-highlight">11.2、服务类型</a><ul><li><a href="#1121独立守护进程" class="table-of-contents__link toc-highlight">11.2.1、独立守护进程</a></li><li><a href="#1122xinetd-超级守护进程" class="table-of-contents__link toc-highlight">11.2.2、xinetd 超级守护进程</a><ul><li><a href="#11221管理瞬时守护进程" class="table-of-contents__link toc-highlight">11.2.2.1、管理瞬时守护进程</a></li><li><a href="#11222瞬时守护进程的配置" class="table-of-contents__link toc-highlight">11.2.2.2、瞬时守护进程的配置</a></li><li><a href="#11223xinetd-守护-sshd" class="table-of-contents__link toc-highlight">11.2.2.3、xinetd 守护 sshd</a></li></ul></li><li><a href="#1123管理服务开机自启" class="table-of-contents__link toc-highlight">11.2.3、管理服务开机自启</a></li></ul></li><li><a href="#113systemd-服务" class="table-of-contents__link toc-highlight">11.3、systemd 服务</a><ul><li><a href="#1131初识-systemd" class="table-of-contents__link toc-highlight">11.3.1、初识 systemd</a><ul><li><a href="#11311systemd-可管理哪些服务" class="table-of-contents__link toc-highlight">11.3.1.1、systemd 可管理哪些服务</a></li><li><a href="#11312systemd-管理服务的命令" class="table-of-contents__link toc-highlight">11.3.1.2、systemd 管理服务的命令</a></li><li><a href="#11313systemd-所管理服务的状态" class="table-of-contents__link toc-highlight">11.3.1.3、systemd 所管理服务的状态</a></li></ul></li><li><a href="#1132systemd-服务配置文件" class="table-of-contents__link toc-highlight">11.3.2、systemd 服务配置文件</a><ul><li><a href="#11321systemd-service" class="table-of-contents__link toc-highlight">11.3.2.1、systemd service</a></li><li><a href="#11322systemd-配置文件路径" class="table-of-contents__link toc-highlight">11.3.2.2、systemd 配置文件路径</a></li><li><a href="#11323systemd-service-文件格式" class="table-of-contents__link toc-highlight">11.3.2.3、systemd service 文件格式</a></li><li><a href="#11324systemd-servicetypeforking" class="table-of-contents__link toc-highlight">11.3.2.4、systemd service：Type=forking</a></li><li><a href="#11325systemd-servicetypesimple" class="table-of-contents__link toc-highlight">11.3.2.5、systemd service：Type=simple</a></li><li><a href="#11326systemd-service其它-type" class="table-of-contents__link toc-highlight">11.3.2.6、Systemd Service：其它 Type</a></li></ul></li><li><a href="#1133模板型服务配置文件" class="table-of-contents__link toc-highlight">11.3.3、模板型服务配置文件</a></li><li><a href="#1134使用-target-组合多个服务" class="table-of-contents__link toc-highlight">11.3.4、使用 target 组合多个服务</a></li><li><a href="#1135systemd-开机自启任务" class="table-of-contents__link toc-highlight">11.3.5、systemd 开机自启任务</a><ul><li><a href="#11351systemd-服务开机自启" class="table-of-contents__link toc-highlight">11.3.5.1、systemd 服务开机自启</a></li><li><a href="#11352systemd-中自定义开机自启动命令脚本" class="table-of-contents__link toc-highlight">11.3.5.2、systemd 中自定义开机自启动命令/脚本</a></li></ul></li><li><a href="#1136systemd-运行级别" class="table-of-contents__link toc-highlight">11.3.6、systemd 运行级别</a></li><li><a href="#1137systemd-timer-定时任务" class="table-of-contents__link toc-highlight">11.3.7、systemd timer 定时任务</a><ul><li><a href="#11371cron-和-systemd-timer" class="table-of-contents__link toc-highlight">11.3.7.1、Cron 和 Systemd Timer</a></li><li><a href="#11372systemd-timer-示例每-3-秒运行一次" class="table-of-contents__link toc-highlight">11.3.7.2、systemd timer 示例：每 3 秒运行一次</a></li><li><a href="#11373定时任务的执行时间点" class="table-of-contents__link toc-highlight">11.3.7.3、定时任务的执行时间点</a></li><li><a href="#11374accuracysec-和-randomizeddelaysec" class="table-of-contents__link toc-highlight">11.3.7.4、AccuracySec 和 RandomizedDelaySec</a></li><li><a href="#11375systemd-timer-支持的单调定时规则" class="table-of-contents__link toc-highlight">11.3.7.5、systemd timer 支持的单调定时规则</a></li><li><a href="#11376更为灵活的定时规则oncalendar" class="table-of-contents__link toc-highlight">11.3.7.6、更为灵活的定时规则：OnCalendar</a></li><li><a href="#11377unit-和-persistent" class="table-of-contents__link toc-highlight">11.3.7.7、Unit 和 Persistent</a></li><li><a href="#11378systemd-timer-用户级定时任务" class="table-of-contents__link toc-highlight">11.3.7.8、systemd timer 用户级定时任务</a></li><li><a href="#11379systemd-临时定时任务" class="table-of-contents__link toc-highlight">11.3.7.9、systemd 临时定时任务</a></li><li><a href="#113710限制定时任务的资源使用量" class="table-of-contents__link toc-highlight">11.3.7.10、限制定时任务的资源使用量</a></li></ul></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">学习</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/tags">标签</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">归档</a></li><li class="footer__item"><a class="footer__link-item" href="/project">实战项目</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/linux">Linux</a></li></ul></div><div class="col footer__col"><div class="footer__title">社交媒体</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/about">关于我</a></li><li class="footer__item"><a href="https://github.com/zqingfa" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://juejin.cn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">掘金<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" position="right" href="/friends">友链</a></li><li class="footer__item"><a class="footer__link-item" position="right" href="/website">导航</a></li><li class="footer__item"><a href="https://docusaurus.io/zh-CN/" target="_blank"><img style="height:50px;margin-top:0.5rem" src="/img/buildwith.png"><a></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p><a href="http://beian.miit.gov.cn/">浙ICP备20024502号-1</a></p><p>Copyright © 2023 - PRESENT zhangqf Built with Docusaurus.</p></div></div></div></footer></div>
<script src="/assets/js/runtime~main.6d616132.js"></script>
<script src="/assets/js/main.26bbf6d2.js"></script>
</body>
</html>