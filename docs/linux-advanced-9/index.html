<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-linux/advanced/linux-advanced-9">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">第 9 章 Linux Nginx 服务配置 - Linux技术分享</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://zhangqf.com/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://zhangqf.com/img/logo.png"><meta data-rh="true" property="og:url" content="https://zhangqf.com/docs/linux-advanced-9"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="第 9 章 Linux Nginx 服务配置 - Linux技术分享"><meta data-rh="true" name="description" content="7.1、nginx 简介"><meta data-rh="true" property="og:description" content="7.1、nginx 简介"><meta data-rh="true" name="keywords" content="linux,nginx"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://zhangqf.com/docs/linux-advanced-9"><link data-rh="true" rel="alternate" href="https://zhangqf.com/en/docs/linux-advanced-9" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/linux-advanced-9" hreflang="zh"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/linux-advanced-9" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9B0V5WT2X8-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S4SD5NXWXF"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S4SD5NXWXF",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Linux技术分享" href="/opensearch.xml">
<link rel="preconnect" href="https://zhangqf.com/">
<script>var _paq=window._paq=window._paq||[];_paq.push(["setRequestMethod","POST"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),_paq.push(["enableHeartBeatTimer"]),function(){var e="https://zhangqf.com/";_paq.push(["setRequestMethod","POST"]),_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]);var a=document,t=a.createElement("script"),p=a.getElementsByTagName("script")[0];t.type="text/javascript",t.async=!0,t.src=e+"matomo.js",p.parentNode.insertBefore(t,p)}()</script>


<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?77dc6b24cf1d939292e9fe13be271a96",e.defer=!0;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<meta name="baidu-site-verification" content="code-rqLUw5reVS">
<script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",t.defer=!0;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script>
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="zhangqf RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="zhangqf Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="zhangqf JSON Feed">

<link rel="icon" href="/img/logo.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(51 139 255)"><link rel="stylesheet" href="/assets/css/styles.86c9ae18.css">
<link rel="preload" href="/assets/js/runtime~main.9e73f1b3.js" as="script">
<link rel="preload" href="/assets/js/main.39d37d57.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><span>更新 <a href="/website">网址导航</a> 带你发现感兴趣的技术</span></div><button type="button" aria-label="关闭" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">zhangqf</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/linux">Linux</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/category/Linux基础">Linux 基础</a></li><li><a class="dropdown__link" href="/docs/category/Linux进阶">Linux 进阶</a></li><li><a class="dropdown__link" href="/docs/category/Linux测试">Linux 测试</a></li><li><a class="dropdown__link" href="/docs/category/LinuxCICD">Linux CICD研发</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Blog</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tags">标签</a></li><li><a class="dropdown__link" href="/archive">归档</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/skill/">笔记</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">工具</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/tools/">工具推荐</a></li><li><a href="https://api.kuizuo.cn" target="_blank" rel="noopener noreferrer" class="dropdown__link">API服务</a></li><li><a href="https://js-de-obfuscator.vercel.app" target="_blank" rel="noopener noreferrer" class="dropdown__link">JS代码还原</a></li><li><a href="https://cipher.kuizuo.cn" target="_blank" rel="noopener noreferrer" class="dropdown__link">CyberChef加密</a></li></ul></div><a class="navbar__item navbar__link" href="/website">导航</a><a class="navbar__item navbar__link" href="/project">项目</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中文</a><ul class="dropdown__menu"><li><a href="/en/docs/linux-advanced-9" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-GB">English</a></li><li><a href="/docs/linux-advanced-9" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh">中文</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"><b>zhangqf</b></a><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/linux">linux</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/linux基础">Linux基础</a><button aria-label="打开/收起侧边栏菜单「Linux基础」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/linux进阶">Linux进阶</a><button aria-label="打开/收起侧边栏菜单「Linux进阶」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-1">第 1 章 Linux 进阶命令</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-2">第 2 章 Linux 防火墙</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-3">第 3 章 Linux NFS 网络文件系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-4">第 4 章 Linux DHCP 服务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-5">第 5 章 Linux DNS 服务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-6">第 6 章 Linux httpd 服务基础配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-7">第 7 章 Linux httpd 服务进阶配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-8">第 8 章 Linux httpd 服务高级配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/linux-advanced-9">第 9 章 Linux Nginx 服务配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-10">第 10 章 Linux Tomcat 服务基础配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-11">第 11 章 Linux Tomcat 服务实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-12">第 12 章 Linux haproxy 服务基础配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-13">第 13 章 Linux haproxy 服务进阶配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-14">第 14 章 Linux haproxy 服务高级配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-15">第 15 章 Linux LVS 服务配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/linux-advanced-16">第 16 章 Linux Keepalived 服务配置</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/linux测试">Linux测试</a><button aria-label="打开/收起侧边栏菜单「Linux测试」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/linuxcicd">Linux CICD研发</a><button aria-label="打开/收起侧边栏菜单「Linux CICD研发」" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/linux进阶"><span itemprop="name">Linux进阶</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">第 9 章 Linux Nginx 服务配置</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>第 9 章 Linux Nginx 服务配置</h1></header><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="71nginx-简介">7.1、nginx 简介<a class="hash-link" href="#71nginx-简介" title="标题的直接链接">​</a></h2><p>nginx 是一个优秀的 web 服务程序、反向代理程序。它采用非阻塞异步的套接字，使用 epoll 方式实现事件驱动，同时采用<strong>一个 master+N 个 worker 进程</strong>(默认)的方式处理请求，这种架构使得它在并发的处理能力上极其出色，可以比较轻松地解决 C10K 问题。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="72nginx-处理请求的过程">7.2、nginx 处理请求的过程<a class="hash-link" href="#72nginx-处理请求的过程" title="标题的直接链接">​</a></h2><p>master 进程用于管理 worker 进程，例如接收外界信号、向 worker 进程发送信号、销毁 worker 进程、启动 worker 进程等等。</p><p>nginx 之所以性能良好，完全是由它的架构决定的。每个 worker 进程是业务处理进程，负责监听套接字、处理请求、响应请求、代理请求至后端服务器等。</p><p>作为 web server 处理静态资源时每个 worker 进程的大致流程：</p><ol><li>监听套接字。</li><li>与客户端建立连接。</li><li>处理监听到的连接请求(加载静态文件)。</li><li>响应数据。</li><li>断开连接。</li></ol><p>这几个过程是每个 web server 都具备的能力，但对于 nginx 来说，由于它的异步非阻塞，每个过程都不会阻塞(有些小过程必须阻塞的时候还是会阻塞)，使得并发处理能力很好。</p><p>从监听套接字开始深入一点理解：</p><ol><li>每个 worker 进程都是平等的，它们都可以去监听套接字，正常情况下不可避免地会造成争抢和触发 &quot;惊群效应&quot;，而 nginx 采用 &quot;争抢&quot; accept 互斥锁的方式，只有持有 accept 互斥锁的 worker 进程才有资格将连接请求接到自己的队列中并完成 TCP 连接的建立。<ul><li>但每个进程是相互独立而平等的，谁有资格去 &quot;争抢&quot; 互斥锁且有更大几率争抢成功？<ul><li>只要 worker 进程当前建立的连接数小于 worker<!-- -->_<!-- -->connections 指令指定的值(实际上源码中设置的是该值的 7/8)，就允许争抢互斥锁，因为连接数超过了该值的 7/8 表示已经非常繁忙。</li><li>除了繁忙程度限制资格，还有 epoll<!-- -->_<!-- -->wait 的 timeout 的指标，等待越久的 worker 进程争抢能力越强。</li></ul></li><li><strong>总之，在某一时刻，一定只有一个 worker 进程监听并 accept 新的连接请求</strong>。</li></ul></li><li>当已经监听到连接请求时，worker 进程与它进行三次握手，并最终 accpet 到自己的内存池中，并和客户端交互数据，处理客户端发送的 http 请求并响应数据给客户端。<ul><li>但是，nginx 的高效就在于它的异步非阻塞，无论是在 TCP 连接进入 ESTABLISHED 之前，还是等待客户端发送请求，亦或者是等待加载本地静态资源的 I/O，以及响应数据给客户端的任意一个过程中，nginx 都是非阻塞的，在任意等待发生时都可以去处理其它事情。</li><li>当等待的某个资源已经准备成功时将产生事件通知 worker 进程，worker 进程可随后去处理。<ul><li>在此过程中，由于 worker 进程绑定在一个 CPU 核心上(推荐如此做)，所有的连接都放在内存池中，这使得上下文切换时是极其轻量的，极大地减轻了 CPU 消耗。</li><li>从理论上来说，当每个 worker 绑定了一个 CPU 核心时，它的并发处理能力主要依赖于内存的大小。</li></ul></li></ul></li></ol><p>实际上 apache httpd 的 event MPM 也是异步非阻塞的，也可以采用 epoll，但它采用的是多线程方式，虽然异步，但它的异步似乎不体现在并发能力上，而仅仅只是一些具有特殊状态的连接(如长连接)的异步处理，在处理过程中 cpu 还是不断地需要在各线程之间大量切换，并发能力并不比 worker MPM 强多少，相比 nginx 更是远远不如。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="73nginx-命令">7.3、nginx 命令<a class="hash-link" href="#73nginx-命令" title="标题的直接链接">​</a></h2><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># nginx -h</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx version: nginx/1.12.1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Usage: nginx </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">-?hvVtTq</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">-s signal</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">-c filename</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">-p prefix</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">-g directives</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Options:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  -?,-h         </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> 帮助</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  -v            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> 输出版本号</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  -V            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> 输出版本号以及编译选项</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  -t            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> 检查配置文件的语法</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  -T            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> 检查配置文件的语法并输出配置的内容</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  -q            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> 配置测试阶段不输出非错误信息，静默模式</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  -s signal     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> 向主进程发送信号：stop, quit, reopen, reload</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  -p prefix     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> 设置nginx的basedir</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">默认为编译时的prefix</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  -c filename   </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> 指定配置文件</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  -g directives </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> 提前设置全局指令</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>-V</code> 选项输出编译选项：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># nginx -V</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx version: nginx/1.12.1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">built by gcc </span><span class="token number" style="color:rgb(9, 134, 88)">4.8</span><span class="token plain">.5 </span><span class="token number" style="color:rgb(9, 134, 88)">20150623</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">Red Hat </span><span class="token number" style="color:rgb(9, 134, 88)">4.8</span><span class="token plain">.5-39</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">GCC</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">built with OpenSSL </span><span class="token number" style="color:rgb(9, 134, 88)">1.0</span><span class="token plain">.2k-fips  </span><span class="token number" style="color:rgb(9, 134, 88)">26</span><span class="token plain"> Jan </span><span class="token number" style="color:rgb(9, 134, 88)">2017</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">TLS SNI support enabled</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">configure arguments: --user</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">nginx --group</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">nginx --prefix</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/usr/local/nginx-1.12.1 --error-log-path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/var/log/nginx/error.log --http-log-path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/var/log/nginx/access.log --pid-path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/var/run/nginx/nginx.pid --lock-path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/var/lock/subsys/nginx --with-http_ssl_module --with-http_flv_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-threads</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li><p>使用默认配置文件直接启动 nginx 和指定配置文件启动 nginx。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># nginx -c /usr/local/nginx/conf/nginx.conf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># lsof -i :80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">COMMAND  PID  </span><span class="token environment constant" style="color:rgb(129, 31, 63)">USER</span><span class="token plain">   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx   </span><span class="token number" style="color:rgb(9, 134, 88)">4928</span><span class="token plain">  root    6u  IPv4  </span><span class="token number" style="color:rgb(9, 134, 88)">32087</span><span class="token plain">      0t0  TCP *:http </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">LISTEN</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx   </span><span class="token number" style="color:rgb(9, 134, 88)">4929</span><span class="token plain"> nginx    6u  IPv4  </span><span class="token number" style="color:rgb(9, 134, 88)">32087</span><span class="token plain">      0t0  TCP *:http </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">LISTEN</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>运行时重载配置文件。当 nginx 主进程接收到重载配置文件的命令后，它会先检查新配置文件语法，然后载入该配置文件到内存中并解析。然后，主进程 fork 一系列新的 worker 进程，并发送 QUIT 信号给旧的 worker 进程(graceful stop)。旧的工作进程接收到 QUIT 信号后，会停止接受新的连接请求，并继续处理旧的连接直到请求处理完成后才退出。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># nginx -s reload</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>运行时快速关闭 nginx。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># nginx -s stop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># lsof -i :80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>运行时优雅关闭 nginx。所有的工作进程会停止接受新的连接，并继续服务旧的连接请求直到所有的请求完成后才退出。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># nginx -s quit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>运行时重新打开日志文件。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># nginx -s reopen</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="74nginx-模块及-http-功能速览">7.4、nginx 模块及 http 功能速览<a class="hash-link" href="#74nginx-模块及-http-功能速览" title="标题的直接链接">​</a></h2><p>Nginx 的代码由一个核心和一系列的模块组成。</p><p>核心(core functionality)主要用于提供全局应用的基本功能，创建必要的运行时环境及确保不同模块之间平滑地进行交互等，对应于配置文件的 main 段和 event 段。核心涉及的指令官方文档：<a href="http://nginx.org/en/docs/ngx_core_module.html" target="_blank" rel="noopener noreferrer">http://nginx.org/en/docs/ngx<!-- -->_<!-- -->core<!-- -->_<!-- -->module.html</a>。</p><p>还有很多功能都通过模块实现，nginx 是高度模块化程序：</p><ul><li>web 相关的功能模块有 <code>&quot;ngx_http_*_module&quot;</code></li><li>mail 相关的功能模块有 <code>&quot;ngx_mail_*_module&quot;</code></li><li>tcp 代理、负载均衡相关的功能模块有 <code>&quot;ngx_stream_*_module&quot;</code></li><li>这些类别的模块中又分为很多类别的模块，如 http 类别的模块中有基本核心模块、事件类模块、缓存类模块、SSL 相关模块、负载均衡类模块 upstream 等等。</li></ul><p>以下是 http 功能模块类中常见的模块：</p><table><thead><tr><th>http 类模块名</th><th>模块功能说明</th></tr></thead><tbody><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->core<!-- -->_<!-- -->module</td><td>http 核心模块，对应配置文件中的 http 段，包含很多指令，如 location 指令</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->access<!-- -->_<!-- -->module</td><td>访问控制模块，控制网站用户对 nginx 的访问，对应于配置文件中的 allow 和 deny 等指令</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->auth<!-- -->_<!-- -->basic<!-- -->_<!-- -->module</td><td>通过用户名和密码认证的访问控制，如访问站点时需要数据用户名和密码，指令包括 auth<!-- -->_<!-- -->basic 和 auth<!-- -->_<!-- -->basic<!-- -->_<!-- -->user<!-- -->_<!-- -->file</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->charset<!-- -->_<!-- -->module</td><td>设置网页显示字符集。指令之一为 charset，如 charset utf-8</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->fastcgi<!-- -->_<!-- -->module</td><td>fastcgi 模块，和动态应用相关。该模块下有非常多的子模块。</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->flv<!-- -->_<!-- -->module</td><td>支持 flv 视频流的模块，如边下边播</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->mp4<!-- -->_<!-- -->module</td><td>同 flv 模块</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->gzip<!-- -->_<!-- -->module</td><td>压缩模块，用来压缩 nginx 返回的响应报文。一般只压缩纯文本内容，因为压缩比例非常大，而图片等不会去压缩</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->image<!-- -->_<!-- -->filter<!-- -->_<!-- -->module</td><td>和图片裁剪、缩略图相关模块，需要安装 gd-devel 才能编译该模块</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->index<!-- -->_<!-- -->module</td><td>定义将要被作为默认主页的文件，对应指令为 index。&quot;index index.html, index.php&quot;</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->autoindex<!-- -->_<!-- -->module</td><td>当 index 指令指定的主页文件不存在时，交给 autoindex 指令，将自动列出目录中的文件 autoindex {on/off}</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->log<!-- -->_<!-- -->module</td><td>和访问日志相关的模块，指令包括 log<!-- -->_<!-- -->format 和 access<!-- -->_<!-- -->log</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->memcached<!-- -->_<!-- -->module</td><td>和 memcached 相关的模块，用于从 memcached 服务器中获取相应响应数据</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->proxy<!-- -->_<!-- -->module</td><td>和代理相关，允许传送请求到其它服务器</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->realip<!-- -->_<!-- -->module</td><td>当 nginx 在反向代理的后端提供服务时，获取到真正的客户端地址，否则获取的是反向代理的 IP 地址</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->referer<!-- -->_<!-- -->module</td><td>实现防盗链功能的模块</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->rewrite<!-- -->_<!-- -->module</td><td>和 URL 地址重写相关的模块，需要安装 pcre-devel 才能编译安装该模块</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->scgi<!-- -->_<!-- -->module</td><td>simple cgi，是 cgi 的替代品，和 fastcgi 类似，但更简单</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->ssl<!-- -->_<!-- -->module</td><td>提供 ssl 功能的模块，即实现 HTTPS</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->stub<!-- -->_<!-- -->status<!-- -->_<!-- -->module</td><td>获取 nginx 运行状态信息</td></tr><tr><td>ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->upstream</td><td>和负载均衡相关模块</td></tr></tbody></table><p>这些模块共同组成了 nginx 的 http 功能。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="75nginx-配置文件简单说明">7.5、nginx 配置文件简单说明<a class="hash-link" href="#75nginx-配置文件简单说明" title="标题的直接链接">​</a></h2><p>nginx 的配置文件有很多个，如下。其中主配置文件为 nginx.conf，其他配置文件在需要的时候使用 include 指令将其包含到主配置文件中。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ls /usr/local/nginx/conf/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">fastcgi.conf            koi-utf             nginx.conf           uwsgi_params</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">fastcgi.conf.default    koi-win             nginx.conf.default   uwsgi_params.default</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">fastcgi_params          mime.types          scgi_params          win-utf</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">fastcgi_params.default  mime.types.default  scgi_params.default</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>其中 &quot;.default&quot; 后缀的是对应前缀配置文件的备份配置文件，<code>&quot;_params&quot;</code> 是对应前缀的参数文件。<ul><li>如 fastcgi.conf 是和 fastcgi 相关参数的配置文件，<code>fastcgi_params</code> 是 fastcgi 的参数文件，fastcgi.conf.default 是 fastcgi.conf 的备份文件。</li></ul></li><li>关于主配置文件 nginx.conf，由于 Nginx 高度模块化，所以它是分段配置的，核心模块为 core，对应配置文件中的 Main 和 Events 段。此外还有其他一些模块。配置文件中每一个指令必须以分号 &quot;;&quot; 结束，否则语法错误。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="751main-和-events-段">7.5.1、main 和 events 段<a class="hash-link" href="#751main-和-events-段" title="标题的直接链接">​</a></h3><p>Main 用于配置错误日志、进程及权限等相关的参数，Events 用于配置 IO 模型，如 epoll、kqueue、select 或 poll 等，它们是必备模块。如下配置：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)">#user  nobody;        # worker进程身份,默认使用编译时指定值.语法为&quot;user user_name [group_name]&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">worker_processes  </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)"># worker进程数量,该指令值依赖因素较多，例如是否CPU密集型、是否IO密集型。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                      </span><span class="token comment" style="color:rgb(0, 128, 0)"># 在初始时设置为cpu的总核数是一个不错的选择。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#error_log logs/error.log;         # 错误日志文件，禁用错误日志&quot;error_log /dev/null LEVEL;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#error_log logs/error.log notice;  # 级别:debug|info|notice|warn|error|crit|alert|emerg，默认为error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#error_log  logs/error.log  info;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#pid        logs/nginx.pid;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#lock_file  logs/nginx.lock;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">events </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    worker_connections  </span><span class="token number" style="color:rgb(9, 134, 88)">1024</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">   </span><span class="token comment" style="color:rgb(0, 128, 0)"># 每个worker进程的最大连接数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    multi_accept on</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 是否一次性将监听到的连接全接收进来，默认为off，关闭时一次接收一条连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    accept_mutex on             </span><span class="token comment" style="color:rgb(0, 128, 0)"># 默认为on，开启时表示以串行方式接入新连接，否则将通报给所有worker。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                </span><span class="token comment" style="color:rgb(0, 128, 0)"># 这可能会浪费资源并产生不可预计的后果，例如惊群问题</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>如果某个文件采用了相对路径，则其相对的基准为 basedir。</p><ul><li>例如编译时 --prefix 指定为 /usr/local/nginx，则指定 pid 为 logs/nginx.pid 时，其实际路径为 /usr/local/nginx/logs/nginx.pid。</li></ul></li><li><p>worker<!-- -->_<!-- -->processes 的值和 work<!-- -->_<!-- -->connections 的值决定了最大并发数量。</p><ul><li>例如上面的配置中，每个 worker 进程最大允许 1024 个连接，配置了 4 个 worker 进程，所以并发数量为 1024<!-- -->*<!-- -->4=4096。</li><li>但在反向代理场景中计算方法不同，因为 nginx 既要维持和客户端的连接，又要维持和后端服务器的连接，因此处理一次连接要占用 2 个连接，所以最大并发数计算方式为：<code>worker_processes * worker_connections/2</code>。</li><li>此外还需注意，除了和客户端的连接、与后端服务器的连接，nginx 可能还会打开其他的连接，这些都会占用文件描述符，从而影响并发数量的计算。</li><li>最后还需注意，最大并发数量还受 &quot;允许打开的最大文件描述符数量&quot; 限制，可以使用 &quot;worker<!-- -->_<!-- -->rlimit<!-- -->_<!-- -->nofile&quot; 指令修改或直接修改操作系统的对应内核参数。</li></ul></li><li><p>可以在 main 段使用 worker<!-- -->_<!-- -->cpu<!-- -->_<!-- -->affinity 指令绑定 CPU 核心。nginx 通过位数识别 CPU 核心以及核心数，指定位数上占位符为 1 表示使用该核心，占位符为 0 表示不使用该核心。</p><ul><li>例如 2 核 cpu 的位数分别为 01 和 10，4 核的位数分别为 1000, 0100, 0010 以及 0001，同理 8 核和 16 核。在结合 worker<!-- -->_<!-- -->processes 指令一起使用时，要注意 worker 进程和核心的对应方式，例如：</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 每个worker分别对应cpu0/cpu1/cpu2/cpu3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">worker_processes    </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">worker_cpu_affinity 0001 0010 0100 </span><span class="token number" style="color:rgb(9, 134, 88)">1000</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 有4核心，但只有两worker，第一个worker对应cpu0/cpu2，第二个worker对应cpu1/cpu3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">worker_processes    </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">worker_cpu_affinity 0101 </span><span class="token number" style="color:rgb(9, 134, 88)">1010</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>在 events 段，可以使用 &quot;use&quot; 指令可以指定使用哪种 I/O 模型，Linux 上默认是 epoll，通常可以不用手动去设置，因为 nginx 默认会采用最佳配置。</p></li></ul><p>以下是 main 段和 events 段的配置示例，大多数采用的默认值，需要修改的大致就是 worker 数量、每个 worker 最大连接数以及进程绑定 cpu。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">worker_processes  </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">events </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    worker_connections  </span><span class="token number" style="color:rgb(9, 134, 88)">1024</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="752http-段">7.5.2、http 段<a class="hash-link" href="#752http-段" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7521配置文件概览">7.5.2.1、配置文件概览<a class="hash-link" href="#7521配置文件概览" title="标题的直接链接">​</a></h4><p>http 段是由 http 相关模块支持的。以下是默认配置项。注意，http 根段下使用相对路径是相对 conf 目录的，如 <code>&quot;include extra/*.conf&quot;</code> 表示的是 <code>conf/extra/*.conf</code>；</p><p>非根段内的相对路径如 server 段内使用相对路径是相对于的安装目录 <code>&lt;prefix&gt;</code> 的，例如 nginx 安装在 /usr/local/nginx 下，当 location 中的 root 设置为 html 时，它表示的路径是 /usr/local/nginx/html/。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">http </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    include       mime.types</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">                       </span><span class="token comment" style="color:rgb(0, 128, 0)"># nginx支持的媒体文件类型。相对路径为同目录conf下的其他文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    default_type  application/octet-stream</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">         </span><span class="token comment" style="color:rgb(0, 128, 0)"># 默认的媒体类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">#log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;   # 访问日志的格式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">#                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">#                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">#access_log  logs/access.log  main;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    sendfile        on</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">                             </span><span class="token comment" style="color:rgb(0, 128, 0)"># 启用sendfile传输模式，此模式是&quot;零拷贝&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">#tcp_nopush     on;                             # 只在sendfile on时有效。让数据包挤满到一定程度才发送出去，挤满之前被阻塞</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">#keepalive_timeout  0;                          # keepalive的超时时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    keepalive_timeout  </span><span class="token number" style="color:rgb(9, 134, 88)">65</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">#gzip  on;                                      # 是否启用gzip压缩响应报文</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">                                        </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定义虚拟主机</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        listen       </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">                            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定义监听套接字</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server_name  localhost</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">                     </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定义主机名加域名，即网站地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)">#charset koi8-r;                            # 默认字符集</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)">#access_log  logs/host.access.log  main;    # 访问日志路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">                                </span><span class="token comment" style="color:rgb(0, 128, 0)"># location容器，即URI的根</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            root   html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">                            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 站点根目录，即DocumentRoot，相对路径时为&lt;prefix&gt;/html</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            index  index.html index.htm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 站点主页文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)">#error_page  404    /404.html;              # 出现404 page not fount错误时，使用/404.html页响应客户端</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)"># redirect server error pages to the static page /50x.html</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        error_page   </span><span class="token number" style="color:rgb(9, 134, 88)">500</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">502</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">503</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">504</span><span class="token plain">  /50x.html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 出现50x错误时，使用/50x.html页返回给客户端</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /50x.html </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">                      </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定义手动输入包含/50x.html时的location</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            root   html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)"># deny access to .htaccess files, if Apache&#x27;s document root</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)"># concurs with nginx&#x27;s one</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)">#location ~ /\.ht {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)">#    deny  all;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)">#}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># another virtual host using mix of IP-, name-, and port-based configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">#server {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">#    listen       8000;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">#    listen       somename:8080;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">#    server_name  somename  alias  another.alias;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">#    location / {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">#        root   html;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">#        index  index.html index.htm;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">#    }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)">#}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7522root-指令和-alias-指令">7.5.2.2、root 指令和 alias 指令<a class="hash-link" href="#7522root-指令和-alias-指令" title="标题的直接链接">​</a></h4><p>root 指令设置站点根目录，即 httpd 的 documentroot，但又有所不同，因为 nginx 可以在多个上下文位置处使用 root 指令，例如 Location 容器中。</p><p>如果配置如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">location /i/ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    root /data/w3</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>那么 nginx 将使用文件 /data/w3/i/top.gif 响应请求 &quot;/i/top.gif&quot;。</li></ul><p><strong>root 指令仅仅只是将匹配的 URI 追加在 root 路径后，如果要改变 URI，应该使用 alias 指令，它会对 URI 进行替换</strong>。例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">location /i/ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">alias</span><span class="token plain"> /data/w3/images/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>那么 nginx 将使用文件 /data/w3/images/top.gif 响应请求 /i/top.gif。因此，如果 alias 指令的路径最后一部分包含了 URI，则最好使用 root 指令，而非 alias 指令，虽然它们都能成功响应。</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">location /images/ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">alias</span><span class="token plain"> /data/w3/images/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location /images/ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    root /data/w3/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>它们都能使用相对路径，相对的是 prefix</strong>。例如编译路径为 /usr/local/nginx，则 &quot;root html&quot; 指的是 &quot;/usr/local/nginx/html&quot;。</li></ul><p>与 root 和 alias 指令相关的变量为 <code>$document_root</code>、<code>$realpath_root</code>。<strong>其中 <code>$document_root</code> 的值即是 root 指令、alias 指令的值，而 <code>$realpath_root</code> 的值是对 root、alias 指令进行绝对路径换算后的值</strong>。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7523location-容器">7.5.2.3、location 容器<a class="hash-link" href="#7523location-容器" title="标题的直接链接">​</a></h4><p>该指令对规范化后的 URI 进行匹配，并对匹配的路径封装一系列指令。 语法：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">location </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> ~ </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> ~* </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> ^~ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> uri </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">. </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>location /uri/ {}：表示对 /uri/ 目录及其子目录下的所有文件都匹配。所以 &quot;location / {}&quot; 的匹配范围是最大的。</li><li>location = /uri/ {}：表示只对目录或文件进行匹配，不对目录中的文件和子目录进行匹配。所以一般只用来做文件匹配</li><li>location ~ /uri/ {}：表示区分大小写的正则匹配。</li><li>location ~<!-- -->*<!-- --> /uri/ {}：表示不区分大小写的正则匹配。</li><li>location ^~ /uri/ {}：表示禁用正则匹配，即精确字符串匹配，此时正则中的元字符被解释成普通字符。</li></ul><p>它们的匹配优先级规则为：<strong>nginx 先检查 URI 的前缀路径，在这些路径中找到最精确匹配请求 URI 的路径。然后 nginx 按在配置文件中的出现顺序检查正则表达式路径，匹配上某个路径后即停止匹配并使用该路径的配置，否则使用最大前缀匹配的路径的配置</strong>。</p><p>使用 &quot;=&quot; 前缀可以定义 URI 和路径的精确匹配。如果发现匹配，则终止路径查找。例如请求 &quot;/&quot; 很频繁，定义 &quot;location = /&quot; 可以提高这些请求的处理速度，因为查找过程在第一次比较以后即结束。</p><p>以下是一个优先级的示例：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">location </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> configuration A </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> configuration B </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location /documents/ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> configuration C </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location ^~ /images/ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> configuration D </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location ~* </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">gif</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">jpg</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">jpeg</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">$ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> configuration E </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>请求 &quot;/&quot; 能匹配 A 和 B，但最精确匹配为 A。</li><li>请求 &quot;/index.html&quot; 的前缀 &quot;/&quot; 能匹配 A 和 B，但 A 只能匹配 &quot;/&quot; 自身，因此最终匹配配置 B。(前缀也能匹配 E，但文件名无法匹配)</li><li>请求 &quot;/documents/document.html&quot; 的前缀能匹配 B 和 C，但 C 更精确，因此匹配配置 C。(前缀也能匹配 E，但文件名无法匹配)</li><li>请求 &quot;/images/1.gif&quot; 的前缀能匹配 B、D 和 E，且 D 和 E 都是最长路径匹配，但 ^~ 优先级更高，因此匹配配置 D。</li><li>请求 &quot;/documents/1.jpg&quot; 的前缀能匹配 B、C，同样也能匹配 E，且 E 比 B 的匹配更精确，因此最终匹配配置 E。</li></ul><p>大致可以将规则简化为如下优先级：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">location </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> uri </span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">location ^~ uri</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">location *~</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">~ uri</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">location uri</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>即等号优先级最高，非正则匹配次之，再之后是正则匹配，它们之间有位置的先后顺序，优先级最低的是没有使用任何符号的匹配</strong>。</li></ul><p>由此也可以知道，&quot;location / {}&quot; 这种方式是一种特殊的 uri 匹配，无论什么 uri 路径，都能往这里面装，可以认为它是默认匹配，当其它 location 都匹配不上时就会匹配它。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7524error_page-指令">7.5.2.4、error<!-- -->_<!-- -->page 指令<a class="hash-link" href="#7524error_page-指令" title="标题的直接链接">​</a></h4><p>当出现对应状态码的错误时，指定返回的 URI路径。语法为：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">error_page code </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">. </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> uri</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>配置文件中的 error<!-- -->_<!-- -->page 部分默认为：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    root   html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    index  index.html index.htm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#error_page  404              /404.html;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">error_page   </span><span class="token number" style="color:rgb(9, 134, 88)">500</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">502</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">503</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">504</span><span class="token plain">  /50x.html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /50x.html </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    root   html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>上面的配置文件中，假如取消了 404 错误的 error<!-- -->_<!-- -->page 行注释，当出现 404 错误时，其 uri 为 /404.html，然后会对其进行 location 的匹配，由于只有 &quot;location / {}&quot; 能匹配到，所以它的目录为 <code>&lt;prefix&gt;/html/</code>，即 404.html 文件路径为 <code>&lt;prefix&gt;/html/404.html</code>。</li><li>对于 50x 的 error<!-- -->_<!-- -->page，其 uri 为 &quot;/50x.html&quot;，所以会对其进行 location 匹配，发现可以精确匹配到 &quot;location = /50x.html {}&quot;，当然 &quot;location / {}&quot; 也能匹配到，但是它的优先级更低，所以当出现 50x 错误时，将从 <code>&lt;prefix&gt;/html</code> 目录下寻找 50x.html，这里正好和 &quot;location / {}&quot; 重复了，但它们的匹配过程是不一样的。</li></ul><p>假如改为如下配置：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">                       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    root   html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">                   </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    index  index.html index.htm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#error_page  404              /404.html;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">error_page   </span><span class="token number" style="color:rgb(9, 134, 88)">500</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">502</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">503</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">504</span><span class="token plain">  /50x.html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /50x.html </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    root   /www/a.com/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>出现 50x 错误时，将返回 /www/a.com/50x.html 文件，而不再是 <code>&lt;prefix&gt;/html/50x.html</code>。</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7525allow-和-deny">7.5.2.5、allow 和 deny<a class="hash-link" href="#7525allow-和-deny" title="标题的直接链接">​</a></h4><p>这两个指令由 ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->access<!-- -->_<!-- -->module 模块提供，用于允许或限制某些 IP 地址的客户端访问。nginx 中的 allow 和 deny 规则很简单，从上向下匹配，只要匹配到就停止。例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">allow </span><span class="token number" style="color:rgb(9, 134, 88)">10.0</span><span class="token plain">.0.8</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">allow </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.100.0/24</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">deny all</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>允许 10.0.0.8 和 192.168.100 网段的访问，其他的都拒绝。</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7526add_header-添加相应首部字段">7.5.2.6、add<!-- -->_<!-- -->header 添加相应首部字段<a class="hash-link" href="#7526add_header-添加相应首部字段" title="标题的直接链接">​</a></h4><p>用于在响应首部中添加字段。例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    add_header RealPath </span><span class="token variable" style="color:rgb(9, 134, 88)">$realpath_root</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>将添加一个名为 RealPath 的字段，值为变量 realpath<!-- -->_<!-- -->root 的值。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># curl -I http://localhost</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">HTTP/1.1 </span><span class="token number" style="color:rgb(9, 134, 88)">200</span><span class="token plain"> OK</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Server: nginx/1.12.1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Date: Sat, </span><span class="token number" style="color:rgb(9, 134, 88)">30</span><span class="token plain"> Oct </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">17</span><span class="token plain">:54:16 GMT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Content-Type: text/html</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Content-Length: </span><span class="token number" style="color:rgb(9, 134, 88)">612</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Last-Modified: Sat, </span><span class="token number" style="color:rgb(9, 134, 88)">30</span><span class="token plain"> Oct </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token plain">:59:41 GMT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Connection: keep-alive</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ETag: </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;617d259d-264&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">RealPath: /usr/local/nginx-1.12.1/html  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 此为自定义添加字段</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Accept-Ranges: bytes</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="753虚拟主机和-server_name-指令">7.5.3、虚拟主机和 server<!-- -->_<!-- -->name 指令<a class="hash-link" href="#753虚拟主机和-server_name-指令" title="标题的直接链接">​</a></h3><p>nginx 使用 server 容器定义一个虚拟主机。在 nginx 中，没有严格区分基于 IP 和基于名称的虚拟主机，它们通过 listen 指令和 server<!-- -->_<!-- -->name 指令结合起来形成不同的虚拟主机。</p><p>例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 基于IP地址的虚拟主机</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        listen </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server_name </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.100.25</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                root /www/brinnatt/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                index index.html index.htm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        listen </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server_name </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.100.26</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                root /www/speedy/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                index index.html index.htm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 基于名称的虚拟主机</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        listen </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server_name www.brinnatt.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                root /www/brinnatt/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                index index.html index.htm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        listen </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server_name www.speedy.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                root /www/speedy/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                index index.html index.htm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 基于端口的虚拟主机</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        listen </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server_name </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.100.25</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                root /www/brinnatt/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                index index.html index.htm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        listen </span><span class="token number" style="color:rgb(9, 134, 88)">8080</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server_name </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.100.25</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                root /www/speedy/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                index index.html index.htm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>其中 server<!-- -->_<!-- -->name 指令可以定义多个主机名，第一个名字为虚拟主机的首要主机名。例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server_name  example.com   www.example.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>主机名中可以含有星号 <code>&quot;*&quot;</code>，以替代名字的开始部分或结尾部分(只能是起始或结尾，如果要实现中间部分的通配，可以使用正则表达式)。例如 <code>&quot;*.example.org&quot;</code> 不仅匹配 <a href="http://www.example.org%EF%BC%8C%E4%B9%9F%E5%8C%B9%E9%85%8D" target="_blank" rel="noopener noreferrer">www.example.org，也匹配</a> <a href="http://www.sub.example.org%E3%80%82%E4%B8%8B%E9%9D%A2%E4%B8%A4%E6%9D%A1%E6%8C%87%E4%BB%A4%E6%98%AF%E7%AD%89%E4%BB%B7%E7%9A%84%E3%80%82" target="_blank" rel="noopener noreferrer">www.sub.example.org。下面两条指令是等价的。</a></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server_name    example.com   *.example.com   www.example.*</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server_name   .example.com   www.example.*</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>也可以在主机名中使用正则表达式，就是在名字前面补一个波浪线 <code>&quot;~&quot;</code>：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server_name   www.example.com   ~^www</span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">d+</span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">.example</span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">.com$</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>nginx 允许定义空主机名：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  listen       </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  server_name  </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain">       </span><span class="token number" style="color:rgb(9, 134, 88)">444</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>这种主机名可以让虚拟主机处理没有 &quot;Host&quot; 首部的请求，而不是让指定 &quot;地址:端口&quot; 的默认虚拟主机来处理，而这正是本指令的默认设置。</li><li>即使用非默认的虚拟主机处理请求头中不含 &quot;Host&quot; 字段的请求。一般这样的请求处理方式是直接丢弃请求，并返回一个非标准的状态码来立即关闭连接，例如上面的 444。</li><li>如果 server 块中没有定义 server<!-- -->_<!-- -->name，nginx 使用空名字作为虚拟主机名。</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="754虚拟主机的匹配规则">7.5.4、虚拟主机的匹配规则<a class="hash-link" href="#754虚拟主机的匹配规则" title="标题的直接链接">​</a></h3><p>通过名字查找虚拟主机时，如果一个名字可以匹配多个指定的配置，比如同时匹配上通配符和正则表达式，按下面优先级，使用先匹配上的虚拟主机：</p><ol><li>确定的名称；</li><li>最长的以星号起始的通配符名字，比如 <code>&quot;*.example.com&quot;</code>；</li><li>最长的以星号结束的通配符名字，比如 <code>&quot;mail.*&quot;</code>；</li><li>第一个匹配的正则表达式名字(按在配置文件中出现的顺序)。</li></ol><p>当开始接入请求时：</p><ol><li>nginx 首先判断请求的套接字，即 IP 和端口号；</li><li>然后在 listen 套接字中选择一个能匹配名称的虚拟主机，如果没有选出能匹配的名称，则使用该套接字的默认虚拟主机。默认情况下，监听套接字的默认虚拟主机为该套接字主机组中的第一个虚拟主机，但可以通过 listen 指令的 default<!-- -->_<!-- -->server 属性手动指定。</li></ol><p>例如下面定义了 4 个虚拟主机：前 3 个都监听在 192.168.100.1:80 上，第四个监听在 192.168.1.2:80 上：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    listen      </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.100.1:80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server_name example.org www.example.org</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    listen      </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.100.1:80 default_server</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server_name example.net www.example.net</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    listen      </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.100.1:80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server_name example.com www.example.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    listen      </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.1.2:80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server_name example.com www.example.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>从 192.168.100.1:80 上请求 <a href="http://www.example.com%EF%BC%8C%E8%83%BD%E5%8C%B9%E9%85%8D%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA" target="_blank" rel="noopener noreferrer">www.example.com，能匹配虚拟主机</a> 3，于是使用虚拟主机 3 的配置进行响应；</li><li>从 192.168.100.1:80 上请求 <a href="http://www.speedy.com" target="_blank" rel="noopener noreferrer">www.speedy.com</a> 时，无法匹配任何虚拟主机，于是使用默认虚拟主机 2 的配置进行响应。如果将 listen 的属性 default<!-- -->_<!-- -->server 去掉，则使用虚拟主机 1 进行响应；</li><li>从 192.168.1.2:80 上请求 <a href="http://www.example.com" target="_blank" rel="noopener noreferrer">www.example.com</a> 时，使用虚拟主机 4 进行响应；</li><li>从 192.168.1.2:80 上请求 <a href="http://www.example.org" target="_blank" rel="noopener noreferrer">www.example.org</a> 时，由于无法匹配该套接字上的任何主机，于是使用默认虚拟主机响应，即虚拟主机 4。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="755stub_status-指令获取-nginx-状态信息">7.5.5、stub<!-- -->_<!-- -->status 指令获取 nginx 状态信息<a class="hash-link" href="#755stub_status-指令获取-nginx-状态信息" title="标题的直接链接">​</a></h3><p>使用 ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->stub<!-- -->_<!-- -->status<!-- -->_<!-- -->module 模块提供的功能可以获取 nginx 运行的状态信息。对应的指令只有一个，即 stub<!-- -->_<!-- -->status。</p><p>例如，在某一个 server 下加上如下配置获取该 server 的状态信息。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    listen </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server_name www.speedy.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        root /www/speedy/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        index index.html index.htm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location /status </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        stub_status on</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>还可以明确指定访问该信息不记录日志，且提供访问控制，不让外界人随意获取信息。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">location /status </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stub_status on</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    access_log off</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    allow </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.100.0/24</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    deny all</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>重载配置文件后，只需在浏览器中输入 &quot;主机名/status&quot; 即可获取信息。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">Active connections: </span><span class="token number" style="color:rgb(9, 134, 88)">291</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server accepts handled requests</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">16630948</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">16630948</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">31070465</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Reading: </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain"> Writing: </span><span class="token number" style="color:rgb(9, 134, 88)">179</span><span class="token plain"> Waiting: </span><span class="token number" style="color:rgb(9, 134, 88)">106</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>第一行 active connections:291 表示当前处于活动状态的客户端连接数，包括正处于等待状态的连接。</p></li><li><p>第四行 reading 数量为 6，表示 nginx 正在读取请求首部的数量，即正在从 socket recv buffer 中读取数据的数量；writing 数量为 179 表示 nginx 正在将响应数据写入 socket send buffer 以返回给客户端的连接数量；waiting 数量为 106 表示等待空闲客户端发起请求的客户端数量，包括长连接状态的连接以及已接入但 socket recv buffer 还未产生可读事件的连接，其值为 active-reading-writing。</p></li><li><p>第二行 accepts 的数量为 16630948 表示从服务启动开始到现在已经接收进来的总的客户端连接数；handled 的数量为 16630948 表示从服务启动以来已经处理过的连接数，一般 handled 的值和 accepts 的值相等，除非作出了连接数限定；requests 的数量为服务启动以来总的客户端请求数。一个连接可以有多个请求，所以可以计算出平均每个连接发出多少个请求。</p></li><li><p>以下是第二行几个参数的官方原文：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">accepts:  The total number of accepted client connections.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">handled:  The total number of handled connections. Generally,the parameter value</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        is the same as accepts unless some resource limits have been reached </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">for example, the worker_connections limit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">requests: The total number of client requests.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="76访问日志-access_log">7.6、访问日志 access<!-- -->_<!-- -->log<a class="hash-link" href="#76访问日志-access_log" title="标题的直接链接">​</a></h2><ol><li>nginx 的访问日志相关功能由 ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->log<!-- -->_<!-- -->module 模块提供，指令包括 log<!-- -->_<!-- -->format、access<!-- -->_<!-- -->log 和 open<!-- -->_<!-- -->log<!-- -->_<!-- -->file<!-- -->_<!-- -->cache。</li><li>nginx 的日志可以先缓冲到 buffer 中，一定时间后再写入到日志文件中。从 buffer 刷盘到本地日志文件中时，可以进行压缩。</li><li>nginx 的 worker 进程的运行身份需要有日志创建的权限，即对日志所在目录有写权限。</li><li>可以在多种上下文中定义是否开启日志以及日志的格式。最常见的三个上下文是 http, server, location。</li><li>open<!-- -->_<!-- -->log<!-- -->_<!-- -->file<!-- -->_<!-- -->cache 指令存在的意义是为了缓存日志文件描述符。之所以提供这个指令，是<strong>因为 nginx 每次日志的写入(从缓存中刷盘到本地日志文件中)都会打开、关闭一次日志文件</strong>。对于日志写入极其频繁的机器可以使用该指令缓存日志文件描述符，使得在缓存有效期内都可以续写到旧日志文件中。</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="761log_format-指令">7.6.1、log<!-- -->_<!-- -->format 指令<a class="hash-link" href="#761log_format-指令" title="标题的直接链接">​</a></h3><p>log<!-- -->_<!-- -->format 指定日志的格式，语法如下：<code>log_format name string...;</code>。其中 name 指定日志格式名称，配置文件中 name 名称不能重复。</p><p>以下是默认提供的 main 格式：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)">#log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 main 后面的是一堆变量，除了这些变量之外还有其他很多变量可用，但如非特殊需求，默认的 main 格式就已经够完美了。以下是变量的意义：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token variable" style="color:rgb(9, 134, 88)">$remote_addr</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">           客户端的地址。如果nginx提供的web服务在后端，如前面有代理服务器或负载均衡等设备时，</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                        该变量只能获取到前端的IP地址。此时要获取到真正客户端地址需要使用变量</span><span class="token variable" style="color:rgb(9, 134, 88)">$http_x_forward_for</span><span class="token plain">，</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                        但要求前端服务器要开启x_forward_for设置。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token variable" style="color:rgb(9, 134, 88)">$http_x_forward_for</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">    如上所述。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token variable" style="color:rgb(9, 134, 88)">$remote_user</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">           远程客户端用户名称。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token variable" style="color:rgb(9, 134, 88)">$time_local</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">            记录访问时间和时区信息。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token variable" style="color:rgb(9, 134, 88)">$request</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">               记录用户访问时的url和http协议信息。如：</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;GET /favicon.ico HTTP/1.1&quot;</span><span class="token plain">。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token variable" style="color:rgb(9, 134, 88)">$status</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">                记录客户端请求时返回的状态码，如成功的状态码为200，page not found的状态码为404。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token variable" style="color:rgb(9, 134, 88)">$body_bytes_sent</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">       记录服务器响应给客户端的主体大小。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token variable" style="color:rgb(9, 134, 88)">$http_referer</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">          记录此次请求是从哪个链接过来的，需要模块ngx_http_referer_module支持，默认已装，可以防止倒链问题。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token variable" style="color:rgb(9, 134, 88)">$http_user_agent</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">       记录客户端的浏览器信息。如使用什么浏览器发起的请求，是否是压力测试工具在测试等。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>例如，以下是默认格式的日志信息：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.107 - - </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain">/Oct/2021:04:01:43 +0800</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;GET /status HTTP/1.1&quot;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">200</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">97</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;-&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.54 Safari/537.36&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.107 - - </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain">/Oct/2021:04:01:43 +0800</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;GET /favicon.ico HTTP/1.1&quot;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">404</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">571</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;http://192.168.0.99/status&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.54 Safari/537.36&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.107 - - </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain">/Oct/2021:04:02:26 +0800</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;GET /status HTTP/1.1&quot;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">200</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">97</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;-&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.54 Safari/537.36&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="762access_log-指令">7.6.2、access<!-- -->_<!-- -->log 指令<a class="hash-link" href="#762access_log-指令" title="标题的直接链接">​</a></h3><p>access<!-- -->_<!-- -->log 主要用于定义使用什么格式的日志，日志存放路径。语法如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">access_log path </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">format </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">buffer</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">size</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">gzip</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">level</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">flush</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">time</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">if</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">condition</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">access_log off</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>path 指定路径，path 里可以使用变量。</li><li>format 指定日志格式，不写时或者配置文件中未配置 access<!-- -->_<!-- -->log 指令时，默认为 combined。</li><li>buffer=size 指定日志缓冲区大小(默认 64K)，flush=time 指定日志刷盘的时间，if=condition 指定某些条件，gzip=level 指定日志刷盘前先压缩的压缩级别(默认 gzip=1)。</li><li>当指定了 buffer 或者 gzip 任意一个时，都会使用 buffer 先缓冲日志，然后再刷盘。</li></ul><p>例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">access_log /spool/logs/nginx-access.log </span><span class="token function" style="color:rgb(0, 0, 255)">gzip</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">buffer</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">32k</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="763日志文件的分割">7.6.3、日志文件的分割<a class="hash-link" href="#763日志文件的分割" title="标题的直接链接">​</a></h3><p>默认 nginx 不会自动分割日志，也不支持在配置文件中使用 cronolog 以及 rotatelogs(apache 支持，因为支持管道传递)。要实现 nginx 的日志分割，需要通过移动旧日志、生成新日志来实现。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">mv</span><span class="token plain"> old_log new_log</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 然后</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx -s reload</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 或者</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx -s reopen</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 或者</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">kill</span><span class="token plain"> -s USR1 master_pid</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>pid 可以通过 pid 文件获得。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">kill</span><span class="token plain"> -s USR1 </span><span class="token variable" style="color:rgb(9, 134, 88)">$(</span><span class="token variable function" style="color:rgb(0, 0, 255)">cat</span><span class="token variable" style="color:rgb(9, 134, 88)"> /var/run/nginx/nginx.pid</span><span class="token variable" style="color:rgb(9, 134, 88)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><p>要实现自动分割，需要使用脚本，并设置定时任务。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/local/nginx/sbin/log_split.sh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># cut the access log for www.speedy.com</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">basedir</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/usr/local/nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">old_log_path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable" style="color:rgb(9, 134, 88)">$basedir</span><span class="token plain">/logs/access.log</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">log_save_path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable" style="color:rgb(9, 134, 88)">$basedir</span><span class="token plain">/logs</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">save_log_name</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">access_</span><span class="token variable" style="color:rgb(9, 134, 88)">$(</span><span class="token variable function" style="color:rgb(0, 0, 255)">date</span><span class="token variable" style="color:rgb(9, 134, 88)"> -d </span><span class="token variable string" style="color:rgb(163, 21, 21)">&quot;yesterday&quot;</span><span class="token variable" style="color:rgb(9, 134, 88)"> +</span><span class="token variable string" style="color:rgb(163, 21, 21)">&quot;%Y%m%d&quot;</span><span class="token variable" style="color:rgb(9, 134, 88)">)</span><span class="token plain">.log</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> -f </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">$old_log_path</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">||</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">exit</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/bin/mv </span><span class="token variable" style="color:rgb(9, 134, 88)">$old_log_path</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$log_save_path</span><span class="token plain">/</span><span class="token variable" style="color:rgb(9, 134, 88)">$save_log_name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token variable" style="color:rgb(9, 134, 88)">$basedir</span><span class="token plain">/sbin/nginx -s reopen</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># chmod +x /usr/local/nginx/sbin/log_split.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>再添加定时任务计划。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">crontab</span><span class="token plain"> -e</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">00 00 * * * /usr/local/nginx/sbin/log_split.sh </span><span class="token operator" style="color:rgb(0, 0, 0)">&amp;&gt;</span><span class="token plain">/dev/null</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="77配置-web-身份认证">7.7、配置 web 身份认证<a class="hash-link" href="#77配置-web-身份认证" title="标题的直接链接">​</a></h2><p>需要输入用户名和密码才能访问站点的功能为 web 身份认证功能。nginx 中由 ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->auth<!-- -->_<!-- -->basic<!-- -->_<!-- -->module 模块提供该功能。指令包括 auth<!-- -->_<!-- -->basic 和 auth<!-- -->_<!-- -->basic<!-- -->_<!-- -->user<!-- -->_<!-- -->file。这两个指令可以在 http 根段、server 段、location 段使用。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">auth_basic string </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> off</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">auth_basic_user_file path/to/user_passwd_file        </span><span class="token comment" style="color:rgb(0, 128, 0)"># 密码文件使用相对路径时是相对conf目录的</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>passwd<!-- -->_<!-- -->file 的格式为：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">user1:passwd1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">user2:passwd2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>需要注意的是，密码文件不能使用明文密码的方式。该类文件一般使用 apache 提供的工具 htpasswd 生成，该工具在 httpd-tools 包中，也可以使用 openssl passwd 生成相关密码然后复制到密码文件中。以下是一个示例：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    listen </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server_name www.brinnatt.com  www1.brinnatt.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        root /www/brinnatt/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        index index.html index.htm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        auth_basic </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Auth your name&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        auth_basic_user_file /usr/local/nginx/conf/htpasswd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后使用 htpasswd 生成密码文件 /usr/local/nginx/conf/htpasswd。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># yum -y install httpd-tools</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># htpasswd -b -c -m /usr/local/nginx/conf/htpasswd Brinnatt CharMan</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Adding password </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> user Brinnatt</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># htpasswd -b -m /usr/local/nginx/conf/htpasswd Speedy Pretty</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Adding password </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> user Speedy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /usr/local/nginx/conf/htpasswd </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Brinnatt:</span><span class="token variable" style="color:rgb(9, 134, 88)">$apr1</span><span class="token variable" style="color:rgb(9, 134, 88)">$6x9yU</span><span class="token plain">/rm</span><span class="token variable" style="color:rgb(9, 134, 88)">$XXWnzw4PWVJN9i859bP921</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Speedy:</span><span class="token variable" style="color:rgb(9, 134, 88)">$apr1</span><span class="token variable" style="color:rgb(9, 134, 88)">$dXFV83fw</span><span class="token variable" style="color:rgb(9, 134, 88)">$Qg2PdbMgmDqH6DsHM7CRP</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>-b</code> 选项是表示 batch 模式，不用交互输入密码。</li><li><code>-c</code> 表示创建密码文件，只能为第一个用户使用该选项，否则后面使用会覆盖前面已经创建过的。</li><li><code>-m</code> 表示强制使用 md5。Brinnatt 和 Speedy 是需要验证的用户名，CharMan 和 Pretty 是对应的密码。</li></ul><p>然后重载配置文件，在浏览器中测试：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># nginx -s reload</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="78配置-https">7.8、配置 https<a class="hash-link" href="#78配置-https" title="标题的直接链接">​</a></h2><p>https 功能由 ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->ssl<!-- -->_<!-- -->module 模块提供。https 连接的认证过程参见 <a href="https://www.brinnatt.com/addons/%e7%ac%ac-c-1-%e7%ab%a0-linux-%e5%8a%a0%e5%af%86%e3%80%81%e7%ad%be%e5%90%8d%e5%92%8c-ssl-%e6%8f%a1%e6%89%8b%e6%9c%ba%e5%88%b6/" target="_blank" rel="noopener noreferrer">SSL 握手机制</a>。大致过程如下：</p><ol><li>客户端 say hello，并发送一个随机数给服务端。</li><li>服务端 say hello，并回复一个随机数给客户端。</li><li>服务端发送数字证书给客户端。</li><li>客户端使用信任的 CA 公钥解密数字证书得到服务端的公钥。</li><li>客户端使用服务端的公钥加密一个预备主密钥并发送给服务端。</li><li>服务端使用自己的私钥解密预备主密钥。</li><li>双方都得到了 2 个随机数加一个预备主密钥。通过这 3 个随机数形成一个会话主密钥，即 session key。至此 ssl 握手结束，连接的认证过程也完毕。</li></ol><p>对于服务端而言，在配置 https 时，需要提供自己的数字证书用于发送给客户端，还要提供自己的私钥用于解密客户端发送的预备主密钥。当 ssl 连接建立完成后，后续连接要传输的数据都采用 session key 进行加密，但注意 session key 是对称加密，客户端和服务端是一样的。</p><p>还需注意，在创建证书请求时，由于需要指定 common name，这时需要使用 https 的站点，因此每个 ssl 证书只能为一个 server<!-- -->_<!-- -->name 提供 https 服务。不过，通过特殊的配置方法，也能让一个 ssl 证书服务于整个域名或域名内的某些主机。</p><p>以下是配置文件中默认的关于 SSL 相关的指令设置：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)">#server {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#    listen       443 ssl;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#    server_name  localhost;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#    ssl_certificate      cert.pem;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#    ssl_certificate_key  cert.key;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#    ssl_session_cache    shared:SSL:1m;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#    ssl_session_timeout  5m;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#    ssl_ciphers  HIGH:!aNULL:!MD5;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#    ssl_prefer_server_ciphers  on;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#    location / {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#        root   html;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#        index  index.html index.htm;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#    }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以下是建立 https 的相关过程：</p><ol><li><p>自建 CA。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cd /etc/pki/CA/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 CA</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># tree .</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">├── certs</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">├── crl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">├── newcerts</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">└── private</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain"> directories, </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> files</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 CA</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># (umask 077;openssl genrsa -out private/cakey.pem 2048)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Generating RSA private key, </span><span class="token number" style="color:rgb(9, 134, 88)">2048</span><span class="token plain"> bit long modulus</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.+++</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.+++</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">e is </span><span class="token number" style="color:rgb(9, 134, 88)">65537</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">0x10001</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 CA</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># tree .</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">├── certs</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">├── crl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">├── newcerts</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">└── private</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   └── cakey.pem</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain"> directories, </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 CA</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 CA</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># openssl req -new -x509 -key private/cakey.pem -out cacert.pem -days 3650</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">You are about to be asked to enter information that will be incorporated</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">into your certificate request.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">What you are about to enter is what is called a Distinguished Name or a DN.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">There are quite a few fields but you can leave some blank</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">For some fields there will be a default value,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">If you enter </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;.&#x27;</span><span class="token plain">, the field will be left blank.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">-----</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Country Name </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> letter code</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">XX</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">:CN</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">State or Province Name </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">full name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">:Hunan</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Locality Name </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">eg, city</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Default City</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">:Changsha</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Organization Name </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">eg, company</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Default Company Ltd</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">:Secret   </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Organizational Unit Name </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">eg, section</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">:Secret</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Common Name </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">eg, your name or your server&#x27;s </span><span class="token function" style="color:rgb(0, 0, 255)">hostname</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">:aarch64       </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Email Address </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">:Secret</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 CA</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>建立相关序列和索引文件。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 CA</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># touch index.txt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 CA</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># echo &quot;01&quot; &gt; serial</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>nginx 端生成证书请求。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 CA</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># (umask 077;openssl genrsa -out /usr/local/nginx/aarch64.key 2048)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Generating RSA private key, </span><span class="token number" style="color:rgb(9, 134, 88)">2048</span><span class="token plain"> bit long modulus</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">+++</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">+++</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">e is </span><span class="token number" style="color:rgb(9, 134, 88)">65537</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">0x10001</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 CA</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># openssl req -new -key /usr/local/nginx/aarch64.key -out /usr/local/nginx/aarch64.csr</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>CA 为证书请求颁发证书。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># openssl ca -in /usr/local/nginx/aarch64.csr -out aarch64.crt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Using configuration from /etc/pki/tls/openssl.cnf</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Check that the request matches the signature</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Signature ok</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Certificate Details:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       Serial Number: </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">0x1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       Validity</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           Not Before: Oct </span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:36:48 </span><span class="token number" style="color:rgb(9, 134, 88)">2021</span><span class="token plain"> GMT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           Not After </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> Oct </span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:36:48 </span><span class="token number" style="color:rgb(9, 134, 88)">2022</span><span class="token plain"> GMT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       Subject:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           countryName               </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> CN</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           stateOrProvinceName       </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> Hunan</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           organizationName          </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> Secret</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           organizationalUnitName    </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> Secret</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           commonName                </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> aarch64</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           emailAddress              </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> Secret</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       X509v3 extensions:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           X509v3 Basic Constraints: </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">               CA:FALSE</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           Netscape Comment: </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">               OpenSSL Generated Certificate</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           X509v3 Subject Key Identifier: </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">               8B:C5:60:D6:A2:83:C0:99:26:8D:2B:1A:B0:4E:AE:BA:E6:08:8C:9D</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">           X509v3 Authority Key Identifier: </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">               keyid:19:E1:DE:4A:F3:88:65:99:0F:B7:9C:5F:1B:80:13:7A:6A:BE:64:05</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Certificate is to be certified </span><span class="token keyword" style="color:rgb(0, 0, 255)">until</span><span class="token plain"> Oct </span><span class="token number" style="color:rgb(9, 134, 88)">31</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:36:48 </span><span class="token number" style="color:rgb(9, 134, 88)">2022</span><span class="token plain"> GMT </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">365</span><span class="token plain"> days</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Sign the certificate? </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">y/n</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">:y</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> out of </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> certificate requests certified, commit? </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">y/n</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">y</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Write out database with </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> new entries</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Data Base Updated</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>将颁发的证书发送给 nginx 端。这里由于 CA 和 nginx 在同一主机上，所以直接移动即可。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># mv aarch64.crt /usr/local/nginx/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此时，在 /usr/local/nginx/ 目录下就有了 nginx 自己的<strong>私钥文件和证书文件</strong>。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cd /usr/local/nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 nginx</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ls aarch64.*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">aarch64.crt  aarch64.csr  aarch64.key</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>修改配置文件，配置 ssl 相关选项。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   listen       </span><span class="token number" style="color:rgb(9, 134, 88)">443</span><span class="token plain"> ssl</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   server_name  www.aarch64.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   ssl_certificate      /usr/local/nginx/aarch64.crt</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   ssl_certificate_key  /usr/local/nginx/aarch64.key</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   ssl_session_cache    shared:SSL:1m</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   ssl_session_timeout  5m</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   ssl_ciphers  HIGH:</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token plain">aNULL:</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token plain">MD5</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   ssl_prefer_server_ciphers  on</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       root   html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">       index  index.html index.htm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>重载配置文件。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># nginx -s reload</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>测试。在浏览器上输入 <code>https://www.aarch64.com</code> 测试。将会提示证书安全存在问题，说明配置成功。以后只要在客户端安装证书即可正常访问。测试时，建议使用 IE 浏览器或使用 IE 内核的浏览器测试，这样比较直观。使用 firefox、chrome 等浏览器可能会因为是自建的 CA 而出现一些问题。</p></li></ol><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="79nginx-版本平稳切换">7.9、nginx 版本平稳切换<a class="hash-link" href="#79nginx-版本平稳切换" title="标题的直接链接">​</a></h2><p>在说明如何稳定安全地升级、降级运行中的 nginx 之前，需要先了解 nginx 支持的几种信号。以下几种是主进程可以接收的信号，注意 worker 进程也可以接收一些信号，但和主进程的信号处理机制有些不一样，且主进程支持的信号 worker 进程不一定支持。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">SIGINT, SIGTERM  立即杀掉nginx主</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">即所有进程</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">SIGQUIT          graceful stop主进程</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">SIGWINCH         graceful stop所有的worker进程</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">SIGHUP           reload配置文件，并使老的worker进程graceful stop</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">SIGUSR1          重新打开日志文件</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">Reopen log files</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">SIGUSR2          在线切换nginx可执行程序</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">Upgrade the nginx executable on the fly</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>graceful stop 的行为是：(1) 进程不再监听、接受新的请求；(2) 进程继续处理正在处理的请求，但处理完成后销毁。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="791升级">7.9.1、升级<a class="hash-link" href="#791升级" title="标题的直接链接">​</a></h3><p>如果想对一个已运行的 nginx 实例进行版本升级，或者因为重新编译了一个版本而替换旧版本，可以考虑按照以下一系列过程来平稳、安全地升级。当然，如果直接停止服务不会产生多大影响，直接停掉再启动新版本 nginx 实例更方便简单。</p><ol><li><p>将新版本的 nginx 命令路径替换掉旧的 nginx 命令。</p><p>通常，对于编译安装的 nginx 来说，采用软链接的方式比较便捷。</p><ul><li>例如旧版本的安装路径为 /usr/local/nginx-1.12.1，为其建立一个软链接 /usr/local/nginx。</li><li>如果有新版本 /usr/local/nginx-1.12.2，只需修改软链接 /usr/local/nginx 的指向目标为 /usr/local/nginx-1.12.1 即可。这样 /usr/local/nginx/sbin/nginx 就会随着软链接的指向改变而指向新 nginx 程序。</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 当前编译了两个版本的nginx，如下很方便平滑切换</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ln -sv /usr/local/nginx-1.12.1/ /usr/local/nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">‘/usr/local/nginx’ -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> ‘/usr/local/nginx-1.12.1/’</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl start nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># nginx -v</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx version: nginx/1.12.1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ln -snfv /usr/local/nginx-1.12.2/ /usr/local/nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">‘/usr/local/nginx’ -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> ‘/usr/local/nginx-1.12.2/’</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># nginx -v</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx version: nginx/1.12.2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>注意</strong>：ln -snfv 其中的 -n 选项很重要，不然得不到想要的结果。</li></ul></li><li><p>对旧 nginx 实例的主进程发送 USR2 信号。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># kill -USR2 cat /var/run/nginx/nginx.pid</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>该信号提示 nginx 旧的主进程要升级，并执行新的 nginx 程序。</p><ul><li>例如步骤 1 中，旧的 nginx 主进程为 /usr/local/nginx/sbin/nginx，但其指向的是 /usr/local/nginx-1.12.1/sbin/nginx，发送该信号后仍将执行 /usr/local/nginx/sbin/nginx，但此时因为软链接目标已改变，使得此时启动的 nginx 已经是 /usr/local/nginx-1.12.2/sbin/nginx 程序。</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ps aux | egrep &#x27;(ngin[x]|PI[D])&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token environment constant" style="color:rgb(129, 31, 63)">USER</span><span class="token plain">       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root      </span><span class="token number" style="color:rgb(9, 134, 88)">8900</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">   </span><span class="token number" style="color:rgb(9, 134, 88)">9920</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">2140</span><span class="token plain"> ?        Ss   </span><span class="token number" style="color:rgb(9, 134, 88)">23</span><span class="token plain">:08   </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">:00 nginx: master process /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx     </span><span class="token number" style="color:rgb(9, 134, 88)">8901</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">10492</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">3504</span><span class="token plain"> ?        S    </span><span class="token number" style="color:rgb(9, 134, 88)">23</span><span class="token plain">:08   </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">:00 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root      </span><span class="token number" style="color:rgb(9, 134, 88)">8923</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">   </span><span class="token number" style="color:rgb(9, 134, 88)">9924</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">5300</span><span class="token plain"> ?        S    </span><span class="token number" style="color:rgb(9, 134, 88)">23</span><span class="token plain">:11   </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">:00 nginx: master process /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx     </span><span class="token number" style="color:rgb(9, 134, 88)">8924</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">10496</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">3592</span><span class="token plain"> ?        S    </span><span class="token number" style="color:rgb(9, 134, 88)">23</span><span class="token plain">:11   </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">:00 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>此外，发送该信号后将会切换 pid 文件，旧的 pid 文件被重命名为 nginx.pid.oldbin，记录的是旧的 nginx 主进程 pid 值，新的 pid 文件为 nginx.pid，记录的是新启动的 nginx 的主进程 pid 值。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ls /var/run/nginx/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx.pid  nginx.pid.oldbin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li><li><p>这一步与第 4 步任选一个，graceful stop 旧的主进程号。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># kill -QUIT cat /var/run/nginx/nginx.pid.oldbin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ls /var/run/nginx/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx.pid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ps aux | egrep &#x27;(ngin[x]|PI[D])&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token environment constant" style="color:rgb(129, 31, 63)">USER</span><span class="token plain">       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">root      </span><span class="token number" style="color:rgb(9, 134, 88)">8923</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">   </span><span class="token number" style="color:rgb(9, 134, 88)">9924</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">5300</span><span class="token plain"> ?        S    </span><span class="token number" style="color:rgb(9, 134, 88)">23</span><span class="token plain">:11   </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">:00 nginx: master process /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx     </span><span class="token number" style="color:rgb(9, 134, 88)">8924</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">0.0</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">10496</span><span class="token plain">  </span><span class="token number" style="color:rgb(9, 134, 88)">3592</span><span class="token plain"> ?        S    </span><span class="token number" style="color:rgb(9, 134, 88)">23</span><span class="token plain">:11   </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">:00 nginx: worker process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>向旧的主进程号发送 QUIT 信号，该信号将使得主进程以 graceful 的方式关闭。这将使得旧的主进程、旧的 worker 进程不再接受任何新请求，但却会把正在处理过程中的请求处理完毕，然后被销毁退出。</li></ul></li><li><p>更稳妥的方式是先让 worker 进程 graceful stop，在新版本的 nginx 实例运行一小段时间后如果正常工作，再 graceful stop 旧的主进程。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">kill</span><span class="token plain"> -WINCH </span><span class="token function" style="color:rgb(0, 0, 255)">cat</span><span class="token plain"> /var/run/nginx/nginx.pid.oldbin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># a period of time goes, graceful stop old master nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">kill</span><span class="token plain"> -QUIT </span><span class="token function" style="color:rgb(0, 0, 255)">cat</span><span class="token plain"> /var/run/nginx/nginx.pid.oldbin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在发送 WINCH 信号给旧的主进程后，旧的 worke r进程将逐渐退出，但旧的主进程却会保留不退出。</p><p>如果发现新版本的 nginx 实例不满意，可以直接向旧主进程号发送 HUP 信号，这样旧的主进程就会重新读取配置文件并 fork 新的 worker 进程，再将新的主进程号杀掉(可以 graceful stop)，就可以还原为旧版本的 nginx 实例。</p></li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="792降级">7.9.2、降级<a class="hash-link" href="#792降级" title="标题的直接链接">​</a></h3><p>上面第 4 步其实就是最安全的降级方式。即：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">kill</span><span class="token plain"> -HUP </span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token variable function" style="color:rgb(0, 0, 255)">cat</span><span class="token variable" style="color:rgb(9, 134, 88)"> /var/run/nginx/nginx.pid.oldbin</span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">kill</span><span class="token plain"> -QUIT </span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token variable function" style="color:rgb(0, 0, 255)">cat</span><span class="token variable" style="color:rgb(9, 134, 88)"> /var/run/nginx/nginx.pid</span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>但如果旧的主进程号已经被杀掉了，目前只有新版本的 nginx 实例在运行，那么只需以升级的步骤进行降级即可。即：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">kill</span><span class="token plain"> -USR2 </span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token variable function" style="color:rgb(0, 0, 255)">cat</span><span class="token variable" style="color:rgb(9, 134, 88)"> /var/run/nginx/nginx.pid</span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">kill</span><span class="token plain"> -QUIT </span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token variable function" style="color:rgb(0, 0, 255)">cat</span><span class="token variable" style="color:rgb(9, 134, 88)"> /var/run/nginx/nginx.pid.oldbin</span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="793一键升级脚本">7.9.3、一键升级脚本<a class="hash-link" href="#793一键升级脚本" title="标题的直接链接">​</a></h3><p>以下是升级的脚本。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Legacy action script for &quot;service nginx upgrade&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Source function library.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> -f /etc/rc.d/init.d/functions </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token plain"> /etc/rc.d/init.d/functions</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> -f /etc/sysconfig/nginx </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token plain"> /etc/sysconfig/nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">prefix</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/usr/local/nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">prog</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">nginx</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable" style="color:rgb(9, 134, 88)">$prefix</span><span class="token plain">/sbin/nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">conffile</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable" style="color:rgb(9, 134, 88)">$prefix</span><span class="token plain">/conf/nginx.conf</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">pidfile</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/var/run/nginx.pid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">SLEEPSEC</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable" style="color:rgb(9, 134, 88)">${SLEEPSEC</span><span class="token variable operator" style="color:rgb(0, 0, 0)">:-</span><span class="token variable" style="color:rgb(9, 134, 88)">1}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">UPGRADEWAITLOOPS</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable" style="color:rgb(9, 134, 88)">${UPGRADEWAITLOOPS</span><span class="token variable operator" style="color:rgb(0, 0, 0)">:-</span><span class="token variable" style="color:rgb(9, 134, 88)">5}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">oldbinpidfile</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable" style="color:rgb(9, 134, 88)">${pidfile}</span><span class="token plain">.oldbin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 配置文件语法检查</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token variable" style="color:rgb(9, 134, 88)">${nginx}</span><span class="token plain"> -t -c </span><span class="token variable" style="color:rgb(9, 134, 88)">${conffile}</span><span class="token plain"> -q </span><span class="token operator" style="color:rgb(0, 0, 0)">||</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> -n $</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Starting new master </span><span class="token string variable" style="color:rgb(9, 134, 88)">$prog</span><span class="token string" style="color:rgb(163, 21, 21)">: &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 发送USR2信号升级nginx可执行程序</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">killproc -p </span><span class="token variable" style="color:rgb(9, 134, 88)">${pidfile}</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">${prog}</span><span class="token plain"> -USR2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:rgb(9, 134, 88)">i</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token variable" style="color:rgb(9, 134, 88)">/usr/bin/seq $UPGRADEWAITLOOPS</span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    /bin/sleep </span><span class="token variable" style="color:rgb(9, 134, 88)">$SLEEPSEC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> -f </span><span class="token variable" style="color:rgb(9, 134, 88)">${oldbinpidfile}</span><span class="token plain"> -a -f </span><span class="token variable" style="color:rgb(9, 134, 88)">${pidfile}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> -n $</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Graceful shutdown of old </span><span class="token string variable" style="color:rgb(9, 134, 88)">$prog</span><span class="token string" style="color:rgb(163, 21, 21)">: &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)"># graceful stop旧主nginx主进程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        killproc -p </span><span class="token variable" style="color:rgb(9, 134, 88)">${oldbinpidfile}</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">${prog}</span><span class="token plain"> -QUIT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">exit</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> $</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Upgrade failed!&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">exit</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="710搭建-lnmp-环境">7.10、搭建 LNMP 环境<a class="hash-link" href="#710搭建-lnmp-环境" title="标题的直接链接">​</a></h2><p>nginx 和 php-fpm 有两种通信方式：<strong>tcp socket 和 unix socket</strong>。tcp socket 可以跨主机配置 nginx+php-fpm，unix socket 是同一主机进程间通信的一种方式，数据的进出都是在内核中进行，效率比 tcp socket 高，要求 php-fpm 开启 sock 监听，且不能跨主机配置 nginx+php-fpm。因此，如果 nginx+php-fpm 在同一主机上时，建议使用 unix socket 的连接通信方式。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7101编译-nginx">7.10.1、编译 nginx<a class="hash-link" href="#7101编译-nginx" title="标题的直接链接">​</a></h3><p>rpm 包格式的 nginx 地址：<a href="http://nginx.org/packages/" target="_blank" rel="noopener noreferrer">http://nginx.org/packages/</a>。</p><p>源码包下载地址：<a href="http://nginx.org/en/download.html" target="_blank" rel="noopener noreferrer">http://nginx.org/en/download.html</a> 。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@casually ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># groupadd -r nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@casually ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># useradd -r -g nginx nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@casually ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># yum groups install &quot;Development Tools&quot; -y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@casually ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># wget http://nginx.org/download/nginx-1.12.2.tar.gz</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@casually ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># tar xf nginx-1.12.2.tar.gz</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@casually ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cd nginx-1.12.2/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@casually nginx-1.12.2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@casually nginx-1.12.2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># yum install pcre-devel openssl-devel -y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@casually nginx-1.12.2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ./configure \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">   --user</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">nginx </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">   --group</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">nginx </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">   --prefix</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/usr/local/nginx-1.12.2 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">   --error-log-path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/var/log/nginx/error.log </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">   --http-log-path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/var/log/nginx/access.log </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">   --pid-path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/var/run/nginx/nginx.pid  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">   --lock-path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/var/lock/subsys/nginx </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">   --with-http_ssl_module </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">   --with-http_flv_module </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">   --with-http_stub_status_module </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">   --with-http_gzip_static_module </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">   --with-pcre </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">   --with-threads</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@casually nginx-1.12.2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># make &amp;&amp; make install</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@casually ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ln -sv /usr/local/nginx-1.12.2/ /usr/local/nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">‘/usr/local/nginx’ -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> ‘/usr/local/nginx-1.12.2/’</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p><code>./configure</code> 过程中，<code>--with-XX_module</code> 的表示启用某模块即功能，<code>--without-XX_module</code> 表示禁用模块即功能。</p></li><li><p>在 <code>./configure --help</code> 的结果中，出现 <code>--with-XX_module</code> 的表示 XX 模块默认是禁用的，需要手动启用，出现 <code>--without-XX_module</code> 表示 XX 模块默认是启用的，需要手动禁用。</p></li><li><p>以下是一些常见选项的说明：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">--prefix</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/usr/local/nginx-1.12.2          </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定义安装路径，不写时默认为/usr/local/nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--sbin-path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">                                </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定义应用程序存放路径，不写时默认为/sbin/nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--conf-path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">                                </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定义配置文件路径，不写时默认为/conf/nginx.conf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--error-log-path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/var/log/nginx/error.log   </span><span class="token comment" style="color:rgb(0, 128, 0)"># 在配置文件中没有指定error log时的错误日志路径，不写时默认为/logs/error.log</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--http-log-path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/var/log/nginx/access.log   </span><span class="token comment" style="color:rgb(0, 128, 0)"># 在配置文件中没有指定access log时的访问日志路径, 不写时默认为/logs/access.log</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--pid-path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/var/run/nginx/nginx.pid         </span><span class="token comment" style="color:rgb(0, 128, 0)"># pid文件路径，没指定时默认为/logs/nginx.pid</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--lock-path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/var/lock/subsys/nginx          </span><span class="token comment" style="color:rgb(0, 128, 0)"># 锁文件路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--user</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">nginx                                </span><span class="token comment" style="color:rgb(0, 128, 0)"># 在配置文件中没有指定user指定时，worker进程的运行身份,不写时默认为nobody</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--group</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">nginx                                 </span><span class="token comment" style="color:rgb(0, 128, 0)"># 在配置文件中没有指定user(不是group，配置文件中没有group指令)指定时，worker进程的运行组</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--with-select_module                          </span><span class="token comment" style="color:rgb(0, 128, 0)"># 启用select方法模型，当找不到epoll时自动启用select</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--without-select_module   </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--with-poll_module                            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 启用poll方法模型，当找不到epoll时自动启用poll</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--without-poll_module  </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--with-http_ssl_module                        </span><span class="token comment" style="color:rgb(0, 128, 0)"># 启用ssl功能</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--with-http_flv_module                        </span><span class="token comment" style="color:rgb(0, 128, 0)"># 启用flv视频流功能</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--with-http_stub_status_module                </span><span class="token comment" style="color:rgb(0, 128, 0)"># 启用nginx状态监控功能，在启动后在浏览器使用root/status显示状态信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--with-http_gzip_static_module                </span><span class="token comment" style="color:rgb(0, 128, 0)"># 启用gzip压缩功能压缩web服务器响应客户端的响应报文</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--http-client-body-temp-path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/var/tmp/nginx/client   </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定义客户端请求报文主体的临时文件存放路径，不写为/client_body_temp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--http-proxy-temp-path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/var/tmp/nginx/proxy          </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定义从代理服务器收到的临时文件存放路径，不写为/proxy_temp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--http-fastcgi-temp-path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/var/tmp/nginx/fcgi         </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定义从fastcgi服务器收到的临时文件存放路径，不写为/fastcgi_temp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--http-uwsgi-temp-path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/var/tmp/nginx/uwsgi          </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定义从uwsgi服务器收到的临时文件存放路径，不写为/uwsgi_temp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--http-scgi-temp-path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/var/tmp/nginx/scgi            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定义从scgi服务器收到的临时文件存放路径，不写为/scgi_temp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--with-pcre                                          </span><span class="token comment" style="color:rgb(0, 128, 0)"># 设置pcre库的路径，yum安装的pcre-devel可以不写路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--with-threads                                       </span><span class="token comment" style="color:rgb(0, 128, 0)"># 设置nginx支持多线程</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><p>在前面的编译选项中，安装路径使用了版本号，且未指定程序目录和配置文件路径，虽说提供了它们很方便，但是在升级 nginx 版本有些麻烦。</p><p>所以，通过最后一步建立软链接的方式，让一切都变得简单，可以将新旧版本的 nginx 分离开来。这种方式安装 nginx，配置文件默认为 <code>&lt;prefix&gt;/conf/nginx.conf</code>，应用程序路径为 <code>&lt;prefix&gt;/sbin/nginx</code>。</p><p>提供服务管理脚本 /etc/rc.d/init.d/nginx：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># nginx - this script starts and stops the nginx daemon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># chkconfig:   - 85 15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># description:  Nginx is an HTTP(S) server, HTTP(S) reverse \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#               proxy and IMAP/POP3 proxy server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Source function library.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token plain"> /etc/rc.d/init.d/functions</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Source networking configuration.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token plain"> /etc/sysconfig/network</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Check that networking is up.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">$NETWORKING</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;no&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">exit</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">nginx</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;/usr/local/nginx/sbin/nginx&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">prog</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable" style="color:rgb(9, 134, 88)">$(</span><span class="token variable function" style="color:rgb(0, 0, 255)">basename</span><span class="token variable" style="color:rgb(9, 134, 88)"> $nginx</span><span class="token variable" style="color:rgb(9, 134, 88)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">sysconfig</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;/etc/sysconfig/</span><span class="token string variable" style="color:rgb(9, 134, 88)">$prog</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">lockfile</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;/var/lock/subsys/nginx&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">pidfile</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;/var/run/nginx/nginx.pid&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">NGINX_CONF_FILE</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;/usr/local/nginx/conf/nginx.conf&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> -f </span><span class="token variable" style="color:rgb(9, 134, 88)">$sysconfig</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$sysconfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function-name function" style="color:rgb(0, 0, 255)">start</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> -x </span><span class="token variable" style="color:rgb(9, 134, 88)">$nginx</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">||</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">exit</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> -f </span><span class="token variable" style="color:rgb(9, 134, 88)">$NGINX_CONF_FILE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">||</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">exit</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> -n $</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Starting </span><span class="token string variable" style="color:rgb(9, 134, 88)">$prog</span><span class="token string" style="color:rgb(163, 21, 21)">: &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    daemon </span><span class="token variable" style="color:rgb(9, 134, 88)">$nginx</span><span class="token plain"> -c </span><span class="token variable" style="color:rgb(9, 134, 88)">$NGINX_CONF_FILE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">retval</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable" style="color:rgb(9, 134, 88)">$?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$retval</span><span class="token plain"> -eq </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">touch</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$lockfile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$retval</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function-name function" style="color:rgb(0, 0, 255)">stop</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> -n $</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Stopping </span><span class="token string variable" style="color:rgb(9, 134, 88)">$prog</span><span class="token string" style="color:rgb(163, 21, 21)">: &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    killproc -p </span><span class="token variable" style="color:rgb(9, 134, 88)">$pidfile</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$prog</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">retval</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable" style="color:rgb(9, 134, 88)">$?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$retval</span><span class="token plain"> -eq </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">rm</span><span class="token plain"> -f </span><span class="token variable" style="color:rgb(9, 134, 88)">$lockfile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$retval</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function-name function" style="color:rgb(0, 0, 255)">restart</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    configtest_q </span><span class="token operator" style="color:rgb(0, 0, 0)">||</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stop</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    start</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function-name function" style="color:rgb(0, 0, 255)">reload</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    configtest_q </span><span class="token operator" style="color:rgb(0, 0, 0)">||</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> -n $</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Reloading </span><span class="token string variable" style="color:rgb(9, 134, 88)">$prog</span><span class="token string" style="color:rgb(163, 21, 21)">: &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    killproc -p </span><span class="token variable" style="color:rgb(9, 134, 88)">$pidfile</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$prog</span><span class="token plain"> -HUP</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function-name function" style="color:rgb(0, 0, 255)">configtest</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token variable" style="color:rgb(9, 134, 88)">$nginx</span><span class="token plain"> -t -c </span><span class="token variable" style="color:rgb(9, 134, 88)">$NGINX_CONF_FILE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function-name function" style="color:rgb(0, 0, 255)">configtest_q</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token variable" style="color:rgb(9, 134, 88)">$nginx</span><span class="token plain"> -t -q -c </span><span class="token variable" style="color:rgb(9, 134, 88)">$NGINX_CONF_FILE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function-name function" style="color:rgb(0, 0, 255)">rh_status</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    status </span><span class="token variable" style="color:rgb(9, 134, 88)">$prog</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function-name function" style="color:rgb(0, 0, 255)">rh_status_q</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    rh_status </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">/dev/null </span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">2</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token file-descriptor important">&amp;1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Upgrade the binary with no downtime.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function-name function" style="color:rgb(0, 0, 255)">upgrade</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">oldbin_pidfile</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">${pidfile}</span><span class="token string" style="color:rgb(163, 21, 21)">.oldbin&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    configtest_q </span><span class="token operator" style="color:rgb(0, 0, 0)">||</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> -n $</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Upgrading </span><span class="token string variable" style="color:rgb(9, 134, 88)">$prog</span><span class="token string" style="color:rgb(163, 21, 21)">: &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    killproc -p </span><span class="token variable" style="color:rgb(9, 134, 88)">$pidfile</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$prog</span><span class="token plain"> -USR2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">retval</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable" style="color:rgb(9, 134, 88)">$?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">sleep</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> -f </span><span class="token variable" style="color:rgb(9, 134, 88)">${oldbin_pidfile}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&amp;&amp;</span><span class="token plain"> -f </span><span class="token variable" style="color:rgb(9, 134, 88)">${pidfile}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">  </span><span class="token keyword" style="color:rgb(0, 0, 255)">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        killproc -p </span><span class="token variable" style="color:rgb(9, 134, 88)">$oldbin_pidfile</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$prog</span><span class="token plain"> -QUIT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        success $</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">$prog</span><span class="token string" style="color:rgb(163, 21, 21)"> online upgrade&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        failure $</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">$prog</span><span class="token string" style="color:rgb(163, 21, 21)"> online upgrade&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Tell nginx to reopen logs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function-name function" style="color:rgb(0, 0, 255)">reopen_logs</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    configtest_q </span><span class="token operator" style="color:rgb(0, 0, 0)">||</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> -n $</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Reopening </span><span class="token string variable" style="color:rgb(9, 134, 88)">$prog</span><span class="token string" style="color:rgb(163, 21, 21)"> logs: &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    killproc -p </span><span class="token variable" style="color:rgb(9, 134, 88)">$pidfile</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$prog</span><span class="token plain"> -USR1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">retval</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable" style="color:rgb(9, 134, 88)">$?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$retval</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">case</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">$1</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    start</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        rh_status_q </span><span class="token operator" style="color:rgb(0, 0, 0)">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">exit</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token variable" style="color:rgb(9, 134, 88)">$1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stop</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        rh_status_q </span><span class="token operator" style="color:rgb(0, 0, 0)">||</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">exit</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token variable" style="color:rgb(9, 134, 88)">$1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    restart</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">configtest</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">reopen_logs</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token variable" style="color:rgb(9, 134, 88)">$1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    force-reload</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">upgrade</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        rh_status_q </span><span class="token operator" style="color:rgb(0, 0, 0)">||</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">exit</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        upgrade</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    reload</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        rh_status_q </span><span class="token operator" style="color:rgb(0, 0, 0)">||</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">exit</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token variable" style="color:rgb(9, 134, 88)">$1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    status</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">status_q</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        rh_</span><span class="token variable" style="color:rgb(9, 134, 88)">$1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    condrestart</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">try-restart</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        rh_status_q </span><span class="token operator" style="color:rgb(0, 0, 0)">||</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">exit</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        restart</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    *</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> $</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Usage: </span><span class="token string variable" style="color:rgb(9, 134, 88)">$0</span><span class="token string" style="color:rgb(163, 21, 21)"> {start|stop|reload|configtest|status|force-reload|upgrade|restart|reopen_logs}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">exit</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">esac</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果是 systemd 管理，则提供 /usr/lib/systemd/system/nginx.service：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Description</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">The nginx HTTP and reverse proxy server</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">After</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">network.target remote-fs.target nss-lookup.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">forking</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">PIDFile</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/var/run/nginx/nginx.pid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Nginx will fail to start if /run/nginx.pid already exists but has the wrong</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># SELinux context. This might happen when running `nginx -t` from the cmdline.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># https://bugzilla.redhat.com/show_bug.cgi?id=1268621</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecStartPre</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/usr/bin/rm -f /var/run/nginx/nginx.pid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecStartPre</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecStart</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecReload</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/bin/kill -s HUP </span><span class="token variable" style="color:rgb(9, 134, 88)">$MAINPID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">KillSignal</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">SIGQUIT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">TimeoutStopSec</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">KillMode</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">process</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">PrivateTmp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">true</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">WantedBy</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">multi-user.target</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最后，将 nginx 命令加入环境变量：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@casually ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># echo &#x27;export PATH=/usr/local/nginx/sbin:$PATH&#x27; &gt; /etc/profile.d/nginx.sh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@casually ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># . /etc/profile.d/nginx.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>启动 nginx 服务：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@casually ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl daemon-reload </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@casually ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl start nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@casually ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ss -tnlpu | grep 80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">tcp    LISTEN     </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">      </span><span class="token number" style="color:rgb(9, 134, 88)">128</span><span class="token plain">       *:80                    *:*                   users:</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">((</span><span class="token variable" style="color:rgb(9, 134, 88)">&quot;nginx&quot;</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token variable" style="color:rgb(9, 134, 88)">pid</span><span class="token variable operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable number" style="color:rgb(9, 134, 88)">25020</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token variable" style="color:rgb(9, 134, 88)">fd</span><span class="token variable operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable number" style="color:rgb(9, 134, 88)">6</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token variable" style="color:rgb(9, 134, 88)">&quot;nginx&quot;</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token variable" style="color:rgb(9, 134, 88)">pid</span><span class="token variable operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable number" style="color:rgb(9, 134, 88)">25019</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token variable" style="color:rgb(9, 134, 88)">fd</span><span class="token variable operator" style="color:rgb(0, 0, 0)">=</span><span class="token variable number" style="color:rgb(9, 134, 88)">6</span><span class="token variable punctuation" style="color:rgb(4, 81, 165)">))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@casually ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7102编译-php">7.10.2、编译 PHP<a class="hash-link" href="#7102编译-php" title="标题的直接链接">​</a></h3><p>编译过程可以参见 <a href="https://www.brinnatt.com/high/%e7%ac%ac-6-%e7%ab%a0-linux-httpd-%e6%9c%8d%e5%8a%a1%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/#692%E3%80%81%E7%BC%96%E8%AF%91_php" target="_blank" rel="noopener noreferrer">php 编译过程</a></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># wget https://www.php.net/distributions/php-5.5.38.tar.gz</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># yum install -y bzip2-devel libmcrypt-devel openssl-devel libxml2-devel libsqlite3x-devel oniguruma-devel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># tar xf php-5.5.38.tar.bz2 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cd php-5.5.38/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 php-5.5.38</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ./configure --prefix=/usr/local/php --with-openssl --enable-mbstring --enable-sockets --with-freetype-dir --with-jpeg-dir --with-png-dir --with-libxml-dir=/usr --enable-xml --with-zlib --with-mcrypt --with-bz2 --with-mhash --with-config-file-path=/etc --with-config-file-scan-dir=/etc/php.d --with-mysql=mysqlnd --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --enable-fpm</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 php-5.5.38</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># make &amp;&amp; make install</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 提供php配置文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 php-5.5.38</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cp php.ini-production /etc/php.ini</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 提供php-fpm服务管理脚本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 php-5.5.38</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cp sapi/fpm/init.d.php-fpm /etc/init.d/php-fpmd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 php-5.5.38</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># chmod +x /etc/init.d/php-fpmd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 提供php-fpm配置文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 php-5.5.38</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cd /usr/local/php/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 php</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cp etc/php-fpm.conf.default etc/php-fpm.conf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 修改php-fpm配置文件(做实验的话改不改随意)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 php</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># vim etc/php-fpm.conf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">listen </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.44:9000</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">pm.max_children </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">50</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">pm.start_servers </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">pm.min_spare_servers </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">pm.max_spare_servers </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 启动php-fpm</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@aarch64 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># service php-fpmd start</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Starting php-fpm  </span><span class="token keyword" style="color:rgb(0, 0, 255)">done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7103配置-nginx-和-php-fpm-交互tcp-socket">7.10.3、配置 nginx 和 php-fpm 交互(tcp socket)<a class="hash-link" href="#7103配置-nginx-和-php-fpm-交互tcp-socket" title="标题的直接链接">​</a></h3><p>在 nginx 配置文件中加入类似如下 location 容器：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">location ~ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">.php$ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    root           /php/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 注意，默认的php-fpm监听在127.0.0.1:9000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    fastcgi_pass   </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.44:9000</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    fastcgi_index  index.php</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    fastcgi_param  SCRIPT_FILENAME  </span><span class="token variable" style="color:rgb(9, 134, 88)">$document_root</span><span class="token variable" style="color:rgb(9, 134, 88)">$fastcgi_script_name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    include        fastcgi_params</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>location 表示当请求的 url 能匹配以 .php 结尾时，将以该容器的指令进行处理。</p></li><li><p>root 指令将此容器的 document<!-- -->_<!-- -->root 设置为 /php/。</p></li><li><p>fastcgi<!-- -->_<!-- -->pass 指令表示将该 url 请求代理至 192.168.122.44 主机上运行的 php-fpm，由于此处设置了 SCRIPT<!-- -->_<!-- -->FILENAME，所以当请求的 uri 为 /a/a.php 时，<code>$document_root=/php/</code>，<code>$fastcgi_script_name=/a/a.php</code>，这表示转发请求至 192.168.122.44 主机上的 /php/a/a.php。</p><ul><li>所以，<strong>在 php-fpm 所在主机</strong> 192.168.122.44 上必须将 a.php 放在事先已创建好的 /php/ 目录下，<strong>这和 nginx 主机</strong>上是否有 /php/ 目录无关。</li></ul></li><li><p>这里的 include 包含的文件都是一些 fastcgi<!-- -->_<!-- -->param 指令，fastcgi<!-- -->_<!-- -->param 指令是 nginx 将相关参数赋值给 php-fpm 所需变量，并将它们传递给 php-fpm，使得 php-fpm 知道处理哪个文件、如何处理、处理的环境是如何的。</p></li><li><p>此处额外定义了一个 php-fpm 所需的变量 SCRIPT<!-- -->_<!-- -->FILENAME，因为该变量没有包含在 fastcgi<!-- -->_<!-- -->params 文件中。如果是 rpm 包安装的 nginx，则在 fastcgi.conf 文件中已包含该变量，此时简写为如下配置即可：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">location ~ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">.php$ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  root           /php/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  fastcgi_pass   </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.44:9000</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  fastcgi_index  index.php</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  include        fastcgi.conf</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>还需注意，fastcgi<!-- -->_<!-- -->index 在此处是多余的。该指令表示的是当代理请求至 php-fpm 上时，如果 uri 以 &quot;/&quot; 结尾(严格地说，是 <code>$fastcgi_script_name</code> 的值以斜线结尾)，则自动添加上此处指定的 index.php。</p><ul><li>但注意，此处的 location 的匹配条件是以 .php 结尾，是不可能匹配以斜线结尾的，因此此处的 fastcgi<!-- -->_<!-- -->index 指令是多余的。但如果修改为如下配置：</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">location ~ .*php </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    root           /php/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    fastcgi_pass   </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.44:9000</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    fastcgi_index  index.php</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    include        fastcgi.conf</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>则 fastcgi<!-- -->_<!-- -->index 是能派上用场的，例如请求的 uri 为 &quot;/a/php/&quot;，则将执行 192.168.122.44 上的 /php/a/php/index.php 文件。</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7104配置-nginx-和-php-fpm-交互unix-socket">7.10.4、配置 nginx 和 php-fpm 交互(unix socket)<a class="hash-link" href="#7104配置-nginx-和-php-fpm-交互unix-socket" title="标题的直接链接">​</a></h3><p>要配置 unix socket 的通信方式，只需将 php-fpm 监听在 unix socket 上即可。</p><p>修改 php-fpm.conf：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">listen </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:9000</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">listen </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /dev/shm/php-cgi.sock</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>这里的路径是 /dev/shm，这是将内存化为虚拟磁盘用的，效率比磁盘速度高得多。</li></ul><p>再在 nginx.conf 中的 fastcgi<!-- -->_<!-- -->pass 改为 <code>unix://</code> 协议即可。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">fastcgi_pass unix:/dev/shm/php-cgi.sock</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="711nginx-反向代理">7.11、nginx 反向代理<a class="hash-link" href="#711nginx-反向代理" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7111正反代理概念">7.11.1、正反代理概念<a class="hash-link" href="#7111正反代理概念" title="标题的直接链接">​</a></h3><p>正向代理是众多内网客户机上网访问互联网上的网站时，将所有的请求交给内网前面处于公网上的 &quot;管家&quot; 服务器，由 &quot;管家&quot; 服务器代为请求想要访问的 web 服务器，然后将得到的结果缓存下来并提供给客户端，这是正向代理。&quot;管家&quot; 服务器称为正向代理服务器。</p><p><img loading="lazy" alt="http forward direction" src="/assets/images/http forward direction-936cc21452de5fe344fdf7f0370f2242.png" width="990" height="427" class="img_ev3q"></p><p>反向代理是客户端访问 web 服务器时，请求发送到真实的 web 服务器的前端 &quot;助手&quot; 服务器上，由 &quot;助手&quot; 服务器决定将此请求转发给哪个真实的 web 服务器，外界客户端以为 &quot;助手&quot; 服务器就是真实的 web 服务器，而实际上它不是，也不需要安装任何 web 程序。&quot;助手&quot; 服务器称为反向代理服务器。</p><p><img loading="lazy" alt="http reverse direction" src="/assets/images/http reverse direction-95b2369e91406ad54760db3ee39fc25c.png" width="910" height="539" class="img_ev3q"></p><p>nginx 是一个优秀的反向代理服务程序，通过反向代理可以实现负载均衡的效果。因为是通过反向代理实现的负载均衡，所以 nginx 实现的是七层负载均衡。它能够识别 http 协议，根据 http 报文将不同类型的请求转发到不同的后端 web 服务器上。后端的 web 服务器称为 &quot;上游服务器&quot;，即 upstream 服务器。</p><p>实际上，nginx 和 php-fpm 结合的时候，指令 fastcgi<!-- -->_<!-- -->pass 实现的也是反向代理的功能，只不过这种代理功能是特定的功能，只能转发给 php-fpm。</p><p>nginx 的反向代理有几种实现方式：</p><ol><li>仅使用模块 ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->proxy<!-- -->_<!-- -->module 实现简单的反向代理。指令为 proxy<!-- -->_<!-- -->pass。</li><li>使用 fastcgi 模块提供的功能，反向代理动态内容。指令为 fastcgi<!-- -->_<!-- -->pass。</li><li>使用 ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->memcached<!-- -->_<!-- -->module 模块提供的功能，反向代理 memcached 缓存内容，指令为 memcached<!-- -->_<!-- -->pass。</li><li>结合 upstream 模块实现更人性化的分组反向代理。</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7112反向代理基础实验">7.11.2、反向代理基础实验<a class="hash-link" href="#7112反向代理基础实验" title="标题的直接链接">​</a></h3><p>实验环境如下图：</p><p><img loading="lazy" alt="simple nginx proxy" src="/assets/images/simple nginx proxy-43b50391223204d80770530aa255e0ca.png" width="784" height="589" class="img_ev3q"></p><p><strong>第 1 步</strong>：反向代理服务器 nginx-proxy(192.168.122.45) 的配置。由于是做代理，所以配置文件的 location 段不再需要 root、index 等指令，只需几个和代理相关的指令即可：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    listen       </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server_name  www.brinnatt.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location ~ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">png</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">jpg</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">jpeg</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">bmp</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">gif</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">$ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_pass http://192.168.122.48:80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_pass http://192.168.122.49:80/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location ~ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">php</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">php5</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">$ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_pass http://192.168.122.46:80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    error_page   </span><span class="token number" style="color:rgb(9, 134, 88)">500</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">502</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">503</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">504</span><span class="token plain">  /50x.html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /50x.html </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        root   html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>第 2 步</strong>：提供动态服务的 nginx 服务器(192.168.122.46) 的配置如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    listen       </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server_name  www.brinnatt.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        root    /www/brinnatt/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        index   index.php index.html index.htm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location ~ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">.php$ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        root /php/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        fastcgi_pass    </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.47:9000</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        fastcgi_index   nomatch.php</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        include         fastcgi.conf</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中 php-fpm 服务器(192.168.122.47) 上的 /php/info.php 内容如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">This is php-fpm server individually</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">?php</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">phpinfo</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">?</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意：如果 php-fpm 服务是用 rpm 包安装的，记得要改 /etc/php-fpm.d/www.conf。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">listen </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.47:9000        </span><span class="token comment" style="color:rgb(0, 128, 0)"># 修改监听地址配合其他服务器实验</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">listen.allowed_clients </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 这是个坑，如果 php-fpm 是个独立的服务器，那谁都用不了，注释掉后默认允许所有</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>第 3 步</strong>：LB1(192.168.122.48) 和 LB2(192.168.122.49) 的 web 程序都是 httpd。其中作为一般静态 web 服务器的 LB2 的配置文件没有任何修改，它的 /var/www/html/index.html 的内容如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">LB2:static</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>作为图片服务器的 LB1 在配置文件中添加了如下几行。且其 /var/www/html/ 下有一个图片文件 dhcp.png。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">Files ~ </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;\.(png|jpeg|jpg|bmp|gif)&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        Order allow,deny</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        Allow from all</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/Files</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>经过以上的配置，可以实现如下图的功能。当访问 <a href="http://www.brinnatt.com(192.168.122.45)" target="_blank" rel="noopener noreferrer">www.brinnatt.com(192.168.122.45)</a> 的时候，任意以 php 结尾的文件请求都转发给 nginx 再由 nginx 交由 php-fpm 处理；任意以图片格式结尾(png/jpg/jpeg/bmp/gif)的请求都转发给 LB1；任意非以上两种格式的请求都转发给 LB2。</p><p><img loading="lazy" alt="simple nginx proxy1" src="/assets/images/simple nginx proxy1-1052682218712e02a33772ad619a3599.png" width="804" height="568" class="img_ev3q"></p><p>测试 1：访问 <a href="http://192.168.122.45/info.php" target="_blank" rel="noopener noreferrer">http://192.168.122.45/info.php</a></p><p><img loading="lazy" alt="nginx php-fpm page" src="/assets/images/nginx php-fpm page-7735fe5984ae8dcc3f8d32b10a1421c1.png" width="937" height="430" class="img_ev3q"></p><p>测试 2：访问 <a href="http://192.168.122.45/dhcp.png%EF%BC%8C%E5%B7%B2%E6%B5%8B%E8%AF%95%E6%88%90%E5%8A%9F" target="_blank" rel="noopener noreferrer">http://192.168.122.45/dhcp.png，已测试成功</a>。</p><p>测试 3：访问 <a href="http://192.168.122.45/%EF%BC%8C%E5%B7%B2%E6%B5%8B%E8%AF%95%E6%88%90%E5%8A%9F" target="_blank" rel="noopener noreferrer">http://192.168.122.45/，已测试成功</a>。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7113反向代理-upstream-模块分组">7.11.3、反向代理 upstream 模块分组<a class="hash-link" href="#7113反向代理-upstream-模块分组" title="标题的直接链接">​</a></h3><p>前面只使用了 ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->proxy<!-- -->_<!-- -->module 来实现反向代理，但是其缺陷在于 nginx-proxy 上定义的每条代理规则都只能转发到后台的某一台服务器上，即后端服务器无法分组。</p><p>如果图片服务器压力太大，添加一台服务器用来减轻图片服务器压力，但是仅使用 proxy 模块无法实现负载均衡到多台图片服务器上。</p><p>这时需要借助 ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->upstream<!-- -->_<!-- -->module 模块，该模块用于定义后端服务器池，后端服务器也称为上游服务器(upstream)，可以为每一种类型的后端服务器分一个组。然后再结合 proxy<!-- -->_<!-- -->pass 或其他代理指令将相应的请求转发到池内。</p><p>服务器池可以有多台服务器，多台服务器如何实现负载均衡和算法有关，默认是指定权重的加权均衡算法，还可以指定 ip<!-- -->_<!-- -->hash 算法实现同一个客户端 IP 发起的请求总是转发到同一台服务器上。还有一些其它算法，如最小连接数算法。最常用的还是加权算法，然后通过 session 共享的方式实现同一个客户端 IP 发起的请求转发到同一服务器上。</p><p>例如，下图描述的需求。当请求图片服务器时，可以将请求均衡到 IP3 和 IP4 两台服务器上，当请求其他静态内容，可以将请求均衡到 IP5 和 IP6 两台服务器上。</p><p><img loading="lazy" alt="nginx upstream" src="/assets/images/nginx upstream-40ab8ee0b4ad1441adfd5acb0e5e716e.png" width="784" height="609" class="img_ev3q"></p><p>要实现这样的功能，nginx-proxy 上的 nginx 配置文件内容大致如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">http </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    include mime.types</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    default_type application/octet-stream</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    sendfile on</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    keepalive_timeout </span><span class="token number" style="color:rgb(9, 134, 88)">65</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># define server pool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 注意upstream后面的名字不能有&quot;_&quot;，否则会报400错误</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    upstream DynamicPool </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server IP1:80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    upstream PicPool </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server IP3:80 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">weight</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server IP4:80 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">weight</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    upstream StaticPool </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server IP5:80 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">weight</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server IP6:80 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">weight</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        listen </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server_name www.brinnatt.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)"># define how to proxy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location ~ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">php</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">php5</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">$ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            proxy_pass http://DynamicPool</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location ~ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">png</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">jpeg</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">jpg</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">bmp</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">gif</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">$ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            proxy_pass http://PicPool</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            proxy_pass http://StaticPool</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7114ngx_http_proxy_module-模块">7.11.4、ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->proxy<!-- -->_<!-- -->module 模块<a class="hash-link" href="#7114ngx_http_proxy_module-模块" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="71141指令及其意义">7.11.4.1、指令及其意义<a class="hash-link" href="#71141指令及其意义" title="标题的直接链接">​</a></h4><p>该模块默认安装。以下是相关指令的说明。</p><table><thead><tr><th>指令</th><th>指令意义</th></tr></thead><tbody><tr><td>proxy<!-- -->_<!-- -->pass</td><td>定义代理到哪台服务器或哪个 upstream 池</td></tr><tr><td>proxy<!-- -->_<!-- -->set<!-- -->_<!-- -->header</td><td>在代理服务器上设置 http 报头信息。如加上真实客户端地址 &quot;proxy<!-- -->_<!-- -->set<!-- -->_<!-- -->header X<!-- -->_<!-- -->Forwarded<!-- -->_<!-- -->For $remote<!-- -->_<!-- -->addr&quot;</td></tr><tr><td>proxy<!-- -->_<!-- -->connect<!-- -->_<!-- -->timeout</td><td>反向代理连接上游服务器节点的超时时间。发起方是 proxy 方，即等待握手成功的时间</td></tr><tr><td>proxy<!-- -->_<!-- -->send<!-- -->_<!-- -->timeout</td><td>上游服务器节点数据传给代理服务器的超时时间。即此时间段内，后端节点需要传完数据给代理服务器</td></tr><tr><td>proxy<!-- -->_<!-- -->read<!-- -->_<!-- -->timeout</td><td>定义代理服务器何时关闭和后端服务器连接的超时时长，默认为 60 秒，表示某次后端传输完数据给代理服务器后，如果 60 秒内代理服务器和后端服务器没有任何传输，则关闭此次连接。目的是避免代理服务器和后端服务器一直保持连接不断开而占用资源</td></tr></tbody></table><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="71142proxy_pass">7.11.4.2、proxy<!-- -->_<!-- -->pass<a class="hash-link" href="#71142proxy_pass" title="标题的直接链接">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">proxy_pass http</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">://</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">IP:PORT/uri/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> upstream_pool </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>当 proxy<!-- -->_<!-- -->pass 所在的 location 中使用了正则匹配时，则 proxy<!-- -->_<!-- -->pass(包括 fastcgi<!-- -->_<!-- -->pass 和 memcached<!-- -->_<!-- -->pass)定义的转发路径都不能包含任何 URI 信息。</strong></li><li><strong>另外，location 中使用了尾随斜线，那么 proxy<!-- -->_<!-- -->pass 定义的转发路径也必须使用斜线，或者都不加尾随斜线。</strong></li></ul><p>例如下面的配置方式是允许的：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server_name www.brinnatt.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location /forum/ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    proxy_pass http://192.168.122.46:8080/bbs/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>当访问 <a href="http://www.brinnatt.com/forum/" target="_blank" rel="noopener noreferrer">www.brinnatt.com/forum/</a> 时将被转发到 <a href="http://192.168.122.46:8080/bbs/%E4%B8%8A" target="_blank" rel="noopener noreferrer">http://192.168.122.46:8080/bbs/上</a>：</li></ul><p>而如果使用了<strong>正则匹配</strong>，将是<strong>不允许</strong>的：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server_name www.brinnatt.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location ~ ^/forum/ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    proxy_pass http://192.168.122.46:8080/bbs/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>只能修改转发路径使其不包含 URI：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server_name www.brinnatt.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location ~ ^/forum/ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    proxy_pass http://192.168.122.46:8080/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>此时请求 <a href="http://www.brinnatt.com/forum/" target="_blank" rel="noopener noreferrer">www.brinnatt.com/forum/</a> 将转发到 <a href="http://192.168.122.46:8080/forum/" target="_blank" rel="noopener noreferrer">http://192.168.122.46:8080/forum/</a>。</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="71143proxy_set_header">7.11.4.3、proxy<!-- -->_<!-- -->set<!-- -->_<!-- -->header<a class="hash-link" href="#71143proxy_set_header" title="标题的直接链接">​</a></h4><p>可以在 nginx 配置文件中的 http 段、server 段或 location 段设置 proxy<!-- -->_<!-- -->set<!-- -->_<!-- -->header 指令。设置该指令后，传输给上游服务器的报文首部将包含相关的信息，如设置客户端的真实 IP 地址。设置如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    listen       </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server_name  www.brinnatt.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location ~ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">png</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">jpg</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">jpeg</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">bmp</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">gif</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">$ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_pass http://192.168.122.48:80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_set_header X-Forwarded-For </span><span class="token variable" style="color:rgb(9, 134, 88)">$remote_addr</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_pass http://192.168.122.49:80/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_set_header X-Forwarded-For </span><span class="token variable" style="color:rgb(9, 134, 88)">$remote_addr</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location ~ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">php</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">php5</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">$ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_pass http://192.168.122.46:80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_set_header X-Forwarded-For </span><span class="token variable" style="color:rgb(9, 134, 88)">$remote_addr</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    error_page   </span><span class="token number" style="color:rgb(9, 134, 88)">500</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">502</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">503</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">504</span><span class="token plain">  /50x.html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /50x.html </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        root   html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>仅在代理服务器上设置了该头部字段后还不够，因为后端服务器仅仅只是获取到它，默认并没有将其记录下来。所以需要在后端的服务的日志格式设置上记录此项或者在其他有需求的地方设置它。nginx 的日志格式和 apache 的日志设置格式不同，以下分别是两种 web 程序的设置方法：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># nginx上的日志设置格式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">log_format  main    </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; &#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">access_log logs/access.log main</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># apache上的日志设置格式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">LogFormat </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;%{X-Forwarded-For}i %h %l %u %t </span><span class="token string entity" style="color:rgb(163, 21, 21)">\&quot;</span><span class="token string" style="color:rgb(163, 21, 21)">%r</span><span class="token string entity" style="color:rgb(163, 21, 21)">\&quot;</span><span class="token string" style="color:rgb(163, 21, 21)"> %&gt;s %b </span><span class="token string entity" style="color:rgb(163, 21, 21)">\&quot;</span><span class="token string" style="color:rgb(163, 21, 21)">%{Referer}i</span><span class="token string entity" style="color:rgb(163, 21, 21)">\&quot;</span><span class="token string" style="color:rgb(163, 21, 21)"> </span><span class="token string entity" style="color:rgb(163, 21, 21)">\&quot;</span><span class="token string" style="color:rgb(163, 21, 21)">%{User-Agent}i</span><span class="token string entity" style="color:rgb(163, 21, 21)">\&quot;</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token plain"> combined</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7115ngx_http_upstream_module-模块">7.11.5、ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->upstream<!-- -->_<!-- -->module 模块<a class="hash-link" href="#7115ngx_http_upstream_module-模块" title="标题的直接链接">​</a></h3><p>upstream 模块定义上游服务器组。主要的指令有 &quot;upstream&quot;、&quot;server&quot;、&quot;ip<!-- -->_<!-- -->hash&quot;。upstream 指令必须定义在 server 段外面。</p><p>以下是一个综合示例定义方法，有矛盾的地方，只是放在一起方便比较用法：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">upstream backend </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.45</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.46:80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server www.brinnatt.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server www.brinnatt.com:8080</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.47 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">weight</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">max_fails</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">fail_timeout</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">2s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.48 down</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.49 backup</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ip_hash</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain">   </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定义此项后，前面的server附加项weight和backup功能失效。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>默认使用加权均衡算法，使用 <code>ip_hash</code> 指令可设置为 <code>ip_hash</code> 算法，但使用 <code>ip_hash</code> 指令后，如果 server 指令中使用了 weight 和 backup 选项，这两个功能将会失效。</li><li>其中 server 指令后可以跟的附加选项有：<ul><li><code>weight</code>：定义该后端服务器在组中的权重，默认为 1，权重越大，代理转发到此服务器次数越多。</li><li><code>max_fails</code> 和 <code>fail_timeout</code>：定义代理服务器联系后端服务器的失败重联系次数和失败后重试等待时间。默认为 1 和 10，如果设置为 2 和 3，则表示只尝试联系 2 次，每次失败等待 3 秒后进行下一次重试，也就是说 6 秒后就能判定此后端服务器无法联系上，将负载均衡到下一台服务器上。常会配合 proxy<!-- -->_<!-- -->next<!-- -->_<!-- -->upstream 或者 fastcgi<!-- -->_<!-- -->next<!-- -->_<!-- -->upstream 或者 memcached<!-- -->_<!-- -->next<!-- -->_<!-- -->upstream 来指定失败时如何处理。</li><li><code>down</code>：将此后端服务器定义为离线状态。此功能不同于直接在配置文件中删除此服务器配置或注释它。常用于 ip<!-- -->_<!-- -->hash 均衡算法。当使用 ip<!-- -->_<!-- -->hash 算法时，如果某台服务器坏了需要将其从服务器组中排除，直接从配置文件中删除该服务器将会导致此前分配到此后端服务器的客户端重新计算 IP<!-- -->_<!-- -->HASH 值，而使用 down 则不会。</li><li><code>backup</code>：指定当其他非 backup 的 server 都联系不上时，将返回 backup 所定义的服务器内容。常用于显示 sorry page。</li></ul></li><li>当 server 指定后端服务器时使用的是主机名的方式时，需要在代理服务器上添加域名解析记录，如放到 /etc/hosts 中。</li></ul><p>以下是一个配置示例。只定义了一个 upstream 组，所有请求都代理，权重为 2 比 1，当 192.168.122.48 和 192.168.122.49 都断开联系时，将返回代理服务器本身配置的 sorrypage。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">http </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    include             mime.types</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    default_type        application/octet-stream</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    sendfile            on</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    keepalive_timeout   </span><span class="token number" style="color:rgb(9, 134, 88)">65</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    upstream WebGroup </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.48 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">weight</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">max_fails</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">fail_timeout</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">2s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.49 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">weight</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">max_fails</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">fail_timeout</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">2s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:80 backup</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        listen </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        root /www/brinnatt/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        index index.html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        listen       </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server_name  www.brinnatt.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                proxy_pass http://WebGroup</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        error_page   </span><span class="token number" style="color:rgb(9, 134, 88)">500</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">502</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">503</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">504</span><span class="token plain">  /50x.html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /50x.html </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                root   html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后在反向代理服务器上创建 /www/brinnatt/ 目录，并向目录下的 index.html 文件中写入 &quot;sorry....&quot;。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">mkdir</span><span class="token plain"> -p /www/brinnatt/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;h1&gt;sorry pages...&lt;/h1&gt;&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">/www/brinnatt/index.html</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>重载代理服务器。在浏览器上输入 <a href="http://www.brinnatt.com" target="_blank" rel="noopener noreferrer">www.brinnatt.com</a> 并不断刷新，结果应该是 2:1 的返回权重。再依次测试停掉某一台后端服务器和两台后端都停掉的情况。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7116反向代理多种类型">7.11.6、反向代理多种类型<a class="hash-link" href="#7116反向代理多种类型" title="标题的直接链接">​</a></h3><p>反向代理时，可以根据 uri 的后缀来代理，也可以根据 uri 中的目录来代理，还可以根据客户端浏览器类型来代理。例如手机访问网站时转发到某个后端服务器组，IE 浏览器访问的转发到某一个后端服务器组等。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># uri后缀代理。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location ~ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">jpeg</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">jpg</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">png</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">bmp</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">gif</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">$ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    proxy_pass </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 目录代理。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location ~ /forum/ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    proxy_pass </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 浏览器类型代理。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token variable" style="color:rgb(9, 134, 88)">$http_user_agent</span><span class="token plain"> ~ </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;MSIE&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_pass</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token variable" style="color:rgb(9, 134, 88)">$http_user_agent</span><span class="token plain"> ~ </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Chrome&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_pass</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7117nginx-代理-memcached">7.11.7、nginx 代理 memcached<a class="hash-link" href="#7117nginx-代理-memcached" title="标题的直接链接">​</a></h3><p>nginx 代理模块可以将请求代理至 memcached server 上，并立即从 server 上获取响应数据。例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">set</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$memcached_key</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">$uri</span><span class="token string" style="color:rgb(163, 21, 21)">?</span><span class="token string variable" style="color:rgb(9, 134, 88)">$args</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    memcached_pass     </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:11211</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>nginx 代理 memcached 时，需要以变量 <code>$memcached_key</code> 作为 key 去访问 memcached server 上的数据。例如此处将 <code>$uri$args</code> 变量赋值给 <code>$memcached_key</code> 变量作为 key 去访问 memcached 服务器上对应的数据。</p></li><li><p>但这样的代理显然不符合真正的需求：没有实现 memcached 的分布式功能。当 memcached server 宕机时，nginx 将无法从中获取任何数据。所以应该使用上游服务器组。例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">upstream memcached </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  server </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:11211</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  server </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:11212</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  server </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:11213</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  server </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:11214</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  listen       </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  server_name  dev.brinnatt.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  location ^~ /cache/ </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">set</span><span class="token plain">            </span><span class="token variable" style="color:rgb(9, 134, 88)">$memcached_key</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">$uri</span><span class="token string variable" style="color:rgb(9, 134, 88)">$args</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      memcached_pass memcached</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>但这也不适合，因为 memcached 是基于一致性哈希算法的，而 upstream 模块默认并不支持一致性哈希算法。可以通过 upstream 模块的 <a href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#hash" target="_blank" rel="noopener noreferrer">hash</a> 指令或者另外使用一个第三方模块 <a href="https://www.nginx.com/resources/wiki/modules/consistent_hash/" target="_blank" rel="noopener noreferrer">ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->upstream<!-- -->_<!-- -->consistent<!-- -->_<!-- -->hash</a>。</p><p>如果使用的是 upstream 模块的 hash 指令，配置如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">upstream memcached </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">hash</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">$uri</span><span class="token string variable" style="color:rgb(9, 134, 88)">$args</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token plain"> consistent</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  server </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:11211</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  server </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:11212</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  server </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:11213</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  server </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:11214</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这样，各上游主机就通过 hash 一致性的算法进行负载均衡。</p><p>如果使用的是第三方模块 ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->upstream<!-- -->_<!-- -->consistent<!-- -->_<!-- -->hash，则在模块添加成功后如下配置 upstream 组：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">upstream memcached </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  consistent_hash consistent</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  server </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:11211</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  server </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:11212</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  server </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:11213</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  server </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:11214</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="712nginx-缓存功能">7.12、nginx 缓存功能<a class="hash-link" href="#712nginx-缓存功能" title="标题的直接链接">​</a></h2><p>nginx 的 ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->proxy<!-- -->_<!-- -->module 自带了缓存功能。有几种缓存：网页内容缓存，日志缓存，打开文件缓存，fastcgi 缓存。fastcgi 缓存功能应慎用，因为动态程序的前后逻辑可能改变了，缓存后的结果可能并非实际所需结果。</p><ul><li>nginx 自带的缓存功能有一定的缺陷，nginx 的缓存功能主要用于缓存体积较小的页面资源，当数据较大时很容易出现瓶颈。</li><li>squid 功能最全面，可以缓存大量数据，但架构太老，性能一般。</li><li>varnish 架构较新，内存管理完全交由操作系统内核，性能是 squid 的几倍之强，但缓存的内容不如 squid。</li></ul><p>本节所讲的主要是 nginx 自带缓存的网页内容缓存。当实现网页内容缓存时，作为 web 服务程序，它可以缓存自身返回给客户端的数据，包括读取的图片、文件等；作为代理，它可以缓存来自后端的数据。</p><p>缓存后的数据在内存中有，也会放在设定的目录下。这样以后客户端继续请求相同资源时，可以直接从内存中或者自身的磁盘中获取并返回给客户端。</p><p>当缓存超出指定的空间大小时，将会有一个专门的线程 cache<!-- -->_<!-- -->manager 来清理缓存。</p><p>定义的相关指令主要有 3 个：proxy<!-- -->_<!-- -->cache<!-- -->_<!-- -->path、proxy<!-- -->_<!-- -->cache、proxy<!-- -->_<!-- -->cache<!-- -->_<!-- -->valid：</p><ul><li><p><code>proxy_cache_path</code>：它的语法比较复杂，但用起来很简单。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">proxy_cache_path path </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">levels</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">levels</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">use_temp_path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">on</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">off</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">keys_zone</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">name:size </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">inactive</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">time</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">max_size</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">size</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">manager_files</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">number</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">manager_sleep</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">time</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">manager_threshold</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">time</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">loader_files</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">number</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">loader_sleep</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">time</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">loader_threshold</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">time</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">purger</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">on</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">off</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">purger_files</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">number</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">purger_sleep</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">time</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">purger_threshold</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">time</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中 <code>proxy_cache_path path [levels=levels] keys_zone=name:size [max_size=size]</code> 这几项是一般使用的选项和必需项。以下为一示例：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">proxy_cache_path /usr/local/nginx/cache_dir </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">levels</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">:2 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">keys_zone</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">cache_one:20m </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">max_size</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">1g</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li><code>path</code>：定义缓存放在磁盘的哪个目录下。此处表示定义在 /usr/local/nginx/cache<!-- -->_<!-- -->dir 目录下。目录不存在会自动创建。</li><li><code>levels</code>：定义缓存目录的级别，同时定义缓存目录名称的字符数。例如 <code>levels=1:2:2</code> 表示 3 级目录，且第一级目录名 1 个字符，第二级目录 2 个字符，第三级目录 2 个字符。目录最多 3 级，目录名最多为 2 个字符。例如上例中 &quot;levels=1:2&quot; 产生的缓存文件路径可能是这样的 &quot;/usr/local/nginx/cache<!-- -->_<!-- -->dir/d/f1/50a3269acaa7774c02d4da0968124f1d&quot;，注意其中加粗的字体。</li><li><code>keys_zone</code>：定义缓存标识名称和内存中缓存的最大空间。name 部分必须唯一，在后面会引用 name 来表示使用该缓存方法。</li><li><code>max_size</code>：定义磁盘中缓存目录的最大空间。即 path 定义的文件最大空间。</li></ol><p>该指令定义后只是定义了一种缓存方法，并非开启了缓存。</p></li><li><p><code>proxy_cache</code>：定义要使用哪个缓存方法。使用 <code>proxy_cache_path</code> 中的 name 来引用。</p><p>例如引用上例定义的 cache<!-- -->_<!-- -->one：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">proxy_cache cache_one</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><code>proxy_cache_valid</code>：根据状态码来指定缓存有效期。</p><p>例如，下面的表示状态码为 200 和 302 的状态缓存 1 小时，状态码为 404 时即 page not found 的缓存只有 1 分钟，防止客户端请求一直错误，状态码为其他的则缓存 5 分钟。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">proxy_cache_valid </span><span class="token number" style="color:rgb(9, 134, 88)">200</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">302</span><span class="token plain"> 1h</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">proxy_cache_valid </span><span class="token number" style="color:rgb(9, 134, 88)">404</span><span class="token plain"> 1m</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">proxy_cache_valid any 5m</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果不指定状态码，只指定时间，则默认只缓存状态码 200、301、302 各 5 分钟，其他的状态码不缓存。</p></li></ul><p>以下是代理服务器 192.168.122.45 上定义的缓存示例：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">http </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    include             mime.types</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    default_type        application/octet-stream</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    sendfile            on</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    keepalive_timeout   </span><span class="token number" style="color:rgb(9, 134, 88)">65</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)"># 注意upstream后面取名字，不要使用&quot;_&quot;，会报400错误</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        upstream WebGroup </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                server </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.48 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">weight</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">max_fails</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">fail_timeout</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">2s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                server </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.49 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">weight</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">max_fails</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">fail_timeout</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">2s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                server </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:80 backup</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        proxy_cache_path /usr/local/nginx/cache_dir </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">levels</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">:2 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">keys_zone</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">cache_one:20m </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">max_size</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">1g</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                listen </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                root /www/brinnatt/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                index index.html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                listen       </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                server_name  www.brinnatt.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token comment" style="color:rgb(0, 128, 0)"># 在响应报文中添加缓存首部字段</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                add_header X-Cache </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">$upstream_cache_status</span><span class="token string" style="color:rgb(163, 21, 21)"> from </span><span class="token string variable" style="color:rgb(9, 134, 88)">$server_addr</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                        proxy_pass http://WebGroup</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                        proxy_cache cache_one</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                        proxy_cache_valid </span><span class="token number" style="color:rgb(9, 134, 88)">200</span><span class="token plain"> 1h</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                        proxy_cache_valid </span><span class="token number" style="color:rgb(9, 134, 88)">404</span><span class="token plain"> 1m</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                        proxy_cache_valid any 5m</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        error_page   </span><span class="token number" style="color:rgb(9, 134, 88)">500</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">502</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">503</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">504</span><span class="token plain">  /50x.html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        location </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /50x.html </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            root   html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>其中添加的一行 <code>&quot;add_header X-Cache &quot;$upstream_cache_status from $server_addr&quot;;&quot;</code> 表示在响应报文的头部加上一字段 X-Cache，其值为是否命中缓存的状态 <code>$upstream_cache_status</code>，从哪台服务器上 <code>$server_addr</code> 取得的缓存。</li></ul><p>重载代理服务器的配置文件后，在客户端打开 &quot;开发者工具&quot; 进行测试。</p><p><img loading="lazy" alt="nginx cache" src="/assets/images/nginx cache-da3b36f038b15cf11ddd60784ee2e6ad.png" width="935" height="804" class="img_ev3q"></p><p>由于是第一次提供缓存功能，所以结果是未命中缓存。此时已经将缓存保存下来了。 再进行测试，结果将命中缓存是 &quot;hit from 192.168.122.45&quot;。</p><p><img loading="lazy" alt="nginx cache hit" src="/assets/images/nginx cache hit-88e49ff99e74b7a8c55cfc9fd1f685b3.png" width="936" height="806" class="img_ev3q"></p><p>查看缓存目录。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@fname1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># tree /usr/local/nginx/cache_dir/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">/usr/local/nginx/cache_dir/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">├── </span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│   └── </span><span class="token number" style="color:rgb(9, 134, 88)">37</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">├── c</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│   └── ab</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">└── d</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ├── db</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    │   └── b27dfaf1bd886ffe7ea35c6913964dbd</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    └── f1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>如果想要删除缓存，只需删除对应的目录即可。</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="713nginx-url-重写">7.13、nginx URL 重写<a class="hash-link" href="#713nginx-url-重写" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7131简介">7.13.1、简介<a class="hash-link" href="#7131简介" title="标题的直接链接">​</a></h3><p>url 重写由 ngx<!-- -->_<!-- -->http<!-- -->_<!-- -->rewrite<!-- -->_<!-- -->module 模块提供，默认会安装，但该模块功能的实现需要 pcre。URL 重写技术不仅要求掌握几个指令的语法、熟悉简单的正则表达式，还需要尽量熟悉 nginx 的各个变量的意义，熟悉的变量越多越好。</p><p>大多数需要用到的变量都是 http<!-- -->_<!-- -->core 模块提供的，它们的意义参见官方手册 <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#variables" target="_blank" rel="noopener noreferrer">http<!-- -->_<!-- -->core内置变量</a>。</p><p>rewrite 模块主要有 break、return、set、rewrite 和 if 这 5 个指令。</p><ul><li><p>break 的作用是完成当前的作用集，不再执行 rewrite 指令</p></li><li><p>return 返回状态码。可用的状态码有 204/301/302/303/307/308/400/402-406/408/410-411/413/416/500-504。return 三种语法：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain"> code </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">text</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain"> code URL</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain"> URL</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>set 用于定义变量。赋给变量的值可以是一个变量、文本及文本变量的组合(语法：set variable value;)</p></li><li><p>if 用于设定判断条件。格式为 if (condition) {}</p></li><li><p>rewrite 用于设定 URL 重写规则(语法：rewrite regex replacement <!-- -->[<!-- -->flag<!-- -->]<!-- -->;)</p></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7132if-指令">7.13.2、if 指令<a class="hash-link" href="#7132if-指令" title="标题的直接链接">​</a></h3><p>if 不支持嵌套，不支持 &quot;&amp;&amp;&quot; 和 &quot;||&quot; 多目运算符。语法为：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">condition</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>测试条件可以如下定义：</p><ol><li>变量的比较可以使用 <code>&quot;=&quot;</code> 和 <code>&quot;!=&quot;</code> 运算符。</li><li>正则匹配可以使用 <code>&quot;~&quot;</code> 和 <code>&quot;~*&quot;</code>，前者表示区分大小写的正则匹配，后者表示不区分大小写的匹配。</li><li>正则匹配可以在前面加上感叹号 <code>&quot;!~&quot;</code> 和 <code>&quot;!~*&quot;</code> 表示取反，即不匹配。</li><li><code>&quot;-f&quot;</code> 和 <code>&quot;!-f&quot;</code> 判断文件是否存在。</li><li><code>&quot;-d&quot;</code> 和 <code>&quot;!-d&quot;</code> 判断目录是否存在。</li><li><code>&quot;-e&quot;</code> 和 <code>&quot;!-e&quot;</code> 判断文件或目录或软链接是否存在。</li><li><code>&quot;-x&quot;</code> 和 <code>&quot;!-x&quot;</code> 判断文件是否可执行。</li></ol><p>if 支持的正则表达式可以使用 <code>$1</code> 至 <code>$9</code> 来实现反向引用。</p><p>以下为几个示例：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 当使用IE浏览器访问时，重定向到/msie/目录下的对应文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token variable" style="color:rgb(9, 134, 88)">$http_user_agent</span><span class="token plain"> ~ MSIE</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    rewrite ^</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">.*</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">$ /msie/</span><span class="token variable" style="color:rgb(9, 134, 88)">$1</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">break</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 当http请求的方法为POST，则直接返回405状态码，即Method not Allowed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token variable" style="color:rgb(9, 134, 88)">$request_method</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> POST</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">405</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 当请求的资源文件不存在，则直接退出当前匹配，并代理至本机，这种情况下由本机来提供服务，如提供错误页面</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token plain">-f </span><span class="token variable" style="color:rgb(9, 134, 88)">$request_filename</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">break</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    proxy_pass http://127.0.0.1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 当访问的是brinnatt.com下任意主机，则重定向到www.brinnatt.com主机下的对应目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token variable" style="color:rgb(9, 134, 88)">$http_host</span><span class="token plain"> ~* </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;^(.*)\.brinnatt\.com$&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">set</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$domain</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    rewrite ^</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">.*</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> https://www.brinnatt.com/</span><span class="token variable" style="color:rgb(9, 134, 88)">$domain</span><span class="token plain">/ </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">break</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>上面最后一种 <strong>URL 重写后的 URL 为一个新的主机名站点，但使用 URL 重写的效率比较低下，远不如直接为此站点独立定义一个虚拟主机</strong>。所以改写为：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  listen </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  server_name .brinnatt.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">302</span><span class="token plain"> https://www.brinnatt.com/</span><span class="token variable" style="color:rgb(9, 134, 88)">$request_uri</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  listen </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  server_name www.brinnatt.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7133rewrite-指令">7.13.3、rewrite 指令<a class="hash-link" href="#7133rewrite-指令" title="标题的直接链接">​</a></h3><p>rewrite 可以写在 server 段、location 段和 if 段。语法：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">rewrite regexp replacement </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">flag</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果 replacement 部分以 &quot;http://&quot; 或 &quot;https://&quot; 或 &quot;$schema&quot; 开头，则直接临时重定向，见下表中的 redirect 标记。</p><p>flag 是标记。有 4 种标记，它们的作用如下表：</p><table><thead><tr><th>flag</th><th>说明</th></tr></thead><tbody><tr><td>last</td><td>停止处理当前上下文中的其他重写模块指令，并为重写后的 uri 再次进行上下文的匹配</td></tr><tr><td>break</td><td>和 last 指令一样，都是停止处理当前上下文中的其他重写模块指令</td></tr><tr><td>redirect</td><td>返回临时重定向状态码 302。当 replacement 部分不是以 &quot;http://&quot; 或者 &quot;https://&quot; 或者 <code>&quot;$schema&quot;</code> 开头的时候使用，<code>&quot;$schema&quot;</code> 变量表示使用的是什么协议</td></tr><tr><td>permanent</td><td>返回永久重定向状态码 301</td></tr></tbody></table><p>以上 flag 中，<strong>last 和 break 用来实现 URL 改写，此时浏览器中的地址不会改变，但实际上在服务器上访问的资源和路径已经改变了。redirect 和 permanent 用来实现 URL 跳转，浏览器中的地址会改变为跳转后的地址</strong>。</p><p><strong>在使用 proxy<!-- -->_<!-- -->pass 指令时要使用 break 标记</strong>。last 标记在本条 rewrite 规则执行完后，继续在当前上下文对重写后的地址发起匹配请求，而 break 则在本次匹配完成后停止再次匹配。例如下面的两条重写规则。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">rewrite </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;^/bbs/(.*)/images/(.*)\.jpg$&quot;</span><span class="token plain"> www.brinnatt.com/bbs/</span><span class="token variable" style="color:rgb(9, 134, 88)">$2</span><span class="token plain">/images/</span><span class="token variable" style="color:rgb(9, 134, 88)">$1</span><span class="token plain">.jpg last</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">rewrite </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;^/bbs/(.*)/images/(.*)\.jpg$&quot;</span><span class="token plain"> www.brinnatt.com/bbs/</span><span class="token variable" style="color:rgb(9, 134, 88)">$2</span><span class="token plain">/images/</span><span class="token variable" style="color:rgb(9, 134, 88)">$1</span><span class="token plain">.jpg </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">break</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>如果访问的是 <a href="http://www.brinnatt.com/bbs/a/images/b.jpg" target="_blank" rel="noopener noreferrer">www.brinnatt.com/bbs/a/images/b.jpg</a> 则重写后为 <a href="http://www.brinnatt.com/bbs/b/images/a.jpg%EF%BC%8C%E4%BD%86%E6%98%AF%E9%87%8D%E5%86%99%E5%90%8E%E7%9A%84%E5%9C%B0%E5%9D%80%E4%BB%8D%E7%84%B6%E5%8F%AF%E4%BB%A5%E5%8C%B9%E9%85%8D%E5%88%B0%E8%A7%84%E5%88%99" target="_blank" rel="noopener noreferrer">www.brinnatt.com/bbs/b/images/a.jpg，但是重写后的地址仍然可以匹配到规则</a> <code>^/bbs/(.*)/images/(.*)\.jpg$</code>，此时如果使用 last 标记，则会再次进行重写，最终导致 URL 重写循环，nginx 默认支持 10 次循环，然后返回 500 状态码。而如果使用 break 标记，则在重写完成后不会再次匹配重写。</li></ul><p>例如，下面的重写示例将会使得任意以 brinnatt.com 结尾的访问重定向到 <a href="http://www.brinnatt.com%E3%80%82" target="_blank" rel="noopener noreferrer">www.brinnatt.com。</a></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server_name  www.brinnatt.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">rewrite </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">.*</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">.brinnatt.com www.brinnatt.com permanent</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下面的重写实例将使得 <code>www.brinnatt.com/bbs/*</code> 的访问都重定向到 <code>www.brinnatt.com/forum/*</code>。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    listen </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server_name www.brinnatt.com</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    location / </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        root /www/brinnatt/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        index index.html</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        rewrite </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;/bbs/(.*)&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;/forum/</span><span class="token string variable" style="color:rgb(9, 134, 88)">$1</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token plain"> last</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7134url-重写和反向代理的区别">7.13.4、URL 重写和反向代理的区别<a class="hash-link" href="#7134url-重写和反向代理的区别" title="标题的直接链接">​</a></h3><p>URL 重写和反向代理都能将请求转发到其他主机上。但它们有很大的区别。</p><ol><li>URL 重写可以实现一些反向代理不能实现的转发。</li><li>URL 重写可以实现浏览器地址改变。</li><li>反向代理更多的配合 upstream 实现负载均衡。URL 重写无法直接通过转发实现负载均衡。</li></ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/linux-advanced-8"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">第 8 章 Linux httpd 服务高级配置</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/linux-advanced-10"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">第 10 章 Linux Tomcat 服务基础配置</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#71nginx-简介" class="table-of-contents__link toc-highlight">7.1、nginx 简介</a></li><li><a href="#72nginx-处理请求的过程" class="table-of-contents__link toc-highlight">7.2、nginx 处理请求的过程</a></li><li><a href="#73nginx-命令" class="table-of-contents__link toc-highlight">7.3、nginx 命令</a></li><li><a href="#74nginx-模块及-http-功能速览" class="table-of-contents__link toc-highlight">7.4、nginx 模块及 http 功能速览</a></li><li><a href="#75nginx-配置文件简单说明" class="table-of-contents__link toc-highlight">7.5、nginx 配置文件简单说明</a><ul><li><a href="#751main-和-events-段" class="table-of-contents__link toc-highlight">7.5.1、main 和 events 段</a></li><li><a href="#752http-段" class="table-of-contents__link toc-highlight">7.5.2、http 段</a><ul><li><a href="#7521配置文件概览" class="table-of-contents__link toc-highlight">7.5.2.1、配置文件概览</a></li><li><a href="#7522root-指令和-alias-指令" class="table-of-contents__link toc-highlight">7.5.2.2、root 指令和 alias 指令</a></li><li><a href="#7523location-容器" class="table-of-contents__link toc-highlight">7.5.2.3、location 容器</a></li><li><a href="#7524error_page-指令" class="table-of-contents__link toc-highlight">7.5.2.4、error_page 指令</a></li><li><a href="#7525allow-和-deny" class="table-of-contents__link toc-highlight">7.5.2.5、allow 和 deny</a></li><li><a href="#7526add_header-添加相应首部字段" class="table-of-contents__link toc-highlight">7.5.2.6、add_header 添加相应首部字段</a></li></ul></li><li><a href="#753虚拟主机和-server_name-指令" class="table-of-contents__link toc-highlight">7.5.3、虚拟主机和 server_name 指令</a></li><li><a href="#754虚拟主机的匹配规则" class="table-of-contents__link toc-highlight">7.5.4、虚拟主机的匹配规则</a></li><li><a href="#755stub_status-指令获取-nginx-状态信息" class="table-of-contents__link toc-highlight">7.5.5、stub_status 指令获取 nginx 状态信息</a></li></ul></li><li><a href="#76访问日志-access_log" class="table-of-contents__link toc-highlight">7.6、访问日志 access_log</a><ul><li><a href="#761log_format-指令" class="table-of-contents__link toc-highlight">7.6.1、log_format 指令</a></li><li><a href="#762access_log-指令" class="table-of-contents__link toc-highlight">7.6.2、access_log 指令</a></li><li><a href="#763日志文件的分割" class="table-of-contents__link toc-highlight">7.6.3、日志文件的分割</a></li></ul></li><li><a href="#77配置-web-身份认证" class="table-of-contents__link toc-highlight">7.7、配置 web 身份认证</a></li><li><a href="#78配置-https" class="table-of-contents__link toc-highlight">7.8、配置 https</a></li><li><a href="#79nginx-版本平稳切换" class="table-of-contents__link toc-highlight">7.9、nginx 版本平稳切换</a><ul><li><a href="#791升级" class="table-of-contents__link toc-highlight">7.9.1、升级</a></li><li><a href="#792降级" class="table-of-contents__link toc-highlight">7.9.2、降级</a></li><li><a href="#793一键升级脚本" class="table-of-contents__link toc-highlight">7.9.3、一键升级脚本</a></li></ul></li><li><a href="#710搭建-lnmp-环境" class="table-of-contents__link toc-highlight">7.10、搭建 LNMP 环境</a><ul><li><a href="#7101编译-nginx" class="table-of-contents__link toc-highlight">7.10.1、编译 nginx</a></li><li><a href="#7102编译-php" class="table-of-contents__link toc-highlight">7.10.2、编译 PHP</a></li><li><a href="#7103配置-nginx-和-php-fpm-交互tcp-socket" class="table-of-contents__link toc-highlight">7.10.3、配置 nginx 和 php-fpm 交互(tcp socket)</a></li><li><a href="#7104配置-nginx-和-php-fpm-交互unix-socket" class="table-of-contents__link toc-highlight">7.10.4、配置 nginx 和 php-fpm 交互(unix socket)</a></li></ul></li><li><a href="#711nginx-反向代理" class="table-of-contents__link toc-highlight">7.11、nginx 反向代理</a><ul><li><a href="#7111正反代理概念" class="table-of-contents__link toc-highlight">7.11.1、正反代理概念</a></li><li><a href="#7112反向代理基础实验" class="table-of-contents__link toc-highlight">7.11.2、反向代理基础实验</a></li><li><a href="#7113反向代理-upstream-模块分组" class="table-of-contents__link toc-highlight">7.11.3、反向代理 upstream 模块分组</a></li><li><a href="#7114ngx_http_proxy_module-模块" class="table-of-contents__link toc-highlight">7.11.4、ngx_http_proxy_module 模块</a><ul><li><a href="#71141指令及其意义" class="table-of-contents__link toc-highlight">7.11.4.1、指令及其意义</a></li><li><a href="#71142proxy_pass" class="table-of-contents__link toc-highlight">7.11.4.2、proxy_pass</a></li><li><a href="#71143proxy_set_header" class="table-of-contents__link toc-highlight">7.11.4.3、proxy_set_header</a></li></ul></li><li><a href="#7115ngx_http_upstream_module-模块" class="table-of-contents__link toc-highlight">7.11.5、ngx_http_upstream_module 模块</a></li><li><a href="#7116反向代理多种类型" class="table-of-contents__link toc-highlight">7.11.6、反向代理多种类型</a></li><li><a href="#7117nginx-代理-memcached" class="table-of-contents__link toc-highlight">7.11.7、nginx 代理 memcached</a></li></ul></li><li><a href="#712nginx-缓存功能" class="table-of-contents__link toc-highlight">7.12、nginx 缓存功能</a></li><li><a href="#713nginx-url-重写" class="table-of-contents__link toc-highlight">7.13、nginx URL 重写</a><ul><li><a href="#7131简介" class="table-of-contents__link toc-highlight">7.13.1、简介</a></li><li><a href="#7132if-指令" class="table-of-contents__link toc-highlight">7.13.2、if 指令</a></li><li><a href="#7133rewrite-指令" class="table-of-contents__link toc-highlight">7.13.3、rewrite 指令</a></li><li><a href="#7134url-重写和反向代理的区别" class="table-of-contents__link toc-highlight">7.13.4、URL 重写和反向代理的区别</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">学习</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/tags">标签</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">归档</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/skill">技术笔记</a></li><li class="footer__item"><a class="footer__link-item" href="/project">实战项目</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/linux">Linux</a></li></ul></div><div class="col footer__col"><div class="footer__title">社交媒体</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/about">关于我</a></li><li class="footer__item"><a href="https://github.com/zqingfa" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://juejin.cn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">掘金<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" position="right" href="/friends">友链</a></li><li class="footer__item"><a class="footer__link-item" position="right" href="/website">导航</a></li><li class="footer__item"><a href="https://docusaurus.io/zh-CN/" target="_blank"><img style="height:50px;margin-top:0.5rem" src="/img/buildwith.png"><a></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p><a href="http://beian.miit.gov.cn/">浙ICP备20024502号-1</a></p><p>Copyright © 2022 - PRESENT zhangqf Built with Docusaurus.</p></div></div></div></footer></div>
<script src="/assets/js/runtime~main.9e73f1b3.js"></script>
<script src="/assets/js/main.39d37d57.js"></script>
</body>
</html>