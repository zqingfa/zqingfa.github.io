<!doctype html>
<html lang="en-GB" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-linux/advanced/linux-advanced-13">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">第 13 章 Linux haproxy 服务进阶配置 - Linux技术分享</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://zhangqf.com/en/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://zhangqf.com/en/img/logo.png"><meta data-rh="true" property="og:url" content="https://zhangqf.com/en/docs/linux-advanced-13"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="第 13 章 Linux haproxy 服务进阶配置 - Linux技术分享"><meta data-rh="true" name="description" content="haproxy 基础篇中我们强调过，默认配置虽然可以直接使用，但是真正的生产环境中，想要实现高性能的代理服务，必须把握好众多参数，这就要求对 haproxy 的配置文件有更进一步的精深理解。下面我们会对 haproxy 的配置文件进行详解。"><meta data-rh="true" property="og:description" content="haproxy 基础篇中我们强调过，默认配置虽然可以直接使用，但是真正的生产环境中，想要实现高性能的代理服务，必须把握好众多参数，这就要求对 haproxy 的配置文件有更进一步的精深理解。下面我们会对 haproxy 的配置文件进行详解。"><meta data-rh="true" name="keywords" content="linux,haproxy"><link data-rh="true" rel="icon" href="/en/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://zhangqf.com/en/docs/linux-advanced-13"><link data-rh="true" rel="alternate" href="https://zhangqf.com/en/docs/linux-advanced-13" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/linux-advanced-13" hreflang="zh"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/linux-advanced-13" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9B0V5WT2X8-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S4SD5NXWXF"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S4SD5NXWXF",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Linux技术分享" href="/en/opensearch.xml">
<link rel="preconnect" href="https://zhangqf.com/">
<script>var _paq=window._paq=window._paq||[];_paq.push(["setRequestMethod","POST"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),_paq.push(["enableHeartBeatTimer"]),function(){var e="https://zhangqf.com/";_paq.push(["setRequestMethod","POST"]),_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]);var a=document,t=a.createElement("script"),p=a.getElementsByTagName("script")[0];t.type="text/javascript",t.async=!0,t.src=e+"matomo.js",p.parentNode.insertBefore(t,p)}()</script>


<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c9a3849aa75f9c4a4e65f846cd1a5155",e.defer=!0;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<meta name="baidu-site-verification" content="code-rqLUw5reVS">
<script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",t.defer=!0;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script>
<link rel="alternate" type="application/rss+xml" href="/en/rss.xml" title="zhangqf RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/atom.xml" title="zhangqf Atom Feed">
<link rel="alternate" type="application/json" href="/en/feed.json" title="zhangqf JSON Feed">

<link rel="icon" href="/en/img/logo.png">
<link rel="manifest" href="/en/manifest.json">
<meta name="theme-color" content="rgb(51 139 255)"><link rel="stylesheet" href="/en/assets/css/styles.86c9ae18.css">
<link rel="preload" href="/en/assets/js/runtime~main.06ffa367.js" as="script">
<link rel="preload" href="/en/assets/js/main.7f2e5564.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><span>更新 <a href="/website">网址导航</a> 带你发现感兴趣的技术</span></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">kuizuo</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/en/docs/linux">Linux</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/en/docs/category/Linux基础">Linux 基础</a></li><li><a class="dropdown__link" href="/en/docs/category/Linux进阶">Linux 进阶</a></li><li><a class="dropdown__link" href="/en/docs/category/Linux测试">Linux 测试</a></li><li><a class="dropdown__link" href="/en/docs/category/LinuxCICD">Linux CICD研发</a></li><li><a class="dropdown__link" href="/en/docs/skill/">Notes</a></li><li><a class="dropdown__link" href="/en/docs/tools/">Recommended Tools</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Blog</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/en/tags">Tags</a></li><li><a class="dropdown__link" href="/en/archive">Archive</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Tools</a><ul class="dropdown__menu"><li><a href="https://api.kuizuo.cn" target="_blank" rel="noopener noreferrer" class="dropdown__link">API Service</a></li><li><a href="https://js-de-obfuscator.vercel.app" target="_blank" rel="noopener noreferrer" class="dropdown__link">JS Deobfuscate</a></li><li><a href="https://cipher.kuizuo.cn" target="_blank" rel="noopener noreferrer" class="dropdown__link">CyberChef Encryption</a></li><li><a href="https://pan.kuizuo.cn" target="_blank" rel="noopener noreferrer" class="dropdown__link">Cloudreve</a></li></ul></div><a class="navbar__item navbar__link" href="/en/website">Links</a><a class="navbar__item navbar__link" href="/en/project">Projects</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/en/"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"><b>kuizuo</b></a><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/linux">linux</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linux基础">Linux基础</a><button aria-label="Toggle the collapsible sidebar category &#x27;Linux基础&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/en/docs/category/linux进阶">Linux进阶</a><button aria-label="Toggle the collapsible sidebar category &#x27;Linux进阶&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-1">第 1 章 Linux 进阶命令</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-2">第 2 章 Linux 防火墙</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-3">第 3 章 Linux NFS 网络文件系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-4">第 4 章 Linux DHCP 服务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-5">第 5 章 Linux DNS 服务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-6">第 6 章 Linux httpd 服务基础配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-7">第 7 章 Linux httpd 服务进阶配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-8">第 8 章 Linux httpd 服务高级配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-9">第 9 章 Linux Nginx 服务配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-10">第 10 章 Linux Tomcat 服务基础配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-11">第 11 章 Linux Tomcat 服务实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-12">第 12 章 Linux haproxy 服务基础配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/en/docs/linux-advanced-13">第 13 章 Linux haproxy 服务进阶配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-14">第 14 章 Linux haproxy 服务高级配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-15">第 15 章 Linux LVS 服务配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-16">第 16 章 Linux Keepalived 服务配置</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linux测试">Linux测试</a><button aria-label="Toggle the collapsible sidebar category &#x27;Linux测试&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linuxcicd">LinuxCICD</a><button aria-label="Toggle the collapsible sidebar category &#x27;LinuxCICD&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/en/docs/category/linux进阶"><span itemprop="name">Linux进阶</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">第 13 章 Linux haproxy 服务进阶配置</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>第 13 章 Linux haproxy 服务进阶配置</h1></header><p>haproxy 基础篇中我们强调过，默认配置虽然可以直接使用，但是真正的生产环境中，想要实现高性能的代理服务，必须把握好众多参数，这就要求对 haproxy 的配置文件有更进一步的精深理解。下面我们会对 haproxy 的配置文件进行详解。</p><p>配置文件的重点在于前端(frontend)和后端(backend)的定制。全局选项(global)的配置将默认提供的参数稍微修改下即可。</p><p>可以使用 haproxy 命令行检查配置文件语法是否正确：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">haproxy -f /etc/haproxy/phaproxy.cfg -c</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>或者使用 sysv 脚本的 check 参数：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">service</span><span class="token plain"> haproxy check</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="91配置文件说明">9.1、配置文件说明<a class="hash-link" href="#91配置文件说明" title="Direct link to heading">​</a></h2><p>HAProxy 在启动之前会解析配置文件，有 3 处配置信息来源：</p><ol><li>最优先处理来自 haproxy 命令行给出的参数。</li><li>&quot;global&quot; 配置段的参数，设定为全局参数。</li><li>代理配置段，包括 <code>defaults</code>，<code>listen</code>，<code>frontend</code> 和 <code>backend</code> 段。</li></ol><p>另外 haproxy 配置文件引入了<strong>引号和转义符：反斜线表示转义符；单引号表示强引用；双引号表示弱引用</strong>。如果字符串内需要输入空格，则空格需要进行转义或者通过引号包围，不转义时在配置文件中表示分隔符。</p><p>如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">    标记一个空白字符以区分它的本义和用作分隔符时的空白符</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">#   to mark a </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">hash</span><span class="token plain"> and differentiate it from a comment</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">   to use a backslash</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">&#x27;   to use a single quote and differentiate it from strong quoting</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">&quot;   to use a double quote and differentiate it from weak quoting</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下面几种情况是等价的：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">log-format %</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">+Q</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"> %t</span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"> %s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"> %</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">-Q</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain">r</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">log-format </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;%{+Q}o %t %s %{-Q}r&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">log-format </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;%{+Q}o %t %s %{-Q}r&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">log-format </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;%{+Q}o %t&quot;</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27; %s %{-Q}r&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">log-format </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;%{+Q}o %t&quot;</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27; %s&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"> %</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">-Q</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain">r</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在配置文件中，一些<strong>包含了数值的参数表示时间</strong>，如 timeout。这些值默认以毫秒为单位，但也可以使用其它的时间单位后缀。</p><ul><li>us：微秒(microseconds)，即 1/1000000 秒；</li><li>ms：毫秒(milliseconds)，即 1/1000 秒；</li><li>s：秒(seconds)；</li><li>m：分钟(minutes)；</li><li>h：小时(hours)；</li><li>d：天(days)；</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="92简单配置示例">9.2、简单配置示例<a class="hash-link" href="#92简单配置示例" title="Direct link to heading">​</a></h2><p>以下是一个简单的配置文件，该配置文件代理模式为 http，frontend 定义的是监听在前端所有网卡的 80 端口上，此文件中只定义了一个后端服务器组 backend，该 backend 只包含一台监听在 127.0.0.1:8000 的服务器。<strong>在 haproxy 的术语中，frontend 表示的是监听套接字，用于等待客户端的连接。</strong></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">global</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    daemon</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">256</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">defaults</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    mode http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> connect 5000ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> client 50000ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> server 50000ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">frontend http-in</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain"> *:80</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    default_backend web_servers</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">backend web_servers</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server server1 </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:8000 maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">32</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果使用 listen 配置方式替换 backend 和 frontend，则更简单，以下是等价配置：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">global</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    daemon</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">256</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">defaults</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    mode http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> connect 5000ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> client 50000ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> server 50000ms</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">listen http-in</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain"> *:80</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server server1 </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:8000 maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">32</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="93全局配置参数">9.3、全局配置参数<a class="hash-link" href="#93全局配置参数" title="Direct link to heading">​</a></h2><p>全局配置参数设定 haproxy 进程运行环境，一般和操作系统指定的值有关，配置正确后一般都不会去修改。全局配置参数一般都有对应的命令行选项。</p><ol><li><p><strong>进程管理及安全相关的参数</strong></p><p>haproxy 是单进程、事件驱动、非阻塞模型的调度器。虽然是单进程，但官方强烈建议不要设置为多进程，因为单进程可以处理很多个代理连接请求且性能极好(官方手册说 30W 个代理实例都能良好运行)，设置为多进程反而有一些限制。</p><ul><li>chroot ：修改 haproxy 工作目录至指定目录，可提升 haproxy 安全级别，但要确保必须为空且任何用户均不能有写权限；</li><li>daemon：让 haproxy 以守护进程的方式工作于后台，等同于命令行的 &quot;-D&quot; 选项，当然，也可以在命令行中以 &quot;-db&quot; 选项将其禁用；<strong>(建议设置项)</strong></li><li>uid/user：以指定的 UID 或用户名身份运行 haproxy 进程；</li><li>gid/group：以指定的 GID 或组名运行 haproxy，建议使用专用于运行 haproxy 的 GID，以免因权限问题带来风险；</li><li>log：定义全局的 syslog 服务器，接收 haproxy 启动和停止的日志。最多可以定义两个；<ul><li><code>log &lt;address&gt; &lt;facility&gt; [max level [min level]]</code></li></ul></li><li>log-send-hostname <!-- -->[<!-- -->string<!-- -->]<!-- -->：在日志的最前面记录本机主机名或 string。远程发送到日志服务器时可由此知道是 haproxy 主机发送的。</li><li>pidfile：等同于命令行的 &quot;-p&quot; 选项。使用服务脚本启动 haproxy 时建议不要设置该项，以保证脚本能正确获取 pid 文件。</li><li>nbproc ：指定启动的 haproxy 进程个数，只能用于守护进程模式的 haproxy；默认只启动一个进程，一般只在单进程仅能打开少数文件描述符的场景中才使用多进程模式；(<strong>官方强烈建议不要设置该选项)</strong></li><li>ulimit-n：设定每进程能够打开的最大文件描述符数量，默认 haproxy 会自动进行计算，因此不推荐修改此选项；<strong>(不建议设置项)</strong></li><li>stats：和多进程 haproxy 有关，由于不建议使用多进程，所以也<strong>不建议设置此项。但建议设置为 &quot;stats socket&quot;</strong> 将套接字和本地文件进行绑定，如 &quot;stats socket /var/lib/haproxy/stats&quot;。</li><li>node：定义当前节点的名称，用于 HA 场景中多 haproxy 进程使用相同 IP 地址时分辨哪个 node 正处于使用状态；</li></ul></li><li><p><strong>性能调整相关的参数</strong></p><ul><li>maxconn ：设定每 haproxy 进程所接受的最大并发连接数，当达到此限定连接数后将不再接受新的连接。该参数特指和客户端的连接数，不包括和服务端的连接。等同于命令行选项 &quot;-n&quot;；&quot;ulimit -n&quot; 就是根据此值进行自动调整的；</li><li>maxpipes ：haproxy 在使用 splice() 在内核中零复制时，是使用 pipe 传递进行报文粘接重组的，此选项用于设定每进程所允许使用的最大 pipe 个数；每个 pipe 会打开两个文件描述符，因此 &quot;ulimit -n&quot; 自动计算时会按需调大此值；默认值为 maxconn/4。调小时会影响一定的性能；</li><li>noepoll：在 Linux 系统上禁用 epoll 机制；<strong>(不建议设置此项)</strong></li><li>nokqueue：在 BSD 系统上禁用 kqueue 机制；</li><li>nopoll：禁用 poll 机制；</li><li>nosplice：禁止在 Linux 套接字上使用内核 tcp 重组，这会导致更多的 recv/send 系统调用；<strong>(在内核版本 2.6.28 之后极度不建议设置此项)</strong></li><li>spread-checks &lt;0..50, in percent&gt;：在 haproxy 后端有着众多服务器的场景中，在精确的时间间隔后统一对众服务器进行健康状况检查可能会带来意外问题；此选项用于在其检查的时间间隔长度上增加或减小一定的随机时长；默认为 0，官方建议设置为 2 到 5 之间。<strong>(建议设置项)</strong></li><li>tune.bufsize ：设定 buffer 的大小，同样的内存条件下，较小的值可以让 haproxy 有能力接受更多的并发连接，较大的值可以让某些应用程序使用较大的 cookie 信息；默认为 16384，可在编译时修改，不过强烈建议使用默认值；<strong>(不建议设置项)</strong></li><li>tune.chksize ：设定检查缓冲区的大小，单位为字节；更大的值有助于在较大的页面中完成基于字符串或正则 pattern 的文本查找，但也会占用更多的系统资源；<strong>(不建议设置项)</strong></li><li>tune.maxaccept ：设定 haproxy 进程内核调度运行时一次性可以接受的连接的个数，较大的值可以带来较大的吞吐率，默认在单进程模式下为 100，多进程模式下为 8，设定为 -1 可以禁止此限制；<strong>(不建议设置项)</strong></li><li>tune.maxpollevents ：设定一次 io 复用时系统调用可以处理的事件最大数，默认值取决于 OS；其值小于 200 时可节约带宽，但会略微增大网络延迟，而大于 200 时会降低延迟，但会稍稍增加网络带宽的占用量；<strong>(不建议设置项)</strong></li><li>tune.maxrewrite ：设定为首部重写或追加而预留的缓冲空间，建议使用 1024 左右的大小；在需要使用更大的空间时，haproxy 会自动增加其值；<strong>(不建议设置项)</strong></li><li>tune.rcvbuf.client ：设定两端的 recv<!-- -->_<!-- -->buff 大小(haproxy 和客户端建立 tcp，和后端服务器建立 tcp，共两端，因此有两个 recv<!-- -->_<!-- -->buff 和两个 send<!-- -->_<!-- -->buff)。单位为字节；<strong>(强烈推荐使用默认值)</strong></li><li>tune.rcvbuf.server ：<strong>(强烈推荐使用默认值)</strong></li><li>tune.sndbuf.client：设定两端的 send<!-- -->_<!-- -->buff 大小<strong>(强烈推荐使用默认值)</strong></li><li>tune.sndbuf.server：<strong>(强烈推荐使用默认值)</strong></li></ul></li></ol><p>因此，抛去不建议设置的项后，global 段的设置大致如下：这也是 yum 安装 haproxy 时默认提供的配置：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">global</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    daemon</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    log         </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1 local2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">chroot</span><span class="token plain">      /var/lib/haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    pidfile     /var/run/haproxy.pid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    maxconn     </span><span class="token number" style="color:rgb(9, 134, 88)">4000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    user        haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    group       haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stats socket /var/lib/haproxy/stats</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意上面配置了使用 local2 记录 log，因此还需去 rsyslogd 的配置文件中添加该设备以及记录的日志位置。如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">cat</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;&lt;</span><span class="token plain">eof</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;&gt;</span><span class="token plain">/etc/rsyslog.conf</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  local2.*     /var/log/haproxy.log</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">eof</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="94proxy-配置段和常用配置选项">9.4、proxy 配置段和常用配置选项<a class="hash-link" href="#94proxy-配置段和常用配置选项" title="Direct link to heading">​</a></h2><p>proxy 配置部分是 haproxy 最重要的配置部分，包含下面四种配置段：</p><ol><li>defaults <!-- -->[<!-- -->]<!-- -->: 设置 frontend/backend/listen 配置段的默认值。</li><li>frontend: 配置监听客户端连接的套接字。</li><li>backend: 配置 haproxy 所代理的后端服务器组。</li><li>listen: 定义一个完整的前端和后端代理，但后端可以不定义。所以有时候等价于 frontend + backend。它常用于绑定前后端 1 对 1 的情况。</li></ol><p>所有代理的名称只能使用大写字母、小写字母、数字、-(中线)、<!-- -->_<!-- -->(下划线)、.(点号) 和 :(冒号)。此外，ACL 名称会区分字母大小写。</p><p>目前，有两种主流的代理模式：tcp 代理(即所谓的 4 层代理)和 http 代理(即所谓的 7 层代理)。</p><ul><li>在 4 层代理模式下，haproxy 简单的在两端进行双向转发。</li><li>在 7 层代理模式下，haproxy 会对协议进行分析，可以根据协议来允许、阻塞、切换、增加、修改和移除 request 或 response 中的属性内容。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="941http-事务模型相关设置">9.4.1、http 事务模型相关设置<a class="hash-link" href="#941http-事务模型相关设置" title="Direct link to heading">​</a></h3><ol><li><p>(no) option http-keep-alive</p><p>启用或禁用客户端和服务端到 haproxy 之间的长连接。haproxy 将处理所有请求和响应报文，请求完后 haproxy 两端的连接都处于空闲状态。由于和后端保持了连接，可以以最快的方式重用会话。</p></li><li><p>(no) option http-server-close</p><p>启用或禁用在 haproxy 处理完第一次响应之后关闭 haproxy 到服务端之间长连接的功能，但客户端的长连接还保持，后续的每次请求都重新建立和后端的连接，每次响应后都关闭和后端的连接。</p><p>启用该选项时，haproxy 将会在转发给后端 server 的 request 数据包中添加一个 &quot;Connection:Close&quot; 标记，后端 Server 看到此标记就会在响应后关闭 tcp 连接。</p></li><li><p>(no) option http-pretend-keepalive</p><p>有些服务器会无视带有 &quot;Connection:Close&quot; 标记的请求，从而 http-server-close 的后端发送响应后不会关闭 tcp 连接。设置该选项时，haproxy 在收到响应后会主动关闭和后端的连接。</p><p>不建议设置该选项，因为绝大多数服务器都能正常工作并且有很好的调整能力。</p></li></ol><p>一般来说，对于高速局域网络来说，如果后端响应的速度非常快(比如后端是静态服务器响应小文件、后端是静态缓存服务器)，这时建立 tcp 连接的代价就比较大，维持空闲连接的优势会非常明显。</p><p>如果后端是动态应用程序，响应给 haproxy 的速度相对较慢，维持空闲连接的代价非常大，完全可以先释放长连接以腾出资源，在需要连接的时候再建立新 tcp 连接。因此：</p><ol><li><strong>后端是静态内容缓存服务器时，或者就是静态服务器时，首选使用 http-keep-alive 模式；</strong></li><li><strong>后端是动态应用程序服务器时，首选使用 http-server-close 模式</strong>。</li></ol><p>默认情况下，如果客户端请求根据调度算法被调度到另一台后端服务器时，http-keep-alive 模式下和后端服务器的空闲连接会立即断开，并重新和被调度选中的后端服务器建立连接。</p><p>可以使用 &quot;prefer-last-server&quot; 选项，使得 haproxy 先查看当前保持的空闲连接是否可用，如果可用，则继续使用该空闲连接，但是这样会影响调度性能。</p><p>frontend 和 backend 都可以设置这些模式选项，如果它们交叉设置了，最终何种模式会生效？例如，frontend 设置了 http-keep-alive，而 bakcend 设置了 http-server-close 时，取何种模式？计算方式采用如下矩阵：keepalive 优先级是最弱的，forceclose 是优先级是最高的。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">The effective mode that will be applied to a connection passing through a</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">frontend and a backend can be determined by both proxy modes according to the</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">following matrix, but </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> short, the modes are symmetric, keep-alive is the</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">weakest option and close is the strongest.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                   Backend mode</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> KAL </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> SCL </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> CLO</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            ----+-----+-----+----</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            KAL </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> KAL </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> SCL </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> CLO</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            ----+-----+-----+----</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   mode     SCL </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> SCL </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> SCL </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> CLO</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            ----+-----+-----+----</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            CLO </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> CLO </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> CLO </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> CLO</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="942balance">9.4.2、balance<a class="hash-link" href="#942balance" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 可用于 default、listen、backend 配置段。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">balance </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">algorithm</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">arguments</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">balance url_param </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">param</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">check_post</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可用于以下配置段：</p><table><thead><tr><th>defaults</th><th>frontend</th><th>listen</th><th>backend</th></tr></thead><tbody><tr><td>yes</td><td></td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>no</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="cross" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACR0lEQVQ4jZ2RT2sTURTFz3sz00wyzsTWWDRK1IIoU4TiShC1CioI4q5aRa1/QIqiqMV+Dlfid1FbUPQTTMGNbW2nSZTENO00z7nvj4u2oWnsQu/uct/5vXvOBf6xxNiD3Naeb23MxGTJTEyGO4rv3g8NpQ+TkdGzXQAzMVmCZc0bziP17EUXRNy5F4LziPv+a030uHn12vE2YFOMTAZwXYDziMaftCGt22MhGIusXR56CgU4QTCiU7pUv3CRMwAwL1+5RusE2Sxnvg/dbEI3GtCiNahJgnEe8cCHE+Qh4kX8Lle0Jsr0Tb2TbPMX9fS5a5RKWDbLeZCHWm5A/qrDkITl+3DyAcRiDFGpaCPJ65t6LwCAbfVJj8ZdLVXCczlu9+4GlAa0BrSCiGOISnVdPP1B/PUKzts3whB5VKtpkALm5oDZWUApiHJFa0o7xF0AANBEA4yBQ0mACJASkBLM4lynNLD9fQdg7catEAyRlc0BkoBiESjuB6REJp+HZVtRZehkx4nbGSTXb4aMs8jOeXCCAK3yEkS1qjUR3N4+7hX3Ya1cwdrSEtKV1cEDX2dm2hskI6MhYyyyszk4vodWvJ62TskzRF4Sx3rl2yxyhT3IFgqwe5xo4fBACAD2hu9+7tiA0WjFZbR+VLUh6RU+fxQAUD4x5K3GcWLSlDueB8Y5jFL9AGbaFhqXrwxzx5mi5rLWJL29Xz51pB0fPeYapZIe3+eiXj9fWpif3h4oamfODf88ddrtGmzUwqEj7veDpeGd5v9VfwCELBf4vgaL1QAAAABJRU5ErkJggg==" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="check" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td></td><td></td><td></td></tr></tbody></table><p>Examples：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">balance roundrobin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">balance url_param userid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">balance url_param session_id check_post </span><span class="token number" style="color:rgb(9, 134, 88)">64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">balance hdr</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">User-Agent</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">balance hdr</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">host</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">balance hdr</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">Host</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> use_domain_only</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>指定代理时负载均衡算法(algorithm)，支持的算法有：</p><ol><li>roundrobin(默认)：根据权重进行轮询，在服务器的处理时间保持均匀分布时，这是最平衡、最公平的算法。此算法是动态的，表示权重可以在 haproxy 运行时调整后端服务器的权重并生效；</li><li>static-rr：基于权重进行轮询，与 roundrobin 类似，但是为静态方法，在 haproxy 运行时调整其服务器权重不会生效；</li><li>leastconn：新的连接请求被派发至具有最少连接数目的后端服务器；在有着较长时间会话的场景中推荐使用此算法，如 LDAP、SQL 等，其并不太适用于较短会话的应用层协议，如 HTTP；此算法是动态的，可以在运行时调整其权重；</li><li>source：将请求的源地址进行 hash 运算，使得同一个客户端 IP 的请求始终被派发至某特定的服务器；但当服务器权重总数发生变化时，如某服务器宕机或添加了新的服务器，许多客户端的请求可能会被派发至与此前请求不同的服务器；类似于 nginx 的 ip<!-- -->_<!-- -->hash，可用于负载均衡无 cookie 功能基于 TCP 协议时。默认为静态；</li><li>uri：对 URI 的左半部分(&quot;?&quot; 标记之前的部分)进行 hash 运算，并除以服务器的总权重来计算派发至某匹配服务器；这可以使得对同一个 URI 的请求总是被派发至某特定的服务器，除非服务器的权重总数发生了变化；此算法常用于代理缓存以提高缓存的命中率；但此算法仅应用于提供 http 服务的后端服务器；默认为静态算法；缺点是后端 server 宕机会造成严重抖动，可以通过 hash-type 设置 hash 算法为一致性哈希解决。</li><li>url<!-- -->_<!-- -->param：一般用于将同一用户 ID 转发至同一服务器的情况。在使用了 basic 认证时，url 中的 param 一般都会使用 user=XXX。使用该算法会对该参数进行 hash 运算，然后除以总权重以决定分配到哪台后端 server。</li><li>hdr(name)：基于指定的请求首部名称进行调度。首部中指定名称相同的调度至同一服务器。一般使用 &quot;hdr(host)&quot; 根据请求首部中的 host 即目标主机来进行 hash 运算。使用 use<!-- -->_<!-- -->domain<!-- -->_<!-- -->only 选项可以基于域名来哈希，使得访问 <a href="http://www.brinnatt.com" target="_blank" rel="noopener noreferrer">www.brinnatt.com</a> 和 web.brinnatt.com 的请求都调度至同一服务器。</li><li>rdp-cookie(name)：基于远程桌面 RDP 协议设置 RDP cookie，不区分字母大小写，把相同用户或者相同 session ID 调度到相同服务器。如果没有 cookie，使用 roundrobin 调度。</li></ol><p>roundrobin 和 static-rr 是有区别的，roundrobin 是动态慢轮询，不用重启服务即可调整其权重，而 static-rr 必须重启服务修改的权重才生效。</p><ul><li>例如原有 2 台后端 server，新添加一台后，roundrobin 会从此时开始慢慢的将请求轮询至此新服务器，而 static-rr 由于需要重启，所以重启前新 server 不会被调度到，重启后新 server 和旧 server 平均调度。</li><li>一般来说，考虑加权轮询的时候，roundrobin 要比 static-rr 好。</li></ul><p>一般可纳入考虑的算法有 roundrobin/static-rr/leastconn/uri，其中 leastconn 算法用于代理 ldap、mysql 等长时间会话连接的情况，uri 算法用于代理后端为缓存服务器的情况。</p><ul><li>用于调度 MySQL 服务器，使用何种算法？<ul><li>答：leastconn</li></ul></li><li>用于调度静态服务器组，使用何种算法？<ul><li>答：roundrobin</li></ul></li><li>调度动态应用程序服务器组，使用何种算法？<ul><li>答：通常客户端需要和后端应用程序服务器保持联系，一般会使用 cookie 或者 session 来实现，但如果特殊情况下无法通过它们实现，则可以使用 source 作为最后 &quot;亲和性&quot; 手段。注意，使用 source 算法时，后端服务器数量一改变，就会导致大量的会话断开。</li></ul></li><li>调度缓存服务器，使用何种算法？<ul><li>答：uri，且设置 hash-type 为一致性哈希算法。</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="943hash-type">9.4.3、hash-type<a class="hash-link" href="#943hash-type" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 指定一种 method 映射 hashes 到 servers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">hash-type </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">method</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">function</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">modifier</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可用在以下配置段：</p><table><thead><tr><th>defaults</th><th>frontend</th><th>listen</th><th>backend</th></tr></thead><tbody><tr><td>yes</td><td></td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>no</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="cross" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACR0lEQVQ4jZ2RT2sTURTFz3sz00wyzsTWWDRK1IIoU4TiShC1CioI4q5aRa1/QIqiqMV+Dlfid1FbUPQTTMGNbW2nSZTENO00z7nvj4u2oWnsQu/uct/5vXvOBf6xxNiD3Naeb23MxGTJTEyGO4rv3g8NpQ+TkdGzXQAzMVmCZc0bziP17EUXRNy5F4LziPv+a030uHn12vE2YFOMTAZwXYDziMaftCGt22MhGIusXR56CgU4QTCiU7pUv3CRMwAwL1+5RusE2Sxnvg/dbEI3GtCiNahJgnEe8cCHE+Qh4kX8Lle0Jsr0Tb2TbPMX9fS5a5RKWDbLeZCHWm5A/qrDkITl+3DyAcRiDFGpaCPJ65t6LwCAbfVJj8ZdLVXCczlu9+4GlAa0BrSCiGOISnVdPP1B/PUKzts3whB5VKtpkALm5oDZWUApiHJFa0o7xF0AANBEA4yBQ0mACJASkBLM4lynNLD9fQdg7catEAyRlc0BkoBiESjuB6REJp+HZVtRZehkx4nbGSTXb4aMs8jOeXCCAK3yEkS1qjUR3N4+7hX3Ya1cwdrSEtKV1cEDX2dm2hskI6MhYyyyszk4vodWvJ62TskzRF4Sx3rl2yxyhT3IFgqwe5xo4fBACAD2hu9+7tiA0WjFZbR+VLUh6RU+fxQAUD4x5K3GcWLSlDueB8Y5jFL9AGbaFhqXrwxzx5mi5rLWJL29Xz51pB0fPeYapZIe3+eiXj9fWpif3h4oamfODf88ddrtGmzUwqEj7veDpeGd5v9VfwCELBf4vgaL1QAAAABJRU5ErkJggg==" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="check" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td></td><td></td><td></td></tr></tbody></table><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">method</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> is the method used to </span><span class="token keyword" style="color:rgb(0, 0, 255)">select</span><span class="token plain"> a server from the </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">hash</span><span class="token plain"> computed by the </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">function</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    map-based   </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">hash</span><span class="token plain"> 表是一个包含所有活动服务器的静态阵列。两个重点，一个是服务器正在运行时，修改权重无效；</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                二是一旦有服务器 down 或 up，会出现大面积会话保持失效，连接重新调度。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    consistent  </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">hash</span><span class="token plain"> 表是一个由各服务器填充而成的树状结构，即一致性哈希算法；基于hash键在hash树中查找相应的服务器时，最近的服务器将被选中。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                此方法是动态的，支持在运行时修改服务器权重，因此兼容慢速启动的特性。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                添加一个新的服务器时，仅会对一小部分请求产生影响，因此，适用于后端服务器为cache的场景。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                不过，此算法不甚平滑，派发至各服务器的请求未必能达到理想的均衡效果，因此，可能需要不时的调整服务器的权重以获得更好的均衡性。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">function</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> is the </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">hash</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">function</span><span class="token plain"> to be used </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    sdbm        这个最初是为 sdbm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">a public-domain reimplementation of ndbm</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> 创建数据库的库函数，后来发现做散列运算也挺合适</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    djb2        djb2 通过研究表明在某些工作负载情况下，可以提供比 sdbm 更好的散列运算。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    wt6         wt6 为 haproxy 设计出来，在过去用来测试其它的函数。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    crc32       crc32 是在以太网中最通用的 CRC32 实现，比如 gzip, PNG等。其散列算法比其它的要慢一些，但是从散列结果和不可预测上来说，显得更加优秀。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">modifier</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> indicates an optional method applied after hashing the key </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    avalanche   这个指令表示上面的哈希函数的结果不应该以原始形式使用，必须首先应用一个 </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain"> 字节的完整雪崩哈希；</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                此步骤的目的是混合前一个散列的结果位，以避免在输入包含一些有限值或服务器数量是散列某个组件的倍</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                数时</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">SDBM为64,DJB2为33</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">产生任何不希望的影响。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                主要目的就是让结果更难预测。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token maybe-class-name">The</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(0, 0, 255)">default</span><span class="token plain"> hash type is </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;map-based&quot;</span><span class="token plain"> and is recommended </span><span class="token keyword control-flow" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> most usages</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain"> </span><span class="token property-access maybe-class-name">The</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword module" style="color:rgb(0, 0, 255)">default</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">function</span><span class="token plain"> is </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;sdbm&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> the selection </span><span class="token keyword" style="color:rgb(0, 0, 255)">of</span><span class="token plain"> a </span><span class="token keyword" style="color:rgb(0, 0, 255)">function</span><span class="token plain"> should be based on</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">the range </span><span class="token keyword" style="color:rgb(0, 0, 255)">of</span><span class="token plain"> the values being hashed</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>默认的 hash 类型是 map-bashed，大多数情况建议使用这个 hash 类型。默认的函数为 sdbm，函数的选择应该基于散列值的范围。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="944bind">9.4.4、bind<a class="hash-link" href="#944bind" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">address</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">:</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">port_range</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">, </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">param*</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain"> /</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">path</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">, </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">param*</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可用在以下配置段：</p><table><thead><tr><th>defaults</th><th>frontend</th><th>listen</th><th>backend</th></tr></thead><tbody><tr><td>no</td><td></td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACR0lEQVQ4jZ2RT2sTURTFz3sz00wyzsTWWDRK1IIoU4TiShC1CioI4q5aRa1/QIqiqMV+Dlfid1FbUPQTTMGNbW2nSZTENO00z7nvj4u2oWnsQu/uct/5vXvOBf6xxNiD3Naeb23MxGTJTEyGO4rv3g8NpQ+TkdGzXQAzMVmCZc0bziP17EUXRNy5F4LziPv+a030uHn12vE2YFOMTAZwXYDziMaftCGt22MhGIusXR56CgU4QTCiU7pUv3CRMwAwL1+5RusE2Sxnvg/dbEI3GtCiNahJgnEe8cCHE+Qh4kX8Lle0Jsr0Tb2TbPMX9fS5a5RKWDbLeZCHWm5A/qrDkITl+3DyAcRiDFGpaCPJ65t6LwCAbfVJj8ZdLVXCczlu9+4GlAa0BrSCiGOISnVdPP1B/PUKzts3whB5VKtpkALm5oDZWUApiHJFa0o7xF0AANBEA4yBQ0mACJASkBLM4lynNLD9fQdg7catEAyRlc0BkoBiESjuB6REJp+HZVtRZehkx4nbGSTXb4aMs8jOeXCCAK3yEkS1qjUR3N4+7hX3Ya1cwdrSEtKV1cEDX2dm2hskI6MhYyyyszk4vodWvJ62TskzRF4Sx3rl2yxyhT3IFgqwe5xo4fBACAD2hu9+7tiA0WjFZbR+VLUh6RU+fxQAUD4x5K3GcWLSlDueB8Y5jFL9AGbaFhqXrwxzx5mi5rLWJL29Xz51pB0fPeYapZIe3+eiXj9fWpif3h4oamfODf88ddrtGmzUwqEj7veDpeGd5v9VfwCELBf4vgaL1QAAAABJRU5ErkJggg==" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="cross" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>no</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="check" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACR0lEQVQ4jZ2RT2sTURTFz3sz00wyzsTWWDRK1IIoU4TiShC1CioI4q5aRa1/QIqiqMV+Dlfid1FbUPQTTMGNbW2nSZTENO00z7nvj4u2oWnsQu/uct/5vXvOBf6xxNiD3Naeb23MxGTJTEyGO4rv3g8NpQ+TkdGzXQAzMVmCZc0bziP17EUXRNy5F4LziPv+a030uHn12vE2YFOMTAZwXYDziMaftCGt22MhGIusXR56CgU4QTCiU7pUv3CRMwAwL1+5RusE2Sxnvg/dbEI3GtCiNahJgnEe8cCHE+Qh4kX8Lle0Jsr0Tb2TbPMX9fS5a5RKWDbLeZCHWm5A/qrDkITl+3DyAcRiDFGpaCPJ65t6LwCAbfVJj8ZdLVXCczlu9+4GlAa0BrSCiGOISnVdPP1B/PUKzts3whB5VKtpkALm5oDZWUApiHJFa0o7xF0AANBEA4yBQ0mACJASkBLM4lynNLD9fQdg7catEAyRlc0BkoBiESjuB6REJp+HZVtRZehkx4nbGSTXb4aMs8jOeXCCAK3yEkS1qjUR3N4+7hX3Ya1cwdrSEtKV1cEDX2dm2hskI6MhYyyyszk4vodWvJ62TskzRF4Sx3rl2yxyhT3IFgqwe5xo4fBACAD2hu9+7tiA0WjFZbR+VLUh6RU+fxQAUD4x5K3GcWLSlDueB8Y5jFL9AGbaFhqXrwxzx5mi5rLWJL29Xz51pB0fPeYapZIe3+eiXj9fWpif3h4oamfODf88ddrtGmzUwqEj7veDpeGd5v9VfwCELBf4vgaL1QAAAABJRU5ErkJggg==" width="16" height="16" class="img_ev3q"></td><td></td><td></td><td></td></tr></tbody></table><p>Examples：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">listen http_proxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain"> :80,:443</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">10.0</span><span class="token plain">.0.1:10080,10.0.0.1:10443</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain"> /var/run/ssl-frontend.sock user root mode </span><span class="token number" style="color:rgb(9, 134, 88)">600</span><span class="token plain"> accept-proxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">listen http_https_proxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain"> :80</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain"> :443 ssl crt /etc/haproxy/site.pem</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">listen http_https_proxy_explicit</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain"> ipv6@:80</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain"> ipv4@public_ssl:443 ssl crt /etc/haproxy/site.pem</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain"> unix@ssl-frontend.sock user root mode </span><span class="token number" style="color:rgb(9, 134, 88)">600</span><span class="token plain"> accept-proxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">listen external_bind_app1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;fd@</span><span class="token string variable" style="color:rgb(9, 134, 88)">${FD_APP1}</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="945mode">9.4.5、mode<a class="hash-link" href="#945mode" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">mode </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> tcp</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">http </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可用在以下配置段：</p><table><thead><tr><th>defaults</th><th>frontend</th><th>listen</th><th>backend</th></tr></thead><tbody><tr><td>yes</td><td></td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="cross" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="check" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td></td><td></td><td></td></tr></tbody></table><p>Examples：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">defaults http_instances</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    mode http</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>指定 haproxy 实例运行模式。可为 tcp、http。tcp 为 4 层代理模式，不会对协议进行任何分析，只是单纯地转发数据包，如 HTTPS/MYSQL 等，http 为 7 层代理模式。如果所有配置区段都没有设置 mode，则默认为 tcp 模式。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="946log">9.4.6、log<a class="hash-link" href="#946log" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">log global</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">log </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">address</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">len </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">length</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">format </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">format</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">sample </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">ranges</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">:</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">sample_size</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">facility</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">level</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">minlevel</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">no log</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可用在以下配置段：</p><table><thead><tr><th>defaults</th><th>frontend</th><th>listen</th><th>backend</th></tr></thead><tbody><tr><td>yes</td><td></td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="cross" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="check" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td></td><td></td><td></td></tr></tbody></table><p>Examples：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">log global</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">log stdout </span><span class="token function" style="color:rgb(0, 0, 255)">format</span><span class="token plain"> short daemon              </span><span class="token comment" style="color:rgb(0, 128, 0)"># send log to systemd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">log stdout </span><span class="token function" style="color:rgb(0, 0, 255)">format</span><span class="token plain"> raw daemon                </span><span class="token comment" style="color:rgb(0, 128, 0)"># send everything to stdout</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">log stderr </span><span class="token function" style="color:rgb(0, 0, 255)">format</span><span class="token plain"> raw daemon notice         </span><span class="token comment" style="color:rgb(0, 128, 0)"># send important events to stderr</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">log </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1:514 local0 notice             </span><span class="token comment" style="color:rgb(0, 128, 0)"># only send important events</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">log tcp@127.0.0.1:514 local0 notice notice  </span><span class="token comment" style="color:rgb(0, 128, 0)"># same but limit output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                            </span><span class="token comment" style="color:rgb(0, 128, 0)"># level and send in tcp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">log </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">${LOCAL_SYSLOG}</span><span class="token string" style="color:rgb(163, 21, 21)">:514&quot;</span><span class="token plain"> local0 notice       </span><span class="token comment" style="color:rgb(0, 128, 0)"># send to local server</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果使用 log global，则表示从全局继承日志设置。另外，如果全局已经定义过两个 log 了，此处除引用 global 外还自定义了一个 log，则此自定义的 log 失效，因为只支持两个日志设置。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="947capture">9.4.7、capture<a class="hash-link" href="#947capture" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 仅能用于&quot;frontend&quot;和&quot;listen&quot;区段</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">capture request header </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">name</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> len </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">length</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">capture response header </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">name</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> len </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">length</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>捕获并记录最近一次出现的指定请求首部或响应首部。请求首部是从客户端发起的请求首部，响应首部是从后端 server 响应并在 haproxy 准备发送给客户端前捕获的。捕获的首部值使用大括号 括起来后会添加进日志中。如果需要捕获多个首部值，它们将以指定的秩序出现在日志文件中，并以竖线 &quot;|&quot; 作为分隔符。不存在的首部记录为空字符串。</p><p>最常需要捕获的请求首部包括：在虚拟主机环境中使用的 &quot;Host&quot;、上传请求首部中的 &quot;Content-length&quot;、快速区别真实用户和网络机器人的 &quot;User-agent&quot;，以及代理环境中记录请求真实来源的 &quot;X-Forward-For&quot;。</p><p>一般需要捕获的响应首部为：记录还有多少内容需要接收的 &quot;Content-length&quot;、跟踪重定向路径的 &quot;Location&quot;。</p><blockquote><ul><li><code>&lt;name&gt;</code>：要捕获的首部的名称，此名称不区分字符大小写，但建议与它们出现在首部中的格式相同，比如大写首字母。需要注意的是，记录在日志中的是首部对应的值，而非首部名称。</li><li><code>&lt;length&gt;</code>：指定记录首部值时所记录的精确长度，超出的部分将会被忽略。</li></ul></blockquote><p>可以捕获的请求首部的个数没有限制，但每个捕获最多只能记录 64 个字符。为了保证同一个 frontend 中日志格式的统一性，首部捕获仅能在 frontend 中定义。</p><p>Examples：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">capture request header Host len </span><span class="token number" style="color:rgb(9, 134, 88)">15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">capture request header X-Forwarded-For len </span><span class="token number" style="color:rgb(9, 134, 88)">15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">capture request header Referer len </span><span class="token number" style="color:rgb(9, 134, 88)">15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">capture response header Content-length len </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">capture response header Location len </span><span class="token number" style="color:rgb(9, 134, 88)">15</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="948maxconn">9.4.8、maxconn<a class="hash-link" href="#948maxconn" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">maxconn </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">conns</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可用于以下配置段：</p><table><thead><tr><th>defaults</th><th>frontend</th><th>listen</th><th>backend</th></tr></thead><tbody><tr><td>yes</td><td></td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="cross" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>no</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="check" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACR0lEQVQ4jZ2RT2sTURTFz3sz00wyzsTWWDRK1IIoU4TiShC1CioI4q5aRa1/QIqiqMV+Dlfid1FbUPQTTMGNbW2nSZTENO00z7nvj4u2oWnsQu/uct/5vXvOBf6xxNiD3Naeb23MxGTJTEyGO4rv3g8NpQ+TkdGzXQAzMVmCZc0bziP17EUXRNy5F4LziPv+a030uHn12vE2YFOMTAZwXYDziMaftCGt22MhGIusXR56CgU4QTCiU7pUv3CRMwAwL1+5RusE2Sxnvg/dbEI3GtCiNahJgnEe8cCHE+Qh4kX8Lle0Jsr0Tb2TbPMX9fS5a5RKWDbLeZCHWm5A/qrDkITl+3DyAcRiDFGpaCPJ65t6LwCAbfVJj8ZdLVXCczlu9+4GlAa0BrSCiGOISnVdPP1B/PUKzts3whB5VKtpkALm5oDZWUApiHJFa0o7xF0AANBEA4yBQ0mACJASkBLM4lynNLD9fQdg7catEAyRlc0BkoBiESjuB6REJp+HZVtRZehkx4nbGSTXb4aMs8jOeXCCAK3yEkS1qjUR3N4+7hX3Ya1cwdrSEtKV1cEDX2dm2hskI6MhYyyyszk4vodWvJ62TskzRF4Sx3rl2yxyhT3IFgqwe5xo4fBACAD2hu9+7tiA0WjFZbR+VLUh6RU+fxQAUD4x5K3GcWLSlDueB8Y5jFL9AGbaFhqXrwxzx5mi5rLWJL29Xz51pB0fPeYapZIe3+eiXj9fWpif3h4oamfODf88ddrtGmzUwqEj7veDpeGd5v9VfwCELBf4vgaL1QAAAABJRU5ErkJggg==" width="16" height="16" class="img_ev3q"></td><td></td><td></td><td></td></tr></tbody></table><p>设定一个前端的最大并发连接数。对于大型站点来说，可以尽可能提高此值以便让 haproxy 管理连接队列，从而避免无法应答用户请求。</p><p>当然，此最大值不能超出 &quot;global&quot; 段中的定义。此外，haproxy 会为每个连接维持两个缓冲，每个缓冲的大小为 16KB，再加上其它的数据，每个连接将大约占用 33KB 的 RAM 空间。这意味着经过适当优化后，有着 1GB 的可用 RAM 空间时将能维护 20000-25000 并发连接。</p><p>如果为指定了一个过大值，极端场景下，其最终占据的空间可能会超出当前主机的可用内存，这可能会带来意想不到的结果；因此，将其设定为一个可接受值方为明智决定。默认为 2000。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="949use_backend">9.4.9、use<!-- -->_<!-- -->backend<a class="hash-link" href="#949use_backend" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># Switch to a specific backend if/unless an ACL-based condition is matched.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">use_backend </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">backend</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">if </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> unless</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">condition</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>定义当满足或不满足什么条件时使用哪个 backend。条件判断是可选的，并且 condition 是基于 acl 的条件。</p><p>可用于以下配置段：</p><table><thead><tr><th>defaults</th><th>frontend</th><th>listen</th><th>backend</th></tr></thead><tbody><tr><td>no</td><td></td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACR0lEQVQ4jZ2RT2sTURTFz3sz00wyzsTWWDRK1IIoU4TiShC1CioI4q5aRa1/QIqiqMV+Dlfid1FbUPQTTMGNbW2nSZTENO00z7nvj4u2oWnsQu/uct/5vXvOBf6xxNiD3Naeb23MxGTJTEyGO4rv3g8NpQ+TkdGzXQAzMVmCZc0bziP17EUXRNy5F4LziPv+a030uHn12vE2YFOMTAZwXYDziMaftCGt22MhGIusXR56CgU4QTCiU7pUv3CRMwAwL1+5RusE2Sxnvg/dbEI3GtCiNahJgnEe8cCHE+Qh4kX8Lle0Jsr0Tb2TbPMX9fS5a5RKWDbLeZCHWm5A/qrDkITl+3DyAcRiDFGpaCPJ65t6LwCAbfVJj8ZdLVXCczlu9+4GlAa0BrSCiGOISnVdPP1B/PUKzts3whB5VKtpkALm5oDZWUApiHJFa0o7xF0AANBEA4yBQ0mACJASkBLM4lynNLD9fQdg7catEAyRlc0BkoBiESjuB6REJp+HZVtRZehkx4nbGSTXb4aMs8jOeXCCAK3yEkS1qjUR3N4+7hX3Ya1cwdrSEtKV1cEDX2dm2hskI6MhYyyyszk4vodWvJ62TskzRF4Sx3rl2yxyhT3IFgqwe5xo4fBACAD2hu9+7tiA0WjFZbR+VLUh6RU+fxQAUD4x5K3GcWLSlDueB8Y5jFL9AGbaFhqXrwxzx5mi5rLWJL29Xz51pB0fPeYapZIe3+eiXj9fWpif3h4oamfODf88ddrtGmzUwqEj7veDpeGd5v9VfwCELBf4vgaL1QAAAABJRU5ErkJggg==" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="cross" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>no</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="check" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACR0lEQVQ4jZ2RT2sTURTFz3sz00wyzsTWWDRK1IIoU4TiShC1CioI4q5aRa1/QIqiqMV+Dlfid1FbUPQTTMGNbW2nSZTENO00z7nvj4u2oWnsQu/uct/5vXvOBf6xxNiD3Naeb23MxGTJTEyGO4rv3g8NpQ+TkdGzXQAzMVmCZc0bziP17EUXRNy5F4LziPv+a030uHn12vE2YFOMTAZwXYDziMaftCGt22MhGIusXR56CgU4QTCiU7pUv3CRMwAwL1+5RusE2Sxnvg/dbEI3GtCiNahJgnEe8cCHE+Qh4kX8Lle0Jsr0Tb2TbPMX9fS5a5RKWDbLeZCHWm5A/qrDkITl+3DyAcRiDFGpaCPJ65t6LwCAbfVJj8ZdLVXCczlu9+4GlAa0BrSCiGOISnVdPP1B/PUKzts3whB5VKtpkALm5oDZWUApiHJFa0o7xF0AANBEA4yBQ0mACJASkBLM4lynNLD9fQdg7catEAyRlc0BkoBiESjuB6REJp+HZVtRZehkx4nbGSTXb4aMs8jOeXCCAK3yEkS1qjUR3N4+7hX3Ya1cwdrSEtKV1cEDX2dm2hskI6MhYyyyszk4vodWvJ62TskzRF4Sx3rl2yxyhT3IFgqwe5xo4fBACAD2hu9+7tiA0WjFZbR+VLUh6RU+fxQAUD4x5K3GcWLSlDueB8Y5jFL9AGbaFhqXrwxzx5mi5rLWJL29Xz51pB0fPeYapZIe3+eiXj9fWpif3h4oamfODf88ddrtGmzUwqEj7veDpeGd5v9VfwCELBf4vgaL1QAAAABJRU5ErkJggg==" width="16" height="16" class="img_ev3q"></td><td></td><td></td><td></td></tr></tbody></table><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9410default_backend">9.4.10、default<!-- -->_<!-- -->backend<a class="hash-link" href="#9410default_backend" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># Specify the backend to use when no &quot;use_backend&quot; rule has been matched.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">default_backend </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">backend</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在没有匹配的 &quot;use<!-- -->_<!-- -->backend&quot; 规则时为实例指定默认后端。在 &quot;frontend&quot; 和 &quot;backend&quot; 之间进行内容交换时，通常使用 &quot;use-backend&quot; 定义匹配规则；而没有被规则匹配到的请求将由此参数指定的后端接收。</p><p>可用于以下配置段：</p><table><thead><tr><th>defaults</th><th>frontend</th><th>listen</th><th>backend</th></tr></thead><tbody><tr><td>yes</td><td></td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="cross" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>no</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="check" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACR0lEQVQ4jZ2RT2sTURTFz3sz00wyzsTWWDRK1IIoU4TiShC1CioI4q5aRa1/QIqiqMV+Dlfid1FbUPQTTMGNbW2nSZTENO00z7nvj4u2oWnsQu/uct/5vXvOBf6xxNiD3Naeb23MxGTJTEyGO4rv3g8NpQ+TkdGzXQAzMVmCZc0bziP17EUXRNy5F4LziPv+a030uHn12vE2YFOMTAZwXYDziMaftCGt22MhGIusXR56CgU4QTCiU7pUv3CRMwAwL1+5RusE2Sxnvg/dbEI3GtCiNahJgnEe8cCHE+Qh4kX8Lle0Jsr0Tb2TbPMX9fS5a5RKWDbLeZCHWm5A/qrDkITl+3DyAcRiDFGpaCPJ65t6LwCAbfVJj8ZdLVXCczlu9+4GlAa0BrSCiGOISnVdPP1B/PUKzts3whB5VKtpkALm5oDZWUApiHJFa0o7xF0AANBEA4yBQ0mACJASkBLM4lynNLD9fQdg7catEAyRlc0BkoBiESjuB6REJp+HZVtRZehkx4nbGSTXb4aMs8jOeXCCAK3yEkS1qjUR3N4+7hX3Ya1cwdrSEtKV1cEDX2dm2hskI6MhYyyyszk4vodWvJ62TskzRF4Sx3rl2yxyhT3IFgqwe5xo4fBACAD2hu9+7tiA0WjFZbR+VLUh6RU+fxQAUD4x5K3GcWLSlDueB8Y5jFL9AGbaFhqXrwxzx5mi5rLWJL29Xz51pB0fPeYapZIe3+eiXj9fWpif3h4oamfODf88ddrtGmzUwqEj7veDpeGd5v9VfwCELBf4vgaL1QAAAABJRU5ErkJggg==" width="16" height="16" class="img_ev3q"></td><td></td><td></td><td></td></tr></tbody></table><p>Arguments：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">backend</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> is the name of the backend to use.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Examples：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">use_backend     dynamic  </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain">  url_dyn</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">use_backend     static   </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain">  url_css url_img extension_img</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">default_backend dynamic</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>已有两组 backend，名称分别为 dynamic 和 static，当不匹配 use<!-- -->_<!-- -->backend 时将默认使用 dynamic 作为转发后端。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9411server-和-default-server">9.4.11、server 和 default-server<a class="hash-link" href="#9411server-和-default-server" title="Direct link to heading">​</a></h3><blockquote><p>server</p></blockquote><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># Declare a server in a backend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">name</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">address</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">:</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">port</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">param*</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可用于以下配置段：</p><table><thead><tr><th>defaults</th><th>frontend</th><th>listen</th><th>backend</th></tr></thead><tbody><tr><td>no</td><td></td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACR0lEQVQ4jZ2RT2sTURTFz3sz00wyzsTWWDRK1IIoU4TiShC1CioI4q5aRa1/QIqiqMV+Dlfid1FbUPQTTMGNbW2nSZTENO00z7nvj4u2oWnsQu/uct/5vXvOBf6xxNiD3Naeb23MxGTJTEyGO4rv3g8NpQ+TkdGzXQAzMVmCZc0bziP17EUXRNy5F4LziPv+a030uHn12vE2YFOMTAZwXYDziMaftCGt22MhGIusXR56CgU4QTCiU7pUv3CRMwAwL1+5RusE2Sxnvg/dbEI3GtCiNahJgnEe8cCHE+Qh4kX8Lle0Jsr0Tb2TbPMX9fS5a5RKWDbLeZCHWm5A/qrDkITl+3DyAcRiDFGpaCPJ65t6LwCAbfVJj8ZdLVXCczlu9+4GlAa0BrSCiGOISnVdPP1B/PUKzts3whB5VKtpkALm5oDZWUApiHJFa0o7xF0AANBEA4yBQ0mACJASkBLM4lynNLD9fQdg7catEAyRlc0BkoBiESjuB6REJp+HZVtRZehkx4nbGSTXb4aMs8jOeXCCAK3yEkS1qjUR3N4+7hX3Ya1cwdrSEtKV1cEDX2dm2hskI6MhYyyyszk4vodWvJ62TskzRF4Sx3rl2yxyhT3IFgqwe5xo4fBACAD2hu9+7tiA0WjFZbR+VLUh6RU+fxQAUD4x5K3GcWLSlDueB8Y5jFL9AGbaFhqXrwxzx5mi5rLWJL29Xz51pB0fPeYapZIe3+eiXj9fWpif3h4oamfODf88ddrtGmzUwqEj7veDpeGd5v9VfwCELBf4vgaL1QAAAABJRU5ErkJggg==" width="16" height="16" class="img_ev3q"></td><td>no</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="cross" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACR0lEQVQ4jZ2RT2sTURTFz3sz00wyzsTWWDRK1IIoU4TiShC1CioI4q5aRa1/QIqiqMV+Dlfid1FbUPQTTMGNbW2nSZTENO00z7nvj4u2oWnsQu/uct/5vXvOBf6xxNiD3Naeb23MxGTJTEyGO4rv3g8NpQ+TkdGzXQAzMVmCZc0bziP17EUXRNy5F4LziPv+a030uHn12vE2YFOMTAZwXYDziMaftCGt22MhGIusXR56CgU4QTCiU7pUv3CRMwAwL1+5RusE2Sxnvg/dbEI3GtCiNahJgnEe8cCHE+Qh4kX8Lle0Jsr0Tb2TbPMX9fS5a5RKWDbLeZCHWm5A/qrDkITl+3DyAcRiDFGpaCPJ65t6LwCAbfVJj8ZdLVXCczlu9+4GlAa0BrSCiGOISnVdPP1B/PUKzts3whB5VKtpkALm5oDZWUApiHJFa0o7xF0AANBEA4yBQ0mACJASkBLM4lynNLD9fQdg7catEAyRlc0BkoBiESjuB6REJp+HZVtRZehkx4nbGSTXb4aMs8jOeXCCAK3yEkS1qjUR3N4+7hX3Ya1cwdrSEtKV1cEDX2dm2hskI6MhYyyyszk4vodWvJ62TskzRF4Sx3rl2yxyhT3IFgqwe5xo4fBACAD2hu9+7tiA0WjFZbR+VLUh6RU+fxQAUD4x5K3GcWLSlDueB8Y5jFL9AGbaFhqXrwxzx5mi5rLWJL29Xz51pB0fPeYapZIe3+eiXj9fWpif3h4oamfODf88ddrtGmzUwqEj7veDpeGd5v9VfwCELBf4vgaL1QAAAABJRU5ErkJggg==" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="check" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td></td><td></td><td></td></tr></tbody></table><p>Examples：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server first  </span><span class="token number" style="color:rgb(9, 134, 88)">10.1</span><span class="token plain">.1.1:1080 cookie first  check inter </span><span class="token number" style="color:rgb(9, 134, 88)">1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server second </span><span class="token number" style="color:rgb(9, 134, 88)">10.1</span><span class="token plain">.1.2:1080 cookie second check inter </span><span class="token number" style="color:rgb(9, 134, 88)">1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server transp ipv4@</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server backup </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">${SRV_BACKUP}</span><span class="token string" style="color:rgb(163, 21, 21)">:1080&quot;</span><span class="token plain"> backup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server www1_dc1 </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">${LAN_DC1}</span><span class="token string" style="color:rgb(163, 21, 21)">.101:80&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">server www1_dc2 </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;</span><span class="token string variable" style="color:rgb(9, 134, 88)">${LAN_DC2}</span><span class="token string" style="color:rgb(163, 21, 21)">.101:80&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>default-server</p></blockquote><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># Change default options for a server in a backend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">default-server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">param*</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可用于以下配置段：</p><table><thead><tr><th>defaults</th><th>frontend</th><th>listen</th><th>backend</th></tr></thead><tbody><tr><td>yes</td><td></td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>no</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="cross" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACR0lEQVQ4jZ2RT2sTURTFz3sz00wyzsTWWDRK1IIoU4TiShC1CioI4q5aRa1/QIqiqMV+Dlfid1FbUPQTTMGNbW2nSZTENO00z7nvj4u2oWnsQu/uct/5vXvOBf6xxNiD3Naeb23MxGTJTEyGO4rv3g8NpQ+TkdGzXQAzMVmCZc0bziP17EUXRNy5F4LziPv+a030uHn12vE2YFOMTAZwXYDziMaftCGt22MhGIusXR56CgU4QTCiU7pUv3CRMwAwL1+5RusE2Sxnvg/dbEI3GtCiNahJgnEe8cCHE+Qh4kX8Lle0Jsr0Tb2TbPMX9fS5a5RKWDbLeZCHWm5A/qrDkITl+3DyAcRiDFGpaCPJ65t6LwCAbfVJj8ZdLVXCczlu9+4GlAa0BrSCiGOISnVdPP1B/PUKzts3whB5VKtpkALm5oDZWUApiHJFa0o7xF0AANBEA4yBQ0mACJASkBLM4lynNLD9fQdg7catEAyRlc0BkoBiESjuB6REJp+HZVtRZehkx4nbGSTXb4aMs8jOeXCCAK3yEkS1qjUR3N4+7hX3Ya1cwdrSEtKV1cEDX2dm2hskI6MhYyyyszk4vodWvJ62TskzRF4Sx3rl2yxyhT3IFgqwe5xo4fBACAD2hu9+7tiA0WjFZbR+VLUh6RU+fxQAUD4x5K3GcWLSlDueB8Y5jFL9AGbaFhqXrwxzx5mi5rLWJL29Xz51pB0fPeYapZIe3+eiXj9fWpif3h4oamfODf88ddrtGmzUwqEj7veDpeGd5v9VfwCELBf4vgaL1QAAAABJRU5ErkJggg==" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="check" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td></td><td></td><td></td></tr></tbody></table><p>Examples：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">default-server inter </span><span class="token number" style="color:rgb(9, 134, 88)">1000</span><span class="token plain"> weight </span><span class="token number" style="color:rgb(9, 134, 88)">13</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面两个指令的简单使用方法如上所述，下面对他们的参数进行重要说明：</p><ul><li><p>格式说明：</p><ul><li><code>&lt;name&gt;</code>：为此服务器指定的内部名称，将出现在日志及警告信息中；</li><li><code>&lt;address&gt;</code>：此服务器的 IPv4 地址，也支持使用可解析的主机名；</li><li><code>[:port]</code>：haproxy 将请求转发至后端服务器的哪个端口，为可选项；未设定时，将使用客户端请求时的同一端口；</li><li><code>[param*]</code>：为此服务器设定的一系列参数；可用的参数非常多，下面是几个常用的参数；</li></ul></li><li><p>服务器或默认服务器参数：</p><ul><li><code>backup</code>：设定为备用服务器，当其它所有后端 server 均不可用时将启用此 server；</li><li><code>disabled</code>：禁用此后端服务器。</li><li><code>check</code>：启动对此 server 执行健康状态检查，但需要配合定义在 backend 的具体检查方法(如 httpcheck，mysql-check)才会进行指定的检查方式，不指定检查方法时将默认以 tcp 方式检查。check 可以借助于额外的参数完成更精细的设定，如：</li><li><code>inter &lt;delay&gt;</code>：设定健康状态检查的时间间隔，单位为毫秒，默认为 2000；</li><li><code>rise &lt;count&gt;</code>：设定 server 从离线状态重新上线需要成功检查的次数；不指定默认为 2，一般可设置为 1。</li><li><code>fall &lt;count&gt;</code>：确认 server 从正常状态转换为不可用状态需要检查的次数；默认为 3。</li><li><code>cookie &lt;value&gt;</code>：为指定 server 设定 cookie 值，指定的值将在请求入站时被检查，第一次为此值挑选的 server 将在后续的请求中被选中，其目的在于实现基于客户端 cookie 的持久连接；</li><li><code>maxconn &lt;maxconn&gt;</code>：指定此后端服务器接受的最大并发连接数(不同于全局设置的 maxconn，全局的 maxconn 是面向客户端的)；如果发往此服务器的连接数高于指定的值，将被放于请求队列以等待其它连接释放；</li><li><code>maxqueue &lt;maxqueue&gt;</code>：设定请求队列的最大长度；</li><li><code>observe &lt;mode&gt;</code>：通过观察服务器的通信状况来判定其健康状态，默认禁用，支持的类型有 &quot;layer4&quot; 和 &quot;layer7&quot;，layer4 表示检查 tcp 连接是否正常，layer7 仅用于 http 代理场景，通过后端 server 发送的 response 来判断，例如可以判断状态码，响应报文头部是否无法解析等；</li><li><code>redir &lt;prefix&gt;</code>：启用重定向功能，将发往此服务器的 GET 和 HEAD 请求均以 302 状态码响应，意味着不会将请求转发至后端服务器；在 prefix 后面不能使用 /，且不能使用相对地址；例如：<code>server srv1 192.168.1.1:80 redir http://image1.mydomain.com check</code></li><li><code>weight &lt;weight&gt;</code>：权重，默认为 1，最大值为 256，0 表示不参与负载均衡，即认为下线了不进行调度；</li></ul></li></ul><p>关于 maxconn 和 maxqueue，这两个值都是此后端服务器的值。它们的大小和全局定义的 maxconn 是有一定大小比较关系的。</p><ul><li>如果没有定义 maxqueue，则全局 maxconn 应该小于或等于后端所有服务器的 maxconn 之和，如果定义了 maxqueue，则需要小于或等于后端所有服务器的 maxconn 和 maxqueue 之和。</li><li>否则 haproxy 接收进来的请求超过后端服务器的压力极限，可能压垮后端。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9412option-httpchk">9.4.12、option httpchk<a class="hash-link" href="#9412option-httpchk" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># Enables HTTP protocol to check on the servers health</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">option httpchk</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">option httpchk </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">uri</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">option httpchk </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">method</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">uri</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">option httpchk </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">method</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">uri</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">version</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可用于以下配置段：</p><table><thead><tr><th>defaults</th><th>frontend</th><th>listen</th><th>backend</th></tr></thead><tbody><tr><td>yes</td><td></td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>no</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="cross" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACR0lEQVQ4jZ2RT2sTURTFz3sz00wyzsTWWDRK1IIoU4TiShC1CioI4q5aRa1/QIqiqMV+Dlfid1FbUPQTTMGNbW2nSZTENO00z7nvj4u2oWnsQu/uct/5vXvOBf6xxNiD3Naeb23MxGTJTEyGO4rv3g8NpQ+TkdGzXQAzMVmCZc0bziP17EUXRNy5F4LziPv+a030uHn12vE2YFOMTAZwXYDziMaftCGt22MhGIusXR56CgU4QTCiU7pUv3CRMwAwL1+5RusE2Sxnvg/dbEI3GtCiNahJgnEe8cCHE+Qh4kX8Lle0Jsr0Tb2TbPMX9fS5a5RKWDbLeZCHWm5A/qrDkITl+3DyAcRiDFGpaCPJ65t6LwCAbfVJj8ZdLVXCczlu9+4GlAa0BrSCiGOISnVdPP1B/PUKzts3whB5VKtpkALm5oDZWUApiHJFa0o7xF0AANBEA4yBQ0mACJASkBLM4lynNLD9fQdg7catEAyRlc0BkoBiESjuB6REJp+HZVtRZehkx4nbGSTXb4aMs8jOeXCCAK3yEkS1qjUR3N4+7hX3Ya1cwdrSEtKV1cEDX2dm2hskI6MhYyyyszk4vodWvJ62TskzRF4Sx3rl2yxyhT3IFgqwe5xo4fBACAD2hu9+7tiA0WjFZbR+VLUh6RU+fxQAUD4x5K3GcWLSlDueB8Y5jFL9AGbaFhqXrwxzx5mi5rLWJL29Xz51pB0fPeYapZIe3+eiXj9fWpif3h4oamfODf88ddrtGmzUwqEj7veDpeGd5v9VfwCELBf4vgaL1QAAAABJRU5ErkJggg==" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="check" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td></td><td></td><td></td></tr></tbody></table><p>此指令表示基于 http 协议来做健康状况检查，只有返回状态码为 2xx 或 3xx 的才认为是健康的，其余所有状态码都认为不健康。不设置该选项时，默认采用 tcp 做健康检查，只要能建立 tcp 就表示健康。</p><ul><li><code>uri</code>：检查的 uri 路径，默认为 &quot;/&quot;。接受带有查询参数的 uri</li><li><code>method</code>：http 检查时使用的 METHOD。不指定时默认为 &quot;OPTIONS&quot; 方法，也建议采用此方法，因为该请求方法对服务器造成的资源损耗最小。</li><li><code>version</code>：检查的 http 协议版本，默认为 http/1.0，但现在很多都采用 HTTP/1.1，因此此处检查版本需要修改为 HTTP/1.1，但对于该版本的 HTTP 协议来说，还强制要求指定 Host，中间使用 <code>\r\n</code> 隔离。</li></ul><p>例如下面的配置，会将健康检查时的页面请求发送至后端 192.168.1.1 的 80 端口来确定该后端是正常的，但客户端的请求将转发至该后端的 443 端口。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">backend https_relay</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    mode tcp</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option httpchk</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option httpchk OPTIONS * HTTP/1.1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">r</span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain">nHost:</span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"> www</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server apache1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.1.1:443 check port </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9413stats-相关">9.4.13、stats 相关<a class="hash-link" href="#9413stats-相关" title="Direct link to heading">​</a></h3><p><code>stats enable</code>：启用基于程序编译时默认设置的统计报告，不能用于 &quot;frontend&quot; 区段。</p><p>只要没有另外的其它设定，默认就会使用如下的配置：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">- stats uri   </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> /haproxy?stats</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">- stats realm </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;HAProxy Statistics&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">- stats auth  </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> no authentication</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">- stats scope </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> no restriction</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>尽管 &quot;stats enable&quot; 一条就能够启用统计报告，但还是建议设定其它所有的参数，以免依赖于默认设定而带来非预期后果。</p><p>例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">backend public_www</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server websrv1 </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.100.11:80</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stats </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stats hide-version</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stats scope   </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stats uri     /haproxyadmin?stats</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stats realm   Haproxy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">\</span><span class="token plain"> Statistics</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stats auth    statsadmin:password</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stats auth    statsmaster:password</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>stats hide-version</code>：启用统计报告并隐藏 HAProxy 版本报告，不能用于 &quot;frontend&quot; 区段。</li><li><code>stats realm</code>：stats auth 身份认证时的提示信息。设置的提示信息中，如果有空白字符，则需要转义。仅在与 &quot;stats auth&quot; 配合使用时有意义。</li><li><code>stats auth</code>：启用带认证的统计报告功能并授权一个用户帐号和对应的密码(明文)。也就是说，想要查看统计报告需要提供身份和密码。不能用于 &quot;frontend&quot; 区段。</li><li><code>stats admin</code>：满足指定条件时启用统计报告页面的管理功能，<strong>它允许通过 web 接口启用或禁用后端服务器</strong>。</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">stats admin </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> unless </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">cond</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下面是两个案例，第一个限制了仅能在本机打开报告页面时启用管理功能，第二个定义了仅允许通过认证的用户使用管理功能。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">backend stats_localhost</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stats </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stats admin </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> LOCALHOST</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">backend stats_auth</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stats </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stats auth  haproxyadmin:password</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stats admin </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> TRUE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9414option-forwardfor">9.4.14、option forwardfor<a class="hash-link" href="#9414option-forwardfor" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">option forwardfor </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> except </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">network</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> header </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">name</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> if-none </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>允许在发往服务器的请求首部中插入 &quot;X-Forwarded-For&quot; 首部。<ul><li><code>except &lt;network&gt;</code>：可选参数，当指定时表示请求中的源地址能匹配此网络时禁用此功能。</li><li><code>header &lt;name&gt;</code>：可选参数，自定义首部名，如 &quot;X-Client&quot; 来替代 &quot;X-Forwarded-For&quot;。有些独特的 web 服务器的确需要一个独特的首部。</li><li><code>if-none</code>：仅在此首部不存在时才将其添加至请求报文首部中。</li></ul></li></ul><p>HAProxy 工作于反向代理模式，其发往服务器的请求中的客户端 IP 均为 HAProxy 主机的地址而非真正客户端的地址，这会使得服务器端的日志信息记录不了真正的请求来源，&quot;X-Forwarded-For&quot; 首部则可用于解决此问题。HAProxy 可以向每个发往服务器的请求上添加此首部，并以客户端 IP 为其 value。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">frontend www</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    mode http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option forwardfor except </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9415error-page">9.4.15、Error Page<a class="hash-link" href="#9415error-page" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="94151errorfile">9.4.15.1、errorfile<a class="hash-link" href="#94151errorfile" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># Return a file contents instead of errors generated by HAProxy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">errorfile </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">code</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">file</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>&lt;code&gt;</code>：指 HTTP 状态码，haproxy 能够产生的状态码有 200、400、401、403、404、405、407、408、410、413、425、429、500、501、502、503 and 504。</li><li><code>&lt;file&gt;</code>：指定用于响应的页面文件；</li></ul><p>可用于以下配置段：</p><table><thead><tr><th>defaults</th><th>frontend</th><th>listen</th><th>backend</th></tr></thead><tbody><tr><td>yes</td><td></td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="cross" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="check" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td></td><td></td><td></td></tr></tbody></table><p>Examples：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">errorfile </span><span class="token number" style="color:rgb(9, 134, 88)">400</span><span class="token plain"> /etc/haproxy/errorfiles/400badreq.http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">errorfile </span><span class="token number" style="color:rgb(9, 134, 88)">408</span><span class="token plain"> /dev/null  </span><span class="token comment" style="color:rgb(0, 128, 0)"># work around Chrome pre-connect bug</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">errorfile </span><span class="token number" style="color:rgb(9, 134, 88)">403</span><span class="token plain"> /etc/haproxy/errorfiles/403forbid.http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">errorfile </span><span class="token number" style="color:rgb(9, 134, 88)">503</span><span class="token plain"> /etc/haproxy/errorfiles/503sorry.http</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="94152errorfiles">9.4.15.2、errorfiles<a class="hash-link" href="#94152errorfiles" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># Import, fully or partially, the error files defined in the &lt;name&gt; http-errors section.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">errorfiles </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">name</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">code</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>&lt;name&gt;</code>：定义 http-errors section 时取的名字。</li><li><code>&lt;code&gt;</code>：HTTP 状态码列表。</li></ul><p>可用于以下配置段：</p><table><thead><tr><th>defaults</th><th>frontend</th><th>listen</th><th>backend</th></tr></thead><tbody><tr><td>yes</td><td></td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="cross" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="yes" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td>yes</td><td></td><td></td></tr><tr><td><img loading="lazy" alt="check" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAB2klEQVQ4jdXQT0gUcRQH8O/uUuvMIrYzOyOa7azsuYMdgqJDSQipddD+gEheisjDQFCXDh0i+3eb7mZ1ys5BpdeITK1WSGfaWd01Cjp1mpyd3/u96dIWZoJ263t78D5fHg/473Lm0QlnYLz3WmNObQeffnjcadVMW00rR4yDWt1/Xn255YJTD/qdVs20i1YBSpOKehQdbelqFomt4JMTfY6ZNeyi1QkGY9H1sLJcQ1QXSrKxNDo90n3h2fC5P/Hg/T7H2JWzC3kLFEt8WHLhl1e4HkbKq+tzYQoARqdGDhHJx7qaHSr2W99KTxZnAGBgvNcxszm707LAYCy5Hip+lUlQ5vWNtyEAJC6+ONsjSU4Ucvn29I405t0Sk6BLQtAeM6tftqwC4ljC9cpY9mtMgjIzY+/CxoWJ80+HmpjiNb1ZQ7vRhmDtOz5//YJUMgXTMBAngY9uA8vMm5u/MQAkAGB4clBlyYHeoqGjbTeYJSIWQAx4no+qvwohSJm99X4d/lXw81kqEwe6piGf7wCxRNmtoFpZBQlSZm+XNuB1BQBw7F63ysSBYeQgSKBW+QQSpMzdWfgr3lAAAIfHDqiSOYjCiEjIzPzdhWgzvGn2X+1S913Zu3Pb8F/yA0u21zwAbszpAAAAAElFTkSuQmCC" width="16" height="16" class="img_ev3q"></td><td></td><td></td><td></td></tr></tbody></table><p>Examples：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">errorfiles generic</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">errorfiles site-1 </span><span class="token number" style="color:rgb(9, 134, 88)">403</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">404</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="94153errorloc-和-errorloc302">9.4.15.3、errorloc 和 errorloc302<a class="hash-link" href="#94153errorloc-和-errorloc302" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 请求错误时，返回一个HTTP重定向至某URL的信息给客户端；可用于所有配置段中。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">errorloc </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">code</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">url</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">errorloc302 </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">code</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">url</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>&lt;code&gt;</code>：指定对 HTTP 的哪些状态码返回指定的页面；这里可用的状态码有 200、400、403、408、500、502、503 和 504；</li><li><code>&lt;url&gt;</code>：Location 首部中指定的页面位置的具体路径，可以是在当前服务器上的页面的相对路径，也可以使用绝对路径；</li><li>这两个关键字都会返回 302 状态吗，这将使得客户端使用同样的 HTTP 方法获取指定的 URL，对于非 GET 方法的场景(如 POST)来说会产生问题，因为返回客户端的 URL 是不允许使用 GET 以外的其它方法的。<ul><li>如果的确有这种问题，可以使用 errorloc303 来返回 303 状态码给客户端。</li></ul></li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="94154errorloc303">9.4.15.4、errorloc303<a class="hash-link" href="#94154errorloc303" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 请求错误时，返回一个HTTP重定向至某URL的信息给客户端；可用于所有配置段中。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">errorloc303 </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">code</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">url</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>&lt;code&gt;</code>：指定对 HTTP 的哪些状态码返回指定的页面；这里可用的状态码有 400、403、408、500、502、503 和 504；</li><li><code>&lt;url&gt;</code>：Location 首部中指定的页面位置的具体路径，可以是在当前服务器上的页面的相对路径，也可以使用绝对路径；需要注意的是，如果 URI 自身错误时产生某特定状态码信息的话，有可能会导致循环定向；</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="94155生产应用">9.4.15.5、生产应用<a class="hash-link" href="#94155生产应用" title="Direct link to heading">​</a></h4><p>在生产环境下，我们常用的做法是创建一个专门放置错误页面的目录 <strong>/etc/haproxy/errors</strong>，然后根据需要在里面定义以 <code>.http</code> 后缀结尾的文件，比如 <strong>/etc/haproxy/errors/404.http</strong>：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">HTTP/1.1 </span><span class="token number" style="color:rgb(9, 134, 88)">404</span><span class="token plain"> Not Found</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Cache-Control: no-cache</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Connection: close</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Content-Type: text/html</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token plain">DOCTYPE html</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">html </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">lang</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;en&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">head</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">meta </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">charset</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;utf-8&quot;</span><span class="token plain"> /</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">title</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token number" style="color:rgb(9, 134, 88)">404</span><span class="token plain"> Not Found</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/title</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/head</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">body</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">main</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token number" style="color:rgb(9, 134, 88)">404</span><span class="token plain"> Not Found</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            This is my custom </span><span class="token number" style="color:rgb(9, 134, 88)">404</span><span class="token plain"> Not Found page</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/main</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/body</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/html</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后打开 haproxy 配置文件 <strong>/etc/haproxy/haproxy.cfg</strong>，添加一个叫 <code>http-errors</code> 的配置段，该配置段有 <code>errorfile</code> 指令指向 xxx.http 的文件。注意，<code>http-errors</code> 配置段是 haproxy v2.2 版本后才开始支持，跟 <code>frontend</code> 和 <code>backend</code> 配置段是同一个级别。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">http-errors myerrors</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    errorfile </span><span class="token number" style="color:rgb(9, 134, 88)">400</span><span class="token plain"> /etc/haproxy/errors/400.http  </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    errorfile </span><span class="token number" style="color:rgb(9, 134, 88)">401</span><span class="token plain"> /etc/haproxy/errors/401.http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    errorfile </span><span class="token number" style="color:rgb(9, 134, 88)">403</span><span class="token plain"> /etc/haproxy/errors/403.http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    errorfile </span><span class="token number" style="color:rgb(9, 134, 88)">404</span><span class="token plain"> /etc/haproxy/errors/404.http</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>默认情况下，haproxy 只是在自己提供服务时遇到问题才返回对应的错误页面，比如：<ul><li>haproxy 不能访问任何后端服务器，将会触发 <em>503 Service Unavailable</em> 错误。</li><li>haproxy 可以访问后端服务器，但是等待回复超时，将会触发 <em>504 Gateway Timeout</em> 错误。</li></ul></li><li>haproxy 支持的状态码：200, 400, 401, 403, 404, 405, 407, 408, 410, 425, 429, 500, 502, 503, and 504.</li></ul><p>一般情况下，默认的错误状态码匹配错误页面就够用户使用，如果想要自定义错误状态码匹配错误页面，需要检查服务器返回的状态码，然后给它一个自定义的匹配错误页面。比如，在 <code>frontend</code> 配置段，替代标准的 404 错误页面。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">http-errors myerrors</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    errorfile </span><span class="token number" style="color:rgb(9, 134, 88)">404</span><span class="token plain"> /etc/haproxy/errors/404.http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">frontend site1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain"> :80</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    default_backend webservers</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    errorfiles myerrors</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http-response </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain"> status </span><span class="token number" style="color:rgb(9, 134, 88)">404</span><span class="token plain"> default-errorfiles </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> status </span><span class="token number" style="color:rgb(9, 134, 88)">404</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>http-response return</code> 指令拦截状态为 404 的响应，并从 myerrors 部分返回一个定制的错误页面，该指令的 <code>default-errorfiles</code> 参数表示要参考 <code>errorfiles</code> 指定的 http-errors 段，从中提取自定义的错误页面。</li></ul><p>然而，有些人通过同一个前端代理多个网站，然后根据接收到的 host header 将请求路由到不同的后端。在这种情况下，可以使用条件语句根据用户访问的网站动态选择不同的 http-errors 部分。比如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">http-errors site1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    errorfile </span><span class="token number" style="color:rgb(9, 134, 88)">404</span><span class="token plain"> /etc/haproxy/errors/site1-404.http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">http-errors site2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    errorfile </span><span class="token number" style="color:rgb(9, 134, 88)">404</span><span class="token plain"> /etc/haproxy/errors/site2-404.http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">frontend allsites</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain"> :80</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    default_backend site1-servers</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    use_backend site2-servers </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> req.hdr</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">host</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> site2.com </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># Store host header in variable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http-request set-var</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">txn.host</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> req.hdr</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">host</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># Use site1 error page if site1.com</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http-response </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain"> status </span><span class="token number" style="color:rgb(9, 134, 88)">404</span><span class="token plain"> errorfiles site1 </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> status </span><span class="token number" style="color:rgb(9, 134, 88)">404</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> var</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">txn.host</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> site1.com </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># Use site2 error page if site2.com</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http-response </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain"> status </span><span class="token number" style="color:rgb(9, 134, 88)">404</span><span class="token plain"> errorfiles site2 </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> status </span><span class="token number" style="color:rgb(9, 134, 88)">404</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> var</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">txn.host</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> site2.com </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>如果网站是 site1.com，则返回 site1 错误页面；如果网站是 site2.com 返回 site2 错误页面。这是通过检查传入 host header(它显示网站的名称)，然后使用 if 语句执行与该名称匹配的 <code>http-response return</code> 行来实现的。</li><li>注意，您需要通过使用 http-request set-var 指令将 host header 存储在一个变量中，否则 HAProxy 在响应阶段将无法访问它。HAProxy 能够通过相同的前端代理多个网站，然后根据条件逻辑选择合适的后端。使用这种技术，您可以将错误页面与请求的站点相匹配。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9416cookie-和-option-redispatch">9.4.16、cookie 和 option redispatch<a class="hash-link" href="#9416cookie-和-option-redispatch" title="Direct link to heading">​</a></h3><p>在 backend 服务器组启用 cookie 功能，以便实现 cookie 绑定。需要同时设置 server 指令中的 cookie 选项。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 后端为静态服务器设置：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">cookie NAME insert nocache</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># PHP做后端时设置：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">cookie SESSION_COOKIE insert indirect nocache</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当客户端绑定 cookie 对应的后端服务器宕机后，应该为此客户端重新调度一个后端 server，否则将打不开页面。这时需要使用 option redispatch，表示当找不到 cookie 对应的服务器时分配新的服务器给客户端。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9417timeout">9.4.17、Timeout<a class="hash-link" href="#9417timeout" title="Direct link to heading">​</a></h3><p>时间单位默认都是毫秒。</p><blockquote><p>timeout http-request</p></blockquote><p>haproxy 等待客户端请求发送完整的超时时长。如果一开始发送了一部分，后续没有再发送，或者后续发送的一直是请求的某一部分，等达到超时时间将断开此连接。这可以防止 DoS 攻击。</p><blockquote><p>timeout queue</p></blockquote><p>当调度的后端服务器已经满负载了，即达到了该 backend 的最大并发连接数时，后续要调度到此 backend 的请求将进入队列等待后端服务器释放可用。该超时时间设置的就是某一请求在队列中的最大等待时长，当达到此时长后将被认为该请求永远无法到达服务端，haproxy 会丢弃该请求并向客户端返回 503 状态码。</p><blockquote><p>timeout connect 和 retries</p></blockquote><p>haproxy 要和后端服务器建立连接时等待超时时间。一般如果 haproxy 和后端服务器处于局域网中，建立连接是瞬间的，所以该值可以设置的小一些。</p><p>retries 表示和服务端建立连接失败时重试连接的次数。</p><p><em>注意：在健康检查时，将取 timeout connect 和 inter 的较小者作为检查时建立 tcp 连接的超时时间。</em></p><blockquote><p>timeout client</p></blockquote><p>客户端和 haproxy 之间非活动连接保持的最大时长，达到此时长 haproxy 将断开和此客户端的连接。非活动表示客户端没有请求报文发送给 haproxy。</p><blockquote><p>timeout server</p></blockquote><p>服务端和 haproxy 之间非活动连接保持的最大时长，达到此时长 haproxy 将断开和此服务器的连接。非活动表示服务端没有响应报文发送给 haproxy。</p><blockquote><p>timeout http-keep-alive</p></blockquote><p>等待出现 http 请求报文出现的最大时长，即和客户端保持长连接的时长。建议设置小一些，以尽快释放连接，例如设置为 2-3 秒钟。</p><p>如果此项未设置，则使用 timeout http-request 值，如果 timeout http-request 也没设置，则使用 timeout client 的值。</p><blockquote><p>timeout check</p></blockquote><p>在和服务端建立连接后，健康状况检查判断的超时时长(意思是，在建立 TCP 连接后，后端节点需要响应消息给 haproxy，响应的消息可能是：</p><ol><li>httpcheck 方式时，经过 hash 计算的 http 页面。</li><li>tcp 检查方式时的回复消息。如果 haproxy 隔了一段时间，都没有接收完这些消息，就认为这次检查不健康。</li></ol><p>因此 timeout check 是 read 回应消息的超时时长。而 min(&quot;timeout connect&quot;,&quot;inter&quot;) 则是建立 tcp 连接的超时时间，它们之和才是一次不健康检查的总时间)。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9418http-协议过滤http-request">9.4.18、http 协议过滤：http-request<a class="hash-link" href="#9418http-协议过滤http-request" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">http-request </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">allow </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> auth </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">realm </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">realm</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> redirect </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">rule</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> deny </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">deny_status </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">status</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">if </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> unless</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">condition</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>做 7 层 http 协议过滤。当 http 协议相关项满足条件时执行一个 action，可以执行的 action 非常多，此处只列出了几项：</p><ul><li><code>allow</code>：表示接受该 http 请求。</li><li><code>auth</code>：表示提示输入用户认证信息，指定 realm 时将给出提示信息。</li><li><code>redirect</code>：重定向功能。</li><li><code>deny</code>：表示拒绝该 http 请求。</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">acl nagios src </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.129.3</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">acl local_net src </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.0.0/16</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">acl auth_ok http_auth</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">L1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">http-request allow </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> nagios</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">http-request allow </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> local_net auth_ok</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">http-request auth realm Gimme </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> local_net auth_ok</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">http-request deny</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9419tcp-请求和响应过滤">9.4.19、tcp 请求和响应过滤<a class="hash-link" href="#9419tcp-请求和响应过滤" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">tcp-request content </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">action</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">if </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> unless</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">condition</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">tcp-response content </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">action</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">if </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> unless</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">condition</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>做 4 层协议过滤。当满足条件时，haproxy 对 tcp 请求或响应报文执行某个 action。</p><p>对于 request 而言，只能用于 listen 和 frontend。常用的 action 是 accept 和 reject，表示满足条件时 haproxy 接受或拒绝该请求报文。</p><p>对于 response 而言，只能用于 listen 和 backend。常用的 action 是 accept、reject 和 close，前两者表示满足条件时接受或拒绝该响应报文，close 表示满足条件时立即关闭和服务端的连接。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="95acl">9.5、ACL<a class="hash-link" href="#95acl" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="951acl-语法">9.5.1、ACL 语法<a class="hash-link" href="#951acl-语法" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">acl </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">aclname</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">criterion</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">flags</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">operator</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">value</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">aclname:        指定acl的名称，在引用时区分大小写。可随意指定，且多个acl指令可以指定同一个aclname，这表示</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;或&quot;</span><span class="token plain">的逻辑关系。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">flags:          可选项，表示标识位。一般会用到的标识位只有</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;-i&quot;</span><span class="token plain">，表示不区分大小写。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">operator:       可选项，某些操作符，有</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;eq&quot;</span><span class="token plain">、</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;ge&quot;</span><span class="token plain">、</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;gt&quot;</span><span class="token plain">、</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;le&quot;</span><span class="token plain">、</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;lt&quot;</span><span class="token plain">，表示数学上的等于、大于、小于。</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">criterion</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">:  指定检查标准，即检查方法。见下文给出的常用4层标准和7层标准</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">value:          根据criterion的不同，值的类型不同。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li><p><strong>4 层常用检查标准</strong>，官方手册：<a href="http://cbonte.github.io/haproxy-dconv/2.4/configuration.html#7.3.3" target="_blank" rel="noopener noreferrer">http://cbonte.github.io/haproxy-dconv/2.4/configuration.html#7.3.3</a></p><ul><li><code>src &lt;ip_addr&gt;</code></li><li><code>src_port &lt;PORT or PORT_ranges&gt;</code></li><li><code>dst &lt;ip_addr&gt;</code></li><li><code>dst_port &lt;PORT or PORT_ranges&gt;</code></li></ul><p>其中 src、src<!-- -->_<!-- -->port、dst 和 dst<!-- -->_<!-- -->port 就是检查标准 creiterion，其后的值就是 value。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">acl accept_clients src </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.100.0/24</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">acl reject_clients src </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.0.0/16</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">tcp-request content accept </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> accept_clients</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">tcp-request content reject </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> reject_clients</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">tcp-request content reject   </span><span class="token comment" style="color:rgb(0, 128, 0)"># 此项表明不匹配前两项的默认都拒绝</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>7 层常用检查标准</strong>，官方手册：<a href="https://cbonte.github.io/haproxy-dconv/1.7/configuration.html#7.3.6" target="_blank" rel="noopener noreferrer">https://cbonte.github.io/haproxy-dconv/1.7/configuration.html#7.3.6</a></p><ul><li><p>hdr(HEADER)：检查首部字段的值是否为指定的值，如：</p><ul><li><code>hdr(Connection) -i close</code> 表示首部字段 Connection 的值是否为不区分大小写的 close。</li><li><code>hdr(Host) -i www.brinnatt.com</code> 表示首部字段 Host 的值是否为 <code>www.brinnatt.com</code>，即请求的主机是否是指定的值。</li></ul></li><li><p>hdr<!-- -->_<!-- -->reg(HEADER)：检查首部字段是否匹配指定的模式，如：</p><ul><li><code>hdr_reg(Host) -i .*\.brinnatt\.com</code></li></ul></li><li><p>http<!-- -->_<!-- -->first<!-- -->_<!-- -->req：当正处理的请求是第一个请求时返回 true。</p></li><li><p>method：请求的方法为指定的方法时返回方法对应的数值，也就表示 true。例如 &quot;method GET&quot;。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">acl valid_method method GET</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">http-request deny </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token plain"> valid_method</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>path：匹配 uri 的 path 部分，一般用来匹配精确的文件资源。例如 <code>path -i /a.png</code>。</p></li><li><p>path<!-- -->_<!-- -->beg：匹配 path 的前缀部分。</p></li><li><p>path<!-- -->_<!-- -->end：匹配 path 的后缀部分。</p></li><li><p>path<!-- -->_<!-- -->reg：使用正则表达式来匹配 path。</p></li><li><p>url：对整个 url 进行匹配。</p></li><li><p>url<!-- -->_<!-- -->beg：对 url 的前缀进行匹配。</p></li></ul><p>还有很多很多检查方法，更多的查询官方手册，太多了。一般 4 层的检查标准和 7 层对路径 path 和首部 hdr 的标准就够了。</p><p><strong>多个条件使用 &quot;AND&quot;、&quot;OR&quot;、&quot;!&quot; 操作符表示逻辑与、逻辑或和取反，不写时默认的操作符是 &quot;AND&quot;。</strong></p></li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="952acl-实现动静分离示例">9.5.2、ACL 实现动静分离示例<a class="hash-link" href="#952acl-实现动静分离示例" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">acl url_static path_beg /static /images /img /css /viedo /download  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定义静态检查标准</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">acl url_static path_end .gif .png .jpg .css .js .bmp                </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定义静态检查标准</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">acl host_www   path /index.html                                     </span><span class="token comment" style="color:rgb(0, 128, 0)"># 为主页专门定制acl</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">acl url_dynamic path_end .php .php5                                 </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定义动态检查标准</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">acl host_www    hdr_beg</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">Host</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> -i www.longshuai.com                  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定位到主页</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">use_backend static  </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> url_static</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">use_backend dynamic </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> url_dynamic</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">use_backend www </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> host_www</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/en/docs/linux-advanced-12"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">第 12 章 Linux haproxy 服务基础配置</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/en/docs/linux-advanced-14"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">第 14 章 Linux haproxy 服务高级配置</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#91配置文件说明" class="table-of-contents__link toc-highlight">9.1、配置文件说明</a></li><li><a href="#92简单配置示例" class="table-of-contents__link toc-highlight">9.2、简单配置示例</a></li><li><a href="#93全局配置参数" class="table-of-contents__link toc-highlight">9.3、全局配置参数</a></li><li><a href="#94proxy-配置段和常用配置选项" class="table-of-contents__link toc-highlight">9.4、proxy 配置段和常用配置选项</a><ul><li><a href="#941http-事务模型相关设置" class="table-of-contents__link toc-highlight">9.4.1、http 事务模型相关设置</a></li><li><a href="#942balance" class="table-of-contents__link toc-highlight">9.4.2、balance</a></li><li><a href="#943hash-type" class="table-of-contents__link toc-highlight">9.4.3、hash-type</a></li><li><a href="#944bind" class="table-of-contents__link toc-highlight">9.4.4、bind</a></li><li><a href="#945mode" class="table-of-contents__link toc-highlight">9.4.5、mode</a></li><li><a href="#946log" class="table-of-contents__link toc-highlight">9.4.6、log</a></li><li><a href="#947capture" class="table-of-contents__link toc-highlight">9.4.7、capture</a></li><li><a href="#948maxconn" class="table-of-contents__link toc-highlight">9.4.8、maxconn</a></li><li><a href="#949use_backend" class="table-of-contents__link toc-highlight">9.4.9、use_backend</a></li><li><a href="#9410default_backend" class="table-of-contents__link toc-highlight">9.4.10、default_backend</a></li><li><a href="#9411server-和-default-server" class="table-of-contents__link toc-highlight">9.4.11、server 和 default-server</a></li><li><a href="#9412option-httpchk" class="table-of-contents__link toc-highlight">9.4.12、option httpchk</a></li><li><a href="#9413stats-相关" class="table-of-contents__link toc-highlight">9.4.13、stats 相关</a></li><li><a href="#9414option-forwardfor" class="table-of-contents__link toc-highlight">9.4.14、option forwardfor</a></li><li><a href="#9415error-page" class="table-of-contents__link toc-highlight">9.4.15、Error Page</a><ul><li><a href="#94151errorfile" class="table-of-contents__link toc-highlight">9.4.15.1、errorfile</a></li><li><a href="#94152errorfiles" class="table-of-contents__link toc-highlight">9.4.15.2、errorfiles</a></li><li><a href="#94153errorloc-和-errorloc302" class="table-of-contents__link toc-highlight">9.4.15.3、errorloc 和 errorloc302</a></li><li><a href="#94154errorloc303" class="table-of-contents__link toc-highlight">9.4.15.4、errorloc303</a></li><li><a href="#94155生产应用" class="table-of-contents__link toc-highlight">9.4.15.5、生产应用</a></li></ul></li><li><a href="#9416cookie-和-option-redispatch" class="table-of-contents__link toc-highlight">9.4.16、cookie 和 option redispatch</a></li><li><a href="#9417timeout" class="table-of-contents__link toc-highlight">9.4.17、Timeout</a></li><li><a href="#9418http-协议过滤http-request" class="table-of-contents__link toc-highlight">9.4.18、http 协议过滤：http-request</a></li><li><a href="#9419tcp-请求和响应过滤" class="table-of-contents__link toc-highlight">9.4.19、tcp 请求和响应过滤</a></li></ul></li><li><a href="#95acl" class="table-of-contents__link toc-highlight">9.5、ACL</a><ul><li><a href="#951acl-语法" class="table-of-contents__link toc-highlight">9.5.1、ACL 语法</a></li><li><a href="#952acl-实现动静分离示例" class="table-of-contents__link toc-highlight">9.5.2、ACL 实现动静分离示例</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Study</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/tags">Tags</a></li><li class="footer__item"><a class="footer__link-item" href="/en/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/en/docs/skill">Notes</a></li><li class="footer__item"><a class="footer__link-item" href="/en/project">Projects</a></li><li class="footer__item"><a class="footer__link-item" href="/en/docs/linux">Linux</a></li></ul></div><div class="col footer__col"><div class="footer__title">Social Media</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/about">About Me</a></li><li class="footer__item"><a href="https://github.com/zqingfa" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://juejin.cn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Juejin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" position="right" href="/en/friends">Friends</a></li><li class="footer__item"><a class="footer__link-item" position="right" href="/en/website">Links</a></li><li class="footer__item"><a href="https://docusaurus.io/zh-CN/" target="_blank"><img style="height:50px;margin-top:0.5rem" src="/img/buildwith.png"><a></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p><a href="http://beian.miit.gov.cn/">闽ICP备2020017848号-2</a></p><p>Copyright © 2020 – PRESENT kuizuo Built with Docusaurus.</p></div></div></div></footer></div>
<script src="/en/assets/js/runtime~main.06ffa367.js"></script>
<script src="/en/assets/js/main.7f2e5564.js"></script>
</body>
</html>