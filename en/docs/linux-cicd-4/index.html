<!doctype html>
<html lang="en-GB" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-linux/cicd/linux-cicd-4">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">第 4 章 Linux Ansible 入门知识 - Linux技术分享</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://zhangqf.com/en/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://zhangqf.com/en/img/logo.png"><meta data-rh="true" property="og:url" content="https://zhangqf.com/en/docs/linux-cicd-4"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="第 4 章 Linux Ansible 入门知识 - Linux技术分享"><meta data-rh="true" name="description" content="4.1、Ansible 简介"><meta data-rh="true" property="og:description" content="4.1、Ansible 简介"><meta data-rh="true" name="keywords" content="linux,ansible"><link data-rh="true" rel="icon" href="/en/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://zhangqf.com/en/docs/linux-cicd-4"><link data-rh="true" rel="alternate" href="https://zhangqf.com/en/docs/linux-cicd-4" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/linux-cicd-4" hreflang="zh"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/linux-cicd-4" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9B0V5WT2X8-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S4SD5NXWXF"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S4SD5NXWXF",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Linux技术分享" href="/en/opensearch.xml">
<link rel="preconnect" href="https://zhangqf.com/">
<script>var _paq=window._paq=window._paq||[];_paq.push(["setRequestMethod","POST"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),_paq.push(["enableHeartBeatTimer"]),function(){var e="https://zhangqf.com/";_paq.push(["setRequestMethod","POST"]),_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]);var a=document,t=a.createElement("script"),p=a.getElementsByTagName("script")[0];t.type="text/javascript",t.async=!0,t.src=e+"matomo.js",p.parentNode.insertBefore(t,p)}()</script>


<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c9a3849aa75f9c4a4e65f846cd1a5155",e.defer=!0;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<meta name="baidu-site-verification" content="code-rqLUw5reVS">
<script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",t.defer=!0;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script>
<link rel="alternate" type="application/rss+xml" href="/en/rss.xml" title="zhangqf RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/atom.xml" title="zhangqf Atom Feed">
<link rel="alternate" type="application/json" href="/en/feed.json" title="zhangqf JSON Feed">

<link rel="icon" href="/en/img/logo.png">
<link rel="manifest" href="/en/manifest.json">
<meta name="theme-color" content="rgb(51 139 255)"><link rel="stylesheet" href="/en/assets/css/styles.86c9ae18.css">
<link rel="preload" href="/en/assets/js/runtime~main.06ffa367.js" as="script">
<link rel="preload" href="/en/assets/js/main.7f2e5564.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><span>更新 <a href="/website">网址导航</a> 带你发现感兴趣的技术</span></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">kuizuo</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/en/docs/linux">Linux</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/en/docs/category/Linux基础">Linux 基础</a></li><li><a class="dropdown__link" href="/en/docs/category/Linux进阶">Linux 进阶</a></li><li><a class="dropdown__link" href="/en/docs/category/Linux测试">Linux 测试</a></li><li><a class="dropdown__link" href="/en/docs/category/LinuxCICD">Linux CICD研发</a></li><li><a class="dropdown__link" href="/en/docs/skill/">Notes</a></li><li><a class="dropdown__link" href="/en/docs/tools/">Recommended Tools</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Blog</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/en/tags">Tags</a></li><li><a class="dropdown__link" href="/en/archive">Archive</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Tools</a><ul class="dropdown__menu"><li><a href="https://api.kuizuo.cn" target="_blank" rel="noopener noreferrer" class="dropdown__link">API Service</a></li><li><a href="https://js-de-obfuscator.vercel.app" target="_blank" rel="noopener noreferrer" class="dropdown__link">JS Deobfuscate</a></li><li><a href="https://cipher.kuizuo.cn" target="_blank" rel="noopener noreferrer" class="dropdown__link">CyberChef Encryption</a></li><li><a href="https://pan.kuizuo.cn" target="_blank" rel="noopener noreferrer" class="dropdown__link">Cloudreve</a></li></ul></div><a class="navbar__item navbar__link" href="/en/website">Links</a><a class="navbar__item navbar__link" href="/en/project">Projects</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/en/"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"><b>kuizuo</b></a><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/linux">linux</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linux基础">Linux基础</a><button aria-label="Toggle the collapsible sidebar category &#x27;Linux基础&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linux进阶">Linux进阶</a><button aria-label="Toggle the collapsible sidebar category &#x27;Linux进阶&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linux测试">Linux测试</a><button aria-label="Toggle the collapsible sidebar category &#x27;Linux测试&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/en/docs/category/linuxcicd">LinuxCICD</a><button aria-label="Toggle the collapsible sidebar category &#x27;LinuxCICD&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-cicd-1">第 1 章 Git 版本控制系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-cicd-2">第 2 章 Maven 代码构建系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux/cicd/第 3 章 Jenkins 自动化系统">第 3 章 Jenkins 自动化系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/en/docs/linux-cicd-4">第 4 章 Linux Ansible 入门知识</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-cicd-5">第 5 章 Linux Ansible 进阶知识</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-cicd-6">第 6 章 DevOps 实践</a></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/en/docs/category/linuxcicd"><span itemprop="name">LinuxCICD</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">第 4 章 Linux Ansible 入门知识</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>第 4 章 Linux Ansible 入门知识</h1></header><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="41ansible-简介">4.1、Ansible 简介<a class="hash-link" href="#41ansible-简介" title="Direct link to heading">​</a></h2><p>Ansible 是一个基于 Python 开发的配置管理和应用部署工具，现在也在自动化管理领域大放异彩。它融合了众多老牌运维工具的优点，Pubbet 和 Saltstack 能实现的功能，Ansible 基本上都可以实现。</p><p>Ansible 能批量配置、部署、管理一大堆的主机。比如以前需要切换到每个主机上执行的一或多个操作，使用Ansible 只需在固定的一台 Ansible 控制节点上去完成所有主机的操作。</p><p>Ansible 是基于模块工作的，它只是提供了一种运行框架，它本身没有完成任务的能力，真正执行操作的是 Ansible 的模块，比如 copy 模块用于拷贝文件到远程主机上，service 模块用于管理服务的启动、停止、重启等。</p><p><img loading="lazy" alt="ansible_arch" src="/en/assets/images/ansible_arch-50bde7498f16765b27d215da774dda9c.jpg" width="713" height="385" class="img_ev3q"></p><p>Ansible 其中一个比较鲜明的特性是 Agentless，即无 Agent 的存在，它就像普通命令一样，并非 C/S 软件，也只需在某个作为控制节点的主机上安装一次 Ansible 即可，通常它基于 ssh 连接来控制远程主机，远程主机上不需要安装 Ansible 或其它额外的服务。</p><p>Ansible 的另一个比较鲜明的特性是它的绝大多数模块都具备幂等性(idempotence)。重复执行某个任务绝大多数时候不会产生任何副作用。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="42ansible-体验">4.2、Ansible 体验<a class="hash-link" href="#42ansible-体验" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="421ansible-环境准备">4.2.1、Ansible 环境准备<a class="hash-link" href="#421ansible-环境准备" title="Direct link to heading">​</a></h3><p>Ansible 的作用是批量控制其它远程主机，并指挥远程主机节点做一些操作、完成一些任务。所以在这个结构中，分为控制节点和被控制节点。Ansible 是 Agentless 的软件，只需在控制节点安装 Ansible，被控制节点一般不需额外安装任何程序。</p><p><em>注意：Ansible 的模块是用 Python 来执行的，且默认远程连接的方式是 ssh，所以控制端和被控制端都需要有 Python 环境，并且被控制端需要启动 sshd 服务，但通常这两个条件在安装 Linux 系统时就已经具备了。所以使用 Ansible 的安装过程只有一个：在控制端安装 Ansible。</em></p><p>在本文中，将配置如下测试环境：包括一个 Ansible 控制节点和 7 个被控制节点。后面的文章中如果没有特别说明，也都使用此处的主机环境。</p><p><em>注意：该 Ansible 环境是基于 x86 架构，与 ARM64 架构使用方式相同。</em></p><table><thead><tr><th>主机</th><th>IP 地址</th><th>主机名</th><th>操作系统</th><th>Ansible 版本</th></tr></thead><tbody><tr><td>controller</td><td>192.168.95.88</td><td>controller</td><td>Centos79</td><td>v2.9.27</td></tr><tr><td>node1</td><td>192.168.95.131</td><td>node1</td><td>Centos79</td><td>无</td></tr><tr><td>node2</td><td>192.168.95.132</td><td>node2</td><td>Centos79</td><td>无</td></tr><tr><td>node3</td><td>192.168.95.133</td><td>node3</td><td>Centos79</td><td>无</td></tr><tr><td>node4</td><td>192.168.95.134</td><td>node4</td><td>Centos79</td><td>无</td></tr><tr><td>node5</td><td>192.168.95.135</td><td>node5</td><td>Centos79</td><td>无</td></tr><tr><td>node6</td><td>192.168.95.136</td><td>node6</td><td>Centos79</td><td>无</td></tr><tr><td>node7</td><td>192.168.95.137</td><td>node7</td><td>Centos79</td><td>无</td></tr></tbody></table><p>所有主机上都已启动 sshd 服务并监听在 22 端口上。因为有时候也会使用主机名去控制目标节点，所以这里也在 controller 节点上配置了其余 7 个节点的 DNS 解析，可在 controller 节点的 /etc/hosts 文件中加入如下内容：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@controller ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat &gt;&gt;/etc/hosts&lt;&lt;EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.131 node1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.132 node2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.133 node3</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.134 node4</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.135 node5</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.136 node6</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.137 node7</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="422安装-ansible">4.2.2、安装 Ansible<a class="hash-link" href="#422安装-ansible" title="Direct link to heading">​</a></h3><p>官方文档：<a href="https://docs.ansible.com/ansible/latest/" target="_blank" rel="noopener noreferrer">https://docs.ansible.com/ansible/latest/</a></p><p>对于 RHEL 系列的系统来说，配置好 epel 镜像即可安装最新版的 Ansible。使用阿里云的 epel 源。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@controller ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@controller ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># yum info ansible</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Loaded plugins: fastestmirror</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Loading mirror speeds from cached hostfile</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> * base: mirrors.aliyun.com</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> * extras: mirrors.njupt.edu.cn</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> * updates: mirrors.aliyun.com</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Available Packages</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Name        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> ansible</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Arch        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> noarch</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Version     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">2.9</span><span class="token plain">.27</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Release     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">.el7</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Size        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">17</span><span class="token plain"> M</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Repo        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> epel/x86_64</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Summary     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> SSH-based configuration management, deployment, and task execution system</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">URL         </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> http://ansible.com</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">License     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> GPLv3+</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> Ansible is a radically simple model-driven configuration management,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> multi-node deployment, and remote task execution system. Ansible works</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> over SSH and does not require any software or daemons to be installed</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> on remote nodes. Extension modules can be written </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> any language and</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> are transferred to managed machines automatically.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后安装即可：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@controller ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># yum install ansible -y</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Ansible 每个版本释放出来之后，都首先提交到 Pypi，所以任何操作系统，都可以使用 pip 工具来安装最新版的 Ansible。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@controller ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># pip3 install ansible</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>注意：python2.x 的环境和 python3.x 的环境是不兼容的，需要注意区分。</li><li>注意：使用各系统的包管理工具(如 yum)安装 Ansible 时会自动提供一些配置文件，如 /etc/ansible/ansible.cfg。而使用 pip 安装的 Ansible 默认不提供配置文件。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="423ansible-命令补全">4.2.3、Ansible 命令补全<a class="hash-link" href="#423ansible-命令补全" title="Direct link to heading">​</a></h3><p>从 Ansible 2.9 版本开始，它支持命令的选项补全功能，它依赖于 python 的 argcomplete 插件。</p><p>安装 argcomplete：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># CentOS/RHEL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">yum -y </span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> python-argcomplete</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 任何系统都可以使用pip工具安装argcomplete</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">pip3 </span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> argcomplete</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>安装完成后，还需激活该插件：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 要求bash版本大于等于4.2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">sudo</span><span class="token plain"> activate-global-python-argcomplete</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 如果bash版本低于4.2，则单独为每个ansible命令注册补全功能</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">eval</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$(</span><span class="token variable" style="color:rgb(9, 134, 88)">register-python-argcomplete ansible</span><span class="token variable" style="color:rgb(9, 134, 88)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">eval</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$(</span><span class="token variable" style="color:rgb(9, 134, 88)">register-python-argcomplete ansible-config</span><span class="token variable" style="color:rgb(9, 134, 88)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">eval</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$(</span><span class="token variable" style="color:rgb(9, 134, 88)">register-python-argcomplete ansible-console</span><span class="token variable" style="color:rgb(9, 134, 88)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">eval</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$(</span><span class="token variable" style="color:rgb(9, 134, 88)">register-python-argcomplete ansible-doc</span><span class="token variable" style="color:rgb(9, 134, 88)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">eval</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$(</span><span class="token variable" style="color:rgb(9, 134, 88)">register-python-argcomplete ansible-galaxy</span><span class="token variable" style="color:rgb(9, 134, 88)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">eval</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$(</span><span class="token variable" style="color:rgb(9, 134, 88)">register-python-argcomplete ansible-inventory</span><span class="token variable" style="color:rgb(9, 134, 88)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">eval</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$(</span><span class="token variable" style="color:rgb(9, 134, 88)">register-python-argcomplete ansible-playbook</span><span class="token variable" style="color:rgb(9, 134, 88)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">eval</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$(</span><span class="token variable" style="color:rgb(9, 134, 88)">register-python-argcomplete ansible-pull</span><span class="token variable" style="color:rgb(9, 134, 88)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">eval</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$(</span><span class="token variable" style="color:rgb(9, 134, 88)">register-python-argcomplete ansible-vault</span><span class="token variable" style="color:rgb(9, 134, 88)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最后，退出当前 Shell 重新进入，或者简单的直接执行如下命令即可：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token builtin class-name" style="color:rgb(38, 127, 153)">exec</span><span class="token plain"> </span><span class="token environment constant" style="color:rgb(129, 31, 63)">$SHELL</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后就可以按 tab 一次或两次补全参数或提示参数。例如，下面选项输入到一半的时候，按一下 tab 键就会补全得到 ansible --syntax-check。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">ansible --syn</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="424配置主机互信">4.2.4、配置主机互信<a class="hash-link" href="#424配置主机互信" title="Direct link to heading">​</a></h3><p>因为 Ansible 默认是基于 ssh 连接的，所以要控制其它节点首先需要建立好 ssh 连接，而建立 ssh 连接要么需要提供密码，要么需要配置好认证方式。为了方便后文的测试，这里先配置好 controller 和其它被控节点之间的主机互信。</p><p>为了避免配置主机互信过程中的交互式询问，这里使用 ssh-keyscan 工具添加主机认证信息以及 sshpass 工具(安装 Ansible 时会自动安装 sshpass，也可以 yum -y install sshpass 安装)直接指定 ssh 连接密码。</p><ol><li>在 controller 节点上生成密钥对</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">ssh-keygen -t rsa -f ~/.ssh/id_rsa -N </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>将各节点的主机信息(host key)写入 controller 的 <code>~/.ssh/known_hosts</code> 文件</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:rgb(9, 134, 88)">host</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token keyword" style="color:rgb(0, 0, 255)">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  ssh-keyscan </span><span class="token variable" style="color:rgb(9, 134, 88)">$host</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;&gt;</span><span class="token plain">~/.ssh/known_hosts </span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">2</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">/dev/null</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>将 controller 上的 ssh 公钥分发给各节点</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># sshpass -p 选项指定的是密码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:rgb(9, 134, 88)">host</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> node</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token keyword" style="color:rgb(0, 0, 255)">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  sshpass -p</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;123456&#x27;</span><span class="token plain"> ssh-copy-id root@</span><span class="token variable" style="color:rgb(9, 134, 88)">$host</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&amp;&gt;</span><span class="token plain">/dev/null</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意：通过上面三步可以完成 controller 到其它 7 个主机的免密认证，但是反过来其它主机到 controller 不是免密认证。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="425ansible-体验">4.2.5、Ansible 体验<a class="hash-link" href="#425ansible-体验" title="Direct link to heading">​</a></h3><p>前面我们提到过，Ansible 的功能之所以强大，是因为 Ansible 提供了成千上万个模块，每个模块都对应一个功能。其中 100 多个核心模块是 Ansible 团队自己维护的，剩余的模块都是 Ansible 社区维护。另外，Ansible 也允许用户自定义模块，解决某些个性化的问题 。</p><p>在控制节点上执行：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@controller ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ansible localhost -m copy -a &#x27;src=/etc/passwd dest=/tmp&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">localhost </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> CHANGED </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;changed&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> true,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;checksum&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;f46e74616780e28c950837c16571665b058c3233&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;dest&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;/tmp/passwd&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;gid&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;group&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;root&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;md5sum&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;388824fe0e2029fba5ef752f0e0fab2c&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;mode&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;0644&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;owner&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;root&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;size&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">798</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;src&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;/root/.ansible/tmp/ansible-tmp-1657750978.04-11732-253772452173510/source&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;state&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;file&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;uid&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>该命令的作用是拷贝本机的 /etc/passwd 文件到本机的 /tmp 目录下。</li><li>其中的 ansible 是一个命令，这个自不需要多做解释。除 ansible 命令外，后面还会用到 ansible-playbook 命令。</li><li>localhost 参数表示 ansible 要控制的节点，即 ansible 将指挥本机执行任务。</li><li>执行任务主要是执行模块，模块的执行还可以依赖一些模块参数。在 ansible 命令行中，使用 -m Module 来指定要执行哪个模块，即执行什么任务，使用 -a ARGS 来指定模块运行时的参数。</li><li>本示例中的模块为 copy 模块，传递给 copy 模块的参数包含两项：<ul><li><code>src=/etc/passwd</code> 指定源文件</li><li><code>dest=/tmp</code> 指定拷贝的目标路径</li></ul></li></ul><p>初学之时，只需学习一些常用的模块，在本文以及后面的文章中会介绍一些常见模块的功能以及用法。熟悉了 Ansible 之后，再按需求到官方手册中去寻找：<a href="https://docs.ansible.com/ansible/latest/modules/modules_by_category.html" target="_blank" rel="noopener noreferrer">https://docs.ansible.com/ansible/latest/modules/modules<!-- -->_<!-- -->by<!-- -->_<!-- -->category.html</a>。</p><p>有时候为了方便快速寻找模块，可以使用 <code>ansible-doc -l | grep &#x27;xxx&#x27;</code> 命令来筛选模块。例如，想要筛选具有拷贝功能的模块：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@controller ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ansible-doc -l | grep &quot;copy&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">vsphere_copy                                                  Copy a </span><span class="token function" style="color:rgb(0, 0, 255)">file</span><span class="token plain"> to a VMware datastore</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">win_copy                                                      Copies files to remote locations on windows ho</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">bigip_file_copy                                               Manage files </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> datastores on a BIG-IP</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ec2_ami_copy                                                  copies AMI between AWS regions, </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">return</span><span class="token plain"> new ima</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">win_robocopy                                                  Synchronizes the contents of two directories u</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">copy                                                          Copy files to remote locations</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">na_ontap_lun_copy                                             NetApp ONTAP copy LUNs</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">icx_copy                                                      Transfer files from or to remote Ruckus ICX </span><span class="token number" style="color:rgb(9, 134, 88)">70</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">unarchive                                                     Unpacks an archive after </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">optionally</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> copying </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ce_file_copy                                                  Copy a </span><span class="token function" style="color:rgb(0, 0, 255)">file</span><span class="token plain"> to a remote cloudengine device ove</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">postgresql_copy                                               Copy data between a file/program and a Postgre</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ec2_snapshot_copy                                             copies an EC2 snapshot and returns the new Sna</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nxos_file_copy                                                Copy a </span><span class="token function" style="color:rgb(0, 0, 255)">file</span><span class="token plain"> to a remote NXOS device</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">netapp_e_volume_copy                                          NetApp E-Series create volume copy pairs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>根据描述，大概找出是否有想要的模块。找到模块后，想要看看它的功能描述以及用法，可以继续使用 ansible-doc 命令。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 详细的模块描述手册</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ansible-doc copy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 只包含模块参数用法的模块描述手册</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ansible-doc -s copy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>再来一个示例，通过 Ansible 删除本地文件 /tmp/passwd。需要使用的模块是 file 模块，file 模块的主要作用是创建或删除文件/目录。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">ansible localhost -m </span><span class="token function" style="color:rgb(0, 0, 255)">file</span><span class="token plain"> -a </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;path=/tmp/passwd state=absent&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>参数 <code>path=</code> 指定要操作的文件路径，<code>state=</code> 参数指定执行何种操作，此处指定为 absent 表示删除操作。</li></ul><p>Ansible 的很多模块都提供了一个 state 参数，它是一个非常重要的参数。它的值一般都会包含 present 和 absent 两种状态值(并非一定)，不同模块的 present 和 absent 状态表示的含义不同，但通常来说，present 状态表示肯定、存在、会、成功等含义，absent 则相反，表示否定、不存在、不会、失败等含义。</p><p>例如这里的 file 模块，absent 状态表示递归删除文件 <code>/</code> 目录，类似于 <code>rm -r</code> 命令，touch 状态和 touch 命令的功能一样，directory 状态表示递归创建目录，类似于 <code>mkdir -p</code> 命令。</p><p>所以，在本地创建文件、创建目录的命令如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 创建文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ansible localhost -m </span><span class="token function" style="color:rgb(0, 0, 255)">file</span><span class="token plain"> -a </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;path=/tmp/a.log state=touch&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 创建目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ansible localhost -m </span><span class="token function" style="color:rgb(0, 0, 255)">file</span><span class="token plain"> -a </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;path=/tmp/dir1/dir2 state=directory&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>再说一个 debug 模块，顾名思义，用于输出或调试一些数据。debug 模块的用法非常简单，就两个常用参数：msg 参数和 var 参数。这两个参数是互斥的，所以只能使用其中一个。msg 参数可以输出字符串，也可以输出变量的值；var 参数只能输出变量的值。</p><p>例如，输出 ”hello world”，需要使用 msg 参数：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@controller ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ansible localhost -m debug -a &#x27;msg=&quot;hello world&quot;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">localhost </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> SUCCESS </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;msg&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;hello world&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Ansible 中也支持使用变量，这里仅演示最简单的设置变量和引用变量的方式。ansible 命令的 <code>-e</code> 选项或 <code>--extra-vars</code> 选项可以设置变量，设置的方式为 <code>-e &#x27;var1=&quot;aaa&quot; var2=&quot;bbb&quot;&#x27;</code>。</p><p>例如，设置变量后使用 debug 的 msg 参数输出：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@controller ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ansible localhost -e &#x27;str=world&#x27; -m debug -a &#x27;msg=&quot;hello {{str}}&quot;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">localhost </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> SUCCESS </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;msg&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;hello world&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>注意上面示例中的 <code>msg=&quot;hello {{str}}&quot;</code>，Ansible 的字符串是可以<strong>不用引号</strong>去包围的，例如 <code>msg=hello</code> 是允许的，但如果字符串中包含了特殊符号，则可能需要使用引号去包围，例如此处的示例出现了会产生歧义的空格。</li><li>此外，要区分变量名和普通的字符串，需要在变量名上加一点标注：用 <code>{}</code> 包围 Ansible 的变量，这其实是 Jinja2 模板的语法。其实不难理解，它的用法和 Shell 下引用变量使用 <code>$</code> 符号或 <code>${}</code> 是一样的，例如 <code>echo &quot;hello ${var}&quot;</code>。</li></ul><p>debug 模块除了 msg 参数，还有一个 var 参数，它只能用来输出变量(还包括以后要介绍的 Jinja2 表达式)，而且 var 参数引用变量的时候，不能使用 <code>{}</code> 包围，因为 var 参数已经隐式地包围了一层 <code>{}</code>。例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@controller ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ansible localhost -e &#x27;str=&quot;hello world&quot;&#x27; -m debug -a &#x27;var=str&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">localhost </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> SUCCESS </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;str&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;hello world&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="43ansible-配置文件">4.3、Ansible 配置文件<a class="hash-link" href="#43ansible-配置文件" title="Direct link to heading">​</a></h2><p>通过操作系统自带的包管理器(比如 yum、dnf、apt)安装的 Ansible 一般都会提供好 Ansible 的配置文件 /etc/ansible/ansible.cfg。</p><p>这是 Ansible 默认的全局配置文件。实际上，Ansible 支持 4 种方式指定配置文件，它们的解析顺序从上到下：</p><ul><li><code>ANSIBLE_CFG</code>：环境变量指定的配置文件。</li><li><code>ansible.cfg</code>：当前目录下的 ansible.cfg。</li><li><code>~/.ansible.cfg</code>：家目录下的 ansible.cfg。</li><li><code>/etc/ansible/ansible.cfg</code>：默认的全局配置文件。</li></ul><p>Ansible 配置文件采用 ini 风格进行配置，每一项配置都使用 key=value 的方式进行配置。</p><p>例如，下面是我从默认的 /etc/ansible/ansible.cfg 中截取的 <!-- -->[<!-- -->defaults<!-- -->]<!-- --> 段落和 <!-- -->[<!-- -->inventory<!-- -->]<!-- --> 段落的部分配置信息。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">defaults</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># some basic default values...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#inventory      = /etc/ansible/hosts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#library        = /usr/share/my_modules/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#module_utils   = /usr/share/my_module_utils/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#remote_tmp     = ~/.ansible/tmp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#local_tmp      = ~/.ansible/tmp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#plugin_filters_cfg = /etc/ansible/plugin_filters.yml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#forks          = 5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">inventory</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#enable_plugins = host_list, virtualbox, yaml, constructed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#ignore_extensions = .pyc, .pyo, .swp, .bak, ~, .rpm, .md, .txt, ~, .orig, .ini, .cfg, .retry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#ignore_patterns=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#unparsed_is_failed=False</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="44inventory">4.4、Inventory<a class="hash-link" href="#44inventory" title="Direct link to heading">​</a></h2><p>让 Ansible 发挥强大作用的第一步是配置 inventory。inventory 表示清单的意思，在计算机领域里往往表示的资源清单，在 Ansible 中它表示主机节点清单，也是资源的一种。通过配置 inventory，就可以定义哪些目标主机是可以被控制的。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="441inventory-文件路径">4.4.1、Inventory 文件路径<a class="hash-link" href="#441inventory-文件路径" title="Direct link to heading">​</a></h3><p>默认的 inventory 文件是 /etc/ansible/hosts，可以通过 Ansible 配置文件的 inventory 配置指令去修改路径。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;/etc/ansible/hosts&#x27;</span><span class="token plain"> /etc/ansible/ansible.cfg </span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#inventory      = /etc/ansible/hosts</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>但通常不会去修改这个配置项，如果在其它地方定义了 inventory 文件，可以直接在 ansible 的命令行中使用 -i 选项去指定自定义的 inventory 文件。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">ansible -i /tmp/myinv.ini </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ansible-playbook -i /tmp/myinv.ini </span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="442配置-inventory">4.4.2、配置 Inventory<a class="hash-link" href="#442配置-inventory" title="Direct link to heading">​</a></h3><p>Ansible inventory 文件的书写格式遵循 ini 配置格式。从 Ansible 2.4 开始支持其它格式，比如 yaml 格式的 inventory。此处以 ini 格式为例，循序渐进地介绍 inventory 的规则。假设所有的规则都定义在 /etc/ansible/hosts 文件中。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4421一行一主机的定义方式">4.4.2.1、一行一主机的定义方式<a class="hash-link" href="#4421一行一主机的定义方式" title="Direct link to heading">​</a></h4><p>Ansible 默认是基于 ssh 连接的，所以一般情况下 inventory 中的每个目标节点都配置主机名或 IP 地址、sshd 监听的端口号、连接的用户名和密码、ssh 连接时的参数等等。当然，很多参数有默认值，所以最简单的是直接指定主机名或 IP 地址即可。</p><p>例如，在默认的 inventory 文件 /etc/ansible/hosts 添加几个目标主机：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">node1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">node2 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ansible_host</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.132</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.133</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.134:22</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.13</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">:6</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ansible_port</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">22</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>第一行通过主机名定义，在 ansible 连接该节点时会进行主机名 DNS 解析。</li><li>第二行也是通过主机名定义，但是使用了一个主机变量 ansible<!-- -->_<!-- -->host=IP，此时该 ansible 去连接该主机时将直接通过 IP 地址进行连接，而不会进行 DNS 解析，此时 node2 相当于主机别名并且可以命名为任何其它名称。</li><li>第三行通过 IP 地址定义主机节点。</li><li>第四行通过 IP 地址和端口号定义主机节点。</li><li>最后一行通过范围的方式展开成了两个主机节点 192.168.95.135 和 192.168.95.136，同时还定义了这两个节点的主机变量 ansible<!-- -->_<!-- -->port=22 表示连接这两个主机时的端口号为 22。</li></ul><p>范围展开的方式还支持字母范围。下面都是有效的：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">范围表示      展开结果</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--------------------</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">a</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">:3</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">  --</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">  a1,a2,a3</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">08:12</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> --</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">  08,09,10,11,12</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">a</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">a:c</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">  --</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">  aa,ab,ac</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面示例中使用了两个主机变量 ansible<!-- -->_<!-- -->port 和 ansible<!-- -->_<!-- -->host，它们直接定义在主机的后面，这些变量都是连接目标主机时的行为控制变量，通常它们都能见名知意。Ansible 支持很多个连接时的行为控制变量，而且不同版本的 Ansible 的行为控制变量名称可能还不同，比如在以前版本中指定端口号的行为变量是 ansible<!-- -->_<!-- -->ssh<!-- -->_<!-- -->port。</p><p>完整的连接行为控制变量参见<a href="https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html#connecting-to-hosts-behavioral-inventory-parameters" target="_blank" rel="noopener noreferrer">官方手册</a>。</p><p>这样定义之后，Ansible 就可以控制任何一个目标主机了：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">ansible node1 -m copy -a </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;src=/etc/passwd dest=/tmp&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ansible </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.133 -m copy -a </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;src=/etc/passwd dest=/tmp&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4422inventory-中的普通变量">4.4.2.2、Inventory 中的普通变量<a class="hash-link" href="#4422inventory-中的普通变量" title="Direct link to heading">​</a></h4><p>在定义 inventory 时，除了可以指定连接的行为控制变量，也可以指定 Ansible 的普通变量，以便在 ansible 执行任务时使用。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">node1 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">node1_var</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;hello world&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">node2 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ansible_host</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.132</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 ansible 执行任务时可以引用普通变量：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">$ ansible node1 -m debug -a </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;var=node1_var&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">node1 </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> SUCCESS </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;node1_var&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;hello world&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4423主机分组">4.4.2.3、主机分组<a class="hash-link" href="#4423主机分组" title="Direct link to heading">​</a></h4><p>上面的示例中是每行单独定义一个主机，这样的方式虽然简单，但是极其不方便管理多个节点。为此，Inventory 支持对主机进行分组，每个组内可以定义多个主机，每个主机都可以定义在任何一个或多个主机组内。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">node1 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">node1_var</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;hello world&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">node2 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ansible_host</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.132</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.133</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.134:22</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.13</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">:6</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ansible_port</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nginx</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.131</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.132 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ansible_password</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;123456&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.133</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">apache</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.13</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain">:7</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">mysql</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.131</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.132</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>这里定义了 3 个主机组：nginx 主机组、apache 主机组和 mysql 主机组。nginx 组包含 3 个节点，apache 主机组包含 4 个节点，mysql 主机组包含 2 个节点。</li><li>Ansible 默认预定义了两个主机组：all 分组和 ungrouped 分组。<ul><li><code>all</code> 分组中包含所有分组内的节点</li><li><code>ungrouped</code> 分组包含所有不在分组内的节点</li><li>这两个分组都不包含 localhost 这个特殊的节点</li></ul></li></ul><p>需要注意的是，mysql 组中的节点也同时存在于 nginx 组内，一个主机同时存在于多个组内是允许也是必要的功能，只有这样才能更为灵活的对各个节点进行分类管理。</p><p>有了主机组，就可以让 ansible 控制一个组，从而让该组内所有主机执行任务：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">ansible apache -m copy -a </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;src=/etc/passwd dest=/tmp&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>定义了 inventory 之后，可以使用 ansible --list 或 ansible--playbook --list 命令来查看主机组的信息，还可以使用更为专业的 ansible-inventory 命令来查看主机组信息。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 使用ansible或ansible-playbook列出所有主机</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@controller ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ansible -i /etc/ansible/hosts nginx --list</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  hosts </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.131</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.132</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.133</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 使用ansible-inventory列出nginx组中的主机</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@controller ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ansible-inventory -i /etc/ansible/hosts nginx --graph</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">@nginx:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--192.168.95.131</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--192.168.95.132</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--192.168.95.133</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 使用ansible-inventory列出nginx组中的主机，同时带上变量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@controller ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ansible-inventory nginx --graph --vars</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">@nginx:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--192.168.95.131</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--192.168.95.132</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">ansible_password </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">123456</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--192.168.95.133</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 使用ansible-inventory列出all组内的主机</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@controller ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ansible-inventory --graph all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">@all:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--@apache:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--192.168.95.134</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--192.168.95.135</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--192.168.95.136</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--192.168.95.137</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--@mysql:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--192.168.95.131</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--192.168.95.132</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--@nginx:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--192.168.95.131</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--192.168.95.132</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--192.168.95.133</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--@ungrouped:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--node1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">--node2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 使用ansible-inventory以json格式列出所有主机的信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@controller ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ansible-inventory --list</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4424主机组变量">4.4.2.4、主机组变量<a class="hash-link" href="#4424主机组变量" title="Direct link to heading">​</a></h4><p>有了主机组之后，可以直接为主机组定义变量，这样组内的所有主机都具有该变量。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nginx</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.131</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.132 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ansible_password</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;123456&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.133</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nginx:vars</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ansible_password</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;123456&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">all:vars</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ansible_port</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">22</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">ungrouped:vars</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ansible_port</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">22</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>上面 <code>[nginx:vars]</code> 表示为 nginx 组内所有主机定义变量 <code>ansible_password=&#x27;123456&#x27;</code>。而 <code>[all:vars]</code> 和 <code>[ungrouped:vars]</code> 分别表示为 all 和 ungrouped 这两个特殊的主机组内的所有主机定义变量。</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4425组嵌套">4.4.2.5、组嵌套<a class="hash-link" href="#4425组嵌套" title="Direct link to heading">​</a></h4><p>Inventory 还支持主机组的分组嵌套，可以通过 <code>[GROUP:children]</code> 的方式定义一个主机组，并在其中包含子组。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nginx</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.131</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.132 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ansible_password</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;123456&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.133</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">apache</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.13</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain">:7</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">mysql</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.131</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.132</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">webservers:children</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">apache</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">centos7:children</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">webservers  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 递归嵌套</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">mysql</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4426multi-inventory-文件">4.4.2.6、Multi Inventory 文件<a class="hash-link" href="#4426multi-inventory-文件" title="Direct link to heading">​</a></h4><p>当 Ansible 要管理的节点非常多时，仅靠分组的逻辑可能也不足够方便管理，这个时候可以定义多个 inventory 文件并放在一个目录下，并按一定的命名规则为每个 inventory 命名，以便见名知意。</p><p>例如，创建一个名为 /etc/ansible/inventorys 的目录，在其中定义 web 和 database 两个 inventory 文件：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">/etc/ansible/inventorys/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">├── web</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">└── database</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>内容分别如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># /etc/ansible/inventorys/web的内容：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nginx</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.131</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.132 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ansible_password</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;123456&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.133</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">apache</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.13</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain">:7</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">web:children</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">apache</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># /etc/ansible/inventorys/database的内容：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">mysql</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.131</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.132</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>现在要使用多个 inventory 的功能，需要将 inventory 指定为目录路径。</p><p>例如，Ansible 配置文件将 inventory 指令设置为对应的目录：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">inventory      </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> /etc/ansible/inventorys</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>或者，ansible 或 ansible-playbook 命令使用 -i INVENTORY 选项指定的路径应当为目录。</p><p>执行下面的命令将列出所有主机：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">ansible-inventory -i /etc/ansible/inventorys --graph all</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>inventory 指定为目录时，inventory 文件最好不要带有后缀，就像示例中的 web 和 database 文件。因为 Ansible 当使用目录作为 inventory 时，默认将忽略一些后缀的文件，不去解析。需要修改配置文件中的 inventory<!-- -->_<!-- -->ignore<!-- -->_<!-- -->extensions 项来禁止忽略指定后缀(如 ini 后缀)的文件。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)">#inventory_ignore_extensions = ~, .orig, .bak, .ini, .cfg, .retry, .pyc, .pyo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">inventory_ignore_extensions </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> ~, .orig, .bak, .cfg, .retry, .pyc, .pyo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="443实验-inventory-文件">4.4.3、实验 Inventory 文件<a class="hash-link" href="#443实验-inventory-文件" title="Direct link to heading">​</a></h3><p>下面是本文使用的 inventory 文件 /etc/ansible/hosts 的内容，在后面的文章中如果没有特别说明，也将使用此处的 inventory 配置。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nginx</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.131</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.132</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.133</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">apache</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.13</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain">:7</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">webservers:children</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">apache</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">mysql</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.137</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="45playbook">4.5、Playbook<a class="hash-link" href="#45playbook" title="Direct link to heading">​</a></h2><p>ansible 命令每次只能执行一个任务，这种运行方式称为 Ad-hoc(点对点模式)；ansible playbook 可以集成多个任务，编排好任务的执行顺序，像电影剧本一样一直演下去直到杀青。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="451playbookplay-和-task-的关系">4.5.1、playbook、play 和 task 的关系<a class="hash-link" href="#451playbookplay-和-task-的关系" title="Direct link to heading">​</a></h3><p>playbook 相当于一整套电视剧剧本，play 相当于一集片段，tasks 相当于一集片段当中的某一节剧情。</p><ol><li>playbook 中可以定义一个或多个 play。</li><li>每个 play 中可以定义一个或多个 task。<ul><li>其中还可以定义两类特殊的 task：pre<!-- -->_<!-- -->tasks 和 post<!-- -->_<!-- -->tasks。<ul><li>pre<!-- -->_<!-- -->tasks 表示执行执行普通任务之前执行的任务列表。</li><li>post<!-- -->_<!-- -->tasks 表示普通任务执行完之后执行的任务列表。</li></ul></li></ul></li><li>每个 play 都需要通过 hosts 指令指定要执行该 play 的目标主机。</li><li>每个 play 都可以设置一些该 play 的环境控制行为，比如定义 play 级别的变量。</li></ol><p>例如，下面是一个 playbook 示例，文件名为 first.yml，内容如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">---</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">- name: play </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  hosts: nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  gather_facts: </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  tasks: </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    - name: task1 </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> play1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      debug: </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        msg: </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;output task1 in play1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    - name: task2 </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> play1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      debug: </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        msg: </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;output task2 in play1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">- name: play </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  hosts: apache</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  gather_facts: </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  tasks: </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    - name: task1 </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> play2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      debug: </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        msg: </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;output task1 in play2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    - name: task2 </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> play2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      debug: </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        msg: </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;output task2 in play2&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>playbook 中包含两个 play：”play 1” 和 ”play 2”，每个 play 中又包含了两个 task。且执行 ”play 1” 的是 nginx 主机组中的主机节点，执行 ”play 2” 的是 apache 主机组中的主机节点。</li></ul><p>使用 ansible-playbook 命令执行这个 playbook：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@controller ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ansible-playbook first.yml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">PLAY </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">play </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> ***************************************************************************************************</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">TASK </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">task1 </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> play1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> *******************************************************************************************</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ok: </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.131</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;msg&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;output task1 in play1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ok: </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.132</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;msg&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;output task1 in play1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">ok: </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.133</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;msg&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;output task1 in play1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">PLAY RECAP ******************************************************************************************************</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.131             </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ok</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">changed</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">unreachable</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">failed</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">skipped</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">rescued</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ignored</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.132             </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ok</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">changed</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">unreachable</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">failed</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">skipped</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">rescued</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ignored</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.133             </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ok</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">changed</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">unreachable</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">failed</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">skipped</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">rescued</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ignored</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.134             </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ok</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">changed</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">unreachable</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">failed</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">skipped</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">rescued</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ignored</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.135             </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ok</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">changed</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">unreachable</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">failed</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">skipped</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">rescued</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ignored</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.136             </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ok</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">changed</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">unreachable</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">failed</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">skipped</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">rescued</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ignored</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.95.137             </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ok</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">changed</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">unreachable</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">failed</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">skipped</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">rescued</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ignored</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>对照输出结果和 first.yml 中的定义，可以很容易对应上执行的流程。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="452yaml-语法">4.5.2、YAML 语法<a class="hash-link" href="#452yaml-语法" title="Direct link to heading">​</a></h3><p>ansible 的 playbook 采用 yaml 语法，它以非常简洁的方式实现了 json 格式的事件描述。yaml 之于 json 就像 markdown 之于 html 一样，极度简化了 json 的书写。</p><p>YAML 文件后缀通常为 <code>.yaml</code> 或 <code>.yml</code>。</p><p>YAML 在不少工具里都使用，学习它是”一次学习、终生受益”的，所以很有必要把 yaml 的语法格式做个梳理，系统性地去学一学。</p><p>YAML 的基本语法规则如下：</p><ul><li>使用缩进表示层级关系。</li><li>缩进时不允许使用 Tab 键，只允许使用空格。</li><li>缩进的空格数目不重要，只要相同层级的元素左对齐即可。</li><li>yaml 文件以 &quot;---&quot; 作为文档的开始，以表明这是一个 yaml 文件。当然 &quot;---&quot; 可以省略。</li><li><code>#</code> 表示注释，从这个字符开始到结尾，都会被解析器忽略。</li><li>字符串不用加引号，但在可能产生歧义时，加引号(单双引号都可以)。</li><li>布尔值非常灵活，不区分大小写的 true/false、yes/no、on/off、y/n、0 和 1 都允许。</li></ul><p>YAML 支持三种数据结构：</p><ul><li>对象：key/value 格式，也称为哈希结构、字典结构或关联数组。</li><li>数组：也称为列表。</li><li>标量(scalars)：单个值。</li></ul><p>可以去找一些在线 YAML 转换 JSON 网站，比如<a href="http://yaml-online-parser.appspot.com%EF%BC%8C%E9%80%9A%E8%BF%87%E5%9C%A8%E7%BA%BF%E8%BD%AC%E6%8D%A2%E5%8F%AF%E4%BB%A5%E9%AA%8C%E8%AF%81%E6%88%96%E6%9F%A5%E7%9C%8B%E8%87%AA%E5%B7%B1%E6%89%80%E5%86%99%E7%9A%84" target="_blank" rel="noopener noreferrer">http://yaml-online-parser.appspot.com，通过在线转换可以验证或查看自己所写的</a> YAML 是否出错以及哪里出错。也可以安装 yq(yaml query) 命令将 yaml 数据转换成 json 格式数据。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">yum -y </span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> jq</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">pip3 </span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> yq</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">cat</span><span class="token plain"> a.yml </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> yq </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4521对象">4.5.2.1、对象<a class="hash-link" href="#4521对象" title="Direct link to heading">​</a></h4><p>一组键值对，使用冒号隔开 key 和 value。注意，冒号后必须至少一个空格。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> junmajinlong</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>等价于 json：</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;junmajinlong&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4522数组">4.5.2.2、数组<a class="hash-link" href="#4522数组" title="Direct link to heading">​</a></h4><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> Shell</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> Perl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> Python</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>等价于 json：</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Shell&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Perl&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Python&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>也可以使用行内数组(内联语法)的写法：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Shell&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Perl&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Python&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>再例如：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">lang1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Shell</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">lang2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Perl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">lang3</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> Python</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>等价于 json：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;lang1&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Shell&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain">, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;lang2&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Perl&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain">, </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;lang3&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Python&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>将对象和数组混合：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">languages</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> Shell</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> Perl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> Python</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>等价于 json：</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token property">&quot;languages&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Shell&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Perl&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Python&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4523字典">4.5.2.3、字典<a class="hash-link" href="#4523字典" title="Direct link to heading">​</a></h4><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">person1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> junmajinlong</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">age</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">18</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">gender</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> male</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">person2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> xiaofanggao</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">age</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">19</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">gender</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> female</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>等价于 json：</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token property">&quot;person2&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token property">&quot;gender&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;female&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token property">&quot;age&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">19</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;xiaofanggao&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token property">&quot;person1&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token property">&quot;gender&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;male&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token property">&quot;age&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">18</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;junmajinlong&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>也可以使用行内对象的写法：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">---</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">person1: </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">name: junmajinlong, age: </span><span class="token number" style="color:rgb(9, 134, 88)">18</span><span class="token plain">, gender: male</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4524复合结构">4.5.2.4、复合结构<a class="hash-link" href="#4524复合结构" title="Direct link to heading">​</a></h4><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">person1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> junmajinlong</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">age</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">18</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">langs</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> Perl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> Ruby</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> Shell</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">person2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> xiaofanggao</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">age</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">19</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">langs</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> Python</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> Javascript</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>等价于 json：</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token property">&quot;langs&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Perl&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Ruby&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Shell&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token property">&quot;person1&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token null keyword" style="color:rgb(0, 0, 255)">null</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token property">&quot;age&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">18</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;junmajinlong&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token property">&quot;person2&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token null keyword" style="color:rgb(0, 0, 255)">null</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token property">&quot;age&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">19</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token property">&quot;langs&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Python&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Javascript&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token property">&quot;name&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;xiaofanggao&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4525字符串续行">4.5.2.5、字符串续行<a class="hash-link" href="#4525字符串续行" title="Direct link to heading">​</a></h4><p>字符串可以写成多行，从第二行开始，必须至少有一个单空格缩进。换行符会被转为空格。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">str</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> hello</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  world</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  hello world</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>等价于 json：</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token property">&quot;str&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;hello world hello world&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>也可以使用 <code>&gt;</code> 换行，它类似于上面的多层缩进写法。此外，还可以使用 <code>|</code> 在换行时保留换行符。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">this</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">|</span><span class="token scalar string" style="color:rgb(163, 21, 21)"></span><br></span><span class="token-line" style="color:#000000"><span class="token scalar string" style="color:rgb(163, 21, 21)">  Foo</span><br></span><span class="token-line" style="color:#000000"><span class="token scalar string" style="color:rgb(163, 21, 21)">  Bar</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token key atrule">that</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token scalar string" style="color:rgb(163, 21, 21)"></span><br></span><span class="token-line" style="color:#000000"><span class="token scalar string" style="color:rgb(163, 21, 21)">  Foo</span><br></span><span class="token-line" style="color:#000000"><span class="token scalar string" style="color:rgb(163, 21, 21)">  Bar</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>等价于 json：</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">&#x27;that&#x27;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> &#x27;Foo Bar&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> &#x27;this&#x27;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> &#x27;Foo\nBar\n&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4526空值">4.5.2.6、空值<a class="hash-link" href="#4526空值" title="Direct link to heading">​</a></h4><p>YAML 中某个 key 有时候不想为其赋值，可以直接写 key 但不写 value，另一种方式是直接写 null，还有一种比较少为人知的方式：波浪号 <code>~</code>。</p><p>例如，下面几种方式全是等价的：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">key1: </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">key2: null</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">key3: Null</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">key4: NULL</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">key5: ~</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4527单双引号和转义">4.5.2.7、单双引号和转义<a class="hash-link" href="#4527单双引号和转义" title="Direct link to heading">​</a></h4><p>YAML 中的字符串是可以不用使用引号包围的，但是如果包含了特殊符号，则需要使用引号包围。</p><p>单引号包围字符串时，会将特殊符号保留。</p><p>双引号包围字符串时，反斜线需要额外进行转义。</p><p>例如，下面几对书写方式是等价的：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">key1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;~&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">key2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;~&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">key3</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;\.php$&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">key4</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;\\.php$&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">key5</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> \.php$</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">key6</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> \n</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">key7</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;\n&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">key8</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;\\n&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>等价于 json：</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> </span><span class="token property">&quot;key1&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;~&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> </span><span class="token property">&quot;key2&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;~&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> </span><span class="token property">&quot;key3&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;\\.php$&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> </span><span class="token property">&quot;key4&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;\\.php$&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> </span><span class="token property">&quot;key5&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;\\.php$&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> </span><span class="token property">&quot;key6&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;\\n&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> </span><span class="token property">&quot;key7&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;\\n&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> </span><span class="token property">&quot;key8&quot;</span><span class="token operator" style="color:rgb(0, 0, 0)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;\\n&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="453playbook-的写法">4.5.3、playbook 的写法<a class="hash-link" href="#453playbook-的写法" title="Direct link to heading">​</a></h3><p>了解 YAML 写法之后，就可以来写 Ansible 的 playbook 了。</p><p>回顾一下前文对 playbook、play 和 task 关系的描述，playbook 可以包含一个或多个 play，每个 play 可以包含一个或多个任务，且每个 play 都需要指定要执行该 play 的目标主机。</p><p>于是，将下面这个 ad-hoc 模式的 ansible 任务改成等价的 playbook 模式：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">$ ansible nginx -m copy -a </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;src=/etc/passwd dest=/tmp&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>假设这个 playbook 的文件名为 copy.yml，其内容如下：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">gather_facts</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">tasks</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">copy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> src=/etc/passwd dest=/tmp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后使用 ansible-playbook 命令执行该 playbook。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">$ ansible-playbook copy.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>再来解释一下这个 playbook 文件的含义。</p><p>playbook 中，每个 play 都需要放在数组中，所以在 playbook 的顶层使用列表的方式 <code>- xxx:</code> 来表示这是一个 play（此处是 <code>- hosts:</code>）。</p><p>每个 play 都必须包含 <code>hosts</code> 和 <code>tasks</code> 指令。</p><p><code>hosts</code> 指令用来指定要执行该 play 的目标主机，可以是主机名，也可以是主机组，还支持其它方式来更灵活的指定目标主机。具体的规则后文再做介绍。</p><p>tasks 指令用来指定这个 play 中包含的任务，可以是一个或多个任务，任务也需要放在 play 的数组中，所以 tasks 指令内使用 <code>- xxx:</code> 的方式来表示每一个任务（此处是 <code>- copy:</code>）。</p><p><code>gather_facts</code> 是一个 play 级别的指令设置，它是一个负责收集目标主机信息的任务，由 setup 模块提供。默认情况下，每个 play 都会先执行这个特殊的任务，收集完信息之后才开始执行其它任务。</p><p>但是，收集目标主机信息的效率很低，如果能够确保 playbook 中不会使用到所收集的信息，可以显式指定 <code>gather_facts: no</code> 来禁止这个默认执行的收集任务，这对效率的提升是非常可观的。</p><p>此外每个 play 和每个 task 都可以使用 name 指令来命名，也建议尽量为每个 play 和每个 task 都命名，且名称具有唯一性。</p><p>所以，将上面的 playbook 改写：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> first play</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">gather_facts</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">tasks</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> copy /etc/passwd to /tmp</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">copy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> src=/etc/passwd dest=/tmp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="454playbook-模块参数的传递方式">4.5.4、playbook 模块参数的传递方式<a class="hash-link" href="#454playbook-模块参数的传递方式" title="Direct link to heading">​</a></h3><p>在刚才的示例中，copy 模块的参数传递方式如下：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token key atrule">tasks</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> copy /etc/passwd to /tmp</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token key atrule">copy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> src=/etc/passwd dest=/tmp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这是标准的 yaml 语法，参数部分 src=/etc/passwd dest=/tmp 是一个字符串，当作 copy 对应的值。</p><p>根据前面介绍的 yaml 语法，还可以换行书写。有以下几种方式：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> first play</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">gather_facts</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">tasks</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">copy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        src=/etc/passwd dest=/tmp</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">copy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        src=/etc/passwd</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        dest=/tmp</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">copy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token scalar string" style="color:rgb(163, 21, 21)"></span><br></span><span class="token-line" style="color:#000000"><span class="token scalar string" style="color:rgb(163, 21, 21)">        src=/etc/passwd</span><br></span><span class="token-line" style="color:#000000"><span class="token scalar string" style="color:rgb(163, 21, 21)">        dest=/tmp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">copy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">|</span><span class="token scalar string" style="color:rgb(163, 21, 21)"></span><br></span><span class="token-line" style="color:#000000"><span class="token scalar string" style="color:rgb(163, 21, 21)">        src=/etc/passwd</span><br></span><span class="token-line" style="color:#000000"><span class="token scalar string" style="color:rgb(163, 21, 21)">        dest=/tmp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>除此之外，Ansible 还提供了另外两种传递参数的方式：</p><ul><li>将参数和参数值写成 <code>key: value</code> 的方式</li><li>使用 <code>args</code> 参数声明接下来的是参数</li></ul><p>通过示例便可对其用法一目了然：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> first play</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">gather_facts</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">tasks</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> copy1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">copy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">src</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> /etc/passwd</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">dest</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> /tmp</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> copy2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">copy</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">      </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">src</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> /etc/passwd</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token key atrule">dest</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> /tmp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>大多数时候，使用何种方式传递参数并无关紧要，只要个人觉得可读性高、方便、美观即可。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="455play-的目标主机">4.5.5、play 的目标主机<a class="hash-link" href="#455play-的目标主机" title="Direct link to heading">​</a></h3><p>每一个 play 都包含 hosts 指令，它用来指示在解析 inventory 之后选择哪些主机执行该 play 中的 tasks。</p><p><code>hosts</code> 指令通过 pattern 的方式来筛选节点，pattern 的指定方式有以下几种规则：</p><ol><li>直接指定 inventory 中定义的主机名<ul><li><code>hosts: localhost</code></li></ul></li><li>直接指定 inventory 中的主机组名<ul><li><code>hosts: nginx</code></li><li><code>hosts: all</code></li></ul></li><li>使用组名时，可以使用数值索引的方式表示组中的第几个主机<ul><li><code>hosts: nginx[1]:mysql[0]</code></li></ul></li><li>可使用冒号或逗号隔开多个 pattern<ul><li><code>hosts: nginx:localhost</code></li></ul></li><li>可以使用范围表示法<ul><li><code>hosts: 192.168.200.3[0:3]</code></li><li><code>hosts: web[A:D]</code></li></ul></li><li>可以使用通配符 <code>*</code><ul><li><code>hosts: *.example.com</code></li><li><code>hosts: *</code>，这等价于 <code>hosts: all</code></li></ul></li><li>可以使用正则表达式，需使用 <code>~</code> 开头<ul><li><code>hosts: ~(web|db)\.example\.com</code></li></ul></li></ol><p>此外：</p><ol><li>所有 pattern 选中的主机都是包含性的，第一个 pattern 选中的主机会添加到下一个 pattern 的范围内，直到最后一个 pattern 筛选完，于是取得了所有 pattern 匹配的主机。</li><li>pattern 前面加一个 <code>&amp;</code> 符号表示取交集<ul><li><code>pattern1:&amp;pattern2</code> 要求同时存在于 pattern1 和 pattern2 中的主机</li></ul></li><li>pattern 前面加一个 <code>!</code> 符号表示排除<ul><li><code>pattern1:!pattern2</code> 要求出现在 pattern1 中但未出现在 pattern2 中</li></ul></li></ol><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="46默认的任务执行策略">4.6、默认的任务执行策略<a class="hash-link" href="#46默认的任务执行策略" title="Direct link to heading">​</a></h2><p>假设有 10 个目标节点要执行某个 play 中的 3 个任务：tA、tB、tC。</p><p>默认情况下，会从 10 个目标节点中选择 5 个节点作为第一批次的节点执行任务 tA，第一批次的 5 个节点都执行 tA 完成后，将选择剩下的 5 个节点作为第二批次执行任务 tA。</p><p>所有节点都执行完任务 tA 后，第一批次的 5 节点开始执行任务 tB，然后第二批次的 5 个节点执行任务 tB。</p><p>所有节点都执行完任务 tB 后，第一批次的 5 节点开始执行任务 tC，然后第二批次的 5 个节点执行任务 tC。</p><p>整个过程如下：</p><p><img loading="lazy" alt="ansible_forks" src="/en/assets/images/ansible_forks-9b8d4c56efca67f1ab56f4a16072a6ba.gif" width="924" height="568" class="img_ev3q"></p><p>这个流程图虽然简单形象，但是不严谨，稍后会解释为何不严谨。</p><p>这里提到的 5 个节点的数量 5，是由配置文件中 forks 指令的值决定的，默认值为 5。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">$ </span><span class="token function" style="color:rgb(0, 0, 255)">grep</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;fork&#x27;</span><span class="token plain"> /etc/ansible/ansible.cfg</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">#forks          = 5</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>forks 指令用来指定 Ansible 最多要创建几个子进程来执行任务，每个节点默认对应一个 ansible-playbook 进程和 ssh 进程，例如 forks=5 表示最多创建 5 个 ansible-playbook 子进程。所以，forks 的值也代表了最多有几个节点同时执行任务。</p><p>例如，将 hosts 指令指定为 all，并将 gather<!-- -->_<!-- -->facts 指令取消注释，因为这个任务执行比较慢，方便观察进程列表。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> first play</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(4, 81, 165)">:</span><span class="token plain"> all </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token comment" style="color:rgb(0, 128, 0)">#gather_facts: false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>执行该 playbook。然后在另外一个终端上去查看进程列表：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@controller ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ansible-playbook first.yml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@controller ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># pstree -c | grep &#x27;ansible&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-sshd-+-sshd---bash---ansible-playboo-+-ansible-playboo---ssh</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">      </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">                               </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-ansible-playboo---ssh</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">      </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">                               </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-ansible-playboo---ssh</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">      </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">                               </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-ansible-playboo---ssh</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">      </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">                               </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-ansible-playboo</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">      </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">                               `-</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">ansible-playboo</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>结果表明 forks=5 时共有 6 个 Ansible 进程，其中父进程是 Ansible 主控进程，负责监控节点执行任务的状态以及创建子进程来执行任务。</li><li>如果某个节点连接失败或执行某个任务失败，则该节点将不再执行该 play 中的后续任务(但会执行后续的 play)。</li></ul><p>根据上面对 forks 指令的效果描述，前面的执行策略流程图并不严谨。因为 forks 的效果并不是选中一批节点，本批节点执行完任务才选下一批节点。</p><p>forks 是保证最多有 N 个节点同时执行任务，但有的节点可能执行任务较慢。比如有 10 个节点，且 forks=5 时，第一批选中 5 个节点执行任务，假如第 1 个节点先执行完任务，Ansible 主控进程不会等待本批中其它 4 个节点执行完任务，而是直接创建一个新的 Ansible 进程，让第 6 个节点执行任务。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="47综合案例">4.7、综合案例<a class="hash-link" href="#47综合案例" title="Direct link to heading">​</a></h2><p>在生产环境中，有大量的集群需要进行初始化工作，这里使用 playbook 写一个批量初始化服务器的案例。</p><p>参见<a href="https://www.brinnatt.com/supplement/%E7%AC%AC-a-%E7%AB%A0-ansible-%E6%89%B9%E9%87%8F%E5%88%9D%E5%A7%8B%E5%8C%96%E6%9C%8D%E5%8A%A1%E5%99%A8/" target="_blank" rel="noopener noreferrer">批量初始化服务器</a></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/en/docs/linux/cicd/第 3 章 Jenkins 自动化系统"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">第 3 章 Jenkins 自动化系统</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/en/docs/linux-cicd-5"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">第 5 章 Linux Ansible 进阶知识</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#41ansible-简介" class="table-of-contents__link toc-highlight">4.1、Ansible 简介</a></li><li><a href="#42ansible-体验" class="table-of-contents__link toc-highlight">4.2、Ansible 体验</a><ul><li><a href="#421ansible-环境准备" class="table-of-contents__link toc-highlight">4.2.1、Ansible 环境准备</a></li><li><a href="#422安装-ansible" class="table-of-contents__link toc-highlight">4.2.2、安装 Ansible</a></li><li><a href="#423ansible-命令补全" class="table-of-contents__link toc-highlight">4.2.3、Ansible 命令补全</a></li><li><a href="#424配置主机互信" class="table-of-contents__link toc-highlight">4.2.4、配置主机互信</a></li><li><a href="#425ansible-体验" class="table-of-contents__link toc-highlight">4.2.5、Ansible 体验</a></li></ul></li><li><a href="#43ansible-配置文件" class="table-of-contents__link toc-highlight">4.3、Ansible 配置文件</a></li><li><a href="#44inventory" class="table-of-contents__link toc-highlight">4.4、Inventory</a><ul><li><a href="#441inventory-文件路径" class="table-of-contents__link toc-highlight">4.4.1、Inventory 文件路径</a></li><li><a href="#442配置-inventory" class="table-of-contents__link toc-highlight">4.4.2、配置 Inventory</a><ul><li><a href="#4421一行一主机的定义方式" class="table-of-contents__link toc-highlight">4.4.2.1、一行一主机的定义方式</a></li><li><a href="#4422inventory-中的普通变量" class="table-of-contents__link toc-highlight">4.4.2.2、Inventory 中的普通变量</a></li><li><a href="#4423主机分组" class="table-of-contents__link toc-highlight">4.4.2.3、主机分组</a></li><li><a href="#4424主机组变量" class="table-of-contents__link toc-highlight">4.4.2.4、主机组变量</a></li><li><a href="#4425组嵌套" class="table-of-contents__link toc-highlight">4.4.2.5、组嵌套</a></li><li><a href="#4426multi-inventory-文件" class="table-of-contents__link toc-highlight">4.4.2.6、Multi Inventory 文件</a></li></ul></li><li><a href="#443实验-inventory-文件" class="table-of-contents__link toc-highlight">4.4.3、实验 Inventory 文件</a></li></ul></li><li><a href="#45playbook" class="table-of-contents__link toc-highlight">4.5、Playbook</a><ul><li><a href="#451playbookplay-和-task-的关系" class="table-of-contents__link toc-highlight">4.5.1、playbook、play 和 task 的关系</a></li><li><a href="#452yaml-语法" class="table-of-contents__link toc-highlight">4.5.2、YAML 语法</a><ul><li><a href="#4521对象" class="table-of-contents__link toc-highlight">4.5.2.1、对象</a></li><li><a href="#4522数组" class="table-of-contents__link toc-highlight">4.5.2.2、数组</a></li><li><a href="#4523字典" class="table-of-contents__link toc-highlight">4.5.2.3、字典</a></li><li><a href="#4524复合结构" class="table-of-contents__link toc-highlight">4.5.2.4、复合结构</a></li><li><a href="#4525字符串续行" class="table-of-contents__link toc-highlight">4.5.2.5、字符串续行</a></li><li><a href="#4526空值" class="table-of-contents__link toc-highlight">4.5.2.6、空值</a></li><li><a href="#4527单双引号和转义" class="table-of-contents__link toc-highlight">4.5.2.7、单双引号和转义</a></li></ul></li><li><a href="#453playbook-的写法" class="table-of-contents__link toc-highlight">4.5.3、playbook 的写法</a></li><li><a href="#454playbook-模块参数的传递方式" class="table-of-contents__link toc-highlight">4.5.4、playbook 模块参数的传递方式</a></li><li><a href="#455play-的目标主机" class="table-of-contents__link toc-highlight">4.5.5、play 的目标主机</a></li></ul></li><li><a href="#46默认的任务执行策略" class="table-of-contents__link toc-highlight">4.6、默认的任务执行策略</a></li><li><a href="#47综合案例" class="table-of-contents__link toc-highlight">4.7、综合案例</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Study</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/tags">Tags</a></li><li class="footer__item"><a class="footer__link-item" href="/en/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/en/docs/skill">Notes</a></li><li class="footer__item"><a class="footer__link-item" href="/en/project">Projects</a></li><li class="footer__item"><a class="footer__link-item" href="/en/docs/linux">Linux</a></li></ul></div><div class="col footer__col"><div class="footer__title">Social Media</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/about">About Me</a></li><li class="footer__item"><a href="https://github.com/zqingfa" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://juejin.cn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Juejin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" position="right" href="/en/friends">Friends</a></li><li class="footer__item"><a class="footer__link-item" position="right" href="/en/website">Links</a></li><li class="footer__item"><a href="https://docusaurus.io/zh-CN/" target="_blank"><img style="height:50px;margin-top:0.5rem" src="/img/buildwith.png"><a></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p><a href="http://beian.miit.gov.cn/">闽ICP备2020017848号-2</a></p><p>Copyright © 2020 – PRESENT kuizuo Built with Docusaurus.</p></div></div></div></footer></div>
<script src="/en/assets/js/runtime~main.06ffa367.js"></script>
<script src="/en/assets/js/main.7f2e5564.js"></script>
</body>
</html>