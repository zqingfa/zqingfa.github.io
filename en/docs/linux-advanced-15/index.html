<!doctype html>
<html lang="en-GB" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-linux/advanced/linux-advanced-15">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">第 15 章 Linux LVS 服务配置 - Linux技术分享</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://zhangqf.com/en/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://zhangqf.com/en/img/logo.png"><meta data-rh="true" property="og:url" content="https://zhangqf.com/en/docs/linux-advanced-15"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="第 15 章 Linux LVS 服务配置 - Linux技术分享"><meta data-rh="true" name="description" content="网站架构中，负载均衡技术是实现网站架构伸缩性的主要手段之一。所谓 &quot;伸缩性&quot;，是指可以不断向集群中添加新的服务器来提升性能、缓解不断增加的并发用户访问压力。"><meta data-rh="true" property="og:description" content="网站架构中，负载均衡技术是实现网站架构伸缩性的主要手段之一。所谓 &quot;伸缩性&quot;，是指可以不断向集群中添加新的服务器来提升性能、缓解不断增加的并发用户访问压力。"><meta data-rh="true" name="keywords" content="linux,lvs"><link data-rh="true" rel="icon" href="/en/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://zhangqf.com/en/docs/linux-advanced-15"><link data-rh="true" rel="alternate" href="https://zhangqf.com/en/docs/linux-advanced-15" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/linux-advanced-15" hreflang="zh"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/linux-advanced-15" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9B0V5WT2X8-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S4SD5NXWXF"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S4SD5NXWXF",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Linux技术分享" href="/en/opensearch.xml">
<link rel="preconnect" href="https://zhangqf.com/">
<script>var _paq=window._paq=window._paq||[];_paq.push(["setRequestMethod","POST"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),_paq.push(["enableHeartBeatTimer"]),function(){var e="https://zhangqf.com/";_paq.push(["setRequestMethod","POST"]),_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]);var a=document,t=a.createElement("script"),p=a.getElementsByTagName("script")[0];t.type="text/javascript",t.async=!0,t.src=e+"matomo.js",p.parentNode.insertBefore(t,p)}()</script>


<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?77dc6b24cf1d939292e9fe13be271a96",e.defer=!0;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<meta name="baidu-site-verification" content="code-rqLUw5reVS">
<script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",t.defer=!0;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script>
<link rel="alternate" type="application/rss+xml" href="/en/rss.xml" title="zhangqf RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/atom.xml" title="zhangqf Atom Feed">
<link rel="alternate" type="application/json" href="/en/feed.json" title="zhangqf JSON Feed">

<link rel="icon" href="/en/img/logo.png">
<link rel="manifest" href="/en/manifest.json">
<meta name="theme-color" content="rgb(51 139 255)"><link rel="stylesheet" href="/en/assets/css/styles.bf38107f.css">
<link rel="preload" href="/en/assets/js/runtime~main.403f05fc.js" as="script">
<link rel="preload" href="/en/assets/js/main.4747bdb7.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><span>更新 <a href="/website">网址导航</a> 带你发现感兴趣的技术</span></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">zhangqf</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/en/docs/linux">Linux</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/en/docs/category/Linux基础">Linux 基础</a></li><li><a class="dropdown__link" href="/en/docs/category/Linux进阶">Linux 进阶</a></li><li><a class="dropdown__link" href="/en/docs/category/Linux测试">Linux 测试</a></li><li><a class="dropdown__link" href="/en/docs/category/LinuxCICD">Linux CICD研发</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/en/docs/skill/">Notes</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/en/tags">Tags</a></li><li><a class="dropdown__link" href="/en/archive">Archive</a></li><li><a class="dropdown__link" href="/en/docs/category/存储">存储</a></li></ul></div><a class="navbar__item navbar__link" href="/en/website">Links</a><a class="navbar__item navbar__link" href="/en/project">Projects</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/en/docs/linux-advanced-15" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en-GB">English</a></li><li><a href="/docs/linux-advanced-15" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh">中文</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/en/"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"><b>zhangqf</b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/linux">linux</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linux基础">Linux基础</a><button aria-label="Toggle the collapsible sidebar category &#x27;Linux基础&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/en/docs/category/linux进阶">Linux进阶</a><button aria-label="Toggle the collapsible sidebar category &#x27;Linux进阶&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-1">第 1 章 Linux 进阶命令</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-2">第 2 章 Linux 防火墙</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-3">第 3 章 Linux NFS 网络文件系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-4">第 4 章 Linux DHCP 服务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-5">第 5 章 Linux DNS 服务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-6">第 6 章 Linux httpd 服务基础配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-7">第 7 章 Linux httpd 服务进阶配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-8">第 8 章 Linux httpd 服务高级配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-9">第 9 章 Linux Nginx 服务配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-10">第 10 章 Linux Tomcat 服务基础配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-11">第 11 章 Linux Tomcat 服务实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-12">第 12 章 Linux haproxy 服务基础配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-13">第 13 章 Linux haproxy 服务进阶配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-14">第 14 章 Linux haproxy 服务高级配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/en/docs/linux-advanced-15">第 15 章 Linux LVS 服务配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-16">第 16 章 Linux Keepalived 服务配置</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linux测试">Linux测试</a><button aria-label="Toggle the collapsible sidebar category &#x27;Linux测试&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linuxcicd">LinuxCICD</a><button aria-label="Toggle the collapsible sidebar category &#x27;LinuxCICD&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/en/docs/category/linux进阶"><span itemprop="name">Linux进阶</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">第 15 章 Linux LVS 服务配置</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>第 15 章 Linux LVS 服务配置</h1></header><p>网站架构中，负载均衡技术是实现网站架构<strong>伸缩性</strong>的主要手段之一。所谓 &quot;伸缩性&quot;，是指可以不断向集群中添加新的服务器来提升性能、缓解不断增加的并发用户访问压力。</p><p>负载均衡有好几种方式：http URL 重定向、DNS 的 A 记录负载均衡、反向代理负载均衡、IP 负载均衡和链路层负载。本文所述为 LVS，它的 VS/NAT 和 VS/TUN 模式是 IP 负载均衡的优秀代表，而它的 VS/DR 模式则是链路层负载均衡的优秀代表。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="101lvs-简介">10.1、LVS 简介<a href="#101lvs-简介" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>LVS 中文官方手册：<a href="http://www.linuxvirtualserver.org/zh/index.html%E3%80%82%E8%BF%99%E4%B8%AA%E6%89%8B%E5%86%8C%E5%AF%B9%E4%BA%8E%E4%BA%86%E8%A7%A3" target="_blank" rel="noopener noreferrer">http://www.linuxvirtualserver.org/zh/index.html。这个手册对于了解</a> lvs 的背景知识很有帮助。</p><p>LVS 英文官方手册：<a href="http://www.linuxvirtualserver.org/Documents.html%E3%80%82%E8%BF%99%E4%B8%AA%E6%89%8B%E5%86%8C%E6%AF%94%E8%BE%83%E5%85%A8%E9%9D%A2%EF%BC%8C%E5%AF%B9%E4%BA%8E%E4%BA%86%E8%A7%A3%E5%92%8C%E5%AD%A6%E4%B9%A0" target="_blank" rel="noopener noreferrer">http://www.linuxvirtualserver.org/Documents.html。这个手册比较全面，对于了解和学习</a> lvs 的原理、配置很有帮助。</p><p>LVS 是章文嵩开发的一个国产开源负载均衡软件。LVS 最初是他在大学期间的玩具，随着后来使用的用户越来越多，LVS 也越来越完善，最终集成到了 Linux 的内核中。有不少开源牛人都为 LVS 开发过辅助工具和辅助组件，最出名的就是 Alexandre 为 LVS 编写的 Keepalived，它最初专门用于监控 LVS，后来加入了通过 VRRP 实现高可用的功能。</p><p>LVS 的全称是 Linux virtual server，即 Linux 虚拟服务器。之所以是虚拟服务器，是因为 LVS 自身是个负载均衡器(director)，不直接处理请求，而是将请求转发至位于它后端真正的服务器 realserver 上。</p><p>LVS 是四层(传输层 tcp/udp)、七层(应用层)的负载均衡工具，只不过大众一般都使用它的四层负载均衡功能 ipvs，而七层的内容分发负载工具 ktcpvs(kernel tcp virtual server)不怎么完善，使用的人并不多。</p><p>ipvs 是集成在内核中的框架，可以通过用户空间的程序 <code>ipvsadm</code> 工具来管理，该工具可以定义一些规则来管理内核中的 ipvs。就像 iptables 和 netfilter 的关系一样。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="102lvs-ipvs-三种模式的工作原理">10.2、LVS-ipvs 三种模式的工作原理<a href="#102lvs-ipvs-三种模式的工作原理" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>首先要解释的是 LVS 相关的几种 IP：</p><ul><li><code>VIP</code>：virtual IP，LVS 服务器上接收外网数据包的网卡 IP 地址。</li><li><code>DIP</code>：director IP，LVS 服务器上转发数据包到 realserver 的网卡 IP 地址。</li><li><code>RIP</code>：realserver(常简称为 RS)上接收 Director 转发数据包的 IP，即提供服务的服务器 IP。</li><li><code>CIP</code>：客户端的 IP。</li></ul><p>LVS 的三种工作模式：</p><ol><li>通过网络地址转换(NAT)将一组服务器构成一个高性能的、高可用的虚拟服务器，是 VS/NAT 技术。</li><li>在分析 VS/NAT 的缺点和网络服务的非对称性的基础上，提出了通过 IP 隧道实现虚拟服务器的方法 VS/TUN（Virtual Server via IP Tunneling）。</li><li>通过直接路由实现虚拟服务器的方法 VS/DR（Virtual Server via Direct Routing）。</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1021vsnat-模式">10.2.1、VS/NAT 模式<a href="#1021vsnat-模式" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><ol><li>客户端发送的请求到达 Director 后，Director 根据负载均衡算法改写目标地址为后端某个 RIP(web 服务器池中主机之一)并转发给该后端主机，就像 NAT 一样。</li><li>当后端主机处理完请求后，后端主机将响应数据交给 Director，并由 director 改写源地址为 VIP 后传输给客户端。</li></ol><p>大多数商品化的 IP 负载均衡硬件都是使用此方法，如 Cisco 的 LocalDirector、F5 的 Big/IP。</p><p><img loading="lazy" alt="lvs nat" src="/en/assets/images/lvs nat-686ea57ac7c2ba3683bfd0a310a69c39.png" width="836" height="355" class="img_ev3q"></p><p>VS/NAT 模式下：</p><ol><li>RIP 和 DIP 一般处于同一私有网段中。但并非必须，只要它们能通信即可。</li><li>各 RealServer 的网关指向 DIP，这样能保证将响应数据交给 Director。</li><li>VS/NAT 模式的最大缺点是 Director 负责所有进出数据：不仅处理客户端发起的请求，还负责将响应传输给客户端。而响应数据一般比请求数据大得多，调度器 Director 容易出现瓶颈。(也就是像 7 层负载的处理方式一样，但却没有 7 层负载那么 &quot;多功能&quot;)</li><li>这种模式配置起来最简单。</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1022vstun-模式">10.2.2、VS/TUN 模式<a href="#1022vstun-模式" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>采用 NAT 技术时，由于请求和响应报文都必须经过调度器地址重写，当客户请求越来越多时，调度器的处理能力将成为瓶颈。</p><p>为了解决这个问题，调度器把请求报文通过 IP 隧道转发至真实服务器，而真实服务器将响应直接返回给客户，所以调度器只处理请求报文。</p><p>由于一般网络服务响应报文比请求报文大许多，采用 VS/TUN 技术后，调度器得到极大的解放，集群系统的最大吞吐量可以提高 10 倍。</p><p><img loading="lazy" alt="lvs tun" src="/en/assets/images/lvs tun-e96e763bce775faf88b5447d07413d7b.png" width="1019" height="356" class="img_ev3q"></p><p>VS/TUN 模式的工作原理：</p><ol><li>IP 隧道技术又称为 IP 封装技术，它可以将带有源和目标 IP 地址的数据报文使用新的源和目标 IP 进行第二次封装，这样这个报文就可以发送到一个指定的目标主机上；</li><li>VS/TUN 模式下，调度器和后端服务器组之间使用 IP 隧道技术。当客户端发送的请求(CIP--&gt;VIP)被 director 接收后，director 修改该报文，加上 IP 隧道两端的 IP 地址作为新的源和目标地址，并将请求转发给后端被选中的一个目标；</li><li>当后端服务器接收到报文后，首先解封报文得到原有的 CIP--&gt;VIP，该后端服务器发现自身的 tun 接口上配置了 VIP，因此接受该数据包。</li><li>当请求处理完成后，结果将不会重新交给 director，而是直接返回给客户端。此时响应数据包的源 IP 为 VIP，目标 IP 为 CIP。</li></ol><p>采用 VS/TUN 模式时的基本属性和要求：</p><ol><li>RealServer 的 RIP 和 director 的 DIP 不用处于同一物理网络中，且 RIP 必须可以和公网通信。也就是说集群节点可以跨互联网实现。</li><li>realserver 的 tun 接口上需要配置 VIP 地址，以便接收 director 转发过来的数据包，以及作为响应报文的源 IP。</li><li>director 给 realserver 时需要借助隧道，隧道外层的 IP 头部的源 IP 是 DIP，目标 IP 是 RIP。而 realsever 响应给客户端的 IP 头部是根据隧道内层的 IP 头分析得到的，源 IP 是 VIP，目标 IP 是 CIP。这样客户端就无法区分这个 VIP 到底是 director 的还是服务器组中的。</li><li>director 只处理入站请求，响应请求由 realserver 完成。</li></ol><p>一般来说，VS/TUN 模式会用来负载调度缓存服务器组，这些缓存服务器一般放置在不同网络环境，可以就近返回数据给客户端。在请求对象不能在 Cache 服务器本地命中的情况下，Cache 服务器要向源服务器发请求，将结果取回，最后将结果返回给客户。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1023vsdr-模式">10.2.3、VS/DR 模式<a href="#1023vsdr-模式" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>VS/TUN 模式下，调度器对数据包的处理是使用 IP 隧道技术进行二次封装。VS/DR 模式和 VS/TUN 模式很类似，只不过调度器对数据包的处理是改写数据帧的目标 MAC 地址，通过链路层来负载均衡。</p><p>VS/DR 通过改写请求报文的目标 MAC 地址，将请求发送到真实服务器，而真实服务器将响应直接返回给客户。同 VS/TUN 技术一样，VS/DR 技术可极大地提高集群系统的伸缩性。这种方法没有 IP 隧道的开销，对集群中的真实服务器也没有必须支持 IP 隧道协议的要求，但是要求调度器与真实服务器都有一块网卡连在同一物理网段上，以便使用 MAC 地址通信转发数据包。</p><p><img loading="lazy" alt="lvs dr" src="/en/assets/images/lvs dr-ca6f17d52a4c2e13bb567a37f2aa126d.png" width="993" height="390" class="img_ev3q"></p><p>VS/DR 模式的工作原理：</p><ol><li>客户端发送的请求被 director 接收后，director 根据负载均衡算法，改写数据帧的<strong>目标 MAC 地址</strong>为后端某 RS 的 MAC 地址，并将该数据包转发给该 RS(实际上是往整个局域网发送，但只有该 MAC 地址的 RS 才不会丢弃)。</li><li>RS 接收到数据包后，发现数据包的目标 IP 地址为 VIP，而 RS 本身已经将 VIP 配置在了某个接口上，因此 RS 会接收下这个数据包并进行处理。</li><li>处理完毕后，RS 直接将响应报文响应给客户端。此时数据包源 IP 为 VIP，目标 IP 为 CIP。</li></ol><p>采用 VS/DR 模式时的基本属性和要求：</p><ol><li>RealServer 的 RIP 和 director 的 DIP 必须处于同一网段中，以便使用 MAC 地址进行通信。</li><li>realserver 上必须配置 VIP 地址，以便接收 director 转发过来的数据包，以及作为响应报文的源 IP。</li><li>realsever 响应给客户端的数据包的源和目标 IP 为 VIP --&gt; CIP。</li><li>director 只处理入站请求，响应请求由 realserver 完成。</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1024lvs-ipvs-的三种模式比较">10.2.4、lvs-ipvs 的三种模式比较<a href="#1024lvs-ipvs-的三种模式比较" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>三种模式的比较如图所示：</p><p><img loading="lazy" alt="lvs compared" src="data:image/png;base64,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" width="628" height="138" class="img_ev3q"></p><ol><li>在性能上，VS/DR 和 VS/TUN 远高于 VS/NAT，因为调度器只处于从客户到服务器的半连接中，按照半连接的 TCP 有限状态机进行状态迁移，极大程度上减轻了调度器的压力(真正建立 TCP 连接的是 RS 和 Client)。</li><li>VS/DR 性能又稍高于 VS/TUN，因为少了隧道的开销。但是，VS/DR 和 VS/TUN 的主要区别是 VS/TUN 可以跨网络实现后端服务器负载均衡(也可以局域网内)，而 VS/DR 只能和 director 在局域网内进行负载均衡。</li></ol><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="103vstun-和-vsdr-模式中的-arp-问题">10.3、VS/TUN 和 VS/DR 模式中的 ARP 问题<a href="#103vstun-和-vsdr-模式中的-arp-问题" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>参见 <a href="https://www.brinnatt.com/addons/%e7%ac%ac-d-1-%e7%ab%a0-linux-arp-%e5%ba%94%e7%94%a8/" target="_blank" rel="noopener noreferrer">VS/TUN 和 VS/DR 的 arp 问题</a>，非常详细地分析了 ARP、arp<!-- -->_<!-- -->ignore 和 arp<!-- -->_<!-- -->announce 相关原理和设置方法。此处简单说明为何需要设置 arp 抑制以及设置 arp 抑制的方法。</p><p>当一个目标 IP 地址为 VIP 的数据包进入 Director 时，Director 局域网(包括隧道)内会进行 ARP 广播，以找出 VIP 地址的 MAC 地址在哪台主机上。</p><p><strong>Director 和各 RS 都配置了 VIP</strong>。Director 和 RS 之间的连接设备 L(可能是交换机、路由器，也可能是直连时 Director 的内核) 发送 ARP 广播后，Director 和 RS 都会收到这个广播包，且都认为这个广播包找的就是自己，于是都回应给设备 L，这样设备 L 上的 ARP 缓存表中的条目 <code>VIP &lt;--&gt; vip_MAC</code> 就不断被覆盖直到最后一个回应。</p><p>这样一来，设备 L 将把客户端的数据包发送给最后一个回应的主机，这台主机的 VIP 可能是 Director 上的，也可能是某个 RS 上的。在一定时间内，设备 L 收到目标 IP 为 VIP 的数据包都会发送给该主机。但设备 L 会定时发送 ARP 广播包，这样一来 ARP 缓存表中的 VIP 对应的 MAC 地址可能会换成另一台主机。</p><p><strong>因此，必须要保证设备 L 只保存 Director 上 VIP 对应的 MAC 地址，即只允许 Director 才对设备 L 的 ARP 广播进行回应。也就是说，所有 RS 上的 VIP 必须隐藏起来</strong>。</p><p>一般通过将 Real Server 上的 VIP 设置在 lo 接口的别名接口上(如 lo:0)，并设置 <code>arp_ignore=1</code> 和 <code>arp_announce=2</code> 的方式来隐藏 RS 上的 VIP。至于 VIP 为何要设置在 lo 接口上以及为何要这样设置这两个 arp 参数，请参见 <a href="https://www.brinnatt.com/addons/%e7%ac%ac-d-1-%e7%ab%a0-linux-arp-%e5%ba%94%e7%94%a8/" target="_blank" rel="noopener noreferrer">VS/TUN 和 VS/DR 的 arp 问题</a>，内容非常详细。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">/proc/sys/net/ipv4/conf/all/arp_ignore</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">/proc/sys/net/ipv4/conf/all/arp_announce</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>或者：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">sysctl -w net.ipv4.conf.all.arp_ignore</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sysctl -w net.ipv4.conf.all.arp_announce</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>或者将 arp 参数设置到内核参数配置文件中以让其永久生效：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;net.ipv4.conf.all.arp_ignore=1&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;&gt;</span><span class="token plain">/etc/sysctl.conf</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;net.ipv4.conf.all.arp_announce=2&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;&gt;</span><span class="token plain">/etc/sysctl.conf</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">sysctl -p</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在网上几乎所有文章还设置了 lo 接口上的 arp 参数：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">/proc/sys/net/ipv4/conf/lo/arp_announce</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>但这没有任何意义，因为 lo 接口不受 arp 参数的影响。</li></ul><p><strong>应该在配置 VIP 之前就设置 arp 参数，以防止配置 VIP 后、设置 arp 抑制之前被外界主机发现。</strong></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="104lvs-负载均衡的调度算法">10.4、LVS 负载均衡的调度算法<a href="#104lvs-负载均衡的调度算法" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>LVS 的调度算法，详细内容见官方手册：<a href="http://www.linuxvirtualserver.org/zh/lvs4.html" target="_blank" rel="noopener noreferrer">http://www.linuxvirtualserver.org/zh/lvs4.html</a> 。</p><p>IPVS 在内核中的负载均衡调度是<strong>以连接为粒度</strong>的。在 HTTP 协议（非持久）中，每次从 WEB 服务器上获取资源都需要建立一个 TCP 连接，同一用户的不同请求会被调度到不同的服务器上，所以这种细粒度的调度在一定程度上可以避免单个用户访问的突发性引起服务器间的负载不平衡。</p><p>LVS 分为两种调度方式：静态调度和动态反馈调度。</p><ul><li>静态调度方式是指不管 RS 的繁忙程度，根据调度算法计算后轮到谁就调度谁。<ul><li>例如两台 realserver，一开始双方都在处理 500 个连接，下一个请求到来前，server1 只断开了 10 个，而 server2 断开了 490 个，但是此时轮到了 server1，就会调度 server1 而不管繁忙的程度。</li></ul></li><li>动态调度方式是指根据 RS 的繁忙程度反馈，计算出下一个连接应该调度谁。<ul><li>动态反馈负载均衡算法考虑服务器的实时负载和响应情况，不断调整服务器间处理请求的比例，来避免有些服务器超载时依然收到大量请求，从而提高整个系统的吞吐率。</li></ul></li></ul><p>在内核中的连接调度算法上，IPVS 已实现了以下八种调度算法：默认的算法为 wlc。</p><ul><li><strong>静态调度：</strong><ul><li>轮叫调度（Round-Robin Scheduling，rr）</li><li>加权轮叫调度（Weighted Round-Robin Scheduling，wrr），按照权重比例作为轮询标准</li><li>目标地址散列调度（Destination Hashing Scheduling，dh），目标地址哈希，对于同一目标 IP 的请求总是发往同一服务器</li><li>源地址散列调度（Source Hashing Scheduling，sh），源地址哈希，在一定时间内，只要是来自同一个客户端的请求，就发送至同一个 realserver</li></ul></li><li><strong>动态反馈调度：</strong><ul><li>最小连接调度（Least-Connection Scheduling，lc），调度器需要记录各个服务器已建立连接的数目，当一个请求被调度到某服务器，其连接数加 1；当连接中止或超时，其连接数减 1。当各个服务器的处理能力不同时，该算法不理想。</li><li>加权最小连接调度（Weighted Least-Connection Scheduling，wlc）</li><li>基于本地的最少连接（Locality-Based Least Connections Scheduling，lblc），目前该算法主要用于 cache 集群系统。</li><li>带复制的基于局部性最少连接（Locality-Based Least Connections with Replication Scheduling，lblcr），目前主要用于 Cache 集群系统。</li></ul></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="105ipvsadm-命令">10.5、ipvsadm 命令<a href="#105ipvsadm-命令" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>ipvsadm 是 ipvs 的命令行管理工具，可以定义、删除、查看 virtual service 和 Real Server 的属性。</p><p>使用操作系统自带的 rpm 包进行安装：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /etc/redhat-release </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">CentOS Linux release </span><span class="token number" style="color:rgb(9, 134, 88)">7.9</span><span class="token plain">.2009 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">AltArch</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># yum info ipvsadm</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Loaded plugins: fastestmirror</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Loading mirror speeds from cached hostfile</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Available Packages</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Name        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> ipvsadm</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Arch        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> aarch64</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Version     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1.27</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Release     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8</span><span class="token plain">.el7</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Size        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">44</span><span class="token plain"> k</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Repo        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> base/aarch64</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Summary     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> Utility to administer the Linux Virtual Server</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">URL         </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> https://kernel.org/pub/linux/utils/kernel/ipvsadm/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">License     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> GPLv2+</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> ipvsadm is used to setup, maintain, and inspect the virtual server</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> table </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> the Linux kernel. The Linux Virtual Server can be used to</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> build scalable network services based on a cluster of two or </span><span class="token function" style="color:rgb(0, 0, 255)">more</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> nodes. The active </span><span class="token function" style="color:rgb(0, 0, 255)">node</span><span class="token plain"> of the cluster redirects </span><span class="token function" style="color:rgb(0, 0, 255)">service</span><span class="token plain"> requests to a</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> collection of server hosts that will actually perform the</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> services. Supported Features include:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">   - two transport layer </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">layer-4</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> protocols </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">TCP and UDP</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">   - three packet-forwarding methods </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">NAT, tunneling, and direct routing</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">   - eight load balancing algorithms </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">round robin, weighted round robin,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">     least-connection, weighted least-connection, locality-based</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">     least-connection, locality-based least-connection with</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">     replication, destination-hashing, and source-hashing</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># yum install ipvsadm.aarch64 -y</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用最新的 ipvsadm 源码安装，下载地址 <a href="https://mirrors.edge.kernel.org/pub/linux/utils/kernel/ipvsadm/" target="_blank" rel="noopener noreferrer">https://mirrors.edge.kernel.org/pub/linux/utils/kernel/ipvsadm/</a>：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># wget --no-check-certificate https://mirrors.edge.kernel.org/pub/linux/utils/kernel/ipvsadm/ipvsadm-1.31.tar.xz</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># yum groups install &quot;Development Tools&quot; -y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># yum install libnl3-devel.aarch64 popt-devel -y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># tar xf ipvsadm-1.31.tar.xz </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cd ipvsadm-1.31/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ipvsadm-1.31</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># make &amp;&amp; make install</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>编译安装后自动执行下面的工作，一般其他软件都要手动执行这些动作，给 ipvsadm 点个赞：</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token plain"> -d /sbin </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">then</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">mkdir</span><span class="token plain"> -p /sbin</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> -m 0755 ipvsadm /sbin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> -m 0755 ipvsadm-save /sbin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> -m 0755 ipvsadm-restore /sbin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> -d /usr/man/man8 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">||</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">mkdir</span><span class="token plain"> -p /usr/man/man8</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> -m 0644 ipvsadm.8 /usr/man/man8</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> -m 0644 ipvsadm-save.8 /usr/man/man8</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> -m 0644 ipvsadm-restore.8 /usr/man/man8</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> -d /etc/rc.d/init.d </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">||</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">mkdir</span><span class="token plain"> -p /etc/rc.d/init.d</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> -m 0755 ipvsadm.sh /etc/rc.d/init.d/ipvsadm</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="106ipvsadm-语法">10.6、ipvsadm 语法<a href="#106ipvsadm-语法" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>使用 <code>ipvsadm --help</code> 可以查看使用方法。ipvs 的更多功能以及 ipvsadm 的更详细用法，请 <code>man ipvsadm</code></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># ipvsadm的选项中，大写选项管理虚拟服务virtual service，小写选项管理关联了虚拟服务的真实服务器RealServer，&quot;-L&quot;和&quot;-l&quot;除外，它们同义。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">.Manage virtual services:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Add:    -A  -t</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">u</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">f service-address </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">-s scheduler</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            -t: tcp协议的集群</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            -u: udp协议的集群</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                service-address格式为IP:PORT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            -f: firewall-mark防火墙标记</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                service-address：a num </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> mark</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            -s: 调度算法</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Modify: -E -t</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">u</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">f service-address </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">-s scheduler</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 和-A使用方法一样</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Delete: -D -t</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">u</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">f service-address</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 和-A使用方法一样</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Example:  ipvsadm -A -t 172.16.10.20:80 -s rr (对外的地址，也就是VIP)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">.Manage realservers </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> virtual service:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Add:    -a  -t</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">u</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">f service-address -r server-address </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">-g</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">i</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">m</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">-w weight</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                -t</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">u</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">f service-address: 指定Real server所绑定的virtual </span><span class="token function" style="color:rgb(0, 0, 255)">service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                -r server-address: 某RS地址，在NAT模型中，可IP:PORT实现端口映射，即端口无需等于VIP对应的port</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                -g</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">i</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">m: 指定lvs的类型，有三种:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    -g: gataway即DR类型（默认的模型）</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    -i: --ipip，即TUN类型</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    -m: masquerade地址伪装即NAT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                -w: 指定权重（需要调度算法支持权重）</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Modify: -e和-a用法一样</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Delete: -d  -t</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">u</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">f service-address -r server-address表示从哪个virtual service中删除哪个realserver</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Examples: ipvsadm -a -t 172.16.10.20:80 -r 192.168.100.9 -m</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># Examples: ipvsadm -a -t 172.16.10.20:80 -r 192.168.100.10 -m </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">.view:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    -L/-l:      列出状态信息，配合以下选项用于显示更精确数据</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    -n:         只显示数字格式，不反解IP地址和端口</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    --stats:    显示统计信息</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    --rate:     显示速率信息（每秒的值）</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    --timeout:  显示tcp/tcpfin/udp的会话超时时间长度</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    --daemon:   显示进程状态和多播端口（不太用）</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    --sort:     对-n列出来的进行排序（按协议、IP、端口号升序排序）</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    -c:         显示当前ipvs的连接状况（不能和stats选项同用）</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">.others:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    -Z:         清空统计数据</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    -C:         删除一个或所有virtual service，连同与之绑定的real server也删除</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    -S:         保存规则  ipvsadm -S </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /path/to/somefile 或者使用ipvsadm-save </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /path/to/somefile</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    -R:         载入规则  ipvsadm -R </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain"> /path/to/somefile 或者使用ipvsadm-restore </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain"> /path/to/somefile</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token function" style="color:rgb(0, 0, 255)">service</span><span class="token plain"> ipvsadm save</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token function" style="color:rgb(0, 0, 255)">service</span><span class="token plain"> ipvsadm restore</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="107实现-vsnat-模式的负载均衡">10.7、实现 VS/NAT 模式的负载均衡<a href="#107实现-vsnat-模式的负载均衡" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p>实验环境如下：</p><p><img loading="lazy" alt="lvs nat practice" src="/en/assets/images/lvs nat practice-fd68ae8a7fff100b03c6a05311c2efa6.png" width="944" height="442" class="img_ev3q"></p><p>在开始操作前，先回顾下 VS/NAT 模式的相关内容：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">请求过程：CIP--</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">VIP--ip_forward--</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">DIP--</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">RIP</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">响应过程：RIP--</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">DIP--ip_forward--</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">VIP--</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">CIP</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>由于 director 接收到 CIP 发送的数据包后，需要转发给 Real Server 进行处理，但 Real Server 的 RIP 和 DIP 是同一网段的，因此 Director 必须将 VIP 接口上收到的数据包转发给 DIP，也就是说 <strong>Director 需要开启 ip<!-- -->_<!-- -->forward 功能</strong>。</p><p>当 RS 处理完成后，响应数据需要先转发给 Director，但因为<strong>响应数据的目标地址为 CIP，因此需要将 RS 的网关指向 Director 的 DIP</strong>，这样 CIP 目的的数据包才能保证交给 director 进行处理并返回给客户端。</p><p>因此，如下操作 Director：假设该实验中的 VS/NAT 采用 wrr 调度算法。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@director ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># echo 1 &gt;/proc/sys/net/ipv4/ip_forward</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@director ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ipvsadm -A -t 192.168.122.202:80 -s wrr</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@director ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ipvsadm -a -t 192.168.122.202:80 -r 172.16.4.203 -m -w 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@director ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ipvsadm -a -t 192.168.122.202:80 -r 172.16.4.204 -m -w 3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如下操作各 RS：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># realserver1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@realserver1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># yum install httpd -y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@realserver1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># echo &quot;This is page from RS1:172.16.4.203&quot; &gt; /var/www/html/index.html</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@realserver1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># service httpd start</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Redirecting to /bin/systemctl start httpd.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@realserver1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># route del default</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@realserver1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># route add default gw 172.16.4.202</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># realserver2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@realserver2 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># yum install httpd -y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@realserver2 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># echo &quot;This is page from RS2:172.16.4.204&quot; &gt; /var/www/html/index.html</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@realserver2 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># service httpd start</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Redirecting to /bin/systemctl start httpd.service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@realserver2 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># route del default</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@realserver2 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># route add default gw 172.16.4.202</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用 linux 客户端(192.168.122.8) 测试 <a href="http://192.168.122.202/" target="_blank" rel="noopener noreferrer">http://192.168.122.202:80</a>：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># curl http://192.168.122.202</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">This is page from RS1:172.16.4.20</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">3</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># curl http://192.168.122.202</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">This is page from RS2:172.16.4.20</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">4</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># curl http://192.168.122.202</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">This is page from RS2:172.16.4.20</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">4</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># curl http://192.168.122.202</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">This is page from RS1:172.16.4.20</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">3</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># curl http://192.168.122.202</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">This is page from RS2:172.16.4.20</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">4</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># curl http://192.168.122.202</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">This is page from RS1:172.16.4.20</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">3</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># curl http://192.168.122.202</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">This is page from RS2:172.16.4.20</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">4</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># curl http://192.168.122.202</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">This is page from RS2:172.16.4.20</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">4</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>查看 director 主机统计数据：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@director ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ipvsadm -ln --stats</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">IP Virtual Server version </span><span class="token number" style="color:rgb(9, 134, 88)">1.2</span><span class="token plain">.1 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">size</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">4096</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Prot LocalAddress:Port               Conns   InPkts  OutPkts  InBytes OutBytes</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> RemoteAddress:Port</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">TCP  </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.202:80                 </span><span class="token number" style="color:rgb(9, 134, 88)">14</span><span class="token plain">      </span><span class="token number" style="color:rgb(9, 134, 88)">115</span><span class="token plain">       </span><span class="token number" style="color:rgb(9, 134, 88)">78</span><span class="token plain">    </span><span class="token number" style="color:rgb(9, 134, 88)">14586</span><span class="token plain">    </span><span class="token number" style="color:rgb(9, 134, 88)">10292</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.4.203:80                     </span><span class="token number" style="color:rgb(9, 134, 88)">5</span><span class="token plain">       </span><span class="token number" style="color:rgb(9, 134, 88)">35</span><span class="token plain">       </span><span class="token number" style="color:rgb(9, 134, 88)">24</span><span class="token plain">     </span><span class="token number" style="color:rgb(9, 134, 88)">3440</span><span class="token plain">     </span><span class="token number" style="color:rgb(9, 134, 88)">3279</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  -</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">172.16</span><span class="token plain">.4.204:80                     </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">       </span><span class="token number" style="color:rgb(9, 134, 88)">80</span><span class="token plain">       </span><span class="token number" style="color:rgb(9, 134, 88)">54</span><span class="token plain">    </span><span class="token number" style="color:rgb(9, 134, 88)">11146</span><span class="token plain">     </span><span class="token number" style="color:rgb(9, 134, 88)">7013</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@director ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><em>注意事项：</em></p><ol><li><em>VS/NAT 模式下，realserver 上不要配置跟 vip 同网段的 ip 地址，否则会出现请求异常的情况。</em></li><li><em>测试客户端最好使用 linux 系统，使用 curl 命令请求 vip 地址，得到的结果更接近期望值，方便分析。</em></li></ol><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="108实现-vsdr-模式的负载均衡">10.8、实现 VS/DR 模式的负载均衡<a href="#108实现-vsdr-模式的负载均衡" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h2><p><img loading="lazy" alt="lvs dr" src="/en/assets/images/lvs dr-ca6f17d52a4c2e13bb567a37f2aa126d.png" width="993" height="390" class="img_ev3q"></p><p>先说明一下 VS/DR 模式下，Director 的功能：</p><ul><li>在 VS/DR 模式下，TCP 连接是客户端和 RS 之间建立的，Director 只是负责改造、转发建立 TCP 连接时的数据包给后端 RealServer；</li><li>当 TCP 连接建立完成后，就有了客户端和服务端(RS)的概念，这时客户端将直接和 RS 进行数据通信，而 Director 已经退出舞台，不再负责改造、转发请求数据包，直到关闭连接。</li><li>也就是说，Director 改造、转发的数据包只有客户端发送的和 tcp 连接建立、关闭相关的 syn、ack 和 fin 包，其它数据包和它无关(网络状况良好的情况下，共转发 syn+ack、fin+ack 4 个包)。<ul><li>可以想象，这样的 Director 相比 NAT 模式，性能高的不是一点点。</li></ul></li></ul><p>请求应答过程：</p><ol><li>当客户端发起 <code>http://VIP</code> 的请求时，数据包的源和目标地址为 <code>CIP--&gt;VIP</code>。这个数据包最终会到达 Director。</li><li>当 Director 收到请求数据包后，将根据调度算法选择一台后端 RealServer 作为调度的目标。于是修改数据包的目标 MAC 地址为该 RealServer 的 RIP 所在 MAC 地址。数据包将转发给该 RS，此时数据包的源和目标 IP 地址仍然为 <code>CIP--&gt;VIP</code>，但源和目标 MAC 地址为 <code>DIP_MAC--&gt;RIP_MAC</code>。<ul><li>需要注意的是，Director 虽然要将数据包交给 RS，但交出去的这个数据包是修改过目标 MAC 地址的数据包。也就是说，交给 RIP 的数据包不是原包，因此在 Director 上不会经过 ip<!-- -->_<!-- -->forward 转发，而是修改 MAC 后根据路由决策直接路由到 RIP。</li><li>因此，<strong>VS/DR 模式下，Director 无需开启 ip<!-- -->_<!-- -->forward 功能，这一点很容易出现误解</strong>，其实如果搭建过 keepalived+lvs 的 DR，就可以发现 keepalived 管理 ipvs 的时候，并没有开启 ip<!-- -->_<!-- -->forward。</li></ul></li><li>被调度到的 RS 收到 Director 转发的数据包后，发现目标 IP 地址已经配置在自身内核，因此会收下该数据包。之后会处理请求，并构建响应数据。</li><li>RS 将响应数据响应给客户端，该响应数据包的源和目标 IP 地址为 <code>VIP--&gt;CIP</code>。<ul><li>由于 RS 上的 VIP 一般配置在 lo 的别名接口上，它无法和外界直接通信，因此数据包最终会从普通网卡上流出，如 RIP 所在接口。</li><li>根据 TCP/IP 协议，响应数据包的源 MAC 地址也将是普通网卡(如 RIP 所在接口)的 MAC 地址。这一细节在后面配置 CIP、VIP、RIP 不同网段时会引出一种特殊问题，详情见后文。</li></ul></li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1081cipviprip-同网段实验">10.8.1、CIP、VIP、RIP 同网段实验<a href="#1081cipviprip-同网段实验" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>CIP、VIP 和 RIP 同网段时，配置非常简单，几乎无需考虑额外的路由问题，也都无需分析数据包流向问题。</p><p>实验环境如下：</p><p><img loading="lazy" alt="lvs dr practice" src="/en/assets/images/lvs dr practice-81302fc4ab8fdc48c980bcda36f00d79.png" width="1073" height="479" class="img_ev3q"></p><p>配置 Director：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@director ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ipvsadm -C</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@director ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ipvsadm -A -t 192.168.122.9:80 -s wrr</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@director ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ipvsadm -a -t 192.168.122.9:80 -r 192.168.122.203 -g -w 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@director ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ipvsadm -a -t 192.168.122.9:80 -r 192.168.122.204 -g -w 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>配置所有 realservers：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 1.提供web服务和测试页面</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">yum -y </span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> httpd</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;This is page from RS1:172.16.4.203&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /var/www/html/index.html  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 在RS1上操作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;This is page from RS2:172.16.4.204&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /var/www/html/index.html  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 在RS2上操作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">service</span><span class="token plain"> httpd start</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 2.设置arp参数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">/proc/sys/net/ipv4/conf/all/arp_ignore</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">/proc/sys/net/ipv4/conf/all/arp_announce</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 3.设置VIP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">ifconfig</span><span class="token plain"> lo:0 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9 netmask </span><span class="token number" style="color:rgb(9, 134, 88)">255.255</span><span class="token plain">.255.255 up</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">route </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> -host </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9 dev lo:0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>DR 模型中一定要配 lo:0 回环口的路由，不然内核不能用 lo:0 上的 vip 进行封装报文。</li><li>注意即使配了 arp<!-- -->_<!-- -->announce、arp<!-- -->_<!-- -->ignore，一样要将 lo:0 配成 32 位掩码，抑制 arp feedback，而且前面两个内核参数要提前改，因为先配了 ip 就会广播。</li><li>学习 iptables 的章节时，我们就知道<strong>地址是属于内核的，不是属于接口的</strong>，请求内核的地址从哪个接口进来默认从哪个接口出去，不过路由表才是真正具有权威的。</li></ul><p><em>经验分享：</em></p><ul><li><p><em>实验过程中，我第一次没有在 Director 上设置 <code>eth0:0</code> 用作 VIP，而是直接使用 eth0 当 VIP，结果一旦 RealServers 配置了 lo:0 作为 VIP 时，就会跟 Director 上的 eth0 VIP 地址冲突。最终导致 Director 和 RealServers 之间无法通信，即便设置了 arp<!-- -->_<!-- -->announce、arp<!-- -->_<!-- -->ignore，也没有意义，因为地址是属于内核的，这两个参数只是让内核从哪个口如何响应 arp 罢了。</em></p></li><li><p><em>实验过程中如果跟我一样 Director 中只设置了一个 IP 地址，而且作为了 VIP，那么实验过程中你会得到 <code>No route to host</code> 错误。</em></p></li><li><p>为了有一个更直观的理解，把上述拓扑图实验环境配置好，通过客户端(192.168.122.8) 去 curl <a href="http://192.168.122.9/" target="_blank" rel="noopener noreferrer">http://192.168.122.9:80</a> 两次，然后在 Director 的 eth0 接口上抓包，如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@director ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># tcpdump -i eth0 not tcp port 22 -nn</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">tcpdump: verbose output suppressed, use -v or -vv </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> full protocol decode</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">listening on eth0, link-type EN10MB </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">Ethernet</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">, capture size </span><span class="token number" style="color:rgb(9, 134, 88)">262144</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:10.889114 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55976 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">S</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, </span><span class="token function" style="color:rgb(0, 0, 255)">seq</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">4149950767</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">29200</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">mss </span><span class="token number" style="color:rgb(9, 134, 88)">1460</span><span class="token plain">,sackOK,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289129575</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">,nop,wscale </span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:10.889175 ARP, Request who-has </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.203 tell </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.202, length </span><span class="token number" style="color:rgb(9, 134, 88)">28</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:10.889700 ARP, Reply </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.203 is-at </span><span class="token number" style="color:rgb(9, 134, 88)">52</span><span class="token plain">:54:00:0e:05:54, length </span><span class="token number" style="color:rgb(9, 134, 88)">28</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:10.889729 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55976 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">S</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, </span><span class="token function" style="color:rgb(0, 0, 255)">seq</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">4149950767</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">29200</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">mss </span><span class="token number" style="color:rgb(9, 134, 88)">1460</span><span class="token plain">,sackOK,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289129575</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">,nop,wscale </span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:10.890167 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55976 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, ack </span><span class="token number" style="color:rgb(9, 134, 88)">1449142928</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">229</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289129576</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">4290791627</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:10.890203 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55976 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, ack </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">229</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289129576</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">4290791627</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:10.890250 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55976 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">P.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, </span><span class="token function" style="color:rgb(0, 0, 255)">seq</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">:77, ack </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">229</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289129576</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">4290791627</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">77</span><span class="token plain">: HTTP: GET / HTTP/1.1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:10.890258 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55976 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">P.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, </span><span class="token function" style="color:rgb(0, 0, 255)">seq</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">:77, ack </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">229</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289129576</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">4290791627</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">77</span><span class="token plain">: HTTP: GET / HTTP/1.1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:10.890999 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55976 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, ack </span><span class="token number" style="color:rgb(9, 134, 88)">286</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">237</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289129577</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">4290791628</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:10.891042 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55976 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, ack </span><span class="token number" style="color:rgb(9, 134, 88)">286</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">237</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289129577</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">4290791628</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:10.891353 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55976 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">F.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, </span><span class="token function" style="color:rgb(0, 0, 255)">seq</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">77</span><span class="token plain">, ack </span><span class="token number" style="color:rgb(9, 134, 88)">286</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">237</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289129577</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">4290791628</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:10.891389 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55976 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">F.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, </span><span class="token function" style="color:rgb(0, 0, 255)">seq</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">77</span><span class="token plain">, ack </span><span class="token number" style="color:rgb(9, 134, 88)">286</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">237</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289129577</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">4290791628</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:10.891820 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55976 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, ack </span><span class="token number" style="color:rgb(9, 134, 88)">287</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">237</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289129578</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">4290791628</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:10.891851 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55976 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, ack </span><span class="token number" style="color:rgb(9, 134, 88)">287</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">237</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289129578</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">4290791628</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:11.352836 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55978 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">S</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, </span><span class="token function" style="color:rgb(0, 0, 255)">seq</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1099517050</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">29200</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">mss </span><span class="token number" style="color:rgb(9, 134, 88)">1460</span><span class="token plain">,sackOK,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289130039</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">,nop,wscale </span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:11.352899 ARP, Request who-has </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.204 tell </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.202, length </span><span class="token number" style="color:rgb(9, 134, 88)">28</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:11.353344 ARP, Reply </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.204 is-at </span><span class="token number" style="color:rgb(9, 134, 88)">52</span><span class="token plain">:54:00:52:1a:d4, length </span><span class="token number" style="color:rgb(9, 134, 88)">28</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:11.353373 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55978 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">S</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, </span><span class="token function" style="color:rgb(0, 0, 255)">seq</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1099517050</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">29200</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">mss </span><span class="token number" style="color:rgb(9, 134, 88)">1460</span><span class="token plain">,sackOK,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289130039</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">,nop,wscale </span><span class="token number" style="color:rgb(9, 134, 88)">7</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:11.353758 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55978 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, ack </span><span class="token number" style="color:rgb(9, 134, 88)">322887858</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">229</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289130040</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">3849403757</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:11.353796 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55978 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, ack </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">229</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289130040</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">3849403757</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:11.353825 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55978 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">P.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, </span><span class="token function" style="color:rgb(0, 0, 255)">seq</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">:77, ack </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">229</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289130040</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">3849403757</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">77</span><span class="token plain">: HTTP: GET / HTTP/1.1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:11.353833 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55978 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">P.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, </span><span class="token function" style="color:rgb(0, 0, 255)">seq</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">:77, ack </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">229</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289130040</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">3849403757</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">77</span><span class="token plain">: HTTP: GET / HTTP/1.1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:11.354754 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55978 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, ack </span><span class="token number" style="color:rgb(9, 134, 88)">286</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">237</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289130041</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">3849403758</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:11.354799 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55978 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, ack </span><span class="token number" style="color:rgb(9, 134, 88)">286</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">237</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289130041</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">3849403758</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:11.354950 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55978 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">F.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, </span><span class="token function" style="color:rgb(0, 0, 255)">seq</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">77</span><span class="token plain">, ack </span><span class="token number" style="color:rgb(9, 134, 88)">286</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">237</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289130041</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">3849403758</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:11.354982 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55978 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">F.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, </span><span class="token function" style="color:rgb(0, 0, 255)">seq</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">77</span><span class="token plain">, ack </span><span class="token number" style="color:rgb(9, 134, 88)">286</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">237</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289130041</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">3849403758</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:11.355422 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55978 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, ack </span><span class="token number" style="color:rgb(9, 134, 88)">287</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">237</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289130042</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">3849403758</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">12</span><span class="token plain">:27:11.355455 IP </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.8.55978 </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9.80: Flags </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, ack </span><span class="token number" style="color:rgb(9, 134, 88)">287</span><span class="token plain">, win </span><span class="token number" style="color:rgb(9, 134, 88)">237</span><span class="token plain">, options </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nop,nop,TS val </span><span class="token number" style="color:rgb(9, 134, 88)">1289130042</span><span class="token plain"> ecr </span><span class="token number" style="color:rgb(9, 134, 88)">3849403758</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">, length </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">^C</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">61</span><span class="token plain"> packets captured</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">61</span><span class="token plain"> packets received by filter</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> packets dropped by kernel</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@director ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>两次请求的最开始都是 Director arp 广播寻找 RealServers，是 192.168.122.202 找 192.168.122.203/204，不是 VIP 192.168.122.9 找 192.168.122.203/204，不然会跟 RealServers 上的 VIP 冲突。所以 Director 上必须配置除 VIP 外的自己的地址。</li><li>为什么 VS/NAT 上 Director 没有配置 <code>eth0:0</code> 呢？因为这种模式 RealServers 没有 VIP，而且寻址逻辑完全不同。</li><li>另外通过这两次请求的 Director arp 寻址，正好可以感受到 ipvsadm 修改 MAC 地址的精髓。</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1082cipviprip-不同网段实验">10.8.2、CIP、VIP、RIP 不同网段实验<a href="#1082cipviprip-不同网段实验" class="hash-link" aria-label="Direct link to heading" title="Direct link to heading">​</a></h3><p>考虑实际的生产环境，由于公网地址有限，一般只给 web server 的负载均衡系统分配一个公网地址。这个公网地址可能直接分配给 VIP，这样 CIP、VIP、RIP 两两都处于不同网段；还可能分配给路由器或防火墙，然后 VIP 和 RIP 都是用私网地址，这样 VIP/RIP 同网段，但它们和 CIP 不同网段。</p><p>不管公网地址分配给谁，CIP、RIP 总是不同网段的。这时需要考虑以下几个问题：</p><ol><li>RS 将响应数据响应给客户端，该响应数据包的源和目标 IP 地址为 <code>VIP--&gt;CIP</code>，但因为是从 RIP 所在网卡流出的，这个响应数据包的源 MAC 地址为 MAC<!-- -->_<!-- -->RIP；</li><li>由于 RIP 和 CIP 不同网段，因此 RS 需要借助某个路由设备来转发这个数据包；</li><li>由于 RS 上的 VIP 被隐藏，DIP/RIP 所在网段的所有主机(包括这个路由设备)上缓存的关于 VIP 的 arp 记录都是 Director 上的(即 <code>VIP&lt;--&gt;MAC_V</code>)，即使重新发起 arp 请求，也只能获取到这样的对应关系。<ul><li>因此，响应数据包的源 IP、源 MAC 的对应关系和路由设备 arp 缓存中记录不一致，这个响应数据包是 &quot;非法&quot; 数据包。</li></ul></li><li>这个路由设备发现数据包的源 MAC 地址、源 IP 和它 arp 缓存中的记录不一致，它会丢弃这个数据包吗？分两种情况：<ul><li>如果这个数据包被路由到普通的路由设备上，路由设备默认不会检查源地址是否合法。这种检查称为 &quot;reverse path filter&quot;(反向路径过滤)功能。默认 Linux 主机会做反向检查，Linux 上控制该功能的参数为 rp<!-- -->_<!-- -->filter。</li><li>如果这个数据包被路由到 Director 所在主机(Linux)上，默认会丢弃这个数据包，因为源 IP 地址正好在本机上。但可以为内核打上 forward<!-- -->_<!-- -->shared 补丁，以便使用 forward<!-- -->_<!-- -->shared 和 rp<!-- -->_<!-- -->filter 参数来开启转发源 IP 地址为自身地址数据包的功能。转发时，需要设置转发接口为 VIP 所在接口，这样数据包的源 MAC 地址和 VIP 相互对应，之后的路由过程会一路顺畅。</li></ul></li></ol><p>根据第四点的 2 种情况，Director 与 RS 之间的路由器有如下两个选择：</p><ul><li>第一种情况设置很简单，但 Linux 充当路由设备关闭源 IP 地址检查功能后，将更容易受到 DDos 攻击。</li><li>第二种情况可以忽略，不仅要重新编译内核，更重要的是 VS/DR 模式的优点本就在于让 Director 专注于调度工作来实现高性能，而不应该让其帮助转发。</li></ul><p>因此，本文将以第一种情况来做实验测试。</p><p>以下是 <a href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt" target="_blank" rel="noopener noreferrer">Linux内核文档</a> 中关于rp<!-- -->_<!-- -->filter变量的描述：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">rp_filter - INTEGER</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> - No </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain"> validation.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> - Strict mode as defined </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> RFC3704 Strict Reverse Path</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        Each incoming packet is tested against the FIB and </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> the interface</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        is not the best reverse path the packet check will fail.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        By default failed packets are discarded.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> - Loose mode as defined </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> RFC3704 Loose Reverse Path</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        Each incoming packet&#x27;s </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain"> address is also tested against the FIB</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        and </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> the </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain"> address is not reachable via any interface</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        the packet check will fail.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Current recommended practice </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> RFC3704 is to </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"> strict mode</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    to prevent IP spoofing from DDos attacks. If using asymmetric routing</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    or other complicated routing, </span><span class="token keyword" style="color:rgb(0, 0, 255)">then</span><span class="token plain"> loose mode is recommended.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    The max value from conf/</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">all,interface</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain">/rp_filter is used</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    when doing </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">source</span><span class="token plain"> validation on the </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">interface</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Default value is </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">. Note that some distributions </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"> it</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> startup scripts.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>0：不开启源地址校验。</li><li>1：开启严格的反向路径校验。对每个进来的数据包，校验其反向路径是否是最佳路径(<strong>通过特定接口</strong>)。如果反向路径不是最佳路径，则直接丢弃该数据包。</li><li>2：开启松散的反向路径校验。对每个进来的数据包，校验其源地址是否可达，即反向路径是否能通（<strong>通过任意接口</strong>），如果反向路径不通，则直接丢弃该数据包。这个值只是为了防止转发无效或冒充的源 IP 地址，如 192.16.10 这样的不完整 IP。</li><li>取 /proc/sys/net/ipv4/conf/{all,interface}/rp<!-- -->_<!-- -->filter 中的最大值生效。注意，对 lo 接口设置该参数是无意义的。</li></ul><p>为了更好地解决实际生产问题，我专门就自己的工作环境设计了一张拓扑图，如果有需要，我会以此设计方案作为生产环境，如下图：</p><p><img loading="lazy" alt="lvs dr production" src="/en/assets/images/lvs dr production-9504038a2bf1c02d9af3a7094c69ed65.png" width="927" height="601" class="img_ev3q"></p><p>配置 lvs 比较简单，几条命令就可以了，真正的难点在网络架构如何设计，这里并没有加上 HA 高可用，所以相对来说还比较简单。把这个实验搞懂，再加个 keepalived 也不在话下。</p><p>Director 配置：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@director ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ipvsadm -C</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@director ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ipvsadm -A -t 192.168.122.9:80 -s wrr</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@director ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ipvsadm -a -t 192.168.122.9:80 -r 172.16.4.203 -g -w 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@director ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ipvsadm -a -t 192.168.122.9:80 -r 172.16.4.204 -g -w 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 添加 vip，我这里使用 ip add 添加的，跟 ifconfig eth0:0 一样，都是临时生效，生产上一定要写在配置文件中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@director ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># ip add add 192.168.122.9/24 dev eth0 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>所有 RealServers 配置：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 1.提供web服务和测试页面</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">yum -y </span><span class="token function" style="color:rgb(0, 0, 255)">install</span><span class="token plain"> httpd</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;This is page from RS1:172.16.4.203&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /var/www/html/index.html  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 在RS1上操作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;This is page from RS2:172.16.4.204&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> /var/www/html/index.html  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 在RS2上操作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">service</span><span class="token plain"> httpd start</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 2.设置arp参数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">/proc/sys/net/ipv4/conf/all/arp_ignore</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">/proc/sys/net/ipv4/conf/all/arp_announce</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 3.设置VIP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">ifconfig</span><span class="token plain"> lo:0 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9 netmask </span><span class="token number" style="color:rgb(9, 134, 88)">255.255</span><span class="token plain">.255.255 up</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">route </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> -host </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.9 dev lo:0</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 4.一定要注意，网关不能指向director，而是要指向router，我在网络配置文件中写好了，按照上面拓扑去设置</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此时，如果通过客户端(192.168.122.1) 去请求 vip(192.168.122.9)，结果是不通的，这是 VS/DR 模式下跨网段的特殊性，重点在这个 router 上，理论上面分析得很详细，如下设置 router 即可完成配置：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@router ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@router ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># echo 2 &gt; /proc/sys/net/ipv4/conf/all/rp_filter</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>这个 router 是 linux 主机，所以必须配置 rp<!-- -->_<!-- -->filter，上一小节是同网段，不需要走三层路由，所以可以不用设置 rp<!-- -->_<!-- -->filter。</li></ul><p>客户端再测试，没有问题：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># curl 192.168.122.9</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">This is page from RS1:172.16.4.20</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">3</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># curl 192.168.122.9</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">This is page from RS1:172.16.4.20</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">3</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># curl 192.168.122.9</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">This is page from RS2:172.16.4.20</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">4</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># curl 192.168.122.9</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">This is page from RS1:172.16.4.20</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">3</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># curl 192.168.122.9</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">This is page from RS1:172.16.4.20</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">3</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># curl 192.168.122.9</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">This is page from RS2:172.16.4.20</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">4</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/en/docs/linux-advanced-14"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">第 14 章 Linux haproxy 服务高级配置</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/en/docs/linux-advanced-16"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">第 16 章 Linux Keepalived 服务配置</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#101lvs-简介" class="table-of-contents__link toc-highlight">10.1、LVS 简介</a></li><li><a href="#102lvs-ipvs-三种模式的工作原理" class="table-of-contents__link toc-highlight">10.2、LVS-ipvs 三种模式的工作原理</a><ul><li><a href="#1021vsnat-模式" class="table-of-contents__link toc-highlight">10.2.1、VS/NAT 模式</a></li><li><a href="#1022vstun-模式" class="table-of-contents__link toc-highlight">10.2.2、VS/TUN 模式</a></li><li><a href="#1023vsdr-模式" class="table-of-contents__link toc-highlight">10.2.3、VS/DR 模式</a></li><li><a href="#1024lvs-ipvs-的三种模式比较" class="table-of-contents__link toc-highlight">10.2.4、lvs-ipvs 的三种模式比较</a></li></ul></li><li><a href="#103vstun-和-vsdr-模式中的-arp-问题" class="table-of-contents__link toc-highlight">10.3、VS/TUN 和 VS/DR 模式中的 ARP 问题</a></li><li><a href="#104lvs-负载均衡的调度算法" class="table-of-contents__link toc-highlight">10.4、LVS 负载均衡的调度算法</a></li><li><a href="#105ipvsadm-命令" class="table-of-contents__link toc-highlight">10.5、ipvsadm 命令</a></li><li><a href="#106ipvsadm-语法" class="table-of-contents__link toc-highlight">10.6、ipvsadm 语法</a></li><li><a href="#107实现-vsnat-模式的负载均衡" class="table-of-contents__link toc-highlight">10.7、实现 VS/NAT 模式的负载均衡</a></li><li><a href="#108实现-vsdr-模式的负载均衡" class="table-of-contents__link toc-highlight">10.8、实现 VS/DR 模式的负载均衡</a><ul><li><a href="#1081cipviprip-同网段实验" class="table-of-contents__link toc-highlight">10.8.1、CIP、VIP、RIP 同网段实验</a></li><li><a href="#1082cipviprip-不同网段实验" class="table-of-contents__link toc-highlight">10.8.2、CIP、VIP、RIP 不同网段实验</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">笔记</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/docs/category/存储">存储</a></li><li class="footer__item"><a class="footer__link-item" href="/en/tags">Tags</a></li><li class="footer__item"><a class="footer__link-item" href="/en/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/en/project">Projects</a></li><li class="footer__item"><a class="footer__link-item" href="/en/docs/linux">Linux</a></li></ul></div><div class="col footer__col"><div class="footer__title">Social Media</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/about">About Me</a></li><li class="footer__item"><a href="https://github.com/zqingfa" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://juejin.cn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Juejin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" position="right" href="/en/friends">Friends</a></li><li class="footer__item"><a class="footer__link-item" position="right" href="/en/website">Links</a></li><li class="footer__item"><a href="https://docusaurus.io/zh-CN/" target="_blank"><img style="height:50px;margin-top:0.5rem" src="/img/buildwith.png"><a></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p><a href="http://beian.miit.gov.cn/">浙ICP备20024502号-1</a></p><p>Copyright © 2022 – PRESENT zhangqf Built with Docusaurus.</p></div></div></div></footer></div>
<script src="/en/assets/js/runtime~main.403f05fc.js"></script>
<script src="/en/assets/js/main.4747bdb7.js"></script>
</body>
</html>