<!doctype html>
<html lang="en-GB" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-linux/advanced/linux-advanced-12">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">第 12 章 Linux haproxy 服务基础配置 - Linux技术分享</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://zhangqf.com/en/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://zhangqf.com/en/img/logo.png"><meta data-rh="true" property="og:url" content="https://zhangqf.com/en/docs/linux-advanced-12"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="第 12 章 Linux haproxy 服务基础配置 - Linux技术分享"><meta data-rh="true" name="description" content="官方站点：http://www.haproxy.org/"><meta data-rh="true" property="og:description" content="官方站点：http://www.haproxy.org/"><meta data-rh="true" name="keywords" content="linux,haproxy"><link data-rh="true" rel="icon" href="/en/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://zhangqf.com/en/docs/linux-advanced-12"><link data-rh="true" rel="alternate" href="https://zhangqf.com/en/docs/linux-advanced-12" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/linux-advanced-12" hreflang="zh"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/linux-advanced-12" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9B0V5WT2X8-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S4SD5NXWXF"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S4SD5NXWXF",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Linux技术分享" href="/en/opensearch.xml">
<link rel="preconnect" href="https://zhangqf.com/">
<script>var _paq=window._paq=window._paq||[];_paq.push(["setRequestMethod","POST"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),_paq.push(["enableHeartBeatTimer"]),function(){var e="https://zhangqf.com/";_paq.push(["setRequestMethod","POST"]),_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]);var a=document,t=a.createElement("script"),p=a.getElementsByTagName("script")[0];t.type="text/javascript",t.async=!0,t.src=e+"matomo.js",p.parentNode.insertBefore(t,p)}()</script>


<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c9a3849aa75f9c4a4e65f846cd1a5155",e.defer=!0;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<meta name="baidu-site-verification" content="code-rqLUw5reVS">
<script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",t.defer=!0;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script>
<link rel="alternate" type="application/rss+xml" href="/en/rss.xml" title="zhangqf RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/atom.xml" title="zhangqf Atom Feed">
<link rel="alternate" type="application/json" href="/en/feed.json" title="zhangqf JSON Feed">

<link rel="icon" href="/en/img/logo.png">
<link rel="manifest" href="/en/manifest.json">
<meta name="theme-color" content="rgb(51 139 255)"><link rel="stylesheet" href="/en/assets/css/styles.86c9ae18.css">
<link rel="preload" href="/en/assets/js/runtime~main.3ab0938b.js" as="script">
<link rel="preload" href="/en/assets/js/main.7af82c56.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><span>更新 <a href="/website">网址导航</a> 带你发现感兴趣的技术</span></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">kuizuo</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/en/docs/linux">Linux</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/en/docs/category/Linux基础">Linux 基础</a></li><li><a class="dropdown__link" href="/en/docs/category/Linux进阶">Linux 进阶</a></li><li><a class="dropdown__link" href="/en/docs/category/Linux测试">Linux 测试</a></li><li><a class="dropdown__link" href="/en/docs/category/LinuxCICD">Linux CICD研发</a></li><li><a class="dropdown__link" href="/en/docs/skill/">Notes</a></li><li><a class="dropdown__link" href="/en/docs/tools/">Recommended Tools</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Blog</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/en/tags">Tags</a></li><li><a class="dropdown__link" href="/en/archive">Archive</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Tools</a><ul class="dropdown__menu"><li><a href="https://api.kuizuo.cn" target="_blank" rel="noopener noreferrer" class="dropdown__link">API Service</a></li><li><a href="https://js-de-obfuscator.vercel.app" target="_blank" rel="noopener noreferrer" class="dropdown__link">JS Deobfuscate</a></li><li><a href="https://cipher.kuizuo.cn" target="_blank" rel="noopener noreferrer" class="dropdown__link">CyberChef Encryption</a></li></ul></div><a class="navbar__item navbar__link" href="/en/website">Links</a><a class="navbar__item navbar__link" href="/en/project">Projects</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/en/"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"><b>kuizuo</b></a><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/linux">linux</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linux基础">Linux基础</a><button aria-label="Toggle the collapsible sidebar category &#x27;Linux基础&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/en/docs/category/linux进阶">Linux进阶</a><button aria-label="Toggle the collapsible sidebar category &#x27;Linux进阶&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-1">第 1 章 Linux 进阶命令</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-2">第 2 章 Linux 防火墙</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-3">第 3 章 Linux NFS 网络文件系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-4">第 4 章 Linux DHCP 服务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-5">第 5 章 Linux DNS 服务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-6">第 6 章 Linux httpd 服务基础配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-7">第 7 章 Linux httpd 服务进阶配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-8">第 8 章 Linux httpd 服务高级配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-9">第 9 章 Linux Nginx 服务配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-10">第 10 章 Linux Tomcat 服务基础配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-11">第 11 章 Linux Tomcat 服务实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/en/docs/linux-advanced-12">第 12 章 Linux haproxy 服务基础配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-13">第 13 章 Linux haproxy 服务进阶配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-14">第 14 章 Linux haproxy 服务高级配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-15">第 15 章 Linux LVS 服务配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-16">第 16 章 Linux Keepalived 服务配置</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linux测试">Linux测试</a><button aria-label="Toggle the collapsible sidebar category &#x27;Linux测试&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linuxcicd">LinuxCICD</a><button aria-label="Toggle the collapsible sidebar category &#x27;LinuxCICD&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/en/docs/category/linux进阶"><span itemprop="name">Linux进阶</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">第 12 章 Linux haproxy 服务基础配置</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>第 12 章 Linux haproxy 服务基础配置</h1></header><p>官方站点：<a href="http://www.haproxy.org/" target="_blank" rel="noopener noreferrer">http://www.haproxy.org/</a></p><p>HAProxy 是一个使用 C 语言编写的自由及开放源代码软件，其提供高可用性、负载均衡，以及基于 TCP 和 HTTP 的应用程序代理。</p><p>HAProxy 特别适用于那些负载特大的 web 站点，这些站点通常又需要会话保持或七层处理。HAProxy 运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的 web 服务器不被暴露到网络上。</p><p>HAProxy 实现了一种事件驱动，单一进程模型，此模型支持非常大的并发连接数。多进程或多线程模型受内存限制 、系统调度器限制以及无处不在的锁限制，很少能处理数千并发连接。</p><p><a href="https://baike.baidu.com/item/%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9E%8B/1419787" target="_blank" rel="noopener noreferrer">事件驱动模型</a>因为在有更好的资源和时间管理的用户空间(User-Space) 实现所有这些任务，所以没有这些问题。此模型的弊端是，在多核系统上，这些程序通常扩展性较差。这就是为什么他们必须进行优化以使每个 CPU 时间片(Cycle)做更多的工作。</p><p>包括 <a href="https://baike.baidu.com/item/GitHub" target="_blank" rel="noopener noreferrer">GitHub</a>、<a href="https://baike.baidu.com/item/Bitbucket" target="_blank" rel="noopener noreferrer">Bitbucket</a>、Stack Overflow、<a href="https://baike.baidu.com/item/Reddit" target="_blank" rel="noopener noreferrer">Reddit</a>、<a href="https://baike.baidu.com/item/Tumblr" target="_blank" rel="noopener noreferrer">Tumblr</a>、<a href="https://baike.baidu.com/item/Twitter" target="_blank" rel="noopener noreferrer">Twitter</a> 和 <a href="https://baike.baidu.com/item/Tuenti" target="_blank" rel="noopener noreferrer">Tuenti</a> 在内的知名网站，及亚马逊网络服务系统都使用了 HAProxy。</p><p><em>注意：本篇及后续对 haproxy 的讲解融合了 haproxy v1.7 到 haproxy v2.5 版本，因为生产环境上我都在用。单一针对某个版本没有必要，因为大版本之间的变化对于使用者来说，不过是废弃一些选项，新增一些选项而已。</em></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="91安装-haproxy">9.1、安装 haproxy<a class="hash-link" href="#91安装-haproxy" title="Direct link to heading">​</a></h2><p>CentOS 操作系统的官方源中都自带 haproxy，但是版本都比较老。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cat /etc/redhat-release </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">CentOS Linux release </span><span class="token number" style="color:rgb(9, 134, 88)">7.9</span><span class="token plain">.2009 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">AltArch</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># uname -a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Linux armv8_1 </span><span class="token number" style="color:rgb(9, 134, 88)">4.18</span><span class="token plain">.0-193.28.1.el7.aarch64 </span><span class="token comment" style="color:rgb(0, 128, 0)">#1 SMP Wed Oct 21 16:25:35 UTC 2020 aarch64 aarch64 aarch64 GNU/Linux</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># yum info haproxy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Loaded plugins: fastestmirror</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Loading mirror speeds from cached hostfile</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Available Packages</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Name        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Arch        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> aarch64</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Version     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1.5</span><span class="token plain">.18</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Release     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">.el7_9.1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Size        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">809</span><span class="token plain"> k</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Repo        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> updates/7/aarch64</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Summary     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> TCP/HTTP proxy and load balancer </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> high availability environments</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">URL         </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> http://www.haproxy.org/</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">License     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> GPLv2+</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Description </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> HAProxy is a TCP/HTTP reverse proxy </span><span class="token function" style="color:rgb(0, 0, 255)">which</span><span class="token plain"> is particularly suited </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> high</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> availability environments. Indeed, it can:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">  - route HTTP requests depending on statically assigned cookies</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">  - spread load among several servers </span><span class="token keyword" style="color:rgb(0, 0, 255)">while</span><span class="token plain"> assuring server persistence</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">    through the use of HTTP cookies</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">  - switch to backup servers </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> the event a main server fails</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">  - accept connections to special ports dedicated to </span><span class="token function" style="color:rgb(0, 0, 255)">service</span><span class="token plain"> monitoring</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">  - stop accepting connections without breaking existing ones</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">  - add, modify, and delete HTTP headers </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> both directions</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">  - block requests matching particular patterns</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">  - report detailed status to authenticated </span><span class="token function" style="color:rgb(0, 0, 255)">users</span><span class="token plain"> from a URI</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain">    intercepted by the application</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当前最新的稳定版本为 haproxy-2.5.0，下面进行编译安装。</p><p>编译安装 haproxy 时，可以借助于 pcre 环境，该环境下编译时借助正则表达式分析编译速度会快很多，但是没有该环境也可以安装。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># yum install pcre pcre-devel -y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># yum groups install &quot;Development Tools&quot; -y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># tar xf haproxy-2.5.0.tar.gz </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># cd haproxy-2.5.0/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 haproxy-2.5.0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># make TARGET=linux-glibc PREFIX=/usr/local/haproxy USE_PCRE=1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 haproxy-2.5.0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># make install PREFIX=/usr/local/haproxy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用 make help 查看编译设置，TARGET 设置操作系统和版本，然后自动开启相关特性。haproxy v2.0 以前通过 linux22、linux24、linux26、linux2628 进行设置，haproxy v2.0 以后的版本废弃了这种设置，只提供以下选项：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">TARGET not set, you may pass </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;TARGET=xxx&#x27;</span><span class="token plain"> to </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">set</span><span class="token plain"> one among </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  linux-glibc, linux-glibc-legacy, solaris, freebsd, dragonfly, netbsd,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  osx, openbsd, aix51, aix52, aix72-gcc, cygwin, haiku, generic,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  custom</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>区别可以使用如下方式查看：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 haproxy-2.5.0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># make help TARGET=generic</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Current TARGET: generic</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Enabled features </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> TARGET </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;generic&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">disable with </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;USE_xxx=&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  POLL TPROXY SLZ</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 haproxy-2.5.0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># make help TARGET=linux-glibc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Current TARGET: linux-glibc</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Enabled features </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> TARGET </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;linux-glibc&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">disable with </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;USE_xxx=&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  EPOLL NETFILTER POLL THREAD BACKTRACE TPROXY LINUX_TPROXY LINUX_SPLICE</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  LIBCRYPT CRYPT_H GETADDRINFO ACCEPT4 SLZ CPU_AFFINITY TFO NS DL RT</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  PRCTL THREAD_DUMP</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>使用 USE<!-- -->_<!-- -->PCRE=1 表示使用 PCRE 环境编译，加快编译速度。</li></ul><p>编译安装完成后，只有 3 个目录：doc、share 和 sbin，sbin 里面只有一个 haproxy 的主程序 haproxy，所以要手动创建几个文件才行。</p><ol><li>创建 haproxy.cfg 配置文件</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># vim /etc/haproxy/haproxy.cfg </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">global</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    log         </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1 local2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">chroot</span><span class="token plain">      /var/lib/haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    pidfile     /var/run/haproxy.pid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    maxconn     </span><span class="token number" style="color:rgb(9, 134, 88)">20000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    user        haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    group       haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    daemon</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stats socket /var/lib/haproxy/stats</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    spread-checks </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">defaults</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    mode                    http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    log                     global</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option                  httplog</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option                  dontlognull</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option http-server-close</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option forwardfor       except </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.0/8</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option                  redispatch</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> http-request    2s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> queue           3s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> connect         1s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> client          10s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> server          2s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> http-keep-alive 10s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> check           2s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    maxconn                 </span><span class="token number" style="color:rgb(9, 134, 88)">18000</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">frontend http-in</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain">             *:80</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    mode             http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    log              global</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    capture request  header Host len </span><span class="token number" style="color:rgb(9, 134, 88)">20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    capture request  header Referer len </span><span class="token number" style="color:rgb(9, 134, 88)">60</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    acl url_static   path_beg  -i /static /images /stylesheets</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    acl url_static   path_end  -i .jpg .jpeg .gif .png .ico .bmp .css .js</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    acl url_static   path_end  -i .html .htm .shtml .shtm .pdf .mp3 .mp4 .rm .rmvb .txt</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    acl url_static   path_end  -i .zip .rar .gz .tgz .bz2 .tgz</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    use_backend      StaticGroup   </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> url_static</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    default_backend  DynamicGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">backend StaticGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    balance            roundrobin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option             http-keep-alive</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http-reuse         safe</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option httpchk     GET /index.html</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http-check </span><span class="token function" style="color:rgb(0, 0, 255)">expect</span><span class="token plain">  status </span><span class="token number" style="color:rgb(9, 134, 88)">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server staticsrv1  </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.14:80 check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">5000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server staticsrv2  </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.15:80 check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">5000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">backend DynamicGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    cookie appsrv insert nocache</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    balance roundrobin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option http-server-close</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option httpchk     GET /index.php</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http-check </span><span class="token function" style="color:rgb(0, 0, 255)">expect</span><span class="token plain">  status </span><span class="token number" style="color:rgb(9, 134, 88)">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server appsrv1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.12:80  check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">3000</span><span class="token plain"> cookie appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server appsrv2 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.13:80  check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">3000</span><span class="token plain"> cookie appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">listen report_stats</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain"> *:8081</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        stats </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        stats hide-version</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        stats uri    /hastats</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        stats realm  </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;pls enter your name&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        stats auth   admin:admin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        stats admin  </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> TRUE</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>创建 systemd 管理 haproxy 的配置文件 haproxy.service</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># vim /usr/lib/systemd/system/haproxy.service </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Description</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">Haproxy Service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">After</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">syslog.target network.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">forking</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecStart</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/usr/local/haproxy/sbin/haproxy -f /etc/haproxy/haproxy.cfg</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecStop</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">cd</span><span class="token operator" style="color:rgb(0, 0, 0)">&amp;&amp;</span><span class="token plain">/usr/local/haproxy/sbin/</span><span class="token operator" style="color:rgb(0, 0, 0)">&amp;&amp;</span><span class="token function" style="color:rgb(0, 0, 255)">pkill</span><span class="token plain"> haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">WantedBy</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">multi-user.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>haproxy.cfg 配置文件中的 <code>stats socket /var/lib/haproxy/stats</code> 指令要提前创建文件</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># mkdir /var/lib/haproxy/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># touch /var/lib/haproxy/stats</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4"><li>启动 haproxy 服务</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@armv8_1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># systemctl start haproxy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="92haproxy-命令">9.2、haproxy 命令<a class="hash-link" href="#92haproxy-命令" title="Direct link to heading">​</a></h2><p>详细内容参见：<a href="http://cbonte.github.io/haproxy-dconv/" target="_blank" rel="noopener noreferrer">http://cbonte.github.io/haproxy-dconv/</a></p><p>介绍几个常用的：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 检查配置文件语法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">haproxy -c -f /etc/haproxy/haproxy.cfg</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 以daemon模式启动，以systemd管理的daemon模式启动</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">haproxy -D -f /etc/haproxy/haproxy.cfg </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">-p /var/run/haproxy.pid</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">haproxy -Ds -f /etc/haproxy/haproxy.cfg </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">-p /var/run/haproxy.pid</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 启动调试功能，将显示所有连接和处理信息在屏幕</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">haproxy -d -f /etc/haproxy/haproxy.cfg</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># restart。需要使用st选项指定pid列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">haproxy -f /etc/haproxy.cfg </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">-p /var/run/haproxy.pid</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> -st </span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token variable function" style="color:rgb(0, 0, 255)">cat</span><span class="token variable" style="color:rgb(9, 134, 88)"> /var/run/haproxy.pid</span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># graceful restart，即reload。需要使用sf选项指定pid列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">haproxy -f /etc/haproxy.cfg </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">-p /var/run/haproxy.pid</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> -sf </span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token variable function" style="color:rgb(0, 0, 255)">cat</span><span class="token variable" style="color:rgb(9, 134, 88)"> /var/run/haproxy.pid</span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 显示haproxy编译和启动信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">haproxy -vv</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>需要注意的是，restart 会直接关掉旧进程并建立新进程，所以会丢弃大量已建立的连接，而 reload 会启动新进程，但旧进程会先处理完当前已建立连接然后再关闭。</p><p>但是，reload 仍然会丢弃极少量的连接，虽然大多数情况下这足够完美了，但是在极度严格的环境下，这是不允许的。</p><p>haproxy 1.8 版本后，提供了完全不丢弃连接的无损重启，要求 haproxy 启动命令中加入 -x 选项，同时要求 haproxy 配置文件的 &quot;stats socket&quot; 配置中加入 expose-fd listeners，比如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">stats socket /var/run/haproxy.sock mode </span><span class="token number" style="color:rgb(9, 134, 88)">600</span><span class="token plain"> expose-fd listeners level user</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用 -x 选项以及 expose-fd listeners 之后，reload haproxy 的时候，会将已建立 TCP 连接(TCP 套接字)转移到 Unix Domain 状态套接字中进行处理。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="93haproxy-丰富特性">9.3、haproxy 丰富特性<a class="hash-link" href="#93haproxy-丰富特性" title="Direct link to heading">​</a></h2><p>haproxy 是一款负载均衡软件，它工作在 7 层模型上，可以分析数据包中的应用层协议，并按规则进行负载。通常这类 7 层负载工具也称为反向代理软件，nginx 是另一款著名的反向代理软件。</p><p>haproxy 支持使用 splice() 系统调用，它可以将数据在两个套接字之间在内核空间直接使用管道进行传递，无需再在 <code>kernel buffer --&gt; app buffer --&gt; kernel</code> 之间来回复制数据，实现零复制转发(Zero-copy forwarding)，还可以实现零复制启动(zero-starting)。</p><p>haproxy 默认对客户端的请求和对服务端的响应数据都开启了 splice 功能，它自身对数据状态进行判断，决定此数据是否启用 splice() 进行管道传递，这能极大提高性能。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="931haproxy-的特性1连接保持和连接关闭">9.3.1、haproxy 的特性(1)：连接保持和连接关闭<a class="hash-link" href="#931haproxy-的特性1连接保持和连接关闭" title="Direct link to heading">​</a></h3><p>先说明 HTTP 协议事务模型。</p><p>http 协议是事务驱动的，意味着每个 request 产生且仅产生一个 response。客户端发送请求时，将建立一个从客户端到服务端的 TCP 连接，客户端发送的每一个 request 都经过此连接传送给服务端，然后服务端发出 response 报文。随后这个 TCP 连接将关闭，下一个 request 将重新打开一个 tcp 连接进行传送。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">conn1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">req1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">resp1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">close1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">conn2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">req2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">resp2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">close2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>这种模式称为 <strong>&quot;http close&quot;</strong> 模式。这种模式下，有多少个 http 事务就有多少个连接，且每发出一个 response 就关闭一次 tcp 连接。这种情况下，客户端不知道 response 中 body 的长度。</li><li>如果 &quot;http close&quot; 可以避免 &quot;tcp 连接随 response 而关闭&quot;，那么它的性能就可以得到一定程度的提升，因为频繁建立和关闭 tcp 连接消耗的资源和时间是较大的。</li></ul><p>那么如何进行提升？在 server 端发送 response 时给出 <code>content-length</code> 的标记，让客户端知道还有多少内容没有接收到，没有接收完则 tcp 连接不关闭。这种模式称为 <strong>&quot;keep-alive&quot;</strong>。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">conn</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">req1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">resp1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">req2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">resp2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">close</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>另一种提升 &quot;http close&quot; 的方式是 <strong>&quot;pipelining&quot;</strong> 模式。它仍然使用 &quot;keep-alive&quot; 模式，但是客户端不需要等待收到服务端的 response 后才发送后续的 request。这在请求一个含有大量图片的页面时很有用。这种模式类似于累积报文数量成一批或完成后才一次性发送，能很好的提升性能。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">conn</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">req1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">req2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">resp1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">resp2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">close</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>很多 http 代理不支持 pipelining，因为它们无法将 response 和相应的 request 在一个 http 协议中联系起来，而 haproxy 可以在 pipelinign 模式下对报文进行重组。</p><p>默认 haproxy 操作在 keep-alive 模式：对于每一个 tcp 连接，它处理每一个 request 和 response，并且在发送 response 后连接两端都处于空闲状态一段时间，如果该连接的客户端发起新的 request，则继续使用此连接。</p><p>haproxy 支持 5 种连接模式：</p><ol><li><code>keep alive</code>：分析并处理所有的 request 和 response(默认)，<strong>后端为静态或缓存服务器建议使用此模式</strong>。</li><li><code>tunnel</code>：仅分析处理第一个 request 和 response，剩余所有内容不进行任何分析直接转发。1.5 版本之前此为默认，现在不建议设置为此模式。</li><li><code>passive close</code>：在请求和响应首部加上 &quot;connection:close&quot; 标记的 tunnel，在处理完第一个 request 和 response 后尝试关闭两端连接。</li><li><code>server close</code>：处理完第一个 response 后关闭和 server 端的连接，但和客户端的连接仍然保持，<strong>后端为动态应用程序服务器组建议使用此模式</strong>。</li><li><code>forced close</code>：传输完一个 response 后客户端和服务端都关闭连接。</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="932haproxy-的特性2会话保持">9.3.2、haproxy 的特性(2)：会话保持<a class="hash-link" href="#932haproxy-的特性2会话保持" title="Direct link to heading">​</a></h3><p>任何一个反向代理软件，都必须具备这个基本的功能，因为 http 是 &quot;<strong>无状态</strong>&quot; 的。这主要针对后端是应用服务器的情况，如果后端是静态服务器或缓存服务器，无需实现会话保持。</p><p>如果反向代理的后端提供的是 &quot;有状态&quot; 的服务或协议时，必须保证请求过一次的客户端能被引导到同一服务端上。只有这样，服务端才能知道这个客户端是它曾经处理过的，能查到并获取到和该客户端对应的上下文环境(session 上下文)，有了这个 session 环境才能继续为该客户端提供后续的服务。</p><ul><li>简单举个例子，客户端 A 向服务端 B 请求将 C 商品加入它的账户购物车，加入成功后，服务端 B 会在某个缓存中记录下客户端 A 和它的商品 C，这个缓存的内容就是 session 上下文环境。<ul><li>而识别客户端的方式一般是设置 session ID(如 PHPSESSID、JSESSIONID)，并将其作为 cookie 的内容交给客户端。</li><li>客户端 A 再次请求的时候(比如将购物车中的商品下订单)只要携带这个 cookie，服务端 B 就可以从中获取到 session ID 并找到属于客户端 A 的缓存内容，也就可以继续执行下订单部分的代码。</li></ul></li><li>假如这时使用负载均衡软件对客户端的请求进行负载，如果这个负载软件只是简单地进行负载转发，就无法保证将客户端 A 引导到服务端 B，可能会引导到服务端 X、服务端 Y，但是 X、Y 上并没有缓存和客户端 A 对应的 session 内容，当然也无法为客户端 A 下订单。</li></ul><p>因此，反向代理软件必须具备将客户端和服务端 &quot;绑定&quot; 的功能，也就是所谓的提供会话保持，让客户端 A 后续的请求一定转发到服务端 B 上。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9321源地址-hash-算法实现会话保持">9.3.2.1、源地址 hash 算法实现会话保持<a class="hash-link" href="#9321源地址-hash-算法实现会话保持" title="Direct link to heading">​</a></h4><p>作为负载均衡软件，一般都会提供一种称为<strong>源地址 hash 的调度算法</strong>，将客户端的 IP 地址结合后端服务器数量和权重做散列计算，每次客户端请求时都会进行同样的 hash 计算，这样同一客户端总能得到相同的 hash 值，也就能调度到同一个服务端上。</p><p>一般来说，<strong>除非无路可选，都不应该选择类似源地址 hash 这样的算法</strong>。因为只要后端服务器的权重发生任何一点改变，所有源 IP 地址的 hash 值几乎都会改变，这是非常大的动荡。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9322cookie-实现会话保持">9.3.2.2、cookie 实现会话保持<a class="hash-link" href="#9322cookie-实现会话保持" title="Direct link to heading">​</a></h4><p>作为反向代理软件，一般还提供一种 <strong>cookie 绑定的功能实现会话保持</strong>。反向代理软件为客户端 A 单独生成一个 cookie1，或者直接修改应用服务器为客户端设置的 cookie2，最后将 cookie 通过在响应报文中设置 &quot;Set-Cookie&quot; 字段响应给客户端。</p><p>与此同时，反向代理软件会在内存中维持一张 cookie 表，这张表记录了 cookie1 或修改后的 cookie2 对应的服务端。只要客户端请求报文中的 &quot;Cookie&quot; 字段中携带了 cookie1 或 cookie2 属性的请求到达反向代理软件时，反向代理软件根据 cookie 表就能检索到对应的服务端是谁。</p><p>需要注意的是，客户端收到的 cookie 可能来源有两类：一类是反向代理软件增加的，这时客户端收到的响应报文中将至少有两个 &quot;Set-Cookie&quot; 字段，其中一个是反代软件的，其他是应用服务器设置的；一类是反向代理软件在应用服务器设置的 Cookie 基础上修改或增加属性。</p><p>例如，当配置 haproxy 插入 cookie 时，客户端从第一次请求到第二次请求被后端应用程序处理的过程大致如下图所示：</p><p><img loading="lazy" alt="haproxy cookie" src="/en/assets/images/haproxy cookie-0147a1acf2ccdddd8bc06db9dd24ffc4.png" width="1044" height="479" class="img_ev3q"></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9323stick-table-实现会话粘性">9.3.2.3、stick table 实现会话粘性<a class="hash-link" href="#9323stick-table-实现会话粘性" title="Direct link to heading">​</a></h4><p>haproxy 还提供另一种 <strong>stick table 功能实现会话粘性(stickiness)</strong>。</p><ul><li>这张 stick-table 表非常强大，它可以根据提取客户端请求报文中的内容或者源 IP 地址或者提取响应报文中的内容(例如应用服务器设置的 Session ID 这个 cookie)作为这张表的 key，将后端服务器的标识符 ID 作为 key 对应的 value。</li><li>只要客户端再次请求，haproxy 就能对请求进行匹配(match)，无论是源 IP 还是 cookie 亦或是其它字符串作为 key，总能匹配到对应的记录，而且匹配速度极快，再根据 value 转发给对应的后端服务器。</li></ul><p>例如，下图是一张最简单的 stick table 示意图：</p><p><img loading="lazy" alt="haproxy stick-table" src="/en/assets/images/haproxy stick-table-cc93f996a228c114a718716919fd2134.png" width="1035" height="453" class="img_ev3q"></p><p>该 stick-table 存储的 key 是客户端的源 IP 地址，当客户端第一次请求到达 haproxy 后，haproxy 根据调度算法为其分配一个后端 appserver，当请求转发到达后端后，haproxy 立即在 stick table 表中建立一条 ip 和 appserver 的粘性(stickiness)记录。之后，无论是否使用 cookie，haproxy 都能为该客户端找到它对应的后端服务器。</p><ul><li><p>stick table 的强大远不止会话粘性。还可以根据需要定制要记录的计数器和速率统计器，例如在一个时间段内总共流入了多少个连接、平均每秒流入多少个连接、流入流出的字节数和平均速率、建立会话的数量和平均速率等。</p></li><li><p>更强大的是，stick table 可以在 &quot;主主模型&quot; 下进行 stick 记录复制(replication)，它不像 session 复制(copy)，节点一多，无论是节点还是网络带宽的压力都会暴增。</p><ul><li>haproxy 每次推送的是 stick table 中的一条记录，而不是整表整表地复制，而且每条记录占用的空间很小(最小时每条记录 50 字节)，使得即使在非常繁忙的情况下，在几十台 haproxy 节点之间复制都不会占用太多网络带宽。</li><li>借助 stick table 的复制，可以完完整整地实现 haproxy &quot;主主模型&quot;，保证所有粘性信息都不会丢失，从而保证 haproxy 节点 down 掉也不会让客户端和对应的服务端失去联系。</li></ul></li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9324session-共享">9.3.2.4、session 共享<a class="hash-link" href="#9324session-共享" title="Direct link to heading">​</a></h4><p>无论反向代理软件实现的会话保持能力有多强，功能有多多，只要后端是应用服务器，就一定是 &quot;有状态&quot; 的。有状态对于某些业务逻辑来说是必不可少的，但对架构的伸缩和高可用带来了不便。我们无法在架构中随意添加新的代理节点，甚至无法随意添加新的应用服务器，高可用的时候还必须考虑状态或者某些缓存内容是否会丢失。</p><p>如果将所有应用服务器的 session 信息全部存储到一台服务器上(一般放在 redis 或数据库中)进行共享，每台应用服务器在需要获取上下文的时候从这台服务器上取，那么应用服务器在取 session 消息之前就是 &quot;无状态&quot; 的。</p><p>例如，下面是一个后端使用 session 共享的示意图：</p><p><img loading="lazy" alt="session share" src="/en/assets/images/session share-1150a0c9bd2e14a490e06231cd9e39e8.png" width="849" height="442" class="img_ev3q"></p><p>使用 session share 后，调度器无论将请求调度到哪个后端上，这个后端都能从 session share 服务器上获取到对应的 session 上下文。这样无状态的请求完全可以被任意负载，负载软件无需记住后端服务器，从而达到四层负载的效果。如果没有特殊需求(如处理 7 层协议)，这时可以使用 LVS 替代 haproxy，因为在负载性能上，LVS 比 haproxy 高好几个级别。</p><p>session 共享给架构带来的好处非常多，正如上面所说的，可以使用 LVS 进行极其高效的负载(前提是没有 LVS 无法实现的需求)，无论是负载节点还是应用服务器节点都可以随意增删服务器。而唯一需要保证的就是 session 共享服务器的高可用。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="933haproxy-的特性3后端健康状况检查和被检查">9.3.3、haproxy 的特性(3)：后端健康状况检查和被检查<a class="hash-link" href="#933haproxy-的特性3后端健康状况检查和被检查" title="Direct link to heading">​</a></h3><p>任何一个负载均衡软件，都应该提供后端服务器健康状况检查的功能，即使自身没有，也必须能够借助其他第三方工具来实现。只有具备后端健康检查的功能，在后端某服务器 down 掉的时候，调度器才能将它从后端服务器组中踢出去，保证客户端的请求不会被调度到这台 down 掉的服务器上。</p><p>haproxy 为多种协议类型提供了健康状况检查的功能，除了最基本的基于 tcp 的检查，还有以下几种协议提供健康检查：</p><ol><li>HTTP</li><li>ldap</li><li>mysql</li><li>pgsql</li><li>redis</li><li>SPOP</li><li>smtp</li></ol><p>如果 haproxy 没有指定基于哪种协议进行检查，默认会使用 tcp 协议进行检查，这种检查的健康判断方式就是能否连上后端。例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">backend StaticGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server staticsrv1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.12:80 check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server staticsrv2 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.13:80 check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>在 server 指令中的 check 设置的是是否开启健康检查功能，以及检查的时间间隔、判断多少次不健康后就认为后端下线了以及成功多少次后认为后端重新上线了。</li></ul><p>如果要基于其它协议检查，需要使用协议对应的 option 指令显式指定要检查的对象。且前提是 server 中必须指定 check，这是控制检查与否的开关。例如，基于 http 协议检查：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">backend DynamicGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option httpchk     GET /index.php</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server appsrv1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.12:80  check</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server appsrv2 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.13:80  check</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>对于基于 http 协议的检查，haproxy 提供了多种判断健康与否的方式，可以通过返回状态码或拿状态码来进行正则匹配、通过判断响应体是否包含某个字符串或者对响应体进行正则匹配。例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">backend DynamicGroup1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option httpchk     GET /index.php</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http-check </span><span class="token function" style="color:rgb(0, 0, 255)">expect</span><span class="token plain">  status </span><span class="token number" style="color:rgb(9, 134, 88)">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server appsrv1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.12:80  check</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server appsrv2 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.13:80  check</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">backend DynamicGroup2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option httpchk     GET /index.php</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http-check </span><span class="token function" style="color:rgb(0, 0, 255)">expect</span><span class="token plain">  </span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token plain"> string error</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server appsrv1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.12:80  check</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server appsrv2 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.13:80  check</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>上面两个后端组都指定了使用 http 协议进行检查，并分别使用 <code>http-check expect</code> 指定了要检查到状态码 200、响应体中不包含字符串 &quot;error&quot; 才认为健康。</li><li>如果不指定 <code>http-check expect</code> 指令，那么基于 http 协议检查的时候，只要状态码为 2xx 或 3xx 都认为是健康的。</li></ul><p><strong>haproxy 除了具备检查后端的能力，还支持被检查，</strong>只需要使用 <code>monitor</code> 类的指令即可。所谓被检查，指的是 haproxy 可以指定一个检查自己的指标，自己获取检查结果，并将检查状态上报给它的前端或高可用软件，让它们很容易根据上报的结果(200 或 503 状态码)判断 haproxy 是否健在。</p><p>以下是两个被检查的示例：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">frontend www</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    mode http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    monitor-uri /haproxy_test</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">frontend www</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   mode http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   acl site_dead nbsrv</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">dynamic</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> lt </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   acl site_dead nbsrv</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">static</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">  lt </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   monitor-uri   /site_alive</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">   monitor fail  </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> site_dead</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>第一个示例中，&quot;/haproxy<!-- -->_<!-- -->test&quot; 是它的前端指定要检查的路径，此处 haproxy 对该 uri 路径进行监控，当该路径正常时，haproxy 会告诉前端 &quot;HTTP/1.0 200 OK&quot;，当不正常时，将 &quot;HTTP/1.0 503 Service unavailable&quot;。</li><li>第二个示例中，不仅监控了 &quot;/site<!-- -->_<!-- -->alive&quot;，还监控了后端健康节点的数量。当 dynamic 或 static 后端组的健康节点数量少于 2 时，haproxy 立即主动告诉前端 &quot;HTTP/1.0 503 Service unavailable&quot;，否则返回给前端 &quot;HTTP/1.0 200 OK&quot;。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="934haproxy-的特性4处理请求和响应报文">9.3.4、haproxy 的特性(4)：处理请求和响应报文<a class="hash-link" href="#934haproxy-的特性4处理请求和响应报文" title="Direct link to heading">​</a></h3><p>一个合格的反向代理软件，必须能够处理流入的请求报文和流出的响应报文。具备这些能力后，不仅可以按照需求改造报文，还能筛选报文，防止被恶意攻击。</p><p>haproxy 提供了很多处理请求、响应报文的功能性指令，还有一些所谓 &quot;函数&quot;，对 4、5、6、7 层协议进行抓包处理。</p><p>大多数处理请求报文的函数都以 &quot;req&quot; 或 &quot;capture.req.&quot; 开头，处理响应报文的函数都以 &quot;res.&quot; 或 &quot;capture.res.&quot;开头，这样的函数非常多，几乎可以实现任何想达到的功能。完整的指令集见官方手册：<a href="https://cbonte.github.io/haproxy-dconv/2.4/configuration.html#7.3" target="_blank" rel="noopener noreferrer">https://cbonte.github.io/haproxy-dconv/2.4/configuration.html#7.3</a>。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="935haproxy-的特性5状态查看">9.3.5、haproxy 的特性(5)：状态查看<a class="hash-link" href="#935haproxy-的特性5状态查看" title="Direct link to heading">​</a></h3><p>作为反向代理，必须具备查看自身和后端服务器的状态信息。</p><p>haproxy 提供了多种获取状态信息的方法：</p><ol><li>使用 <code>stats enable</code> 指令启用状态报告功能，这样就可以在浏览器中输入特定的 url 访问状态信息。</li><li>提供了很多对前端状态和后端节点状态<strong>取样调查</strong>的函数。例如某指定后端或所有后端有多少个节点存活、某后端或所有后端已建立多少连接、后端还有多少连接槽位可以继续提供连接、前端建立了多少连接等等。完整的指令集见官方手册：<a href="https://cbonte.github.io/haproxy-dconv/2.4/configuration.html#7.3" target="_blank" rel="noopener noreferrer">https://cbonte.github.io/haproxy-dconv/2.4/configuration.html#7.3</a>。</li><li>提供了套接字状态查看、管理功能。也许很多人都不知道，默认配置文件中的 <code>stat socket</code> 指令是干吗用的，其实这就是为系统管理员提供的接口。</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">global</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> log         </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1 local2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">chroot</span><span class="token plain">      /var/lib/haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> pidfile     /var/run/haproxy.pid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> maxconn     </span><span class="token number" style="color:rgb(9, 134, 88)">2000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> user        haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> group       haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> daemon</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"> stats socket /var/lib/haproxy/stats</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们安装 &quot;socat&quot; 包(socket cat，在 epel 源提供该包)后，就可以通过 socat 命令来查看 /var/lib/haproxy/stats 这个状态套接字。例如，执行下面的命令可以获取到所有可执行的命令。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;help&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> socat unix:/var/lib/haproxy/stats -</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>例如，其中一条命令是 &quot;show backend&quot; 用来列出所有的 backend，可以这样使用：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;show backend&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> socat unix:/var/lib/haproxy/stats -</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>或者也可以进入交互式操作模式：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">socat readline unix:/var/lib/haproxy/stats</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="936haproxy-的特性6acl">9.3.6、haproxy 的特性(6)：ACL<a class="hash-link" href="#936haproxy-的特性6acl" title="Direct link to heading">​</a></h3><p>ACL 本意是 access control list(访问控制列表)，用来定义一组黑名单或白名单。但显然，它绝不仅仅是为了黑白名单而存在的，有了 ACL，可以随意按条件定制一组或多组列表。ACL 存在的意义，就像是正则表达式存在的意义一样，极大程度上简化了软件在管理上的复杂度。</p><p>在 haproxy 中，只要能在逻辑意义上进行分组的，几乎都可以使用 ACL 来定制。比如哪些 IP 属于 A 组，后端哪些节点是静态组，后端节点少于几个时属于 dead 状态等等。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="937haproxy-的特性7连接重用功能">9.3.7、haproxy 的特性(7)：连接重用功能<a class="hash-link" href="#937haproxy-的特性7连接重用功能" title="Direct link to heading">​</a></h3><p>haproxy 支持后端连接重用的功能。</p><p>在默认情况下(不使用连接重用)，当某客户端的请求到来后，haproxy 为了将请求转发给后端，会和后端某服务器建立一个 TCP 连接，并将请求调度到该服务器上，该客户端后续的请求也会通过该 TCP 连接转发给后端(假设没有采用关闭后端连接的 http 事务模型)。但在响应后和该客户端的下一个请求到来前，这个连接是空闲的。</p><p>其实仔细想想，和后端建立的 TCP 连接仅仅只是为了调度转发，免去后续再次建立 tcp 连接的消耗。完全可以为其它客户端的请求调度也使用这个 TCP 连接，保证 TCP 连接资源不浪费。可以使用 <code>http-reuse strategy_name</code> 指令设置连接重用的策略，而默认策略禁用连接重用。</p><p>该指令有 4 个值：</p><ol><li><code>never</code>：这是默认设置。表示禁用连接重用，因为老版本的 haproxy 认为来源不同的请求不应该共享同一个后端连接。</li><li><code>safe</code>：这是建议使用的策略。&quot;安全&quot;策略下，haproxy 为客户端的每个第一个请求都单独建立一个和后端的 TCP 连接，但是后续的请求则会重用和该后端的空闲 TCP 连接。<strong>这样的转发不仅提高了资源使用率，还保持了 keep-alive 的功能。因此，safe 策略配合 http-keep-alive 事务模式比 http-server-close 事务模式更高效，无论后端是静态、缓存还是动态应用服务器。</strong></li><li><code>aggressive</code>：一种激进的策略，该策略的 haproxy 会重用空闲 TCP 连接来转发大多数客户端的第一次请求。之所以是大多数而不是所有，是因为 haproxy 会挑选那些已经被重用过至少一次的连接(即从建立开始转发过至少两次，不管源是否是同一客户端)进行重用，因为 haproxy 认为只有这样的连接才具有重用能力。</li><li><code>always</code>：它将总是为第一个请求重用空闲连接。当后端是缓存服务器时，这种策略比 safe 策略的性能要高许多，因为这样的请求行为都是一样的，且可以共享同一连接来获取资源。不过不建议使用这种策略，因为大多数情况下，它和 aggressive 的性能是一样的，但是却带来了很多风险。</li></ol><p>因此，为了性能的提升，将它设置为 safe 或 aggressive 吧，同时再将 http 事务模型设置为 http-keep-alive，以免后端连接在响应后立即被关闭。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="94配置-haproxy">9.4、配置 haproxy<a class="hash-link" href="#94配置-haproxy" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="941配置-haproxy-前">9.4.1、配置 haproxy 前<a class="hash-link" href="#941配置-haproxy-前" title="Direct link to heading">​</a></h3><p>尽管 haproxy 大多数配置选项都可以采用默认配置，但有些选项，特别是关于实际需求、连接数和超时时间相关的选项，必须独立配置。</p><p>大致总结了下以下几点需要考虑的问题：</p><ol><li><p>haproxy 支持 5 种 http 事务模型。一般只会选择其中两种：</p><ul><li>当后端为静态 web 或静态缓存服务器时，由于响应速度快，频繁建立 tcp 连接的代价比较大；<strong>建议使用 <code>http-keep-alive</code> 模型</strong>。</li><li>当后端为动态应用程序服务器或者静态但传输的资源对象体积较大时，由于响应速度相对较慢，占用空闲连接的资源比建立 tcp 连接的代价更大，<strong>建议使用 <code>http-server-close</code> 模型</strong>。</li></ul></li><li><p>haproxy 反向代理的调度算法优先级是低于 cookie 的，因此当一个连接已经保持了会话，调度算法对该连接就无效。只有新的连接请求或者长连接已经失效时，才会使用调度算法进行调度。在调度算法的选择上，如果不考虑服务器性能差距的话：</p><ul><li>如果后端会话时间比较长(mysql)，建议使用 <code>leastconn</code>，因为调度过程中，后端释放连接时动荡不大，比较稳定。</li><li>如果后端是静态 web，建议使用 roundrobin 算法。</li><li>如果后端需要保持会话信息，但又不使用 cookie 时，可以使用源地址 hash 算法 <code>source</code>，保证将同一客户端引导到同一后端服务器上。如果使用 cookie，则可以使用 <code>roundrobin</code> 或 <code>leastconn</code> 算法。<strong>源地址 hash 算法，一般只在没有办法的时候但又要调度到同一后端服务器时，才作为最后手段。</strong></li><li>如果配置了 session 共享，则对于 haproxy 来说，动态资源的请求是 &quot;无状态&quot; 的，可以使用 <code>roundrobin</code> 算法或 <code>leastconn</code>。</li><li>如果后端是缓存服务器，为了保证命中率，建议使用 <code>uri</code> 算法，同时将 <code>hash-type</code> 设置为 <code>consistent</code> 方法(一致性 hash)，保证后端缓存服务器 down 掉后对客户端的影响足够小。</li></ul></li><li><p>haproxy 是单进程、事件驱动模型的软件，单进程下工作效率已经非常好，不建议开启的多进程/多实例。</p></li><li><p><code>maxconn</code> 指令控制最大并发连接数，可以在多处设置，设置位置不同，代表意义不同：</p><ul><li><p>设置在 global 段或 frontend/listen/defaults 段的 <code>maxconn</code> 代表的是和客户端(即 frontend)的最大连接并发数；其中 global 段的值是硬限制，frontend/listen/defaults 段的 <code>maxconn</code> 值不能超过 global 段的值。</p></li><li><p>设置在 server 指令中时，代表的是 haproxy 和某台后端服务器维持的最大并发连接数。</p></li><li><p>前端的最大并发数(即 global 段的 <code>maxconn</code>)可以根据内存来估算，haproxy 为每个连接维持两个缓存区，每个大致 16K 左右，加上一些额外数据，共约 33-34K 左右，因此理论上 1G 的空闲内存能维持 2W-2.5W 个纯 HTTP 的并发连接(只是理论上)，如果代理的是 https，则允许的最大并发数量要小的多。<strong>前端 <code>maxconn</code> 默认值为 2000，非常有必要将其增加几倍</strong>。</p><p>一般代理纯 http 服务时，如果后端能处理及时，这里设置 20000 以上都不会有什么问题。以上只是大致估算代理能力，实际设置时必须根据后端处理能力以及 haproxy 自身能力设置前端 <code>maxconn</code>，否则将前端接进来后端也无法立即处理。</p></li><li><p>后端所有服务器的 <code>maxconn</code> 值之和应接近前端的 <code>maxconn</code> 值，计算两者差距时，还需要考虑后端的等待队列长度 <code>maxqueue</code>。其中和静态 web 服务器的 <code>maxconn</code> 可以设置大一些。</p></li></ul></li><li><p>参见本章 9.3.7 设置连接重用功能。</p></li><li><p>对于 haproxy 是否开启 cookie 以及 stick table 相关功能的设置必须严加考虑，它直接影响调度算法的选择和负载均衡的性能。不过如果后端应用程序服务器共享了 session，haproxy 可以不用设置会话粘性相关的选项。</p></li><li><p>haproxy 的默认配置文件中关于超时时间的设置应该修改，不少项设置都很不合理。</p></li><li><p>建议开启 haproxy 的 <code>X-Forwarded-For</code> 选项，使得后端服务器能够记录客户端的真实源 IP 地址。</p></li><li><p>建议开启 haproxy 的状态页面，并设置访问权限。</p></li></ol><p>为了实现 Haproxy 完善的功能，上面几个问题是远远不够的，但可以在边使用 haproxy 过程中边增加功能使其不断完美。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="942配置-haproxy-反向代理">9.4.2、配置 haproxy 反向代理<a class="hash-link" href="#942配置-haproxy-反向代理" title="Direct link to heading">​</a></h3><p>实验环境如下图：</p><p><img loading="lazy" alt="haproxy proxy" src="/en/assets/images/haproxy proxy-abd811ff4f4460ace5e006cfe1417105.png" width="806" height="532" class="img_ev3q"></p><p>haproxy 编译安装参见 9.1 小节，由于默认配置文件中和超时时间相关的设置比较不合理，所以建议修改这些时间。另外还有些建议开启或关闭的项也尽量开启或关闭。</p><p>默认配置如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">global</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    log         </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1 local2            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 需要设置/etc/rsyslog.conf加上local2设备的日志记录级别和日志路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">chroot</span><span class="token plain">      /var/lib/haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    pidfile     /var/run/haproxy.pid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    maxconn     </span><span class="token number" style="color:rgb(9, 134, 88)">4000</span><span class="token plain">                        </span><span class="token comment" style="color:rgb(0, 128, 0)"># 这是前段对外的最大连接数。代理http时，1G空闲内存承载20000以上没大问题</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    user        haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    group       haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    daemon</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stats socket /var/lib/haproxy/stats     </span><span class="token comment" style="color:rgb(0, 128, 0)"># 开启动态查看、管理haproxy的状态文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 另外建议设置spread-checks全局项，且百分比建议为2-5之间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">defaults</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    mode                    http            </span><span class="token comment" style="color:rgb(0, 128, 0)"># 7层http代理，另有4层tcp代理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    log                     global</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option                  httplog         </span><span class="token comment" style="color:rgb(0, 128, 0)"># 在日志中记录http请求、session信息等</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option                  dontlognull     </span><span class="token comment" style="color:rgb(0, 128, 0)"># 不要在日志中记录空连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option http-server-close                </span><span class="token comment" style="color:rgb(0, 128, 0)"># 后端为动态应用程序建议使用http-server-close，后端为静态建议使用http-keep-alive</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option forwardfor       except </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.0/8  </span><span class="token comment" style="color:rgb(0, 128, 0)"># haproxy将在发往后端的请求中加上&quot;X-Forwarded-For&quot;首部字段</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option                  redispatch          </span><span class="token comment" style="color:rgb(0, 128, 0)"># 当某后端down掉使得haproxy无法转发携带cookie的请求到该后端时，将其转发到别的后端上</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> http-request    10s     </span><span class="token comment" style="color:rgb(0, 128, 0)"># 此为等待客户端发送完整请求的最大时长，应该设置较短些防止洪水攻击，如设置为2-3秒，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                    </span><span class="token comment" style="color:rgb(0, 128, 0)"># haproxy总是要求一次请求或响应全部发送完成后才会处理、转发。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> queue           1m      </span><span class="token comment" style="color:rgb(0, 128, 0)"># 请求在队列中的最大时长，1分钟太长了。设置为10秒都有点长，10秒请求不到资源客户端会失去耐心</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> connect         10s     </span><span class="token comment" style="color:rgb(0, 128, 0)"># haproxy和服务端建立连接的最大时长，设置为1秒就足够了。局域网内建立连接一般都是瞬间的</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> client          1m      </span><span class="token comment" style="color:rgb(0, 128, 0)"># 和客户端保持空闲连接的超时时长，在高并发下可稍微短一点，可设置为10秒以尽快释放连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> server          1m      </span><span class="token comment" style="color:rgb(0, 128, 0)"># 和服务端保持空闲连接的超时时长，局域网内建立连接很快，所以尽量设置短一些，特别是并发时，如设置为1-3秒</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> http-keep-alive 10s     </span><span class="token comment" style="color:rgb(0, 128, 0)"># 和客户端保持长连接的最大时长。优先级高于timeout http-request高于timeout client</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> check           10s     </span><span class="token comment" style="color:rgb(0, 128, 0)"># 和后端服务器成功建立连接后到最终完成检查的时长(不包括建立连接的时间，只是读取到检查结果的时长)，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 可设置短一点，如1-2秒</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    maxconn                 </span><span class="token number" style="color:rgb(9, 134, 88)">3000</span><span class="token plain">    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 默认和前段的最大连接数，但不能超过global中的maxconn硬限制数</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>所以修改后建议配置如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">global</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    log         </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1 local2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">chroot</span><span class="token plain">      /var/lib/haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    pidfile     /var/run/haproxy.pid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    maxconn     </span><span class="token number" style="color:rgb(9, 134, 88)">20000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    user        haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    group       haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    daemon</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stats socket /var/lib/haproxy/stats</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    spread-checks </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">defaults</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    mode                    http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    log                     global</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option                  httplog</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option                  dontlognull</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option http-server-close</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option forwardfor       except </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.0/8</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option                  redispatch</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> http-request    2s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> queue           3s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> connect         1s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> client          10s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> server          2s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> http-keep-alive 10s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> check           2s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    maxconn                 </span><span class="token number" style="color:rgb(9, 134, 88)">18000</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">frontend http-in</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain">             *:80</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    mode             http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    log              global</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    capture request  header Host len </span><span class="token number" style="color:rgb(9, 134, 88)">20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    capture request  header Referer len </span><span class="token number" style="color:rgb(9, 134, 88)">60</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    acl url_static   path_beg  -i /static /images /stylesheets</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    acl url_static   path_end  -i .jpg .jpeg .gif .png .ico .bmp .css .js</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    acl url_static   path_end  -i .html .htm .shtml .shtm .pdf .mp3 .mp4 .rm .rmvb .txt</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    acl url_static   path_end  -i .zip .rar .gz .tgz .bz2 .tgz</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    use_backend      StaticGroup   </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> url_static</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    default_backend  DynamicGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">backend StaticGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    balance            roundrobin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option             http-keep-alive</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http-reuse         safe</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option httpchk     GET /index.html</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http-check </span><span class="token function" style="color:rgb(0, 0, 255)">expect</span><span class="token plain">  status </span><span class="token number" style="color:rgb(9, 134, 88)">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server staticsrv1  </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.14:80 check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">5000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server staticsrv2  </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.15:80 check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">5000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">backend DynamicGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    cookie appsrv insert nocache</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    balance roundrobin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option http-server-close</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option httpchk     GET /index.php</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http-check </span><span class="token function" style="color:rgb(0, 0, 255)">expect</span><span class="token plain">  status </span><span class="token number" style="color:rgb(9, 134, 88)">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server appsrv1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.12:80  check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">3000</span><span class="token plain"> cookie appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server appsrv2 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.13:80  check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">3000</span><span class="token plain"> cookie appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">listen report_stats</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain"> *:8081</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        stats </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        stats hide-version</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        stats uri    /hastats</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        stats realm  </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;pls enter your name&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        stats auth   admin:admin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        stats admin  </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> TRUE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的配置中：</p><ol><li>静态请求将分配给 StaticGroup 并进行 roundrobin 调度，同时通过获取 index.html 来做健康状况检查，此外还设置了 haproxy 和后端连接重用的功能。</li><li>动态请求将分配给 DynamicGroup 并进行 roundrobin 调度，但是向响应报文中插入了一个 cookie，保证被调度过的服务端和客户端能保持会话。此外还设置了通过获取 index.php 来做健康状况检查。</li></ol><p>如何配置 nginx + php 请参见 <a href="https://www.brinnatt.com/high/%e7%ac%ac-7-%e7%ab%a0-linux-nginx-%e6%9c%8d%e5%8a%a1%e9%85%8d%e7%bd%ae/#710%E3%80%81%E6%90%AD%E5%BB%BA_LNMP_%E7%8E%AF%E5%A2%83" target="_blank" rel="noopener noreferrer">nginx 配置 LNMP</a></p><p>为了以示区分，在 DynamicGroup 和 StaticGroup 主机中的响应文件里面加入 IP 地址：</p><ul><li>比如 index.html 文件如下：</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 192.168.122.14 主机 index.html</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">This is static page on </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.14 </span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 192.168.122.15 主机 index.html</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">This is static page on </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.15 </span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>比如 index.php 文件如下：</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 192.168.122.12 主机 index.php</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">response from webapp </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.1</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">2</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">?php</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    session_start</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Server IP: &quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;font color=red&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token variable" style="color:rgb(9, 134, 88)">$_SERVER</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;SERVER_ADDR&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;/font&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;br&gt;&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Server Name: &quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;font color=red&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token variable" style="color:rgb(9, 134, 88)">$_SERVER</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;SERVER_NAME&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;/font&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;br&gt;&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;SESSIONNAME: &quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;font color=red&gt;&quot;</span><span class="token plain">.session_name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;/font&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;br&gt;&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;SESSIONID: &quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;font color=red&gt;&quot;</span><span class="token plain">.session_id</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;/font&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;br&gt;&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">?</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 192.168.122.13 主机 index.php</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">response from webapp </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.1</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">3</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">?php</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    session_start</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Server IP: &quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;font color=red&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token variable" style="color:rgb(9, 134, 88)">$_SERVER</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;SERVER_ADDR&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;/font&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;br&gt;&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Server Name: &quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;font color=red&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token variable" style="color:rgb(9, 134, 88)">$_SERVER</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;SERVER_NAME&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;/font&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;br&gt;&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;SESSIONNAME: &quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;font color=red&gt;&quot;</span><span class="token plain">.session_name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;/font&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;br&gt;&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;SESSIONID: &quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;font color=red&gt;&quot;</span><span class="token plain">.session_id</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;/font&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;br&gt;&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">?</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>测试：</p><p><img loading="lazy" alt="haproxy test" src="/en/assets/images/haproxy test-438fc2cf9e087c4793e8d2a785dda93e.png" width="1098" height="756" class="img_ev3q"></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/en/docs/linux-advanced-11"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">第 11 章 Linux Tomcat 服务实践</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/en/docs/linux-advanced-13"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">第 13 章 Linux haproxy 服务进阶配置</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#91安装-haproxy" class="table-of-contents__link toc-highlight">9.1、安装 haproxy</a></li><li><a href="#92haproxy-命令" class="table-of-contents__link toc-highlight">9.2、haproxy 命令</a></li><li><a href="#93haproxy-丰富特性" class="table-of-contents__link toc-highlight">9.3、haproxy 丰富特性</a><ul><li><a href="#931haproxy-的特性1连接保持和连接关闭" class="table-of-contents__link toc-highlight">9.3.1、haproxy 的特性(1)：连接保持和连接关闭</a></li><li><a href="#932haproxy-的特性2会话保持" class="table-of-contents__link toc-highlight">9.3.2、haproxy 的特性(2)：会话保持</a><ul><li><a href="#9321源地址-hash-算法实现会话保持" class="table-of-contents__link toc-highlight">9.3.2.1、源地址 hash 算法实现会话保持</a></li><li><a href="#9322cookie-实现会话保持" class="table-of-contents__link toc-highlight">9.3.2.2、cookie 实现会话保持</a></li><li><a href="#9323stick-table-实现会话粘性" class="table-of-contents__link toc-highlight">9.3.2.3、stick table 实现会话粘性</a></li><li><a href="#9324session-共享" class="table-of-contents__link toc-highlight">9.3.2.4、session 共享</a></li></ul></li><li><a href="#933haproxy-的特性3后端健康状况检查和被检查" class="table-of-contents__link toc-highlight">9.3.3、haproxy 的特性(3)：后端健康状况检查和被检查</a></li><li><a href="#934haproxy-的特性4处理请求和响应报文" class="table-of-contents__link toc-highlight">9.3.4、haproxy 的特性(4)：处理请求和响应报文</a></li><li><a href="#935haproxy-的特性5状态查看" class="table-of-contents__link toc-highlight">9.3.5、haproxy 的特性(5)：状态查看</a></li><li><a href="#936haproxy-的特性6acl" class="table-of-contents__link toc-highlight">9.3.6、haproxy 的特性(6)：ACL</a></li><li><a href="#937haproxy-的特性7连接重用功能" class="table-of-contents__link toc-highlight">9.3.7、haproxy 的特性(7)：连接重用功能</a></li></ul></li><li><a href="#94配置-haproxy" class="table-of-contents__link toc-highlight">9.4、配置 haproxy</a><ul><li><a href="#941配置-haproxy-前" class="table-of-contents__link toc-highlight">9.4.1、配置 haproxy 前</a></li><li><a href="#942配置-haproxy-反向代理" class="table-of-contents__link toc-highlight">9.4.2、配置 haproxy 反向代理</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Study</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/tags">Tags</a></li><li class="footer__item"><a class="footer__link-item" href="/en/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/en/docs/skill">Notes</a></li><li class="footer__item"><a class="footer__link-item" href="/en/project">Projects</a></li><li class="footer__item"><a class="footer__link-item" href="/en/docs/linux">Linux</a></li></ul></div><div class="col footer__col"><div class="footer__title">Social Media</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/about">About Me</a></li><li class="footer__item"><a href="https://github.com/zqingfa" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://juejin.cn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Juejin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" position="right" href="/en/friends">Friends</a></li><li class="footer__item"><a class="footer__link-item" position="right" href="/en/website">Links</a></li><li class="footer__item"><a href="https://docusaurus.io/zh-CN/" target="_blank"><img style="height:50px;margin-top:0.5rem" src="/img/buildwith.png"><a></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p><a href="http://beian.miit.gov.cn/">浙ICP备20024502号-1</a></p><p>Copyright © 2022 – PRESENT zhangqf Built with Docusaurus.</p></div></div></div></footer></div>
<script src="/en/assets/js/runtime~main.3ab0938b.js"></script>
<script src="/en/assets/js/main.7af82c56.js"></script>
</body>
</html>