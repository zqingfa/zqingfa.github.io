<!doctype html>
<html lang="en-GB" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-linux/advanced/linux-advanced-14">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">第 14 章 Linux haproxy 服务高级配置 - Linux技术分享</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://zhangqf.com/en/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://zhangqf.com/en/img/logo.png"><meta data-rh="true" property="og:url" content="https://zhangqf.com/en/docs/linux-advanced-14"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="第 14 章 Linux haproxy 服务高级配置 - Linux技术分享"><meta data-rh="true" name="description" content="haproxy 是一个非常强大的服务，特别是在高并发的场景下，是一个非常不错的选择；前两篇针对 haproxy 的使用做了详细说明，让 haproxy 在生产环境下优雅地跑起来绝不在话下；下面我们需要对它的一些重要功能进一步剖析一下。"><meta data-rh="true" property="og:description" content="haproxy 是一个非常强大的服务，特别是在高并发的场景下，是一个非常不错的选择；前两篇针对 haproxy 的使用做了详细说明，让 haproxy 在生产环境下优雅地跑起来绝不在话下；下面我们需要对它的一些重要功能进一步剖析一下。"><meta data-rh="true" name="keywords" content="linux,haproxy"><link data-rh="true" rel="icon" href="/en/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://zhangqf.com/en/docs/linux-advanced-14"><link data-rh="true" rel="alternate" href="https://zhangqf.com/en/docs/linux-advanced-14" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/linux-advanced-14" hreflang="zh"><link data-rh="true" rel="alternate" href="https://zhangqf.com/docs/linux-advanced-14" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9B0V5WT2X8-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S4SD5NXWXF"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S4SD5NXWXF",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Linux技术分享" href="/en/opensearch.xml">
<link rel="preconnect" href="https://zhangqf.com/">
<script>var _paq=window._paq=window._paq||[];_paq.push(["setRequestMethod","POST"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),_paq.push(["enableHeartBeatTimer"]),function(){var e="https://zhangqf.com/";_paq.push(["setRequestMethod","POST"]),_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]);var a=document,t=a.createElement("script"),p=a.getElementsByTagName("script")[0];t.type="text/javascript",t.async=!0,t.src=e+"matomo.js",p.parentNode.insertBefore(t,p)}()</script>


<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c9a3849aa75f9c4a4e65f846cd1a5155",e.defer=!0;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<meta name="baidu-site-verification" content="code-rqLUw5reVS">
<script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",t.defer=!0;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script>
<link rel="alternate" type="application/rss+xml" href="/en/rss.xml" title="zhangqf RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/atom.xml" title="zhangqf Atom Feed">
<link rel="alternate" type="application/json" href="/en/feed.json" title="zhangqf JSON Feed">

<link rel="icon" href="/en/img/logo.png">
<link rel="manifest" href="/en/manifest.json">
<meta name="theme-color" content="rgb(51 139 255)"><link rel="stylesheet" href="/en/assets/css/styles.86c9ae18.css">
<link rel="preload" href="/en/assets/js/runtime~main.06ffa367.js" as="script">
<link rel="preload" href="/en/assets/js/main.7f2e5564.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY"><span>更新 <a href="/website">网址导航</a> 带你发现感兴趣的技术</span></div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">kuizuo</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/en/docs/linux">Linux</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/en/docs/category/Linux基础">Linux 基础</a></li><li><a class="dropdown__link" href="/en/docs/category/Linux进阶">Linux 进阶</a></li><li><a class="dropdown__link" href="/en/docs/category/Linux测试">Linux 测试</a></li><li><a class="dropdown__link" href="/en/docs/category/LinuxCICD">Linux CICD研发</a></li><li><a class="dropdown__link" href="/en/docs/skill/">Notes</a></li><li><a class="dropdown__link" href="/en/docs/tools/">Recommended Tools</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Blog</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/en/tags">Tags</a></li><li><a class="dropdown__link" href="/en/archive">Archive</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Tools</a><ul class="dropdown__menu"><li><a href="https://api.kuizuo.cn" target="_blank" rel="noopener noreferrer" class="dropdown__link">API Service</a></li><li><a href="https://js-de-obfuscator.vercel.app" target="_blank" rel="noopener noreferrer" class="dropdown__link">JS Deobfuscate</a></li><li><a href="https://cipher.kuizuo.cn" target="_blank" rel="noopener noreferrer" class="dropdown__link">CyberChef Encryption</a></li><li><a href="https://pan.kuizuo.cn" target="_blank" rel="noopener noreferrer" class="dropdown__link">Cloudreve</a></li></ul></div><a class="navbar__item navbar__link" href="/en/website">Links</a><a class="navbar__item navbar__link" href="/en/project">Projects</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/en/"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/logo.webp" alt="zhangqf" class="themedImage_ToTc themedImage--dark_i4oU"><b>kuizuo</b></a><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/linux">linux</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linux基础">Linux基础</a><button aria-label="Toggle the collapsible sidebar category &#x27;Linux基础&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/en/docs/category/linux进阶">Linux进阶</a><button aria-label="Toggle the collapsible sidebar category &#x27;Linux进阶&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-1">第 1 章 Linux 进阶命令</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-2">第 2 章 Linux 防火墙</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-3">第 3 章 Linux NFS 网络文件系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-4">第 4 章 Linux DHCP 服务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-5">第 5 章 Linux DNS 服务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-6">第 6 章 Linux httpd 服务基础配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-7">第 7 章 Linux httpd 服务进阶配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-8">第 8 章 Linux httpd 服务高级配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-9">第 9 章 Linux Nginx 服务配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-10">第 10 章 Linux Tomcat 服务基础配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-11">第 11 章 Linux Tomcat 服务实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-12">第 12 章 Linux haproxy 服务基础配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-13">第 13 章 Linux haproxy 服务进阶配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/en/docs/linux-advanced-14">第 14 章 Linux haproxy 服务高级配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-15">第 15 章 Linux LVS 服务配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/linux-advanced-16">第 16 章 Linux Keepalived 服务配置</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linux测试">Linux测试</a><button aria-label="Toggle the collapsible sidebar category &#x27;Linux测试&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/en/docs/category/linuxcicd">LinuxCICD</a><button aria-label="Toggle the collapsible sidebar category &#x27;LinuxCICD&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/en/docs/category/linux进阶"><span itemprop="name">Linux进阶</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">第 14 章 Linux haproxy 服务高级配置</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>第 14 章 Linux haproxy 服务高级配置</h1></header><p>haproxy 是一个非常强大的服务，特别是在高并发的场景下，是一个非常不错的选择；前两篇针对 haproxy 的使用做了详细说明，让 haproxy 在生产环境下优雅地跑起来绝不在话下；下面我们需要对它的一些重要功能进一步剖析一下。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="91haproxy-cookie">9.1、haproxy cookie<a class="hash-link" href="#91haproxy-cookie" title="Direct link to heading">​</a></h2><p>http 是无状态协议，任何一个七层的 http 负载均衡器，都应该具备一个功能：会话保持。会话保持是保证客户端对动态应用程序正确请求的基本要求。</p><p>如果反向代理的后端提供的是 &quot;有状态&quot; 的服务或协议时，必须保证请求过一次的客户端能被引导到同一服务端上。只有这样，服务端才能知道这个客户端是它曾经处理过的，能查到并获取到和该客户端对应的上下文环境(session 上下文)，有了这个 session 环境才能继续为该客户端提供后续的服务。</p><ul><li>简单举个例子，客户端 A 向服务端 B 请求将 C 商品加入它的账户购物车，加入成功后，服务端 B 会在某个缓存中记录下客户端 A 和它的商品 C，这个缓存的内容就是 session 上下文环境。<ul><li>而识别客户端的方式一般是设置 session ID(如 PHPSESSID、JSESSIONID)，并将其作为 cookie 的内容交给客户端。</li><li>客户端 A 再次请求的时候(比如将购物车中的商品下订单)只要携带这个 cookie，服务端 B 就可以从中获取到 session ID 并找到属于客户端 A 的缓存内容，也就可以继续执行下订单部分的代码。</li></ul></li><li>假如这时使用负载均衡软件对客户端的请求进行负载，如果这个负载软件只是简单地进行负载转发，就无法保证将客户端 A 引导到服务端 B，可能会引导到服务端 X、服务端 Y，但是 X、Y 上并没有缓存和客户端 A 对应的 session 内容，当然也无法为客户端 A 下订单。</li></ul><p>因此，反向代理软件必须具备将客户端和服务端 &quot;绑定&quot; 的功能，也就是所谓的提供会话保持，让客户端 A 后续的请求一定转发到服务端 B 上。</p><p>haproxy 提供了 3 种实现会话保持的方式：</p><ol><li>源地址 hash；</li><li>设置 cookie；</li><li>会话粘性表 stick-table；</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="911haproxy-设置-cookie-的几种方式">9.1.1、haproxy 设置 cookie 的几种方式<a class="hash-link" href="#911haproxy-设置-cookie-的几种方式" title="Direct link to heading">​</a></h3><p>设置 cookie 的方式是通过在配置文件中使用 cookie 指令进行配置的。由于 haproxy 设置 cookie 的目的是为了将某客户端引导到之前为其服务过的后端服务器上，简单地说，就是和后端某服务器保持联系，因此 cookie 指令不能设置在 frontend 段落。</p><p>首先看一个设置 cookie 的示例：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">backend dynamic_servers</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    cookie app_cook  insert  nocache</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server app1      </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.102:80 cookie server1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server app2      </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.103:80 cookie server2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>这个示例配置中，<code>cookie</code> 指令中指定的是 insert 命令，表示在将响应报文交给客户端之前，先插入一个属性名为 &quot;app<!-- -->_<!-- -->cook&quot; 的 cookie，这个 cookie 在响应报文的头部将独占一个 &quot;Set-Cookie&quot; 字段(因为是插入新 cookie)，而 &quot;app<!-- -->_<!-- -->cook&quot; 只是 cookie 名称，它的值是由 server 指令中的 cookie 选项指定的，这里是 &quot;server1&quot; 或 &quot;server2&quot;。</li><li>因此，如果这个请求报文分配给后端 app2 时，响应给客户端的响应报文中 <strong>haproxy 设置的</strong> &quot;Set-Cookie&quot; 字段的样式为：</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">Set-Cookie:app_cook</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">server2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">path</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>除了 insert 命令，cookie 指令中还支持 rewrite 和 prefix 两种设置 cookie 的方式，这三种 cookie 的操作方式只能三选一。此外，还提供一些额外对 cookie 的功能设置。</p><p>首先看看指令的语法：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">cookie </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">name</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> rewrite </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> insert </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> prefix </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> indirect </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> nocache </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> postonly </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> preserve </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> httponly </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> secure </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> domain </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">domain</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">* </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> maxidle </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">idle</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> maxlife </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">life</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>本文详细分节讨论 rewrite、insert、prefix 的行为，并在讨论它们的时候会穿插说明 indirect、nocache 和 preserve 的行为，如果需要了解其他选项，请自翻官方手册。</p><p>下图是后文实验时使用的环境：</p><p><img loading="lazy" alt="haproxy cookie detail" src="/en/assets/images/haproxy cookie detail-579e41144c2052be576b87944c353b15.png" width="557" height="479" class="img_ev3q"></p><p>其中在后端提供的 index.php 内容大致如下，主要部分是<strong>设置了名为 <code>PHPSESSID</code> 的 cookie</strong>。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">response from webapp </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.102/10</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">3</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">?php</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        session_start</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Server IP: &quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;font color=red&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token variable" style="color:rgb(9, 134, 88)">$_SERVER</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;SERVER_ADDR&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;/font&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;br&gt;&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Server Name: &quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;font color=red&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token variable" style="color:rgb(9, 134, 88)">$_SERVER</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;SERVER_NAME&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;/font&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;br&gt;&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;SESSIONNAME: &quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;font color=red&gt;&quot;</span><span class="token plain">.session_name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;/font&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;br&gt;&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;SESSIONID: &quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;font color=red&gt;&quot;</span><span class="token plain">.session_id</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;/font&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;br&gt;&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">?</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9111cookie-insert">9.1.1.1、cookie insert<a class="hash-link" href="#9111cookie-insert" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">cookie </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">name</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> rewrite </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> insert </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> prefix </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> indirect </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> nocache </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> postonly </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> preserve </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> httponly </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> secure </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> domain </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">domain</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">* </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> maxidle </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">idle</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> maxlife </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">life</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> dynamic </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain"> attr </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">value</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">*</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">insert    This keyword indicates that the persistence cookie will have to</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          be inserted by HAProxy </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> server responses </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> the client did not</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          already have a cookie that would have permitted it to access this</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          server. When used without the </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;preserve&quot;</span><span class="token plain"> option, </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> the server</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          emits a cookie with the same name, it will be removed before</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          processing. For this reason, this mode can be used to upgrade</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          existing configurations running </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> the </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;rewrite&quot;</span><span class="token plain"> mode. The cookie</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          will only be a session cookie and will not be stored on the</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          client&#x27;s disk. By default, unless the </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;indirect&quot;</span><span class="token plain"> option is added,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          the server will see the cookies emitted by the client. Due to</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          caching effects, it is generally wise to </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> the </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;nocache&quot;</span><span class="token plain"> or</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;postonly&quot;</span><span class="token plain"> keywords </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">see below</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">. The </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;insert&quot;</span><span class="token plain"> keyword is not</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          compatible with </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;rewrite&quot;</span><span class="token plain"> and </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;prefix&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>insert 参数的意思如下：<ol><li>haproxy 将在客户端没有 cookie 时(比如第一次请求)，在响应报文中插入一个 cookie。</li><li>当没有使用关键词 &quot;preserve&quot; 选项时，如果后端服务器设置了一个和此处名称相同的 cookie，则首先删除服务端设置的 cookie。</li><li>该 cookie 只能作为会话保持使用，无法持久化到客户端的磁盘上(因为 haproxy 设置的 cookie 没有 maxAge 属性，无法持久保存，只能保存在浏览器缓存中)。</li><li>默认情况下，除非使用了 &quot;indirect&quot; 选项，否则服务端可以看到客户端请求时的所有 cookie 信息。</li><li>由于缓存的影响，建议加上 &quot;nocache&quot; 或 &quot;postonly&quot; 选项。</li></ol></li></ul><p>下面使用例子来解释 insert 的各种行为。</p><p>在 haproxy 如下配置后端。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">backend DynamicGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    cookie app_cook insert nocache</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server app1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.102:80 cookie app_server1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server app2 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.103:80 cookie app_server2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当使用浏览器第一次访问 <code>http://192.168.122.101/index.php</code> 时，响应结果和响应首部内容如下图：</p><p><img loading="lazy" alt="haproxy cookie detail1" src="/en/assets/images/haproxy cookie detail1-85be4522f0d26ad561f8045175138eb2.png" width="1060" height="623" class="img_ev3q"></p><ul><li>从图中可以知道，这次浏览器的请求分配给了 app2，而且响应首部中有两个 &quot;Set-Cookie&quot; 字段，其中带有 PHPSESSID 的 cookie 是 app2 服务器自身设置的，另一个是 haproxy 设置的，其名和其值为 &quot;app<!-- -->_<!-- -->cook=app<!-- -->_<!-- -->server2&quot;。</li></ul><p>如果客户端再次访问(不关闭浏览器，cookie 缓存还在)，请求头中将携带该 cookie，haproxy 发现了该 cookie 中 &quot;app<!-- -->_<!-- -->cook=app<!-- -->_<!-- -->server2&quot; 部分，知道这个请求要交给 app<!-- -->_<!-- -->server2 这个后端。如下图：</p><p><img loading="lazy" alt="haproxy cookie detail2" src="/en/assets/images/haproxy cookie detail2-5047103cd076812e03e9b447996f673c.png" width="989" height="512" class="img_ev3q"></p><p>这样就实现了会话保持，保证被处理过的客户端能被分配到同一个后端应用服务器上。</p><p>注意，<strong>客户端在第一次收到响应后就会把 cookie 缓存下来</strong>，以后每次 <code>http://192.168.122.101/index.php</code> (根据域名进行判断)都会从缓存中取出该 cookie 放进请求首部。这样 haproxy 一定会将其分配给 app<!-- -->_<!-- -->server2，除非 app<!-- -->_<!-- -->server2 下线了。</p><p>但即使如此，客户端还是会携带该 cookie，只不过 haproxy 判断 app<!-- -->_<!-- -->server2 下线后，就为客户端重新分配 app<!-- -->_<!-- -->server1，并设置 &quot;app<!-- -->_<!-- -->cook=app<!-- -->_<!-- -->server1&quot;，该 cookie 会<strong>替换客户端中的 &quot;app<!-- -->_<!-- -->cook=app<!-- -->_<!-- -->server2&quot;</strong>。下图是 app2 下线后分配给 app1 的结果：</p><p><img loading="lazy" alt="haproxy cookie detail3" src="/en/assets/images/haproxy cookie detail3-1e5963743dff7636ccbe88cee9c0232b.png" width="1054" height="722" class="img_ev3q"></p><ul><li>注意，<strong>即使分配给了 app1，PHPSESSID 也不会改变(即 app1 设置的 PHPSESSID 无效)</strong>，因为 haproxy 判断出这个重名 cookie，会删除 app1 设置的 PHPSESSID。因此上图中的 PHPSESSID 值和之前分配给 app2 时的 PHPSESSID 是一样的。<ul><li>这样一来，app1 不是就无法处理该客户端的请求了吗？确实如此，但没办法，<strong>除非后端设置了 session 共享</strong>。</li></ul></li></ul><p>如果将配置文件中的 cookie 名称也设置为 PHPSESSID，即后端应用服务器和此处设置的 cookie 名称相同，那么 haproxy 将首先将后端的 PHPSESSID 删除，然后使用自己的值发送给客户端。也就是说，此时将只有一个 &quot;Set-Cookie&quot; 字段响应给客户端。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">backend DynamicGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    cookie PHPSESSID insert nocache</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server app1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.102:80 cookie app_server1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server app2 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.103:80 cookie app_server2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="haroxy cookie detail4" src="/en/assets/images/haproxy cookie detail4-eb420b7d867757d7d07c218d7955743c.png" width="1050" height="697" class="img_ev3q"></p><ul><li>因此，在 cookie 指令中绝对不能设置 cookie 名称和后端的 cookie 名称相同，否则后端就相当于 &quot;盲人&quot;。例如此处的 PHPSESSID，此时后端虽然认识 PHPSESSID 是自己发送出去的 cookie 名称，但是无法获取 ID 为 &quot;app<!-- -->_<!-- -->server2&quot; 的 session 上下文。</li><li><strong>如果不配合 &quot;indirect&quot; 选项</strong>，服务端可以看到客户端请求时的所有 cookie 信息。如果配合 &quot;indirect&quot; 选项，则 haproxy 在将请求转发给后端时，将删除自己设置的 cookie，使得后端只能看到它自己的 cookie，这样对后端来说，整个过程是完全透明的，它不知道前面有负载均衡软件。</li></ul><p>重新修改 haproxy 的 cookie 指令，并修改 nginx 配置文件中日志格式，在其中加上 &quot;$http<!-- -->_<!-- -->cookie&quot; 变量，它表示请求报文中的 cookie 信息。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># haproxy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">cookie app_cook insert nocache</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">log_format  main  </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;$http_cookie $remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                  </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                  </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>客户端再次访问时，nginx 的日志中将记录以下信息(只贴出了前几个字段)。</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token assign-left variable" style="color:rgb(9, 134, 88)">PHPSESSID</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">0n2m66kr6tbpmqftcljlvjk3i7</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">app_cook</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">app_server1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.101</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>加上 &quot;indirect&quot; 选项，再测试。</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">cookie app_cook insert indirect nocache</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>结果如下：</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token assign-left variable" style="color:rgb(9, 134, 88)">PHPSESSID</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">0n2m66kr6tbpmqftcljlvjk3i7 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.101</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>如果 insert 关键字配合 &quot;preserve&quot; 关键字</strong>，那么当后端设置了cookie 时，haproxy 将强制保留该 cookie，不做任何修改。也就是说，如果将 haproxy 的 cookie 名称也设置为 PHPSESSID，那么客户端第一次请求时收到的响应报文中将只有一个 &quot;Set-Cookie&quot; 字段，且这个字段的值是后端服务器设置的，和 haproxy 无关。</p><p><strong>当客户端和 HAProxy 之间存在缓存时，建议将 insert 配合 nocache 一起使用</strong>，因为 nocache 确保如果需要插入 cookie，则可缓存页面将被标记为不可缓存。这一点很重要，因为如果所有 cookie 都添加到可缓存的页面上，则所有客户都将从中间的缓存层(如 cdn 端的缓存层)获取页面，并且将共享同一个 Cookie，从而导致某台后端服务器接收的流量远远超过其他后端服务器。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9112cookie-prefix">9.1.1.2、cookie prefix<a class="hash-link" href="#9112cookie-prefix" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">prefix    This keyword indicates that instead of relying on a dedicated</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          cookie </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> the persistence, an existing one will be completed.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          This may be needed </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> some specific environments where the client</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          does not support </span><span class="token function" style="color:rgb(0, 0, 255)">more</span><span class="token plain"> than one single cookie and the application</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          already needs it. In this case, whenever the server sets a cookie</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          named </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">name</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">, it will be prefixed with the server</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;s identifier</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">          and a delimiter. The prefix will be removed from all client</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">          requests so that the server still finds the cookie it emitted.</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">          Since all requests and responses are subject to being modified,</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">          this mode doesn&#x27;</span><span class="token plain">t work with tunnel mode. The </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;prefix&quot;</span><span class="token plain"> keyword is</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          not compatible with </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;rewrite&quot;</span><span class="token plain"> and </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;insert&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token plain"> Note: it is highly</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          recommended not to use </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;indirect&quot;</span><span class="token plain"> with </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;prefix&quot;</span><span class="token plain">, otherwise server</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          cookie updates would not be sent to clients.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>haproxy 将在已存在的 cookie(例如后端应用服务器设置的)上添加前缀 cookie 值，这个前缀部分是 server 指令中的 cookie 设置的，代表的是<strong>服务端标识符</strong>。</li><li>在客户端再次访问时，haproxy 将会自动移除这部分前缀，使得服务端只能看到它自己发出的 cookie。在一些特殊环境下，客户端不支持多个 &quot;Set-Cookie&quot; 字段，这时可以使用 prefix。</li><li>使用 prefix 的时候，<strong>cookie 指令设置的 cookie 名必须和后端设置的 cookie 一样(在本文的环境中是 PHPSESSID)</strong>，否则 prefix 模式下的 haproxy 不会对响应报文做任何改变。</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">backend DynamicGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    cookie PHPSESSID prefix</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server app1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.102:80 cookie app_server1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server app2 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.103:80 cookie app_server2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如下图：</p><p><img loading="lazy" alt="haproxy cookie detail5" src="/en/assets/images/haproxy cookie detail5-b11ea9d3b56a8ef1115563fcefdc8a4f.png" width="1054" height="699" class="img_ev3q"></p><ul><li>从后端 nginx 上的日志上查看 haproxy 转发过来的请求，可以看到前缀已经被 haproxy 去掉了。</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token assign-left variable" style="color:rgb(9, 134, 88)">PHPSESSID</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">k9cno2au088uhnm2na4rk99hv7 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.101</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9113cookie-rewrite">9.1.1.3、cookie rewrite<a class="hash-link" href="#9113cookie-rewrite" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">rewrite   This keyword indicates that the cookie will be provided by the</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          server and that HAProxy will have to modify its value to </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">set</span><span class="token plain"> the</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          server</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;s identifier in it. This mode is handy when the management</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">          of complex combinations of &quot;Set-cookie&quot; and &quot;Cache-control&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">          headers is left to the application. The application can then</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">          decide whether or not it is appropriate to emit a persistence</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">          cookie. Since all responses should be monitored, this mode</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">          doesn&#x27;</span><span class="token plain">t work </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> HTTP tunnel mode. Unless the application</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          behavior is very complex and/or broken, it is advised not to</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          start with this mode </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> new deployments. This keyword is</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">          incompatible with </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;insert&quot;</span><span class="token plain"> and </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;prefix&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>当后端服务器设置了 cookie 时，使用 rewrite 模式时，haproxy 将重写该 cookie 的<strong>值</strong>为后端服务器的标识符。</li><li>当应用程序需要同时考虑 &quot;Set-Cookie&quot; 和 &quot;Cache-control&quot; 字段时，该模式非常方便，因为应用程序可以决定是否应该设置一个为了保持会话的 cookie。除非后端应用程序的环境非常复杂，否则不建议使用该模式。</li><li>同样，rewrite 模式下的 haproxy 设置的 cookie 必须和后端服务器设置的 cookie 名称一致，否则不会做任何改变。</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">backend DynamicGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    cookie PHPSESSID rewrite</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server app1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.102:80 cookie app_server1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server app2 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.103:80 cookie app_server2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>结果如下图：</p><p><img loading="lazy" alt="haroxy cookie detail6" src="/en/assets/images/haproxy cookie detail6-dc1a3d6eaf56da1064c8b70a05e13c41.png" width="1052" height="697" class="img_ev3q"></p><ul><li>但是，当客户端持着 &quot;PHPSESSID=app<!-- -->_<!-- -->server1&quot; 再去请求服务器时，haproxy 将其分配给 app1，app1 此时收到的 cookie 将是重写后的，但是 app1 根本就不认识这个 cookie，后面的代码可能因此而失去逻辑无法进行正确处理。</li><li>后端 nginx 的日志如下：</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token assign-left variable" style="color:rgb(9, 134, 88)">PHPSESSID</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">app_server1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.101</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="912haproxy-cookie-保持或忽略会话">9.1.2、haproxy cookie 保持或忽略会话<a class="hash-link" href="#912haproxy-cookie-保持或忽略会话" title="Direct link to heading">​</a></h3><p>在 haproxy 中，haproxy 会监控、修改、增加 cookie，这都是通过内存中的 cookie 表实现的。</p><p>cookie 表中记录了它自己增、改的 cookie 记录，包括 cookie 名和对应 server 的 cookie 值，通过这个 cookie 记录，haproxy 就能知道请求该交给哪个后端。</p><p><img loading="lazy" alt="haproxy cookie" src="/en/assets/images/haproxy cookie-0147a1acf2ccdddd8bc06db9dd24ffc4.png" width="1044" height="479" class="img_ev3q"></p><p>如图所示，当 haproxy 成功修改了响应报文中的 cookie 时，将在 cookie 表中插入一条记录，这条记录是维持会话的依据。</p><p>其实，通过 cookie 表保持和后端的会话只是默认情况，haproxy 允许 &quot;即使使用了 cookie 也不进行会话绑定&quot; 的功能。这可以通过 <code>ignore-persist</code> 指令来实现。当满足该指令的要求时，表示不将该 cookie 插入到 cookie 表中，因此无法实现会话保持，即使 haproxy 设置了 cookie 也没用。</p><p>例如，在 backend 中指定如下配置：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">backend DynamicGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    acl url_static  path_beg         /static /images /img /css</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    acl url_static  path_end         .gif .png .jpg .css .js</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ignore-persist  </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> url_static</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    cookie app_cook insert nocache</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server app1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.102:80 cookie app_server1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server app2 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.103:80 cookie app_server2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>这表示 uri 满足 acl 中指定的静态网页时，将不进行会话保持。</li><li>与 <code>ignore-persist</code> 相对的是 <code>force-persist</code>，但不建议使用该选项，因为它和 <code>option redispatch</code> 冲突。</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="92haproxy-stick-table">9.2、haproxy stick table<a class="hash-link" href="#92haproxy-stick-table" title="Direct link to heading">​</a></h2><p>stick table 是 haproxy 的一个非常优秀的特性，这个表里面存储的是 stickiness 记录，stickiness 记录了客户端和服务端 1:1 对应的引用关系。通过这个关系，haproxy 可以将客户端的请求引导到之前为它服务过的后端服务器上，也就是实现了会话保持的功能。这种记录方式，俗称<strong>会话粘性</strong>(stickiness)，即将客户端和服务端粘连起来。</p><p>stick table 实现会话粘性的过程如下图：</p><p><img loading="lazy" alt="haproxy stick-table" src="/en/assets/images/haproxy stick-table-cc93f996a228c114a718716919fd2134.png" width="1035" height="453" class="img_ev3q"></p><ol><li><p>stick table 中使用 key/value 的方式映射客户端和后端服务器，key 是客户端的标识符，可以使用客户端的源 ip(50字节)、cookie 以及从报文中过滤出来的部分 String。value 部分是服务端的标识符。</p></li><li><p>除了存储 key/value 实现最基本的粘性，stick table 还可以额外存储每个 stickiness 记录对应的<strong>状态统计数据</strong>。比如 stickiness 记录 1 目前建立了多少和客户端的连接、平均建立连接的速度是多少、流入流出了多少字节的数据、建立会话的数量等等。</p></li><li><p>stick table 可以<strong>在 &quot;双主模型&quot; 下进行复制</strong>(replication)。只要设置好对端 haproxy 节点，haproxy 就会自动将新插入的、刚更新的记录通过 TCP 连接推送到对端节点上。</p><ul><li>这样一来，粘性记录不会丢失，即使某 haproxy 节点出现了故障，其他节点也能将客户端按照粘性映射关系引导到正确的后端服务器上。</li><li><strong>而且每条 stickiness 记录占用空间都很小(平均最小 50 字节，最大 166 字节，由是否记录额外统计数据以及记录多少来决定占用空间大小)，使得即使在非常繁忙的环境下在几十个节点之间推送都不会出现压力瓶颈和网络阻塞</strong>(可以按节点数量、stickiness 记录的大小和平均并发量来计算每秒在网络间推送的数据流量)。</li></ul></li><li><p>stick table 还可以在 haproxy 重启时，<strong>在新旧两个进程间进行复制</strong>，这是本地复制。</p><ul><li>当 haproxy 重启时，旧 haproxy 进程会和新 haproxy 进程建立 TCP 连接，将其维护的 stick table 推送给新进程。</li><li>这样新进程不会丢失粘性信息，和其他节点也能最大程度地保持同步，使得其他节点只需要推送该节点重启过程中新增加的 stickiness 记录就能完全保持同步。</li></ul></li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="921使用-stick-table">9.2.1、使用 stick table<a class="hash-link" href="#921使用-stick-table" title="Direct link to heading">​</a></h3><p>下图是本文测试时的环境：</p><p><img loading="lazy" alt="haproxy stick-table detail" src="/en/assets/images/haproxy stick-table detail-22003381776bdb008e3fbfcddfa69f30.png" width="748" height="524" class="img_ev3q"></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9211创建-stick-table">9.2.1.1、创建 stick table<a class="hash-link" href="#9211创建-stick-table" title="Direct link to heading">​</a></h4><p>首先看创建 stick table 的语法：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">stick-table </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">type</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">ip </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> integer </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> string </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">len </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">length</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> binary </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">len </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">length</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            size </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">size</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">expire </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">expire</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">nopurge</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">peers </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">peersect</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">srvkey </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">srvkey</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">store </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">data_type</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>type ip | integer | string</code>：使用什么类型的 key 作为客户端标识符。可以是客户端的源 IP，可以是一个整数 ID 值，也可以是一段从请求报文或响应报文中匹配出来的字符串。</li><li><code>size</code>：表中允许的最大 stickiness 记录数量。单位使用 k、m 和 g 表示，分别表示 1024、2^20 和 2^30 条记录。</li><li><code>expire</code>：stickiness 记录的过期时长。当某记录被操作后，过了一段时间就会过期，过期的记录会自动从 stick table 中移除，释放表空间。</li><li><code>nopurge</code>：默认情况下，当表满后，如果还有新的 stickiness 记录要插入进来，haproxy 会自动将一部分老旧的 stickiness 记录 flush 掉，以释放空间存储新纪录。指定 nopurge 后，将不进行 flush，只能通过记录过期来释放表空间，因此该选项必须配合 expire 选项同时使用。</li><li><code>peers</code>：指定要将 stick table 中的记录 replication 到对端 haproxy 节点。</li><li><code>store</code>：指定要存储在 stick table 中的额外状态统计数据。其中代表后端服务器的标识符 server ID(即 key/value 的 value 部分)会自动插入，无需显式指定。</li></ul><p>注意，每个<strong>后端组只能建立一张 stick table，每个 stick table 的 id 或名称等于后端组名</strong>。例如在 <code>backend StaticGroup</code> 后端创建 stick table，则该表的 id 为 &quot;StaticGroup&quot;。也有特殊方法建立多张，但没有必要，可翻官方手册找方法。</p><p>例如，创建一个以源 IP 地址为 key 的 stick table，该表允许 100W 条记录，5 分钟的记录过期时长，并且不记录任何额外数据。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">stick-table </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">type</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> size 1m expire 5m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>这张表由于没有记录额外的统计数据，每条 stickiness 记录在内存中只占用 50 字节左右的空间，表满后整张表在内存中占用 50MB(2^20<!-- -->*<!-- -->50/1024/1024=50MB)。看上去很大，但检索速度是极快的，完全不用担心性能问题。</li><li>如果还要存储和客户端建立的连接数量计数器(conn<!-- -->_<!-- -->cnt)，则：</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">stick-table </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">type</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> size 1m expire 5m store conn_cnt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>conn<!-- -->_<!-- -->cnt 占用 32 个 bit 位，即 4 字节，因此每条 stickiness 记录占用 54 字节，100W 条记录占用 54M 内存空间。</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9212查看-stick-table">9.2.1.2、查看 stick table<a class="hash-link" href="#9212查看-stick-table" title="Direct link to heading">​</a></h4><p>haproxy 没有直接的接口可以显示 stick table 的相关信息，只能通过 <code>stats socket</code> 进行查看。该指令表示开启一个本地 unix 套接字监听 haproxy 的信息，通过这个套接字可以查看 haproxy 的很多信息，且能动态调整 haproxy 配置。</p><p>首先在 haproxy 的配置文件中开启 &quot;stats socket&quot; 状态信息，如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">global</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stats socket /var/run/haproxy.sock mode </span><span class="token number" style="color:rgb(9, 134, 88)">600</span><span class="token plain"> level admin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stats </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> 2m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>默认 stats timeout 的过期时长为 10s，建议设置长一点。上面还设置了 socket 的权限级别，表示能访问(600)这个套接字的人具有所有权限(admin)。</li><li>level 还有两种权限级别更低一点的值 &quot;read&quot; 和 &quot;operator&quot;(默认)，前者表示只有读取信息的权限，不能设置或删除、清空某些信息，后者表示具备读和某些设置权限。</li></ul><p>本地套接字监听 haproxy 后，可以通过 &quot;socat&quot; 工具(socket cat，很强大的工具，在 epel 源中提供)从套接字来操作 haproxy。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 方式一：直接传递要执行的操作给套接字</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;help&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> socat unix:/var/run/haproxy.sock -</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 方式二：进入交互式模式，然后在交互式模式下执行相关操作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">socat readline unix:/var/run/haproxy.sock</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果要监控某些状态信息的实时变化，可以使用 <code>watch</code> 命令。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">watch</span><span class="token plain"> -n </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;&quot;echo show table&quot; | socat unix:/var/run/haproxy.sock -&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>haproxy 支持以下列出的所有操作命令：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@c79arm1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># echo &quot;help&quot; | socat unix:/var/run/haproxy.sock -</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">The following commands are valid at this level:</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> acl </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">@</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">ver</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">acl</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">pattern</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> an acl entry</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> map </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">@</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">ver</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">map</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">key</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">val</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">      </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">add</span><span class="token plain"> a map entry </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">payload supported instead of key/val</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token function" style="color:rgb(0, 0, 255)">clear</span><span class="token plain"> acl </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">@</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">ver</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">acl</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">                </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">clear</span><span class="token plain"> the contents of this acl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token function" style="color:rgb(0, 0, 255)">clear</span><span class="token plain"> counters </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">all</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">                    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">clear</span><span class="token plain"> max statistics counters </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">or all counters</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token function" style="color:rgb(0, 0, 255)">clear</span><span class="token plain"> map </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">@</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">ver</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">map</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">                </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">clear</span><span class="token plain"> the contents of this map</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token function" style="color:rgb(0, 0, 255)">clear</span><span class="token plain"> table </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">table</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">filter</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">*         </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> remove an entry from a table </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">filter: data/key</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  commit acl @</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">ver</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">acl</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">                 </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> commit the ACL at this version</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  commit map @</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">ver</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">map</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">                 </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> commit the map at this version</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  del acl </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">acl</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">key</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;|</span><span class="token comment" style="color:rgb(0, 128, 0)">#&lt;ref&gt;]            : delete acl entries matching &lt;key&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  del map </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">map</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">key</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;|</span><span class="token comment" style="color:rgb(0, 128, 0)">#&lt;ref&gt;]            : delete map entries matching &lt;key&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  disable agent                           </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> disable agent checks</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  disable dynamic-cookie backend </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">bk</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> disable dynamic cookies on a specific backend</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  disable frontend </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">frontend</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">             </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> temporarily disable specific frontend</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  disable health                          </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> disable health checks</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  disable server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">DEPRECATED</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">             </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> disable a server </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> maintenance </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">use </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;set server&#x27;</span><span class="token plain"> instead</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"> agent                            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"> agent checks</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"> dynamic-cookie backend </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">bk</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">      </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"> dynamic cookies on a specific backend</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"> frontend </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">frontend</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">              </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> re-enable specific frontend</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"> health                           </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"> health checks</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"> server  </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">DEPRECATED</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">             </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">enable</span><span class="token plain"> a disabled server </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">use </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;set server&#x27;</span><span class="token plain"> instead</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  get acl </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">acl</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">value</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">                   </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> report the patterns matching a sample </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> an ACL</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  get map </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">acl</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">value</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">                   </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> report the keys and values matching a sample </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> a map</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  get var </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">name</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">                          </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> retrieve contents of a process-wide variable</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  get weight </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">bk</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">/</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">srv</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">                   </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> report a server</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;s current weight</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  operator                                : lower the level of the current CLI session to operator</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  prepare acl &lt;acl&gt;                       : prepare a new version for atomic ACL replacement</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  prepare map &lt;acl&gt;                       : prepare a new version for atomic map replacement</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  set dynamic-cookie-key backend &lt;bk&gt; &lt;k&gt; : change a backend secret key for dynamic cookies</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  set map &lt;map&gt; [&lt;key&gt;|#&lt;ref&gt;] &lt;value&gt;    : modify a map entry</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  set maxconn frontend &lt;frontend&gt; &lt;value&gt; : change a frontend&#x27;</span><span class="token plain">s maxconn setting</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">set</span><span class="token plain"> maxconn global </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">value</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">              </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> change the per-process maxconn setting</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">set</span><span class="token plain"> maxconn server </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">bk</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">/</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">srv</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">           </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> change a server</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;s maxconn setting</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  set profiling &lt;what&gt; {auto|on|off}      : enable/disable resource profiling (tasks,memory)</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  set rate-limit &lt;setting&gt; &lt;value&gt;        : change a rate limiting value</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  set server &lt;bk&gt;/&lt;srv&gt; [opts]            : change a server&#x27;</span><span class="token plain">s state, weight, address or ssl</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">set</span><span class="token plain"> severity-output </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">none</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">number</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">string</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">: </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">set</span><span class="token plain"> presence of severity level </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> feedback information</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">set</span><span class="token plain"> table </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">table</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> key </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">k</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">data.* </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">v</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">* </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> update or create a table entry</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;s data</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  set timeout [cli] &lt;delay&gt;               : change a timeout setting</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  set weight &lt;bk&gt;/&lt;srv&gt;  (DEPRECATED)     : change a server&#x27;</span><span class="token plain">s weight </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">use </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;set server&#x27;</span><span class="token plain"> instead</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  show acl </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">@</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">ver</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">acl</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">                </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> report available acls or dump an acl</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;s contents</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  show activity                           : show per-thread activity stats (for support/developers)</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  show backend                            : list backends in the current running config</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  show cache                              : show cache status</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  show cli level                          : display the level of the current CLI session</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  show cli sockets                        : dump list of cli sockets</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  show env [var]                          : dump environment variables known to the process</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  show errors [&lt;px&gt;] [request|response]   : report last request and/or response errors for each proxy</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  show events [&lt;sink&gt;] [-w] [-n]          : show event sink state</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  show fd [num]                           : dump list of file descriptors in use or a specific one</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  show info [desc|json|typed|float]*      : report information about the running process</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">  show map [@ver] [map]                   : report available maps or dump a map&#x27;</span><span class="token plain">s contents</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  show peers </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">dict</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">-</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">section</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">           </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> dump some information about all the peers or this peers section</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  show pools                              </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> report information about the memory pools usage</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  show profiling </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">what</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;|</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token comment" style="color:rgb(0, 128, 0)">#lines&gt;|byaddr]*: show profiling state (all,status,tasks,memory)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  show resolvers </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">                     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> dumps counters from all resolvers section and associated name servers</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  show schema json                        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> report schema used </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> stats</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  show servers conn </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">backend</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">           </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> dump server connections status </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">all or </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> a single backend</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  show servers state </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">backend</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">          </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> dump volatile server information </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">all or </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> a single backend</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  show sess </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">                          </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> report the list of current sessions or dump this exact session</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  show startup-logs                       </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> report logs emitted during HAProxy startup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  show </span><span class="token function" style="color:rgb(0, 0, 255)">stat</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">desc</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">json</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">no-maint</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">typed</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">up</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">*: report counters </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> each proxy and server</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  show table </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">table</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">filter</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">*          </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> report table usage stats or dump this table&#x27;s contents </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">filter: data/key</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  show tasks                              </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> show running tasks</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  show threads                            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> show some threads debugging information</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  show trace </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">module</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">                   </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> show live tracing state</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token function" style="color:rgb(0, 0, 255)">shutdown</span><span class="token plain"> frontend </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">frontend</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">            </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> stop a specific frontend</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token function" style="color:rgb(0, 0, 255)">shutdown</span><span class="token plain"> session </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">                   </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">kill</span><span class="token plain"> a specific session</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token function" style="color:rgb(0, 0, 255)">shutdown</span><span class="token plain"> sessions server </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">bk</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">/</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">srv</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">     </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">kill</span><span class="token plain"> sessions on a server</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  trace </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">module</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;|</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">cmd </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">args</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">      </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> manage live tracing </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">empty to list, </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> to stop all</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  user                                    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> lower the level of the current CLI session to user</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">help</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">command</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">                        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> list matching or all commands</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  prompt                                  </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> toggle interactive mode with prompt</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">  quit                                    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> disconnect</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@c79arm1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中和 stick table 相关的命令有：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">clear</span><span class="token plain"> table    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> remove an entry from a table</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">set</span><span class="token plain"> table </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">:</span><span class="token plain"> update or create a table entry</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;s data</span><br></span><span class="token-line" style="color:#000000"><span class="token string" style="color:rgb(163, 21, 21)">show table [id]: report table usage stats or dump this table&#x27;</span><span class="token plain">s contents</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们实验中 stick-table 配置如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 查看一下 stick-table 设置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@c79arm1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># grep -B 1 &quot;stick-table&quot; /etc/haproxy/haproxy.cfg </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">backend StaticGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stick-table </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">type</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> size 5k expire 1m</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">--</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">backend DynamicGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stick-table </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">type</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> size 5k expire 1m</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@c79arm1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@c79arm1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># echo &quot;show table&quot; | socat unix:/var/run/haproxy.sock -</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># table: DynamicGroup, type: ip, size:5120, used:0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># table: StaticGroup, type: ip, size:5120, used:0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@c79arm1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意：本文只是引入 <code>stats socket</code> 的操作方式，至于各命令的作用，参见官方手册：<code>http://cbonte.github.io/haproxy-dconv/2.4/management.html#9.3</code></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9213客户端源-ip-标识">9.2.1.3、客户端源 IP 标识<a class="hash-link" href="#9213客户端源-ip-标识" title="Direct link to heading">​</a></h4><p>配置文件部分内容如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">frontend http-in</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain">             *:80</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    mode             http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    log              global</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    capture request  header Host len </span><span class="token number" style="color:rgb(9, 134, 88)">20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    capture request  header Referer len </span><span class="token number" style="color:rgb(9, 134, 88)">60</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    acl url_static   path_beg  -i /static /images /stylesheets</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    acl url_static   path_end  -i .jpg .jpeg .gif .png .ico .bmp .css .js</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    acl url_static   path_end  -i .html .htm .shtml .shtm .pdf .mp3 .mp4 .rm .rmvb .txt</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    acl url_static   path_end  -i .zip .rar .gz .tgz .bz2 .tgz</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    use_backend      StaticGroup   </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> url_static</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    default_backend  DynamicGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">backend StaticGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stick-table </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">type</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> size 5k expire 1m</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stick on src</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    balance            roundrobin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option             http-keep-alive</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http-reuse         safe</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option httpchk     GET /index.html</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http-check </span><span class="token function" style="color:rgb(0, 0, 255)">expect</span><span class="token plain">  status </span><span class="token number" style="color:rgb(9, 134, 88)">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server staticsrv1  </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.104:80 check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">5000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server staticsrv2  </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.105:80 check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">5000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">backend DynamicGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stick-table </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">type</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> size 5k expire 1m</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stick on src</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    balance roundrobin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option http-server-close</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option httpchk     GET /index.php</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http-check </span><span class="token function" style="color:rgb(0, 0, 255)">expect</span><span class="token plain">  status </span><span class="token number" style="color:rgb(9, 134, 88)">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server appsrv1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.102:80  check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">3000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server appsrv2 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.103:80  check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">3000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>上面的配置中，设置了acl，当满足静态访问时，使用 StaticGroup 后端组，否则使用 DynamicGroup 后端组。</li><li>在两个后端组中，都设置了 <code>stick-table</code> 和 <code>stick on</code>，其中 <code>stick on</code> 是存储指定内容，并在请求到达时匹配该内容，它的具体用法见后文。只有配置了 <code>stick on</code> 后，haproxy 才能根据匹配的结果决定是否存储到 stick table 中，以及如何筛选待分派的后端。</li><li>总之，上面的两个后端组都已经指定了要向 stick table 中存储源 ip 地址作为 key。当客户端请求到达时，haproxy 根据调度算法分配一个后端，但请求交给后端成功后，Haproxy 立即向 stick table 表中插入一条 stickiness 记录。<ul><li>当客户端请求再次到达时，haproxy 发现能匹配源 ip，于是按照该 stickiness 记录，将请求分配给对应的后端。</li></ul></li></ul><p>以下是分别使用两台机器测试 <code>192.168.122.101/index.html</code> 和 <code>192.168.122.101/index.php</code> 后，stick table 记录的数据。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@c79arm1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># echo &quot;show table DynamicGroup&quot; | socat unix:/var/run/haproxy.sock - </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># table: DynamicGroup, type: ip, size:5120, used:2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0x201effb0: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.1 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">43604</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff78033970: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.106 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">50021</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@c79arm1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># echo &quot;show table StaticGroup&quot; | socat unix:/var/run/haproxy.sock - </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># table: StaticGroup, type: ip, size:5120, used:2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0x201ef980: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.1 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">37314</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">staticsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff70033900: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.106 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">50135</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">staticsrv2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>其中 server<!-- -->_<!-- -->id 默认是从 1 自增的，它可以在 server 指令中用 &quot;id&quot; 选项进行显式指定。例如：</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">server appsrv1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.102:80 </span><span class="token function" style="color:rgb(0, 0, 255)">id</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">123</span><span class="token plain"> check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">3000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9214客户端-cookie-标识">9.2.1.4、客户端 cookie 标识<a class="hash-link" href="#9214客户端-cookie-标识" title="Direct link to heading">​</a></h4><p>一般会话保持考虑的对象是应用程序服务器，因此此处我们忽略后端的静态服务器，只考虑 php 应用服务器。在 DynamicGroup 两个后端 server appsrv1 和 server appsrv2 的 index.php 中分别设置好 PHPSESSID 作为测试。例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">response from webapp </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.10</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">2</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">?php</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        session_start</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Server IP: &quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;font color=red&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token variable" style="color:rgb(9, 134, 88)">$_SERVER</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;SERVER_ADDR&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;/font&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;br&gt;&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Server Name: &quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;font color=red&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token variable" style="color:rgb(9, 134, 88)">$_SERVER</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;SERVER_NAME&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;/font&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;br&gt;&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;SESSIONNAME: &quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;font color=red&gt;&quot;</span><span class="token plain">.session_name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;/font&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;br&gt;&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;SESSIONID: &quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;font color=red&gt;&quot;</span><span class="token plain">.session_id</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;/font&gt;&quot;</span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">.</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;&lt;br&gt;&quot;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">?</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>cookie 是 string 的一种特殊情况，因此创建 stick table 时，指定 type 为 string。以下是在 haproxy 上的配置：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">backend DynamicGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stick-table </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">type</span><span class="token plain"> string len </span><span class="token number" style="color:rgb(9, 134, 88)">32</span><span class="token plain"> size 5k expire 2m</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stick on req.cook</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">PHPSESSID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stick store-response res.cook</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">PHPSESSID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    balance roundrobin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option http-server-close</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option httpchk     GET /index.php</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http-check </span><span class="token function" style="color:rgb(0, 0, 255)">expect</span><span class="token plain">  status </span><span class="token number" style="color:rgb(9, 134, 88)">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server appsrv1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.102:80  check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">3000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server appsrv2 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.103:80  check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">3000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>stick store-response</code> 指令表示从响应报文中匹配某些数据出来，然后存储到 stick table 中，此处表示截取响应报文中 &quot;Set-Cookie&quot; 字段中名为 &quot;PHPSESSID&quot; 的 cookie 名进行存储。</li><li><code>stick on req.cook(PHPSESSID)</code> 表示从请求报文的 &quot;Cookie&quot; 字段中匹配名为 PHPSESSID 的 cookie。如果能和存储在 stick table 中的 PHPSESSID 匹配成功，则表示该客户端被处理过，于是将其引导到对应的后端服务器上。严格地说，这里不是识别客户端，而是通过 PHPSESSID 来识别后端。</li></ul><p>浏览器请求后发生会话粘性，在 haproxy 上查看 stick table：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@c79arm1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># echo &quot;show table DynamicGroup&quot; | socat unix:/var/run/haproxy.sock - </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># table: DynamicGroup, type: string, size:5120, used:1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffffb8027320: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">8bvq7fcvprj29oj6s1n0djokk5 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">117654</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@c79arm1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>注意，不要使用 curl 命令来测试，因为这里是根据 PHPSESSID 匹配的，curl 每次接收到响应后进程就直接退出了，无法缓存 cookie，因此 curl 每次请求都相当于一次新请求。</strong></li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9215客户端-string-标识">9.2.1.5、客户端 string 标识<a class="hash-link" href="#9215客户端-string-标识" title="Direct link to heading">​</a></h4><p>上面的 cookie 是 string 的一种特殊用法。使用 string 筛选内容进行存储，灵活性非常大，可以通过它实现某些复杂、特殊的需求。</p><p>例如，从请求报文中截取 Host 字段的值作为 key 存储起来。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">backend DynamicGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stick-table </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">type</span><span class="token plain"> string size 5k expire 2m</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stick on req.hdr</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">Host</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    balance roundrobin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option http-server-close</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option httpchk     GET /index.php</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http-check </span><span class="token function" style="color:rgb(0, 0, 255)">expect</span><span class="token plain">  status </span><span class="token number" style="color:rgb(9, 134, 88)">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server appsrv1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.102:80  check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">3000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server appsrv2 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.103:80  check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">3000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>找一台 linux 客户端使用 curl 进行测试，发现所有请求都将引导到同一后端服务器上。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># for i in {1..8};do grep &quot;response&quot; &lt;(curl 192.168.122.101/index.php 2&gt; /dev/null);done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">response from webapp </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.10</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">2</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">response from webapp </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.10</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">2</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">response from webapp </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.10</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">2</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">response from webapp </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.10</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">2</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">response from webapp </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.10</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">2</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">response from webapp </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.10</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">2</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">response from webapp </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.10</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">2</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain">response from webapp </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.10</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">2</span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">/h</span><span class="token operator file-descriptor important" style="color:rgb(0, 0, 0)">1</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@yidam ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>查看 stick table 也只能看到一条记录，而且其 key 部分正是捕获到的 Host 字段的值。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">root@c79arm1 ~</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token comment" style="color:rgb(0, 128, 0)"># echo &quot;show table DynamicGroup&quot; | socat unix:/var/run/haproxy.sock - </span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># table: DynamicGroup, type: string, size:5120, used:1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0x1dbfa00: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.101 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">65915</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9216stick-onstick-matchstick-store">9.2.1.6、stick on、stick match、stick store<a class="hash-link" href="#9216stick-onstick-matchstick-store" title="Direct link to heading">​</a></h4><p>在前面 haproxy 的配置中出现过 <code>stick on</code> 和 <code>stick store-response</code>，除此之外，还有两个指令 <code>stick match</code>、<code>stick store-request</code>。语法如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">stick store-request </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">pattern</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">table </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">table</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">if </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> unless</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">condition</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">stick store-response </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">pattern</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">table </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">table</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">if </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> unless</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">condition</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">stick match </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">pattern</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">table </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">table</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">if </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> unless</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">cond</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">stick on </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">pattern</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">table </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">table</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain">if </span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain"> unless</span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">condition</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>其中 <code>stick store</code> 指令是从请求或响应报文中截取一部分字符串出来，并将其作为 stickiness 的 key 存储到 stick table 中。例如：</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 截取响应报文中名为PHPSESSID的cookie作为key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">stick store-response res.cook</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">PHPSESSID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 截取请求报文中Host字段的值作为key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">stick store-request req.hdr</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">Host</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 对请求的源ip地址进行匹配，若不是兄弟网络中的主机时，就写入stick table中，且该table名为DynamicGroup</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">stick store-request src table DynamicGroup </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token plain">my_brother</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>stick match</code> 是将请求报文中的指定部分和 stick table 中的记录进行匹配。例如：</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 截取请求报文中名为PHPSESSID的cookie，去stick table中搜索是否存在对应的记录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">stick match req.cook</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">PHPSESSID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 当源IP不是本机时，去DynamicGroup表中搜索是否有能匹配到源IP地址的记录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">stick match src table DynamicGroup </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token plain">localhost</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>stick on</code> 等价于 <code>stick store</code>+<code>stick match</code>，是它们的简化写法。例如：</li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)"># 存储并匹配源IP地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">stick on src               </span><span class="token comment" style="color:rgb(0, 128, 0)">#1 = #2 + #3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">stick match src            </span><span class="token comment" style="color:rgb(0, 128, 0)">#2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">stick store-request src    </span><span class="token comment" style="color:rgb(0, 128, 0)">#3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 存储并匹配源IP地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">stick on src table DynamicGroup </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token plain">localhost             </span><span class="token comment" style="color:rgb(0, 128, 0)">#1 = #2 + #3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">stick match src table DynamicGroup </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token plain">localhost          </span><span class="token comment" style="color:rgb(0, 128, 0)">#2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">stick store-request src table DynamicGroup </span><span class="token keyword" style="color:rgb(0, 0, 255)">if</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">!</span><span class="token plain">localhost  </span><span class="token comment" style="color:rgb(0, 128, 0)">#3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># 存储并匹配后端服务器设置的PHPSESSID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">stick on req.cook</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">PHPSESSID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">                 </span><span class="token comment" style="color:rgb(0, 128, 0)">#1 +#2 = #3 + #4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">stick store-response res.cook</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">PHPSESSID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">     </span><span class="token comment" style="color:rgb(0, 128, 0)">#2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">stick match req.cook</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">PHPSESSID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">              </span><span class="token comment" style="color:rgb(0, 128, 0)">#3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">stick store-response res.cook</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">PHPSESSID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain">     </span><span class="token comment" style="color:rgb(0, 128, 0)">#4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9217stick-table-统计状态信息">9.2.1.7、stick table 统计状态信息<a class="hash-link" href="#9217stick-table-统计状态信息" title="Direct link to heading">​</a></h4><p>stick table 除了存储基本的粘性信息，还能存储额外的统计数据，这其实是 haproxy 提供的一种 &quot;<strong>采样调查</strong>&quot; 功能。它能采集的数据种类有以下几种：</p><p><img loading="lazy" alt="haproxy samples" src="/en/assets/images/haproxy samples-8a2512f0fe496d3a1de8f8f918f89e19.png" width="778" height="668" class="img_ev3q"></p><p>每个 stickiness 记录中可以同时存储多个记录类型，使用逗号分隔或多次使用 store 关键字即可。但注意，后端服务器的 server id 会自动记录，其它所有额外信息都需要显式指定。</p><p>需要注意，每个 haproxy 后端组只能有一张 stick table，但却不建议统计太多额外的状态信息，因为每多存一个类型，意味着使用更多的内存。</p><p>如果存储所有上述列出的数据类型，需要 116 字节，100W 条记录要用 116M，这不是可以忽略的大小。此外还有 50M 的 key，共 166M。</p><p>例如下面的示例中，使用了通用计数器累计，并记录了每 30 秒内的平均连接速率。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">stick-table </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">type</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> size 1m expire 5m store gpc0,conn_rate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">30s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="93haproxy-stick-table-复制">9.3、haproxy stick table 复制<a class="hash-link" href="#93haproxy-stick-table-复制" title="Direct link to heading">​</a></h2><p>在上一节中，分析了 haproxy 的 stick table 特性和用法，其中特性之一也是很实用的特性是 stick table 支持在 haproxy 多个节点之间进行复制(replication)。</p><p>本文仅讨论如何配置实现 stick table 的复制功能，不考虑在什么环境下实现它，以及它的双主模型如何配置。</p><p>本文实验环境：</p><p><img loading="lazy" alt="haproxy replication" src="/en/assets/images/haproxy replication-e2384410fd04632ba5333432f9e58940.png" width="682" height="592" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="931stick-table-复制特性">9.3.1、stick table 复制特性<a class="hash-link" href="#931stick-table-复制特性" title="Direct link to heading">​</a></h3><ol><li>只要设置好 haproxy 的节点组，haproxy 就会自动将新插入的、刚更新的 stickiness 记录通过 TCP 连接推送到节点组中的非本地节点上。<ul><li>这样一来，stickiness 记录不会丢失，即使某 haproxy 节点出现了故障，其他节点也能将客户端按照粘性映射关系引导到正确的后端服务器上。</li></ul></li><li>由于每条 stickiness 记录占用空间都很小(平均最小 50 字节，最大 166 字节，由是否记录额外统计数据以及记录多少来决定占用空间大小)，使得即使在非常繁忙的环境下多个节点之间推送都不会出现压力瓶颈和网络阻塞(可以按节点数量、stickiness 记录的大小和平均并发量来计算每秒在网络间推送的数据流量)。</li><li>stick table 复制不像被人诟病的 session 复制(copy)，因为 session 复制的数据量比较大，而且是在各应用程序服务器之间进行的。而一个稍大一点的核心应用，提供服务的应用程序服务器数量都不会小，这样复制起来很容出现网络阻塞。</li><li>此外，stick table 还可以在 haproxy 重启时，在新旧两个进程间进行复制，这是本地复制。<ul><li>当 haproxy 重启时，旧 haproxy 进程会和新 haproxy 进程建立 TCP 连接，将其维护的 stick table 推送给新进程。</li><li>这样新进程不会丢失粘性信息，和其他节点也能最大程度地保持同步，使得其他节点只需要推送该节点重启过程中新增加的 stickiness 记录就能完全保持同步。</li></ul></li><li>如果后端使用了 session 共享，在大多数情况下没必要在代理层实现会话保持。如果此时使用 stick table，一般只是为了收集统计数据进行采样调查，但这样的状态统计数据无需在各节点之间进行复制。</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="932定义-haproxy-节点成员">9.3.2、定义 haproxy 节点成员<a class="hash-link" href="#932定义-haproxy-节点成员" title="Direct link to heading">​</a></h3><p>haproxy 提供了 <code>peers</code> 指令，用于定义节点组，<code>peer</code> 指令用于定义节点组中的成员。</p><p>例如，定义本测试环境的节点组：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">peers my_peers    </span><span class="token comment" style="color:rgb(0, 128, 0)"># 节点组名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    peer haproxy1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.101:12138  </span><span class="token comment" style="color:rgb(0, 128, 0)"># 定义对端名称，以及和对端建立tcp连接的端口，用于推送stickiness记录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    peer haproxy2 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.106:12138</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    peer haproxy3 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.107:12138</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后在 <code>stick-table</code> 指令中引用节点组。例如：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">stick-table </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">type</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">ip</span><span class="token plain"> size 100k expire 5m peers my_peers</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意，应当让每个 haproxy 节点的节点组内容一致，然后使用 haproxy 命令的 &quot;-L&quot; 选项指定本地节点成员，这样方便管理每个节点和本地节点。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">haproxy -D -L haproxy1 -f /etc/haproxy/haproxy.cfg</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>如果不指定 &quot;-L&quot;，则在解析配置文件时将默认以主机名作为本地节点名进行解析，但很可能它不会定义在 <code>peers</code> 中，因此会报错。</li></ul><p>因此，如果要实现 stick table 的复制，还想使用 sysV 或 systemctl 管理 haproxy 服务，需要修改这些服务管理脚本，在启动、重启和语法检查项上加上 &quot;-L&quot; 选项。例如，systemd 的 haproxy 服务管理脚本改为如下内容：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Description</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">Haproxy Service</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">After</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">syslog.target network.target</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">Type</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">forking</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecStart</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">/usr/local/haproxy/sbin/haproxy -L haproxy1 -f /etc/haproxy/haproxy.cfg</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ExecStop</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">cd</span><span class="token operator" style="color:rgb(0, 0, 0)">&amp;&amp;</span><span class="token plain">/usr/local/haproxy/sbin/</span><span class="token operator" style="color:rgb(0, 0, 0)">&amp;&amp;</span><span class="token function" style="color:rgb(0, 0, 255)">pkill</span><span class="token plain"> haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">WantedBy</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">multi-user.target</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><em>注意：每个节点要么完全使用 sysV、systemctl 管理 haproxy 的启动、停止，要么完全使用 haproxy 命令手动管理服务的启动和停止，否则可能会出现记录不同步的现象。</em></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="933完成配置">9.3.3、完成配置<a class="hash-link" href="#933完成配置" title="Direct link to heading">​</a></h3><p>如下，是每个 haproxy 节点的配置文件内容。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">global</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    log         </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.1 local2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">chroot</span><span class="token plain">      /var/lib/haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    pidfile     /var/run/haproxy.pid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    maxconn     </span><span class="token number" style="color:rgb(9, 134, 88)">20000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    user        haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    group       haproxy</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    daemon</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stats socket /var/run/haproxy.sock mode </span><span class="token number" style="color:rgb(9, 134, 88)">600</span><span class="token plain"> level admin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    spread-checks </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    peers mypeers </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        peer haproxy1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.101:12138</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        peer haproxy2 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.106:12138</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        peer haproxy3 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.107:12138</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">defaults</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    mode                    http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    log                     global</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option                  httplog</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option                  dontlognull</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option http-server-close</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option forwardfor       except </span><span class="token number" style="color:rgb(9, 134, 88)">127.0</span><span class="token plain">.0.0/8</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option                  redispatch</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> http-request    2s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> queue           3s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> connect         1s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> client          10s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> server          2s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> http-keep-alive 10s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">timeout</span><span class="token plain"> check           2s</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    maxconn                 </span><span class="token number" style="color:rgb(9, 134, 88)">18000</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">frontend http-in</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">bind</span><span class="token plain">             *:80</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    mode             http</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    log              global</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    default_backend  DynamicGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">backend DynamicGroup</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stick-table </span><span class="token builtin class-name" style="color:rgb(38, 127, 153)">type</span><span class="token plain"> string len </span><span class="token number" style="color:rgb(9, 134, 88)">32</span><span class="token plain"> size 5k expire 5m peers mypeers</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stick on req.cook</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">PHPSESSID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    stick store-response res.cook</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">PHPSESSID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    balance roundrobin</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option http-server-close</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option httpchk     GET /index.php</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    option redispatch</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    http-check </span><span class="token function" style="color:rgb(0, 0, 255)">expect</span><span class="token plain">  status </span><span class="token number" style="color:rgb(9, 134, 88)">200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server appsrv1 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.102:80 check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">3000</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    server appsrv2 </span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.103:80 check rise </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> maxconn </span><span class="token number" style="color:rgb(9, 134, 88)">3000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后分别在 3 个节点上启动 haproxy 服务，分别在 haproxy1、haproxy2、haproxy3 上监控 stick table。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">watch</span><span class="token plain"> -n </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;echo &quot;show table DynamicGroup&quot; | socat unix:/var/run/haproxy.sock -&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>由于上面的配置文件中，stick table 中存储和匹配的记录是响应报文中名为 PHPSESSID 的 cookie，因此在浏览器上测试时，能实现会话粘性。</p><p>但如果使用 curl 命令进行测试，由于 curl 每次执行结束进程就退出，无法缓存 cookie，因此 curl 的每次请求都是新连接。此处正好利用 curl 这一点特性，来生成多个 stickiness 记录，方便观察 stick table 记录推送的情况。</p><p>找一台 Linux 主机，分别对三个 haproxy 节点进行 5 次 curl 请求。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ip1</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.101</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ip2</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.106</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">ip3</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">192.168</span><span class="token plain">.122.107</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:rgb(9, 134, 88)">i</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$ip1</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$ip2</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">$ip3</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token keyword" style="color:rgb(0, 0, 255)">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:rgb(9, 134, 88)">j</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">in</span><span class="token plain"> </span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token variable function" style="color:rgb(0, 0, 255)">seq</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable number" style="color:rgb(9, 134, 88)">1</span><span class="token variable" style="color:rgb(9, 134, 88)"> </span><span class="token variable number" style="color:rgb(9, 134, 88)">5</span><span class="token variable" style="color:rgb(9, 134, 88)">`</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token keyword" style="color:rgb(0, 0, 255)">do</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token function" style="color:rgb(0, 0, 255)">curl</span><span class="token plain"> http://</span><span class="token variable" style="color:rgb(9, 134, 88)">$i</span><span class="token plain">/index.php </span><span class="token operator" style="color:rgb(0, 0, 0)">&amp;&gt;</span><span class="token plain">/dev/null</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        usleep </span><span class="token number" style="color:rgb(9, 134, 88)">500000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">done</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以下是截取自三个节点的 stick table 内容。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token comment" style="color:rgb(0, 128, 0)">###################### haproxy1 ########################</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># table: DynamicGroup, type: string, size:5120, used:15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff88042cc0: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">61m6cpr7qkkcrst2m0fq85vs93 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">217803</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff88042b60: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">672uvf5c9jb0ppb115b16glip5 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">215246</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff88041820: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">6tlnotjd9rb8b9ln96cjul6vj4 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">219861</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff84038e30: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">75t9mkmtfjcn6prv6vm7fq5bs1 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">218317</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff8803d430: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">77akt5tv541usblqp09qvhcjk3 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">214219</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff840388f0: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">9qo3ion9tubhd6hofv709vlrt7 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">218833</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff88042a00: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">a39v8ntdn5u7sd66jbjns0b1j3 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">215757</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff84038790: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">b5vl3bd68pr9ij2mha9329rg10 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">216268</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff88042290: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">bmnob21gp6oq87qb03vpl0pu35 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">216780</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff84037bc0: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">hhgj3ckk0jd6p6ivmkpqugv6p3 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">213198</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff880407a0: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">k8knr6k0d6u7rln4f2dg85vju4 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">212686</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff84038560: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">n4422bvflsqhdtlrhl6vkv9sa4 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">219351</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff84039b10: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">osstpulqkcm9t0cfb8i2albdk3 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">214732</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff84037c90: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">qn55ad64v6qm5jgvrq3mg6kd22 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">213708</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff880412a0: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">svimc7pe9abamhmvmccune7j91 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">217291</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">###################### haproxy2 ########################</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># table: DynamicGroup, type: string, size:5120, used:15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff80026c90: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">61m6cpr7qkkcrst2m0fq85vs93 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">210178</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0x25b01040:     </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">672uvf5c9jb0ppb115b16glip5 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">207620</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff7403d430: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">6tlnotjd9rb8b9ln96cjul6vj4 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">212236</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff7403eee0: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">75t9mkmtfjcn6prv6vm7fq5bs1 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">210692</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff7403d500: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">77akt5tv541usblqp09qvhcjk3 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">206594</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff7403e960: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">9qo3ion9tubhd6hofv709vlrt7 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">211208</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff94027150: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">a39v8ntdn5u7sd66jbjns0b1j3 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">208132</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff8c03c9f0: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">b5vl3bd68pr9ij2mha9329rg10 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">208642</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff84026910: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">bmnob21gp6oq87qb03vpl0pu35 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">209155</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff7403e610: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">hhgj3ckk0jd6p6ivmkpqugv6p3 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">205573</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff7403d780: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">k8knr6k0d6u7rln4f2dg85vju4 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">205061</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff7403e280: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">n4422bvflsqhdtlrhl6vkv9sa4 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">211726</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff7403cb60: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">osstpulqkcm9t0cfb8i2albdk3 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">207108</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff7403dfc0: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">qn55ad64v6qm5jgvrq3mg6kd22 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">206083</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff88026910: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">svimc7pe9abamhmvmccune7j91 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">209665</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)">###################### haproxy3 ########################</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token comment" style="color:rgb(0, 128, 0)"># table: DynamicGroup, type: string, size:5120, used:15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0x3d5b1330:     </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">61m6cpr7qkkcrst2m0fq85vs93 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">207767</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff94026c90: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">672uvf5c9jb0ppb115b16glip5 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">205211</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff8c026910: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">6tlnotjd9rb8b9ln96cjul6vj4 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">209826</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff94026910: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">75t9mkmtfjcn6prv6vm7fq5bs1 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">208282</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff94033630: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">77akt5tv541usblqp09qvhcjk3 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">204185</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff94026ac0: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">9qo3ion9tubhd6hofv709vlrt7 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">208798</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff7c027b50: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">a39v8ntdn5u7sd66jbjns0b1j3 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">205722</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff7c027d00: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">b5vl3bd68pr9ij2mha9329rg10 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">206233</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff7c027ed0: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">bmnob21gp6oq87qb03vpl0pu35 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">206745</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff94033eb0: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">hhgj3ckk0jd6p6ivmkpqugv6p3 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">203163</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff94034430: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">k8knr6k0d6u7rln4f2dg85vju4 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">202651</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff94035f90: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">n4422bvflsqhdtlrhl6vkv9sa4 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">209316</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff90033790: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">osstpulqkcm9t0cfb8i2albdk3 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">204698</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff94033de0: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">qn55ad64v6qm5jgvrq3mg6kd22 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">203673</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0xffff7c038cb0: </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">svimc7pe9abamhmvmccune7j91 </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">use</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">exp</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">207256</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_id</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(9, 134, 88)">server_key</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain">appsrv1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>结果符合预期目标，每个表都有 15 条 stickiness，且它们的 key 和对应的 server<!-- -->_<!-- -->id 完全相同。</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/en/docs/linux-advanced-13"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">第 13 章 Linux haproxy 服务进阶配置</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/en/docs/linux-advanced-15"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">第 15 章 Linux LVS 服务配置</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#91haproxy-cookie" class="table-of-contents__link toc-highlight">9.1、haproxy cookie</a><ul><li><a href="#911haproxy-设置-cookie-的几种方式" class="table-of-contents__link toc-highlight">9.1.1、haproxy 设置 cookie 的几种方式</a><ul><li><a href="#9111cookie-insert" class="table-of-contents__link toc-highlight">9.1.1.1、cookie insert</a></li><li><a href="#9112cookie-prefix" class="table-of-contents__link toc-highlight">9.1.1.2、cookie prefix</a></li><li><a href="#9113cookie-rewrite" class="table-of-contents__link toc-highlight">9.1.1.3、cookie rewrite</a></li></ul></li><li><a href="#912haproxy-cookie-保持或忽略会话" class="table-of-contents__link toc-highlight">9.1.2、haproxy cookie 保持或忽略会话</a></li></ul></li><li><a href="#92haproxy-stick-table" class="table-of-contents__link toc-highlight">9.2、haproxy stick table</a><ul><li><a href="#921使用-stick-table" class="table-of-contents__link toc-highlight">9.2.1、使用 stick table</a><ul><li><a href="#9211创建-stick-table" class="table-of-contents__link toc-highlight">9.2.1.1、创建 stick table</a></li><li><a href="#9212查看-stick-table" class="table-of-contents__link toc-highlight">9.2.1.2、查看 stick table</a></li><li><a href="#9213客户端源-ip-标识" class="table-of-contents__link toc-highlight">9.2.1.3、客户端源 IP 标识</a></li><li><a href="#9214客户端-cookie-标识" class="table-of-contents__link toc-highlight">9.2.1.4、客户端 cookie 标识</a></li><li><a href="#9215客户端-string-标识" class="table-of-contents__link toc-highlight">9.2.1.5、客户端 string 标识</a></li><li><a href="#9216stick-onstick-matchstick-store" class="table-of-contents__link toc-highlight">9.2.1.6、stick on、stick match、stick store</a></li><li><a href="#9217stick-table-统计状态信息" class="table-of-contents__link toc-highlight">9.2.1.7、stick table 统计状态信息</a></li></ul></li></ul></li><li><a href="#93haproxy-stick-table-复制" class="table-of-contents__link toc-highlight">9.3、haproxy stick table 复制</a><ul><li><a href="#931stick-table-复制特性" class="table-of-contents__link toc-highlight">9.3.1、stick table 复制特性</a></li><li><a href="#932定义-haproxy-节点成员" class="table-of-contents__link toc-highlight">9.3.2、定义 haproxy 节点成员</a></li><li><a href="#933完成配置" class="table-of-contents__link toc-highlight">9.3.3、完成配置</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Study</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/tags">Tags</a></li><li class="footer__item"><a class="footer__link-item" href="/en/archive">Archive</a></li><li class="footer__item"><a class="footer__link-item" href="/en/docs/skill">Notes</a></li><li class="footer__item"><a class="footer__link-item" href="/en/project">Projects</a></li><li class="footer__item"><a class="footer__link-item" href="/en/docs/linux">Linux</a></li></ul></div><div class="col footer__col"><div class="footer__title">Social Media</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/about">About Me</a></li><li class="footer__item"><a href="https://github.com/zqingfa" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://juejin.cn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Juejin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" position="right" href="/en/friends">Friends</a></li><li class="footer__item"><a class="footer__link-item" position="right" href="/en/website">Links</a></li><li class="footer__item"><a href="https://docusaurus.io/zh-CN/" target="_blank"><img style="height:50px;margin-top:0.5rem" src="/img/buildwith.png"><a></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p><a href="http://beian.miit.gov.cn/">闽ICP备2020017848号-2</a></p><p>Copyright © 2020 – PRESENT kuizuo Built with Docusaurus.</p></div></div></div></footer></div>
<script src="/en/assets/js/runtime~main.06ffa367.js"></script>
<script src="/en/assets/js/main.7f2e5564.js"></script>
</body>
</html>