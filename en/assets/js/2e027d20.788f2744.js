"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[3198],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return h}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=a.createContext({}),l=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=l(e.components);return a.createElement(p.Provider,{value:t},e.children)},k={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,s=e.originalType,p=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),u=l(n),h=r,d=u["".concat(p,".").concat(h)]||u[h]||k[h]||s;return n?a.createElement(d,o(o({ref:t},c),{},{components:n})):a.createElement(d,o({ref:t},c))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=n.length,o=new Array(s);o[0]=u;var i={};for(var p in t)hasOwnProperty.call(t,p)&&(i[p]=t[p]);i.originalType=e,i.mdxType="string"==typeof e?e:r,o[1]=i;for(var l=2;l<s;l++)o[l]=n[l];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},12371:function(e,t,n){n.r(t),n.d(t,{assets:function(){return c},contentTitle:function(){return p},default:function(){return h},frontMatter:function(){return i},metadata:function(){return l},toc:function(){return k}});var a=n(83117),r=n(80102),s=(n(67294),n(3905)),o=["components"],i={id:"linux-advanced-14",slug:"/linux-advanced-14",title:"\u7b2c 14 \u7ae0 Linux haproxy \u670d\u52a1\u9ad8\u7ea7\u914d\u7f6e",authors:"zhangqf",keywords:["linux","haproxy"]},p=void 0,l={unversionedId:"linux/advanced/linux-advanced-14",id:"linux/advanced/linux-advanced-14",title:"\u7b2c 14 \u7ae0 Linux haproxy \u670d\u52a1\u9ad8\u7ea7\u914d\u7f6e",description:"haproxy \u662f\u4e00\u4e2a\u975e\u5e38\u5f3a\u5927\u7684\u670d\u52a1\uff0c\u7279\u522b\u662f\u5728\u9ad8\u5e76\u53d1\u7684\u573a\u666f\u4e0b\uff0c\u662f\u4e00\u4e2a\u975e\u5e38\u4e0d\u9519\u7684\u9009\u62e9\uff1b\u524d\u4e24\u7bc7\u9488\u5bf9 haproxy \u7684\u4f7f\u7528\u505a\u4e86\u8be6\u7ec6\u8bf4\u660e\uff0c\u8ba9 haproxy \u5728\u751f\u4ea7\u73af\u5883\u4e0b\u4f18\u96c5\u5730\u8dd1\u8d77\u6765\u7edd\u4e0d\u5728\u8bdd\u4e0b\uff1b\u4e0b\u9762\u6211\u4eec\u9700\u8981\u5bf9\u5b83\u7684\u4e00\u4e9b\u91cd\u8981\u529f\u80fd\u8fdb\u4e00\u6b65\u5256\u6790\u4e00\u4e0b\u3002",source:"@site/docs/linux/advanced/\u7b2c 14 \u7ae0 Linux haproxy \u670d\u52a1\u9ad8\u7ea7\u914d\u7f6e.md",sourceDirName:"linux/advanced",slug:"/linux-advanced-14",permalink:"/en/docs/linux-advanced-14",draft:!1,tags:[],version:"current",frontMatter:{id:"linux-advanced-14",slug:"/linux-advanced-14",title:"\u7b2c 14 \u7ae0 Linux haproxy \u670d\u52a1\u9ad8\u7ea7\u914d\u7f6e",authors:"zhangqf",keywords:["linux","haproxy"]},sidebar:"linux",previous:{title:"\u7b2c 13 \u7ae0 Linux haproxy \u670d\u52a1\u8fdb\u9636\u914d\u7f6e",permalink:"/en/docs/linux-advanced-13"},next:{title:"\u7b2c 15 \u7ae0 Linux LVS \u670d\u52a1\u914d\u7f6e",permalink:"/en/docs/linux-advanced-15"}},c={},k=[{value:"9.1\u3001haproxy cookie",id:"91haproxy-cookie",level:2},{value:"9.1.1\u3001haproxy \u8bbe\u7f6e cookie \u7684\u51e0\u79cd\u65b9\u5f0f",id:"911haproxy-\u8bbe\u7f6e-cookie-\u7684\u51e0\u79cd\u65b9\u5f0f",level:3},{value:"9.1.1.1\u3001cookie insert",id:"9111cookie-insert",level:4},{value:"9.1.1.2\u3001cookie prefix",id:"9112cookie-prefix",level:4},{value:"9.1.1.3\u3001cookie rewrite",id:"9113cookie-rewrite",level:4},{value:"9.1.2\u3001haproxy cookie \u4fdd\u6301\u6216\u5ffd\u7565\u4f1a\u8bdd",id:"912haproxy-cookie-\u4fdd\u6301\u6216\u5ffd\u7565\u4f1a\u8bdd",level:3},{value:"9.2\u3001haproxy stick table",id:"92haproxy-stick-table",level:2},{value:"9.2.1\u3001\u4f7f\u7528 stick table",id:"921\u4f7f\u7528-stick-table",level:3},{value:"9.2.1.1\u3001\u521b\u5efa stick table",id:"9211\u521b\u5efa-stick-table",level:4},{value:"9.2.1.2\u3001\u67e5\u770b stick table",id:"9212\u67e5\u770b-stick-table",level:4},{value:"9.2.1.3\u3001\u5ba2\u6237\u7aef\u6e90 IP \u6807\u8bc6",id:"9213\u5ba2\u6237\u7aef\u6e90-ip-\u6807\u8bc6",level:4},{value:"9.2.1.4\u3001\u5ba2\u6237\u7aef cookie \u6807\u8bc6",id:"9214\u5ba2\u6237\u7aef-cookie-\u6807\u8bc6",level:4},{value:"9.2.1.5\u3001\u5ba2\u6237\u7aef string \u6807\u8bc6",id:"9215\u5ba2\u6237\u7aef-string-\u6807\u8bc6",level:4},{value:"9.2.1.6\u3001stick on\u3001stick match\u3001stick store",id:"9216stick-onstick-matchstick-store",level:4},{value:"9.2.1.7\u3001stick table \u7edf\u8ba1\u72b6\u6001\u4fe1\u606f",id:"9217stick-table-\u7edf\u8ba1\u72b6\u6001\u4fe1\u606f",level:4},{value:"9.3\u3001haproxy stick table \u590d\u5236",id:"93haproxy-stick-table-\u590d\u5236",level:2},{value:"9.3.1\u3001stick table \u590d\u5236\u7279\u6027",id:"931stick-table-\u590d\u5236\u7279\u6027",level:3},{value:"9.3.2\u3001\u5b9a\u4e49 haproxy \u8282\u70b9\u6210\u5458",id:"932\u5b9a\u4e49-haproxy-\u8282\u70b9\u6210\u5458",level:3},{value:"9.3.3\u3001\u5b8c\u6210\u914d\u7f6e",id:"933\u5b8c\u6210\u914d\u7f6e",level:3}],u={toc:k};function h(e){var t=e.components,i=(0,r.Z)(e,o);return(0,s.kt)("wrapper",(0,a.Z)({},u,i,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("p",null,"haproxy \u662f\u4e00\u4e2a\u975e\u5e38\u5f3a\u5927\u7684\u670d\u52a1\uff0c\u7279\u522b\u662f\u5728\u9ad8\u5e76\u53d1\u7684\u573a\u666f\u4e0b\uff0c\u662f\u4e00\u4e2a\u975e\u5e38\u4e0d\u9519\u7684\u9009\u62e9\uff1b\u524d\u4e24\u7bc7\u9488\u5bf9 haproxy \u7684\u4f7f\u7528\u505a\u4e86\u8be6\u7ec6\u8bf4\u660e\uff0c\u8ba9 haproxy \u5728\u751f\u4ea7\u73af\u5883\u4e0b\u4f18\u96c5\u5730\u8dd1\u8d77\u6765\u7edd\u4e0d\u5728\u8bdd\u4e0b\uff1b\u4e0b\u9762\u6211\u4eec\u9700\u8981\u5bf9\u5b83\u7684\u4e00\u4e9b\u91cd\u8981\u529f\u80fd\u8fdb\u4e00\u6b65\u5256\u6790\u4e00\u4e0b\u3002"),(0,s.kt)("h2",{id:"91haproxy-cookie"},"9.1\u3001haproxy cookie"),(0,s.kt)("p",null,"http \u662f\u65e0\u72b6\u6001\u534f\u8bae\uff0c\u4efb\u4f55\u4e00\u4e2a\u4e03\u5c42\u7684 http \u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u90fd\u5e94\u8be5\u5177\u5907\u4e00\u4e2a\u529f\u80fd\uff1a\u4f1a\u8bdd\u4fdd\u6301\u3002\u4f1a\u8bdd\u4fdd\u6301\u662f\u4fdd\u8bc1\u5ba2\u6237\u7aef\u5bf9\u52a8\u6001\u5e94\u7528\u7a0b\u5e8f\u6b63\u786e\u8bf7\u6c42\u7684\u57fa\u672c\u8981\u6c42\u3002"),(0,s.kt)("p",null,'\u5982\u679c\u53cd\u5411\u4ee3\u7406\u7684\u540e\u7aef\u63d0\u4f9b\u7684\u662f "\u6709\u72b6\u6001" \u7684\u670d\u52a1\u6216\u534f\u8bae\u65f6\uff0c\u5fc5\u987b\u4fdd\u8bc1\u8bf7\u6c42\u8fc7\u4e00\u6b21\u7684\u5ba2\u6237\u7aef\u80fd\u88ab\u5f15\u5bfc\u5230\u540c\u4e00\u670d\u52a1\u7aef\u4e0a\u3002\u53ea\u6709\u8fd9\u6837\uff0c\u670d\u52a1\u7aef\u624d\u80fd\u77e5\u9053\u8fd9\u4e2a\u5ba2\u6237\u7aef\u662f\u5b83\u66fe\u7ecf\u5904\u7406\u8fc7\u7684\uff0c\u80fd\u67e5\u5230\u5e76\u83b7\u53d6\u5230\u548c\u8be5\u5ba2\u6237\u7aef\u5bf9\u5e94\u7684\u4e0a\u4e0b\u6587\u73af\u5883(session \u4e0a\u4e0b\u6587)\uff0c\u6709\u4e86\u8fd9\u4e2a session \u73af\u5883\u624d\u80fd\u7ee7\u7eed\u4e3a\u8be5\u5ba2\u6237\u7aef\u63d0\u4f9b\u540e\u7eed\u7684\u670d\u52a1\u3002'),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"\u7b80\u5355\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u5ba2\u6237\u7aef A \u5411\u670d\u52a1\u7aef B \u8bf7\u6c42\u5c06 C \u5546\u54c1\u52a0\u5165\u5b83\u7684\u8d26\u6237\u8d2d\u7269\u8f66\uff0c\u52a0\u5165\u6210\u529f\u540e\uff0c\u670d\u52a1\u7aef B \u4f1a\u5728\u67d0\u4e2a\u7f13\u5b58\u4e2d\u8bb0\u5f55\u4e0b\u5ba2\u6237\u7aef A \u548c\u5b83\u7684\u5546\u54c1 C\uff0c\u8fd9\u4e2a\u7f13\u5b58\u7684\u5185\u5bb9\u5c31\u662f session \u4e0a\u4e0b\u6587\u73af\u5883\u3002",(0,s.kt)("ul",{parentName:"li"},(0,s.kt)("li",{parentName:"ul"},"\u800c\u8bc6\u522b\u5ba2\u6237\u7aef\u7684\u65b9\u5f0f\u4e00\u822c\u662f\u8bbe\u7f6e session ID(\u5982 PHPSESSID\u3001JSESSIONID)\uff0c\u5e76\u5c06\u5176\u4f5c\u4e3a cookie \u7684\u5185\u5bb9\u4ea4\u7ed9\u5ba2\u6237\u7aef\u3002"),(0,s.kt)("li",{parentName:"ul"},"\u5ba2\u6237\u7aef A \u518d\u6b21\u8bf7\u6c42\u7684\u65f6\u5019(\u6bd4\u5982\u5c06\u8d2d\u7269\u8f66\u4e2d\u7684\u5546\u54c1\u4e0b\u8ba2\u5355)\u53ea\u8981\u643a\u5e26\u8fd9\u4e2a cookie\uff0c\u670d\u52a1\u7aef B \u5c31\u53ef\u4ee5\u4ece\u4e2d\u83b7\u53d6\u5230 session ID \u5e76\u627e\u5230\u5c5e\u4e8e\u5ba2\u6237\u7aef A \u7684\u7f13\u5b58\u5185\u5bb9\uff0c\u4e5f\u5c31\u53ef\u4ee5\u7ee7\u7eed\u6267\u884c\u4e0b\u8ba2\u5355\u90e8\u5206\u7684\u4ee3\u7801\u3002"))),(0,s.kt)("li",{parentName:"ul"},"\u5047\u5982\u8fd9\u65f6\u4f7f\u7528\u8d1f\u8f7d\u5747\u8861\u8f6f\u4ef6\u5bf9\u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u8fdb\u884c\u8d1f\u8f7d\uff0c\u5982\u679c\u8fd9\u4e2a\u8d1f\u8f7d\u8f6f\u4ef6\u53ea\u662f\u7b80\u5355\u5730\u8fdb\u884c\u8d1f\u8f7d\u8f6c\u53d1\uff0c\u5c31\u65e0\u6cd5\u4fdd\u8bc1\u5c06\u5ba2\u6237\u7aef A \u5f15\u5bfc\u5230\u670d\u52a1\u7aef B\uff0c\u53ef\u80fd\u4f1a\u5f15\u5bfc\u5230\u670d\u52a1\u7aef X\u3001\u670d\u52a1\u7aef Y\uff0c\u4f46\u662f X\u3001Y \u4e0a\u5e76\u6ca1\u6709\u7f13\u5b58\u548c\u5ba2\u6237\u7aef A \u5bf9\u5e94\u7684 session \u5185\u5bb9\uff0c\u5f53\u7136\u4e5f\u65e0\u6cd5\u4e3a\u5ba2\u6237\u7aef A \u4e0b\u8ba2\u5355\u3002")),(0,s.kt)("p",null,'\u56e0\u6b64\uff0c\u53cd\u5411\u4ee3\u7406\u8f6f\u4ef6\u5fc5\u987b\u5177\u5907\u5c06\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef "\u7ed1\u5b9a" \u7684\u529f\u80fd\uff0c\u4e5f\u5c31\u662f\u6240\u8c13\u7684\u63d0\u4f9b\u4f1a\u8bdd\u4fdd\u6301\uff0c\u8ba9\u5ba2\u6237\u7aef A \u540e\u7eed\u7684\u8bf7\u6c42\u4e00\u5b9a\u8f6c\u53d1\u5230\u670d\u52a1\u7aef B \u4e0a\u3002'),(0,s.kt)("p",null,"haproxy \u63d0\u4f9b\u4e86 3 \u79cd\u5b9e\u73b0\u4f1a\u8bdd\u4fdd\u6301\u7684\u65b9\u5f0f\uff1a"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},"\u6e90\u5730\u5740 hash\uff1b"),(0,s.kt)("li",{parentName:"ol"},"\u8bbe\u7f6e cookie\uff1b"),(0,s.kt)("li",{parentName:"ol"},"\u4f1a\u8bdd\u7c98\u6027\u8868 stick-table\uff1b")),(0,s.kt)("h3",{id:"911haproxy-\u8bbe\u7f6e-cookie-\u7684\u51e0\u79cd\u65b9\u5f0f"},"9.1.1\u3001haproxy \u8bbe\u7f6e cookie \u7684\u51e0\u79cd\u65b9\u5f0f"),(0,s.kt)("p",null,"\u8bbe\u7f6e cookie \u7684\u65b9\u5f0f\u662f\u901a\u8fc7\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u4f7f\u7528 cookie \u6307\u4ee4\u8fdb\u884c\u914d\u7f6e\u7684\u3002\u7531\u4e8e haproxy \u8bbe\u7f6e cookie \u7684\u76ee\u7684\u662f\u4e3a\u4e86\u5c06\u67d0\u5ba2\u6237\u7aef\u5f15\u5bfc\u5230\u4e4b\u524d\u4e3a\u5176\u670d\u52a1\u8fc7\u7684\u540e\u7aef\u670d\u52a1\u5668\u4e0a\uff0c\u7b80\u5355\u5730\u8bf4\uff0c\u5c31\u662f\u548c\u540e\u7aef\u67d0\u670d\u52a1\u5668\u4fdd\u6301\u8054\u7cfb\uff0c\u56e0\u6b64 cookie \u6307\u4ee4\u4e0d\u80fd\u8bbe\u7f6e\u5728 frontend \u6bb5\u843d\u3002"),(0,s.kt)("p",null,"\u9996\u5148\u770b\u4e00\u4e2a\u8bbe\u7f6e cookie \u7684\u793a\u4f8b\uff1a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"backend dynamic_servers\n    cookie app_cook  insert  nocache\n    server app1      192.168.122.102:80 cookie server1\n    server app2      192.168.122.103:80 cookie server2\n")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"\u8fd9\u4e2a\u793a\u4f8b\u914d\u7f6e\u4e2d\uff0c",(0,s.kt)("inlineCode",{parentName:"li"},"cookie"),' \u6307\u4ee4\u4e2d\u6307\u5b9a\u7684\u662f insert \u547d\u4ee4\uff0c\u8868\u793a\u5728\u5c06\u54cd\u5e94\u62a5\u6587\u4ea4\u7ed9\u5ba2\u6237\u7aef\u4e4b\u524d\uff0c\u5148\u63d2\u5165\u4e00\u4e2a\u5c5e\u6027\u540d\u4e3a "app',"_",'cook" \u7684 cookie\uff0c\u8fd9\u4e2a cookie \u5728\u54cd\u5e94\u62a5\u6587\u7684\u5934\u90e8\u5c06\u72ec\u5360\u4e00\u4e2a "Set-Cookie" \u5b57\u6bb5(\u56e0\u4e3a\u662f\u63d2\u5165\u65b0 cookie)\uff0c\u800c "app',"_",'cook" \u53ea\u662f cookie \u540d\u79f0\uff0c\u5b83\u7684\u503c\u662f\u7531 server \u6307\u4ee4\u4e2d\u7684 cookie \u9009\u9879\u6307\u5b9a\u7684\uff0c\u8fd9\u91cc\u662f "server1" \u6216 "server2"\u3002'),(0,s.kt)("li",{parentName:"ul"},"\u56e0\u6b64\uff0c\u5982\u679c\u8fd9\u4e2a\u8bf7\u6c42\u62a5\u6587\u5206\u914d\u7ed9\u540e\u7aef app2 \u65f6\uff0c\u54cd\u5e94\u7ed9\u5ba2\u6237\u7aef\u7684\u54cd\u5e94\u62a5\u6587\u4e2d ",(0,s.kt)("strong",{parentName:"li"},"haproxy \u8bbe\u7f6e\u7684"),' "Set-Cookie" \u5b57\u6bb5\u7684\u6837\u5f0f\u4e3a\uff1a')),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"Set-Cookie:app_cook=server2; path=/\n")),(0,s.kt)("p",null,"\u9664\u4e86 insert \u547d\u4ee4\uff0ccookie \u6307\u4ee4\u4e2d\u8fd8\u652f\u6301 rewrite \u548c prefix \u4e24\u79cd\u8bbe\u7f6e cookie \u7684\u65b9\u5f0f\uff0c\u8fd9\u4e09\u79cd cookie \u7684\u64cd\u4f5c\u65b9\u5f0f\u53ea\u80fd\u4e09\u9009\u4e00\u3002\u6b64\u5916\uff0c\u8fd8\u63d0\u4f9b\u4e00\u4e9b\u989d\u5916\u5bf9 cookie \u7684\u529f\u80fd\u8bbe\u7f6e\u3002"),(0,s.kt)("p",null,"\u9996\u5148\u770b\u770b\u6307\u4ee4\u7684\u8bed\u6cd5\uff1a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"cookie <name> [ rewrite | insert | prefix ] [ indirect ] [ nocache ]\n              [ postonly ] [ preserve ] [ httponly ] [ secure ]\n              [ domain <domain> ]* [ maxidle <idle> ] [ maxlife <life> ]\n")),(0,s.kt)("p",null,"\u672c\u6587\u8be6\u7ec6\u5206\u8282\u8ba8\u8bba rewrite\u3001insert\u3001prefix \u7684\u884c\u4e3a\uff0c\u5e76\u5728\u8ba8\u8bba\u5b83\u4eec\u7684\u65f6\u5019\u4f1a\u7a7f\u63d2\u8bf4\u660e indirect\u3001nocache \u548c preserve \u7684\u884c\u4e3a\uff0c\u5982\u679c\u9700\u8981\u4e86\u89e3\u5176\u4ed6\u9009\u9879\uff0c\u8bf7\u81ea\u7ffb\u5b98\u65b9\u624b\u518c\u3002"),(0,s.kt)("p",null,"\u4e0b\u56fe\u662f\u540e\u6587\u5b9e\u9a8c\u65f6\u4f7f\u7528\u7684\u73af\u5883\uff1a"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"haproxy cookie detail",src:n(14947).Z,width:"557",height:"479"})),(0,s.kt)("p",null,"\u5176\u4e2d\u5728\u540e\u7aef\u63d0\u4f9b\u7684 index.php \u5185\u5bb9\u5927\u81f4\u5982\u4e0b\uff0c\u4e3b\u8981\u90e8\u5206\u662f",(0,s.kt)("strong",{parentName:"p"},"\u8bbe\u7f6e\u4e86\u540d\u4e3a ",(0,s.kt)("inlineCode",{parentName:"strong"},"PHPSESSID")," \u7684 cookie"),"\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'<h1>response from webapp 192.168.122.102/103</h1>\n<?php\n        session_start();\n        echo "Server IP: "."<font color=red>".$_SERVER[\'SERVER_ADDR\']."</font>"."<br>";\n        echo "Server Name: "."<font color=red>".$_SERVER[\'SERVER_NAME\']."</font>"."<br>";\n        echo "SESSIONNAME: "."<font color=red>".session_name()."</font>"."<br>";\n        echo "SESSIONID: "."<font color=red>".session_id()."</font>"."<br>";\n?>\n')),(0,s.kt)("h4",{id:"9111cookie-insert"},"9.1.1.1\u3001cookie insert"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'cookie <name> [ rewrite | insert | prefix ] [ indirect ] [ nocache ]\n              [ postonly ] [ preserve ] [ httponly ] [ secure ]\n              [ domain <domain> ]* [ maxidle <idle> ] [ maxlife <life> ]\n              [ dynamic ] [ attr <value> ]*\n\ninsert    This keyword indicates that the persistence cookie will have to\n          be inserted by HAProxy in server responses if the client did not\n\n          already have a cookie that would have permitted it to access this\n          server. When used without the "preserve" option, if the server\n          emits a cookie with the same name, it will be removed before\n          processing. For this reason, this mode can be used to upgrade\n          existing configurations running in the "rewrite" mode. The cookie\n          will only be a session cookie and will not be stored on the\n          client\'s disk. By default, unless the "indirect" option is added,\n          the server will see the cookies emitted by the client. Due to\n          caching effects, it is generally wise to add the "nocache" or\n          "postonly" keywords (see below). The "insert" keyword is not\n          compatible with "rewrite" and "prefix".\n')),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"insert \u53c2\u6570\u7684\u610f\u601d\u5982\u4e0b\uff1a",(0,s.kt)("ol",{parentName:"li"},(0,s.kt)("li",{parentName:"ol"},"haproxy \u5c06\u5728\u5ba2\u6237\u7aef\u6ca1\u6709 cookie \u65f6(\u6bd4\u5982\u7b2c\u4e00\u6b21\u8bf7\u6c42)\uff0c\u5728\u54cd\u5e94\u62a5\u6587\u4e2d\u63d2\u5165\u4e00\u4e2a cookie\u3002"),(0,s.kt)("li",{parentName:"ol"},'\u5f53\u6ca1\u6709\u4f7f\u7528\u5173\u952e\u8bcd "preserve" \u9009\u9879\u65f6\uff0c\u5982\u679c\u540e\u7aef\u670d\u52a1\u5668\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u548c\u6b64\u5904\u540d\u79f0\u76f8\u540c\u7684 cookie\uff0c\u5219\u9996\u5148\u5220\u9664\u670d\u52a1\u7aef\u8bbe\u7f6e\u7684 cookie\u3002'),(0,s.kt)("li",{parentName:"ol"},"\u8be5 cookie \u53ea\u80fd\u4f5c\u4e3a\u4f1a\u8bdd\u4fdd\u6301\u4f7f\u7528\uff0c\u65e0\u6cd5\u6301\u4e45\u5316\u5230\u5ba2\u6237\u7aef\u7684\u78c1\u76d8\u4e0a(\u56e0\u4e3a haproxy \u8bbe\u7f6e\u7684 cookie \u6ca1\u6709 maxAge \u5c5e\u6027\uff0c\u65e0\u6cd5\u6301\u4e45\u4fdd\u5b58\uff0c\u53ea\u80fd\u4fdd\u5b58\u5728\u6d4f\u89c8\u5668\u7f13\u5b58\u4e2d)\u3002"),(0,s.kt)("li",{parentName:"ol"},'\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u9664\u975e\u4f7f\u7528\u4e86 "indirect" \u9009\u9879\uff0c\u5426\u5219\u670d\u52a1\u7aef\u53ef\u4ee5\u770b\u5230\u5ba2\u6237\u7aef\u8bf7\u6c42\u65f6\u7684\u6240\u6709 cookie \u4fe1\u606f\u3002'),(0,s.kt)("li",{parentName:"ol"},'\u7531\u4e8e\u7f13\u5b58\u7684\u5f71\u54cd\uff0c\u5efa\u8bae\u52a0\u4e0a "nocache" \u6216 "postonly" \u9009\u9879\u3002')))),(0,s.kt)("p",null,"\u4e0b\u9762\u4f7f\u7528\u4f8b\u5b50\u6765\u89e3\u91ca insert \u7684\u5404\u79cd\u884c\u4e3a\u3002"),(0,s.kt)("p",null,"\u5728 haproxy \u5982\u4e0b\u914d\u7f6e\u540e\u7aef\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"backend DynamicGroup\n    cookie app_cook insert nocache\n    server app1 192.168.122.102:80 cookie app_server1\n    server app2 192.168.122.103:80 cookie app_server2\n")),(0,s.kt)("p",null,"\u5f53\u4f7f\u7528\u6d4f\u89c8\u5668\u7b2c\u4e00\u6b21\u8bbf\u95ee ",(0,s.kt)("inlineCode",{parentName:"p"},"http://192.168.122.101/index.php")," \u65f6\uff0c\u54cd\u5e94\u7ed3\u679c\u548c\u54cd\u5e94\u9996\u90e8\u5185\u5bb9\u5982\u4e0b\u56fe\uff1a"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"haproxy cookie detail1",src:n(67098).Z,width:"1060",height:"623"})),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},'\u4ece\u56fe\u4e2d\u53ef\u4ee5\u77e5\u9053\uff0c\u8fd9\u6b21\u6d4f\u89c8\u5668\u7684\u8bf7\u6c42\u5206\u914d\u7ed9\u4e86 app2\uff0c\u800c\u4e14\u54cd\u5e94\u9996\u90e8\u4e2d\u6709\u4e24\u4e2a "Set-Cookie" \u5b57\u6bb5\uff0c\u5176\u4e2d\u5e26\u6709 PHPSESSID \u7684 cookie \u662f app2 \u670d\u52a1\u5668\u81ea\u8eab\u8bbe\u7f6e\u7684\uff0c\u53e6\u4e00\u4e2a\u662f haproxy \u8bbe\u7f6e\u7684\uff0c\u5176\u540d\u548c\u5176\u503c\u4e3a "app',"_","cook=app","_",'server2"\u3002')),(0,s.kt)("p",null,'\u5982\u679c\u5ba2\u6237\u7aef\u518d\u6b21\u8bbf\u95ee(\u4e0d\u5173\u95ed\u6d4f\u89c8\u5668\uff0ccookie \u7f13\u5b58\u8fd8\u5728)\uff0c\u8bf7\u6c42\u5934\u4e2d\u5c06\u643a\u5e26\u8be5 cookie\uff0chaproxy \u53d1\u73b0\u4e86\u8be5 cookie \u4e2d "app',"_","cook=app","_",'server2" \u90e8\u5206\uff0c\u77e5\u9053\u8fd9\u4e2a\u8bf7\u6c42\u8981\u4ea4\u7ed9 app',"_","server2 \u8fd9\u4e2a\u540e\u7aef\u3002\u5982\u4e0b\u56fe\uff1a"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"haproxy cookie detail2",src:n(33441).Z,width:"989",height:"512"})),(0,s.kt)("p",null,"\u8fd9\u6837\u5c31\u5b9e\u73b0\u4e86\u4f1a\u8bdd\u4fdd\u6301\uff0c\u4fdd\u8bc1\u88ab\u5904\u7406\u8fc7\u7684\u5ba2\u6237\u7aef\u80fd\u88ab\u5206\u914d\u5230\u540c\u4e00\u4e2a\u540e\u7aef\u5e94\u7528\u670d\u52a1\u5668\u4e0a\u3002"),(0,s.kt)("p",null,"\u6ce8\u610f\uff0c",(0,s.kt)("strong",{parentName:"p"},"\u5ba2\u6237\u7aef\u5728\u7b2c\u4e00\u6b21\u6536\u5230\u54cd\u5e94\u540e\u5c31\u4f1a\u628a cookie \u7f13\u5b58\u4e0b\u6765"),"\uff0c\u4ee5\u540e\u6bcf\u6b21 ",(0,s.kt)("inlineCode",{parentName:"p"},"http://192.168.122.101/index.php")," (\u6839\u636e\u57df\u540d\u8fdb\u884c\u5224\u65ad)\u90fd\u4f1a\u4ece\u7f13\u5b58\u4e2d\u53d6\u51fa\u8be5 cookie \u653e\u8fdb\u8bf7\u6c42\u9996\u90e8\u3002\u8fd9\u6837 haproxy \u4e00\u5b9a\u4f1a\u5c06\u5176\u5206\u914d\u7ed9 app","_","server2\uff0c\u9664\u975e app","_","server2 \u4e0b\u7ebf\u4e86\u3002"),(0,s.kt)("p",null,"\u4f46\u5373\u4f7f\u5982\u6b64\uff0c\u5ba2\u6237\u7aef\u8fd8\u662f\u4f1a\u643a\u5e26\u8be5 cookie\uff0c\u53ea\u4e0d\u8fc7 haproxy \u5224\u65ad app","_","server2 \u4e0b\u7ebf\u540e\uff0c\u5c31\u4e3a\u5ba2\u6237\u7aef\u91cd\u65b0\u5206\u914d app","_",'server1\uff0c\u5e76\u8bbe\u7f6e "app',"_","cook=app","_",'server1"\uff0c\u8be5 cookie \u4f1a',(0,s.kt)("strong",{parentName:"p"},'\u66ff\u6362\u5ba2\u6237\u7aef\u4e2d\u7684 "app',"_","cook=app","_",'server2"'),"\u3002\u4e0b\u56fe\u662f app2 \u4e0b\u7ebf\u540e\u5206\u914d\u7ed9 app1 \u7684\u7ed3\u679c\uff1a"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"haproxy cookie detail3",src:n(71837).Z,width:"1054",height:"722"})),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"\u6ce8\u610f\uff0c",(0,s.kt)("strong",{parentName:"li"},"\u5373\u4f7f\u5206\u914d\u7ed9\u4e86 app1\uff0cPHPSESSID \u4e5f\u4e0d\u4f1a\u6539\u53d8(\u5373 app1 \u8bbe\u7f6e\u7684 PHPSESSID \u65e0\u6548)"),"\uff0c\u56e0\u4e3a haproxy \u5224\u65ad\u51fa\u8fd9\u4e2a\u91cd\u540d cookie\uff0c\u4f1a\u5220\u9664 app1 \u8bbe\u7f6e\u7684 PHPSESSID\u3002\u56e0\u6b64\u4e0a\u56fe\u4e2d\u7684 PHPSESSID \u503c\u548c\u4e4b\u524d\u5206\u914d\u7ed9 app2 \u65f6\u7684 PHPSESSID \u662f\u4e00\u6837\u7684\u3002",(0,s.kt)("ul",{parentName:"li"},(0,s.kt)("li",{parentName:"ul"},"\u8fd9\u6837\u4e00\u6765\uff0capp1 \u4e0d\u662f\u5c31\u65e0\u6cd5\u5904\u7406\u8be5\u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u4e86\u5417\uff1f\u786e\u5b9e\u5982\u6b64\uff0c\u4f46\u6ca1\u529e\u6cd5\uff0c",(0,s.kt)("strong",{parentName:"li"},"\u9664\u975e\u540e\u7aef\u8bbe\u7f6e\u4e86 session \u5171\u4eab"),"\u3002")))),(0,s.kt)("p",null,'\u5982\u679c\u5c06\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684 cookie \u540d\u79f0\u4e5f\u8bbe\u7f6e\u4e3a PHPSESSID\uff0c\u5373\u540e\u7aef\u5e94\u7528\u670d\u52a1\u5668\u548c\u6b64\u5904\u8bbe\u7f6e\u7684 cookie \u540d\u79f0\u76f8\u540c\uff0c\u90a3\u4e48 haproxy \u5c06\u9996\u5148\u5c06\u540e\u7aef\u7684 PHPSESSID \u5220\u9664\uff0c\u7136\u540e\u4f7f\u7528\u81ea\u5df1\u7684\u503c\u53d1\u9001\u7ed9\u5ba2\u6237\u7aef\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u6b64\u65f6\u5c06\u53ea\u6709\u4e00\u4e2a "Set-Cookie" \u5b57\u6bb5\u54cd\u5e94\u7ed9\u5ba2\u6237\u7aef\u3002'),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"backend DynamicGroup\n    cookie PHPSESSID insert nocache\n    server app1 192.168.122.102:80 cookie app_server1\n    server app2 192.168.122.103:80 cookie app_server2\n")),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"haroxy cookie detail4",src:n(58847).Z,width:"1050",height:"697"})),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},'\u56e0\u6b64\uff0c\u5728 cookie \u6307\u4ee4\u4e2d\u7edd\u5bf9\u4e0d\u80fd\u8bbe\u7f6e cookie \u540d\u79f0\u548c\u540e\u7aef\u7684 cookie \u540d\u79f0\u76f8\u540c\uff0c\u5426\u5219\u540e\u7aef\u5c31\u76f8\u5f53\u4e8e "\u76f2\u4eba"\u3002\u4f8b\u5982\u6b64\u5904\u7684 PHPSESSID\uff0c\u6b64\u65f6\u540e\u7aef\u867d\u7136\u8ba4\u8bc6 PHPSESSID \u662f\u81ea\u5df1\u53d1\u9001\u51fa\u53bb\u7684 cookie \u540d\u79f0\uff0c\u4f46\u662f\u65e0\u6cd5\u83b7\u53d6 ID \u4e3a "app',"_",'server2" \u7684 session \u4e0a\u4e0b\u6587\u3002'),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},'\u5982\u679c\u4e0d\u914d\u5408 "indirect" \u9009\u9879'),'\uff0c\u670d\u52a1\u7aef\u53ef\u4ee5\u770b\u5230\u5ba2\u6237\u7aef\u8bf7\u6c42\u65f6\u7684\u6240\u6709 cookie \u4fe1\u606f\u3002\u5982\u679c\u914d\u5408 "indirect" \u9009\u9879\uff0c\u5219 haproxy \u5728\u5c06\u8bf7\u6c42\u8f6c\u53d1\u7ed9\u540e\u7aef\u65f6\uff0c\u5c06\u5220\u9664\u81ea\u5df1\u8bbe\u7f6e\u7684 cookie\uff0c\u4f7f\u5f97\u540e\u7aef\u53ea\u80fd\u770b\u5230\u5b83\u81ea\u5df1\u7684 cookie\uff0c\u8fd9\u6837\u5bf9\u540e\u7aef\u6765\u8bf4\uff0c\u6574\u4e2a\u8fc7\u7a0b\u662f\u5b8c\u5168\u900f\u660e\u7684\uff0c\u5b83\u4e0d\u77e5\u9053\u524d\u9762\u6709\u8d1f\u8f7d\u5747\u8861\u8f6f\u4ef6\u3002')),(0,s.kt)("p",null,'\u91cd\u65b0\u4fee\u6539 haproxy \u7684 cookie \u6307\u4ee4\uff0c\u5e76\u4fee\u6539 nginx \u914d\u7f6e\u6587\u4ef6\u4e2d\u65e5\u5fd7\u683c\u5f0f\uff0c\u5728\u5176\u4e2d\u52a0\u4e0a "$http',"_",'cookie" \u53d8\u91cf\uff0c\u5b83\u8868\u793a\u8bf7\u6c42\u62a5\u6587\u4e2d\u7684 cookie \u4fe1\u606f\u3002'),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'# haproxy\ncookie app_cook insert nocache\n\n# nginx\nlog_format  main  \'$http_cookie $remote_addr - $remote_user [$time_local] "$request" \'\n                  \'$status $body_bytes_sent "$http_referer" \'\n                  \'"$http_user_agent" "$http_x_forwarded_for"\';\n')),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"\u5ba2\u6237\u7aef\u518d\u6b21\u8bbf\u95ee\u65f6\uff0cnginx \u7684\u65e5\u5fd7\u4e2d\u5c06\u8bb0\u5f55\u4ee5\u4e0b\u4fe1\u606f(\u53ea\u8d34\u51fa\u4e86\u524d\u51e0\u4e2a\u5b57\u6bb5)\u3002")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"PHPSESSID=0n2m66kr6tbpmqftcljlvjk3i7; app_cook=app_server1 192.168.122.101\n")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},'\u52a0\u4e0a "indirect" \u9009\u9879\uff0c\u518d\u6d4b\u8bd5\u3002')),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"cookie app_cook insert indirect nocache\n")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"\u7ed3\u679c\u5982\u4e0b\uff1a")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"PHPSESSID=0n2m66kr6tbpmqftcljlvjk3i7 192.168.122.101\n")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},'\u5982\u679c insert \u5173\u952e\u5b57\u914d\u5408 "preserve" \u5173\u952e\u5b57'),'\uff0c\u90a3\u4e48\u5f53\u540e\u7aef\u8bbe\u7f6e\u4e86cookie \u65f6\uff0chaproxy \u5c06\u5f3a\u5236\u4fdd\u7559\u8be5 cookie\uff0c\u4e0d\u505a\u4efb\u4f55\u4fee\u6539\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u5c06 haproxy \u7684 cookie \u540d\u79f0\u4e5f\u8bbe\u7f6e\u4e3a PHPSESSID\uff0c\u90a3\u4e48\u5ba2\u6237\u7aef\u7b2c\u4e00\u6b21\u8bf7\u6c42\u65f6\u6536\u5230\u7684\u54cd\u5e94\u62a5\u6587\u4e2d\u5c06\u53ea\u6709\u4e00\u4e2a "Set-Cookie" \u5b57\u6bb5\uff0c\u4e14\u8fd9\u4e2a\u5b57\u6bb5\u7684\u503c\u662f\u540e\u7aef\u670d\u52a1\u5668\u8bbe\u7f6e\u7684\uff0c\u548c haproxy \u65e0\u5173\u3002'),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"\u5f53\u5ba2\u6237\u7aef\u548c HAProxy \u4e4b\u95f4\u5b58\u5728\u7f13\u5b58\u65f6\uff0c\u5efa\u8bae\u5c06 insert \u914d\u5408 nocache \u4e00\u8d77\u4f7f\u7528"),"\uff0c\u56e0\u4e3a nocache \u786e\u4fdd\u5982\u679c\u9700\u8981\u63d2\u5165 cookie\uff0c\u5219\u53ef\u7f13\u5b58\u9875\u9762\u5c06\u88ab\u6807\u8bb0\u4e3a\u4e0d\u53ef\u7f13\u5b58\u3002\u8fd9\u4e00\u70b9\u5f88\u91cd\u8981\uff0c\u56e0\u4e3a\u5982\u679c\u6240\u6709 cookie \u90fd\u6dfb\u52a0\u5230\u53ef\u7f13\u5b58\u7684\u9875\u9762\u4e0a\uff0c\u5219\u6240\u6709\u5ba2\u6237\u90fd\u5c06\u4ece\u4e2d\u95f4\u7684\u7f13\u5b58\u5c42(\u5982 cdn \u7aef\u7684\u7f13\u5b58\u5c42)\u83b7\u53d6\u9875\u9762\uff0c\u5e76\u4e14\u5c06\u5171\u4eab\u540c\u4e00\u4e2a Cookie\uff0c\u4ece\u800c\u5bfc\u81f4\u67d0\u53f0\u540e\u7aef\u670d\u52a1\u5668\u63a5\u6536\u7684\u6d41\u91cf\u8fdc\u8fdc\u8d85\u8fc7\u5176\u4ed6\u540e\u7aef\u670d\u52a1\u5668\u3002"),(0,s.kt)("h4",{id:"9112cookie-prefix"},"9.1.1.2\u3001cookie prefix"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'prefix    This keyword indicates that instead of relying on a dedicated\n          cookie for the persistence, an existing one will be completed.\n          This may be needed in some specific environments where the client\n          does not support more than one single cookie and the application\n          already needs it. In this case, whenever the server sets a cookie\n          named <name>, it will be prefixed with the server\'s identifier\n          and a delimiter. The prefix will be removed from all client\n          requests so that the server still finds the cookie it emitted.\n          Since all requests and responses are subject to being modified,\n          this mode doesn\'t work with tunnel mode. The "prefix" keyword is\n          not compatible with "rewrite" and "insert". Note: it is highly\n          recommended not to use "indirect" with "prefix", otherwise server\n          cookie updates would not be sent to clients.\n')),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"haproxy \u5c06\u5728\u5df2\u5b58\u5728\u7684 cookie(\u4f8b\u5982\u540e\u7aef\u5e94\u7528\u670d\u52a1\u5668\u8bbe\u7f6e\u7684)\u4e0a\u6dfb\u52a0\u524d\u7f00 cookie \u503c\uff0c\u8fd9\u4e2a\u524d\u7f00\u90e8\u5206\u662f server \u6307\u4ee4\u4e2d\u7684 cookie \u8bbe\u7f6e\u7684\uff0c\u4ee3\u8868\u7684\u662f",(0,s.kt)("strong",{parentName:"li"},"\u670d\u52a1\u7aef\u6807\u8bc6\u7b26"),"\u3002"),(0,s.kt)("li",{parentName:"ul"},'\u5728\u5ba2\u6237\u7aef\u518d\u6b21\u8bbf\u95ee\u65f6\uff0chaproxy \u5c06\u4f1a\u81ea\u52a8\u79fb\u9664\u8fd9\u90e8\u5206\u524d\u7f00\uff0c\u4f7f\u5f97\u670d\u52a1\u7aef\u53ea\u80fd\u770b\u5230\u5b83\u81ea\u5df1\u53d1\u51fa\u7684 cookie\u3002\u5728\u4e00\u4e9b\u7279\u6b8a\u73af\u5883\u4e0b\uff0c\u5ba2\u6237\u7aef\u4e0d\u652f\u6301\u591a\u4e2a "Set-Cookie" \u5b57\u6bb5\uff0c\u8fd9\u65f6\u53ef\u4ee5\u4f7f\u7528 prefix\u3002'),(0,s.kt)("li",{parentName:"ul"},"\u4f7f\u7528 prefix \u7684\u65f6\u5019\uff0c",(0,s.kt)("strong",{parentName:"li"},"cookie \u6307\u4ee4\u8bbe\u7f6e\u7684 cookie \u540d\u5fc5\u987b\u548c\u540e\u7aef\u8bbe\u7f6e\u7684 cookie \u4e00\u6837(\u5728\u672c\u6587\u7684\u73af\u5883\u4e2d\u662f PHPSESSID)"),"\uff0c\u5426\u5219 prefix \u6a21\u5f0f\u4e0b\u7684 haproxy \u4e0d\u4f1a\u5bf9\u54cd\u5e94\u62a5\u6587\u505a\u4efb\u4f55\u6539\u53d8\u3002")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"backend DynamicGroup\n    cookie PHPSESSID prefix\n    server app1 192.168.122.102:80 cookie app_server1\n    server app2 192.168.122.103:80 cookie app_server2\n")),(0,s.kt)("p",null,"\u5982\u4e0b\u56fe\uff1a"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"haproxy cookie detail5",src:n(10197).Z,width:"1054",height:"699"})),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"\u4ece\u540e\u7aef nginx \u4e0a\u7684\u65e5\u5fd7\u4e0a\u67e5\u770b haproxy \u8f6c\u53d1\u8fc7\u6765\u7684\u8bf7\u6c42\uff0c\u53ef\u4ee5\u770b\u5230\u524d\u7f00\u5df2\u7ecf\u88ab haproxy \u53bb\u6389\u4e86\u3002")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"PHPSESSID=k9cno2au088uhnm2na4rk99hv7 192.168.122.101\n")),(0,s.kt)("h4",{id:"9113cookie-rewrite"},"9.1.1.3\u3001cookie rewrite"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'rewrite   This keyword indicates that the cookie will be provided by the\n          server and that HAProxy will have to modify its value to set the\n          server\'s identifier in it. This mode is handy when the management\n          of complex combinations of "Set-cookie" and "Cache-control"\n          headers is left to the application. The application can then\n          decide whether or not it is appropriate to emit a persistence\n          cookie. Since all responses should be monitored, this mode\n          doesn\'t work in HTTP tunnel mode. Unless the application\n          behavior is very complex and/or broken, it is advised not to\n          start with this mode for new deployments. This keyword is\n          incompatible with "insert" and "prefix".\n')),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"\u5f53\u540e\u7aef\u670d\u52a1\u5668\u8bbe\u7f6e\u4e86 cookie \u65f6\uff0c\u4f7f\u7528 rewrite \u6a21\u5f0f\u65f6\uff0chaproxy \u5c06\u91cd\u5199\u8be5 cookie \u7684",(0,s.kt)("strong",{parentName:"li"},"\u503c"),"\u4e3a\u540e\u7aef\u670d\u52a1\u5668\u7684\u6807\u8bc6\u7b26\u3002"),(0,s.kt)("li",{parentName:"ul"},'\u5f53\u5e94\u7528\u7a0b\u5e8f\u9700\u8981\u540c\u65f6\u8003\u8651 "Set-Cookie" \u548c "Cache-control" \u5b57\u6bb5\u65f6\uff0c\u8be5\u6a21\u5f0f\u975e\u5e38\u65b9\u4fbf\uff0c\u56e0\u4e3a\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u51b3\u5b9a\u662f\u5426\u5e94\u8be5\u8bbe\u7f6e\u4e00\u4e2a\u4e3a\u4e86\u4fdd\u6301\u4f1a\u8bdd\u7684 cookie\u3002\u9664\u975e\u540e\u7aef\u5e94\u7528\u7a0b\u5e8f\u7684\u73af\u5883\u975e\u5e38\u590d\u6742\uff0c\u5426\u5219\u4e0d\u5efa\u8bae\u4f7f\u7528\u8be5\u6a21\u5f0f\u3002'),(0,s.kt)("li",{parentName:"ul"},"\u540c\u6837\uff0crewrite \u6a21\u5f0f\u4e0b\u7684 haproxy \u8bbe\u7f6e\u7684 cookie \u5fc5\u987b\u548c\u540e\u7aef\u670d\u52a1\u5668\u8bbe\u7f6e\u7684 cookie \u540d\u79f0\u4e00\u81f4\uff0c\u5426\u5219\u4e0d\u4f1a\u505a\u4efb\u4f55\u6539\u53d8\u3002")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"backend DynamicGroup\n    cookie PHPSESSID rewrite\n    server app1 192.168.122.102:80 cookie app_server1\n    server app2 192.168.122.103:80 cookie app_server2\n")),(0,s.kt)("p",null,"\u7ed3\u679c\u5982\u4e0b\u56fe\uff1a"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"haroxy cookie detail6",src:n(42694).Z,width:"1052",height:"697"})),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},'\u4f46\u662f\uff0c\u5f53\u5ba2\u6237\u7aef\u6301\u7740 "PHPSESSID=app',"_",'server1" \u518d\u53bb\u8bf7\u6c42\u670d\u52a1\u5668\u65f6\uff0chaproxy \u5c06\u5176\u5206\u914d\u7ed9 app1\uff0capp1 \u6b64\u65f6\u6536\u5230\u7684 cookie \u5c06\u662f\u91cd\u5199\u540e\u7684\uff0c\u4f46\u662f app1 \u6839\u672c\u5c31\u4e0d\u8ba4\u8bc6\u8fd9\u4e2a cookie\uff0c\u540e\u9762\u7684\u4ee3\u7801\u53ef\u80fd\u56e0\u6b64\u800c\u5931\u53bb\u903b\u8f91\u65e0\u6cd5\u8fdb\u884c\u6b63\u786e\u5904\u7406\u3002'),(0,s.kt)("li",{parentName:"ul"},"\u540e\u7aef nginx \u7684\u65e5\u5fd7\u5982\u4e0b\uff1a")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"PHPSESSID=app_server1 192.168.122.101\n")),(0,s.kt)("h3",{id:"912haproxy-cookie-\u4fdd\u6301\u6216\u5ffd\u7565\u4f1a\u8bdd"},"9.1.2\u3001haproxy cookie \u4fdd\u6301\u6216\u5ffd\u7565\u4f1a\u8bdd"),(0,s.kt)("p",null,"\u5728 haproxy \u4e2d\uff0chaproxy \u4f1a\u76d1\u63a7\u3001\u4fee\u6539\u3001\u589e\u52a0 cookie\uff0c\u8fd9\u90fd\u662f\u901a\u8fc7\u5185\u5b58\u4e2d\u7684 cookie \u8868\u5b9e\u73b0\u7684\u3002"),(0,s.kt)("p",null,"cookie \u8868\u4e2d\u8bb0\u5f55\u4e86\u5b83\u81ea\u5df1\u589e\u3001\u6539\u7684 cookie \u8bb0\u5f55\uff0c\u5305\u62ec cookie \u540d\u548c\u5bf9\u5e94 server \u7684 cookie \u503c\uff0c\u901a\u8fc7\u8fd9\u4e2a cookie \u8bb0\u5f55\uff0chaproxy \u5c31\u80fd\u77e5\u9053\u8bf7\u6c42\u8be5\u4ea4\u7ed9\u54ea\u4e2a\u540e\u7aef\u3002"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"haproxy cookie",src:n(86842).Z,width:"1044",height:"479"})),(0,s.kt)("p",null,"\u5982\u56fe\u6240\u793a\uff0c\u5f53 haproxy \u6210\u529f\u4fee\u6539\u4e86\u54cd\u5e94\u62a5\u6587\u4e2d\u7684 cookie \u65f6\uff0c\u5c06\u5728 cookie \u8868\u4e2d\u63d2\u5165\u4e00\u6761\u8bb0\u5f55\uff0c\u8fd9\u6761\u8bb0\u5f55\u662f\u7ef4\u6301\u4f1a\u8bdd\u7684\u4f9d\u636e\u3002"),(0,s.kt)("p",null,'\u5176\u5b9e\uff0c\u901a\u8fc7 cookie \u8868\u4fdd\u6301\u548c\u540e\u7aef\u7684\u4f1a\u8bdd\u53ea\u662f\u9ed8\u8ba4\u60c5\u51b5\uff0chaproxy \u5141\u8bb8 "\u5373\u4f7f\u4f7f\u7528\u4e86 cookie \u4e5f\u4e0d\u8fdb\u884c\u4f1a\u8bdd\u7ed1\u5b9a" \u7684\u529f\u80fd\u3002\u8fd9\u53ef\u4ee5\u901a\u8fc7 ',(0,s.kt)("inlineCode",{parentName:"p"},"ignore-persist")," \u6307\u4ee4\u6765\u5b9e\u73b0\u3002\u5f53\u6ee1\u8db3\u8be5\u6307\u4ee4\u7684\u8981\u6c42\u65f6\uff0c\u8868\u793a\u4e0d\u5c06\u8be5 cookie \u63d2\u5165\u5230 cookie \u8868\u4e2d\uff0c\u56e0\u6b64\u65e0\u6cd5\u5b9e\u73b0\u4f1a\u8bdd\u4fdd\u6301\uff0c\u5373\u4f7f haproxy \u8bbe\u7f6e\u4e86 cookie \u4e5f\u6ca1\u7528\u3002"),(0,s.kt)("p",null,"\u4f8b\u5982\uff0c\u5728 backend \u4e2d\u6307\u5b9a\u5982\u4e0b\u914d\u7f6e\uff1a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"backend DynamicGroup\n    acl url_static  path_beg         /static /images /img /css\n    acl url_static  path_end         .gif .png .jpg .css .js\n    ignore-persist  if url_static\n    cookie app_cook insert nocache\n    server app1 192.168.122.102:80 cookie app_server1\n    server app2 192.168.122.103:80 cookie app_server2\n")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"\u8fd9\u8868\u793a uri \u6ee1\u8db3 acl \u4e2d\u6307\u5b9a\u7684\u9759\u6001\u7f51\u9875\u65f6\uff0c\u5c06\u4e0d\u8fdb\u884c\u4f1a\u8bdd\u4fdd\u6301\u3002"),(0,s.kt)("li",{parentName:"ul"},"\u4e0e ",(0,s.kt)("inlineCode",{parentName:"li"},"ignore-persist")," \u76f8\u5bf9\u7684\u662f ",(0,s.kt)("inlineCode",{parentName:"li"},"force-persist"),"\uff0c\u4f46\u4e0d\u5efa\u8bae\u4f7f\u7528\u8be5\u9009\u9879\uff0c\u56e0\u4e3a\u5b83\u548c ",(0,s.kt)("inlineCode",{parentName:"li"},"option redispatch")," \u51b2\u7a81\u3002")),(0,s.kt)("h2",{id:"92haproxy-stick-table"},"9.2\u3001haproxy stick table"),(0,s.kt)("p",null,"stick table \u662f haproxy \u7684\u4e00\u4e2a\u975e\u5e38\u4f18\u79c0\u7684\u7279\u6027\uff0c\u8fd9\u4e2a\u8868\u91cc\u9762\u5b58\u50a8\u7684\u662f stickiness \u8bb0\u5f55\uff0cstickiness \u8bb0\u5f55\u4e86\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef 1:1 \u5bf9\u5e94\u7684\u5f15\u7528\u5173\u7cfb\u3002\u901a\u8fc7\u8fd9\u4e2a\u5173\u7cfb\uff0chaproxy \u53ef\u4ee5\u5c06\u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u5f15\u5bfc\u5230\u4e4b\u524d\u4e3a\u5b83\u670d\u52a1\u8fc7\u7684\u540e\u7aef\u670d\u52a1\u5668\u4e0a\uff0c\u4e5f\u5c31\u662f\u5b9e\u73b0\u4e86\u4f1a\u8bdd\u4fdd\u6301\u7684\u529f\u80fd\u3002\u8fd9\u79cd\u8bb0\u5f55\u65b9\u5f0f\uff0c\u4fd7\u79f0",(0,s.kt)("strong",{parentName:"p"},"\u4f1a\u8bdd\u7c98\u6027"),"(stickiness)\uff0c\u5373\u5c06\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u7c98\u8fde\u8d77\u6765\u3002"),(0,s.kt)("p",null,"stick table \u5b9e\u73b0\u4f1a\u8bdd\u7c98\u6027\u7684\u8fc7\u7a0b\u5982\u4e0b\u56fe\uff1a"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"haproxy stick-table",src:n(2813).Z,width:"1035",height:"453"})),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},"stick table \u4e2d\u4f7f\u7528 key/value \u7684\u65b9\u5f0f\u6620\u5c04\u5ba2\u6237\u7aef\u548c\u540e\u7aef\u670d\u52a1\u5668\uff0ckey \u662f\u5ba2\u6237\u7aef\u7684\u6807\u8bc6\u7b26\uff0c\u53ef\u4ee5\u4f7f\u7528\u5ba2\u6237\u7aef\u7684\u6e90 ip(50\u5b57\u8282)\u3001cookie \u4ee5\u53ca\u4ece\u62a5\u6587\u4e2d\u8fc7\u6ee4\u51fa\u6765\u7684\u90e8\u5206 String\u3002value \u90e8\u5206\u662f\u670d\u52a1\u7aef\u7684\u6807\u8bc6\u7b26\u3002")),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},"\u9664\u4e86\u5b58\u50a8 key/value \u5b9e\u73b0\u6700\u57fa\u672c\u7684\u7c98\u6027\uff0cstick table \u8fd8\u53ef\u4ee5\u989d\u5916\u5b58\u50a8\u6bcf\u4e2a stickiness \u8bb0\u5f55\u5bf9\u5e94\u7684",(0,s.kt)("strong",{parentName:"p"},"\u72b6\u6001\u7edf\u8ba1\u6570\u636e"),"\u3002\u6bd4\u5982 stickiness \u8bb0\u5f55 1 \u76ee\u524d\u5efa\u7acb\u4e86\u591a\u5c11\u548c\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\u3001\u5e73\u5747\u5efa\u7acb\u8fde\u63a5\u7684\u901f\u5ea6\u662f\u591a\u5c11\u3001\u6d41\u5165\u6d41\u51fa\u4e86\u591a\u5c11\u5b57\u8282\u7684\u6570\u636e\u3001\u5efa\u7acb\u4f1a\u8bdd\u7684\u6570\u91cf\u7b49\u7b49\u3002")),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},"stick table \u53ef\u4ee5",(0,s.kt)("strong",{parentName:"p"},'\u5728 "\u53cc\u4e3b\u6a21\u578b" \u4e0b\u8fdb\u884c\u590d\u5236'),"(replication)\u3002\u53ea\u8981\u8bbe\u7f6e\u597d\u5bf9\u7aef haproxy \u8282\u70b9\uff0chaproxy \u5c31\u4f1a\u81ea\u52a8\u5c06\u65b0\u63d2\u5165\u7684\u3001\u521a\u66f4\u65b0\u7684\u8bb0\u5f55\u901a\u8fc7 TCP \u8fde\u63a5\u63a8\u9001\u5230\u5bf9\u7aef\u8282\u70b9\u4e0a\u3002"),(0,s.kt)("ul",{parentName:"li"},(0,s.kt)("li",{parentName:"ul"},"\u8fd9\u6837\u4e00\u6765\uff0c\u7c98\u6027\u8bb0\u5f55\u4e0d\u4f1a\u4e22\u5931\uff0c\u5373\u4f7f\u67d0 haproxy \u8282\u70b9\u51fa\u73b0\u4e86\u6545\u969c\uff0c\u5176\u4ed6\u8282\u70b9\u4e5f\u80fd\u5c06\u5ba2\u6237\u7aef\u6309\u7167\u7c98\u6027\u6620\u5c04\u5173\u7cfb\u5f15\u5bfc\u5230\u6b63\u786e\u7684\u540e\u7aef\u670d\u52a1\u5668\u4e0a\u3002"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"\u800c\u4e14\u6bcf\u6761 stickiness \u8bb0\u5f55\u5360\u7528\u7a7a\u95f4\u90fd\u5f88\u5c0f(\u5e73\u5747\u6700\u5c0f 50 \u5b57\u8282\uff0c\u6700\u5927 166 \u5b57\u8282\uff0c\u7531\u662f\u5426\u8bb0\u5f55\u989d\u5916\u7edf\u8ba1\u6570\u636e\u4ee5\u53ca\u8bb0\u5f55\u591a\u5c11\u6765\u51b3\u5b9a\u5360\u7528\u7a7a\u95f4\u5927\u5c0f)\uff0c\u4f7f\u5f97\u5373\u4f7f\u5728\u975e\u5e38\u7e41\u5fd9\u7684\u73af\u5883\u4e0b\u5728\u51e0\u5341\u4e2a\u8282\u70b9\u4e4b\u95f4\u63a8\u9001\u90fd\u4e0d\u4f1a\u51fa\u73b0\u538b\u529b\u74f6\u9888\u548c\u7f51\u7edc\u963b\u585e"),"(\u53ef\u4ee5\u6309\u8282\u70b9\u6570\u91cf\u3001stickiness \u8bb0\u5f55\u7684\u5927\u5c0f\u548c\u5e73\u5747\u5e76\u53d1\u91cf\u6765\u8ba1\u7b97\u6bcf\u79d2\u5728\u7f51\u7edc\u95f4\u63a8\u9001\u7684\u6570\u636e\u6d41\u91cf)\u3002"))),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},"stick table \u8fd8\u53ef\u4ee5\u5728 haproxy \u91cd\u542f\u65f6\uff0c",(0,s.kt)("strong",{parentName:"p"},"\u5728\u65b0\u65e7\u4e24\u4e2a\u8fdb\u7a0b\u95f4\u8fdb\u884c\u590d\u5236"),"\uff0c\u8fd9\u662f\u672c\u5730\u590d\u5236\u3002"),(0,s.kt)("ul",{parentName:"li"},(0,s.kt)("li",{parentName:"ul"},"\u5f53 haproxy \u91cd\u542f\u65f6\uff0c\u65e7 haproxy \u8fdb\u7a0b\u4f1a\u548c\u65b0 haproxy \u8fdb\u7a0b\u5efa\u7acb TCP \u8fde\u63a5\uff0c\u5c06\u5176\u7ef4\u62a4\u7684 stick table \u63a8\u9001\u7ed9\u65b0\u8fdb\u7a0b\u3002"),(0,s.kt)("li",{parentName:"ul"},"\u8fd9\u6837\u65b0\u8fdb\u7a0b\u4e0d\u4f1a\u4e22\u5931\u7c98\u6027\u4fe1\u606f\uff0c\u548c\u5176\u4ed6\u8282\u70b9\u4e5f\u80fd\u6700\u5927\u7a0b\u5ea6\u5730\u4fdd\u6301\u540c\u6b65\uff0c\u4f7f\u5f97\u5176\u4ed6\u8282\u70b9\u53ea\u9700\u8981\u63a8\u9001\u8be5\u8282\u70b9\u91cd\u542f\u8fc7\u7a0b\u4e2d\u65b0\u589e\u52a0\u7684 stickiness \u8bb0\u5f55\u5c31\u80fd\u5b8c\u5168\u4fdd\u6301\u540c\u6b65\u3002")))),(0,s.kt)("h3",{id:"921\u4f7f\u7528-stick-table"},"9.2.1\u3001\u4f7f\u7528 stick table"),(0,s.kt)("p",null,"\u4e0b\u56fe\u662f\u672c\u6587\u6d4b\u8bd5\u65f6\u7684\u73af\u5883\uff1a"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"haproxy stick-table detail",src:n(88984).Z,width:"748",height:"524"})),(0,s.kt)("h4",{id:"9211\u521b\u5efa-stick-table"},"9.2.1.1\u3001\u521b\u5efa stick table"),(0,s.kt)("p",null,"\u9996\u5148\u770b\u521b\u5efa stick table \u7684\u8bed\u6cd5\uff1a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"stick-table type {ip | integer | string [len <length>] | binary [len <length>]}\n            size <size> [expire <expire>] [nopurge] [peers <peersect>] [srvkey <srvkey>]\n            [store <data_type>]*\n")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"type ip | integer | string"),"\uff1a\u4f7f\u7528\u4ec0\u4e48\u7c7b\u578b\u7684 key \u4f5c\u4e3a\u5ba2\u6237\u7aef\u6807\u8bc6\u7b26\u3002\u53ef\u4ee5\u662f\u5ba2\u6237\u7aef\u7684\u6e90 IP\uff0c\u53ef\u4ee5\u662f\u4e00\u4e2a\u6574\u6570 ID \u503c\uff0c\u4e5f\u53ef\u4ee5\u662f\u4e00\u6bb5\u4ece\u8bf7\u6c42\u62a5\u6587\u6216\u54cd\u5e94\u62a5\u6587\u4e2d\u5339\u914d\u51fa\u6765\u7684\u5b57\u7b26\u4e32\u3002"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"size"),"\uff1a\u8868\u4e2d\u5141\u8bb8\u7684\u6700\u5927 stickiness \u8bb0\u5f55\u6570\u91cf\u3002\u5355\u4f4d\u4f7f\u7528 k\u3001m \u548c g \u8868\u793a\uff0c\u5206\u522b\u8868\u793a 1024\u30012^20 \u548c 2^30 \u6761\u8bb0\u5f55\u3002"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"expire"),"\uff1astickiness \u8bb0\u5f55\u7684\u8fc7\u671f\u65f6\u957f\u3002\u5f53\u67d0\u8bb0\u5f55\u88ab\u64cd\u4f5c\u540e\uff0c\u8fc7\u4e86\u4e00\u6bb5\u65f6\u95f4\u5c31\u4f1a\u8fc7\u671f\uff0c\u8fc7\u671f\u7684\u8bb0\u5f55\u4f1a\u81ea\u52a8\u4ece stick table \u4e2d\u79fb\u9664\uff0c\u91ca\u653e\u8868\u7a7a\u95f4\u3002"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"nopurge"),"\uff1a\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5f53\u8868\u6ee1\u540e\uff0c\u5982\u679c\u8fd8\u6709\u65b0\u7684 stickiness \u8bb0\u5f55\u8981\u63d2\u5165\u8fdb\u6765\uff0chaproxy \u4f1a\u81ea\u52a8\u5c06\u4e00\u90e8\u5206\u8001\u65e7\u7684 stickiness \u8bb0\u5f55 flush \u6389\uff0c\u4ee5\u91ca\u653e\u7a7a\u95f4\u5b58\u50a8\u65b0\u7eaa\u5f55\u3002\u6307\u5b9a nopurge \u540e\uff0c\u5c06\u4e0d\u8fdb\u884c flush\uff0c\u53ea\u80fd\u901a\u8fc7\u8bb0\u5f55\u8fc7\u671f\u6765\u91ca\u653e\u8868\u7a7a\u95f4\uff0c\u56e0\u6b64\u8be5\u9009\u9879\u5fc5\u987b\u914d\u5408 expire \u9009\u9879\u540c\u65f6\u4f7f\u7528\u3002"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"peers"),"\uff1a\u6307\u5b9a\u8981\u5c06 stick table \u4e2d\u7684\u8bb0\u5f55 replication \u5230\u5bf9\u7aef haproxy \u8282\u70b9\u3002"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"store"),"\uff1a\u6307\u5b9a\u8981\u5b58\u50a8\u5728 stick table \u4e2d\u7684\u989d\u5916\u72b6\u6001\u7edf\u8ba1\u6570\u636e\u3002\u5176\u4e2d\u4ee3\u8868\u540e\u7aef\u670d\u52a1\u5668\u7684\u6807\u8bc6\u7b26 server ID(\u5373 key/value \u7684 value \u90e8\u5206)\u4f1a\u81ea\u52a8\u63d2\u5165\uff0c\u65e0\u9700\u663e\u5f0f\u6307\u5b9a\u3002")),(0,s.kt)("p",null,"\u6ce8\u610f\uff0c\u6bcf\u4e2a",(0,s.kt)("strong",{parentName:"p"},"\u540e\u7aef\u7ec4\u53ea\u80fd\u5efa\u7acb\u4e00\u5f20 stick table\uff0c\u6bcf\u4e2a stick table \u7684 id \u6216\u540d\u79f0\u7b49\u4e8e\u540e\u7aef\u7ec4\u540d"),"\u3002\u4f8b\u5982\u5728 ",(0,s.kt)("inlineCode",{parentName:"p"},"backend StaticGroup"),' \u540e\u7aef\u521b\u5efa stick table\uff0c\u5219\u8be5\u8868\u7684 id \u4e3a "StaticGroup"\u3002\u4e5f\u6709\u7279\u6b8a\u65b9\u6cd5\u5efa\u7acb\u591a\u5f20\uff0c\u4f46\u6ca1\u6709\u5fc5\u8981\uff0c\u53ef\u7ffb\u5b98\u65b9\u624b\u518c\u627e\u65b9\u6cd5\u3002'),(0,s.kt)("p",null,"\u4f8b\u5982\uff0c\u521b\u5efa\u4e00\u4e2a\u4ee5\u6e90 IP \u5730\u5740\u4e3a key \u7684 stick table\uff0c\u8be5\u8868\u5141\u8bb8 100W \u6761\u8bb0\u5f55\uff0c5 \u5206\u949f\u7684\u8bb0\u5f55\u8fc7\u671f\u65f6\u957f\uff0c\u5e76\u4e14\u4e0d\u8bb0\u5f55\u4efb\u4f55\u989d\u5916\u6570\u636e\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"stick-table type ip size 1m expire 5m\n")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"\u8fd9\u5f20\u8868\u7531\u4e8e\u6ca1\u6709\u8bb0\u5f55\u989d\u5916\u7684\u7edf\u8ba1\u6570\u636e\uff0c\u6bcf\u6761 stickiness \u8bb0\u5f55\u5728\u5185\u5b58\u4e2d\u53ea\u5360\u7528 50 \u5b57\u8282\u5de6\u53f3\u7684\u7a7a\u95f4\uff0c\u8868\u6ee1\u540e\u6574\u5f20\u8868\u5728\u5185\u5b58\u4e2d\u5360\u7528 50MB(2^20","*","50/1024/1024=50MB)\u3002\u770b\u4e0a\u53bb\u5f88\u5927\uff0c\u4f46\u68c0\u7d22\u901f\u5ea6\u662f\u6781\u5feb\u7684\uff0c\u5b8c\u5168\u4e0d\u7528\u62c5\u5fc3\u6027\u80fd\u95ee\u9898\u3002"),(0,s.kt)("li",{parentName:"ul"},"\u5982\u679c\u8fd8\u8981\u5b58\u50a8\u548c\u5ba2\u6237\u7aef\u5efa\u7acb\u7684\u8fde\u63a5\u6570\u91cf\u8ba1\u6570\u5668(conn","_","cnt)\uff0c\u5219\uff1a")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"stick-table type ip size 1m expire 5m store conn_cnt\n")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"conn","_","cnt \u5360\u7528 32 \u4e2a bit \u4f4d\uff0c\u5373 4 \u5b57\u8282\uff0c\u56e0\u6b64\u6bcf\u6761 stickiness \u8bb0\u5f55\u5360\u7528 54 \u5b57\u8282\uff0c100W \u6761\u8bb0\u5f55\u5360\u7528 54M \u5185\u5b58\u7a7a\u95f4\u3002")),(0,s.kt)("h4",{id:"9212\u67e5\u770b-stick-table"},"9.2.1.2\u3001\u67e5\u770b stick table"),(0,s.kt)("p",null,"haproxy \u6ca1\u6709\u76f4\u63a5\u7684\u63a5\u53e3\u53ef\u4ee5\u663e\u793a stick table \u7684\u76f8\u5173\u4fe1\u606f\uff0c\u53ea\u80fd\u901a\u8fc7 ",(0,s.kt)("inlineCode",{parentName:"p"},"stats socket")," \u8fdb\u884c\u67e5\u770b\u3002\u8be5\u6307\u4ee4\u8868\u793a\u5f00\u542f\u4e00\u4e2a\u672c\u5730 unix \u5957\u63a5\u5b57\u76d1\u542c haproxy \u7684\u4fe1\u606f\uff0c\u901a\u8fc7\u8fd9\u4e2a\u5957\u63a5\u5b57\u53ef\u4ee5\u67e5\u770b haproxy \u7684\u5f88\u591a\u4fe1\u606f\uff0c\u4e14\u80fd\u52a8\u6001\u8c03\u6574 haproxy \u914d\u7f6e\u3002"),(0,s.kt)("p",null,'\u9996\u5148\u5728 haproxy \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u5f00\u542f "stats socket" \u72b6\u6001\u4fe1\u606f\uff0c\u5982\u4e0b\uff1a'),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"global\n    stats socket /var/run/haproxy.sock mode 600 level admin\n    stats timeout 2m\n")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4 stats timeout \u7684\u8fc7\u671f\u65f6\u957f\u4e3a 10s\uff0c\u5efa\u8bae\u8bbe\u7f6e\u957f\u4e00\u70b9\u3002\u4e0a\u9762\u8fd8\u8bbe\u7f6e\u4e86 socket \u7684\u6743\u9650\u7ea7\u522b\uff0c\u8868\u793a\u80fd\u8bbf\u95ee(600)\u8fd9\u4e2a\u5957\u63a5\u5b57\u7684\u4eba\u5177\u6709\u6240\u6709\u6743\u9650(admin)\u3002"),(0,s.kt)("li",{parentName:"ul"},'level \u8fd8\u6709\u4e24\u79cd\u6743\u9650\u7ea7\u522b\u66f4\u4f4e\u4e00\u70b9\u7684\u503c "read" \u548c "operator"(\u9ed8\u8ba4)\uff0c\u524d\u8005\u8868\u793a\u53ea\u6709\u8bfb\u53d6\u4fe1\u606f\u7684\u6743\u9650\uff0c\u4e0d\u80fd\u8bbe\u7f6e\u6216\u5220\u9664\u3001\u6e05\u7a7a\u67d0\u4e9b\u4fe1\u606f\uff0c\u540e\u8005\u8868\u793a\u5177\u5907\u8bfb\u548c\u67d0\u4e9b\u8bbe\u7f6e\u6743\u9650\u3002')),(0,s.kt)("p",null,'\u672c\u5730\u5957\u63a5\u5b57\u76d1\u542c haproxy \u540e\uff0c\u53ef\u4ee5\u901a\u8fc7 "socat" \u5de5\u5177(socket cat\uff0c\u5f88\u5f3a\u5927\u7684\u5de5\u5177\uff0c\u5728 epel \u6e90\u4e2d\u63d0\u4f9b)\u4ece\u5957\u63a5\u5b57\u6765\u64cd\u4f5c haproxy\u3002'),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'# \u65b9\u5f0f\u4e00\uff1a\u76f4\u63a5\u4f20\u9012\u8981\u6267\u884c\u7684\u64cd\u4f5c\u7ed9\u5957\u63a5\u5b57\necho "help" | socat unix:/var/run/haproxy.sock -\n\n# \u65b9\u5f0f\u4e8c\uff1a\u8fdb\u5165\u4ea4\u4e92\u5f0f\u6a21\u5f0f\uff0c\u7136\u540e\u5728\u4ea4\u4e92\u5f0f\u6a21\u5f0f\u4e0b\u6267\u884c\u76f8\u5173\u64cd\u4f5c\nsocat readline unix:/var/run/haproxy.sock\n')),(0,s.kt)("p",null,"\u5982\u679c\u8981\u76d1\u63a7\u67d0\u4e9b\u72b6\u6001\u4fe1\u606f\u7684\u5b9e\u65f6\u53d8\u5316\uff0c\u53ef\u4ee5\u4f7f\u7528 ",(0,s.kt)("inlineCode",{parentName:"p"},"watch")," \u547d\u4ee4\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"watch -n 1 '\"echo show table\" | socat unix:/var/run/haproxy.sock -'\n")),(0,s.kt)("p",null,"haproxy \u652f\u6301\u4ee5\u4e0b\u5217\u51fa\u7684\u6240\u6709\u64cd\u4f5c\u547d\u4ee4\uff1a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"[root@c79arm1 ~]# echo \"help\" | socat unix:/var/run/haproxy.sock -\nThe following commands are valid at this level:\n  add acl [@<ver>] <acl> <pattern>        : add an acl entry\n  add map [@<ver>] <map> <key> <val>      : add a map entry (payload supported instead of key/val)\n  clear acl [@<ver>] <acl>                : clear the contents of this acl\n  clear counters [all]                    : clear max statistics counters (or all counters)\n  clear map [@<ver>] <map>                : clear the contents of this map\n  clear table <table> [<filter>]*         : remove an entry from a table (filter: data/key)\n  commit acl @<ver> <acl>                 : commit the ACL at this version\n  commit map @<ver> <map>                 : commit the map at this version\n  del acl <acl> [<key>|#<ref>]            : delete acl entries matching <key>\n  del map <map> [<key>|#<ref>]            : delete map entries matching <key>\n  disable agent                           : disable agent checks\n  disable dynamic-cookie backend <bk>     : disable dynamic cookies on a specific backend\n  disable frontend <frontend>             : temporarily disable specific frontend\n  disable health                          : disable health checks\n  disable server (DEPRECATED)             : disable a server for maintenance (use 'set server' instead)\n  enable agent                            : enable agent checks\n  enable dynamic-cookie backend <bk>      : enable dynamic cookies on a specific backend\n  enable frontend <frontend>              : re-enable specific frontend\n  enable health                           : enable health checks\n  enable server  (DEPRECATED)             : enable a disabled server (use 'set server' instead)\n  get acl <acl> <value>                   : report the patterns matching a sample for an ACL\n  get map <acl> <value>                   : report the keys and values matching a sample for a map\n  get var <name>                          : retrieve contents of a process-wide variable\n  get weight <bk>/<srv>                   : report a server's current weight\n  operator                                : lower the level of the current CLI session to operator\n  prepare acl <acl>                       : prepare a new version for atomic ACL replacement\n  prepare map <acl>                       : prepare a new version for atomic map replacement\n  set dynamic-cookie-key backend <bk> <k> : change a backend secret key for dynamic cookies\n  set map <map> [<key>|#<ref>] <value>    : modify a map entry\n  set maxconn frontend <frontend> <value> : change a frontend's maxconn setting\n  set maxconn global <value>              : change the per-process maxconn setting\n  set maxconn server <bk>/<srv>           : change a server's maxconn setting\n  set profiling <what> {auto|on|off}      : enable/disable resource profiling (tasks,memory)\n  set rate-limit <setting> <value>        : change a rate limiting value\n  set server <bk>/<srv> [opts]            : change a server's state, weight, address or ssl\n  set severity-output [none|number|string]: set presence of severity level in feedback information\n  set table <table> key <k> [data.* <v>]* : update or create a table entry's data\n  set timeout [cli] <delay>               : change a timeout setting\n  set weight <bk>/<srv>  (DEPRECATED)     : change a server's weight (use 'set server' instead)\n  show acl [@<ver>] <acl>]                : report available acls or dump an acl's contents\n  show activity                           : show per-thread activity stats (for support/developers)\n  show backend                            : list backends in the current running config\n  show cache                              : show cache status\n  show cli level                          : display the level of the current CLI session\n  show cli sockets                        : dump list of cli sockets\n  show env [var]                          : dump environment variables known to the process\n  show errors [<px>] [request|response]   : report last request and/or response errors for each proxy\n  show events [<sink>] [-w] [-n]          : show event sink state\n  show fd [num]                           : dump list of file descriptors in use or a specific one\n  show info [desc|json|typed|float]*      : report information about the running process\n  show map [@ver] [map]                   : report available maps or dump a map's contents\n  show peers [dict|-] [section]           : dump some information about all the peers or this peers section\n  show pools                              : report information about the memory pools usage\n  show profiling [<what>|<#lines>|byaddr]*: show profiling state (all,status,tasks,memory)\n  show resolvers [id]                     : dumps counters from all resolvers section and associated name servers\n  show schema json                        : report schema used for stats\n  show servers conn [<backend>]           : dump server connections status (all or for a single backend)\n  show servers state [<backend>]          : dump volatile server information (all or for a single backend)\n  show sess [id]                          : report the list of current sessions or dump this exact session\n  show startup-logs                       : report logs emitted during HAProxy startup\n  show stat [desc|json|no-maint|typed|up]*: report counters for each proxy and server\n  show table <table> [<filter>]*          : report table usage stats or dump this table's contents (filter: data/key)\n  show tasks                              : show running tasks\n  show threads                            : show some threads debugging information\n  show trace [<module>]                   : show live tracing state\n  shutdown frontend <frontend>            : stop a specific frontend\n  shutdown session [id]                   : kill a specific session\n  shutdown sessions server <bk>/<srv>     : kill sessions on a server\n  trace [<module>|0] [cmd [args...]]      : manage live tracing (empty to list, 0 to stop all)\n  user                                    : lower the level of the current CLI session to user\n  help [<command>]                        : list matching or all commands\n  prompt                                  : toggle interactive mode with prompt\n  quit                                    : disconnect\n\n[root@c79arm1 ~]#\n")),(0,s.kt)("p",null,"\u5176\u4e2d\u548c stick table \u76f8\u5173\u7684\u547d\u4ee4\u6709\uff1a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"clear table    : remove an entry from a table\nset table [id] : update or create a table entry's data\nshow table [id]: report table usage stats or dump this table's contents\n")),(0,s.kt)("p",null,"\u6211\u4eec\u5b9e\u9a8c\u4e2d stick-table \u914d\u7f6e\u5982\u4e0b\uff1a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'# \u67e5\u770b\u4e00\u4e0b stick-table \u8bbe\u7f6e\n[root@c79arm1 ~]# grep -B 1 "stick-table" /etc/haproxy/haproxy.cfg \nbackend StaticGroup\n    stick-table type ip size 5k expire 1m\n--\nbackend DynamicGroup\n    stick-table type ip size 5k expire 1m\n[root@c79arm1 ~]#\n')),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'[root@c79arm1 ~]# echo "show table" | socat unix:/var/run/haproxy.sock -\n# table: DynamicGroup, type: ip, size:5120, used:0\n# table: StaticGroup, type: ip, size:5120, used:0\n\n[root@c79arm1 ~]#\n')),(0,s.kt)("p",null,"\u6ce8\u610f\uff1a\u672c\u6587\u53ea\u662f\u5f15\u5165 ",(0,s.kt)("inlineCode",{parentName:"p"},"stats socket")," \u7684\u64cd\u4f5c\u65b9\u5f0f\uff0c\u81f3\u4e8e\u5404\u547d\u4ee4\u7684\u4f5c\u7528\uff0c\u53c2\u89c1\u5b98\u65b9\u624b\u518c\uff1a",(0,s.kt)("inlineCode",{parentName:"p"},"http://cbonte.github.io/haproxy-dconv/2.4/management.html#9.3")),(0,s.kt)("h4",{id:"9213\u5ba2\u6237\u7aef\u6e90-ip-\u6807\u8bc6"},"9.2.1.3\u3001\u5ba2\u6237\u7aef\u6e90 IP \u6807\u8bc6"),(0,s.kt)("p",null,"\u914d\u7f6e\u6587\u4ef6\u90e8\u5206\u5185\u5bb9\u5982\u4e0b\uff1a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"frontend http-in\n    bind             *:80\n    mode             http\n    log              global\n    capture request  header Host len 20\n    capture request  header Referer len 60\n    acl url_static   path_beg  -i /static /images /stylesheets\n    acl url_static   path_end  -i .jpg .jpeg .gif .png .ico .bmp .css .js\n    acl url_static   path_end  -i .html .htm .shtml .shtm .pdf .mp3 .mp4 .rm .rmvb .txt\n    acl url_static   path_end  -i .zip .rar .gz .tgz .bz2 .tgz\n\n    use_backend      StaticGroup   if url_static\n    default_backend  DynamicGroup\n\nbackend StaticGroup\n    stick-table type ip size 5k expire 1m\n    stick on src\n    balance            roundrobin\n    option             http-keep-alive\n    http-reuse         safe\n    option httpchk     GET /index.html\n    http-check expect  status 200\n    server staticsrv1  192.168.122.104:80 check rise 1 maxconn 5000\n    server staticsrv2  192.168.122.105:80 check rise 1 maxconn 5000\n\nbackend DynamicGroup\n    stick-table type ip size 5k expire 1m\n    stick on src\n    balance roundrobin\n    option http-server-close\n    option httpchk     GET /index.php\n    http-check expect  status 200\n    server appsrv1 192.168.122.102:80  check rise 1 maxconn 3000\n    server appsrv2 192.168.122.103:80  check rise 1 maxconn 3000\n")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"\u4e0a\u9762\u7684\u914d\u7f6e\u4e2d\uff0c\u8bbe\u7f6e\u4e86acl\uff0c\u5f53\u6ee1\u8db3\u9759\u6001\u8bbf\u95ee\u65f6\uff0c\u4f7f\u7528 StaticGroup \u540e\u7aef\u7ec4\uff0c\u5426\u5219\u4f7f\u7528 DynamicGroup \u540e\u7aef\u7ec4\u3002"),(0,s.kt)("li",{parentName:"ul"},"\u5728\u4e24\u4e2a\u540e\u7aef\u7ec4\u4e2d\uff0c\u90fd\u8bbe\u7f6e\u4e86 ",(0,s.kt)("inlineCode",{parentName:"li"},"stick-table")," \u548c ",(0,s.kt)("inlineCode",{parentName:"li"},"stick on"),"\uff0c\u5176\u4e2d ",(0,s.kt)("inlineCode",{parentName:"li"},"stick on")," \u662f\u5b58\u50a8\u6307\u5b9a\u5185\u5bb9\uff0c\u5e76\u5728\u8bf7\u6c42\u5230\u8fbe\u65f6\u5339\u914d\u8be5\u5185\u5bb9\uff0c\u5b83\u7684\u5177\u4f53\u7528\u6cd5\u89c1\u540e\u6587\u3002\u53ea\u6709\u914d\u7f6e\u4e86 ",(0,s.kt)("inlineCode",{parentName:"li"},"stick on")," \u540e\uff0chaproxy \u624d\u80fd\u6839\u636e\u5339\u914d\u7684\u7ed3\u679c\u51b3\u5b9a\u662f\u5426\u5b58\u50a8\u5230 stick table \u4e2d\uff0c\u4ee5\u53ca\u5982\u4f55\u7b5b\u9009\u5f85\u5206\u6d3e\u7684\u540e\u7aef\u3002"),(0,s.kt)("li",{parentName:"ul"},"\u603b\u4e4b\uff0c\u4e0a\u9762\u7684\u4e24\u4e2a\u540e\u7aef\u7ec4\u90fd\u5df2\u7ecf\u6307\u5b9a\u4e86\u8981\u5411 stick table \u4e2d\u5b58\u50a8\u6e90 ip \u5730\u5740\u4f5c\u4e3a key\u3002\u5f53\u5ba2\u6237\u7aef\u8bf7\u6c42\u5230\u8fbe\u65f6\uff0chaproxy \u6839\u636e\u8c03\u5ea6\u7b97\u6cd5\u5206\u914d\u4e00\u4e2a\u540e\u7aef\uff0c\u4f46\u8bf7\u6c42\u4ea4\u7ed9\u540e\u7aef\u6210\u529f\u540e\uff0cHaproxy \u7acb\u5373\u5411 stick table \u8868\u4e2d\u63d2\u5165\u4e00\u6761 stickiness \u8bb0\u5f55\u3002",(0,s.kt)("ul",{parentName:"li"},(0,s.kt)("li",{parentName:"ul"},"\u5f53\u5ba2\u6237\u7aef\u8bf7\u6c42\u518d\u6b21\u5230\u8fbe\u65f6\uff0chaproxy \u53d1\u73b0\u80fd\u5339\u914d\u6e90 ip\uff0c\u4e8e\u662f\u6309\u7167\u8be5 stickiness \u8bb0\u5f55\uff0c\u5c06\u8bf7\u6c42\u5206\u914d\u7ed9\u5bf9\u5e94\u7684\u540e\u7aef\u3002")))),(0,s.kt)("p",null,"\u4ee5\u4e0b\u662f\u5206\u522b\u4f7f\u7528\u4e24\u53f0\u673a\u5668\u6d4b\u8bd5 ",(0,s.kt)("inlineCode",{parentName:"p"},"192.168.122.101/index.html")," \u548c ",(0,s.kt)("inlineCode",{parentName:"p"},"192.168.122.101/index.php")," \u540e\uff0cstick table \u8bb0\u5f55\u7684\u6570\u636e\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'[root@c79arm1 ~]# echo "show table DynamicGroup" | socat unix:/var/run/haproxy.sock - \n# table: DynamicGroup, type: ip, size:5120, used:2\n0x201effb0: key=192.168.122.1 use=0 exp=43604 server_id=1 server_key=appsrv1\n0xffff78033970: key=192.168.122.106 use=0 exp=50021 server_id=2 server_key=appsrv2\n\n[root@c79arm1 ~]# echo "show table StaticGroup" | socat unix:/var/run/haproxy.sock - \n# table: StaticGroup, type: ip, size:5120, used:2\n0x201ef980: key=192.168.122.1 use=0 exp=37314 server_id=1 server_key=staticsrv1\n0xffff70033900: key=192.168.122.106 use=0 exp=50135 server_id=2 server_key=staticsrv2\n')),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"\u5176\u4e2d server","_",'id \u9ed8\u8ba4\u662f\u4ece 1 \u81ea\u589e\u7684\uff0c\u5b83\u53ef\u4ee5\u5728 server \u6307\u4ee4\u4e2d\u7528 "id" \u9009\u9879\u8fdb\u884c\u663e\u5f0f\u6307\u5b9a\u3002\u4f8b\u5982\uff1a')),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"server appsrv1 192.168.122.102:80 id 123 check rise 1 maxconn 3000\n")),(0,s.kt)("h4",{id:"9214\u5ba2\u6237\u7aef-cookie-\u6807\u8bc6"},"9.2.1.4\u3001\u5ba2\u6237\u7aef cookie \u6807\u8bc6"),(0,s.kt)("p",null,"\u4e00\u822c\u4f1a\u8bdd\u4fdd\u6301\u8003\u8651\u7684\u5bf9\u8c61\u662f\u5e94\u7528\u7a0b\u5e8f\u670d\u52a1\u5668\uff0c\u56e0\u6b64\u6b64\u5904\u6211\u4eec\u5ffd\u7565\u540e\u7aef\u7684\u9759\u6001\u670d\u52a1\u5668\uff0c\u53ea\u8003\u8651 php \u5e94\u7528\u670d\u52a1\u5668\u3002\u5728 DynamicGroup \u4e24\u4e2a\u540e\u7aef server appsrv1 \u548c server appsrv2 \u7684 index.php \u4e2d\u5206\u522b\u8bbe\u7f6e\u597d PHPSESSID \u4f5c\u4e3a\u6d4b\u8bd5\u3002\u4f8b\u5982\uff1a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'<h1>response from webapp 192.168.122.102</h1>\n<?php\n        session_start();\n        echo "Server IP: "."<font color=red>".$_SERVER[\'SERVER_ADDR\']."</font>"."<br>";\n        echo "Server Name: "."<font color=red>".$_SERVER[\'SERVER_NAME\']."</font>"."<br>";\n        echo "SESSIONNAME: "."<font color=red>".session_name()."</font>"."<br>";\n        echo "SESSIONID: "."<font color=red>".session_id()."</font>"."<br>";\n?>\n')),(0,s.kt)("p",null,"cookie \u662f string \u7684\u4e00\u79cd\u7279\u6b8a\u60c5\u51b5\uff0c\u56e0\u6b64\u521b\u5efa stick table \u65f6\uff0c\u6307\u5b9a type \u4e3a string\u3002\u4ee5\u4e0b\u662f\u5728 haproxy \u4e0a\u7684\u914d\u7f6e\uff1a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"backend DynamicGroup\n    stick-table type string len 32 size 5k expire 2m\n    stick on req.cook(PHPSESSID)\n    stick store-response res.cook(PHPSESSID)\n    balance roundrobin\n    option http-server-close\n    option httpchk     GET /index.php\n    http-check expect  status 200\n    server appsrv1 192.168.122.102:80  check rise 1 maxconn 3000\n    server appsrv2 192.168.122.103:80  check rise 1 maxconn 3000\n")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"stick store-response"),' \u6307\u4ee4\u8868\u793a\u4ece\u54cd\u5e94\u62a5\u6587\u4e2d\u5339\u914d\u67d0\u4e9b\u6570\u636e\u51fa\u6765\uff0c\u7136\u540e\u5b58\u50a8\u5230 stick table \u4e2d\uff0c\u6b64\u5904\u8868\u793a\u622a\u53d6\u54cd\u5e94\u62a5\u6587\u4e2d "Set-Cookie" \u5b57\u6bb5\u4e2d\u540d\u4e3a "PHPSESSID" \u7684 cookie \u540d\u8fdb\u884c\u5b58\u50a8\u3002'),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"stick on req.cook(PHPSESSID)"),' \u8868\u793a\u4ece\u8bf7\u6c42\u62a5\u6587\u7684 "Cookie" \u5b57\u6bb5\u4e2d\u5339\u914d\u540d\u4e3a PHPSESSID \u7684 cookie\u3002\u5982\u679c\u80fd\u548c\u5b58\u50a8\u5728 stick table \u4e2d\u7684 PHPSESSID \u5339\u914d\u6210\u529f\uff0c\u5219\u8868\u793a\u8be5\u5ba2\u6237\u7aef\u88ab\u5904\u7406\u8fc7\uff0c\u4e8e\u662f\u5c06\u5176\u5f15\u5bfc\u5230\u5bf9\u5e94\u7684\u540e\u7aef\u670d\u52a1\u5668\u4e0a\u3002\u4e25\u683c\u5730\u8bf4\uff0c\u8fd9\u91cc\u4e0d\u662f\u8bc6\u522b\u5ba2\u6237\u7aef\uff0c\u800c\u662f\u901a\u8fc7 PHPSESSID \u6765\u8bc6\u522b\u540e\u7aef\u3002')),(0,s.kt)("p",null,"\u6d4f\u89c8\u5668\u8bf7\u6c42\u540e\u53d1\u751f\u4f1a\u8bdd\u7c98\u6027\uff0c\u5728 haproxy \u4e0a\u67e5\u770b stick table\uff1a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'[root@c79arm1 ~]# echo "show table DynamicGroup" | socat unix:/var/run/haproxy.sock - \n# table: DynamicGroup, type: string, size:5120, used:1\n0xffffb8027320: key=8bvq7fcvprj29oj6s1n0djokk5 use=0 exp=117654 server_id=2 server_key=appsrv2\n\n[root@c79arm1 ~]#\n')),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"\u6ce8\u610f\uff0c\u4e0d\u8981\u4f7f\u7528 curl \u547d\u4ee4\u6765\u6d4b\u8bd5\uff0c\u56e0\u4e3a\u8fd9\u91cc\u662f\u6839\u636e PHPSESSID \u5339\u914d\u7684\uff0ccurl \u6bcf\u6b21\u63a5\u6536\u5230\u54cd\u5e94\u540e\u8fdb\u7a0b\u5c31\u76f4\u63a5\u9000\u51fa\u4e86\uff0c\u65e0\u6cd5\u7f13\u5b58 cookie\uff0c\u56e0\u6b64 curl \u6bcf\u6b21\u8bf7\u6c42\u90fd\u76f8\u5f53\u4e8e\u4e00\u6b21\u65b0\u8bf7\u6c42\u3002"))),(0,s.kt)("h4",{id:"9215\u5ba2\u6237\u7aef-string-\u6807\u8bc6"},"9.2.1.5\u3001\u5ba2\u6237\u7aef string \u6807\u8bc6"),(0,s.kt)("p",null,"\u4e0a\u9762\u7684 cookie \u662f string \u7684\u4e00\u79cd\u7279\u6b8a\u7528\u6cd5\u3002\u4f7f\u7528 string \u7b5b\u9009\u5185\u5bb9\u8fdb\u884c\u5b58\u50a8\uff0c\u7075\u6d3b\u6027\u975e\u5e38\u5927\uff0c\u53ef\u4ee5\u901a\u8fc7\u5b83\u5b9e\u73b0\u67d0\u4e9b\u590d\u6742\u3001\u7279\u6b8a\u7684\u9700\u6c42\u3002"),(0,s.kt)("p",null,"\u4f8b\u5982\uff0c\u4ece\u8bf7\u6c42\u62a5\u6587\u4e2d\u622a\u53d6 Host \u5b57\u6bb5\u7684\u503c\u4f5c\u4e3a key \u5b58\u50a8\u8d77\u6765\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"backend DynamicGroup\n    stick-table type string size 5k expire 2m\n    stick on req.hdr(Host)\n    balance roundrobin\n    option http-server-close\n    option httpchk     GET /index.php\n    http-check expect  status 200\n    server appsrv1 192.168.122.102:80  check rise 1 maxconn 3000\n    server appsrv2 192.168.122.103:80  check rise 1 maxconn 3000\n")),(0,s.kt)("p",null,"\u627e\u4e00\u53f0 linux \u5ba2\u6237\u7aef\u4f7f\u7528 curl \u8fdb\u884c\u6d4b\u8bd5\uff0c\u53d1\u73b0\u6240\u6709\u8bf7\u6c42\u90fd\u5c06\u5f15\u5bfc\u5230\u540c\u4e00\u540e\u7aef\u670d\u52a1\u5668\u4e0a\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'[root@yidam ~]# for i in {1..8};do grep "response" <(curl 192.168.122.101/index.php 2> /dev/null);done\n<h1>response from webapp 192.168.122.102</h1>\n<h1>response from webapp 192.168.122.102</h1>\n<h1>response from webapp 192.168.122.102</h1>\n<h1>response from webapp 192.168.122.102</h1>\n<h1>response from webapp 192.168.122.102</h1>\n<h1>response from webapp 192.168.122.102</h1>\n<h1>response from webapp 192.168.122.102</h1>\n<h1>response from webapp 192.168.122.102</h1>\n[root@yidam ~]#\n')),(0,s.kt)("p",null,"\u67e5\u770b stick table \u4e5f\u53ea\u80fd\u770b\u5230\u4e00\u6761\u8bb0\u5f55\uff0c\u800c\u4e14\u5176 key \u90e8\u5206\u6b63\u662f\u6355\u83b7\u5230\u7684 Host \u5b57\u6bb5\u7684\u503c\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'[root@c79arm1 ~]# echo "show table DynamicGroup" | socat unix:/var/run/haproxy.sock - \n# table: DynamicGroup, type: string, size:5120, used:1\n0x1dbfa00: key=192.168.122.101 use=0 exp=65915 server_id=1 server_key=appsrv1\n')),(0,s.kt)("h4",{id:"9216stick-onstick-matchstick-store"},"9.2.1.6\u3001stick on\u3001stick match\u3001stick store"),(0,s.kt)("p",null,"\u5728\u524d\u9762 haproxy \u7684\u914d\u7f6e\u4e2d\u51fa\u73b0\u8fc7 ",(0,s.kt)("inlineCode",{parentName:"p"},"stick on")," \u548c ",(0,s.kt)("inlineCode",{parentName:"p"},"stick store-response"),"\uff0c\u9664\u6b64\u4e4b\u5916\uff0c\u8fd8\u6709\u4e24\u4e2a\u6307\u4ee4 ",(0,s.kt)("inlineCode",{parentName:"p"},"stick match"),"\u3001",(0,s.kt)("inlineCode",{parentName:"p"},"stick store-request"),"\u3002\u8bed\u6cd5\u5982\u4e0b\uff1a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"stick store-request <pattern> [table <table>] [{if | unless} <condition>]\nstick store-response <pattern> [table <table>] [{if | unless} <condition>]\nstick match <pattern> [table <table>] [{if | unless} <cond>]\nstick on <pattern> [table <table>] [{if | unless} <condition>]\n")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"\u5176\u4e2d ",(0,s.kt)("inlineCode",{parentName:"li"},"stick store")," \u6307\u4ee4\u662f\u4ece\u8bf7\u6c42\u6216\u54cd\u5e94\u62a5\u6587\u4e2d\u622a\u53d6\u4e00\u90e8\u5206\u5b57\u7b26\u4e32\u51fa\u6765\uff0c\u5e76\u5c06\u5176\u4f5c\u4e3a stickiness \u7684 key \u5b58\u50a8\u5230 stick table \u4e2d\u3002\u4f8b\u5982\uff1a")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"# \u622a\u53d6\u54cd\u5e94\u62a5\u6587\u4e2d\u540d\u4e3aPHPSESSID\u7684cookie\u4f5c\u4e3akey\nstick store-response res.cook(PHPSESSID)\n\n# \u622a\u53d6\u8bf7\u6c42\u62a5\u6587\u4e2dHost\u5b57\u6bb5\u7684\u503c\u4f5c\u4e3akey\nstick store-request req.hdr(Host)\n\n# \u5bf9\u8bf7\u6c42\u7684\u6e90ip\u5730\u5740\u8fdb\u884c\u5339\u914d\uff0c\u82e5\u4e0d\u662f\u5144\u5f1f\u7f51\u7edc\u4e2d\u7684\u4e3b\u673a\u65f6\uff0c\u5c31\u5199\u5165stick table\u4e2d\uff0c\u4e14\u8be5table\u540d\u4e3aDynamicGroup\nstick store-request src table DynamicGroup if !my_brother\n")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"stick match")," \u662f\u5c06\u8bf7\u6c42\u62a5\u6587\u4e2d\u7684\u6307\u5b9a\u90e8\u5206\u548c stick table \u4e2d\u7684\u8bb0\u5f55\u8fdb\u884c\u5339\u914d\u3002\u4f8b\u5982\uff1a")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"# \u622a\u53d6\u8bf7\u6c42\u62a5\u6587\u4e2d\u540d\u4e3aPHPSESSID\u7684cookie\uff0c\u53bbstick table\u4e2d\u641c\u7d22\u662f\u5426\u5b58\u5728\u5bf9\u5e94\u7684\u8bb0\u5f55\nstick match req.cook(PHPSESSID)\n\n# \u5f53\u6e90IP\u4e0d\u662f\u672c\u673a\u65f6\uff0c\u53bbDynamicGroup\u8868\u4e2d\u641c\u7d22\u662f\u5426\u6709\u80fd\u5339\u914d\u5230\u6e90IP\u5730\u5740\u7684\u8bb0\u5f55\nstick match src table DynamicGroup if !localhost\n")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"stick on")," \u7b49\u4ef7\u4e8e ",(0,s.kt)("inlineCode",{parentName:"li"},"stick store"),"+",(0,s.kt)("inlineCode",{parentName:"li"},"stick match"),"\uff0c\u662f\u5b83\u4eec\u7684\u7b80\u5316\u5199\u6cd5\u3002\u4f8b\u5982\uff1a")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"# \u5b58\u50a8\u5e76\u5339\u914d\u6e90IP\u5730\u5740\nstick on src               #1 = #2 + #3\nstick match src            #2\nstick store-request src    #3\n\n# \u5b58\u50a8\u5e76\u5339\u914d\u6e90IP\u5730\u5740\nstick on src table DynamicGroup if !localhost             #1 = #2 + #3\nstick match src table DynamicGroup if !localhost          #2\nstick store-request src table DynamicGroup if !localhost  #3\n\n# \u5b58\u50a8\u5e76\u5339\u914d\u540e\u7aef\u670d\u52a1\u5668\u8bbe\u7f6e\u7684PHPSESSID\nstick on req.cook(PHPSESSID)                 #1 +#2 = #3 + #4\nstick store-response res.cook(PHPSESSID)     #2\nstick match req.cook(PHPSESSID)              #3\nstick store-response res.cook(PHPSESSID)     #4\n")),(0,s.kt)("h4",{id:"9217stick-table-\u7edf\u8ba1\u72b6\u6001\u4fe1\u606f"},"9.2.1.7\u3001stick table \u7edf\u8ba1\u72b6\u6001\u4fe1\u606f"),(0,s.kt)("p",null,'stick table \u9664\u4e86\u5b58\u50a8\u57fa\u672c\u7684\u7c98\u6027\u4fe1\u606f\uff0c\u8fd8\u80fd\u5b58\u50a8\u989d\u5916\u7684\u7edf\u8ba1\u6570\u636e\uff0c\u8fd9\u5176\u5b9e\u662f haproxy \u63d0\u4f9b\u7684\u4e00\u79cd "',(0,s.kt)("strong",{parentName:"p"},"\u91c7\u6837\u8c03\u67e5"),'" \u529f\u80fd\u3002\u5b83\u80fd\u91c7\u96c6\u7684\u6570\u636e\u79cd\u7c7b\u6709\u4ee5\u4e0b\u51e0\u79cd\uff1a'),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"haproxy samples",src:n(84988).Z,width:"778",height:"668"})),(0,s.kt)("p",null,"\u6bcf\u4e2a stickiness \u8bb0\u5f55\u4e2d\u53ef\u4ee5\u540c\u65f6\u5b58\u50a8\u591a\u4e2a\u8bb0\u5f55\u7c7b\u578b\uff0c\u4f7f\u7528\u9017\u53f7\u5206\u9694\u6216\u591a\u6b21\u4f7f\u7528 store \u5173\u952e\u5b57\u5373\u53ef\u3002\u4f46\u6ce8\u610f\uff0c\u540e\u7aef\u670d\u52a1\u5668\u7684 server id \u4f1a\u81ea\u52a8\u8bb0\u5f55\uff0c\u5176\u5b83\u6240\u6709\u989d\u5916\u4fe1\u606f\u90fd\u9700\u8981\u663e\u5f0f\u6307\u5b9a\u3002"),(0,s.kt)("p",null,"\u9700\u8981\u6ce8\u610f\uff0c\u6bcf\u4e2a haproxy \u540e\u7aef\u7ec4\u53ea\u80fd\u6709\u4e00\u5f20 stick table\uff0c\u4f46\u5374\u4e0d\u5efa\u8bae\u7edf\u8ba1\u592a\u591a\u989d\u5916\u7684\u72b6\u6001\u4fe1\u606f\uff0c\u56e0\u4e3a\u6bcf\u591a\u5b58\u4e00\u4e2a\u7c7b\u578b\uff0c\u610f\u5473\u7740\u4f7f\u7528\u66f4\u591a\u7684\u5185\u5b58\u3002"),(0,s.kt)("p",null,"\u5982\u679c\u5b58\u50a8\u6240\u6709\u4e0a\u8ff0\u5217\u51fa\u7684\u6570\u636e\u7c7b\u578b\uff0c\u9700\u8981 116 \u5b57\u8282\uff0c100W \u6761\u8bb0\u5f55\u8981\u7528 116M\uff0c\u8fd9\u4e0d\u662f\u53ef\u4ee5\u5ffd\u7565\u7684\u5927\u5c0f\u3002\u6b64\u5916\u8fd8\u6709 50M \u7684 key\uff0c\u5171 166M\u3002"),(0,s.kt)("p",null,"\u4f8b\u5982\u4e0b\u9762\u7684\u793a\u4f8b\u4e2d\uff0c\u4f7f\u7528\u4e86\u901a\u7528\u8ba1\u6570\u5668\u7d2f\u8ba1\uff0c\u5e76\u8bb0\u5f55\u4e86\u6bcf 30 \u79d2\u5185\u7684\u5e73\u5747\u8fde\u63a5\u901f\u7387\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"stick-table type ip size 1m expire 5m store gpc0,conn_rate(30s)\n")),(0,s.kt)("h2",{id:"93haproxy-stick-table-\u590d\u5236"},"9.3\u3001haproxy stick table \u590d\u5236"),(0,s.kt)("p",null,"\u5728\u4e0a\u4e00\u8282\u4e2d\uff0c\u5206\u6790\u4e86 haproxy \u7684 stick table \u7279\u6027\u548c\u7528\u6cd5\uff0c\u5176\u4e2d\u7279\u6027\u4e4b\u4e00\u4e5f\u662f\u5f88\u5b9e\u7528\u7684\u7279\u6027\u662f stick table \u652f\u6301\u5728 haproxy \u591a\u4e2a\u8282\u70b9\u4e4b\u95f4\u8fdb\u884c\u590d\u5236(replication)\u3002"),(0,s.kt)("p",null,"\u672c\u6587\u4ec5\u8ba8\u8bba\u5982\u4f55\u914d\u7f6e\u5b9e\u73b0 stick table \u7684\u590d\u5236\u529f\u80fd\uff0c\u4e0d\u8003\u8651\u5728\u4ec0\u4e48\u73af\u5883\u4e0b\u5b9e\u73b0\u5b83\uff0c\u4ee5\u53ca\u5b83\u7684\u53cc\u4e3b\u6a21\u578b\u5982\u4f55\u914d\u7f6e\u3002"),(0,s.kt)("p",null,"\u672c\u6587\u5b9e\u9a8c\u73af\u5883\uff1a"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"haproxy replication",src:n(35626).Z,width:"682",height:"592"})),(0,s.kt)("h3",{id:"931stick-table-\u590d\u5236\u7279\u6027"},"9.3.1\u3001stick table \u590d\u5236\u7279\u6027"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},"\u53ea\u8981\u8bbe\u7f6e\u597d haproxy \u7684\u8282\u70b9\u7ec4\uff0chaproxy \u5c31\u4f1a\u81ea\u52a8\u5c06\u65b0\u63d2\u5165\u7684\u3001\u521a\u66f4\u65b0\u7684 stickiness \u8bb0\u5f55\u901a\u8fc7 TCP \u8fde\u63a5\u63a8\u9001\u5230\u8282\u70b9\u7ec4\u4e2d\u7684\u975e\u672c\u5730\u8282\u70b9\u4e0a\u3002",(0,s.kt)("ul",{parentName:"li"},(0,s.kt)("li",{parentName:"ul"},"\u8fd9\u6837\u4e00\u6765\uff0cstickiness \u8bb0\u5f55\u4e0d\u4f1a\u4e22\u5931\uff0c\u5373\u4f7f\u67d0 haproxy \u8282\u70b9\u51fa\u73b0\u4e86\u6545\u969c\uff0c\u5176\u4ed6\u8282\u70b9\u4e5f\u80fd\u5c06\u5ba2\u6237\u7aef\u6309\u7167\u7c98\u6027\u6620\u5c04\u5173\u7cfb\u5f15\u5bfc\u5230\u6b63\u786e\u7684\u540e\u7aef\u670d\u52a1\u5668\u4e0a\u3002"))),(0,s.kt)("li",{parentName:"ol"},"\u7531\u4e8e\u6bcf\u6761 stickiness \u8bb0\u5f55\u5360\u7528\u7a7a\u95f4\u90fd\u5f88\u5c0f(\u5e73\u5747\u6700\u5c0f 50 \u5b57\u8282\uff0c\u6700\u5927 166 \u5b57\u8282\uff0c\u7531\u662f\u5426\u8bb0\u5f55\u989d\u5916\u7edf\u8ba1\u6570\u636e\u4ee5\u53ca\u8bb0\u5f55\u591a\u5c11\u6765\u51b3\u5b9a\u5360\u7528\u7a7a\u95f4\u5927\u5c0f)\uff0c\u4f7f\u5f97\u5373\u4f7f\u5728\u975e\u5e38\u7e41\u5fd9\u7684\u73af\u5883\u4e0b\u591a\u4e2a\u8282\u70b9\u4e4b\u95f4\u63a8\u9001\u90fd\u4e0d\u4f1a\u51fa\u73b0\u538b\u529b\u74f6\u9888\u548c\u7f51\u7edc\u963b\u585e(\u53ef\u4ee5\u6309\u8282\u70b9\u6570\u91cf\u3001stickiness \u8bb0\u5f55\u7684\u5927\u5c0f\u548c\u5e73\u5747\u5e76\u53d1\u91cf\u6765\u8ba1\u7b97\u6bcf\u79d2\u5728\u7f51\u7edc\u95f4\u63a8\u9001\u7684\u6570\u636e\u6d41\u91cf)\u3002"),(0,s.kt)("li",{parentName:"ol"},"stick table \u590d\u5236\u4e0d\u50cf\u88ab\u4eba\u8bdf\u75c5\u7684 session \u590d\u5236(copy)\uff0c\u56e0\u4e3a session \u590d\u5236\u7684\u6570\u636e\u91cf\u6bd4\u8f83\u5927\uff0c\u800c\u4e14\u662f\u5728\u5404\u5e94\u7528\u7a0b\u5e8f\u670d\u52a1\u5668\u4e4b\u95f4\u8fdb\u884c\u7684\u3002\u800c\u4e00\u4e2a\u7a0d\u5927\u4e00\u70b9\u7684\u6838\u5fc3\u5e94\u7528\uff0c\u63d0\u4f9b\u670d\u52a1\u7684\u5e94\u7528\u7a0b\u5e8f\u670d\u52a1\u5668\u6570\u91cf\u90fd\u4e0d\u4f1a\u5c0f\uff0c\u8fd9\u6837\u590d\u5236\u8d77\u6765\u5f88\u5bb9\u51fa\u73b0\u7f51\u7edc\u963b\u585e\u3002"),(0,s.kt)("li",{parentName:"ol"},"\u6b64\u5916\uff0cstick table \u8fd8\u53ef\u4ee5\u5728 haproxy \u91cd\u542f\u65f6\uff0c\u5728\u65b0\u65e7\u4e24\u4e2a\u8fdb\u7a0b\u95f4\u8fdb\u884c\u590d\u5236\uff0c\u8fd9\u662f\u672c\u5730\u590d\u5236\u3002",(0,s.kt)("ul",{parentName:"li"},(0,s.kt)("li",{parentName:"ul"},"\u5f53 haproxy \u91cd\u542f\u65f6\uff0c\u65e7 haproxy \u8fdb\u7a0b\u4f1a\u548c\u65b0 haproxy \u8fdb\u7a0b\u5efa\u7acb TCP \u8fde\u63a5\uff0c\u5c06\u5176\u7ef4\u62a4\u7684 stick table \u63a8\u9001\u7ed9\u65b0\u8fdb\u7a0b\u3002"),(0,s.kt)("li",{parentName:"ul"},"\u8fd9\u6837\u65b0\u8fdb\u7a0b\u4e0d\u4f1a\u4e22\u5931\u7c98\u6027\u4fe1\u606f\uff0c\u548c\u5176\u4ed6\u8282\u70b9\u4e5f\u80fd\u6700\u5927\u7a0b\u5ea6\u5730\u4fdd\u6301\u540c\u6b65\uff0c\u4f7f\u5f97\u5176\u4ed6\u8282\u70b9\u53ea\u9700\u8981\u63a8\u9001\u8be5\u8282\u70b9\u91cd\u542f\u8fc7\u7a0b\u4e2d\u65b0\u589e\u52a0\u7684 stickiness \u8bb0\u5f55\u5c31\u80fd\u5b8c\u5168\u4fdd\u6301\u540c\u6b65\u3002"))),(0,s.kt)("li",{parentName:"ol"},"\u5982\u679c\u540e\u7aef\u4f7f\u7528\u4e86 session \u5171\u4eab\uff0c\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\u6ca1\u5fc5\u8981\u5728\u4ee3\u7406\u5c42\u5b9e\u73b0\u4f1a\u8bdd\u4fdd\u6301\u3002\u5982\u679c\u6b64\u65f6\u4f7f\u7528 stick table\uff0c\u4e00\u822c\u53ea\u662f\u4e3a\u4e86\u6536\u96c6\u7edf\u8ba1\u6570\u636e\u8fdb\u884c\u91c7\u6837\u8c03\u67e5\uff0c\u4f46\u8fd9\u6837\u7684\u72b6\u6001\u7edf\u8ba1\u6570\u636e\u65e0\u9700\u5728\u5404\u8282\u70b9\u4e4b\u95f4\u8fdb\u884c\u590d\u5236\u3002")),(0,s.kt)("h3",{id:"932\u5b9a\u4e49-haproxy-\u8282\u70b9\u6210\u5458"},"9.3.2\u3001\u5b9a\u4e49 haproxy \u8282\u70b9\u6210\u5458"),(0,s.kt)("p",null,"haproxy \u63d0\u4f9b\u4e86 ",(0,s.kt)("inlineCode",{parentName:"p"},"peers")," \u6307\u4ee4\uff0c\u7528\u4e8e\u5b9a\u4e49\u8282\u70b9\u7ec4\uff0c",(0,s.kt)("inlineCode",{parentName:"p"},"peer")," \u6307\u4ee4\u7528\u4e8e\u5b9a\u4e49\u8282\u70b9\u7ec4\u4e2d\u7684\u6210\u5458\u3002"),(0,s.kt)("p",null,"\u4f8b\u5982\uff0c\u5b9a\u4e49\u672c\u6d4b\u8bd5\u73af\u5883\u7684\u8282\u70b9\u7ec4\uff1a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"peers my_peers    # \u8282\u70b9\u7ec4\u540d\n    peer haproxy1 192.168.122.101:12138  # \u5b9a\u4e49\u5bf9\u7aef\u540d\u79f0\uff0c\u4ee5\u53ca\u548c\u5bf9\u7aef\u5efa\u7acbtcp\u8fde\u63a5\u7684\u7aef\u53e3\uff0c\u7528\u4e8e\u63a8\u9001stickiness\u8bb0\u5f55\n    peer haproxy2 192.168.122.106:12138\n    peer haproxy3 192.168.122.107:12138\n")),(0,s.kt)("p",null,"\u7136\u540e\u5728 ",(0,s.kt)("inlineCode",{parentName:"p"},"stick-table")," \u6307\u4ee4\u4e2d\u5f15\u7528\u8282\u70b9\u7ec4\u3002\u4f8b\u5982\uff1a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"stick-table type ip size 100k expire 5m peers my_peers\n")),(0,s.kt)("p",null,'\u6ce8\u610f\uff0c\u5e94\u5f53\u8ba9\u6bcf\u4e2a haproxy \u8282\u70b9\u7684\u8282\u70b9\u7ec4\u5185\u5bb9\u4e00\u81f4\uff0c\u7136\u540e\u4f7f\u7528 haproxy \u547d\u4ee4\u7684 "-L" \u9009\u9879\u6307\u5b9a\u672c\u5730\u8282\u70b9\u6210\u5458\uff0c\u8fd9\u6837\u65b9\u4fbf\u7ba1\u7406\u6bcf\u4e2a\u8282\u70b9\u548c\u672c\u5730\u8282\u70b9\u3002'),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"haproxy -D -L haproxy1 -f /etc/haproxy/haproxy.cfg\n")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},'\u5982\u679c\u4e0d\u6307\u5b9a "-L"\uff0c\u5219\u5728\u89e3\u6790\u914d\u7f6e\u6587\u4ef6\u65f6\u5c06\u9ed8\u8ba4\u4ee5\u4e3b\u673a\u540d\u4f5c\u4e3a\u672c\u5730\u8282\u70b9\u540d\u8fdb\u884c\u89e3\u6790\uff0c\u4f46\u5f88\u53ef\u80fd\u5b83\u4e0d\u4f1a\u5b9a\u4e49\u5728 ',(0,s.kt)("inlineCode",{parentName:"li"},"peers")," \u4e2d\uff0c\u56e0\u6b64\u4f1a\u62a5\u9519\u3002")),(0,s.kt)("p",null,'\u56e0\u6b64\uff0c\u5982\u679c\u8981\u5b9e\u73b0 stick table \u7684\u590d\u5236\uff0c\u8fd8\u60f3\u4f7f\u7528 sysV \u6216 systemctl \u7ba1\u7406 haproxy \u670d\u52a1\uff0c\u9700\u8981\u4fee\u6539\u8fd9\u4e9b\u670d\u52a1\u7ba1\u7406\u811a\u672c\uff0c\u5728\u542f\u52a8\u3001\u91cd\u542f\u548c\u8bed\u6cd5\u68c0\u67e5\u9879\u4e0a\u52a0\u4e0a "-L" \u9009\u9879\u3002\u4f8b\u5982\uff0csystemd \u7684 haproxy \u670d\u52a1\u7ba1\u7406\u811a\u672c\u6539\u4e3a\u5982\u4e0b\u5185\u5bb9\uff1a'),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"[Unit]\nDescription=Haproxy Service\nAfter=syslog.target network.target\n\n[Service]\nType=forking\nExecStart=/usr/local/haproxy/sbin/haproxy -L haproxy1 -f /etc/haproxy/haproxy.cfg\nExecStop=cd&&/usr/local/haproxy/sbin/&&pkill haproxy\n[Install]\nWantedBy=multi-user.target\n")),(0,s.kt)("p",null,(0,s.kt)("em",{parentName:"p"},"\u6ce8\u610f\uff1a\u6bcf\u4e2a\u8282\u70b9\u8981\u4e48\u5b8c\u5168\u4f7f\u7528 sysV\u3001systemctl \u7ba1\u7406 haproxy \u7684\u542f\u52a8\u3001\u505c\u6b62\uff0c\u8981\u4e48\u5b8c\u5168\u4f7f\u7528 haproxy \u547d\u4ee4\u624b\u52a8\u7ba1\u7406\u670d\u52a1\u7684\u542f\u52a8\u548c\u505c\u6b62\uff0c\u5426\u5219\u53ef\u80fd\u4f1a\u51fa\u73b0\u8bb0\u5f55\u4e0d\u540c\u6b65\u7684\u73b0\u8c61\u3002")),(0,s.kt)("h3",{id:"933\u5b8c\u6210\u914d\u7f6e"},"9.3.3\u3001\u5b8c\u6210\u914d\u7f6e"),(0,s.kt)("p",null,"\u5982\u4e0b\uff0c\u662f\u6bcf\u4e2a haproxy \u8282\u70b9\u7684\u914d\u7f6e\u6587\u4ef6\u5185\u5bb9\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"global\n    log         127.0.0.1 local2\n    chroot      /var/lib/haproxy\n    pidfile     /var/run/haproxy.pid\n    maxconn     20000\n    user        haproxy\n    group       haproxy\n    daemon\n    stats socket /var/run/haproxy.sock mode 600 level admin\n    spread-checks 2\n\n    peers mypeers \n        peer haproxy1 192.168.122.101:12138\n        peer haproxy2 192.168.122.106:12138\n        peer haproxy3 192.168.122.107:12138\ndefaults\n    mode                    http\n    log                     global\n    option                  httplog\n    option                  dontlognull\n    option http-server-close\n    option forwardfor       except 127.0.0.0/8\n    option                  redispatch\n    timeout http-request    2s\n    timeout queue           3s\n    timeout connect         1s\n    timeout client          10s\n    timeout server          2s\n    timeout http-keep-alive 10s\n    timeout check           2s\n    maxconn                 18000 \n\nfrontend http-in\n    bind             *:80\n    mode             http\n    log              global\n    default_backend  DynamicGroup\n\nbackend DynamicGroup\n    stick-table type string len 32 size 5k expire 5m peers mypeers\n    stick on req.cook(PHPSESSID)\n    stick store-response res.cook(PHPSESSID)\n    balance roundrobin\n    option http-server-close\n    option httpchk     GET /index.php\n    option redispatch\n    http-check expect  status 200\n    server appsrv1 192.168.122.102:80 check rise 1 maxconn 3000 \n    server appsrv2 192.168.122.103:80 check rise 1 maxconn 3000\n")),(0,s.kt)("p",null,"\u7136\u540e\u5206\u522b\u5728 3 \u4e2a\u8282\u70b9\u4e0a\u542f\u52a8 haproxy \u670d\u52a1\uff0c\u5206\u522b\u5728 haproxy1\u3001haproxy2\u3001haproxy3 \u4e0a\u76d1\u63a7 stick table\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"watch -n 1 'echo \"show table DynamicGroup\" | socat unix:/var/run/haproxy.sock -'\n")),(0,s.kt)("p",null,"\u7531\u4e8e\u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0cstick table \u4e2d\u5b58\u50a8\u548c\u5339\u914d\u7684\u8bb0\u5f55\u662f\u54cd\u5e94\u62a5\u6587\u4e2d\u540d\u4e3a PHPSESSID \u7684 cookie\uff0c\u56e0\u6b64\u5728\u6d4f\u89c8\u5668\u4e0a\u6d4b\u8bd5\u65f6\uff0c\u80fd\u5b9e\u73b0\u4f1a\u8bdd\u7c98\u6027\u3002"),(0,s.kt)("p",null,"\u4f46\u5982\u679c\u4f7f\u7528 curl \u547d\u4ee4\u8fdb\u884c\u6d4b\u8bd5\uff0c\u7531\u4e8e curl \u6bcf\u6b21\u6267\u884c\u7ed3\u675f\u8fdb\u7a0b\u5c31\u9000\u51fa\uff0c\u65e0\u6cd5\u7f13\u5b58 cookie\uff0c\u56e0\u6b64 curl \u7684\u6bcf\u6b21\u8bf7\u6c42\u90fd\u662f\u65b0\u8fde\u63a5\u3002\u6b64\u5904\u6b63\u597d\u5229\u7528 curl \u8fd9\u4e00\u70b9\u7279\u6027\uff0c\u6765\u751f\u6210\u591a\u4e2a stickiness \u8bb0\u5f55\uff0c\u65b9\u4fbf\u89c2\u5bdf stick table \u8bb0\u5f55\u63a8\u9001\u7684\u60c5\u51b5\u3002"),(0,s.kt)("p",null,"\u627e\u4e00\u53f0 Linux \u4e3b\u673a\uff0c\u5206\u522b\u5bf9\u4e09\u4e2a haproxy \u8282\u70b9\u8fdb\u884c 5 \u6b21 curl \u8bf7\u6c42\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"ip1=192.168.122.101\nip2=192.168.122.106\nip3=192.168.122.107\nfor i in $ip1 $ip2 $ip3;do\n    for j in `seq 1 5`;do \n        curl http://$i/index.php &>/dev/null\n        usleep 500000\n    done\ndone\n")),(0,s.kt)("p",null,"\u4ee5\u4e0b\u662f\u622a\u53d6\u81ea\u4e09\u4e2a\u8282\u70b9\u7684 stick table \u5185\u5bb9\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"###################### haproxy1 ########################\n# table: DynamicGroup, type: string, size:5120, used:15\n0xffff88042cc0: key=61m6cpr7qkkcrst2m0fq85vs93 use=0 exp=217803 server_id=1 server_key=appsrv1\n0xffff88042b60: key=672uvf5c9jb0ppb115b16glip5 use=0 exp=215246 server_id=1 server_key=appsrv1\n0xffff88041820: key=6tlnotjd9rb8b9ln96cjul6vj4 use=0 exp=219861 server_id=1 server_key=appsrv1\n0xffff84038e30: key=75t9mkmtfjcn6prv6vm7fq5bs1 use=0 exp=218317 server_id=2 server_key=appsrv2\n0xffff8803d430: key=77akt5tv541usblqp09qvhcjk3 use=0 exp=214219 server_id=2 server_key=appsrv2\n0xffff840388f0: key=9qo3ion9tubhd6hofv709vlrt7 use=0 exp=218833 server_id=1 server_key=appsrv1\n0xffff88042a00: key=a39v8ntdn5u7sd66jbjns0b1j3 use=0 exp=215757 server_id=2 server_key=appsrv2\n0xffff84038790: key=b5vl3bd68pr9ij2mha9329rg10 use=0 exp=216268 server_id=1 server_key=appsrv1\n0xffff88042290: key=bmnob21gp6oq87qb03vpl0pu35 use=0 exp=216780 server_id=2 server_key=appsrv2\n0xffff84037bc0: key=hhgj3ckk0jd6p6ivmkpqugv6p3 use=0 exp=213198 server_id=2 server_key=appsrv2\n0xffff880407a0: key=k8knr6k0d6u7rln4f2dg85vju4 use=0 exp=212686 server_id=1 server_key=appsrv1\n0xffff84038560: key=n4422bvflsqhdtlrhl6vkv9sa4 use=0 exp=219351 server_id=2 server_key=appsrv2\n0xffff84039b10: key=osstpulqkcm9t0cfb8i2albdk3 use=0 exp=214732 server_id=1 server_key=appsrv1\n0xffff84037c90: key=qn55ad64v6qm5jgvrq3mg6kd22 use=0 exp=213708 server_id=1 server_key=appsrv1\n0xffff880412a0: key=svimc7pe9abamhmvmccune7j91 use=0 exp=217291 server_id=1 server_key=appsrv1\n\n###################### haproxy2 ########################\n# table: DynamicGroup, type: string, size:5120, used:15\n0xffff80026c90: key=61m6cpr7qkkcrst2m0fq85vs93 use=0 exp=210178 server_id=1 server_key=appsrv1\n0x25b01040:     key=672uvf5c9jb0ppb115b16glip5 use=0 exp=207620 server_id=1 server_key=appsrv1\n0xffff7403d430: key=6tlnotjd9rb8b9ln96cjul6vj4 use=0 exp=212236 server_id=1 server_key=appsrv1\n0xffff7403eee0: key=75t9mkmtfjcn6prv6vm7fq5bs1 use=0 exp=210692 server_id=2 server_key=appsrv2\n0xffff7403d500: key=77akt5tv541usblqp09qvhcjk3 use=0 exp=206594 server_id=2 server_key=appsrv2\n0xffff7403e960: key=9qo3ion9tubhd6hofv709vlrt7 use=0 exp=211208 server_id=1 server_key=appsrv1\n0xffff94027150: key=a39v8ntdn5u7sd66jbjns0b1j3 use=0 exp=208132 server_id=2 server_key=appsrv2\n0xffff8c03c9f0: key=b5vl3bd68pr9ij2mha9329rg10 use=0 exp=208642 server_id=1 server_key=appsrv1\n0xffff84026910: key=bmnob21gp6oq87qb03vpl0pu35 use=0 exp=209155 server_id=2 server_key=appsrv2\n0xffff7403e610: key=hhgj3ckk0jd6p6ivmkpqugv6p3 use=0 exp=205573 server_id=2 server_key=appsrv2\n0xffff7403d780: key=k8knr6k0d6u7rln4f2dg85vju4 use=0 exp=205061 server_id=1 server_key=appsrv1\n0xffff7403e280: key=n4422bvflsqhdtlrhl6vkv9sa4 use=0 exp=211726 server_id=2 server_key=appsrv2\n0xffff7403cb60: key=osstpulqkcm9t0cfb8i2albdk3 use=0 exp=207108 server_id=1 server_key=appsrv1\n0xffff7403dfc0: key=qn55ad64v6qm5jgvrq3mg6kd22 use=0 exp=206083 server_id=1 server_key=appsrv1\n0xffff88026910: key=svimc7pe9abamhmvmccune7j91 use=0 exp=209665 server_id=1 server_key=appsrv1\n\n###################### haproxy3 ########################\n# table: DynamicGroup, type: string, size:5120, used:15\n0x3d5b1330:     key=61m6cpr7qkkcrst2m0fq85vs93 use=0 exp=207767 server_id=1 server_key=appsrv1\n0xffff94026c90: key=672uvf5c9jb0ppb115b16glip5 use=0 exp=205211 server_id=1 server_key=appsrv1\n0xffff8c026910: key=6tlnotjd9rb8b9ln96cjul6vj4 use=0 exp=209826 server_id=1 server_key=appsrv1\n0xffff94026910: key=75t9mkmtfjcn6prv6vm7fq5bs1 use=0 exp=208282 server_id=2 server_key=appsrv2\n0xffff94033630: key=77akt5tv541usblqp09qvhcjk3 use=0 exp=204185 server_id=2 server_key=appsrv2\n0xffff94026ac0: key=9qo3ion9tubhd6hofv709vlrt7 use=0 exp=208798 server_id=1 server_key=appsrv1\n0xffff7c027b50: key=a39v8ntdn5u7sd66jbjns0b1j3 use=0 exp=205722 server_id=2 server_key=appsrv2\n0xffff7c027d00: key=b5vl3bd68pr9ij2mha9329rg10 use=0 exp=206233 server_id=1 server_key=appsrv1\n0xffff7c027ed0: key=bmnob21gp6oq87qb03vpl0pu35 use=0 exp=206745 server_id=2 server_key=appsrv2\n0xffff94033eb0: key=hhgj3ckk0jd6p6ivmkpqugv6p3 use=0 exp=203163 server_id=2 server_key=appsrv2\n0xffff94034430: key=k8knr6k0d6u7rln4f2dg85vju4 use=0 exp=202651 server_id=1 server_key=appsrv1\n0xffff94035f90: key=n4422bvflsqhdtlrhl6vkv9sa4 use=0 exp=209316 server_id=2 server_key=appsrv2\n0xffff90033790: key=osstpulqkcm9t0cfb8i2albdk3 use=0 exp=204698 server_id=1 server_key=appsrv1\n0xffff94033de0: key=qn55ad64v6qm5jgvrq3mg6kd22 use=0 exp=203673 server_id=1 server_key=appsrv1\n0xffff7c038cb0: key=svimc7pe9abamhmvmccune7j91 use=0 exp=207256 server_id=1 server_key=appsrv1\n")),(0,s.kt)("p",null,"\u7ed3\u679c\u7b26\u5408\u9884\u671f\u76ee\u6807\uff0c\u6bcf\u4e2a\u8868\u90fd\u6709 15 \u6761 stickiness\uff0c\u4e14\u5b83\u4eec\u7684 key \u548c\u5bf9\u5e94\u7684 server","_","id \u5b8c\u5168\u76f8\u540c\u3002"))}h.isMDXComponent=!0},14947:function(e,t,n){t.Z=n.p+"assets/images/haproxy cookie detail-579e41144c2052be576b87944c353b15.png"},67098:function(e,t,n){t.Z=n.p+"assets/images/haproxy cookie detail1-85be4522f0d26ad561f8045175138eb2.png"},33441:function(e,t,n){t.Z=n.p+"assets/images/haproxy cookie detail2-5047103cd076812e03e9b447996f673c.png"},71837:function(e,t,n){t.Z=n.p+"assets/images/haproxy cookie detail3-1e5963743dff7636ccbe88cee9c0232b.png"},58847:function(e,t,n){t.Z=n.p+"assets/images/haproxy cookie detail4-eb420b7d867757d7d07c218d7955743c.png"},10197:function(e,t,n){t.Z=n.p+"assets/images/haproxy cookie detail5-b11ea9d3b56a8ef1115563fcefdc8a4f.png"},42694:function(e,t,n){t.Z=n.p+"assets/images/haproxy cookie detail6-dc1a3d6eaf56da1064c8b70a05e13c41.png"},86842:function(e,t,n){t.Z=n.p+"assets/images/haproxy cookie-0147a1acf2ccdddd8bc06db9dd24ffc4.png"},35626:function(e,t,n){t.Z=n.p+"assets/images/haproxy replication-e2384410fd04632ba5333432f9e58940.png"},84988:function(e,t,n){t.Z=n.p+"assets/images/haproxy samples-8a2512f0fe496d3a1de8f8f918f89e19.png"},88984:function(e,t,n){t.Z=n.p+"assets/images/haproxy stick-table detail-22003381776bdb008e3fbfcddfa69f30.png"},2813:function(e,t,n){t.Z=n.p+"assets/images/haproxy stick-table-cc93f996a228c114a718716919fd2134.png"}}]);