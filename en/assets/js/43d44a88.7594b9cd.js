"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[3473],{3905:function(e,n,t){t.d(n,{Zo:function(){return m},kt:function(){return g}});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function p(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var o=a.createContext({}),s=function(e){var n=a.useContext(o),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},m=function(e){var n=s(e.components);return a.createElement(o.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,o=e.parentName,m=p(e,["components","mdxType","originalType","parentName"]),u=s(t),g=r,d=u["".concat(o,".").concat(g)]||u[g]||c[g]||l;return t?a.createElement(d,i(i({ref:n},m),{},{components:t})):a.createElement(d,i({ref:n},m))}));function g(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,i=new Array(l);i[0]=u;var p={};for(var o in n)hasOwnProperty.call(n,o)&&(p[o]=n[o]);p.originalType=e,p.mdxType="string"==typeof e?e:r,i[1]=p;for(var s=2;s<l;s++)i[s]=t[s];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},22545:function(e,n,t){t.r(n),t.d(n,{assets:function(){return m},contentTitle:function(){return o},default:function(){return g},frontMatter:function(){return p},metadata:function(){return s},toc:function(){return c}});var a=t(83117),r=t(80102),l=(t(67294),t(3905)),i=["components"],p={id:"linux-advanced-9",slug:"/linux-advanced-9",title:"\u7b2c 9 \u7ae0 Linux Nginx \u670d\u52a1\u914d\u7f6e",authors:"zhangqf",keywords:["linux","nginx"]},o=void 0,s={unversionedId:"linux/advanced/linux-advanced-9",id:"linux/advanced/linux-advanced-9",title:"\u7b2c 9 \u7ae0 Linux Nginx \u670d\u52a1\u914d\u7f6e",description:"7.1\u3001nginx \u7b80\u4ecb",source:"@site/docs/linux/advanced/\u7b2c 9 \u7ae0 Linux Nginx \u670d\u52a1\u914d\u7f6e.md",sourceDirName:"linux/advanced",slug:"/linux-advanced-9",permalink:"/en/docs/linux-advanced-9",draft:!1,tags:[],version:"current",frontMatter:{id:"linux-advanced-9",slug:"/linux-advanced-9",title:"\u7b2c 9 \u7ae0 Linux Nginx \u670d\u52a1\u914d\u7f6e",authors:"zhangqf",keywords:["linux","nginx"]},sidebar:"linux",previous:{title:"\u7b2c 8 \u7ae0 Linux httpd \u670d\u52a1\u9ad8\u7ea7\u914d\u7f6e",permalink:"/en/docs/linux-advanced-8"},next:{title:"\u7b2c 10 \u7ae0 Linux Tomcat \u670d\u52a1\u57fa\u7840\u914d\u7f6e",permalink:"/en/docs/linux-advanced-10"}},m={},c=[{value:"7.1\u3001nginx \u7b80\u4ecb",id:"71nginx-\u7b80\u4ecb",level:2},{value:"7.2\u3001nginx \u5904\u7406\u8bf7\u6c42\u7684\u8fc7\u7a0b",id:"72nginx-\u5904\u7406\u8bf7\u6c42\u7684\u8fc7\u7a0b",level:2},{value:"7.3\u3001nginx \u547d\u4ee4",id:"73nginx-\u547d\u4ee4",level:2},{value:"7.4\u3001nginx \u6a21\u5757\u53ca http \u529f\u80fd\u901f\u89c8",id:"74nginx-\u6a21\u5757\u53ca-http-\u529f\u80fd\u901f\u89c8",level:2},{value:"7.5\u3001nginx \u914d\u7f6e\u6587\u4ef6\u7b80\u5355\u8bf4\u660e",id:"75nginx-\u914d\u7f6e\u6587\u4ef6\u7b80\u5355\u8bf4\u660e",level:2},{value:"7.5.1\u3001main \u548c events \u6bb5",id:"751main-\u548c-events-\u6bb5",level:3},{value:"7.5.2\u3001http \u6bb5",id:"752http-\u6bb5",level:3},{value:"7.5.2.1\u3001\u914d\u7f6e\u6587\u4ef6\u6982\u89c8",id:"7521\u914d\u7f6e\u6587\u4ef6\u6982\u89c8",level:4},{value:"7.5.2.2\u3001root \u6307\u4ee4\u548c alias \u6307\u4ee4",id:"7522root-\u6307\u4ee4\u548c-alias-\u6307\u4ee4",level:4},{value:"7.5.2.3\u3001location \u5bb9\u5668",id:"7523location-\u5bb9\u5668",level:4},{value:"7.5.2.4\u3001error_page \u6307\u4ee4",id:"7524error_page-\u6307\u4ee4",level:4},{value:"7.5.2.5\u3001allow \u548c deny",id:"7525allow-\u548c-deny",level:4},{value:"7.5.2.6\u3001add_header \u6dfb\u52a0\u76f8\u5e94\u9996\u90e8\u5b57\u6bb5",id:"7526add_header-\u6dfb\u52a0\u76f8\u5e94\u9996\u90e8\u5b57\u6bb5",level:4},{value:"7.5.3\u3001\u865a\u62df\u4e3b\u673a\u548c server_name \u6307\u4ee4",id:"753\u865a\u62df\u4e3b\u673a\u548c-server_name-\u6307\u4ee4",level:3},{value:"7.5.4\u3001\u865a\u62df\u4e3b\u673a\u7684\u5339\u914d\u89c4\u5219",id:"754\u865a\u62df\u4e3b\u673a\u7684\u5339\u914d\u89c4\u5219",level:3},{value:"7.5.5\u3001stub_status \u6307\u4ee4\u83b7\u53d6 nginx \u72b6\u6001\u4fe1\u606f",id:"755stub_status-\u6307\u4ee4\u83b7\u53d6-nginx-\u72b6\u6001\u4fe1\u606f",level:3},{value:"7.6\u3001\u8bbf\u95ee\u65e5\u5fd7 access_log",id:"76\u8bbf\u95ee\u65e5\u5fd7-access_log",level:2},{value:"7.6.1\u3001log_format \u6307\u4ee4",id:"761log_format-\u6307\u4ee4",level:3},{value:"7.6.2\u3001access_log \u6307\u4ee4",id:"762access_log-\u6307\u4ee4",level:3},{value:"7.6.3\u3001\u65e5\u5fd7\u6587\u4ef6\u7684\u5206\u5272",id:"763\u65e5\u5fd7\u6587\u4ef6\u7684\u5206\u5272",level:3},{value:"7.7\u3001\u914d\u7f6e web \u8eab\u4efd\u8ba4\u8bc1",id:"77\u914d\u7f6e-web-\u8eab\u4efd\u8ba4\u8bc1",level:2},{value:"7.8\u3001\u914d\u7f6e https",id:"78\u914d\u7f6e-https",level:2},{value:"7.9\u3001nginx \u7248\u672c\u5e73\u7a33\u5207\u6362",id:"79nginx-\u7248\u672c\u5e73\u7a33\u5207\u6362",level:2},{value:"7.9.1\u3001\u5347\u7ea7",id:"791\u5347\u7ea7",level:3},{value:"7.9.2\u3001\u964d\u7ea7",id:"792\u964d\u7ea7",level:3},{value:"7.9.3\u3001\u4e00\u952e\u5347\u7ea7\u811a\u672c",id:"793\u4e00\u952e\u5347\u7ea7\u811a\u672c",level:3},{value:"7.10\u3001\u642d\u5efa LNMP \u73af\u5883",id:"710\u642d\u5efa-lnmp-\u73af\u5883",level:2},{value:"7.10.1\u3001\u7f16\u8bd1 nginx",id:"7101\u7f16\u8bd1-nginx",level:3},{value:"7.10.2\u3001\u7f16\u8bd1 PHP",id:"7102\u7f16\u8bd1-php",level:3},{value:"7.10.3\u3001\u914d\u7f6e nginx \u548c php-fpm \u4ea4\u4e92(tcp socket)",id:"7103\u914d\u7f6e-nginx-\u548c-php-fpm-\u4ea4\u4e92tcp-socket",level:3},{value:"7.10.4\u3001\u914d\u7f6e nginx \u548c php-fpm \u4ea4\u4e92(unix socket)",id:"7104\u914d\u7f6e-nginx-\u548c-php-fpm-\u4ea4\u4e92unix-socket",level:3},{value:"7.11\u3001nginx \u53cd\u5411\u4ee3\u7406",id:"711nginx-\u53cd\u5411\u4ee3\u7406",level:2},{value:"7.11.1\u3001\u6b63\u53cd\u4ee3\u7406\u6982\u5ff5",id:"7111\u6b63\u53cd\u4ee3\u7406\u6982\u5ff5",level:3},{value:"7.11.2\u3001\u53cd\u5411\u4ee3\u7406\u57fa\u7840\u5b9e\u9a8c",id:"7112\u53cd\u5411\u4ee3\u7406\u57fa\u7840\u5b9e\u9a8c",level:3},{value:"7.11.3\u3001\u53cd\u5411\u4ee3\u7406 upstream \u6a21\u5757\u5206\u7ec4",id:"7113\u53cd\u5411\u4ee3\u7406-upstream-\u6a21\u5757\u5206\u7ec4",level:3},{value:"7.11.4\u3001ngx_http_proxy_module \u6a21\u5757",id:"7114ngx_http_proxy_module-\u6a21\u5757",level:3},{value:"7.11.4.1\u3001\u6307\u4ee4\u53ca\u5176\u610f\u4e49",id:"71141\u6307\u4ee4\u53ca\u5176\u610f\u4e49",level:4},{value:"7.11.4.2\u3001proxy_pass",id:"71142proxy_pass",level:4},{value:"7.11.4.3\u3001proxy_set_header",id:"71143proxy_set_header",level:4},{value:"7.11.5\u3001ngx_http_upstream_module \u6a21\u5757",id:"7115ngx_http_upstream_module-\u6a21\u5757",level:3},{value:"7.11.6\u3001\u53cd\u5411\u4ee3\u7406\u591a\u79cd\u7c7b\u578b",id:"7116\u53cd\u5411\u4ee3\u7406\u591a\u79cd\u7c7b\u578b",level:3},{value:"7.11.7\u3001nginx \u4ee3\u7406 memcached",id:"7117nginx-\u4ee3\u7406-memcached",level:3},{value:"7.12\u3001nginx \u7f13\u5b58\u529f\u80fd",id:"712nginx-\u7f13\u5b58\u529f\u80fd",level:2},{value:"7.13\u3001nginx URL \u91cd\u5199",id:"713nginx-url-\u91cd\u5199",level:2},{value:"7.13.1\u3001\u7b80\u4ecb",id:"7131\u7b80\u4ecb",level:3},{value:"7.13.2\u3001if \u6307\u4ee4",id:"7132if-\u6307\u4ee4",level:3},{value:"7.13.3\u3001rewrite \u6307\u4ee4",id:"7133rewrite-\u6307\u4ee4",level:3},{value:"7.13.4\u3001URL \u91cd\u5199\u548c\u53cd\u5411\u4ee3\u7406\u7684\u533a\u522b",id:"7134url-\u91cd\u5199\u548c\u53cd\u5411\u4ee3\u7406\u7684\u533a\u522b",level:3}],u={toc:c};function g(e){var n=e.components,p=(0,r.Z)(e,i);return(0,l.kt)("wrapper",(0,a.Z)({},u,p,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h2",{id:"71nginx-\u7b80\u4ecb"},"7.1\u3001nginx \u7b80\u4ecb"),(0,l.kt)("p",null,"nginx \u662f\u4e00\u4e2a\u4f18\u79c0\u7684 web \u670d\u52a1\u7a0b\u5e8f\u3001\u53cd\u5411\u4ee3\u7406\u7a0b\u5e8f\u3002\u5b83\u91c7\u7528\u975e\u963b\u585e\u5f02\u6b65\u7684\u5957\u63a5\u5b57\uff0c\u4f7f\u7528 epoll \u65b9\u5f0f\u5b9e\u73b0\u4e8b\u4ef6\u9a71\u52a8\uff0c\u540c\u65f6\u91c7\u7528",(0,l.kt)("strong",{parentName:"p"},"\u4e00\u4e2a master+N \u4e2a worker \u8fdb\u7a0b"),"(\u9ed8\u8ba4)\u7684\u65b9\u5f0f\u5904\u7406\u8bf7\u6c42\uff0c\u8fd9\u79cd\u67b6\u6784\u4f7f\u5f97\u5b83\u5728\u5e76\u53d1\u7684\u5904\u7406\u80fd\u529b\u4e0a\u6781\u5176\u51fa\u8272\uff0c\u53ef\u4ee5\u6bd4\u8f83\u8f7b\u677e\u5730\u89e3\u51b3 C10K \u95ee\u9898\u3002"),(0,l.kt)("h2",{id:"72nginx-\u5904\u7406\u8bf7\u6c42\u7684\u8fc7\u7a0b"},"7.2\u3001nginx \u5904\u7406\u8bf7\u6c42\u7684\u8fc7\u7a0b"),(0,l.kt)("p",null,"master \u8fdb\u7a0b\u7528\u4e8e\u7ba1\u7406 worker \u8fdb\u7a0b\uff0c\u4f8b\u5982\u63a5\u6536\u5916\u754c\u4fe1\u53f7\u3001\u5411 worker \u8fdb\u7a0b\u53d1\u9001\u4fe1\u53f7\u3001\u9500\u6bc1 worker \u8fdb\u7a0b\u3001\u542f\u52a8 worker \u8fdb\u7a0b\u7b49\u7b49\u3002"),(0,l.kt)("p",null,"nginx \u4e4b\u6240\u4ee5\u6027\u80fd\u826f\u597d\uff0c\u5b8c\u5168\u662f\u7531\u5b83\u7684\u67b6\u6784\u51b3\u5b9a\u7684\u3002\u6bcf\u4e2a worker \u8fdb\u7a0b\u662f\u4e1a\u52a1\u5904\u7406\u8fdb\u7a0b\uff0c\u8d1f\u8d23\u76d1\u542c\u5957\u63a5\u5b57\u3001\u5904\u7406\u8bf7\u6c42\u3001\u54cd\u5e94\u8bf7\u6c42\u3001\u4ee3\u7406\u8bf7\u6c42\u81f3\u540e\u7aef\u670d\u52a1\u5668\u7b49\u3002"),(0,l.kt)("p",null,"\u4f5c\u4e3a web server \u5904\u7406\u9759\u6001\u8d44\u6e90\u65f6\u6bcf\u4e2a worker \u8fdb\u7a0b\u7684\u5927\u81f4\u6d41\u7a0b\uff1a"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u76d1\u542c\u5957\u63a5\u5b57\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u4e0e\u5ba2\u6237\u7aef\u5efa\u7acb\u8fde\u63a5\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u5904\u7406\u76d1\u542c\u5230\u7684\u8fde\u63a5\u8bf7\u6c42(\u52a0\u8f7d\u9759\u6001\u6587\u4ef6)\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u54cd\u5e94\u6570\u636e\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u65ad\u5f00\u8fde\u63a5\u3002")),(0,l.kt)("p",null,"\u8fd9\u51e0\u4e2a\u8fc7\u7a0b\u662f\u6bcf\u4e2a web server \u90fd\u5177\u5907\u7684\u80fd\u529b\uff0c\u4f46\u5bf9\u4e8e nginx \u6765\u8bf4\uff0c\u7531\u4e8e\u5b83\u7684\u5f02\u6b65\u975e\u963b\u585e\uff0c\u6bcf\u4e2a\u8fc7\u7a0b\u90fd\u4e0d\u4f1a\u963b\u585e(\u6709\u4e9b\u5c0f\u8fc7\u7a0b\u5fc5\u987b\u963b\u585e\u7684\u65f6\u5019\u8fd8\u662f\u4f1a\u963b\u585e)\uff0c\u4f7f\u5f97\u5e76\u53d1\u5904\u7406\u80fd\u529b\u5f88\u597d\u3002"),(0,l.kt)("p",null,"\u4ece\u76d1\u542c\u5957\u63a5\u5b57\u5f00\u59cb\u6df1\u5165\u4e00\u70b9\u7406\u89e3\uff1a"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},'\u6bcf\u4e2a worker \u8fdb\u7a0b\u90fd\u662f\u5e73\u7b49\u7684\uff0c\u5b83\u4eec\u90fd\u53ef\u4ee5\u53bb\u76d1\u542c\u5957\u63a5\u5b57\uff0c\u6b63\u5e38\u60c5\u51b5\u4e0b\u4e0d\u53ef\u907f\u514d\u5730\u4f1a\u9020\u6210\u4e89\u62a2\u548c\u89e6\u53d1 "\u60ca\u7fa4\u6548\u5e94"\uff0c\u800c nginx \u91c7\u7528 "\u4e89\u62a2" accept \u4e92\u65a5\u9501\u7684\u65b9\u5f0f\uff0c\u53ea\u6709\u6301\u6709 accept \u4e92\u65a5\u9501\u7684 worker \u8fdb\u7a0b\u624d\u6709\u8d44\u683c\u5c06\u8fde\u63a5\u8bf7\u6c42\u63a5\u5230\u81ea\u5df1\u7684\u961f\u5217\u4e2d\u5e76\u5b8c\u6210 TCP \u8fde\u63a5\u7684\u5efa\u7acb\u3002',(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},'\u4f46\u6bcf\u4e2a\u8fdb\u7a0b\u662f\u76f8\u4e92\u72ec\u7acb\u800c\u5e73\u7b49\u7684\uff0c\u8c01\u6709\u8d44\u683c\u53bb "\u4e89\u62a2" \u4e92\u65a5\u9501\u4e14\u6709\u66f4\u5927\u51e0\u7387\u4e89\u62a2\u6210\u529f\uff1f',(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u53ea\u8981 worker \u8fdb\u7a0b\u5f53\u524d\u5efa\u7acb\u7684\u8fde\u63a5\u6570\u5c0f\u4e8e worker","_","connections \u6307\u4ee4\u6307\u5b9a\u7684\u503c(\u5b9e\u9645\u4e0a\u6e90\u7801\u4e2d\u8bbe\u7f6e\u7684\u662f\u8be5\u503c\u7684 7/8)\uff0c\u5c31\u5141\u8bb8\u4e89\u62a2\u4e92\u65a5\u9501\uff0c\u56e0\u4e3a\u8fde\u63a5\u6570\u8d85\u8fc7\u4e86\u8be5\u503c\u7684 7/8 \u8868\u793a\u5df2\u7ecf\u975e\u5e38\u7e41\u5fd9\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u9664\u4e86\u7e41\u5fd9\u7a0b\u5ea6\u9650\u5236\u8d44\u683c\uff0c\u8fd8\u6709 epoll","_","wait \u7684 timeout \u7684\u6307\u6807\uff0c\u7b49\u5f85\u8d8a\u4e45\u7684 worker \u8fdb\u7a0b\u4e89\u62a2\u80fd\u529b\u8d8a\u5f3a\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"\u603b\u4e4b\uff0c\u5728\u67d0\u4e00\u65f6\u523b\uff0c\u4e00\u5b9a\u53ea\u6709\u4e00\u4e2a worker \u8fdb\u7a0b\u76d1\u542c\u5e76 accept \u65b0\u7684\u8fde\u63a5\u8bf7\u6c42"),"\u3002"))),(0,l.kt)("li",{parentName:"ol"},"\u5f53\u5df2\u7ecf\u76d1\u542c\u5230\u8fde\u63a5\u8bf7\u6c42\u65f6\uff0cworker \u8fdb\u7a0b\u4e0e\u5b83\u8fdb\u884c\u4e09\u6b21\u63e1\u624b\uff0c\u5e76\u6700\u7ec8 accpet \u5230\u81ea\u5df1\u7684\u5185\u5b58\u6c60\u4e2d\uff0c\u5e76\u548c\u5ba2\u6237\u7aef\u4ea4\u4e92\u6570\u636e\uff0c\u5904\u7406\u5ba2\u6237\u7aef\u53d1\u9001\u7684 http \u8bf7\u6c42\u5e76\u54cd\u5e94\u6570\u636e\u7ed9\u5ba2\u6237\u7aef\u3002",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u4f46\u662f\uff0cnginx \u7684\u9ad8\u6548\u5c31\u5728\u4e8e\u5b83\u7684\u5f02\u6b65\u975e\u963b\u585e\uff0c\u65e0\u8bba\u662f\u5728 TCP \u8fde\u63a5\u8fdb\u5165 ESTABLISHED \u4e4b\u524d\uff0c\u8fd8\u662f\u7b49\u5f85\u5ba2\u6237\u7aef\u53d1\u9001\u8bf7\u6c42\uff0c\u4ea6\u6216\u8005\u662f\u7b49\u5f85\u52a0\u8f7d\u672c\u5730\u9759\u6001\u8d44\u6e90\u7684 I/O\uff0c\u4ee5\u53ca\u54cd\u5e94\u6570\u636e\u7ed9\u5ba2\u6237\u7aef\u7684\u4efb\u610f\u4e00\u4e2a\u8fc7\u7a0b\u4e2d\uff0cnginx \u90fd\u662f\u975e\u963b\u585e\u7684\uff0c\u5728\u4efb\u610f\u7b49\u5f85\u53d1\u751f\u65f6\u90fd\u53ef\u4ee5\u53bb\u5904\u7406\u5176\u5b83\u4e8b\u60c5\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u5f53\u7b49\u5f85\u7684\u67d0\u4e2a\u8d44\u6e90\u5df2\u7ecf\u51c6\u5907\u6210\u529f\u65f6\u5c06\u4ea7\u751f\u4e8b\u4ef6\u901a\u77e5 worker \u8fdb\u7a0b\uff0cworker \u8fdb\u7a0b\u53ef\u968f\u540e\u53bb\u5904\u7406\u3002",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u5728\u6b64\u8fc7\u7a0b\u4e2d\uff0c\u7531\u4e8e worker \u8fdb\u7a0b\u7ed1\u5b9a\u5728\u4e00\u4e2a CPU \u6838\u5fc3\u4e0a(\u63a8\u8350\u5982\u6b64\u505a)\uff0c\u6240\u6709\u7684\u8fde\u63a5\u90fd\u653e\u5728\u5185\u5b58\u6c60\u4e2d\uff0c\u8fd9\u4f7f\u5f97\u4e0a\u4e0b\u6587\u5207\u6362\u65f6\u662f\u6781\u5176\u8f7b\u91cf\u7684\uff0c\u6781\u5927\u5730\u51cf\u8f7b\u4e86 CPU \u6d88\u8017\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u4ece\u7406\u8bba\u4e0a\u6765\u8bf4\uff0c\u5f53\u6bcf\u4e2a worker \u7ed1\u5b9a\u4e86\u4e00\u4e2a CPU \u6838\u5fc3\u65f6\uff0c\u5b83\u7684\u5e76\u53d1\u5904\u7406\u80fd\u529b\u4e3b\u8981\u4f9d\u8d56\u4e8e\u5185\u5b58\u7684\u5927\u5c0f\u3002")))))),(0,l.kt)("p",null,"\u5b9e\u9645\u4e0a apache httpd \u7684 event MPM \u4e5f\u662f\u5f02\u6b65\u975e\u963b\u585e\u7684\uff0c\u4e5f\u53ef\u4ee5\u91c7\u7528 epoll\uff0c\u4f46\u5b83\u91c7\u7528\u7684\u662f\u591a\u7ebf\u7a0b\u65b9\u5f0f\uff0c\u867d\u7136\u5f02\u6b65\uff0c\u4f46\u5b83\u7684\u5f02\u6b65\u4f3c\u4e4e\u4e0d\u4f53\u73b0\u5728\u5e76\u53d1\u80fd\u529b\u4e0a\uff0c\u800c\u4ec5\u4ec5\u53ea\u662f\u4e00\u4e9b\u5177\u6709\u7279\u6b8a\u72b6\u6001\u7684\u8fde\u63a5(\u5982\u957f\u8fde\u63a5)\u7684\u5f02\u6b65\u5904\u7406\uff0c\u5728\u5904\u7406\u8fc7\u7a0b\u4e2d cpu \u8fd8\u662f\u4e0d\u65ad\u5730\u9700\u8981\u5728\u5404\u7ebf\u7a0b\u4e4b\u95f4\u5927\u91cf\u5207\u6362\uff0c\u5e76\u53d1\u80fd\u529b\u5e76\u4e0d\u6bd4 worker MPM \u5f3a\u591a\u5c11\uff0c\u76f8\u6bd4 nginx \u66f4\u662f\u8fdc\u8fdc\u4e0d\u5982\u3002"),(0,l.kt)("h2",{id:"73nginx-\u547d\u4ee4"},"7.3\u3001nginx \u547d\u4ee4"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# nginx -h\nnginx version: nginx/1.12.1\nUsage: nginx [-?hvVtTq] [-s signal] [-c filename] [-p prefix] [-g directives]\n\nOptions:\n  -?,-h         : \u5e2e\u52a9\n  -v            : \u8f93\u51fa\u7248\u672c\u53f7\n  -V            : \u8f93\u51fa\u7248\u672c\u53f7\u4ee5\u53ca\u7f16\u8bd1\u9009\u9879\n  -t            : \u68c0\u67e5\u914d\u7f6e\u6587\u4ef6\u7684\u8bed\u6cd5\n  -T            : \u68c0\u67e5\u914d\u7f6e\u6587\u4ef6\u7684\u8bed\u6cd5\u5e76\u8f93\u51fa\u914d\u7f6e\u7684\u5185\u5bb9\n  -q            : \u914d\u7f6e\u6d4b\u8bd5\u9636\u6bb5\u4e0d\u8f93\u51fa\u975e\u9519\u8bef\u4fe1\u606f\uff0c\u9759\u9ed8\u6a21\u5f0f\n  -s signal     : \u5411\u4e3b\u8fdb\u7a0b\u53d1\u9001\u4fe1\u53f7\uff1astop, quit, reopen, reload\n  -p prefix     : \u8bbe\u7f6enginx\u7684basedir(\u9ed8\u8ba4\u4e3a\u7f16\u8bd1\u65f6\u7684prefix)\n  -c filename   : \u6307\u5b9a\u914d\u7f6e\u6587\u4ef6\n  -g directives : \u63d0\u524d\u8bbe\u7f6e\u5168\u5c40\u6307\u4ee4\n\n[root@aarch64 ~]#\n")),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"-V")," \u9009\u9879\u8f93\u51fa\u7f16\u8bd1\u9009\u9879\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# nginx -V\nnginx version: nginx/1.12.1\nbuilt by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC) \nbuilt with OpenSSL 1.0.2k-fips  26 Jan 2017\nTLS SNI support enabled\nconfigure arguments: --user=nginx --group=nginx --prefix=/usr/local/nginx-1.12.1 --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx/nginx.pid --lock-path=/var/lock/subsys/nginx --with-http_ssl_module --with-http_flv_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-threads\n[root@aarch64 ~]#\n")),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"\u4f7f\u7528\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u76f4\u63a5\u542f\u52a8 nginx \u548c\u6307\u5b9a\u914d\u7f6e\u6587\u4ef6\u542f\u52a8 nginx\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# nginx -c /usr/local/nginx/conf/nginx.conf\n[root@aarch64 ~]# lsof -i :80\nCOMMAND  PID  USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\nnginx   4928  root    6u  IPv4  32087      0t0  TCP *:http (LISTEN)\nnginx   4929 nginx    6u  IPv4  32087      0t0  TCP *:http (LISTEN)\n[root@aarch64 ~]#\n"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"\u8fd0\u884c\u65f6\u91cd\u8f7d\u914d\u7f6e\u6587\u4ef6\u3002\u5f53 nginx \u4e3b\u8fdb\u7a0b\u63a5\u6536\u5230\u91cd\u8f7d\u914d\u7f6e\u6587\u4ef6\u7684\u547d\u4ee4\u540e\uff0c\u5b83\u4f1a\u5148\u68c0\u67e5\u65b0\u914d\u7f6e\u6587\u4ef6\u8bed\u6cd5\uff0c\u7136\u540e\u8f7d\u5165\u8be5\u914d\u7f6e\u6587\u4ef6\u5230\u5185\u5b58\u4e2d\u5e76\u89e3\u6790\u3002\u7136\u540e\uff0c\u4e3b\u8fdb\u7a0b fork \u4e00\u7cfb\u5217\u65b0\u7684 worker \u8fdb\u7a0b\uff0c\u5e76\u53d1\u9001 QUIT \u4fe1\u53f7\u7ed9\u65e7\u7684 worker \u8fdb\u7a0b(graceful stop)\u3002\u65e7\u7684\u5de5\u4f5c\u8fdb\u7a0b\u63a5\u6536\u5230 QUIT \u4fe1\u53f7\u540e\uff0c\u4f1a\u505c\u6b62\u63a5\u53d7\u65b0\u7684\u8fde\u63a5\u8bf7\u6c42\uff0c\u5e76\u7ee7\u7eed\u5904\u7406\u65e7\u7684\u8fde\u63a5\u76f4\u5230\u8bf7\u6c42\u5904\u7406\u5b8c\u6210\u540e\u624d\u9000\u51fa\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# nginx -s reload\n"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"\u8fd0\u884c\u65f6\u5feb\u901f\u5173\u95ed nginx\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# nginx -s stop\n[root@aarch64 ~]# lsof -i :80\n[root@aarch64 ~]#\n"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"\u8fd0\u884c\u65f6\u4f18\u96c5\u5173\u95ed nginx\u3002\u6240\u6709\u7684\u5de5\u4f5c\u8fdb\u7a0b\u4f1a\u505c\u6b62\u63a5\u53d7\u65b0\u7684\u8fde\u63a5\uff0c\u5e76\u7ee7\u7eed\u670d\u52a1\u65e7\u7684\u8fde\u63a5\u8bf7\u6c42\u76f4\u5230\u6240\u6709\u7684\u8bf7\u6c42\u5b8c\u6210\u540e\u624d\u9000\u51fa\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# nginx -s quit\n"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"\u8fd0\u884c\u65f6\u91cd\u65b0\u6253\u5f00\u65e5\u5fd7\u6587\u4ef6\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# nginx -s reopen\n")))),(0,l.kt)("h2",{id:"74nginx-\u6a21\u5757\u53ca-http-\u529f\u80fd\u901f\u89c8"},"7.4\u3001nginx \u6a21\u5757\u53ca http \u529f\u80fd\u901f\u89c8"),(0,l.kt)("p",null,"Nginx \u7684\u4ee3\u7801\u7531\u4e00\u4e2a\u6838\u5fc3\u548c\u4e00\u7cfb\u5217\u7684\u6a21\u5757\u7ec4\u6210\u3002"),(0,l.kt)("p",null,"\u6838\u5fc3(core functionality)\u4e3b\u8981\u7528\u4e8e\u63d0\u4f9b\u5168\u5c40\u5e94\u7528\u7684\u57fa\u672c\u529f\u80fd\uff0c\u521b\u5efa\u5fc5\u8981\u7684\u8fd0\u884c\u65f6\u73af\u5883\u53ca\u786e\u4fdd\u4e0d\u540c\u6a21\u5757\u4e4b\u95f4\u5e73\u6ed1\u5730\u8fdb\u884c\u4ea4\u4e92\u7b49\uff0c\u5bf9\u5e94\u4e8e\u914d\u7f6e\u6587\u4ef6\u7684 main \u6bb5\u548c event \u6bb5\u3002\u6838\u5fc3\u6d89\u53ca\u7684\u6307\u4ee4\u5b98\u65b9\u6587\u6863\uff1a",(0,l.kt)("a",{parentName:"p",href:"http://nginx.org/en/docs/ngx_core_module.html"},"http://nginx.org/en/docs/ngx","_","core","_","module.html"),"\u3002"),(0,l.kt)("p",null,"\u8fd8\u6709\u5f88\u591a\u529f\u80fd\u90fd\u901a\u8fc7\u6a21\u5757\u5b9e\u73b0\uff0cnginx \u662f\u9ad8\u5ea6\u6a21\u5757\u5316\u7a0b\u5e8f\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"web \u76f8\u5173\u7684\u529f\u80fd\u6a21\u5757\u6709 ",(0,l.kt)("inlineCode",{parentName:"li"},'"ngx_http_*_module"')),(0,l.kt)("li",{parentName:"ul"},"mail \u76f8\u5173\u7684\u529f\u80fd\u6a21\u5757\u6709 ",(0,l.kt)("inlineCode",{parentName:"li"},'"ngx_mail_*_module"')),(0,l.kt)("li",{parentName:"ul"},"tcp \u4ee3\u7406\u3001\u8d1f\u8f7d\u5747\u8861\u76f8\u5173\u7684\u529f\u80fd\u6a21\u5757\u6709 ",(0,l.kt)("inlineCode",{parentName:"li"},'"ngx_stream_*_module"')),(0,l.kt)("li",{parentName:"ul"},"\u8fd9\u4e9b\u7c7b\u522b\u7684\u6a21\u5757\u4e2d\u53c8\u5206\u4e3a\u5f88\u591a\u7c7b\u522b\u7684\u6a21\u5757\uff0c\u5982 http \u7c7b\u522b\u7684\u6a21\u5757\u4e2d\u6709\u57fa\u672c\u6838\u5fc3\u6a21\u5757\u3001\u4e8b\u4ef6\u7c7b\u6a21\u5757\u3001\u7f13\u5b58\u7c7b\u6a21\u5757\u3001SSL \u76f8\u5173\u6a21\u5757\u3001\u8d1f\u8f7d\u5747\u8861\u7c7b\u6a21\u5757 upstream \u7b49\u7b49\u3002")),(0,l.kt)("p",null,"\u4ee5\u4e0b\u662f http \u529f\u80fd\u6a21\u5757\u7c7b\u4e2d\u5e38\u89c1\u7684\u6a21\u5757\uff1a"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"http \u7c7b\u6a21\u5757\u540d"),(0,l.kt)("th",{parentName:"tr",align:null},"\u6a21\u5757\u529f\u80fd\u8bf4\u660e"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","core","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},"http \u6838\u5fc3\u6a21\u5757\uff0c\u5bf9\u5e94\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684 http \u6bb5\uff0c\u5305\u542b\u5f88\u591a\u6307\u4ee4\uff0c\u5982 location \u6307\u4ee4")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","access","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},"\u8bbf\u95ee\u63a7\u5236\u6a21\u5757\uff0c\u63a7\u5236\u7f51\u7ad9\u7528\u6237\u5bf9 nginx \u7684\u8bbf\u95ee\uff0c\u5bf9\u5e94\u4e8e\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684 allow \u548c deny \u7b49\u6307\u4ee4")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","auth","_","basic","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},"\u901a\u8fc7\u7528\u6237\u540d\u548c\u5bc6\u7801\u8ba4\u8bc1\u7684\u8bbf\u95ee\u63a7\u5236\uff0c\u5982\u8bbf\u95ee\u7ad9\u70b9\u65f6\u9700\u8981\u6570\u636e\u7528\u6237\u540d\u548c\u5bc6\u7801\uff0c\u6307\u4ee4\u5305\u62ec auth","_","basic \u548c auth","_","basic","_","user","_","file")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","charset","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},"\u8bbe\u7f6e\u7f51\u9875\u663e\u793a\u5b57\u7b26\u96c6\u3002\u6307\u4ee4\u4e4b\u4e00\u4e3a charset\uff0c\u5982 charset utf-8")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","fastcgi","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},"fastcgi \u6a21\u5757\uff0c\u548c\u52a8\u6001\u5e94\u7528\u76f8\u5173\u3002\u8be5\u6a21\u5757\u4e0b\u6709\u975e\u5e38\u591a\u7684\u5b50\u6a21\u5757\u3002")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","flv","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},"\u652f\u6301 flv \u89c6\u9891\u6d41\u7684\u6a21\u5757\uff0c\u5982\u8fb9\u4e0b\u8fb9\u64ad")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","mp4","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},"\u540c flv \u6a21\u5757")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","gzip","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},"\u538b\u7f29\u6a21\u5757\uff0c\u7528\u6765\u538b\u7f29 nginx \u8fd4\u56de\u7684\u54cd\u5e94\u62a5\u6587\u3002\u4e00\u822c\u53ea\u538b\u7f29\u7eaf\u6587\u672c\u5185\u5bb9\uff0c\u56e0\u4e3a\u538b\u7f29\u6bd4\u4f8b\u975e\u5e38\u5927\uff0c\u800c\u56fe\u7247\u7b49\u4e0d\u4f1a\u53bb\u538b\u7f29")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","image","_","filter","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},"\u548c\u56fe\u7247\u88c1\u526a\u3001\u7f29\u7565\u56fe\u76f8\u5173\u6a21\u5757\uff0c\u9700\u8981\u5b89\u88c5 gd-devel \u624d\u80fd\u7f16\u8bd1\u8be5\u6a21\u5757")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","index","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},'\u5b9a\u4e49\u5c06\u8981\u88ab\u4f5c\u4e3a\u9ed8\u8ba4\u4e3b\u9875\u7684\u6587\u4ef6\uff0c\u5bf9\u5e94\u6307\u4ee4\u4e3a index\u3002"index index.html, index.php"')),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","autoindex","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},"\u5f53 index \u6307\u4ee4\u6307\u5b9a\u7684\u4e3b\u9875\u6587\u4ef6\u4e0d\u5b58\u5728\u65f6\uff0c\u4ea4\u7ed9 autoindex \u6307\u4ee4\uff0c\u5c06\u81ea\u52a8\u5217\u51fa\u76ee\u5f55\u4e2d\u7684\u6587\u4ef6 autoindex {on/off}")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","log","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},"\u548c\u8bbf\u95ee\u65e5\u5fd7\u76f8\u5173\u7684\u6a21\u5757\uff0c\u6307\u4ee4\u5305\u62ec log","_","format \u548c access","_","log")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","memcached","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},"\u548c memcached \u76f8\u5173\u7684\u6a21\u5757\uff0c\u7528\u4e8e\u4ece memcached \u670d\u52a1\u5668\u4e2d\u83b7\u53d6\u76f8\u5e94\u54cd\u5e94\u6570\u636e")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","proxy","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},"\u548c\u4ee3\u7406\u76f8\u5173\uff0c\u5141\u8bb8\u4f20\u9001\u8bf7\u6c42\u5230\u5176\u5b83\u670d\u52a1\u5668")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","realip","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},"\u5f53 nginx \u5728\u53cd\u5411\u4ee3\u7406\u7684\u540e\u7aef\u63d0\u4f9b\u670d\u52a1\u65f6\uff0c\u83b7\u53d6\u5230\u771f\u6b63\u7684\u5ba2\u6237\u7aef\u5730\u5740\uff0c\u5426\u5219\u83b7\u53d6\u7684\u662f\u53cd\u5411\u4ee3\u7406\u7684 IP \u5730\u5740")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","referer","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},"\u5b9e\u73b0\u9632\u76d7\u94fe\u529f\u80fd\u7684\u6a21\u5757")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","rewrite","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},"\u548c URL \u5730\u5740\u91cd\u5199\u76f8\u5173\u7684\u6a21\u5757\uff0c\u9700\u8981\u5b89\u88c5 pcre-devel \u624d\u80fd\u7f16\u8bd1\u5b89\u88c5\u8be5\u6a21\u5757")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","scgi","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},"simple cgi\uff0c\u662f cgi \u7684\u66ff\u4ee3\u54c1\uff0c\u548c fastcgi \u7c7b\u4f3c\uff0c\u4f46\u66f4\u7b80\u5355")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","ssl","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},"\u63d0\u4f9b ssl \u529f\u80fd\u7684\u6a21\u5757\uff0c\u5373\u5b9e\u73b0 HTTPS")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","stub","_","status","_","module"),(0,l.kt)("td",{parentName:"tr",align:null},"\u83b7\u53d6 nginx \u8fd0\u884c\u72b6\u6001\u4fe1\u606f")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ngx","_","http","_","upstream"),(0,l.kt)("td",{parentName:"tr",align:null},"\u548c\u8d1f\u8f7d\u5747\u8861\u76f8\u5173\u6a21\u5757")))),(0,l.kt)("p",null,"\u8fd9\u4e9b\u6a21\u5757\u5171\u540c\u7ec4\u6210\u4e86 nginx \u7684 http \u529f\u80fd\u3002"),(0,l.kt)("h2",{id:"75nginx-\u914d\u7f6e\u6587\u4ef6\u7b80\u5355\u8bf4\u660e"},"7.5\u3001nginx \u914d\u7f6e\u6587\u4ef6\u7b80\u5355\u8bf4\u660e"),(0,l.kt)("p",null,"nginx \u7684\u914d\u7f6e\u6587\u4ef6\u6709\u5f88\u591a\u4e2a\uff0c\u5982\u4e0b\u3002\u5176\u4e2d\u4e3b\u914d\u7f6e\u6587\u4ef6\u4e3a nginx.conf\uff0c\u5176\u4ed6\u914d\u7f6e\u6587\u4ef6\u5728\u9700\u8981\u7684\u65f6\u5019\u4f7f\u7528 include \u6307\u4ee4\u5c06\u5176\u5305\u542b\u5230\u4e3b\u914d\u7f6e\u6587\u4ef6\u4e2d\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# ls /usr/local/nginx/conf/\nfastcgi.conf            koi-utf             nginx.conf           uwsgi_params\nfastcgi.conf.default    koi-win             nginx.conf.default   uwsgi_params.default\nfastcgi_params          mime.types          scgi_params          win-utf\nfastcgi_params.default  mime.types.default  scgi_params.default\n[root@aarch64 ~]#\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},'\u5176\u4e2d ".default" \u540e\u7f00\u7684\u662f\u5bf9\u5e94\u524d\u7f00\u914d\u7f6e\u6587\u4ef6\u7684\u5907\u4efd\u914d\u7f6e\u6587\u4ef6\uff0c',(0,l.kt)("inlineCode",{parentName:"li"},'"_params"')," \u662f\u5bf9\u5e94\u524d\u7f00\u7684\u53c2\u6570\u6587\u4ef6\u3002",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u5982 fastcgi.conf \u662f\u548c fastcgi \u76f8\u5173\u53c2\u6570\u7684\u914d\u7f6e\u6587\u4ef6\uff0c",(0,l.kt)("inlineCode",{parentName:"li"},"fastcgi_params")," \u662f fastcgi \u7684\u53c2\u6570\u6587\u4ef6\uff0cfastcgi.conf.default \u662f fastcgi.conf \u7684\u5907\u4efd\u6587\u4ef6\u3002"))),(0,l.kt)("li",{parentName:"ul"},'\u5173\u4e8e\u4e3b\u914d\u7f6e\u6587\u4ef6 nginx.conf\uff0c\u7531\u4e8e Nginx \u9ad8\u5ea6\u6a21\u5757\u5316\uff0c\u6240\u4ee5\u5b83\u662f\u5206\u6bb5\u914d\u7f6e\u7684\uff0c\u6838\u5fc3\u6a21\u5757\u4e3a core\uff0c\u5bf9\u5e94\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684 Main \u548c Events \u6bb5\u3002\u6b64\u5916\u8fd8\u6709\u5176\u4ed6\u4e00\u4e9b\u6a21\u5757\u3002\u914d\u7f6e\u6587\u4ef6\u4e2d\u6bcf\u4e00\u4e2a\u6307\u4ee4\u5fc5\u987b\u4ee5\u5206\u53f7 ";" \u7ed3\u675f\uff0c\u5426\u5219\u8bed\u6cd5\u9519\u8bef\u3002')),(0,l.kt)("h3",{id:"751main-\u548c-events-\u6bb5"},"7.5.1\u3001main \u548c events \u6bb5"),(0,l.kt)("p",null,"Main \u7528\u4e8e\u914d\u7f6e\u9519\u8bef\u65e5\u5fd7\u3001\u8fdb\u7a0b\u53ca\u6743\u9650\u7b49\u76f8\u5173\u7684\u53c2\u6570\uff0cEvents \u7528\u4e8e\u914d\u7f6e IO \u6a21\u578b\uff0c\u5982 epoll\u3001kqueue\u3001select \u6216 poll \u7b49\uff0c\u5b83\u4eec\u662f\u5fc5\u5907\u6a21\u5757\u3002\u5982\u4e0b\u914d\u7f6e\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'#user  nobody;        # worker\u8fdb\u7a0b\u8eab\u4efd,\u9ed8\u8ba4\u4f7f\u7528\u7f16\u8bd1\u65f6\u6307\u5b9a\u503c.\u8bed\u6cd5\u4e3a"user user_name [group_name]"\nworker_processes  4;  # worker\u8fdb\u7a0b\u6570\u91cf,\u8be5\u6307\u4ee4\u503c\u4f9d\u8d56\u56e0\u7d20\u8f83\u591a\uff0c\u4f8b\u5982\u662f\u5426CPU\u5bc6\u96c6\u578b\u3001\u662f\u5426IO\u5bc6\u96c6\u578b\u3002\n                      # \u5728\u521d\u59cb\u65f6\u8bbe\u7f6e\u4e3acpu\u7684\u603b\u6838\u6570\u662f\u4e00\u4e2a\u4e0d\u9519\u7684\u9009\u62e9\u3002\n\n#error_log logs/error.log;         # \u9519\u8bef\u65e5\u5fd7\u6587\u4ef6\uff0c\u7981\u7528\u9519\u8bef\u65e5\u5fd7"error_log /dev/null LEVEL;"\n#error_log logs/error.log notice;  # \u7ea7\u522b:debug|info|notice|warn|error|crit|alert|emerg\uff0c\u9ed8\u8ba4\u4e3aerror\n#error_log  logs/error.log  info;\n\n#pid        logs/nginx.pid;\n#lock_file  logs/nginx.lock;\n\nevents {\n    worker_connections  1024;   # \u6bcf\u4e2aworker\u8fdb\u7a0b\u7684\u6700\u5927\u8fde\u63a5\u6570\n    multi_accept on;            # \u662f\u5426\u4e00\u6b21\u6027\u5c06\u76d1\u542c\u5230\u7684\u8fde\u63a5\u5168\u63a5\u6536\u8fdb\u6765\uff0c\u9ed8\u8ba4\u4e3aoff\uff0c\u5173\u95ed\u65f6\u4e00\u6b21\u63a5\u6536\u4e00\u6761\u8fde\u63a5\n    accept_mutex on             # \u9ed8\u8ba4\u4e3aon\uff0c\u5f00\u542f\u65f6\u8868\u793a\u4ee5\u4e32\u884c\u65b9\u5f0f\u63a5\u5165\u65b0\u8fde\u63a5\uff0c\u5426\u5219\u5c06\u901a\u62a5\u7ed9\u6240\u6709worker\u3002\n                                # \u8fd9\u53ef\u80fd\u4f1a\u6d6a\u8d39\u8d44\u6e90\u5e76\u4ea7\u751f\u4e0d\u53ef\u9884\u8ba1\u7684\u540e\u679c\uff0c\u4f8b\u5982\u60ca\u7fa4\u95ee\u9898\n}\n')),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u5982\u679c\u67d0\u4e2a\u6587\u4ef6\u91c7\u7528\u4e86\u76f8\u5bf9\u8def\u5f84\uff0c\u5219\u5176\u76f8\u5bf9\u7684\u57fa\u51c6\u4e3a basedir\u3002"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u4f8b\u5982\u7f16\u8bd1\u65f6 --prefix \u6307\u5b9a\u4e3a /usr/local/nginx\uff0c\u5219\u6307\u5b9a pid \u4e3a logs/nginx.pid \u65f6\uff0c\u5176\u5b9e\u9645\u8def\u5f84\u4e3a /usr/local/nginx/logs/nginx.pid\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"worker","_","processes \u7684\u503c\u548c work","_","connections \u7684\u503c\u51b3\u5b9a\u4e86\u6700\u5927\u5e76\u53d1\u6570\u91cf\u3002"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u4f8b\u5982\u4e0a\u9762\u7684\u914d\u7f6e\u4e2d\uff0c\u6bcf\u4e2a worker \u8fdb\u7a0b\u6700\u5927\u5141\u8bb8 1024 \u4e2a\u8fde\u63a5\uff0c\u914d\u7f6e\u4e86 4 \u4e2a worker \u8fdb\u7a0b\uff0c\u6240\u4ee5\u5e76\u53d1\u6570\u91cf\u4e3a 1024","*","4=4096\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u4f46\u5728\u53cd\u5411\u4ee3\u7406\u573a\u666f\u4e2d\u8ba1\u7b97\u65b9\u6cd5\u4e0d\u540c\uff0c\u56e0\u4e3a nginx \u65e2\u8981\u7ef4\u6301\u548c\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\uff0c\u53c8\u8981\u7ef4\u6301\u548c\u540e\u7aef\u670d\u52a1\u5668\u7684\u8fde\u63a5\uff0c\u56e0\u6b64\u5904\u7406\u4e00\u6b21\u8fde\u63a5\u8981\u5360\u7528 2 \u4e2a\u8fde\u63a5\uff0c\u6240\u4ee5\u6700\u5927\u5e76\u53d1\u6570\u8ba1\u7b97\u65b9\u5f0f\u4e3a\uff1a",(0,l.kt)("inlineCode",{parentName:"li"},"worker_processes * worker_connections/2"),"\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u6b64\u5916\u8fd8\u9700\u6ce8\u610f\uff0c\u9664\u4e86\u548c\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\u3001\u4e0e\u540e\u7aef\u670d\u52a1\u5668\u7684\u8fde\u63a5\uff0cnginx \u53ef\u80fd\u8fd8\u4f1a\u6253\u5f00\u5176\u4ed6\u7684\u8fde\u63a5\uff0c\u8fd9\u4e9b\u90fd\u4f1a\u5360\u7528\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u4ece\u800c\u5f71\u54cd\u5e76\u53d1\u6570\u91cf\u7684\u8ba1\u7b97\u3002"),(0,l.kt)("li",{parentName:"ul"},'\u6700\u540e\u8fd8\u9700\u6ce8\u610f\uff0c\u6700\u5927\u5e76\u53d1\u6570\u91cf\u8fd8\u53d7 "\u5141\u8bb8\u6253\u5f00\u7684\u6700\u5927\u6587\u4ef6\u63cf\u8ff0\u7b26\u6570\u91cf" \u9650\u5236\uff0c\u53ef\u4ee5\u4f7f\u7528 "worker',"_","rlimit","_",'nofile" \u6307\u4ee4\u4fee\u6539\u6216\u76f4\u63a5\u4fee\u6539\u64cd\u4f5c\u7cfb\u7edf\u7684\u5bf9\u5e94\u5185\u6838\u53c2\u6570\u3002'))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u53ef\u4ee5\u5728 main \u6bb5\u4f7f\u7528 worker","_","cpu","_","affinity \u6307\u4ee4\u7ed1\u5b9a CPU \u6838\u5fc3\u3002nginx \u901a\u8fc7\u4f4d\u6570\u8bc6\u522b CPU \u6838\u5fc3\u4ee5\u53ca\u6838\u5fc3\u6570\uff0c\u6307\u5b9a\u4f4d\u6570\u4e0a\u5360\u4f4d\u7b26\u4e3a 1 \u8868\u793a\u4f7f\u7528\u8be5\u6838\u5fc3\uff0c\u5360\u4f4d\u7b26\u4e3a 0 \u8868\u793a\u4e0d\u4f7f\u7528\u8be5\u6838\u5fc3\u3002"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u4f8b\u5982 2 \u6838 cpu \u7684\u4f4d\u6570\u5206\u522b\u4e3a 01 \u548c 10\uff0c4 \u6838\u7684\u4f4d\u6570\u5206\u522b\u4e3a 1000, 0100, 0010 \u4ee5\u53ca 0001\uff0c\u540c\u7406 8 \u6838\u548c 16 \u6838\u3002\u5728\u7ed3\u5408 worker","_","processes \u6307\u4ee4\u4e00\u8d77\u4f7f\u7528\u65f6\uff0c\u8981\u6ce8\u610f worker \u8fdb\u7a0b\u548c\u6838\u5fc3\u7684\u5bf9\u5e94\u65b9\u5f0f\uff0c\u4f8b\u5982\uff1a")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# \u6bcf\u4e2aworker\u5206\u522b\u5bf9\u5e94cpu0/cpu1/cpu2/cpu3\nworker_processes    4;\nworker_cpu_affinity 0001 0010 0100 1000;\n\n# \u67094\u6838\u5fc3\uff0c\u4f46\u53ea\u6709\u4e24worker\uff0c\u7b2c\u4e00\u4e2aworker\u5bf9\u5e94cpu0/cpu2\uff0c\u7b2c\u4e8c\u4e2aworker\u5bf9\u5e94cpu1/cpu3\nworker_processes    2;\nworker_cpu_affinity 0101 1010;\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},'\u5728 events \u6bb5\uff0c\u53ef\u4ee5\u4f7f\u7528 "use" \u6307\u4ee4\u53ef\u4ee5\u6307\u5b9a\u4f7f\u7528\u54ea\u79cd I/O \u6a21\u578b\uff0cLinux \u4e0a\u9ed8\u8ba4\u662f epoll\uff0c\u901a\u5e38\u53ef\u4ee5\u4e0d\u7528\u624b\u52a8\u53bb\u8bbe\u7f6e\uff0c\u56e0\u4e3a nginx \u9ed8\u8ba4\u4f1a\u91c7\u7528\u6700\u4f73\u914d\u7f6e\u3002'))),(0,l.kt)("p",null,"\u4ee5\u4e0b\u662f main \u6bb5\u548c events \u6bb5\u7684\u914d\u7f6e\u793a\u4f8b\uff0c\u5927\u591a\u6570\u91c7\u7528\u7684\u9ed8\u8ba4\u503c\uff0c\u9700\u8981\u4fee\u6539\u7684\u5927\u81f4\u5c31\u662f worker \u6570\u91cf\u3001\u6bcf\u4e2a worker \u6700\u5927\u8fde\u63a5\u6570\u4ee5\u53ca\u8fdb\u7a0b\u7ed1\u5b9a cpu\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"worker_processes  4;\nevents {\n    worker_connections  1024;\n}\n")),(0,l.kt)("h3",{id:"752http-\u6bb5"},"7.5.2\u3001http \u6bb5"),(0,l.kt)("h4",{id:"7521\u914d\u7f6e\u6587\u4ef6\u6982\u89c8"},"7.5.2.1\u3001\u914d\u7f6e\u6587\u4ef6\u6982\u89c8"),(0,l.kt)("p",null,"http \u6bb5\u662f\u7531 http \u76f8\u5173\u6a21\u5757\u652f\u6301\u7684\u3002\u4ee5\u4e0b\u662f\u9ed8\u8ba4\u914d\u7f6e\u9879\u3002\u6ce8\u610f\uff0chttp \u6839\u6bb5\u4e0b\u4f7f\u7528\u76f8\u5bf9\u8def\u5f84\u662f\u76f8\u5bf9 conf \u76ee\u5f55\u7684\uff0c\u5982 ",(0,l.kt)("inlineCode",{parentName:"p"},'"include extra/*.conf"')," \u8868\u793a\u7684\u662f ",(0,l.kt)("inlineCode",{parentName:"p"},"conf/extra/*.conf"),"\uff1b"),(0,l.kt)("p",null,"\u975e\u6839\u6bb5\u5185\u7684\u76f8\u5bf9\u8def\u5f84\u5982 server \u6bb5\u5185\u4f7f\u7528\u76f8\u5bf9\u8def\u5f84\u662f\u76f8\u5bf9\u4e8e\u7684\u5b89\u88c5\u76ee\u5f55 ",(0,l.kt)("inlineCode",{parentName:"p"},"<prefix>")," \u7684\uff0c\u4f8b\u5982 nginx \u5b89\u88c5\u5728 /usr/local/nginx \u4e0b\uff0c\u5f53 location \u4e2d\u7684 root \u8bbe\u7f6e\u4e3a html \u65f6\uff0c\u5b83\u8868\u793a\u7684\u8def\u5f84\u662f /usr/local/nginx/html/\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'http {\n    include       mime.types;                       # nginx\u652f\u6301\u7684\u5a92\u4f53\u6587\u4ef6\u7c7b\u578b\u3002\u76f8\u5bf9\u8def\u5f84\u4e3a\u540c\u76ee\u5f55conf\u4e0b\u7684\u5176\u4ed6\u6587\u4ef6\n    default_type  application/octet-stream;         # \u9ed8\u8ba4\u7684\u5a92\u4f53\u7c7b\u578b\n\n    #log_format  main  \'$remote_addr - $remote_user [$time_local] "$request" \'   # \u8bbf\u95ee\u65e5\u5fd7\u7684\u683c\u5f0f\n    #                  \'$status $body_bytes_sent "$http_referer" \'\n    #                  \'"$http_user_agent" "$http_x_forwarded_for"\';\n\n    #access_log  logs/access.log  main;\n\n    sendfile        on;                             # \u542f\u7528sendfile\u4f20\u8f93\u6a21\u5f0f\uff0c\u6b64\u6a21\u5f0f\u662f"\u96f6\u62f7\u8d1d"\n    #tcp_nopush     on;                             # \u53ea\u5728sendfile on\u65f6\u6709\u6548\u3002\u8ba9\u6570\u636e\u5305\u6324\u6ee1\u5230\u4e00\u5b9a\u7a0b\u5ea6\u624d\u53d1\u9001\u51fa\u53bb\uff0c\u6324\u6ee1\u4e4b\u524d\u88ab\u963b\u585e\n\n    #keepalive_timeout  0;                          # keepalive\u7684\u8d85\u65f6\u65f6\u95f4\n    keepalive_timeout  65;\n\n    #gzip  on;                                      # \u662f\u5426\u542f\u7528gzip\u538b\u7f29\u54cd\u5e94\u62a5\u6587\n\n    server {                                        # \u5b9a\u4e49\u865a\u62df\u4e3b\u673a\n        listen       80;                            # \u5b9a\u4e49\u76d1\u542c\u5957\u63a5\u5b57\n        server_name  localhost;                     # \u5b9a\u4e49\u4e3b\u673a\u540d\u52a0\u57df\u540d\uff0c\u5373\u7f51\u7ad9\u5730\u5740\n\n        #charset koi8-r;                            # \u9ed8\u8ba4\u5b57\u7b26\u96c6\n\n        #access_log  logs/host.access.log  main;    # \u8bbf\u95ee\u65e5\u5fd7\u8def\u5f84\n\n        location / {                                # location\u5bb9\u5668\uff0c\u5373URI\u7684\u6839\n            root   html;                            # \u7ad9\u70b9\u6839\u76ee\u5f55\uff0c\u5373DocumentRoot\uff0c\u76f8\u5bf9\u8def\u5f84\u65f6\u4e3a<prefix>/html\n            index  index.html index.htm;            # \u7ad9\u70b9\u4e3b\u9875\u6587\u4ef6\n        }\n\n        #error_page  404    /404.html;              # \u51fa\u73b0404 page not fount\u9519\u8bef\u65f6\uff0c\u4f7f\u7528/404.html\u9875\u54cd\u5e94\u5ba2\u6237\u7aef\n\n        # redirect server error pages to the static page /50x.html\n        #\n        error_page   500 502 503 504  /50x.html;    # \u51fa\u73b050x\u9519\u8bef\u65f6\uff0c\u4f7f\u7528/50x.html\u9875\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\n        location = /50x.html {                      # \u5b9a\u4e49\u624b\u52a8\u8f93\u5165\u5305\u542b/50x.html\u65f6\u7684location\n            root   html;\n        }\n\n        # deny access to .htaccess files, if Apache\'s document root\n        # concurs with nginx\'s one\n        #\n        #location ~ /\\.ht {\n        #    deny  all;\n        #}\n    }\n    # another virtual host using mix of IP-, name-, and port-based configuration\n    #\n    #server {\n    #    listen       8000;\n    #    listen       somename:8080;\n    #    server_name  somename  alias  another.alias;\n\n    #    location / {\n    #        root   html;\n    #        index  index.html index.htm;\n    #    }\n    #}\n}\n')),(0,l.kt)("h4",{id:"7522root-\u6307\u4ee4\u548c-alias-\u6307\u4ee4"},"7.5.2.2\u3001root \u6307\u4ee4\u548c alias \u6307\u4ee4"),(0,l.kt)("p",null,"root \u6307\u4ee4\u8bbe\u7f6e\u7ad9\u70b9\u6839\u76ee\u5f55\uff0c\u5373 httpd \u7684 documentroot\uff0c\u4f46\u53c8\u6709\u6240\u4e0d\u540c\uff0c\u56e0\u4e3a nginx \u53ef\u4ee5\u5728\u591a\u4e2a\u4e0a\u4e0b\u6587\u4f4d\u7f6e\u5904\u4f7f\u7528 root \u6307\u4ee4\uff0c\u4f8b\u5982 Location \u5bb9\u5668\u4e2d\u3002"),(0,l.kt)("p",null,"\u5982\u679c\u914d\u7f6e\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"location /i/ {\n    root /data/w3;\n}\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},'\u90a3\u4e48 nginx \u5c06\u4f7f\u7528\u6587\u4ef6 /data/w3/i/top.gif \u54cd\u5e94\u8bf7\u6c42 "/i/top.gif"\u3002')),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"root \u6307\u4ee4\u4ec5\u4ec5\u53ea\u662f\u5c06\u5339\u914d\u7684 URI \u8ffd\u52a0\u5728 root \u8def\u5f84\u540e\uff0c\u5982\u679c\u8981\u6539\u53d8 URI\uff0c\u5e94\u8be5\u4f7f\u7528 alias \u6307\u4ee4\uff0c\u5b83\u4f1a\u5bf9 URI \u8fdb\u884c\u66ff\u6362"),"\u3002\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"location /i/ {\n    alias /data/w3/images/;\n}\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u90a3\u4e48 nginx \u5c06\u4f7f\u7528\u6587\u4ef6 /data/w3/images/top.gif \u54cd\u5e94\u8bf7\u6c42 /i/top.gif\u3002\u56e0\u6b64\uff0c\u5982\u679c alias \u6307\u4ee4\u7684\u8def\u5f84\u6700\u540e\u4e00\u90e8\u5206\u5305\u542b\u4e86 URI\uff0c\u5219\u6700\u597d\u4f7f\u7528 root \u6307\u4ee4\uff0c\u800c\u975e alias \u6307\u4ee4\uff0c\u867d\u7136\u5b83\u4eec\u90fd\u80fd\u6210\u529f\u54cd\u5e94\u3002")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"location /images/ {\n    alias /data/w3/images/;\n}\n\nlocation /images/ {\n    root /data/w3/;\n}\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"\u5b83\u4eec\u90fd\u80fd\u4f7f\u7528\u76f8\u5bf9\u8def\u5f84\uff0c\u76f8\u5bf9\u7684\u662f prefix"),'\u3002\u4f8b\u5982\u7f16\u8bd1\u8def\u5f84\u4e3a /usr/local/nginx\uff0c\u5219 "root html" \u6307\u7684\u662f "/usr/local/nginx/html"\u3002')),(0,l.kt)("p",null,"\u4e0e root \u548c alias \u6307\u4ee4\u76f8\u5173\u7684\u53d8\u91cf\u4e3a ",(0,l.kt)("inlineCode",{parentName:"p"},"$document_root"),"\u3001",(0,l.kt)("inlineCode",{parentName:"p"},"$realpath_root"),"\u3002",(0,l.kt)("strong",{parentName:"p"},"\u5176\u4e2d ",(0,l.kt)("inlineCode",{parentName:"strong"},"$document_root")," \u7684\u503c\u5373\u662f root \u6307\u4ee4\u3001alias \u6307\u4ee4\u7684\u503c\uff0c\u800c ",(0,l.kt)("inlineCode",{parentName:"strong"},"$realpath_root")," \u7684\u503c\u662f\u5bf9 root\u3001alias \u6307\u4ee4\u8fdb\u884c\u7edd\u5bf9\u8def\u5f84\u6362\u7b97\u540e\u7684\u503c"),"\u3002"),(0,l.kt)("h4",{id:"7523location-\u5bb9\u5668"},"7.5.2.3\u3001location \u5bb9\u5668"),(0,l.kt)("p",null,"\u8be5\u6307\u4ee4\u5bf9\u89c4\u8303\u5316\u540e\u7684 URI \u8fdb\u884c\u5339\u914d\uff0c\u5e76\u5bf9\u5339\u914d\u7684\u8def\u5f84\u5c01\u88c5\u4e00\u7cfb\u5217\u6307\u4ee4\u3002 \u8bed\u6cd5\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"location [ = | ~ | ~* | ^~ ] uri { ... }\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},'location /uri/ {}\uff1a\u8868\u793a\u5bf9 /uri/ \u76ee\u5f55\u53ca\u5176\u5b50\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u90fd\u5339\u914d\u3002\u6240\u4ee5 "location / {}" \u7684\u5339\u914d\u8303\u56f4\u662f\u6700\u5927\u7684\u3002'),(0,l.kt)("li",{parentName:"ul"},"location = /uri/ {}\uff1a\u8868\u793a\u53ea\u5bf9\u76ee\u5f55\u6216\u6587\u4ef6\u8fdb\u884c\u5339\u914d\uff0c\u4e0d\u5bf9\u76ee\u5f55\u4e2d\u7684\u6587\u4ef6\u548c\u5b50\u76ee\u5f55\u8fdb\u884c\u5339\u914d\u3002\u6240\u4ee5\u4e00\u822c\u53ea\u7528\u6765\u505a\u6587\u4ef6\u5339\u914d"),(0,l.kt)("li",{parentName:"ul"},"location ~ /uri/ {}\uff1a\u8868\u793a\u533a\u5206\u5927\u5c0f\u5199\u7684\u6b63\u5219\u5339\u914d\u3002"),(0,l.kt)("li",{parentName:"ul"},"location ~","*"," /uri/ {}\uff1a\u8868\u793a\u4e0d\u533a\u5206\u5927\u5c0f\u5199\u7684\u6b63\u5219\u5339\u914d\u3002"),(0,l.kt)("li",{parentName:"ul"},"location ^~ /uri/ {}\uff1a\u8868\u793a\u7981\u7528\u6b63\u5219\u5339\u914d\uff0c\u5373\u7cbe\u786e\u5b57\u7b26\u4e32\u5339\u914d\uff0c\u6b64\u65f6\u6b63\u5219\u4e2d\u7684\u5143\u5b57\u7b26\u88ab\u89e3\u91ca\u6210\u666e\u901a\u5b57\u7b26\u3002")),(0,l.kt)("p",null,"\u5b83\u4eec\u7684\u5339\u914d\u4f18\u5148\u7ea7\u89c4\u5219\u4e3a\uff1a",(0,l.kt)("strong",{parentName:"p"},"nginx \u5148\u68c0\u67e5 URI \u7684\u524d\u7f00\u8def\u5f84\uff0c\u5728\u8fd9\u4e9b\u8def\u5f84\u4e2d\u627e\u5230\u6700\u7cbe\u786e\u5339\u914d\u8bf7\u6c42 URI \u7684\u8def\u5f84\u3002\u7136\u540e nginx \u6309\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u51fa\u73b0\u987a\u5e8f\u68c0\u67e5\u6b63\u5219\u8868\u8fbe\u5f0f\u8def\u5f84\uff0c\u5339\u914d\u4e0a\u67d0\u4e2a\u8def\u5f84\u540e\u5373\u505c\u6b62\u5339\u914d\u5e76\u4f7f\u7528\u8be5\u8def\u5f84\u7684\u914d\u7f6e\uff0c\u5426\u5219\u4f7f\u7528\u6700\u5927\u524d\u7f00\u5339\u914d\u7684\u8def\u5f84\u7684\u914d\u7f6e"),"\u3002"),(0,l.kt)("p",null,'\u4f7f\u7528 "=" \u524d\u7f00\u53ef\u4ee5\u5b9a\u4e49 URI \u548c\u8def\u5f84\u7684\u7cbe\u786e\u5339\u914d\u3002\u5982\u679c\u53d1\u73b0\u5339\u914d\uff0c\u5219\u7ec8\u6b62\u8def\u5f84\u67e5\u627e\u3002\u4f8b\u5982\u8bf7\u6c42 "/" \u5f88\u9891\u7e41\uff0c\u5b9a\u4e49 "location = /" \u53ef\u4ee5\u63d0\u9ad8\u8fd9\u4e9b\u8bf7\u6c42\u7684\u5904\u7406\u901f\u5ea6\uff0c\u56e0\u4e3a\u67e5\u627e\u8fc7\u7a0b\u5728\u7b2c\u4e00\u6b21\u6bd4\u8f83\u4ee5\u540e\u5373\u7ed3\u675f\u3002'),(0,l.kt)("p",null,"\u4ee5\u4e0b\u662f\u4e00\u4e2a\u4f18\u5148\u7ea7\u7684\u793a\u4f8b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"location = / {\n    [ configuration A ]\n}\n\nlocation / {\n    [ configuration B ]\n}\n\nlocation /documents/ {\n    [ configuration C ]\n}\n\nlocation ^~ /images/ {\n    [ configuration D ]\n}\n\nlocation ~* \\.(gif|jpg|jpeg)$ { \n    [ configuration E ] \n}\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},'\u8bf7\u6c42 "/" \u80fd\u5339\u914d A \u548c B\uff0c\u4f46\u6700\u7cbe\u786e\u5339\u914d\u4e3a A\u3002'),(0,l.kt)("li",{parentName:"ul"},'\u8bf7\u6c42 "/index.html" \u7684\u524d\u7f00 "/" \u80fd\u5339\u914d A \u548c B\uff0c\u4f46 A \u53ea\u80fd\u5339\u914d "/" \u81ea\u8eab\uff0c\u56e0\u6b64\u6700\u7ec8\u5339\u914d\u914d\u7f6e B\u3002(\u524d\u7f00\u4e5f\u80fd\u5339\u914d E\uff0c\u4f46\u6587\u4ef6\u540d\u65e0\u6cd5\u5339\u914d)'),(0,l.kt)("li",{parentName:"ul"},'\u8bf7\u6c42 "/documents/document.html" \u7684\u524d\u7f00\u80fd\u5339\u914d B \u548c C\uff0c\u4f46 C \u66f4\u7cbe\u786e\uff0c\u56e0\u6b64\u5339\u914d\u914d\u7f6e C\u3002(\u524d\u7f00\u4e5f\u80fd\u5339\u914d E\uff0c\u4f46\u6587\u4ef6\u540d\u65e0\u6cd5\u5339\u914d)'),(0,l.kt)("li",{parentName:"ul"},'\u8bf7\u6c42 "/images/1.gif" \u7684\u524d\u7f00\u80fd\u5339\u914d B\u3001D \u548c E\uff0c\u4e14 D \u548c E \u90fd\u662f\u6700\u957f\u8def\u5f84\u5339\u914d\uff0c\u4f46 ^~ \u4f18\u5148\u7ea7\u66f4\u9ad8\uff0c\u56e0\u6b64\u5339\u914d\u914d\u7f6e D\u3002'),(0,l.kt)("li",{parentName:"ul"},'\u8bf7\u6c42 "/documents/1.jpg" \u7684\u524d\u7f00\u80fd\u5339\u914d B\u3001C\uff0c\u540c\u6837\u4e5f\u80fd\u5339\u914d E\uff0c\u4e14 E \u6bd4 B \u7684\u5339\u914d\u66f4\u7cbe\u786e\uff0c\u56e0\u6b64\u6700\u7ec8\u5339\u914d\u914d\u7f6e E\u3002')),(0,l.kt)("p",null,"\u5927\u81f4\u53ef\u4ee5\u5c06\u89c4\u5219\u7b80\u5316\u4e3a\u5982\u4e0b\u4f18\u5148\u7ea7\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"(location = uri ) > (location ^~ uri) > (location *~|~ uri) > (location uri)\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"\u5373\u7b49\u53f7\u4f18\u5148\u7ea7\u6700\u9ad8\uff0c\u975e\u6b63\u5219\u5339\u914d\u6b21\u4e4b\uff0c\u518d\u4e4b\u540e\u662f\u6b63\u5219\u5339\u914d\uff0c\u5b83\u4eec\u4e4b\u95f4\u6709\u4f4d\u7f6e\u7684\u5148\u540e\u987a\u5e8f\uff0c\u4f18\u5148\u7ea7\u6700\u4f4e\u7684\u662f\u6ca1\u6709\u4f7f\u7528\u4efb\u4f55\u7b26\u53f7\u7684\u5339\u914d"),"\u3002")),(0,l.kt)("p",null,'\u7531\u6b64\u4e5f\u53ef\u4ee5\u77e5\u9053\uff0c"location / {}" \u8fd9\u79cd\u65b9\u5f0f\u662f\u4e00\u79cd\u7279\u6b8a\u7684 uri \u5339\u914d\uff0c\u65e0\u8bba\u4ec0\u4e48 uri \u8def\u5f84\uff0c\u90fd\u80fd\u5f80\u8fd9\u91cc\u9762\u88c5\uff0c\u53ef\u4ee5\u8ba4\u4e3a\u5b83\u662f\u9ed8\u8ba4\u5339\u914d\uff0c\u5f53\u5176\u5b83 location \u90fd\u5339\u914d\u4e0d\u4e0a\u65f6\u5c31\u4f1a\u5339\u914d\u5b83\u3002'),(0,l.kt)("h4",{id:"7524error_page-\u6307\u4ee4"},"7.5.2.4\u3001error","_","page \u6307\u4ee4"),(0,l.kt)("p",null,"\u5f53\u51fa\u73b0\u5bf9\u5e94\u72b6\u6001\u7801\u7684\u9519\u8bef\u65f6\uff0c\u6307\u5b9a\u8fd4\u56de\u7684 URI\u8def\u5f84\u3002\u8bed\u6cd5\u4e3a\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"error_page code ... [=[response]] uri;\n")),(0,l.kt)("p",null,"\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684 error","_","page \u90e8\u5206\u9ed8\u8ba4\u4e3a\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"location / {\n    root   html;\n    index  index.html index.htm;\n}\n#error_page  404              /404.html;\nerror_page   500 502 503 504  /50x.html;\nlocation = /50x.html {\n    root   html;\n}\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u5047\u5982\u53d6\u6d88\u4e86 404 \u9519\u8bef\u7684 error","_",'page \u884c\u6ce8\u91ca\uff0c\u5f53\u51fa\u73b0 404 \u9519\u8bef\u65f6\uff0c\u5176 uri \u4e3a /404.html\uff0c\u7136\u540e\u4f1a\u5bf9\u5176\u8fdb\u884c location \u7684\u5339\u914d\uff0c\u7531\u4e8e\u53ea\u6709 "location / {}" \u80fd\u5339\u914d\u5230\uff0c\u6240\u4ee5\u5b83\u7684\u76ee\u5f55\u4e3a ',(0,l.kt)("inlineCode",{parentName:"li"},"<prefix>/html/"),"\uff0c\u5373 404.html \u6587\u4ef6\u8def\u5f84\u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"<prefix>/html/404.html"),"\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u5bf9\u4e8e 50x \u7684 error","_",'page\uff0c\u5176 uri \u4e3a "/50x.html"\uff0c\u6240\u4ee5\u4f1a\u5bf9\u5176\u8fdb\u884c location \u5339\u914d\uff0c\u53d1\u73b0\u53ef\u4ee5\u7cbe\u786e\u5339\u914d\u5230 "location = /50x.html {}"\uff0c\u5f53\u7136 "location / {}" \u4e5f\u80fd\u5339\u914d\u5230\uff0c\u4f46\u662f\u5b83\u7684\u4f18\u5148\u7ea7\u66f4\u4f4e\uff0c\u6240\u4ee5\u5f53\u51fa\u73b0 50x \u9519\u8bef\u65f6\uff0c\u5c06\u4ece ',(0,l.kt)("inlineCode",{parentName:"li"},"<prefix>/html"),' \u76ee\u5f55\u4e0b\u5bfb\u627e 50x.html\uff0c\u8fd9\u91cc\u6b63\u597d\u548c "location / {}" \u91cd\u590d\u4e86\uff0c\u4f46\u5b83\u4eec\u7684\u5339\u914d\u8fc7\u7a0b\u662f\u4e0d\u4e00\u6837\u7684\u3002')),(0,l.kt)("p",null,"\u5047\u5982\u6539\u4e3a\u5982\u4e0b\u914d\u7f6e\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"location / {                       \n    root   html;                   \n    index  index.html index.htm;   \n}\n#error_page  404              /404.html;\nerror_page   500 502 503 504  /50x.html;\nlocation = /50x.html {\n    root   /www/a.com/;\n}\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u51fa\u73b0 50x \u9519\u8bef\u65f6\uff0c\u5c06\u8fd4\u56de /www/a.com/50x.html \u6587\u4ef6\uff0c\u800c\u4e0d\u518d\u662f ",(0,l.kt)("inlineCode",{parentName:"li"},"<prefix>/html/50x.html"),"\u3002")),(0,l.kt)("h4",{id:"7525allow-\u548c-deny"},"7.5.2.5\u3001allow \u548c deny"),(0,l.kt)("p",null,"\u8fd9\u4e24\u4e2a\u6307\u4ee4\u7531 ngx","_","http","_","access","_","module \u6a21\u5757\u63d0\u4f9b\uff0c\u7528\u4e8e\u5141\u8bb8\u6216\u9650\u5236\u67d0\u4e9b IP \u5730\u5740\u7684\u5ba2\u6237\u7aef\u8bbf\u95ee\u3002nginx \u4e2d\u7684 allow \u548c deny \u89c4\u5219\u5f88\u7b80\u5355\uff0c\u4ece\u4e0a\u5411\u4e0b\u5339\u914d\uff0c\u53ea\u8981\u5339\u914d\u5230\u5c31\u505c\u6b62\u3002\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"allow 10.0.0.8\nallow 192.168.100.0/24\ndeny all\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5141\u8bb8 10.0.0.8 \u548c 192.168.100 \u7f51\u6bb5\u7684\u8bbf\u95ee\uff0c\u5176\u4ed6\u7684\u90fd\u62d2\u7edd\u3002")),(0,l.kt)("h4",{id:"7526add_header-\u6dfb\u52a0\u76f8\u5e94\u9996\u90e8\u5b57\u6bb5"},"7.5.2.6\u3001add","_","header \u6dfb\u52a0\u76f8\u5e94\u9996\u90e8\u5b57\u6bb5"),(0,l.kt)("p",null,"\u7528\u4e8e\u5728\u54cd\u5e94\u9996\u90e8\u4e2d\u6dfb\u52a0\u5b57\u6bb5\u3002\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"server {\n    add_header RealPath $realpath_root;\n}\n")),(0,l.kt)("p",null,"\u5c06\u6dfb\u52a0\u4e00\u4e2a\u540d\u4e3a RealPath \u7684\u5b57\u6bb5\uff0c\u503c\u4e3a\u53d8\u91cf realpath","_","root \u7684\u503c\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'[root@aarch64 ~]# curl -I http://localhost\nHTTP/1.1 200 OK\nServer: nginx/1.12.1\nDate: Sat, 30 Oct 2021 17:54:16 GMT\nContent-Type: text/html\nContent-Length: 612\nLast-Modified: Sat, 30 Oct 2021 10:59:41 GMT\nConnection: keep-alive\nETag: "617d259d-264"\nRealPath: /usr/local/nginx-1.12.1/html  # \u6b64\u4e3a\u81ea\u5b9a\u4e49\u6dfb\u52a0\u5b57\u6bb5\nAccept-Ranges: bytes\n\n[root@aarch64 ~]#\n')),(0,l.kt)("h3",{id:"753\u865a\u62df\u4e3b\u673a\u548c-server_name-\u6307\u4ee4"},"7.5.3\u3001\u865a\u62df\u4e3b\u673a\u548c server","_","name \u6307\u4ee4"),(0,l.kt)("p",null,"nginx \u4f7f\u7528 server \u5bb9\u5668\u5b9a\u4e49\u4e00\u4e2a\u865a\u62df\u4e3b\u673a\u3002\u5728 nginx \u4e2d\uff0c\u6ca1\u6709\u4e25\u683c\u533a\u5206\u57fa\u4e8e IP \u548c\u57fa\u4e8e\u540d\u79f0\u7684\u865a\u62df\u4e3b\u673a\uff0c\u5b83\u4eec\u901a\u8fc7 listen \u6307\u4ee4\u548c server","_","name \u6307\u4ee4\u7ed3\u5408\u8d77\u6765\u5f62\u6210\u4e0d\u540c\u7684\u865a\u62df\u4e3b\u673a\u3002"),(0,l.kt)("p",null,"\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# \u57fa\u4e8eIP\u5730\u5740\u7684\u865a\u62df\u4e3b\u673a\nserver {\n        listen 80;\n        server_name 192.168.100.25;\n        location / {\n                root /www/brinnatt/;\n                index index.html index.htm;\n        }\n}\nserver {\n        listen 80;\n        server_name 192.168.100.26;\n        location / {\n                root /www/speedy/;\n                index index.html index.htm;\n        }\n}\n\n# \u57fa\u4e8e\u540d\u79f0\u7684\u865a\u62df\u4e3b\u673a\nserver {\n        listen 80;\n        server_name www.brinnatt.com;\n        location / {\n                root /www/brinnatt/;\n                index index.html index.htm;\n        }\n}\nserver {\n        listen 80;\n        server_name www.speedy.com;\n        location / {\n                root /www/speedy/;\n                index index.html index.htm;\n        }\n}\n\n# \u57fa\u4e8e\u7aef\u53e3\u7684\u865a\u62df\u4e3b\u673a\nserver {\n        listen 80;\n        server_name 192.168.100.25;\n        location / {\n                root /www/brinnatt/;\n                index index.html index.htm;\n        }\n}\nserver {\n        listen 8080;\n        server_name 192.168.100.25;\n        location / {\n                root /www/speedy/;\n                index index.html index.htm;\n        }\n}\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u5176\u4e2d server","_","name \u6307\u4ee4\u53ef\u4ee5\u5b9a\u4e49\u591a\u4e2a\u4e3b\u673a\u540d\uff0c\u7b2c\u4e00\u4e2a\u540d\u5b57\u4e3a\u865a\u62df\u4e3b\u673a\u7684\u9996\u8981\u4e3b\u673a\u540d\u3002\u4f8b\u5982\uff1a"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"server_name  example.com   www.example.com;\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u4e3b\u673a\u540d\u4e2d\u53ef\u4ee5\u542b\u6709\u661f\u53f7 ",(0,l.kt)("inlineCode",{parentName:"p"},'"*"'),"\uff0c\u4ee5\u66ff\u4ee3\u540d\u5b57\u7684\u5f00\u59cb\u90e8\u5206\u6216\u7ed3\u5c3e\u90e8\u5206(\u53ea\u80fd\u662f\u8d77\u59cb\u6216\u7ed3\u5c3e\uff0c\u5982\u679c\u8981\u5b9e\u73b0\u4e2d\u95f4\u90e8\u5206\u7684\u901a\u914d\uff0c\u53ef\u4ee5\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f)\u3002\u4f8b\u5982 ",(0,l.kt)("inlineCode",{parentName:"p"},'"*.example.org"')," \u4e0d\u4ec5\u5339\u914d ",(0,l.kt)("a",{parentName:"p",href:"http://www.example.org%EF%BC%8C%E4%B9%9F%E5%8C%B9%E9%85%8D"},"www.example.org\uff0c\u4e5f\u5339\u914d")," ",(0,l.kt)("a",{parentName:"p",href:"http://www.sub.example.org%E3%80%82%E4%B8%8B%E9%9D%A2%E4%B8%A4%E6%9D%A1%E6%8C%87%E4%BB%A4%E6%98%AF%E7%AD%89%E4%BB%B7%E7%9A%84%E3%80%82"},"www.sub.example.org\u3002\u4e0b\u9762\u4e24\u6761\u6307\u4ee4\u662f\u7b49\u4ef7\u7684\u3002")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"server_name    example.com   *.example.com   www.example.*;\nserver_name   .example.com   www.example.*;\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u4e5f\u53ef\u4ee5\u5728\u4e3b\u673a\u540d\u4e2d\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u5c31\u662f\u5728\u540d\u5b57\u524d\u9762\u8865\u4e00\u4e2a\u6ce2\u6d6a\u7ebf ",(0,l.kt)("inlineCode",{parentName:"p"},'"~"'),"\uff1a"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"server_name   www.example.com   ~^www\\d+\\.example\\.com$;\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"nginx \u5141\u8bb8\u5b9a\u4e49\u7a7a\u4e3b\u673a\u540d\uff1a"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'server {\n  listen       80;\n  server_name  "";\n  return       444;\n}\n')),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},'\u8fd9\u79cd\u4e3b\u673a\u540d\u53ef\u4ee5\u8ba9\u865a\u62df\u4e3b\u673a\u5904\u7406\u6ca1\u6709 "Host" \u9996\u90e8\u7684\u8bf7\u6c42\uff0c\u800c\u4e0d\u662f\u8ba9\u6307\u5b9a "\u5730\u5740:\u7aef\u53e3" \u7684\u9ed8\u8ba4\u865a\u62df\u4e3b\u673a\u6765\u5904\u7406\uff0c\u800c\u8fd9\u6b63\u662f\u672c\u6307\u4ee4\u7684\u9ed8\u8ba4\u8bbe\u7f6e\u3002'),(0,l.kt)("li",{parentName:"ul"},'\u5373\u4f7f\u7528\u975e\u9ed8\u8ba4\u7684\u865a\u62df\u4e3b\u673a\u5904\u7406\u8bf7\u6c42\u5934\u4e2d\u4e0d\u542b "Host" \u5b57\u6bb5\u7684\u8bf7\u6c42\u3002\u4e00\u822c\u8fd9\u6837\u7684\u8bf7\u6c42\u5904\u7406\u65b9\u5f0f\u662f\u76f4\u63a5\u4e22\u5f03\u8bf7\u6c42\uff0c\u5e76\u8fd4\u56de\u4e00\u4e2a\u975e\u6807\u51c6\u7684\u72b6\u6001\u7801\u6765\u7acb\u5373\u5173\u95ed\u8fde\u63a5\uff0c\u4f8b\u5982\u4e0a\u9762\u7684 444\u3002'),(0,l.kt)("li",{parentName:"ul"},"\u5982\u679c server \u5757\u4e2d\u6ca1\u6709\u5b9a\u4e49 server","_","name\uff0cnginx \u4f7f\u7528\u7a7a\u540d\u5b57\u4f5c\u4e3a\u865a\u62df\u4e3b\u673a\u540d\u3002")))),(0,l.kt)("h3",{id:"754\u865a\u62df\u4e3b\u673a\u7684\u5339\u914d\u89c4\u5219"},"7.5.4\u3001\u865a\u62df\u4e3b\u673a\u7684\u5339\u914d\u89c4\u5219"),(0,l.kt)("p",null,"\u901a\u8fc7\u540d\u5b57\u67e5\u627e\u865a\u62df\u4e3b\u673a\u65f6\uff0c\u5982\u679c\u4e00\u4e2a\u540d\u5b57\u53ef\u4ee5\u5339\u914d\u591a\u4e2a\u6307\u5b9a\u7684\u914d\u7f6e\uff0c\u6bd4\u5982\u540c\u65f6\u5339\u914d\u4e0a\u901a\u914d\u7b26\u548c\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u6309\u4e0b\u9762\u4f18\u5148\u7ea7\uff0c\u4f7f\u7528\u5148\u5339\u914d\u4e0a\u7684\u865a\u62df\u4e3b\u673a\uff1a"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u786e\u5b9a\u7684\u540d\u79f0\uff1b"),(0,l.kt)("li",{parentName:"ol"},"\u6700\u957f\u7684\u4ee5\u661f\u53f7\u8d77\u59cb\u7684\u901a\u914d\u7b26\u540d\u5b57\uff0c\u6bd4\u5982 ",(0,l.kt)("inlineCode",{parentName:"li"},'"*.example.com"'),"\uff1b"),(0,l.kt)("li",{parentName:"ol"},"\u6700\u957f\u7684\u4ee5\u661f\u53f7\u7ed3\u675f\u7684\u901a\u914d\u7b26\u540d\u5b57\uff0c\u6bd4\u5982 ",(0,l.kt)("inlineCode",{parentName:"li"},'"mail.*"'),"\uff1b"),(0,l.kt)("li",{parentName:"ol"},"\u7b2c\u4e00\u4e2a\u5339\u914d\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u540d\u5b57(\u6309\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u51fa\u73b0\u7684\u987a\u5e8f)\u3002")),(0,l.kt)("p",null,"\u5f53\u5f00\u59cb\u63a5\u5165\u8bf7\u6c42\u65f6\uff1a"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"nginx \u9996\u5148\u5224\u65ad\u8bf7\u6c42\u7684\u5957\u63a5\u5b57\uff0c\u5373 IP \u548c\u7aef\u53e3\u53f7\uff1b"),(0,l.kt)("li",{parentName:"ol"},"\u7136\u540e\u5728 listen \u5957\u63a5\u5b57\u4e2d\u9009\u62e9\u4e00\u4e2a\u80fd\u5339\u914d\u540d\u79f0\u7684\u865a\u62df\u4e3b\u673a\uff0c\u5982\u679c\u6ca1\u6709\u9009\u51fa\u80fd\u5339\u914d\u7684\u540d\u79f0\uff0c\u5219\u4f7f\u7528\u8be5\u5957\u63a5\u5b57\u7684\u9ed8\u8ba4\u865a\u62df\u4e3b\u673a\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u76d1\u542c\u5957\u63a5\u5b57\u7684\u9ed8\u8ba4\u865a\u62df\u4e3b\u673a\u4e3a\u8be5\u5957\u63a5\u5b57\u4e3b\u673a\u7ec4\u4e2d\u7684\u7b2c\u4e00\u4e2a\u865a\u62df\u4e3b\u673a\uff0c\u4f46\u53ef\u4ee5\u901a\u8fc7 listen \u6307\u4ee4\u7684 default","_","server \u5c5e\u6027\u624b\u52a8\u6307\u5b9a\u3002")),(0,l.kt)("p",null,"\u4f8b\u5982\u4e0b\u9762\u5b9a\u4e49\u4e86 4 \u4e2a\u865a\u62df\u4e3b\u673a\uff1a\u524d 3 \u4e2a\u90fd\u76d1\u542c\u5728 192.168.100.1:80 \u4e0a\uff0c\u7b2c\u56db\u4e2a\u76d1\u542c\u5728 192.168.1.2:80 \u4e0a\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"server {\n    listen      192.168.100.1:80;\n    server_name example.org www.example.org;\n    ...\n}\n\nserver {\n    listen      192.168.100.1:80 default_server;\n    server_name example.net www.example.net;\n    ...\n}\n\nserver {\n    listen      192.168.100.1:80;\n    server_name example.com www.example.com;\n    ...\n}\n\nserver {\n    listen      192.168.1.2:80;\n    server_name example.com www.example.com;\n    ...\n}\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u4ece 192.168.100.1:80 \u4e0a\u8bf7\u6c42 ",(0,l.kt)("a",{parentName:"li",href:"http://www.example.com%EF%BC%8C%E8%83%BD%E5%8C%B9%E9%85%8D%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"},"www.example.com\uff0c\u80fd\u5339\u914d\u865a\u62df\u4e3b\u673a")," 3\uff0c\u4e8e\u662f\u4f7f\u7528\u865a\u62df\u4e3b\u673a 3 \u7684\u914d\u7f6e\u8fdb\u884c\u54cd\u5e94\uff1b"),(0,l.kt)("li",{parentName:"ul"},"\u4ece 192.168.100.1:80 \u4e0a\u8bf7\u6c42 ",(0,l.kt)("a",{parentName:"li",href:"http://www.speedy.com"},"www.speedy.com")," \u65f6\uff0c\u65e0\u6cd5\u5339\u914d\u4efb\u4f55\u865a\u62df\u4e3b\u673a\uff0c\u4e8e\u662f\u4f7f\u7528\u9ed8\u8ba4\u865a\u62df\u4e3b\u673a 2 \u7684\u914d\u7f6e\u8fdb\u884c\u54cd\u5e94\u3002\u5982\u679c\u5c06 listen \u7684\u5c5e\u6027 default","_","server \u53bb\u6389\uff0c\u5219\u4f7f\u7528\u865a\u62df\u4e3b\u673a 1 \u8fdb\u884c\u54cd\u5e94\uff1b"),(0,l.kt)("li",{parentName:"ul"},"\u4ece 192.168.1.2:80 \u4e0a\u8bf7\u6c42 ",(0,l.kt)("a",{parentName:"li",href:"http://www.example.com"},"www.example.com")," \u65f6\uff0c\u4f7f\u7528\u865a\u62df\u4e3b\u673a 4 \u8fdb\u884c\u54cd\u5e94\uff1b"),(0,l.kt)("li",{parentName:"ul"},"\u4ece 192.168.1.2:80 \u4e0a\u8bf7\u6c42 ",(0,l.kt)("a",{parentName:"li",href:"http://www.example.org"},"www.example.org")," \u65f6\uff0c\u7531\u4e8e\u65e0\u6cd5\u5339\u914d\u8be5\u5957\u63a5\u5b57\u4e0a\u7684\u4efb\u4f55\u4e3b\u673a\uff0c\u4e8e\u662f\u4f7f\u7528\u9ed8\u8ba4\u865a\u62df\u4e3b\u673a\u54cd\u5e94\uff0c\u5373\u865a\u62df\u4e3b\u673a 4\u3002")),(0,l.kt)("h3",{id:"755stub_status-\u6307\u4ee4\u83b7\u53d6-nginx-\u72b6\u6001\u4fe1\u606f"},"7.5.5\u3001stub","_","status \u6307\u4ee4\u83b7\u53d6 nginx \u72b6\u6001\u4fe1\u606f"),(0,l.kt)("p",null,"\u4f7f\u7528 ngx","_","http","_","stub","_","status","_","module \u6a21\u5757\u63d0\u4f9b\u7684\u529f\u80fd\u53ef\u4ee5\u83b7\u53d6 nginx \u8fd0\u884c\u7684\u72b6\u6001\u4fe1\u606f\u3002\u5bf9\u5e94\u7684\u6307\u4ee4\u53ea\u6709\u4e00\u4e2a\uff0c\u5373 stub","_","status\u3002"),(0,l.kt)("p",null,"\u4f8b\u5982\uff0c\u5728\u67d0\u4e00\u4e2a server \u4e0b\u52a0\u4e0a\u5982\u4e0b\u914d\u7f6e\u83b7\u53d6\u8be5 server \u7684\u72b6\u6001\u4fe1\u606f\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"server {\n    listen 80;\n    server_name www.speedy.com;\n    location / {\n        root /www/speedy/;\n        index index.html index.htm;\n    }\n    location /status {\n        stub_status on;\n    }\n}\n")),(0,l.kt)("p",null,"\u8fd8\u53ef\u4ee5\u660e\u786e\u6307\u5b9a\u8bbf\u95ee\u8be5\u4fe1\u606f\u4e0d\u8bb0\u5f55\u65e5\u5fd7\uff0c\u4e14\u63d0\u4f9b\u8bbf\u95ee\u63a7\u5236\uff0c\u4e0d\u8ba9\u5916\u754c\u4eba\u968f\u610f\u83b7\u53d6\u4fe1\u606f\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"location /status {\n    stub_status on;\n    access_log off;\n    allow 192.168.100.0/24;\n    deny all;\n}\n")),(0,l.kt)("p",null,'\u91cd\u8f7d\u914d\u7f6e\u6587\u4ef6\u540e\uff0c\u53ea\u9700\u5728\u6d4f\u89c8\u5668\u4e2d\u8f93\u5165 "\u4e3b\u673a\u540d/status" \u5373\u53ef\u83b7\u53d6\u4fe1\u606f\u3002'),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"Active connections: 291 \nserver accepts handled requests\n 16630948 16630948 31070465 \nReading: 6 Writing: 179 Waiting: 106\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u7b2c\u4e00\u884c active connections:291 \u8868\u793a\u5f53\u524d\u5904\u4e8e\u6d3b\u52a8\u72b6\u6001\u7684\u5ba2\u6237\u7aef\u8fde\u63a5\u6570\uff0c\u5305\u62ec\u6b63\u5904\u4e8e\u7b49\u5f85\u72b6\u6001\u7684\u8fde\u63a5\u3002")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u7b2c\u56db\u884c reading \u6570\u91cf\u4e3a 6\uff0c\u8868\u793a nginx \u6b63\u5728\u8bfb\u53d6\u8bf7\u6c42\u9996\u90e8\u7684\u6570\u91cf\uff0c\u5373\u6b63\u5728\u4ece socket recv buffer \u4e2d\u8bfb\u53d6\u6570\u636e\u7684\u6570\u91cf\uff1bwriting \u6570\u91cf\u4e3a 179 \u8868\u793a nginx \u6b63\u5728\u5c06\u54cd\u5e94\u6570\u636e\u5199\u5165 socket send buffer \u4ee5\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\u6570\u91cf\uff1bwaiting \u6570\u91cf\u4e3a 106 \u8868\u793a\u7b49\u5f85\u7a7a\u95f2\u5ba2\u6237\u7aef\u53d1\u8d77\u8bf7\u6c42\u7684\u5ba2\u6237\u7aef\u6570\u91cf\uff0c\u5305\u62ec\u957f\u8fde\u63a5\u72b6\u6001\u7684\u8fde\u63a5\u4ee5\u53ca\u5df2\u63a5\u5165\u4f46 socket recv buffer \u8fd8\u672a\u4ea7\u751f\u53ef\u8bfb\u4e8b\u4ef6\u7684\u8fde\u63a5\uff0c\u5176\u503c\u4e3a active-reading-writing\u3002")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u7b2c\u4e8c\u884c accepts \u7684\u6570\u91cf\u4e3a 16630948 \u8868\u793a\u4ece\u670d\u52a1\u542f\u52a8\u5f00\u59cb\u5230\u73b0\u5728\u5df2\u7ecf\u63a5\u6536\u8fdb\u6765\u7684\u603b\u7684\u5ba2\u6237\u7aef\u8fde\u63a5\u6570\uff1bhandled \u7684\u6570\u91cf\u4e3a 16630948 \u8868\u793a\u4ece\u670d\u52a1\u542f\u52a8\u4ee5\u6765\u5df2\u7ecf\u5904\u7406\u8fc7\u7684\u8fde\u63a5\u6570\uff0c\u4e00\u822c handled \u7684\u503c\u548c accepts \u7684\u503c\u76f8\u7b49\uff0c\u9664\u975e\u4f5c\u51fa\u4e86\u8fde\u63a5\u6570\u9650\u5b9a\uff1brequests \u7684\u6570\u91cf\u4e3a\u670d\u52a1\u542f\u52a8\u4ee5\u6765\u603b\u7684\u5ba2\u6237\u7aef\u8bf7\u6c42\u6570\u3002\u4e00\u4e2a\u8fde\u63a5\u53ef\u4ee5\u6709\u591a\u4e2a\u8bf7\u6c42\uff0c\u6240\u4ee5\u53ef\u4ee5\u8ba1\u7b97\u51fa\u5e73\u5747\u6bcf\u4e2a\u8fde\u63a5\u53d1\u51fa\u591a\u5c11\u4e2a\u8bf7\u6c42\u3002")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u4ee5\u4e0b\u662f\u7b2c\u4e8c\u884c\u51e0\u4e2a\u53c2\u6570\u7684\u5b98\u65b9\u539f\u6587\uff1a"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"accepts:  The total number of accepted client connections.\n\nhandled:  The total number of handled connections. Generally,the parameter value\n        is the same as accepts unless some resource limits have been reached \n        (for example, the worker_connections limit).\n\nrequests: The total number of client requests.\n")))),(0,l.kt)("h2",{id:"76\u8bbf\u95ee\u65e5\u5fd7-access_log"},"7.6\u3001\u8bbf\u95ee\u65e5\u5fd7 access","_","log"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"nginx \u7684\u8bbf\u95ee\u65e5\u5fd7\u76f8\u5173\u529f\u80fd\u7531 ngx","_","http","_","log","_","module \u6a21\u5757\u63d0\u4f9b\uff0c\u6307\u4ee4\u5305\u62ec log","_","format\u3001access","_","log \u548c open","_","log","_","file","_","cache\u3002"),(0,l.kt)("li",{parentName:"ol"},"nginx \u7684\u65e5\u5fd7\u53ef\u4ee5\u5148\u7f13\u51b2\u5230 buffer \u4e2d\uff0c\u4e00\u5b9a\u65f6\u95f4\u540e\u518d\u5199\u5165\u5230\u65e5\u5fd7\u6587\u4ef6\u4e2d\u3002\u4ece buffer \u5237\u76d8\u5230\u672c\u5730\u65e5\u5fd7\u6587\u4ef6\u4e2d\u65f6\uff0c\u53ef\u4ee5\u8fdb\u884c\u538b\u7f29\u3002"),(0,l.kt)("li",{parentName:"ol"},"nginx \u7684 worker \u8fdb\u7a0b\u7684\u8fd0\u884c\u8eab\u4efd\u9700\u8981\u6709\u65e5\u5fd7\u521b\u5efa\u7684\u6743\u9650\uff0c\u5373\u5bf9\u65e5\u5fd7\u6240\u5728\u76ee\u5f55\u6709\u5199\u6743\u9650\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u53ef\u4ee5\u5728\u591a\u79cd\u4e0a\u4e0b\u6587\u4e2d\u5b9a\u4e49\u662f\u5426\u5f00\u542f\u65e5\u5fd7\u4ee5\u53ca\u65e5\u5fd7\u7684\u683c\u5f0f\u3002\u6700\u5e38\u89c1\u7684\u4e09\u4e2a\u4e0a\u4e0b\u6587\u662f http, server, location\u3002"),(0,l.kt)("li",{parentName:"ol"},"open","_","log","_","file","_","cache \u6307\u4ee4\u5b58\u5728\u7684\u610f\u4e49\u662f\u4e3a\u4e86\u7f13\u5b58\u65e5\u5fd7\u6587\u4ef6\u63cf\u8ff0\u7b26\u3002\u4e4b\u6240\u4ee5\u63d0\u4f9b\u8fd9\u4e2a\u6307\u4ee4\uff0c\u662f",(0,l.kt)("strong",{parentName:"li"},"\u56e0\u4e3a nginx \u6bcf\u6b21\u65e5\u5fd7\u7684\u5199\u5165(\u4ece\u7f13\u5b58\u4e2d\u5237\u76d8\u5230\u672c\u5730\u65e5\u5fd7\u6587\u4ef6\u4e2d)\u90fd\u4f1a\u6253\u5f00\u3001\u5173\u95ed\u4e00\u6b21\u65e5\u5fd7\u6587\u4ef6"),"\u3002\u5bf9\u4e8e\u65e5\u5fd7\u5199\u5165\u6781\u5176\u9891\u7e41\u7684\u673a\u5668\u53ef\u4ee5\u4f7f\u7528\u8be5\u6307\u4ee4\u7f13\u5b58\u65e5\u5fd7\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u4f7f\u5f97\u5728\u7f13\u5b58\u6709\u6548\u671f\u5185\u90fd\u53ef\u4ee5\u7eed\u5199\u5230\u65e7\u65e5\u5fd7\u6587\u4ef6\u4e2d\u3002")),(0,l.kt)("h3",{id:"761log_format-\u6307\u4ee4"},"7.6.1\u3001log","_","format \u6307\u4ee4"),(0,l.kt)("p",null,"log","_","format \u6307\u5b9a\u65e5\u5fd7\u7684\u683c\u5f0f\uff0c\u8bed\u6cd5\u5982\u4e0b\uff1a",(0,l.kt)("inlineCode",{parentName:"p"},"log_format name string...;"),"\u3002\u5176\u4e2d name \u6307\u5b9a\u65e5\u5fd7\u683c\u5f0f\u540d\u79f0\uff0c\u914d\u7f6e\u6587\u4ef6\u4e2d name \u540d\u79f0\u4e0d\u80fd\u91cd\u590d\u3002"),(0,l.kt)("p",null,"\u4ee5\u4e0b\u662f\u9ed8\u8ba4\u63d0\u4f9b\u7684 main \u683c\u5f0f\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'#log_format  main  \'$remote_addr - $remote_user [$time_local] "$request" \'\n#                  \'$status $body_bytes_sent "$http_referer" \'\n#                  \'"$http_user_agent" "$http_x_forwarded_for"\';\n')),(0,l.kt)("p",null,"\u5728 main \u540e\u9762\u7684\u662f\u4e00\u5806\u53d8\u91cf\uff0c\u9664\u4e86\u8fd9\u4e9b\u53d8\u91cf\u4e4b\u5916\u8fd8\u6709\u5176\u4ed6\u5f88\u591a\u53d8\u91cf\u53ef\u7528\uff0c\u4f46\u5982\u975e\u7279\u6b8a\u9700\u6c42\uff0c\u9ed8\u8ba4\u7684 main \u683c\u5f0f\u5c31\u5df2\u7ecf\u591f\u5b8c\u7f8e\u4e86\u3002\u4ee5\u4e0b\u662f\u53d8\u91cf\u7684\u610f\u4e49\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'$remote_addr:           \u5ba2\u6237\u7aef\u7684\u5730\u5740\u3002\u5982\u679cnginx\u63d0\u4f9b\u7684web\u670d\u52a1\u5728\u540e\u7aef\uff0c\u5982\u524d\u9762\u6709\u4ee3\u7406\u670d\u52a1\u5668\u6216\u8d1f\u8f7d\u5747\u8861\u7b49\u8bbe\u5907\u65f6\uff0c\n                        \u8be5\u53d8\u91cf\u53ea\u80fd\u83b7\u53d6\u5230\u524d\u7aef\u7684IP\u5730\u5740\u3002\u6b64\u65f6\u8981\u83b7\u53d6\u5230\u771f\u6b63\u5ba2\u6237\u7aef\u5730\u5740\u9700\u8981\u4f7f\u7528\u53d8\u91cf$http_x_forward_for\uff0c\n                        \u4f46\u8981\u6c42\u524d\u7aef\u670d\u52a1\u5668\u8981\u5f00\u542fx_forward_for\u8bbe\u7f6e\u3002\n$http_x_forward_for:    \u5982\u4e0a\u6240\u8ff0\u3002\n$remote_user:           \u8fdc\u7a0b\u5ba2\u6237\u7aef\u7528\u6237\u540d\u79f0\u3002\n$time_local:            \u8bb0\u5f55\u8bbf\u95ee\u65f6\u95f4\u548c\u65f6\u533a\u4fe1\u606f\u3002\n$request:               \u8bb0\u5f55\u7528\u6237\u8bbf\u95ee\u65f6\u7684url\u548chttp\u534f\u8bae\u4fe1\u606f\u3002\u5982\uff1a"GET /favicon.ico HTTP/1.1"\u3002\n$status:                \u8bb0\u5f55\u5ba2\u6237\u7aef\u8bf7\u6c42\u65f6\u8fd4\u56de\u7684\u72b6\u6001\u7801\uff0c\u5982\u6210\u529f\u7684\u72b6\u6001\u7801\u4e3a200\uff0cpage not found\u7684\u72b6\u6001\u7801\u4e3a404\u3002\n$body_bytes_sent:       \u8bb0\u5f55\u670d\u52a1\u5668\u54cd\u5e94\u7ed9\u5ba2\u6237\u7aef\u7684\u4e3b\u4f53\u5927\u5c0f\u3002\n$http_referer:          \u8bb0\u5f55\u6b64\u6b21\u8bf7\u6c42\u662f\u4ece\u54ea\u4e2a\u94fe\u63a5\u8fc7\u6765\u7684\uff0c\u9700\u8981\u6a21\u5757ngx_http_referer_module\u652f\u6301\uff0c\u9ed8\u8ba4\u5df2\u88c5\uff0c\u53ef\u4ee5\u9632\u6b62\u5012\u94fe\u95ee\u9898\u3002\n$http_user_agent:       \u8bb0\u5f55\u5ba2\u6237\u7aef\u7684\u6d4f\u89c8\u5668\u4fe1\u606f\u3002\u5982\u4f7f\u7528\u4ec0\u4e48\u6d4f\u89c8\u5668\u53d1\u8d77\u7684\u8bf7\u6c42\uff0c\u662f\u5426\u662f\u538b\u529b\u6d4b\u8bd5\u5de5\u5177\u5728\u6d4b\u8bd5\u7b49\u3002\n')),(0,l.kt)("p",null,"\u4f8b\u5982\uff0c\u4ee5\u4e0b\u662f\u9ed8\u8ba4\u683c\u5f0f\u7684\u65e5\u5fd7\u4fe1\u606f\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'192.168.0.107 - - [31/Oct/2021:04:01:43 +0800] "GET /status HTTP/1.1" 200 97 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.54 Safari/537.36"\n192.168.0.107 - - [31/Oct/2021:04:01:43 +0800] "GET /favicon.ico HTTP/1.1" 404 571 "http://192.168.0.99/status" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.54 Safari/537.36"\n192.168.0.107 - - [31/Oct/2021:04:02:26 +0800] "GET /status HTTP/1.1" 200 97 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.54 Safari/537.36"\n')),(0,l.kt)("h3",{id:"762access_log-\u6307\u4ee4"},"7.6.2\u3001access","_","log \u6307\u4ee4"),(0,l.kt)("p",null,"access","_","log \u4e3b\u8981\u7528\u4e8e\u5b9a\u4e49\u4f7f\u7528\u4ec0\u4e48\u683c\u5f0f\u7684\u65e5\u5fd7\uff0c\u65e5\u5fd7\u5b58\u653e\u8def\u5f84\u3002\u8bed\u6cd5\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"access_log path [format [buffer=size] [gzip[=level]] [flush=time] [if=condition]];\naccess_log off;\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"path \u6307\u5b9a\u8def\u5f84\uff0cpath \u91cc\u53ef\u4ee5\u4f7f\u7528\u53d8\u91cf\u3002"),(0,l.kt)("li",{parentName:"ul"},"format \u6307\u5b9a\u65e5\u5fd7\u683c\u5f0f\uff0c\u4e0d\u5199\u65f6\u6216\u8005\u914d\u7f6e\u6587\u4ef6\u4e2d\u672a\u914d\u7f6e access","_","log \u6307\u4ee4\u65f6\uff0c\u9ed8\u8ba4\u4e3a combined\u3002"),(0,l.kt)("li",{parentName:"ul"},"buffer=size \u6307\u5b9a\u65e5\u5fd7\u7f13\u51b2\u533a\u5927\u5c0f(\u9ed8\u8ba4 64K)\uff0cflush=time \u6307\u5b9a\u65e5\u5fd7\u5237\u76d8\u7684\u65f6\u95f4\uff0cif=condition \u6307\u5b9a\u67d0\u4e9b\u6761\u4ef6\uff0cgzip=level \u6307\u5b9a\u65e5\u5fd7\u5237\u76d8\u524d\u5148\u538b\u7f29\u7684\u538b\u7f29\u7ea7\u522b(\u9ed8\u8ba4 gzip=1)\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u5f53\u6307\u5b9a\u4e86 buffer \u6216\u8005 gzip \u4efb\u610f\u4e00\u4e2a\u65f6\uff0c\u90fd\u4f1a\u4f7f\u7528 buffer \u5148\u7f13\u51b2\u65e5\u5fd7\uff0c\u7136\u540e\u518d\u5237\u76d8\u3002")),(0,l.kt)("p",null,"\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"access_log /spool/logs/nginx-access.log gzip buffer=32k;\n")),(0,l.kt)("h3",{id:"763\u65e5\u5fd7\u6587\u4ef6\u7684\u5206\u5272"},"7.6.3\u3001\u65e5\u5fd7\u6587\u4ef6\u7684\u5206\u5272"),(0,l.kt)("p",null,"\u9ed8\u8ba4 nginx \u4e0d\u4f1a\u81ea\u52a8\u5206\u5272\u65e5\u5fd7\uff0c\u4e5f\u4e0d\u652f\u6301\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u4f7f\u7528 cronolog \u4ee5\u53ca rotatelogs(apache \u652f\u6301\uff0c\u56e0\u4e3a\u652f\u6301\u7ba1\u9053\u4f20\u9012)\u3002\u8981\u5b9e\u73b0 nginx \u7684\u65e5\u5fd7\u5206\u5272\uff0c\u9700\u8981\u901a\u8fc7\u79fb\u52a8\u65e7\u65e5\u5fd7\u3001\u751f\u6210\u65b0\u65e5\u5fd7\u6765\u5b9e\u73b0\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"mv old_log new_log\n# \u7136\u540e\nnginx -s reload\n# \u6216\u8005\nnginx -s reopen\n# \u6216\u8005\nkill -s USR1 master_pid\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"pid \u53ef\u4ee5\u901a\u8fc7 pid \u6587\u4ef6\u83b7\u5f97\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kill -s USR1 $(cat /var/run/nginx/nginx.pid)\n")))),(0,l.kt)("p",null,"\u8981\u5b9e\u73b0\u81ea\u52a8\u5206\u5272\uff0c\u9700\u8981\u4f7f\u7528\u811a\u672c\uff0c\u5e76\u8bbe\u7f6e\u5b9a\u65f6\u4efb\u52a1\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'[root@aarch64 ~]# cat /usr/local/nginx/sbin/log_split.sh\n#!/bin/bash\n\n# cut the access log for www.speedy.com\n\nbasedir=/usr/local/nginx\nold_log_path=$basedir/logs/access.log\nlog_save_path=$basedir/logs\nsave_log_name=access_$(date -d "yesterday" +"%Y%m%d").log\n\n[ -f "$old_log_path" ] || exit 1\n/bin/mv $old_log_path $log_save_path/$save_log_name\n$basedir/sbin/nginx -s reopen\n[root@aarch64 ~]# chmod +x /usr/local/nginx/sbin/log_split.sh\n')),(0,l.kt)("p",null,"\u518d\u6dfb\u52a0\u5b9a\u65f6\u4efb\u52a1\u8ba1\u5212\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"crontab -e\n00 00 * * * /usr/local/nginx/sbin/log_split.sh &>/dev/null\n")),(0,l.kt)("h2",{id:"77\u914d\u7f6e-web-\u8eab\u4efd\u8ba4\u8bc1"},"7.7\u3001\u914d\u7f6e web \u8eab\u4efd\u8ba4\u8bc1"),(0,l.kt)("p",null,"\u9700\u8981\u8f93\u5165\u7528\u6237\u540d\u548c\u5bc6\u7801\u624d\u80fd\u8bbf\u95ee\u7ad9\u70b9\u7684\u529f\u80fd\u4e3a web \u8eab\u4efd\u8ba4\u8bc1\u529f\u80fd\u3002nginx \u4e2d\u7531 ngx","_","http","_","auth","_","basic","_","module \u6a21\u5757\u63d0\u4f9b\u8be5\u529f\u80fd\u3002\u6307\u4ee4\u5305\u62ec auth","_","basic \u548c auth","_","basic","_","user","_","file\u3002\u8fd9\u4e24\u4e2a\u6307\u4ee4\u53ef\u4ee5\u5728 http \u6839\u6bb5\u3001server \u6bb5\u3001location \u6bb5\u4f7f\u7528\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"auth_basic string | off\nauth_basic_user_file path/to/user_passwd_file        # \u5bc6\u7801\u6587\u4ef6\u4f7f\u7528\u76f8\u5bf9\u8def\u5f84\u65f6\u662f\u76f8\u5bf9conf\u76ee\u5f55\u7684\n")),(0,l.kt)("p",null,"passwd","_","file \u7684\u683c\u5f0f\u4e3a\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"user1:passwd1\nuser2:passwd2\n")),(0,l.kt)("p",null,"\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5bc6\u7801\u6587\u4ef6\u4e0d\u80fd\u4f7f\u7528\u660e\u6587\u5bc6\u7801\u7684\u65b9\u5f0f\u3002\u8be5\u7c7b\u6587\u4ef6\u4e00\u822c\u4f7f\u7528 apache \u63d0\u4f9b\u7684\u5de5\u5177 htpasswd \u751f\u6210\uff0c\u8be5\u5de5\u5177\u5728 httpd-tools \u5305\u4e2d\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 openssl passwd \u751f\u6210\u76f8\u5173\u5bc6\u7801\u7136\u540e\u590d\u5236\u5230\u5bc6\u7801\u6587\u4ef6\u4e2d\u3002\u4ee5\u4e0b\u662f\u4e00\u4e2a\u793a\u4f8b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'server {\n    listen 80;\n    server_name www.brinnatt.com  www1.brinnatt.com;\n    location / {\n        root /www/brinnatt/;\n        index index.html index.htm;\n        auth_basic "Auth your name";\n        auth_basic_user_file /usr/local/nginx/conf/htpasswd;\n    }\n}\n')),(0,l.kt)("p",null,"\u7136\u540e\u4f7f\u7528 htpasswd \u751f\u6210\u5bc6\u7801\u6587\u4ef6 /usr/local/nginx/conf/htpasswd\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# yum -y install httpd-tools\n[root@aarch64 ~]# htpasswd -b -c -m /usr/local/nginx/conf/htpasswd Brinnatt CharMan\nAdding password for user Brinnatt\n[root@aarch64 ~]# htpasswd -b -m /usr/local/nginx/conf/htpasswd Speedy Pretty\nAdding password for user Speedy\n[root@aarch64 ~]# cat /usr/local/nginx/conf/htpasswd \nBrinnatt:$apr1$6x9yU/rm$XXWnzw4PWVJN9i859bP921\nSpeedy:$apr1$dXFV83fw$Qg2PdbMgmDqH6DsHM7CRP.\n[root@aarch64 ~]#\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"-b")," \u9009\u9879\u662f\u8868\u793a batch \u6a21\u5f0f\uff0c\u4e0d\u7528\u4ea4\u4e92\u8f93\u5165\u5bc6\u7801\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"-c")," \u8868\u793a\u521b\u5efa\u5bc6\u7801\u6587\u4ef6\uff0c\u53ea\u80fd\u4e3a\u7b2c\u4e00\u4e2a\u7528\u6237\u4f7f\u7528\u8be5\u9009\u9879\uff0c\u5426\u5219\u540e\u9762\u4f7f\u7528\u4f1a\u8986\u76d6\u524d\u9762\u5df2\u7ecf\u521b\u5efa\u8fc7\u7684\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"-m")," \u8868\u793a\u5f3a\u5236\u4f7f\u7528 md5\u3002Brinnatt \u548c Speedy \u662f\u9700\u8981\u9a8c\u8bc1\u7684\u7528\u6237\u540d\uff0cCharMan \u548c Pretty \u662f\u5bf9\u5e94\u7684\u5bc6\u7801\u3002")),(0,l.kt)("p",null,"\u7136\u540e\u91cd\u8f7d\u914d\u7f6e\u6587\u4ef6\uff0c\u5728\u6d4f\u89c8\u5668\u4e2d\u6d4b\u8bd5\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# nginx -s reload\n")),(0,l.kt)("h2",{id:"78\u914d\u7f6e-https"},"7.8\u3001\u914d\u7f6e https"),(0,l.kt)("p",null,"https \u529f\u80fd\u7531 ngx","_","http","_","ssl","_","module \u6a21\u5757\u63d0\u4f9b\u3002https \u8fde\u63a5\u7684\u8ba4\u8bc1\u8fc7\u7a0b\u53c2\u89c1 ",(0,l.kt)("a",{parentName:"p",href:"https://www.brinnatt.com/addons/%e7%ac%ac-c-1-%e7%ab%a0-linux-%e5%8a%a0%e5%af%86%e3%80%81%e7%ad%be%e5%90%8d%e5%92%8c-ssl-%e6%8f%a1%e6%89%8b%e6%9c%ba%e5%88%b6/"},"SSL \u63e1\u624b\u673a\u5236"),"\u3002\u5927\u81f4\u8fc7\u7a0b\u5982\u4e0b\uff1a"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u5ba2\u6237\u7aef say hello\uff0c\u5e76\u53d1\u9001\u4e00\u4e2a\u968f\u673a\u6570\u7ed9\u670d\u52a1\u7aef\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u670d\u52a1\u7aef say hello\uff0c\u5e76\u56de\u590d\u4e00\u4e2a\u968f\u673a\u6570\u7ed9\u5ba2\u6237\u7aef\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u670d\u52a1\u7aef\u53d1\u9001\u6570\u5b57\u8bc1\u4e66\u7ed9\u5ba2\u6237\u7aef\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u5ba2\u6237\u7aef\u4f7f\u7528\u4fe1\u4efb\u7684 CA \u516c\u94a5\u89e3\u5bc6\u6570\u5b57\u8bc1\u4e66\u5f97\u5230\u670d\u52a1\u7aef\u7684\u516c\u94a5\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u5ba2\u6237\u7aef\u4f7f\u7528\u670d\u52a1\u7aef\u7684\u516c\u94a5\u52a0\u5bc6\u4e00\u4e2a\u9884\u5907\u4e3b\u5bc6\u94a5\u5e76\u53d1\u9001\u7ed9\u670d\u52a1\u7aef\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u670d\u52a1\u7aef\u4f7f\u7528\u81ea\u5df1\u7684\u79c1\u94a5\u89e3\u5bc6\u9884\u5907\u4e3b\u5bc6\u94a5\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u53cc\u65b9\u90fd\u5f97\u5230\u4e86 2 \u4e2a\u968f\u673a\u6570\u52a0\u4e00\u4e2a\u9884\u5907\u4e3b\u5bc6\u94a5\u3002\u901a\u8fc7\u8fd9 3 \u4e2a\u968f\u673a\u6570\u5f62\u6210\u4e00\u4e2a\u4f1a\u8bdd\u4e3b\u5bc6\u94a5\uff0c\u5373 session key\u3002\u81f3\u6b64 ssl \u63e1\u624b\u7ed3\u675f\uff0c\u8fde\u63a5\u7684\u8ba4\u8bc1\u8fc7\u7a0b\u4e5f\u5b8c\u6bd5\u3002")),(0,l.kt)("p",null,"\u5bf9\u4e8e\u670d\u52a1\u7aef\u800c\u8a00\uff0c\u5728\u914d\u7f6e https \u65f6\uff0c\u9700\u8981\u63d0\u4f9b\u81ea\u5df1\u7684\u6570\u5b57\u8bc1\u4e66\u7528\u4e8e\u53d1\u9001\u7ed9\u5ba2\u6237\u7aef\uff0c\u8fd8\u8981\u63d0\u4f9b\u81ea\u5df1\u7684\u79c1\u94a5\u7528\u4e8e\u89e3\u5bc6\u5ba2\u6237\u7aef\u53d1\u9001\u7684\u9884\u5907\u4e3b\u5bc6\u94a5\u3002\u5f53 ssl \u8fde\u63a5\u5efa\u7acb\u5b8c\u6210\u540e\uff0c\u540e\u7eed\u8fde\u63a5\u8981\u4f20\u8f93\u7684\u6570\u636e\u90fd\u91c7\u7528 session key \u8fdb\u884c\u52a0\u5bc6\uff0c\u4f46\u6ce8\u610f session key \u662f\u5bf9\u79f0\u52a0\u5bc6\uff0c\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u662f\u4e00\u6837\u7684\u3002"),(0,l.kt)("p",null,"\u8fd8\u9700\u6ce8\u610f\uff0c\u5728\u521b\u5efa\u8bc1\u4e66\u8bf7\u6c42\u65f6\uff0c\u7531\u4e8e\u9700\u8981\u6307\u5b9a common name\uff0c\u8fd9\u65f6\u9700\u8981\u4f7f\u7528 https \u7684\u7ad9\u70b9\uff0c\u56e0\u6b64\u6bcf\u4e2a ssl \u8bc1\u4e66\u53ea\u80fd\u4e3a\u4e00\u4e2a server","_","name \u63d0\u4f9b https \u670d\u52a1\u3002\u4e0d\u8fc7\uff0c\u901a\u8fc7\u7279\u6b8a\u7684\u914d\u7f6e\u65b9\u6cd5\uff0c\u4e5f\u80fd\u8ba9\u4e00\u4e2a ssl \u8bc1\u4e66\u670d\u52a1\u4e8e\u6574\u4e2a\u57df\u540d\u6216\u57df\u540d\u5185\u7684\u67d0\u4e9b\u4e3b\u673a\u3002"),(0,l.kt)("p",null,"\u4ee5\u4e0b\u662f\u914d\u7f6e\u6587\u4ef6\u4e2d\u9ed8\u8ba4\u7684\u5173\u4e8e SSL \u76f8\u5173\u7684\u6307\u4ee4\u8bbe\u7f6e\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"#server {\n#    listen       443 ssl;\n#    server_name  localhost;\n\n#    ssl_certificate      cert.pem;\n#    ssl_certificate_key  cert.key;\n\n#    ssl_session_cache    shared:SSL:1m;\n#    ssl_session_timeout  5m;\n\n#    ssl_ciphers  HIGH:!aNULL:!MD5;\n#    ssl_prefer_server_ciphers  on;\n\n#    location / {\n#        root   html;\n#        index  index.html index.htm;\n#    }\n#}\n")),(0,l.kt)("p",null,"\u4ee5\u4e0b\u662f\u5efa\u7acb https \u7684\u76f8\u5173\u8fc7\u7a0b\uff1a"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"\u81ea\u5efa CA\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# cd /etc/pki/CA/\n[root@aarch64 CA]# tree .\n.\n\u251c\u2500\u2500 certs\n\u251c\u2500\u2500 crl\n\u251c\u2500\u2500 newcerts\n\u2514\u2500\u2500 private\n\n4 directories, 0 files\n[root@aarch64 CA]# (umask 077;openssl genrsa -out private/cakey.pem 2048)\nGenerating RSA private key, 2048 bit long modulus\n.......+++\n.........................+++\ne is 65537 (0x10001)\n[root@aarch64 CA]# tree .\n.\n\u251c\u2500\u2500 certs\n\u251c\u2500\u2500 crl\n\u251c\u2500\u2500 newcerts\n\u2514\u2500\u2500 private\n   \u2514\u2500\u2500 cakey.pem\n\n4 directories, 1 file\n[root@aarch64 CA]#\n[root@aarch64 CA]# openssl req -new -x509 -key private/cakey.pem -out cacert.pem -days 3650\nYou are about to be asked to enter information that will be incorporated\ninto your certificate request.\nWhat you are about to enter is what is called a Distinguished Name or a DN.\nThere are quite a few fields but you can leave some blank\nFor some fields there will be a default value,\nIf you enter '.', the field will be left blank.\n-----\nCountry Name (2 letter code) [XX]:CN\nState or Province Name (full name) []:Hunan\nLocality Name (eg, city) [Default City]:Changsha\nOrganization Name (eg, company) [Default Company Ltd]:Secret   \nOrganizational Unit Name (eg, section) []:Secret\nCommon Name (eg, your name or your server's hostname) []:aarch64       \nEmail Address []:Secret\n[root@aarch64 CA]#\n"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"\u5efa\u7acb\u76f8\u5173\u5e8f\u5217\u548c\u7d22\u5f15\u6587\u4ef6\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'[root@aarch64 CA]# touch index.txt\n[root@aarch64 CA]# echo "01" > serial\n'))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"nginx \u7aef\u751f\u6210\u8bc1\u4e66\u8bf7\u6c42\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 CA]# (umask 077;openssl genrsa -out /usr/local/nginx/aarch64.key 2048)\nGenerating RSA private key, 2048 bit long modulus\n....................................................................................................................................+++\n........................................+++\ne is 65537 (0x10001)\n[root@aarch64 CA]# openssl req -new -key /usr/local/nginx/aarch64.key -out /usr/local/nginx/aarch64.csr\n"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"CA \u4e3a\u8bc1\u4e66\u8bf7\u6c42\u9881\u53d1\u8bc1\u4e66\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# openssl ca -in /usr/local/nginx/aarch64.csr -out aarch64.crt\nUsing configuration from /etc/pki/tls/openssl.cnf\nCheck that the request matches the signature\nSignature ok\nCertificate Details:\n       Serial Number: 1 (0x1)\n       Validity\n           Not Before: Oct 31 12:36:48 2021 GMT\n           Not After : Oct 31 12:36:48 2022 GMT\n       Subject:\n           countryName               = CN\n           stateOrProvinceName       = Hunan\n           organizationName          = Secret\n           organizationalUnitName    = Secret\n           commonName                = aarch64\n           emailAddress              = Secret\n       X509v3 extensions:\n           X509v3 Basic Constraints: \n               CA:FALSE\n           Netscape Comment: \n               OpenSSL Generated Certificate\n           X509v3 Subject Key Identifier: \n               8B:C5:60:D6:A2:83:C0:99:26:8D:2B:1A:B0:4E:AE:BA:E6:08:8C:9D\n           X509v3 Authority Key Identifier: \n               keyid:19:E1:DE:4A:F3:88:65:99:0F:B7:9C:5F:1B:80:13:7A:6A:BE:64:05\n\nCertificate is to be certified until Oct 31 12:36:48 2022 GMT (365 days)\nSign the certificate? [y/n]:y\n\n1 out of 1 certificate requests certified, commit? [y/n]y\nWrite out database with 1 new entries\nData Base Updated\n[root@aarch64 ~]#\n"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"\u5c06\u9881\u53d1\u7684\u8bc1\u4e66\u53d1\u9001\u7ed9 nginx \u7aef\u3002\u8fd9\u91cc\u7531\u4e8e CA \u548c nginx \u5728\u540c\u4e00\u4e3b\u673a\u4e0a\uff0c\u6240\u4ee5\u76f4\u63a5\u79fb\u52a8\u5373\u53ef\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# mv aarch64.crt /usr/local/nginx/\n")),(0,l.kt)("p",{parentName:"li"},"\u6b64\u65f6\uff0c\u5728 /usr/local/nginx/ \u76ee\u5f55\u4e0b\u5c31\u6709\u4e86 nginx \u81ea\u5df1\u7684",(0,l.kt)("strong",{parentName:"p"},"\u79c1\u94a5\u6587\u4ef6\u548c\u8bc1\u4e66\u6587\u4ef6"),"\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# cd /usr/local/nginx\n[root@aarch64 nginx]# ls aarch64.*\naarch64.crt  aarch64.csr  aarch64.key\n"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u914d\u7f6e ssl \u76f8\u5173\u9009\u9879\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"server {\n   listen       443 ssl;\n   server_name  www.aarch64.com;\n\n   ssl_certificate      /usr/local/nginx/aarch64.crt;\n   ssl_certificate_key  /usr/local/nginx/aarch64.key;\n\n   ssl_session_cache    shared:SSL:1m;\n   ssl_session_timeout  5m;\n\n   ssl_ciphers  HIGH:!aNULL:!MD5;\n   ssl_prefer_server_ciphers  on;\n\n   location / {\n       root   html;\n       index  index.html index.htm;\n   }\n}\n"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"\u91cd\u8f7d\u914d\u7f6e\u6587\u4ef6\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# nginx -s reload\n"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"\u6d4b\u8bd5\u3002\u5728\u6d4f\u89c8\u5668\u4e0a\u8f93\u5165 ",(0,l.kt)("inlineCode",{parentName:"p"},"https://www.aarch64.com")," \u6d4b\u8bd5\u3002\u5c06\u4f1a\u63d0\u793a\u8bc1\u4e66\u5b89\u5168\u5b58\u5728\u95ee\u9898\uff0c\u8bf4\u660e\u914d\u7f6e\u6210\u529f\u3002\u4ee5\u540e\u53ea\u8981\u5728\u5ba2\u6237\u7aef\u5b89\u88c5\u8bc1\u4e66\u5373\u53ef\u6b63\u5e38\u8bbf\u95ee\u3002\u6d4b\u8bd5\u65f6\uff0c\u5efa\u8bae\u4f7f\u7528 IE \u6d4f\u89c8\u5668\u6216\u4f7f\u7528 IE \u5185\u6838\u7684\u6d4f\u89c8\u5668\u6d4b\u8bd5\uff0c\u8fd9\u6837\u6bd4\u8f83\u76f4\u89c2\u3002\u4f7f\u7528 firefox\u3001chrome \u7b49\u6d4f\u89c8\u5668\u53ef\u80fd\u4f1a\u56e0\u4e3a\u662f\u81ea\u5efa\u7684 CA \u800c\u51fa\u73b0\u4e00\u4e9b\u95ee\u9898\u3002"))),(0,l.kt)("h2",{id:"79nginx-\u7248\u672c\u5e73\u7a33\u5207\u6362"},"7.9\u3001nginx \u7248\u672c\u5e73\u7a33\u5207\u6362"),(0,l.kt)("p",null,"\u5728\u8bf4\u660e\u5982\u4f55\u7a33\u5b9a\u5b89\u5168\u5730\u5347\u7ea7\u3001\u964d\u7ea7\u8fd0\u884c\u4e2d\u7684 nginx \u4e4b\u524d\uff0c\u9700\u8981\u5148\u4e86\u89e3 nginx \u652f\u6301\u7684\u51e0\u79cd\u4fe1\u53f7\u3002\u4ee5\u4e0b\u51e0\u79cd\u662f\u4e3b\u8fdb\u7a0b\u53ef\u4ee5\u63a5\u6536\u7684\u4fe1\u53f7\uff0c\u6ce8\u610f worker \u8fdb\u7a0b\u4e5f\u53ef\u4ee5\u63a5\u6536\u4e00\u4e9b\u4fe1\u53f7\uff0c\u4f46\u548c\u4e3b\u8fdb\u7a0b\u7684\u4fe1\u53f7\u5904\u7406\u673a\u5236\u6709\u4e9b\u4e0d\u4e00\u6837\uff0c\u4e14\u4e3b\u8fdb\u7a0b\u652f\u6301\u7684\u4fe1\u53f7 worker \u8fdb\u7a0b\u4e0d\u4e00\u5b9a\u652f\u6301\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"SIGINT, SIGTERM  \u7acb\u5373\u6740\u6389nginx\u4e3b(\u5373\u6240\u6709\u8fdb\u7a0b)\nSIGQUIT          graceful stop\u4e3b\u8fdb\u7a0b\nSIGWINCH         graceful stop\u6240\u6709\u7684worker\u8fdb\u7a0b\nSIGHUP           reload\u914d\u7f6e\u6587\u4ef6\uff0c\u5e76\u4f7f\u8001\u7684worker\u8fdb\u7a0bgraceful stop\nSIGUSR1          \u91cd\u65b0\u6253\u5f00\u65e5\u5fd7\u6587\u4ef6(Reopen log files)\nSIGUSR2          \u5728\u7ebf\u5207\u6362nginx\u53ef\u6267\u884c\u7a0b\u5e8f(Upgrade the nginx executable on the fly)\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"graceful stop \u7684\u884c\u4e3a\u662f\uff1a(1) \u8fdb\u7a0b\u4e0d\u518d\u76d1\u542c\u3001\u63a5\u53d7\u65b0\u7684\u8bf7\u6c42\uff1b(2) \u8fdb\u7a0b\u7ee7\u7eed\u5904\u7406\u6b63\u5728\u5904\u7406\u7684\u8bf7\u6c42\uff0c\u4f46\u5904\u7406\u5b8c\u6210\u540e\u9500\u6bc1\u3002")),(0,l.kt)("h3",{id:"791\u5347\u7ea7"},"7.9.1\u3001\u5347\u7ea7"),(0,l.kt)("p",null,"\u5982\u679c\u60f3\u5bf9\u4e00\u4e2a\u5df2\u8fd0\u884c\u7684 nginx \u5b9e\u4f8b\u8fdb\u884c\u7248\u672c\u5347\u7ea7\uff0c\u6216\u8005\u56e0\u4e3a\u91cd\u65b0\u7f16\u8bd1\u4e86\u4e00\u4e2a\u7248\u672c\u800c\u66ff\u6362\u65e7\u7248\u672c\uff0c\u53ef\u4ee5\u8003\u8651\u6309\u7167\u4ee5\u4e0b\u4e00\u7cfb\u5217\u8fc7\u7a0b\u6765\u5e73\u7a33\u3001\u5b89\u5168\u5730\u5347\u7ea7\u3002\u5f53\u7136\uff0c\u5982\u679c\u76f4\u63a5\u505c\u6b62\u670d\u52a1\u4e0d\u4f1a\u4ea7\u751f\u591a\u5927\u5f71\u54cd\uff0c\u76f4\u63a5\u505c\u6389\u518d\u542f\u52a8\u65b0\u7248\u672c nginx \u5b9e\u4f8b\u66f4\u65b9\u4fbf\u7b80\u5355\u3002"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"\u5c06\u65b0\u7248\u672c\u7684 nginx \u547d\u4ee4\u8def\u5f84\u66ff\u6362\u6389\u65e7\u7684 nginx \u547d\u4ee4\u3002"),(0,l.kt)("p",{parentName:"li"},"\u901a\u5e38\uff0c\u5bf9\u4e8e\u7f16\u8bd1\u5b89\u88c5\u7684 nginx \u6765\u8bf4\uff0c\u91c7\u7528\u8f6f\u94fe\u63a5\u7684\u65b9\u5f0f\u6bd4\u8f83\u4fbf\u6377\u3002"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u4f8b\u5982\u65e7\u7248\u672c\u7684\u5b89\u88c5\u8def\u5f84\u4e3a /usr/local/nginx-1.12.1\uff0c\u4e3a\u5176\u5efa\u7acb\u4e00\u4e2a\u8f6f\u94fe\u63a5 /usr/local/nginx\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u5982\u679c\u6709\u65b0\u7248\u672c /usr/local/nginx-1.12.2\uff0c\u53ea\u9700\u4fee\u6539\u8f6f\u94fe\u63a5 /usr/local/nginx \u7684\u6307\u5411\u76ee\u6807\u4e3a /usr/local/nginx-1.12.1 \u5373\u53ef\u3002\u8fd9\u6837 /usr/local/nginx/sbin/nginx \u5c31\u4f1a\u968f\u7740\u8f6f\u94fe\u63a5\u7684\u6307\u5411\u6539\u53d8\u800c\u6307\u5411\u65b0 nginx \u7a0b\u5e8f\u3002")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# \u5f53\u524d\u7f16\u8bd1\u4e86\u4e24\u4e2a\u7248\u672c\u7684nginx\uff0c\u5982\u4e0b\u5f88\u65b9\u4fbf\u5e73\u6ed1\u5207\u6362\n[root@aarch64 ~]# ln -sv /usr/local/nginx-1.12.1/ /usr/local/nginx\n\u2018/usr/local/nginx\u2019 -> \u2018/usr/local/nginx-1.12.1/\u2019\n[root@aarch64 ~]# systemctl start nginx\n[root@aarch64 ~]# nginx -v\nnginx version: nginx/1.12.1\n[root@aarch64 ~]# \n[root@aarch64 ~]# ln -snfv /usr/local/nginx-1.12.2/ /usr/local/nginx\n\u2018/usr/local/nginx\u2019 -> \u2018/usr/local/nginx-1.12.2/\u2019\n[root@aarch64 ~]# nginx -v\nnginx version: nginx/1.12.2\n[root@aarch64 ~]#\n")),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"\u6ce8\u610f"),"\uff1aln -snfv \u5176\u4e2d\u7684 -n \u9009\u9879\u5f88\u91cd\u8981\uff0c\u4e0d\u7136\u5f97\u4e0d\u5230\u60f3\u8981\u7684\u7ed3\u679c\u3002"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"\u5bf9\u65e7 nginx \u5b9e\u4f8b\u7684\u4e3b\u8fdb\u7a0b\u53d1\u9001 USR2 \u4fe1\u53f7\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# kill -USR2 cat /var/run/nginx/nginx.pid\n")),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u8be5\u4fe1\u53f7\u63d0\u793a nginx \u65e7\u7684\u4e3b\u8fdb\u7a0b\u8981\u5347\u7ea7\uff0c\u5e76\u6267\u884c\u65b0\u7684 nginx \u7a0b\u5e8f\u3002"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u4f8b\u5982\u6b65\u9aa4 1 \u4e2d\uff0c\u65e7\u7684 nginx \u4e3b\u8fdb\u7a0b\u4e3a /usr/local/nginx/sbin/nginx\uff0c\u4f46\u5176\u6307\u5411\u7684\u662f /usr/local/nginx-1.12.1/sbin/nginx\uff0c\u53d1\u9001\u8be5\u4fe1\u53f7\u540e\u4ecd\u5c06\u6267\u884c /usr/local/nginx/sbin/nginx\uff0c\u4f46\u6b64\u65f6\u56e0\u4e3a\u8f6f\u94fe\u63a5\u76ee\u6807\u5df2\u6539\u53d8\uff0c\u4f7f\u5f97\u6b64\u65f6\u542f\u52a8\u7684 nginx \u5df2\u7ecf\u662f /usr/local/nginx-1.12.2/sbin/nginx \u7a0b\u5e8f\u3002")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# ps aux | egrep '(ngin[x]|PI[D])'\nUSER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nroot      8900  0.0  0.0   9920  2140 ?        Ss   23:08   0:00 nginx: master process /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf\nnginx     8901  0.0  0.0  10492  3504 ?        S    23:08   0:00 nginx: worker process\nroot      8923  0.0  0.0   9924  5300 ?        S    23:11   0:00 nginx: master process /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf\nnginx     8924  0.0  0.0  10496  3592 ?        S    23:11   0:00 nginx: worker process\n[root@aarch64 ~]#\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u6b64\u5916\uff0c\u53d1\u9001\u8be5\u4fe1\u53f7\u540e\u5c06\u4f1a\u5207\u6362 pid \u6587\u4ef6\uff0c\u65e7\u7684 pid \u6587\u4ef6\u88ab\u91cd\u547d\u540d\u4e3a nginx.pid.oldbin\uff0c\u8bb0\u5f55\u7684\u662f\u65e7\u7684 nginx \u4e3b\u8fdb\u7a0b pid \u503c\uff0c\u65b0\u7684 pid \u6587\u4ef6\u4e3a nginx.pid\uff0c\u8bb0\u5f55\u7684\u662f\u65b0\u542f\u52a8\u7684 nginx \u7684\u4e3b\u8fdb\u7a0b pid \u503c\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# ls /var/run/nginx/\nnginx.pid  nginx.pid.oldbin\n[root@aarch64 ~]#\n"))))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"\u8fd9\u4e00\u6b65\u4e0e\u7b2c 4 \u6b65\u4efb\u9009\u4e00\u4e2a\uff0cgraceful stop \u65e7\u7684\u4e3b\u8fdb\u7a0b\u53f7\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# kill -QUIT cat /var/run/nginx/nginx.pid.oldbin\n[root@aarch64 ~]# ls /var/run/nginx/\nnginx.pid\n[root@aarch64 ~]#\n[root@aarch64 ~]# ps aux | egrep '(ngin[x]|PI[D])'\nUSER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nroot      8923  0.0  0.0   9924  5300 ?        S    23:11   0:00 nginx: master process /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf\nnginx     8924  0.0  0.0  10496  3592 ?        S    23:11   0:00 nginx: worker process\n[root@aarch64 ~]#\n")),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u5411\u65e7\u7684\u4e3b\u8fdb\u7a0b\u53f7\u53d1\u9001 QUIT \u4fe1\u53f7\uff0c\u8be5\u4fe1\u53f7\u5c06\u4f7f\u5f97\u4e3b\u8fdb\u7a0b\u4ee5 graceful \u7684\u65b9\u5f0f\u5173\u95ed\u3002\u8fd9\u5c06\u4f7f\u5f97\u65e7\u7684\u4e3b\u8fdb\u7a0b\u3001\u65e7\u7684 worker \u8fdb\u7a0b\u4e0d\u518d\u63a5\u53d7\u4efb\u4f55\u65b0\u8bf7\u6c42\uff0c\u4f46\u5374\u4f1a\u628a\u6b63\u5728\u5904\u7406\u8fc7\u7a0b\u4e2d\u7684\u8bf7\u6c42\u5904\u7406\u5b8c\u6bd5\uff0c\u7136\u540e\u88ab\u9500\u6bc1\u9000\u51fa\u3002"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"\u66f4\u7a33\u59a5\u7684\u65b9\u5f0f\u662f\u5148\u8ba9 worker \u8fdb\u7a0b graceful stop\uff0c\u5728\u65b0\u7248\u672c\u7684 nginx \u5b9e\u4f8b\u8fd0\u884c\u4e00\u5c0f\u6bb5\u65f6\u95f4\u540e\u5982\u679c\u6b63\u5e38\u5de5\u4f5c\uff0c\u518d graceful stop \u65e7\u7684\u4e3b\u8fdb\u7a0b\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kill -WINCH cat /var/run/nginx/nginx.pid.oldbin\n# a period of time goes, graceful stop old master nginx\nkill -QUIT cat /var/run/nginx/nginx.pid.oldbin\n")),(0,l.kt)("p",{parentName:"li"},"\u5728\u53d1\u9001 WINCH \u4fe1\u53f7\u7ed9\u65e7\u7684\u4e3b\u8fdb\u7a0b\u540e\uff0c\u65e7\u7684 worke r\u8fdb\u7a0b\u5c06\u9010\u6e10\u9000\u51fa\uff0c\u4f46\u65e7\u7684\u4e3b\u8fdb\u7a0b\u5374\u4f1a\u4fdd\u7559\u4e0d\u9000\u51fa\u3002"),(0,l.kt)("p",{parentName:"li"},"\u5982\u679c\u53d1\u73b0\u65b0\u7248\u672c\u7684 nginx \u5b9e\u4f8b\u4e0d\u6ee1\u610f\uff0c\u53ef\u4ee5\u76f4\u63a5\u5411\u65e7\u4e3b\u8fdb\u7a0b\u53f7\u53d1\u9001 HUP \u4fe1\u53f7\uff0c\u8fd9\u6837\u65e7\u7684\u4e3b\u8fdb\u7a0b\u5c31\u4f1a\u91cd\u65b0\u8bfb\u53d6\u914d\u7f6e\u6587\u4ef6\u5e76 fork \u65b0\u7684 worker \u8fdb\u7a0b\uff0c\u518d\u5c06\u65b0\u7684\u4e3b\u8fdb\u7a0b\u53f7\u6740\u6389(\u53ef\u4ee5 graceful stop)\uff0c\u5c31\u53ef\u4ee5\u8fd8\u539f\u4e3a\u65e7\u7248\u672c\u7684 nginx \u5b9e\u4f8b\u3002"))),(0,l.kt)("h3",{id:"792\u964d\u7ea7"},"7.9.2\u3001\u964d\u7ea7"),(0,l.kt)("p",null,"\u4e0a\u9762\u7b2c 4 \u6b65\u5176\u5b9e\u5c31\u662f\u6700\u5b89\u5168\u7684\u964d\u7ea7\u65b9\u5f0f\u3002\u5373\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kill -HUP `cat /var/run/nginx/nginx.pid.oldbin`\nkill -QUIT `cat /var/run/nginx/nginx.pid`\n")),(0,l.kt)("p",null,"\u4f46\u5982\u679c\u65e7\u7684\u4e3b\u8fdb\u7a0b\u53f7\u5df2\u7ecf\u88ab\u6740\u6389\u4e86\uff0c\u76ee\u524d\u53ea\u6709\u65b0\u7248\u672c\u7684 nginx \u5b9e\u4f8b\u5728\u8fd0\u884c\uff0c\u90a3\u4e48\u53ea\u9700\u4ee5\u5347\u7ea7\u7684\u6b65\u9aa4\u8fdb\u884c\u964d\u7ea7\u5373\u53ef\u3002\u5373\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"kill -USR2 `cat /var/run/nginx/nginx.pid`\nkill -QUIT `cat /var/run/nginx/nginx.pid.oldbin`\n")),(0,l.kt)("h3",{id:"793\u4e00\u952e\u5347\u7ea7\u811a\u672c"},"7.9.3\u3001\u4e00\u952e\u5347\u7ea7\u811a\u672c"),(0,l.kt)("p",null,"\u4ee5\u4e0b\u662f\u5347\u7ea7\u7684\u811a\u672c\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n#\n# Legacy action script for "service nginx upgrade"\n\n# Source function library.\n[ -f /etc/rc.d/init.d/functions ] && . /etc/rc.d/init.d/functions\n\nif [ -f /etc/sysconfig/nginx ]; then\n    . /etc/sysconfig/nginx\nfi\n\nprefix=/usr/local/nginx\nprog=nginx\nnginx=$prefix/sbin/nginx\nconffile=$prefix/conf/nginx.conf\npidfile=/var/run/nginx.pid\nSLEEPSEC=${SLEEPSEC:-1}\nUPGRADEWAITLOOPS=${UPGRADEWAITLOOPS:-5}\n\noldbinpidfile=${pidfile}.oldbin\n\n# \u914d\u7f6e\u6587\u4ef6\u8bed\u6cd5\u68c0\u67e5\n${nginx} -t -c ${conffile} -q || return 6\necho -n $"Starting new master $prog: "\n# \u53d1\u9001USR2\u4fe1\u53f7\u5347\u7ea7nginx\u53ef\u6267\u884c\u7a0b\u5e8f\nkillproc -p ${pidfile} ${prog} -USR2\necho\n\nfor i in `/usr/bin/seq $UPGRADEWAITLOOPS`; do\n    /bin/sleep $SLEEPSEC\n    if [ -f ${oldbinpidfile} -a -f ${pidfile} ]; then\n        echo -n $"Graceful shutdown of old $prog: "\n        # graceful stop\u65e7\u4e3bnginx\u4e3b\u8fdb\u7a0b\n        killproc -p ${oldbinpidfile} ${prog} -QUIT\n        echo\n        exit 0\n    fi\ndone\n\necho $"Upgrade failed!"\nexit 1\n')),(0,l.kt)("h2",{id:"710\u642d\u5efa-lnmp-\u73af\u5883"},"7.10\u3001\u642d\u5efa LNMP \u73af\u5883"),(0,l.kt)("p",null,"nginx \u548c php-fpm \u6709\u4e24\u79cd\u901a\u4fe1\u65b9\u5f0f\uff1a",(0,l.kt)("strong",{parentName:"p"},"tcp socket \u548c unix socket"),"\u3002tcp socket \u53ef\u4ee5\u8de8\u4e3b\u673a\u914d\u7f6e nginx+php-fpm\uff0cunix socket \u662f\u540c\u4e00\u4e3b\u673a\u8fdb\u7a0b\u95f4\u901a\u4fe1\u7684\u4e00\u79cd\u65b9\u5f0f\uff0c\u6570\u636e\u7684\u8fdb\u51fa\u90fd\u662f\u5728\u5185\u6838\u4e2d\u8fdb\u884c\uff0c\u6548\u7387\u6bd4 tcp socket \u9ad8\uff0c\u8981\u6c42 php-fpm \u5f00\u542f sock \u76d1\u542c\uff0c\u4e14\u4e0d\u80fd\u8de8\u4e3b\u673a\u914d\u7f6e nginx+php-fpm\u3002\u56e0\u6b64\uff0c\u5982\u679c nginx+php-fpm \u5728\u540c\u4e00\u4e3b\u673a\u4e0a\u65f6\uff0c\u5efa\u8bae\u4f7f\u7528 unix socket \u7684\u8fde\u63a5\u901a\u4fe1\u65b9\u5f0f\u3002"),(0,l.kt)("h3",{id:"7101\u7f16\u8bd1-nginx"},"7.10.1\u3001\u7f16\u8bd1 nginx"),(0,l.kt)("p",null,"rpm \u5305\u683c\u5f0f\u7684 nginx \u5730\u5740\uff1a",(0,l.kt)("a",{parentName:"p",href:"http://nginx.org/packages/"},"http://nginx.org/packages/"),"\u3002"),(0,l.kt)("p",null,"\u6e90\u7801\u5305\u4e0b\u8f7d\u5730\u5740\uff1a",(0,l.kt)("a",{parentName:"p",href:"http://nginx.org/en/download.html"},"http://nginx.org/en/download.html")," \u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'[root@casually ~]# groupadd -r nginx\n[root@casually ~]# useradd -r -g nginx nginx\n[root@casually ~]# yum groups install "Development Tools" -y\n[root@casually ~]# wget http://nginx.org/download/nginx-1.12.2.tar.gz\n[root@casually ~]# tar xf nginx-1.12.2.tar.gz\n[root@casually ~]# cd nginx-1.12.2/\n[root@casually nginx-1.12.2]#\n[root@casually nginx-1.12.2]# yum install pcre-devel openssl-devel -y\n[root@casually nginx-1.12.2]# ./configure \\\n>   --user=nginx \\\n>   --group=nginx \\\n>   --prefix=/usr/local/nginx-1.12.2 \\\n>   --error-log-path=/var/log/nginx/error.log \\\n>   --http-log-path=/var/log/nginx/access.log \\\n>   --pid-path=/var/run/nginx/nginx.pid  \\\n>   --lock-path=/var/lock/subsys/nginx \\\n>   --with-http_ssl_module \\\n>   --with-http_flv_module \\\n>   --with-http_stub_status_module \\\n>   --with-http_gzip_static_module \\\n>   --with-pcre \\\n>   --with-threads\n[root@casually nginx-1.12.2]# make && make install\n[root@casually ~]# ln -sv /usr/local/nginx-1.12.2/ /usr/local/nginx\n\u2018/usr/local/nginx\u2019 -> \u2018/usr/local/nginx-1.12.2/\u2019\n')),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("inlineCode",{parentName:"p"},"./configure")," \u8fc7\u7a0b\u4e2d\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"--with-XX_module")," \u7684\u8868\u793a\u542f\u7528\u67d0\u6a21\u5757\u5373\u529f\u80fd\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"--without-XX_module")," \u8868\u793a\u7981\u7528\u6a21\u5757\u5373\u529f\u80fd\u3002")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u5728 ",(0,l.kt)("inlineCode",{parentName:"p"},"./configure --help")," \u7684\u7ed3\u679c\u4e2d\uff0c\u51fa\u73b0 ",(0,l.kt)("inlineCode",{parentName:"p"},"--with-XX_module")," \u7684\u8868\u793a XX \u6a21\u5757\u9ed8\u8ba4\u662f\u7981\u7528\u7684\uff0c\u9700\u8981\u624b\u52a8\u542f\u7528\uff0c\u51fa\u73b0 ",(0,l.kt)("inlineCode",{parentName:"p"},"--without-XX_module")," \u8868\u793a XX \u6a21\u5757\u9ed8\u8ba4\u662f\u542f\u7528\u7684\uff0c\u9700\u8981\u624b\u52a8\u7981\u7528\u3002")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u4ee5\u4e0b\u662f\u4e00\u4e9b\u5e38\u89c1\u9009\u9879\u7684\u8bf4\u660e\uff1a"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"--prefix=/usr/local/nginx-1.12.2          # \u5b9a\u4e49\u5b89\u88c5\u8def\u5f84\uff0c\u4e0d\u5199\u65f6\u9ed8\u8ba4\u4e3a/usr/local/nginx\n--sbin-path=                                # \u5b9a\u4e49\u5e94\u7528\u7a0b\u5e8f\u5b58\u653e\u8def\u5f84\uff0c\u4e0d\u5199\u65f6\u9ed8\u8ba4\u4e3a/sbin/nginx\n--conf-path=                                # \u5b9a\u4e49\u914d\u7f6e\u6587\u4ef6\u8def\u5f84\uff0c\u4e0d\u5199\u65f6\u9ed8\u8ba4\u4e3a/conf/nginx.conf\n--error-log-path=/var/log/nginx/error.log   # \u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u6ca1\u6709\u6307\u5b9aerror log\u65f6\u7684\u9519\u8bef\u65e5\u5fd7\u8def\u5f84\uff0c\u4e0d\u5199\u65f6\u9ed8\u8ba4\u4e3a/logs/error.log\n--http-log-path=/var/log/nginx/access.log   # \u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u6ca1\u6709\u6307\u5b9aaccess log\u65f6\u7684\u8bbf\u95ee\u65e5\u5fd7\u8def\u5f84, \u4e0d\u5199\u65f6\u9ed8\u8ba4\u4e3a/logs/access.log\n--pid-path=/var/run/nginx/nginx.pid         # pid\u6587\u4ef6\u8def\u5f84\uff0c\u6ca1\u6307\u5b9a\u65f6\u9ed8\u8ba4\u4e3a/logs/nginx.pid\n--lock-path=/var/lock/subsys/nginx          # \u9501\u6587\u4ef6\u8def\u5f84\n--user=nginx                                # \u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u6ca1\u6709\u6307\u5b9auser\u6307\u5b9a\u65f6\uff0cworker\u8fdb\u7a0b\u7684\u8fd0\u884c\u8eab\u4efd,\u4e0d\u5199\u65f6\u9ed8\u8ba4\u4e3anobody\n--group=nginx                                 # \u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u6ca1\u6709\u6307\u5b9auser(\u4e0d\u662fgroup\uff0c\u914d\u7f6e\u6587\u4ef6\u4e2d\u6ca1\u6709group\u6307\u4ee4)\u6307\u5b9a\u65f6\uff0cworker\u8fdb\u7a0b\u7684\u8fd0\u884c\u7ec4\n\n--with-select_module                          # \u542f\u7528select\u65b9\u6cd5\u6a21\u578b\uff0c\u5f53\u627e\u4e0d\u5230epoll\u65f6\u81ea\u52a8\u542f\u7528select\n--without-select_module   \n--with-poll_module                            # \u542f\u7528poll\u65b9\u6cd5\u6a21\u578b\uff0c\u5f53\u627e\u4e0d\u5230epoll\u65f6\u81ea\u52a8\u542f\u7528poll\n--without-poll_module  \n\n--with-http_ssl_module                        # \u542f\u7528ssl\u529f\u80fd\n--with-http_flv_module                        # \u542f\u7528flv\u89c6\u9891\u6d41\u529f\u80fd\n--with-http_stub_status_module                # \u542f\u7528nginx\u72b6\u6001\u76d1\u63a7\u529f\u80fd\uff0c\u5728\u542f\u52a8\u540e\u5728\u6d4f\u89c8\u5668\u4f7f\u7528root/status\u663e\u793a\u72b6\u6001\u4fe1\u606f\n--with-http_gzip_static_module                # \u542f\u7528gzip\u538b\u7f29\u529f\u80fd\u538b\u7f29web\u670d\u52a1\u5668\u54cd\u5e94\u5ba2\u6237\u7aef\u7684\u54cd\u5e94\u62a5\u6587\n--http-client-body-temp-path=/var/tmp/nginx/client   # \u5b9a\u4e49\u5ba2\u6237\u7aef\u8bf7\u6c42\u62a5\u6587\u4e3b\u4f53\u7684\u4e34\u65f6\u6587\u4ef6\u5b58\u653e\u8def\u5f84\uff0c\u4e0d\u5199\u4e3a/client_body_temp\n--http-proxy-temp-path=/var/tmp/nginx/proxy          # \u5b9a\u4e49\u4ece\u4ee3\u7406\u670d\u52a1\u5668\u6536\u5230\u7684\u4e34\u65f6\u6587\u4ef6\u5b58\u653e\u8def\u5f84\uff0c\u4e0d\u5199\u4e3a/proxy_temp\n--http-fastcgi-temp-path=/var/tmp/nginx/fcgi         # \u5b9a\u4e49\u4ecefastcgi\u670d\u52a1\u5668\u6536\u5230\u7684\u4e34\u65f6\u6587\u4ef6\u5b58\u653e\u8def\u5f84\uff0c\u4e0d\u5199\u4e3a/fastcgi_temp\n--http-uwsgi-temp-path=/var/tmp/nginx/uwsgi          # \u5b9a\u4e49\u4eceuwsgi\u670d\u52a1\u5668\u6536\u5230\u7684\u4e34\u65f6\u6587\u4ef6\u5b58\u653e\u8def\u5f84\uff0c\u4e0d\u5199\u4e3a/uwsgi_temp\n--http-scgi-temp-path=/var/tmp/nginx/scgi            # \u5b9a\u4e49\u4ecescgi\u670d\u52a1\u5668\u6536\u5230\u7684\u4e34\u65f6\u6587\u4ef6\u5b58\u653e\u8def\u5f84\uff0c\u4e0d\u5199\u4e3a/scgi_temp\n--with-pcre                                          # \u8bbe\u7f6epcre\u5e93\u7684\u8def\u5f84\uff0cyum\u5b89\u88c5\u7684pcre-devel\u53ef\u4ee5\u4e0d\u5199\u8def\u5f84\n--with-threads                                       # \u8bbe\u7f6enginx\u652f\u6301\u591a\u7ebf\u7a0b\n")))),(0,l.kt)("p",null,"\u5728\u524d\u9762\u7684\u7f16\u8bd1\u9009\u9879\u4e2d\uff0c\u5b89\u88c5\u8def\u5f84\u4f7f\u7528\u4e86\u7248\u672c\u53f7\uff0c\u4e14\u672a\u6307\u5b9a\u7a0b\u5e8f\u76ee\u5f55\u548c\u914d\u7f6e\u6587\u4ef6\u8def\u5f84\uff0c\u867d\u8bf4\u63d0\u4f9b\u4e86\u5b83\u4eec\u5f88\u65b9\u4fbf\uff0c\u4f46\u662f\u5728\u5347\u7ea7 nginx \u7248\u672c\u6709\u4e9b\u9ebb\u70e6\u3002"),(0,l.kt)("p",null,"\u6240\u4ee5\uff0c\u901a\u8fc7\u6700\u540e\u4e00\u6b65\u5efa\u7acb\u8f6f\u94fe\u63a5\u7684\u65b9\u5f0f\uff0c\u8ba9\u4e00\u5207\u90fd\u53d8\u5f97\u7b80\u5355\uff0c\u53ef\u4ee5\u5c06\u65b0\u65e7\u7248\u672c\u7684 nginx \u5206\u79bb\u5f00\u6765\u3002\u8fd9\u79cd\u65b9\u5f0f\u5b89\u88c5 nginx\uff0c\u914d\u7f6e\u6587\u4ef6\u9ed8\u8ba4\u4e3a ",(0,l.kt)("inlineCode",{parentName:"p"},"<prefix>/conf/nginx.conf"),"\uff0c\u5e94\u7528\u7a0b\u5e8f\u8def\u5f84\u4e3a ",(0,l.kt)("inlineCode",{parentName:"p"},"<prefix>/sbin/nginx"),"\u3002"),(0,l.kt)("p",null,"\u63d0\u4f9b\u670d\u52a1\u7ba1\u7406\u811a\u672c /etc/rc.d/init.d/nginx\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n#\n# nginx - this script starts and stops the nginx daemon\n#\n# chkconfig:   - 85 15\n# description:  Nginx is an HTTP(S) server, HTTP(S) reverse \\\n#               proxy and IMAP/POP3 proxy server\n\n# Source function library.\n. /etc/rc.d/init.d/functions\n\n# Source networking configuration.\n. /etc/sysconfig/network\n\n# Check that networking is up.\n[ "$NETWORKING" = "no" ] && exit 0\n\nnginx="/usr/local/nginx/sbin/nginx"\nprog=$(basename $nginx)\n\nsysconfig="/etc/sysconfig/$prog"\nlockfile="/var/lock/subsys/nginx"\npidfile="/var/run/nginx/nginx.pid"\n\nNGINX_CONF_FILE="/usr/local/nginx/conf/nginx.conf"\n\n[ -f $sysconfig ] && . $sysconfig\n\nstart() {\n    [ -x $nginx ] || exit 5\n    [ -f $NGINX_CONF_FILE ] || exit 6\n    echo -n $"Starting $prog: "\n    daemon $nginx -c $NGINX_CONF_FILE\n    retval=$?\n    echo\n    [ $retval -eq 0 ] && touch $lockfile\n    return $retval\n}\n\nstop() {\n    echo -n $"Stopping $prog: "\n    killproc -p $pidfile $prog\n    retval=$?\n    echo\n    [ $retval -eq 0 ] && rm -f $lockfile\n    return $retval\n}\n\nrestart() {\n    configtest_q || return 6\n    stop\n    start\n}\n\nreload() {\n    configtest_q || return 6\n    echo -n $"Reloading $prog: "\n    killproc -p $pidfile $prog -HUP\n    echo\n}\n\nconfigtest() {\n    $nginx -t -c $NGINX_CONF_FILE\n}\n\nconfigtest_q() {\n    $nginx -t -q -c $NGINX_CONF_FILE\n}\n\nrh_status() {\n    status $prog\n}\n\nrh_status_q() {\n    rh_status >/dev/null 2>&1\n}\n\n# Upgrade the binary with no downtime.\nupgrade() {\n    local oldbin_pidfile="${pidfile}.oldbin"\n\n    configtest_q || return 6\n    echo -n $"Upgrading $prog: "\n    killproc -p $pidfile $prog -USR2\n    retval=$?\n    sleep 1\n    if [[ -f ${oldbin_pidfile} && -f ${pidfile} ]];  then\n        killproc -p $oldbin_pidfile $prog -QUIT\n        success $"$prog online upgrade"\n        echo \n        return 0\n    else\n        failure $"$prog online upgrade"\n        echo\n        return 1\n    fi\n}\n\n# Tell nginx to reopen logs\nreopen_logs() {\n    configtest_q || return 6\n    echo -n $"Reopening $prog logs: "\n    killproc -p $pidfile $prog -USR1\n    retval=$?\n    echo\n    return $retval\n}\n\ncase "$1" in\n    start)\n        rh_status_q && exit 0\n        $1\n        ;;\n    stop)\n        rh_status_q || exit 0\n        $1\n        ;;\n    restart|configtest|reopen_logs)\n        $1\n        ;;\n    force-reload|upgrade) \n        rh_status_q || exit 7\n        upgrade\n        ;;\n    reload)\n        rh_status_q || exit 7\n        $1\n        ;;\n    status|status_q)\n        rh_$1\n        ;;\n    condrestart|try-restart)\n        rh_status_q || exit 7\n        restart\n        ;;\n    *)\n        echo $"Usage: $0 {start|stop|reload|configtest|status|force-reload|upgrade|restart|reopen_logs}"\n        exit 2\nesac\n')),(0,l.kt)("p",null,"\u5982\u679c\u662f systemd \u7ba1\u7406\uff0c\u5219\u63d0\u4f9b /usr/lib/systemd/system/nginx.service\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[Unit]\nDescription=The nginx HTTP and reverse proxy server\nAfter=network.target remote-fs.target nss-lookup.target\n\n[Service]\nType=forking\nPIDFile=/var/run/nginx/nginx.pid\n# Nginx will fail to start if /run/nginx.pid already exists but has the wrong\n# SELinux context. This might happen when running `nginx -t` from the cmdline.\n# https://bugzilla.redhat.com/show_bug.cgi?id=1268621\nExecStartPre=/usr/bin/rm -f /var/run/nginx/nginx.pid\nExecStartPre=/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf\nExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf\nExecReload=/bin/kill -s HUP $MAINPID\nKillSignal=SIGQUIT\nTimeoutStopSec=5\nKillMode=process\nPrivateTmp=true\n\n[Install]\nWantedBy=multi-user.target\n")),(0,l.kt)("p",null,"\u6700\u540e\uff0c\u5c06 nginx \u547d\u4ee4\u52a0\u5165\u73af\u5883\u53d8\u91cf\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@casually ~]# echo 'export PATH=/usr/local/nginx/sbin:$PATH' > /etc/profile.d/nginx.sh\n[root@casually ~]# . /etc/profile.d/nginx.sh\n")),(0,l.kt)("p",null,"\u542f\u52a8 nginx \u670d\u52a1\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'[root@casually ~]# systemctl daemon-reload \n[root@casually ~]# systemctl start nginx\n[root@casually ~]# ss -tnlpu | grep 80\ntcp    LISTEN     0      128       *:80                    *:*                   users:(("nginx",pid=25020,fd=6),("nginx",pid=25019,fd=6))\n[root@casually ~]#\n')),(0,l.kt)("h3",{id:"7102\u7f16\u8bd1-php"},"7.10.2\u3001\u7f16\u8bd1 PHP"),(0,l.kt)("p",null,"\u7f16\u8bd1\u8fc7\u7a0b\u53ef\u4ee5\u53c2\u89c1 ",(0,l.kt)("a",{parentName:"p",href:"https://www.brinnatt.com/high/%e7%ac%ac-6-%e7%ab%a0-linux-httpd-%e6%9c%8d%e5%8a%a1%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae/#692%E3%80%81%E7%BC%96%E8%AF%91_php"},"php \u7f16\u8bd1\u8fc7\u7a0b")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@aarch64 ~]# wget https://www.php.net/distributions/php-5.5.38.tar.gz\n[root@aarch64 ~]# yum install -y bzip2-devel libmcrypt-devel openssl-devel libxml2-devel libsqlite3x-devel oniguruma-devel\n[root@aarch64 ~]# tar xf php-5.5.38.tar.bz2 \n[root@aarch64 ~]# cd php-5.5.38/\n[root@aarch64 php-5.5.38]# ./configure --prefix=/usr/local/php --with-openssl --enable-mbstring --enable-sockets --with-freetype-dir --with-jpeg-dir --with-png-dir --with-libxml-dir=/usr --enable-xml --with-zlib --with-mcrypt --with-bz2 --with-mhash --with-config-file-path=/etc --with-config-file-scan-dir=/etc/php.d --with-mysql=mysqlnd --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --enable-fpm\n[root@aarch64 php-5.5.38]# make && make install\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# \u63d0\u4f9bphp\u914d\u7f6e\u6587\u4ef6\n[root@aarch64 php-5.5.38]# cp php.ini-production /etc/php.ini\n\n# \u63d0\u4f9bphp-fpm\u670d\u52a1\u7ba1\u7406\u811a\u672c\n[root@aarch64 php-5.5.38]# cp sapi/fpm/init.d.php-fpm /etc/init.d/php-fpmd\n[root@aarch64 php-5.5.38]# chmod +x /etc/init.d/php-fpmd\n\n# \u63d0\u4f9bphp-fpm\u914d\u7f6e\u6587\u4ef6\n[root@aarch64 php-5.5.38]# cd /usr/local/php/\n[root@aarch64 php]# cp etc/php-fpm.conf.default etc/php-fpm.conf\n\n# \u4fee\u6539php-fpm\u914d\u7f6e\u6587\u4ef6(\u505a\u5b9e\u9a8c\u7684\u8bdd\u6539\u4e0d\u6539\u968f\u610f)\n[root@aarch64 php]# vim etc/php-fpm.conf\nlisten = 192.168.122.44:9000\npm.max_children = 50\npm.start_servers = 5\npm.min_spare_servers = 2\npm.max_spare_servers = 8\n\n# \u542f\u52a8php-fpm\n[root@aarch64 ~]# service php-fpmd start\nStarting php-fpm  done\n")),(0,l.kt)("h3",{id:"7103\u914d\u7f6e-nginx-\u548c-php-fpm-\u4ea4\u4e92tcp-socket"},"7.10.3\u3001\u914d\u7f6e nginx \u548c php-fpm \u4ea4\u4e92(tcp socket)"),(0,l.kt)("p",null,"\u5728 nginx \u914d\u7f6e\u6587\u4ef6\u4e2d\u52a0\u5165\u7c7b\u4f3c\u5982\u4e0b location \u5bb9\u5668\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"location ~ \\.php$ {\n    root           /php/;\n    # \u6ce8\u610f\uff0c\u9ed8\u8ba4\u7684php-fpm\u76d1\u542c\u5728127.0.0.1:9000\n    fastcgi_pass   192.168.122.44:9000;\n    fastcgi_index  index.php;\n    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;\n    include        fastcgi_params;\n}\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"location \u8868\u793a\u5f53\u8bf7\u6c42\u7684 url \u80fd\u5339\u914d\u4ee5 .php \u7ed3\u5c3e\u65f6\uff0c\u5c06\u4ee5\u8be5\u5bb9\u5668\u7684\u6307\u4ee4\u8fdb\u884c\u5904\u7406\u3002")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"root \u6307\u4ee4\u5c06\u6b64\u5bb9\u5668\u7684 document","_","root \u8bbe\u7f6e\u4e3a /php/\u3002")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"fastcgi","_","pass \u6307\u4ee4\u8868\u793a\u5c06\u8be5 url \u8bf7\u6c42\u4ee3\u7406\u81f3 192.168.122.44 \u4e3b\u673a\u4e0a\u8fd0\u884c\u7684 php-fpm\uff0c\u7531\u4e8e\u6b64\u5904\u8bbe\u7f6e\u4e86 SCRIPT","_","FILENAME\uff0c\u6240\u4ee5\u5f53\u8bf7\u6c42\u7684 uri \u4e3a /a/a.php \u65f6\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"$document_root=/php/"),"\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"$fastcgi_script_name=/a/a.php"),"\uff0c\u8fd9\u8868\u793a\u8f6c\u53d1\u8bf7\u6c42\u81f3 192.168.122.44 \u4e3b\u673a\u4e0a\u7684 /php/a/a.php\u3002"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u6240\u4ee5\uff0c",(0,l.kt)("strong",{parentName:"li"},"\u5728 php-fpm \u6240\u5728\u4e3b\u673a")," 192.168.122.44 \u4e0a\u5fc5\u987b\u5c06 a.php \u653e\u5728\u4e8b\u5148\u5df2\u521b\u5efa\u597d\u7684 /php/ \u76ee\u5f55\u4e0b\uff0c",(0,l.kt)("strong",{parentName:"li"},"\u8fd9\u548c nginx \u4e3b\u673a"),"\u4e0a\u662f\u5426\u6709 /php/ \u76ee\u5f55\u65e0\u5173\u3002"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u8fd9\u91cc\u7684 include \u5305\u542b\u7684\u6587\u4ef6\u90fd\u662f\u4e00\u4e9b fastcgi","_","param \u6307\u4ee4\uff0cfastcgi","_","param \u6307\u4ee4\u662f nginx \u5c06\u76f8\u5173\u53c2\u6570\u8d4b\u503c\u7ed9 php-fpm \u6240\u9700\u53d8\u91cf\uff0c\u5e76\u5c06\u5b83\u4eec\u4f20\u9012\u7ed9 php-fpm\uff0c\u4f7f\u5f97 php-fpm \u77e5\u9053\u5904\u7406\u54ea\u4e2a\u6587\u4ef6\u3001\u5982\u4f55\u5904\u7406\u3001\u5904\u7406\u7684\u73af\u5883\u662f\u5982\u4f55\u7684\u3002")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u6b64\u5904\u989d\u5916\u5b9a\u4e49\u4e86\u4e00\u4e2a php-fpm \u6240\u9700\u7684\u53d8\u91cf SCRIPT","_","FILENAME\uff0c\u56e0\u4e3a\u8be5\u53d8\u91cf\u6ca1\u6709\u5305\u542b\u5728 fastcgi","_","params \u6587\u4ef6\u4e2d\u3002\u5982\u679c\u662f rpm \u5305\u5b89\u88c5\u7684 nginx\uff0c\u5219\u5728 fastcgi.conf \u6587\u4ef6\u4e2d\u5df2\u5305\u542b\u8be5\u53d8\u91cf\uff0c\u6b64\u65f6\u7b80\u5199\u4e3a\u5982\u4e0b\u914d\u7f6e\u5373\u53ef\uff1a"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"location ~ \\.php$ {\n  root           /php/;\n  fastcgi_pass   192.168.122.44:9000;\n  fastcgi_index  index.php;\n  include        fastcgi.conf;\n}\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u8fd8\u9700\u6ce8\u610f\uff0cfastcgi","_",'index \u5728\u6b64\u5904\u662f\u591a\u4f59\u7684\u3002\u8be5\u6307\u4ee4\u8868\u793a\u7684\u662f\u5f53\u4ee3\u7406\u8bf7\u6c42\u81f3 php-fpm \u4e0a\u65f6\uff0c\u5982\u679c uri \u4ee5 "/" \u7ed3\u5c3e(\u4e25\u683c\u5730\u8bf4\uff0c\u662f ',(0,l.kt)("inlineCode",{parentName:"p"},"$fastcgi_script_name")," \u7684\u503c\u4ee5\u659c\u7ebf\u7ed3\u5c3e)\uff0c\u5219\u81ea\u52a8\u6dfb\u52a0\u4e0a\u6b64\u5904\u6307\u5b9a\u7684 index.php\u3002"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u4f46\u6ce8\u610f\uff0c\u6b64\u5904\u7684 location \u7684\u5339\u914d\u6761\u4ef6\u662f\u4ee5 .php \u7ed3\u5c3e\uff0c\u662f\u4e0d\u53ef\u80fd\u5339\u914d\u4ee5\u659c\u7ebf\u7ed3\u5c3e\u7684\uff0c\u56e0\u6b64\u6b64\u5904\u7684 fastcgi","_","index \u6307\u4ee4\u662f\u591a\u4f59\u7684\u3002\u4f46\u5982\u679c\u4fee\u6539\u4e3a\u5982\u4e0b\u914d\u7f6e\uff1a")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"location ~ .*php {\n    root           /php/;\n    fastcgi_pass   192.168.122.44:9000;\n    fastcgi_index  index.php;\n    include        fastcgi.conf;\n}\n")),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u5219 fastcgi","_",'index \u662f\u80fd\u6d3e\u4e0a\u7528\u573a\u7684\uff0c\u4f8b\u5982\u8bf7\u6c42\u7684 uri \u4e3a "/a/php/"\uff0c\u5219\u5c06\u6267\u884c 192.168.122.44 \u4e0a\u7684 /php/a/php/index.php \u6587\u4ef6\u3002')))),(0,l.kt)("h3",{id:"7104\u914d\u7f6e-nginx-\u548c-php-fpm-\u4ea4\u4e92unix-socket"},"7.10.4\u3001\u914d\u7f6e nginx \u548c php-fpm \u4ea4\u4e92(unix socket)"),(0,l.kt)("p",null,"\u8981\u914d\u7f6e unix socket \u7684\u901a\u4fe1\u65b9\u5f0f\uff0c\u53ea\u9700\u5c06 php-fpm \u76d1\u542c\u5728 unix socket \u4e0a\u5373\u53ef\u3002"),(0,l.kt)("p",null,"\u4fee\u6539 php-fpm.conf\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},";listen = 127.0.0.1:9000\nlisten = /dev/shm/php-cgi.sock\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u8fd9\u91cc\u7684\u8def\u5f84\u662f /dev/shm\uff0c\u8fd9\u662f\u5c06\u5185\u5b58\u5316\u4e3a\u865a\u62df\u78c1\u76d8\u7528\u7684\uff0c\u6548\u7387\u6bd4\u78c1\u76d8\u901f\u5ea6\u9ad8\u5f97\u591a\u3002")),(0,l.kt)("p",null,"\u518d\u5728 nginx.conf \u4e2d\u7684 fastcgi","_","pass \u6539\u4e3a ",(0,l.kt)("inlineCode",{parentName:"p"},"unix://")," \u534f\u8bae\u5373\u53ef\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"fastcgi_pass unix:/dev/shm/php-cgi.sock;\n")),(0,l.kt)("h2",{id:"711nginx-\u53cd\u5411\u4ee3\u7406"},"7.11\u3001nginx \u53cd\u5411\u4ee3\u7406"),(0,l.kt)("h3",{id:"7111\u6b63\u53cd\u4ee3\u7406\u6982\u5ff5"},"7.11.1\u3001\u6b63\u53cd\u4ee3\u7406\u6982\u5ff5"),(0,l.kt)("p",null,'\u6b63\u5411\u4ee3\u7406\u662f\u4f17\u591a\u5185\u7f51\u5ba2\u6237\u673a\u4e0a\u7f51\u8bbf\u95ee\u4e92\u8054\u7f51\u4e0a\u7684\u7f51\u7ad9\u65f6\uff0c\u5c06\u6240\u6709\u7684\u8bf7\u6c42\u4ea4\u7ed9\u5185\u7f51\u524d\u9762\u5904\u4e8e\u516c\u7f51\u4e0a\u7684 "\u7ba1\u5bb6" \u670d\u52a1\u5668\uff0c\u7531 "\u7ba1\u5bb6" \u670d\u52a1\u5668\u4ee3\u4e3a\u8bf7\u6c42\u60f3\u8981\u8bbf\u95ee\u7684 web \u670d\u52a1\u5668\uff0c\u7136\u540e\u5c06\u5f97\u5230\u7684\u7ed3\u679c\u7f13\u5b58\u4e0b\u6765\u5e76\u63d0\u4f9b\u7ed9\u5ba2\u6237\u7aef\uff0c\u8fd9\u662f\u6b63\u5411\u4ee3\u7406\u3002"\u7ba1\u5bb6" \u670d\u52a1\u5668\u79f0\u4e3a\u6b63\u5411\u4ee3\u7406\u670d\u52a1\u5668\u3002'),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"http forward direction",src:t(10591).Z,width:"990",height:"427"})),(0,l.kt)("p",null,'\u53cd\u5411\u4ee3\u7406\u662f\u5ba2\u6237\u7aef\u8bbf\u95ee web \u670d\u52a1\u5668\u65f6\uff0c\u8bf7\u6c42\u53d1\u9001\u5230\u771f\u5b9e\u7684 web \u670d\u52a1\u5668\u7684\u524d\u7aef "\u52a9\u624b" \u670d\u52a1\u5668\u4e0a\uff0c\u7531 "\u52a9\u624b" \u670d\u52a1\u5668\u51b3\u5b9a\u5c06\u6b64\u8bf7\u6c42\u8f6c\u53d1\u7ed9\u54ea\u4e2a\u771f\u5b9e\u7684 web \u670d\u52a1\u5668\uff0c\u5916\u754c\u5ba2\u6237\u7aef\u4ee5\u4e3a "\u52a9\u624b" \u670d\u52a1\u5668\u5c31\u662f\u771f\u5b9e\u7684 web \u670d\u52a1\u5668\uff0c\u800c\u5b9e\u9645\u4e0a\u5b83\u4e0d\u662f\uff0c\u4e5f\u4e0d\u9700\u8981\u5b89\u88c5\u4efb\u4f55 web \u7a0b\u5e8f\u3002"\u52a9\u624b" \u670d\u52a1\u5668\u79f0\u4e3a\u53cd\u5411\u4ee3\u7406\u670d\u52a1\u5668\u3002'),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"http reverse direction",src:t(66201).Z,width:"910",height:"539"})),(0,l.kt)("p",null,'nginx \u662f\u4e00\u4e2a\u4f18\u79c0\u7684\u53cd\u5411\u4ee3\u7406\u670d\u52a1\u7a0b\u5e8f\uff0c\u901a\u8fc7\u53cd\u5411\u4ee3\u7406\u53ef\u4ee5\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u7684\u6548\u679c\u3002\u56e0\u4e3a\u662f\u901a\u8fc7\u53cd\u5411\u4ee3\u7406\u5b9e\u73b0\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u6240\u4ee5 nginx \u5b9e\u73b0\u7684\u662f\u4e03\u5c42\u8d1f\u8f7d\u5747\u8861\u3002\u5b83\u80fd\u591f\u8bc6\u522b http \u534f\u8bae\uff0c\u6839\u636e http \u62a5\u6587\u5c06\u4e0d\u540c\u7c7b\u578b\u7684\u8bf7\u6c42\u8f6c\u53d1\u5230\u4e0d\u540c\u7684\u540e\u7aef web \u670d\u52a1\u5668\u4e0a\u3002\u540e\u7aef\u7684 web \u670d\u52a1\u5668\u79f0\u4e3a "\u4e0a\u6e38\u670d\u52a1\u5668"\uff0c\u5373 upstream \u670d\u52a1\u5668\u3002'),(0,l.kt)("p",null,"\u5b9e\u9645\u4e0a\uff0cnginx \u548c php-fpm \u7ed3\u5408\u7684\u65f6\u5019\uff0c\u6307\u4ee4 fastcgi","_","pass \u5b9e\u73b0\u7684\u4e5f\u662f\u53cd\u5411\u4ee3\u7406\u7684\u529f\u80fd\uff0c\u53ea\u4e0d\u8fc7\u8fd9\u79cd\u4ee3\u7406\u529f\u80fd\u662f\u7279\u5b9a\u7684\u529f\u80fd\uff0c\u53ea\u80fd\u8f6c\u53d1\u7ed9 php-fpm\u3002"),(0,l.kt)("p",null,"nginx \u7684\u53cd\u5411\u4ee3\u7406\u6709\u51e0\u79cd\u5b9e\u73b0\u65b9\u5f0f\uff1a"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u4ec5\u4f7f\u7528\u6a21\u5757 ngx","_","http","_","proxy","_","module \u5b9e\u73b0\u7b80\u5355\u7684\u53cd\u5411\u4ee3\u7406\u3002\u6307\u4ee4\u4e3a proxy","_","pass\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u4f7f\u7528 fastcgi \u6a21\u5757\u63d0\u4f9b\u7684\u529f\u80fd\uff0c\u53cd\u5411\u4ee3\u7406\u52a8\u6001\u5185\u5bb9\u3002\u6307\u4ee4\u4e3a fastcgi","_","pass\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u4f7f\u7528 ngx","_","http","_","memcached","_","module \u6a21\u5757\u63d0\u4f9b\u7684\u529f\u80fd\uff0c\u53cd\u5411\u4ee3\u7406 memcached \u7f13\u5b58\u5185\u5bb9\uff0c\u6307\u4ee4\u4e3a memcached","_","pass\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u7ed3\u5408 upstream \u6a21\u5757\u5b9e\u73b0\u66f4\u4eba\u6027\u5316\u7684\u5206\u7ec4\u53cd\u5411\u4ee3\u7406\u3002")),(0,l.kt)("h3",{id:"7112\u53cd\u5411\u4ee3\u7406\u57fa\u7840\u5b9e\u9a8c"},"7.11.2\u3001\u53cd\u5411\u4ee3\u7406\u57fa\u7840\u5b9e\u9a8c"),(0,l.kt)("p",null,"\u5b9e\u9a8c\u73af\u5883\u5982\u4e0b\u56fe\uff1a"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"simple nginx proxy",src:t(4388).Z,width:"784",height:"589"})),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"\u7b2c 1 \u6b65"),"\uff1a\u53cd\u5411\u4ee3\u7406\u670d\u52a1\u5668 nginx-proxy(192.168.122.45) \u7684\u914d\u7f6e\u3002\u7531\u4e8e\u662f\u505a\u4ee3\u7406\uff0c\u6240\u4ee5\u914d\u7f6e\u6587\u4ef6\u7684 location \u6bb5\u4e0d\u518d\u9700\u8981 root\u3001index \u7b49\u6307\u4ee4\uff0c\u53ea\u9700\u51e0\u4e2a\u548c\u4ee3\u7406\u76f8\u5173\u7684\u6307\u4ee4\u5373\u53ef\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"server {\n    listen       80;\n    server_name  www.brinnatt.com;\n    location ~ \\.(png|jpg|jpeg|bmp|gif)$ {\n        proxy_pass http://192.168.122.48:80;\n    }\n    location / {\n        proxy_pass http://192.168.122.49:80/;\n    }\n    location ~ \\.(php|php5)$ {\n        proxy_pass http://192.168.122.46:80;\n    }\n    error_page   500 502 503 504  /50x.html;\n    location = /50x.html {\n        root   html;\n    }\n}\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"\u7b2c 2 \u6b65"),"\uff1a\u63d0\u4f9b\u52a8\u6001\u670d\u52a1\u7684 nginx \u670d\u52a1\u5668(192.168.122.46) \u7684\u914d\u7f6e\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"server {\n    listen       80;\n    server_name  www.brinnatt.com;\n    location / {\n        root    /www/brinnatt/;\n        index   index.php index.html index.htm;\n    }\n    location ~ \\.php$ {\n        root /php/;\n        fastcgi_pass    192.168.122.47:9000;\n        fastcgi_index   nomatch.php;\n        include         fastcgi.conf;\n    }\n}\n")),(0,l.kt)("p",null,"\u5176\u4e2d php-fpm \u670d\u52a1\u5668(192.168.122.47) \u4e0a\u7684 /php/info.php \u5185\u5bb9\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"<h1>This is php-fpm server individually<h1>\n<?php\nphpinfo();\n?>\n")),(0,l.kt)("p",null,"\u6ce8\u610f\uff1a\u5982\u679c php-fpm \u670d\u52a1\u662f\u7528 rpm \u5305\u5b89\u88c5\u7684\uff0c\u8bb0\u5f97\u8981\u6539 /etc/php-fpm.d/www.conf\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"listen = 192.168.122.47:9000        # \u4fee\u6539\u76d1\u542c\u5730\u5740\u914d\u5408\u5176\u4ed6\u670d\u52a1\u5668\u5b9e\u9a8c\nlisten.allowed_clients = 127.0.0.1  # \u8fd9\u662f\u4e2a\u5751\uff0c\u5982\u679c php-fpm \u662f\u4e2a\u72ec\u7acb\u7684\u670d\u52a1\u5668\uff0c\u90a3\u8c01\u90fd\u7528\u4e0d\u4e86\uff0c\u6ce8\u91ca\u6389\u540e\u9ed8\u8ba4\u5141\u8bb8\u6240\u6709\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"\u7b2c 3 \u6b65"),"\uff1aLB1(192.168.122.48) \u548c LB2(192.168.122.49) \u7684 web \u7a0b\u5e8f\u90fd\u662f httpd\u3002\u5176\u4e2d\u4f5c\u4e3a\u4e00\u822c\u9759\u6001 web \u670d\u52a1\u5668\u7684 LB2 \u7684\u914d\u7f6e\u6587\u4ef6\u6ca1\u6709\u4efb\u4f55\u4fee\u6539\uff0c\u5b83\u7684 /var/www/html/index.html \u7684\u5185\u5bb9\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"<h1>LB2:static</h1>\n")),(0,l.kt)("p",null,"\u4f5c\u4e3a\u56fe\u7247\u670d\u52a1\u5668\u7684 LB1 \u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u6dfb\u52a0\u4e86\u5982\u4e0b\u51e0\u884c\u3002\u4e14\u5176 /var/www/html/ \u4e0b\u6709\u4e00\u4e2a\u56fe\u7247\u6587\u4ef6 dhcp.png\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'<Files ~ "\\.(png|jpeg|jpg|bmp|gif)">\n        Order allow,deny\n        Allow from all\n</Files>\n')),(0,l.kt)("p",null,"\u7ecf\u8fc7\u4ee5\u4e0a\u7684\u914d\u7f6e\uff0c\u53ef\u4ee5\u5b9e\u73b0\u5982\u4e0b\u56fe\u7684\u529f\u80fd\u3002\u5f53\u8bbf\u95ee ",(0,l.kt)("a",{parentName:"p",href:"http://www.brinnatt.com(192.168.122.45)"},"www.brinnatt.com(192.168.122.45)")," \u7684\u65f6\u5019\uff0c\u4efb\u610f\u4ee5 php \u7ed3\u5c3e\u7684\u6587\u4ef6\u8bf7\u6c42\u90fd\u8f6c\u53d1\u7ed9 nginx \u518d\u7531 nginx \u4ea4\u7531 php-fpm \u5904\u7406\uff1b\u4efb\u610f\u4ee5\u56fe\u7247\u683c\u5f0f\u7ed3\u5c3e(png/jpg/jpeg/bmp/gif)\u7684\u8bf7\u6c42\u90fd\u8f6c\u53d1\u7ed9 LB1\uff1b\u4efb\u610f\u975e\u4ee5\u4e0a\u4e24\u79cd\u683c\u5f0f\u7684\u8bf7\u6c42\u90fd\u8f6c\u53d1\u7ed9 LB2\u3002"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"simple nginx proxy1",src:t(57305).Z,width:"804",height:"568"})),(0,l.kt)("p",null,"\u6d4b\u8bd5 1\uff1a\u8bbf\u95ee ",(0,l.kt)("a",{parentName:"p",href:"http://192.168.122.45/info.php"},"http://192.168.122.45/info.php")),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"nginx php-fpm page",src:t(3301).Z,width:"937",height:"430"})),(0,l.kt)("p",null,"\u6d4b\u8bd5 2\uff1a\u8bbf\u95ee ",(0,l.kt)("a",{parentName:"p",href:"http://192.168.122.45/dhcp.png%EF%BC%8C%E5%B7%B2%E6%B5%8B%E8%AF%95%E6%88%90%E5%8A%9F"},"http://192.168.122.45/dhcp.png\uff0c\u5df2\u6d4b\u8bd5\u6210\u529f"),"\u3002"),(0,l.kt)("p",null,"\u6d4b\u8bd5 3\uff1a\u8bbf\u95ee ",(0,l.kt)("a",{parentName:"p",href:"http://192.168.122.45/%EF%BC%8C%E5%B7%B2%E6%B5%8B%E8%AF%95%E6%88%90%E5%8A%9F"},"http://192.168.122.45/\uff0c\u5df2\u6d4b\u8bd5\u6210\u529f"),"\u3002"),(0,l.kt)("h3",{id:"7113\u53cd\u5411\u4ee3\u7406-upstream-\u6a21\u5757\u5206\u7ec4"},"7.11.3\u3001\u53cd\u5411\u4ee3\u7406 upstream \u6a21\u5757\u5206\u7ec4"),(0,l.kt)("p",null,"\u524d\u9762\u53ea\u4f7f\u7528\u4e86 ngx","_","http","_","proxy","_","module \u6765\u5b9e\u73b0\u53cd\u5411\u4ee3\u7406\uff0c\u4f46\u662f\u5176\u7f3a\u9677\u5728\u4e8e nginx-proxy \u4e0a\u5b9a\u4e49\u7684\u6bcf\u6761\u4ee3\u7406\u89c4\u5219\u90fd\u53ea\u80fd\u8f6c\u53d1\u5230\u540e\u53f0\u7684\u67d0\u4e00\u53f0\u670d\u52a1\u5668\u4e0a\uff0c\u5373\u540e\u7aef\u670d\u52a1\u5668\u65e0\u6cd5\u5206\u7ec4\u3002"),(0,l.kt)("p",null,"\u5982\u679c\u56fe\u7247\u670d\u52a1\u5668\u538b\u529b\u592a\u5927\uff0c\u6dfb\u52a0\u4e00\u53f0\u670d\u52a1\u5668\u7528\u6765\u51cf\u8f7b\u56fe\u7247\u670d\u52a1\u5668\u538b\u529b\uff0c\u4f46\u662f\u4ec5\u4f7f\u7528 proxy \u6a21\u5757\u65e0\u6cd5\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u5230\u591a\u53f0\u56fe\u7247\u670d\u52a1\u5668\u4e0a\u3002"),(0,l.kt)("p",null,"\u8fd9\u65f6\u9700\u8981\u501f\u52a9 ngx","_","http","_","upstream","_","module \u6a21\u5757\uff0c\u8be5\u6a21\u5757\u7528\u4e8e\u5b9a\u4e49\u540e\u7aef\u670d\u52a1\u5668\u6c60\uff0c\u540e\u7aef\u670d\u52a1\u5668\u4e5f\u79f0\u4e3a\u4e0a\u6e38\u670d\u52a1\u5668(upstream)\uff0c\u53ef\u4ee5\u4e3a\u6bcf\u4e00\u79cd\u7c7b\u578b\u7684\u540e\u7aef\u670d\u52a1\u5668\u5206\u4e00\u4e2a\u7ec4\u3002\u7136\u540e\u518d\u7ed3\u5408 proxy","_","pass \u6216\u5176\u4ed6\u4ee3\u7406\u6307\u4ee4\u5c06\u76f8\u5e94\u7684\u8bf7\u6c42\u8f6c\u53d1\u5230\u6c60\u5185\u3002"),(0,l.kt)("p",null,"\u670d\u52a1\u5668\u6c60\u53ef\u4ee5\u6709\u591a\u53f0\u670d\u52a1\u5668\uff0c\u591a\u53f0\u670d\u52a1\u5668\u5982\u4f55\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u548c\u7b97\u6cd5\u6709\u5173\uff0c\u9ed8\u8ba4\u662f\u6307\u5b9a\u6743\u91cd\u7684\u52a0\u6743\u5747\u8861\u7b97\u6cd5\uff0c\u8fd8\u53ef\u4ee5\u6307\u5b9a ip","_","hash \u7b97\u6cd5\u5b9e\u73b0\u540c\u4e00\u4e2a\u5ba2\u6237\u7aef IP \u53d1\u8d77\u7684\u8bf7\u6c42\u603b\u662f\u8f6c\u53d1\u5230\u540c\u4e00\u53f0\u670d\u52a1\u5668\u4e0a\u3002\u8fd8\u6709\u4e00\u4e9b\u5176\u5b83\u7b97\u6cd5\uff0c\u5982\u6700\u5c0f\u8fde\u63a5\u6570\u7b97\u6cd5\u3002\u6700\u5e38\u7528\u7684\u8fd8\u662f\u52a0\u6743\u7b97\u6cd5\uff0c\u7136\u540e\u901a\u8fc7 session \u5171\u4eab\u7684\u65b9\u5f0f\u5b9e\u73b0\u540c\u4e00\u4e2a\u5ba2\u6237\u7aef IP \u53d1\u8d77\u7684\u8bf7\u6c42\u8f6c\u53d1\u5230\u540c\u4e00\u670d\u52a1\u5668\u4e0a\u3002"),(0,l.kt)("p",null,"\u4f8b\u5982\uff0c\u4e0b\u56fe\u63cf\u8ff0\u7684\u9700\u6c42\u3002\u5f53\u8bf7\u6c42\u56fe\u7247\u670d\u52a1\u5668\u65f6\uff0c\u53ef\u4ee5\u5c06\u8bf7\u6c42\u5747\u8861\u5230 IP3 \u548c IP4 \u4e24\u53f0\u670d\u52a1\u5668\u4e0a\uff0c\u5f53\u8bf7\u6c42\u5176\u4ed6\u9759\u6001\u5185\u5bb9\uff0c\u53ef\u4ee5\u5c06\u8bf7\u6c42\u5747\u8861\u5230 IP5 \u548c IP6 \u4e24\u53f0\u670d\u52a1\u5668\u4e0a\u3002"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"nginx upstream",src:t(94470).Z,width:"784",height:"609"})),(0,l.kt)("p",null,"\u8981\u5b9e\u73b0\u8fd9\u6837\u7684\u529f\u80fd\uff0cnginx-proxy \u4e0a\u7684 nginx \u914d\u7f6e\u6587\u4ef6\u5185\u5bb9\u5927\u81f4\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'http {\n    include mime.types;\n    default_type application/octet-stream;\n    sendfile on;\n    keepalive_timeout 65;\n\n    # define server pool\n    # \u6ce8\u610fupstream\u540e\u9762\u7684\u540d\u5b57\u4e0d\u80fd\u6709"_"\uff0c\u5426\u5219\u4f1a\u62a5400\u9519\u8bef\n    upstream DynamicPool {\n        server IP1:80;\n    }\n    upstream PicPool {\n        server IP3:80 weight=2;\n        server IP4:80 weight=1;\n    }\n    upstream StaticPool {\n        server IP5:80 weight=1;\n        server IP6:80 weight=1;\n    }\n\n    server {\n        listen 80;\n        server_name www.brinnatt.com;\n\n        # define how to proxy\n        location ~ \\.(php|php5)$ {\n            proxy_pass http://DynamicPool;\n        }\n        location ~ \\.(png|jpeg|jpg|bmp|gif)$ {\n            proxy_pass http://PicPool;\n        }\n        location / {\n            proxy_pass http://StaticPool;\n        }\n    }\n}\n')),(0,l.kt)("h3",{id:"7114ngx_http_proxy_module-\u6a21\u5757"},"7.11.4\u3001ngx","_","http","_","proxy","_","module \u6a21\u5757"),(0,l.kt)("h4",{id:"71141\u6307\u4ee4\u53ca\u5176\u610f\u4e49"},"7.11.4.1\u3001\u6307\u4ee4\u53ca\u5176\u610f\u4e49"),(0,l.kt)("p",null,"\u8be5\u6a21\u5757\u9ed8\u8ba4\u5b89\u88c5\u3002\u4ee5\u4e0b\u662f\u76f8\u5173\u6307\u4ee4\u7684\u8bf4\u660e\u3002"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"\u6307\u4ee4"),(0,l.kt)("th",{parentName:"tr",align:null},"\u6307\u4ee4\u610f\u4e49"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"proxy","_","pass"),(0,l.kt)("td",{parentName:"tr",align:null},"\u5b9a\u4e49\u4ee3\u7406\u5230\u54ea\u53f0\u670d\u52a1\u5668\u6216\u54ea\u4e2a upstream \u6c60")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"proxy","_","set","_","header"),(0,l.kt)("td",{parentName:"tr",align:null},'\u5728\u4ee3\u7406\u670d\u52a1\u5668\u4e0a\u8bbe\u7f6e http \u62a5\u5934\u4fe1\u606f\u3002\u5982\u52a0\u4e0a\u771f\u5b9e\u5ba2\u6237\u7aef\u5730\u5740 "proxy',"_","set","_","header X","_","Forwarded","_","For $remote","_",'addr"')),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"proxy","_","connect","_","timeout"),(0,l.kt)("td",{parentName:"tr",align:null},"\u53cd\u5411\u4ee3\u7406\u8fde\u63a5\u4e0a\u6e38\u670d\u52a1\u5668\u8282\u70b9\u7684\u8d85\u65f6\u65f6\u95f4\u3002\u53d1\u8d77\u65b9\u662f proxy \u65b9\uff0c\u5373\u7b49\u5f85\u63e1\u624b\u6210\u529f\u7684\u65f6\u95f4")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"proxy","_","send","_","timeout"),(0,l.kt)("td",{parentName:"tr",align:null},"\u4e0a\u6e38\u670d\u52a1\u5668\u8282\u70b9\u6570\u636e\u4f20\u7ed9\u4ee3\u7406\u670d\u52a1\u5668\u7684\u8d85\u65f6\u65f6\u95f4\u3002\u5373\u6b64\u65f6\u95f4\u6bb5\u5185\uff0c\u540e\u7aef\u8282\u70b9\u9700\u8981\u4f20\u5b8c\u6570\u636e\u7ed9\u4ee3\u7406\u670d\u52a1\u5668")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"proxy","_","read","_","timeout"),(0,l.kt)("td",{parentName:"tr",align:null},"\u5b9a\u4e49\u4ee3\u7406\u670d\u52a1\u5668\u4f55\u65f6\u5173\u95ed\u548c\u540e\u7aef\u670d\u52a1\u5668\u8fde\u63a5\u7684\u8d85\u65f6\u65f6\u957f\uff0c\u9ed8\u8ba4\u4e3a 60 \u79d2\uff0c\u8868\u793a\u67d0\u6b21\u540e\u7aef\u4f20\u8f93\u5b8c\u6570\u636e\u7ed9\u4ee3\u7406\u670d\u52a1\u5668\u540e\uff0c\u5982\u679c 60 \u79d2\u5185\u4ee3\u7406\u670d\u52a1\u5668\u548c\u540e\u7aef\u670d\u52a1\u5668\u6ca1\u6709\u4efb\u4f55\u4f20\u8f93\uff0c\u5219\u5173\u95ed\u6b64\u6b21\u8fde\u63a5\u3002\u76ee\u7684\u662f\u907f\u514d\u4ee3\u7406\u670d\u52a1\u5668\u548c\u540e\u7aef\u670d\u52a1\u5668\u4e00\u76f4\u4fdd\u6301\u8fde\u63a5\u4e0d\u65ad\u5f00\u800c\u5360\u7528\u8d44\u6e90")))),(0,l.kt)("h4",{id:"71142proxy_pass"},"7.11.4.2\u3001proxy","_","pass"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"proxy_pass http[s]://{ [IP:PORT/uri/] | upstream_pool };\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"\u5f53 proxy","_","pass \u6240\u5728\u7684 location \u4e2d\u4f7f\u7528\u4e86\u6b63\u5219\u5339\u914d\u65f6\uff0c\u5219 proxy","_","pass(\u5305\u62ec fastcgi","_","pass \u548c memcached","_","pass)\u5b9a\u4e49\u7684\u8f6c\u53d1\u8def\u5f84\u90fd\u4e0d\u80fd\u5305\u542b\u4efb\u4f55 URI \u4fe1\u606f\u3002")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"\u53e6\u5916\uff0clocation \u4e2d\u4f7f\u7528\u4e86\u5c3e\u968f\u659c\u7ebf\uff0c\u90a3\u4e48 proxy","_","pass \u5b9a\u4e49\u7684\u8f6c\u53d1\u8def\u5f84\u4e5f\u5fc5\u987b\u4f7f\u7528\u659c\u7ebf\uff0c\u6216\u8005\u90fd\u4e0d\u52a0\u5c3e\u968f\u659c\u7ebf\u3002"))),(0,l.kt)("p",null,"\u4f8b\u5982\u4e0b\u9762\u7684\u914d\u7f6e\u65b9\u5f0f\u662f\u5141\u8bb8\u7684\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"server_name www.brinnatt.com;\nlocation /forum/ {\n    proxy_pass http://192.168.122.46:8080/bbs/;\n}\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5f53\u8bbf\u95ee ",(0,l.kt)("a",{parentName:"li",href:"http://www.brinnatt.com/forum/"},"www.brinnatt.com/forum/")," \u65f6\u5c06\u88ab\u8f6c\u53d1\u5230 ",(0,l.kt)("a",{parentName:"li",href:"http://192.168.122.46:8080/bbs/%E4%B8%8A"},"http://192.168.122.46:8080/bbs/\u4e0a"),"\uff1a")),(0,l.kt)("p",null,"\u800c\u5982\u679c\u4f7f\u7528\u4e86",(0,l.kt)("strong",{parentName:"p"},"\u6b63\u5219\u5339\u914d"),"\uff0c\u5c06\u662f",(0,l.kt)("strong",{parentName:"p"},"\u4e0d\u5141\u8bb8"),"\u7684\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"server_name www.brinnatt.com;\nlocation ~ ^/forum/ {\n    proxy_pass http://192.168.122.46:8080/bbs/;\n}\n")),(0,l.kt)("p",null,"\u53ea\u80fd\u4fee\u6539\u8f6c\u53d1\u8def\u5f84\u4f7f\u5176\u4e0d\u5305\u542b URI\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"server_name www.brinnatt.com;\nlocation ~ ^/forum/ {\n    proxy_pass http://192.168.122.46:8080/;\n}\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u6b64\u65f6\u8bf7\u6c42 ",(0,l.kt)("a",{parentName:"li",href:"http://www.brinnatt.com/forum/"},"www.brinnatt.com/forum/")," \u5c06\u8f6c\u53d1\u5230 ",(0,l.kt)("a",{parentName:"li",href:"http://192.168.122.46:8080/forum/"},"http://192.168.122.46:8080/forum/"),"\u3002")),(0,l.kt)("h4",{id:"71143proxy_set_header"},"7.11.4.3\u3001proxy","_","set","_","header"),(0,l.kt)("p",null,"\u53ef\u4ee5\u5728 nginx \u914d\u7f6e\u6587\u4ef6\u4e2d\u7684 http \u6bb5\u3001server \u6bb5\u6216 location \u6bb5\u8bbe\u7f6e proxy","_","set","_","header \u6307\u4ee4\u3002\u8bbe\u7f6e\u8be5\u6307\u4ee4\u540e\uff0c\u4f20\u8f93\u7ed9\u4e0a\u6e38\u670d\u52a1\u5668\u7684\u62a5\u6587\u9996\u90e8\u5c06\u5305\u542b\u76f8\u5173\u7684\u4fe1\u606f\uff0c\u5982\u8bbe\u7f6e\u5ba2\u6237\u7aef\u7684\u771f\u5b9e IP \u5730\u5740\u3002\u8bbe\u7f6e\u5982\u4e0b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"server {\n    listen       80;\n    server_name  www.brinnatt.com;\n    location ~ \\.(png|jpg|jpeg|bmp|gif)$ {\n        proxy_pass http://192.168.122.48:80;\n        proxy_set_header X-Forwarded-For $remote_addr;\n    }\n    location / {\n        proxy_pass http://192.168.122.49:80/;\n        proxy_set_header X-Forwarded-For $remote_addr;\n    }\n    location ~ \\.(php|php5)$ {\n        proxy_pass http://192.168.122.46:80;\n        proxy_set_header X-Forwarded-For $remote_addr;\n    }\n    error_page   500 502 503 504  /50x.html;\n    location = /50x.html {\n        root   html;\n    }\n}\n")),(0,l.kt)("p",null,"\u4ec5\u5728\u4ee3\u7406\u670d\u52a1\u5668\u4e0a\u8bbe\u7f6e\u4e86\u8be5\u5934\u90e8\u5b57\u6bb5\u540e\u8fd8\u4e0d\u591f\uff0c\u56e0\u4e3a\u540e\u7aef\u670d\u52a1\u5668\u4ec5\u4ec5\u53ea\u662f\u83b7\u53d6\u5230\u5b83\uff0c\u9ed8\u8ba4\u5e76\u6ca1\u6709\u5c06\u5176\u8bb0\u5f55\u4e0b\u6765\u3002\u6240\u4ee5\u9700\u8981\u5728\u540e\u7aef\u7684\u670d\u52a1\u7684\u65e5\u5fd7\u683c\u5f0f\u8bbe\u7f6e\u4e0a\u8bb0\u5f55\u6b64\u9879\u6216\u8005\u5728\u5176\u4ed6\u6709\u9700\u6c42\u7684\u5730\u65b9\u8bbe\u7f6e\u5b83\u3002nginx \u7684\u65e5\u5fd7\u683c\u5f0f\u548c apache \u7684\u65e5\u5fd7\u8bbe\u7f6e\u683c\u5f0f\u4e0d\u540c\uff0c\u4ee5\u4e0b\u5206\u522b\u662f\u4e24\u79cd web \u7a0b\u5e8f\u7684\u8bbe\u7f6e\u65b9\u6cd5\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'# nginx\u4e0a\u7684\u65e5\u5fd7\u8bbe\u7f6e\u683c\u5f0f\nlog_format  main    \'$remote_addr - $remote_user [$time_local] "$request" \'\n                    \'$status $body_bytes_sent "$http_referer" \'\n                    \'"$http_user_agent" "$http_x_forwarded_for" \';\naccess_log logs/access.log main;\n\n# apache\u4e0a\u7684\u65e5\u5fd7\u8bbe\u7f6e\u683c\u5f0f\nLogFormat "%{X-Forwarded-For}i %h %l %u %t \\"%r\\" %>s %b \\"%{Referer}i\\" \\"%{User-Agent}i\\"" combined\n')),(0,l.kt)("h3",{id:"7115ngx_http_upstream_module-\u6a21\u5757"},"7.11.5\u3001ngx","_","http","_","upstream","_","module \u6a21\u5757"),(0,l.kt)("p",null,'upstream \u6a21\u5757\u5b9a\u4e49\u4e0a\u6e38\u670d\u52a1\u5668\u7ec4\u3002\u4e3b\u8981\u7684\u6307\u4ee4\u6709 "upstream"\u3001"server"\u3001"ip',"_",'hash"\u3002upstream \u6307\u4ee4\u5fc5\u987b\u5b9a\u4e49\u5728 server \u6bb5\u5916\u9762\u3002'),(0,l.kt)("p",null,"\u4ee5\u4e0b\u662f\u4e00\u4e2a\u7efc\u5408\u793a\u4f8b\u5b9a\u4e49\u65b9\u6cd5\uff0c\u6709\u77db\u76fe\u7684\u5730\u65b9\uff0c\u53ea\u662f\u653e\u5728\u4e00\u8d77\u65b9\u4fbf\u6bd4\u8f83\u7528\u6cd5\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"upstream backend {\n    server 192.168.122.45;\n    server 192.168.122.46:80;\n    server www.brinnatt.com;\n    server www.brinnatt.com:8080;\n    server 192.168.122.47 weight=2 max_fails=2 fail_timeout=2s;\n    server 192.168.122.48 down;\n    server 192.168.122.49 backup;\n    ip_hash;   # \u5b9a\u4e49\u6b64\u9879\u540e\uff0c\u524d\u9762\u7684server\u9644\u52a0\u9879weight\u548cbackup\u529f\u80fd\u5931\u6548\u3002\n}\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u9ed8\u8ba4\u4f7f\u7528\u52a0\u6743\u5747\u8861\u7b97\u6cd5\uff0c\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"li"},"ip_hash")," \u6307\u4ee4\u53ef\u8bbe\u7f6e\u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"ip_hash")," \u7b97\u6cd5\uff0c\u4f46\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"li"},"ip_hash")," \u6307\u4ee4\u540e\uff0c\u5982\u679c server \u6307\u4ee4\u4e2d\u4f7f\u7528\u4e86 weight \u548c backup \u9009\u9879\uff0c\u8fd9\u4e24\u4e2a\u529f\u80fd\u5c06\u4f1a\u5931\u6548\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u5176\u4e2d server \u6307\u4ee4\u540e\u53ef\u4ee5\u8ddf\u7684\u9644\u52a0\u9009\u9879\u6709\uff1a",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"weight"),"\uff1a\u5b9a\u4e49\u8be5\u540e\u7aef\u670d\u52a1\u5668\u5728\u7ec4\u4e2d\u7684\u6743\u91cd\uff0c\u9ed8\u8ba4\u4e3a 1\uff0c\u6743\u91cd\u8d8a\u5927\uff0c\u4ee3\u7406\u8f6c\u53d1\u5230\u6b64\u670d\u52a1\u5668\u6b21\u6570\u8d8a\u591a\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"max_fails")," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},"fail_timeout"),"\uff1a\u5b9a\u4e49\u4ee3\u7406\u670d\u52a1\u5668\u8054\u7cfb\u540e\u7aef\u670d\u52a1\u5668\u7684\u5931\u8d25\u91cd\u8054\u7cfb\u6b21\u6570\u548c\u5931\u8d25\u540e\u91cd\u8bd5\u7b49\u5f85\u65f6\u95f4\u3002\u9ed8\u8ba4\u4e3a 1 \u548c 10\uff0c\u5982\u679c\u8bbe\u7f6e\u4e3a 2 \u548c 3\uff0c\u5219\u8868\u793a\u53ea\u5c1d\u8bd5\u8054\u7cfb 2 \u6b21\uff0c\u6bcf\u6b21\u5931\u8d25\u7b49\u5f85 3 \u79d2\u540e\u8fdb\u884c\u4e0b\u4e00\u6b21\u91cd\u8bd5\uff0c\u4e5f\u5c31\u662f\u8bf4 6 \u79d2\u540e\u5c31\u80fd\u5224\u5b9a\u6b64\u540e\u7aef\u670d\u52a1\u5668\u65e0\u6cd5\u8054\u7cfb\u4e0a\uff0c\u5c06\u8d1f\u8f7d\u5747\u8861\u5230\u4e0b\u4e00\u53f0\u670d\u52a1\u5668\u4e0a\u3002\u5e38\u4f1a\u914d\u5408 proxy","_","next","_","upstream \u6216\u8005 fastcgi","_","next","_","upstream \u6216\u8005 memcached","_","next","_","upstream \u6765\u6307\u5b9a\u5931\u8d25\u65f6\u5982\u4f55\u5904\u7406\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"down"),"\uff1a\u5c06\u6b64\u540e\u7aef\u670d\u52a1\u5668\u5b9a\u4e49\u4e3a\u79bb\u7ebf\u72b6\u6001\u3002\u6b64\u529f\u80fd\u4e0d\u540c\u4e8e\u76f4\u63a5\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u5220\u9664\u6b64\u670d\u52a1\u5668\u914d\u7f6e\u6216\u6ce8\u91ca\u5b83\u3002\u5e38\u7528\u4e8e ip","_","hash \u5747\u8861\u7b97\u6cd5\u3002\u5f53\u4f7f\u7528 ip","_","hash \u7b97\u6cd5\u65f6\uff0c\u5982\u679c\u67d0\u53f0\u670d\u52a1\u5668\u574f\u4e86\u9700\u8981\u5c06\u5176\u4ece\u670d\u52a1\u5668\u7ec4\u4e2d\u6392\u9664\uff0c\u76f4\u63a5\u4ece\u914d\u7f6e\u6587\u4ef6\u4e2d\u5220\u9664\u8be5\u670d\u52a1\u5668\u5c06\u4f1a\u5bfc\u81f4\u6b64\u524d\u5206\u914d\u5230\u6b64\u540e\u7aef\u670d\u52a1\u5668\u7684\u5ba2\u6237\u7aef\u91cd\u65b0\u8ba1\u7b97 IP","_","HASH \u503c\uff0c\u800c\u4f7f\u7528 down \u5219\u4e0d\u4f1a\u3002"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"backup"),"\uff1a\u6307\u5b9a\u5f53\u5176\u4ed6\u975e backup \u7684 server \u90fd\u8054\u7cfb\u4e0d\u4e0a\u65f6\uff0c\u5c06\u8fd4\u56de backup \u6240\u5b9a\u4e49\u7684\u670d\u52a1\u5668\u5185\u5bb9\u3002\u5e38\u7528\u4e8e\u663e\u793a sorry page\u3002"))),(0,l.kt)("li",{parentName:"ul"},"\u5f53 server \u6307\u5b9a\u540e\u7aef\u670d\u52a1\u5668\u65f6\u4f7f\u7528\u7684\u662f\u4e3b\u673a\u540d\u7684\u65b9\u5f0f\u65f6\uff0c\u9700\u8981\u5728\u4ee3\u7406\u670d\u52a1\u5668\u4e0a\u6dfb\u52a0\u57df\u540d\u89e3\u6790\u8bb0\u5f55\uff0c\u5982\u653e\u5230 /etc/hosts \u4e2d\u3002")),(0,l.kt)("p",null,"\u4ee5\u4e0b\u662f\u4e00\u4e2a\u914d\u7f6e\u793a\u4f8b\u3002\u53ea\u5b9a\u4e49\u4e86\u4e00\u4e2a upstream \u7ec4\uff0c\u6240\u6709\u8bf7\u6c42\u90fd\u4ee3\u7406\uff0c\u6743\u91cd\u4e3a 2 \u6bd4 1\uff0c\u5f53 192.168.122.48 \u548c 192.168.122.49 \u90fd\u65ad\u5f00\u8054\u7cfb\u65f6\uff0c\u5c06\u8fd4\u56de\u4ee3\u7406\u670d\u52a1\u5668\u672c\u8eab\u914d\u7f6e\u7684 sorrypage\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"http {\n    include             mime.types;\n    default_type        application/octet-stream;\n    sendfile            on;\n    keepalive_timeout   65;\n\n    upstream WebGroup {\n        server 192.168.122.48 weight=2 max_fails=2 fail_timeout=2s;\n        server 192.168.122.49 weight=1 max_fails=2 fail_timeout=2s;\n        server 127.0.0.1:80 backup;\n    }\n    server {\n        listen 127.0.0.1:80;\n        root /www/brinnatt/;\n        index index.html;\n    }\n    server {\n        listen       80;\n        server_name  www.brinnatt.com;\n        location / {\n                proxy_pass http://WebGroup;\n        }\n        error_page   500 502 503 504  /50x.html;\n        location = /50x.html {\n                root   html;\n        }\n    }\n}\n")),(0,l.kt)("p",null,'\u7136\u540e\u5728\u53cd\u5411\u4ee3\u7406\u670d\u52a1\u5668\u4e0a\u521b\u5efa /www/brinnatt/ \u76ee\u5f55\uff0c\u5e76\u5411\u76ee\u5f55\u4e0b\u7684 index.html \u6587\u4ef6\u4e2d\u5199\u5165 "sorry...."\u3002'),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'mkdir -p /www/brinnatt/\necho "<h1>sorry pages...</h1>" >/www/brinnatt/index.html\n')),(0,l.kt)("p",null,"\u91cd\u8f7d\u4ee3\u7406\u670d\u52a1\u5668\u3002\u5728\u6d4f\u89c8\u5668\u4e0a\u8f93\u5165 ",(0,l.kt)("a",{parentName:"p",href:"http://www.brinnatt.com"},"www.brinnatt.com")," \u5e76\u4e0d\u65ad\u5237\u65b0\uff0c\u7ed3\u679c\u5e94\u8be5\u662f 2:1 \u7684\u8fd4\u56de\u6743\u91cd\u3002\u518d\u4f9d\u6b21\u6d4b\u8bd5\u505c\u6389\u67d0\u4e00\u53f0\u540e\u7aef\u670d\u52a1\u5668\u548c\u4e24\u53f0\u540e\u7aef\u90fd\u505c\u6389\u7684\u60c5\u51b5\u3002"),(0,l.kt)("h3",{id:"7116\u53cd\u5411\u4ee3\u7406\u591a\u79cd\u7c7b\u578b"},"7.11.6\u3001\u53cd\u5411\u4ee3\u7406\u591a\u79cd\u7c7b\u578b"),(0,l.kt)("p",null,"\u53cd\u5411\u4ee3\u7406\u65f6\uff0c\u53ef\u4ee5\u6839\u636e uri \u7684\u540e\u7f00\u6765\u4ee3\u7406\uff0c\u4e5f\u53ef\u4ee5\u6839\u636e uri \u4e2d\u7684\u76ee\u5f55\u6765\u4ee3\u7406\uff0c\u8fd8\u53ef\u4ee5\u6839\u636e\u5ba2\u6237\u7aef\u6d4f\u89c8\u5668\u7c7b\u578b\u6765\u4ee3\u7406\u3002\u4f8b\u5982\u624b\u673a\u8bbf\u95ee\u7f51\u7ad9\u65f6\u8f6c\u53d1\u5230\u67d0\u4e2a\u540e\u7aef\u670d\u52a1\u5668\u7ec4\uff0cIE \u6d4f\u89c8\u5668\u8bbf\u95ee\u7684\u8f6c\u53d1\u5230\u67d0\u4e00\u4e2a\u540e\u7aef\u670d\u52a1\u5668\u7ec4\u7b49\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'# uri\u540e\u7f00\u4ee3\u7406\u3002\nlocation ~ \\.(jpeg|jpg|png|bmp|gif)$ {\n    proxy_pass ...\n}\n\n# \u76ee\u5f55\u4ee3\u7406\u3002\nlocation ~ /forum/ {\n    proxy_pass ...\n}\n\n# \u6d4f\u89c8\u5668\u7c7b\u578b\u4ee3\u7406\u3002\nlocation / {\n    if ($http_user_agent ~ "MSIE") {\n        proxy_pass...\n    }\n    if ($http_user_agent ~ "Chrome") {\n        proxy_pass...\n    }\n}\n')),(0,l.kt)("h3",{id:"7117nginx-\u4ee3\u7406-memcached"},"7.11.7\u3001nginx \u4ee3\u7406 memcached"),(0,l.kt)("p",null,"nginx \u4ee3\u7406\u6a21\u5757\u53ef\u4ee5\u5c06\u8bf7\u6c42\u4ee3\u7406\u81f3 memcached server \u4e0a\uff0c\u5e76\u7acb\u5373\u4ece server \u4e0a\u83b7\u53d6\u54cd\u5e94\u6570\u636e\u3002\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'location / {\n    set $memcached_key "$uri?$args";\n    memcached_pass     127.0.0.1:11211;\n}\n')),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"nginx \u4ee3\u7406 memcached \u65f6\uff0c\u9700\u8981\u4ee5\u53d8\u91cf ",(0,l.kt)("inlineCode",{parentName:"p"},"$memcached_key")," \u4f5c\u4e3a key \u53bb\u8bbf\u95ee memcached server \u4e0a\u7684\u6570\u636e\u3002\u4f8b\u5982\u6b64\u5904\u5c06 ",(0,l.kt)("inlineCode",{parentName:"p"},"$uri$args")," \u53d8\u91cf\u8d4b\u503c\u7ed9 ",(0,l.kt)("inlineCode",{parentName:"p"},"$memcached_key")," \u53d8\u91cf\u4f5c\u4e3a key \u53bb\u8bbf\u95ee memcached \u670d\u52a1\u5668\u4e0a\u5bf9\u5e94\u7684\u6570\u636e\u3002")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u4f46\u8fd9\u6837\u7684\u4ee3\u7406\u663e\u7136\u4e0d\u7b26\u5408\u771f\u6b63\u7684\u9700\u6c42\uff1a\u6ca1\u6709\u5b9e\u73b0 memcached \u7684\u5206\u5e03\u5f0f\u529f\u80fd\u3002\u5f53 memcached server \u5b95\u673a\u65f6\uff0cnginx \u5c06\u65e0\u6cd5\u4ece\u4e2d\u83b7\u53d6\u4efb\u4f55\u6570\u636e\u3002\u6240\u4ee5\u5e94\u8be5\u4f7f\u7528\u4e0a\u6e38\u670d\u52a1\u5668\u7ec4\u3002\u4f8b\u5982\uff1a"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'upstream memcached {\n  server 127.0.0.1:11211;\n  server 127.0.0.1:11212;\n  server 127.0.0.1:11213;\n  server 127.0.0.1:11214;\n}\n\nserver {\n  listen       80;\n  server_name  dev.brinnatt.com;\n\n  location ^~ /cache/ {\n      set            $memcached_key "$uri$args";\n      memcached_pass memcached;\n  }\n}\n')),(0,l.kt)("p",{parentName:"li"},"\u4f46\u8fd9\u4e5f\u4e0d\u9002\u5408\uff0c\u56e0\u4e3a memcached \u662f\u57fa\u4e8e\u4e00\u81f4\u6027\u54c8\u5e0c\u7b97\u6cd5\u7684\uff0c\u800c upstream \u6a21\u5757\u9ed8\u8ba4\u5e76\u4e0d\u652f\u6301\u4e00\u81f4\u6027\u54c8\u5e0c\u7b97\u6cd5\u3002\u53ef\u4ee5\u901a\u8fc7 upstream \u6a21\u5757\u7684 ",(0,l.kt)("a",{parentName:"p",href:"http://nginx.org/en/docs/http/ngx_http_upstream_module.html#hash"},"hash")," \u6307\u4ee4\u6216\u8005\u53e6\u5916\u4f7f\u7528\u4e00\u4e2a\u7b2c\u4e09\u65b9\u6a21\u5757 ",(0,l.kt)("a",{parentName:"p",href:"https://www.nginx.com/resources/wiki/modules/consistent_hash/"},"ngx","_","http","_","upstream","_","consistent","_","hash"),"\u3002"),(0,l.kt)("p",{parentName:"li"},"\u5982\u679c\u4f7f\u7528\u7684\u662f upstream \u6a21\u5757\u7684 hash \u6307\u4ee4\uff0c\u914d\u7f6e\u5982\u4e0b\uff1a"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'upstream memcached {\n  hash "$uri$args" consistent;\n  server 127.0.0.1:11211;\n  server 127.0.0.1:11212;\n  server 127.0.0.1:11213;\n  server 127.0.0.1:11214;\n}\n')),(0,l.kt)("p",{parentName:"li"},"\u8fd9\u6837\uff0c\u5404\u4e0a\u6e38\u4e3b\u673a\u5c31\u901a\u8fc7 hash \u4e00\u81f4\u6027\u7684\u7b97\u6cd5\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\u3002"),(0,l.kt)("p",{parentName:"li"},"\u5982\u679c\u4f7f\u7528\u7684\u662f\u7b2c\u4e09\u65b9\u6a21\u5757 ngx","_","http","_","upstream","_","consistent","_","hash\uff0c\u5219\u5728\u6a21\u5757\u6dfb\u52a0\u6210\u529f\u540e\u5982\u4e0b\u914d\u7f6e upstream \u7ec4\uff1a"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"upstream memcached {\n  consistent_hash consistent;\n  server 127.0.0.1:11211;\n  server 127.0.0.1:11212;\n  server 127.0.0.1:11213;\n  server 127.0.0.1:11214;\n}\n")))),(0,l.kt)("h2",{id:"712nginx-\u7f13\u5b58\u529f\u80fd"},"7.12\u3001nginx \u7f13\u5b58\u529f\u80fd"),(0,l.kt)("p",null,"nginx \u7684 ngx","_","http","_","proxy","_","module \u81ea\u5e26\u4e86\u7f13\u5b58\u529f\u80fd\u3002\u6709\u51e0\u79cd\u7f13\u5b58\uff1a\u7f51\u9875\u5185\u5bb9\u7f13\u5b58\uff0c\u65e5\u5fd7\u7f13\u5b58\uff0c\u6253\u5f00\u6587\u4ef6\u7f13\u5b58\uff0cfastcgi \u7f13\u5b58\u3002fastcgi \u7f13\u5b58\u529f\u80fd\u5e94\u614e\u7528\uff0c\u56e0\u4e3a\u52a8\u6001\u7a0b\u5e8f\u7684\u524d\u540e\u903b\u8f91\u53ef\u80fd\u6539\u53d8\u4e86\uff0c\u7f13\u5b58\u540e\u7684\u7ed3\u679c\u53ef\u80fd\u5e76\u975e\u5b9e\u9645\u6240\u9700\u7ed3\u679c\u3002"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"nginx \u81ea\u5e26\u7684\u7f13\u5b58\u529f\u80fd\u6709\u4e00\u5b9a\u7684\u7f3a\u9677\uff0cnginx \u7684\u7f13\u5b58\u529f\u80fd\u4e3b\u8981\u7528\u4e8e\u7f13\u5b58\u4f53\u79ef\u8f83\u5c0f\u7684\u9875\u9762\u8d44\u6e90\uff0c\u5f53\u6570\u636e\u8f83\u5927\u65f6\u5f88\u5bb9\u6613\u51fa\u73b0\u74f6\u9888\u3002"),(0,l.kt)("li",{parentName:"ul"},"squid \u529f\u80fd\u6700\u5168\u9762\uff0c\u53ef\u4ee5\u7f13\u5b58\u5927\u91cf\u6570\u636e\uff0c\u4f46\u67b6\u6784\u592a\u8001\uff0c\u6027\u80fd\u4e00\u822c\u3002"),(0,l.kt)("li",{parentName:"ul"},"varnish \u67b6\u6784\u8f83\u65b0\uff0c\u5185\u5b58\u7ba1\u7406\u5b8c\u5168\u4ea4\u7531\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\uff0c\u6027\u80fd\u662f squid \u7684\u51e0\u500d\u4e4b\u5f3a\uff0c\u4f46\u7f13\u5b58\u7684\u5185\u5bb9\u4e0d\u5982 squid\u3002")),(0,l.kt)("p",null,"\u672c\u8282\u6240\u8bb2\u7684\u4e3b\u8981\u662f nginx \u81ea\u5e26\u7f13\u5b58\u7684\u7f51\u9875\u5185\u5bb9\u7f13\u5b58\u3002\u5f53\u5b9e\u73b0\u7f51\u9875\u5185\u5bb9\u7f13\u5b58\u65f6\uff0c\u4f5c\u4e3a web \u670d\u52a1\u7a0b\u5e8f\uff0c\u5b83\u53ef\u4ee5\u7f13\u5b58\u81ea\u8eab\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u7684\u6570\u636e\uff0c\u5305\u62ec\u8bfb\u53d6\u7684\u56fe\u7247\u3001\u6587\u4ef6\u7b49\uff1b\u4f5c\u4e3a\u4ee3\u7406\uff0c\u5b83\u53ef\u4ee5\u7f13\u5b58\u6765\u81ea\u540e\u7aef\u7684\u6570\u636e\u3002"),(0,l.kt)("p",null,"\u7f13\u5b58\u540e\u7684\u6570\u636e\u5728\u5185\u5b58\u4e2d\u6709\uff0c\u4e5f\u4f1a\u653e\u5728\u8bbe\u5b9a\u7684\u76ee\u5f55\u4e0b\u3002\u8fd9\u6837\u4ee5\u540e\u5ba2\u6237\u7aef\u7ee7\u7eed\u8bf7\u6c42\u76f8\u540c\u8d44\u6e90\u65f6\uff0c\u53ef\u4ee5\u76f4\u63a5\u4ece\u5185\u5b58\u4e2d\u6216\u8005\u81ea\u8eab\u7684\u78c1\u76d8\u4e2d\u83b7\u53d6\u5e76\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002"),(0,l.kt)("p",null,"\u5f53\u7f13\u5b58\u8d85\u51fa\u6307\u5b9a\u7684\u7a7a\u95f4\u5927\u5c0f\u65f6\uff0c\u5c06\u4f1a\u6709\u4e00\u4e2a\u4e13\u95e8\u7684\u7ebf\u7a0b cache","_","manager \u6765\u6e05\u7406\u7f13\u5b58\u3002"),(0,l.kt)("p",null,"\u5b9a\u4e49\u7684\u76f8\u5173\u6307\u4ee4\u4e3b\u8981\u6709 3 \u4e2a\uff1aproxy","_","cache","_","path\u3001proxy","_","cache\u3001proxy","_","cache","_","valid\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("inlineCode",{parentName:"p"},"proxy_cache_path"),"\uff1a\u5b83\u7684\u8bed\u6cd5\u6bd4\u8f83\u590d\u6742\uff0c\u4f46\u7528\u8d77\u6765\u5f88\u7b80\u5355\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"proxy_cache_path path [levels=levels] [use_temp_path=on|off] keys_zone=name:size [inactive=time] [max_size=size] [manager_files=number] [manager_sleep=time] [manager_threshold=time] [loader_files=number] [loader_sleep=time] [loader_threshold=time] [purger=on|off] [purger_files=number] [purger_sleep=time] [purger_threshold=time];\n")),(0,l.kt)("p",{parentName:"li"},"\u5176\u4e2d ",(0,l.kt)("inlineCode",{parentName:"p"},"proxy_cache_path path [levels=levels] keys_zone=name:size [max_size=size]")," \u8fd9\u51e0\u9879\u662f\u4e00\u822c\u4f7f\u7528\u7684\u9009\u9879\u548c\u5fc5\u9700\u9879\u3002\u4ee5\u4e0b\u4e3a\u4e00\u793a\u4f8b\uff1a"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"proxy_cache_path /usr/local/nginx/cache_dir levels=1:2 keys_zone=cache_one:20m max_size=1g;\n")),(0,l.kt)("ol",{parentName:"li"},(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("inlineCode",{parentName:"li"},"path"),"\uff1a\u5b9a\u4e49\u7f13\u5b58\u653e\u5728\u78c1\u76d8\u7684\u54ea\u4e2a\u76ee\u5f55\u4e0b\u3002\u6b64\u5904\u8868\u793a\u5b9a\u4e49\u5728 /usr/local/nginx/cache","_","dir \u76ee\u5f55\u4e0b\u3002\u76ee\u5f55\u4e0d\u5b58\u5728\u4f1a\u81ea\u52a8\u521b\u5efa\u3002"),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("inlineCode",{parentName:"li"},"levels"),"\uff1a\u5b9a\u4e49\u7f13\u5b58\u76ee\u5f55\u7684\u7ea7\u522b\uff0c\u540c\u65f6\u5b9a\u4e49\u7f13\u5b58\u76ee\u5f55\u540d\u79f0\u7684\u5b57\u7b26\u6570\u3002\u4f8b\u5982 ",(0,l.kt)("inlineCode",{parentName:"li"},"levels=1:2:2"),' \u8868\u793a 3 \u7ea7\u76ee\u5f55\uff0c\u4e14\u7b2c\u4e00\u7ea7\u76ee\u5f55\u540d 1 \u4e2a\u5b57\u7b26\uff0c\u7b2c\u4e8c\u7ea7\u76ee\u5f55 2 \u4e2a\u5b57\u7b26\uff0c\u7b2c\u4e09\u7ea7\u76ee\u5f55 2 \u4e2a\u5b57\u7b26\u3002\u76ee\u5f55\u6700\u591a 3 \u7ea7\uff0c\u76ee\u5f55\u540d\u6700\u591a\u4e3a 2 \u4e2a\u5b57\u7b26\u3002\u4f8b\u5982\u4e0a\u4f8b\u4e2d "levels=1:2" \u4ea7\u751f\u7684\u7f13\u5b58\u6587\u4ef6\u8def\u5f84\u53ef\u80fd\u662f\u8fd9\u6837\u7684 "/usr/local/nginx/cache',"_",'dir/d/f1/50a3269acaa7774c02d4da0968124f1d"\uff0c\u6ce8\u610f\u5176\u4e2d\u52a0\u7c97\u7684\u5b57\u4f53\u3002'),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("inlineCode",{parentName:"li"},"keys_zone"),"\uff1a\u5b9a\u4e49\u7f13\u5b58\u6807\u8bc6\u540d\u79f0\u548c\u5185\u5b58\u4e2d\u7f13\u5b58\u7684\u6700\u5927\u7a7a\u95f4\u3002name \u90e8\u5206\u5fc5\u987b\u552f\u4e00\uff0c\u5728\u540e\u9762\u4f1a\u5f15\u7528 name \u6765\u8868\u793a\u4f7f\u7528\u8be5\u7f13\u5b58\u65b9\u6cd5\u3002"),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("inlineCode",{parentName:"li"},"max_size"),"\uff1a\u5b9a\u4e49\u78c1\u76d8\u4e2d\u7f13\u5b58\u76ee\u5f55\u7684\u6700\u5927\u7a7a\u95f4\u3002\u5373 path \u5b9a\u4e49\u7684\u6587\u4ef6\u6700\u5927\u7a7a\u95f4\u3002")),(0,l.kt)("p",{parentName:"li"},"\u8be5\u6307\u4ee4\u5b9a\u4e49\u540e\u53ea\u662f\u5b9a\u4e49\u4e86\u4e00\u79cd\u7f13\u5b58\u65b9\u6cd5\uff0c\u5e76\u975e\u5f00\u542f\u4e86\u7f13\u5b58\u3002")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("inlineCode",{parentName:"p"},"proxy_cache"),"\uff1a\u5b9a\u4e49\u8981\u4f7f\u7528\u54ea\u4e2a\u7f13\u5b58\u65b9\u6cd5\u3002\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"proxy_cache_path")," \u4e2d\u7684 name \u6765\u5f15\u7528\u3002"),(0,l.kt)("p",{parentName:"li"},"\u4f8b\u5982\u5f15\u7528\u4e0a\u4f8b\u5b9a\u4e49\u7684 cache","_","one\uff1a"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"proxy_cache cache_one;\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("inlineCode",{parentName:"p"},"proxy_cache_valid"),"\uff1a\u6839\u636e\u72b6\u6001\u7801\u6765\u6307\u5b9a\u7f13\u5b58\u6709\u6548\u671f\u3002"),(0,l.kt)("p",{parentName:"li"},"\u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u8868\u793a\u72b6\u6001\u7801\u4e3a 200 \u548c 302 \u7684\u72b6\u6001\u7f13\u5b58 1 \u5c0f\u65f6\uff0c\u72b6\u6001\u7801\u4e3a 404 \u65f6\u5373 page not found \u7684\u7f13\u5b58\u53ea\u6709 1 \u5206\u949f\uff0c\u9632\u6b62\u5ba2\u6237\u7aef\u8bf7\u6c42\u4e00\u76f4\u9519\u8bef\uff0c\u72b6\u6001\u7801\u4e3a\u5176\u4ed6\u7684\u5219\u7f13\u5b58 5 \u5206\u949f\u3002"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"proxy_cache_valid 200 302 1h;\nproxy_cache_valid 404 1m;\nproxy_cache_valid any 5m;\n")),(0,l.kt)("p",{parentName:"li"},"\u5982\u679c\u4e0d\u6307\u5b9a\u72b6\u6001\u7801\uff0c\u53ea\u6307\u5b9a\u65f6\u95f4\uff0c\u5219\u9ed8\u8ba4\u53ea\u7f13\u5b58\u72b6\u6001\u7801 200\u3001301\u3001302 \u5404 5 \u5206\u949f\uff0c\u5176\u4ed6\u7684\u72b6\u6001\u7801\u4e0d\u7f13\u5b58\u3002"))),(0,l.kt)("p",null,"\u4ee5\u4e0b\u662f\u4ee3\u7406\u670d\u52a1\u5668 192.168.122.45 \u4e0a\u5b9a\u4e49\u7684\u7f13\u5b58\u793a\u4f8b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'http {\n    include             mime.types;\n    default_type        application/octet-stream;\n    sendfile            on;\n    keepalive_timeout   65;\n\n        # \u6ce8\u610fupstream\u540e\u9762\u53d6\u540d\u5b57\uff0c\u4e0d\u8981\u4f7f\u7528"_"\uff0c\u4f1a\u62a5400\u9519\u8bef\n        upstream WebGroup {\n                server 192.168.122.48 weight=2 max_fails=2 fail_timeout=2s;\n                server 192.168.122.49 weight=1 max_fails=2 fail_timeout=2s;\n                server 127.0.0.1:80 backup;\n        }\n        proxy_cache_path /usr/local/nginx/cache_dir levels=1:2 keys_zone=cache_one:20m max_size=1g;\n        server {\n                listen 127.0.0.1:80;\n                root /www/brinnatt/;\n                index index.html;\n        }\n        server {\n                listen       80;\n                server_name  www.brinnatt.com;\n              # \u5728\u54cd\u5e94\u62a5\u6587\u4e2d\u6dfb\u52a0\u7f13\u5b58\u9996\u90e8\u5b57\u6bb5\n                add_header X-Cache "$upstream_cache_status from $server_addr";\n                location / {\n                        proxy_pass http://WebGroup;\n                        proxy_cache cache_one;\n                        proxy_cache_valid 200 1h;\n                        proxy_cache_valid 404 1m;\n                        proxy_cache_valid any 5m;\n                }\n\n        error_page   500 502 503 504  /50x.html;\n        location = /50x.html {\n            root   html;\n        }\n    }\n}\n')),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5176\u4e2d\u6dfb\u52a0\u7684\u4e00\u884c ",(0,l.kt)("inlineCode",{parentName:"li"},'"add_header X-Cache "$upstream_cache_status from $server_addr";"')," \u8868\u793a\u5728\u54cd\u5e94\u62a5\u6587\u7684\u5934\u90e8\u52a0\u4e0a\u4e00\u5b57\u6bb5 X-Cache\uff0c\u5176\u503c\u4e3a\u662f\u5426\u547d\u4e2d\u7f13\u5b58\u7684\u72b6\u6001 ",(0,l.kt)("inlineCode",{parentName:"li"},"$upstream_cache_status"),"\uff0c\u4ece\u54ea\u53f0\u670d\u52a1\u5668\u4e0a ",(0,l.kt)("inlineCode",{parentName:"li"},"$server_addr")," \u53d6\u5f97\u7684\u7f13\u5b58\u3002")),(0,l.kt)("p",null,'\u91cd\u8f7d\u4ee3\u7406\u670d\u52a1\u5668\u7684\u914d\u7f6e\u6587\u4ef6\u540e\uff0c\u5728\u5ba2\u6237\u7aef\u6253\u5f00 "\u5f00\u53d1\u8005\u5de5\u5177" \u8fdb\u884c\u6d4b\u8bd5\u3002'),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"nginx cache",src:t(87839).Z,width:"935",height:"804"})),(0,l.kt)("p",null,'\u7531\u4e8e\u662f\u7b2c\u4e00\u6b21\u63d0\u4f9b\u7f13\u5b58\u529f\u80fd\uff0c\u6240\u4ee5\u7ed3\u679c\u662f\u672a\u547d\u4e2d\u7f13\u5b58\u3002\u6b64\u65f6\u5df2\u7ecf\u5c06\u7f13\u5b58\u4fdd\u5b58\u4e0b\u6765\u4e86\u3002 \u518d\u8fdb\u884c\u6d4b\u8bd5\uff0c\u7ed3\u679c\u5c06\u547d\u4e2d\u7f13\u5b58\u662f "hit from 192.168.122.45"\u3002'),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"nginx cache hit",src:t(67717).Z,width:"936",height:"806"})),(0,l.kt)("p",null,"\u67e5\u770b\u7f13\u5b58\u76ee\u5f55\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"[root@fname1 ~]# tree /usr/local/nginx/cache_dir/\n/usr/local/nginx/cache_dir/\n\u251c\u2500\u2500 7\n\u2502   \u2514\u2500\u2500 37\n\u251c\u2500\u2500 c\n\u2502   \u2514\u2500\u2500 ab\n\u2514\u2500\u2500 d\n    \u251c\u2500\u2500 db\n    \u2502   \u2514\u2500\u2500 b27dfaf1bd886ffe7ea35c6913964dbd\n    \u2514\u2500\u2500 f1\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5982\u679c\u60f3\u8981\u5220\u9664\u7f13\u5b58\uff0c\u53ea\u9700\u5220\u9664\u5bf9\u5e94\u7684\u76ee\u5f55\u5373\u53ef\u3002")),(0,l.kt)("h2",{id:"713nginx-url-\u91cd\u5199"},"7.13\u3001nginx URL \u91cd\u5199"),(0,l.kt)("h3",{id:"7131\u7b80\u4ecb"},"7.13.1\u3001\u7b80\u4ecb"),(0,l.kt)("p",null,"url \u91cd\u5199\u7531 ngx","_","http","_","rewrite","_","module \u6a21\u5757\u63d0\u4f9b\uff0c\u9ed8\u8ba4\u4f1a\u5b89\u88c5\uff0c\u4f46\u8be5\u6a21\u5757\u529f\u80fd\u7684\u5b9e\u73b0\u9700\u8981 pcre\u3002URL \u91cd\u5199\u6280\u672f\u4e0d\u4ec5\u8981\u6c42\u638c\u63e1\u51e0\u4e2a\u6307\u4ee4\u7684\u8bed\u6cd5\u3001\u719f\u6089\u7b80\u5355\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u8fd8\u9700\u8981\u5c3d\u91cf\u719f\u6089 nginx \u7684\u5404\u4e2a\u53d8\u91cf\u7684\u610f\u4e49\uff0c\u719f\u6089\u7684\u53d8\u91cf\u8d8a\u591a\u8d8a\u597d\u3002"),(0,l.kt)("p",null,"\u5927\u591a\u6570\u9700\u8981\u7528\u5230\u7684\u53d8\u91cf\u90fd\u662f http","_","core \u6a21\u5757\u63d0\u4f9b\u7684\uff0c\u5b83\u4eec\u7684\u610f\u4e49\u53c2\u89c1\u5b98\u65b9\u624b\u518c ",(0,l.kt)("a",{parentName:"p",href:"http://nginx.org/en/docs/http/ngx_http_core_module.html#variables"},"http","_","core\u5185\u7f6e\u53d8\u91cf"),"\u3002"),(0,l.kt)("p",null,"rewrite \u6a21\u5757\u4e3b\u8981\u6709 break\u3001return\u3001set\u3001rewrite \u548c if \u8fd9 5 \u4e2a\u6307\u4ee4\u3002"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"break \u7684\u4f5c\u7528\u662f\u5b8c\u6210\u5f53\u524d\u7684\u4f5c\u7528\u96c6\uff0c\u4e0d\u518d\u6267\u884c rewrite \u6307\u4ee4")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"return \u8fd4\u56de\u72b6\u6001\u7801\u3002\u53ef\u7528\u7684\u72b6\u6001\u7801\u6709 204/301/302/303/307/308/400/402-406/408/410-411/413/416/500-504\u3002return \u4e09\u79cd\u8bed\u6cd5\uff1a"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"return code [text];\nreturn code URL;\nreturn URL;\n"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"set \u7528\u4e8e\u5b9a\u4e49\u53d8\u91cf\u3002\u8d4b\u7ed9\u53d8\u91cf\u7684\u503c\u53ef\u4ee5\u662f\u4e00\u4e2a\u53d8\u91cf\u3001\u6587\u672c\u53ca\u6587\u672c\u53d8\u91cf\u7684\u7ec4\u5408(\u8bed\u6cd5\uff1aset variable value;)")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"if \u7528\u4e8e\u8bbe\u5b9a\u5224\u65ad\u6761\u4ef6\u3002\u683c\u5f0f\u4e3a if (condition) {}")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"rewrite \u7528\u4e8e\u8bbe\u5b9a URL \u91cd\u5199\u89c4\u5219(\u8bed\u6cd5\uff1arewrite regex replacement ","[","flag","]",";)"))),(0,l.kt)("h3",{id:"7132if-\u6307\u4ee4"},"7.13.2\u3001if \u6307\u4ee4"),(0,l.kt)("p",null,'if \u4e0d\u652f\u6301\u5d4c\u5957\uff0c\u4e0d\u652f\u6301 "&&" \u548c "||" \u591a\u76ee\u8fd0\u7b97\u7b26\u3002\u8bed\u6cd5\u4e3a\uff1a'),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"if (condition) {}\n")),(0,l.kt)("p",null,"\u6d4b\u8bd5\u6761\u4ef6\u53ef\u4ee5\u5982\u4e0b\u5b9a\u4e49\uff1a"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u53d8\u91cf\u7684\u6bd4\u8f83\u53ef\u4ee5\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"li"},'"="')," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},'"!="')," \u8fd0\u7b97\u7b26\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u6b63\u5219\u5339\u914d\u53ef\u4ee5\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"li"},'"~"')," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},'"~*"'),"\uff0c\u524d\u8005\u8868\u793a\u533a\u5206\u5927\u5c0f\u5199\u7684\u6b63\u5219\u5339\u914d\uff0c\u540e\u8005\u8868\u793a\u4e0d\u533a\u5206\u5927\u5c0f\u5199\u7684\u5339\u914d\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u6b63\u5219\u5339\u914d\u53ef\u4ee5\u5728\u524d\u9762\u52a0\u4e0a\u611f\u53f9\u53f7 ",(0,l.kt)("inlineCode",{parentName:"li"},'"!~"')," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},'"!~*"')," \u8868\u793a\u53d6\u53cd\uff0c\u5373\u4e0d\u5339\u914d\u3002"),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("inlineCode",{parentName:"li"},'"-f"')," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},'"!-f"')," \u5224\u65ad\u6587\u4ef6\u662f\u5426\u5b58\u5728\u3002"),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("inlineCode",{parentName:"li"},'"-d"')," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},'"!-d"')," \u5224\u65ad\u76ee\u5f55\u662f\u5426\u5b58\u5728\u3002"),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("inlineCode",{parentName:"li"},'"-e"')," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},'"!-e"')," \u5224\u65ad\u6587\u4ef6\u6216\u76ee\u5f55\u6216\u8f6f\u94fe\u63a5\u662f\u5426\u5b58\u5728\u3002"),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("inlineCode",{parentName:"li"},'"-x"')," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},'"!-x"')," \u5224\u65ad\u6587\u4ef6\u662f\u5426\u53ef\u6267\u884c\u3002")),(0,l.kt)("p",null,"if \u652f\u6301\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u53ef\u4ee5\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"$1")," \u81f3 ",(0,l.kt)("inlineCode",{parentName:"p"},"$9")," \u6765\u5b9e\u73b0\u53cd\u5411\u5f15\u7528\u3002"),(0,l.kt)("p",null,"\u4ee5\u4e0b\u4e3a\u51e0\u4e2a\u793a\u4f8b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'# \u5f53\u4f7f\u7528IE\u6d4f\u89c8\u5668\u8bbf\u95ee\u65f6\uff0c\u91cd\u5b9a\u5411\u5230/msie/\u76ee\u5f55\u4e0b\u7684\u5bf9\u5e94\u6587\u4ef6\nif ($http_user_agent ~ MSIE) {\n    rewrite ^(.*)$ /msie/$1 break;\n}\n\n# \u5f53http\u8bf7\u6c42\u7684\u65b9\u6cd5\u4e3aPOST\uff0c\u5219\u76f4\u63a5\u8fd4\u56de405\u72b6\u6001\u7801\uff0c\u5373Method not Allowed\nif ($request_method = POST) {\n    return 405;\n}\n\n# \u5f53\u8bf7\u6c42\u7684\u8d44\u6e90\u6587\u4ef6\u4e0d\u5b58\u5728\uff0c\u5219\u76f4\u63a5\u9000\u51fa\u5f53\u524d\u5339\u914d\uff0c\u5e76\u4ee3\u7406\u81f3\u672c\u673a\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\u7531\u672c\u673a\u6765\u63d0\u4f9b\u670d\u52a1\uff0c\u5982\u63d0\u4f9b\u9519\u8bef\u9875\u9762\nif (!-f $request_filename) {\n    break;\n    proxy_pass http://127.0.0.1;\n}\n\n# \u5f53\u8bbf\u95ee\u7684\u662fbrinnatt.com\u4e0b\u4efb\u610f\u4e3b\u673a\uff0c\u5219\u91cd\u5b9a\u5411\u5230www.brinnatt.com\u4e3b\u673a\u4e0b\u7684\u5bf9\u5e94\u76ee\u5f55\nif ($http_host ~* "^(.*)\\.brinnatt\\.com$") {\n    set $domain $1;\n    rewrite ^(.*) https://www.brinnatt.com/$domain/ break;\n}\n')),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"\u4e0a\u9762\u6700\u540e\u4e00\u79cd ",(0,l.kt)("strong",{parentName:"p"},"URL \u91cd\u5199\u540e\u7684 URL \u4e3a\u4e00\u4e2a\u65b0\u7684\u4e3b\u673a\u540d\u7ad9\u70b9\uff0c\u4f46\u4f7f\u7528 URL \u91cd\u5199\u7684\u6548\u7387\u6bd4\u8f83\u4f4e\u4e0b\uff0c\u8fdc\u4e0d\u5982\u76f4\u63a5\u4e3a\u6b64\u7ad9\u70b9\u72ec\u7acb\u5b9a\u4e49\u4e00\u4e2a\u865a\u62df\u4e3b\u673a"),"\u3002\u6240\u4ee5\u6539\u5199\u4e3a\uff1a"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"server {\n  listen 80;\n  server_name .brinnatt.com;\n  return 302 https://www.brinnatt.com/$request_uri;\n}\n\nserver {\n  listen 80;\n  server_name www.brinnatt.com;\n}\n")))),(0,l.kt)("h3",{id:"7133rewrite-\u6307\u4ee4"},"7.13.3\u3001rewrite \u6307\u4ee4"),(0,l.kt)("p",null,"rewrite \u53ef\u4ee5\u5199\u5728 server \u6bb5\u3001location \u6bb5\u548c if \u6bb5\u3002\u8bed\u6cd5\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"rewrite regexp replacement [flag]\n")),(0,l.kt)("p",null,'\u5982\u679c replacement \u90e8\u5206\u4ee5 "http://" \u6216 "https://" \u6216 "$schema" \u5f00\u5934\uff0c\u5219\u76f4\u63a5\u4e34\u65f6\u91cd\u5b9a\u5411\uff0c\u89c1\u4e0b\u8868\u4e2d\u7684 redirect \u6807\u8bb0\u3002'),(0,l.kt)("p",null,"flag \u662f\u6807\u8bb0\u3002\u6709 4 \u79cd\u6807\u8bb0\uff0c\u5b83\u4eec\u7684\u4f5c\u7528\u5982\u4e0b\u8868\uff1a"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"flag"),(0,l.kt)("th",{parentName:"tr",align:null},"\u8bf4\u660e"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"last"),(0,l.kt)("td",{parentName:"tr",align:null},"\u505c\u6b62\u5904\u7406\u5f53\u524d\u4e0a\u4e0b\u6587\u4e2d\u7684\u5176\u4ed6\u91cd\u5199\u6a21\u5757\u6307\u4ee4\uff0c\u5e76\u4e3a\u91cd\u5199\u540e\u7684 uri \u518d\u6b21\u8fdb\u884c\u4e0a\u4e0b\u6587\u7684\u5339\u914d")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"break"),(0,l.kt)("td",{parentName:"tr",align:null},"\u548c last \u6307\u4ee4\u4e00\u6837\uff0c\u90fd\u662f\u505c\u6b62\u5904\u7406\u5f53\u524d\u4e0a\u4e0b\u6587\u4e2d\u7684\u5176\u4ed6\u91cd\u5199\u6a21\u5757\u6307\u4ee4")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"redirect"),(0,l.kt)("td",{parentName:"tr",align:null},'\u8fd4\u56de\u4e34\u65f6\u91cd\u5b9a\u5411\u72b6\u6001\u7801 302\u3002\u5f53 replacement \u90e8\u5206\u4e0d\u662f\u4ee5 "http://" \u6216\u8005 "https://" \u6216\u8005 ',(0,l.kt)("inlineCode",{parentName:"td"},'"$schema"')," \u5f00\u5934\u7684\u65f6\u5019\u4f7f\u7528\uff0c",(0,l.kt)("inlineCode",{parentName:"td"},'"$schema"')," \u53d8\u91cf\u8868\u793a\u4f7f\u7528\u7684\u662f\u4ec0\u4e48\u534f\u8bae")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"permanent"),(0,l.kt)("td",{parentName:"tr",align:null},"\u8fd4\u56de\u6c38\u4e45\u91cd\u5b9a\u5411\u72b6\u6001\u7801 301")))),(0,l.kt)("p",null,"\u4ee5\u4e0a flag \u4e2d\uff0c",(0,l.kt)("strong",{parentName:"p"},"last \u548c break \u7528\u6765\u5b9e\u73b0 URL \u6539\u5199\uff0c\u6b64\u65f6\u6d4f\u89c8\u5668\u4e2d\u7684\u5730\u5740\u4e0d\u4f1a\u6539\u53d8\uff0c\u4f46\u5b9e\u9645\u4e0a\u5728\u670d\u52a1\u5668\u4e0a\u8bbf\u95ee\u7684\u8d44\u6e90\u548c\u8def\u5f84\u5df2\u7ecf\u6539\u53d8\u4e86\u3002redirect \u548c permanent \u7528\u6765\u5b9e\u73b0 URL \u8df3\u8f6c\uff0c\u6d4f\u89c8\u5668\u4e2d\u7684\u5730\u5740\u4f1a\u6539\u53d8\u4e3a\u8df3\u8f6c\u540e\u7684\u5730\u5740"),"\u3002"),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"\u5728\u4f7f\u7528 proxy","_","pass \u6307\u4ee4\u65f6\u8981\u4f7f\u7528 break \u6807\u8bb0"),"\u3002last \u6807\u8bb0\u5728\u672c\u6761 rewrite \u89c4\u5219\u6267\u884c\u5b8c\u540e\uff0c\u7ee7\u7eed\u5728\u5f53\u524d\u4e0a\u4e0b\u6587\u5bf9\u91cd\u5199\u540e\u7684\u5730\u5740\u53d1\u8d77\u5339\u914d\u8bf7\u6c42\uff0c\u800c break \u5219\u5728\u672c\u6b21\u5339\u914d\u5b8c\u6210\u540e\u505c\u6b62\u518d\u6b21\u5339\u914d\u3002\u4f8b\u5982\u4e0b\u9762\u7684\u4e24\u6761\u91cd\u5199\u89c4\u5219\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'rewrite "^/bbs/(.*)/images/(.*)\\.jpg$" www.brinnatt.com/bbs/$2/images/$1.jpg last;\nrewrite "^/bbs/(.*)/images/(.*)\\.jpg$" www.brinnatt.com/bbs/$2/images/$1.jpg break;\n')),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5982\u679c\u8bbf\u95ee\u7684\u662f ",(0,l.kt)("a",{parentName:"li",href:"http://www.brinnatt.com/bbs/a/images/b.jpg"},"www.brinnatt.com/bbs/a/images/b.jpg")," \u5219\u91cd\u5199\u540e\u4e3a ",(0,l.kt)("a",{parentName:"li",href:"http://www.brinnatt.com/bbs/b/images/a.jpg%EF%BC%8C%E4%BD%86%E6%98%AF%E9%87%8D%E5%86%99%E5%90%8E%E7%9A%84%E5%9C%B0%E5%9D%80%E4%BB%8D%E7%84%B6%E5%8F%AF%E4%BB%A5%E5%8C%B9%E9%85%8D%E5%88%B0%E8%A7%84%E5%88%99"},"www.brinnatt.com/bbs/b/images/a.jpg\uff0c\u4f46\u662f\u91cd\u5199\u540e\u7684\u5730\u5740\u4ecd\u7136\u53ef\u4ee5\u5339\u914d\u5230\u89c4\u5219")," ",(0,l.kt)("inlineCode",{parentName:"li"},"^/bbs/(.*)/images/(.*)\\.jpg$"),"\uff0c\u6b64\u65f6\u5982\u679c\u4f7f\u7528 last \u6807\u8bb0\uff0c\u5219\u4f1a\u518d\u6b21\u8fdb\u884c\u91cd\u5199\uff0c\u6700\u7ec8\u5bfc\u81f4 URL \u91cd\u5199\u5faa\u73af\uff0cnginx \u9ed8\u8ba4\u652f\u6301 10 \u6b21\u5faa\u73af\uff0c\u7136\u540e\u8fd4\u56de 500 \u72b6\u6001\u7801\u3002\u800c\u5982\u679c\u4f7f\u7528 break \u6807\u8bb0\uff0c\u5219\u5728\u91cd\u5199\u5b8c\u6210\u540e\u4e0d\u4f1a\u518d\u6b21\u5339\u914d\u91cd\u5199\u3002")),(0,l.kt)("p",null,"\u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u91cd\u5199\u793a\u4f8b\u5c06\u4f1a\u4f7f\u5f97\u4efb\u610f\u4ee5 brinnatt.com \u7ed3\u5c3e\u7684\u8bbf\u95ee\u91cd\u5b9a\u5411\u5230 ",(0,l.kt)("a",{parentName:"p",href:"http://www.brinnatt.com%E3%80%82"},"www.brinnatt.com\u3002")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"server_name  www.brinnatt.com;\nrewrite (.*).brinnatt.com www.brinnatt.com permanent;\n")),(0,l.kt)("p",null,"\u4e0b\u9762\u7684\u91cd\u5199\u5b9e\u4f8b\u5c06\u4f7f\u5f97 ",(0,l.kt)("inlineCode",{parentName:"p"},"www.brinnatt.com/bbs/*")," \u7684\u8bbf\u95ee\u90fd\u91cd\u5b9a\u5411\u5230 ",(0,l.kt)("inlineCode",{parentName:"p"},"www.brinnatt.com/forum/*"),"\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'server {\n    listen 80;\n    server_name www.brinnatt.com;\n    location / {\n        root /www/brinnatt/;\n        index index.html;\n        rewrite "/bbs/(.*)" "/forum/$1" last;\n    }\n}\n')),(0,l.kt)("h3",{id:"7134url-\u91cd\u5199\u548c\u53cd\u5411\u4ee3\u7406\u7684\u533a\u522b"},"7.13.4\u3001URL \u91cd\u5199\u548c\u53cd\u5411\u4ee3\u7406\u7684\u533a\u522b"),(0,l.kt)("p",null,"URL \u91cd\u5199\u548c\u53cd\u5411\u4ee3\u7406\u90fd\u80fd\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u5176\u4ed6\u4e3b\u673a\u4e0a\u3002\u4f46\u5b83\u4eec\u6709\u5f88\u5927\u7684\u533a\u522b\u3002"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"URL \u91cd\u5199\u53ef\u4ee5\u5b9e\u73b0\u4e00\u4e9b\u53cd\u5411\u4ee3\u7406\u4e0d\u80fd\u5b9e\u73b0\u7684\u8f6c\u53d1\u3002"),(0,l.kt)("li",{parentName:"ol"},"URL \u91cd\u5199\u53ef\u4ee5\u5b9e\u73b0\u6d4f\u89c8\u5668\u5730\u5740\u6539\u53d8\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u53cd\u5411\u4ee3\u7406\u66f4\u591a\u7684\u914d\u5408 upstream \u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u3002URL \u91cd\u5199\u65e0\u6cd5\u76f4\u63a5\u901a\u8fc7\u8f6c\u53d1\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u3002")))}g.isMDXComponent=!0},10591:function(e,n,t){n.Z=t.p+"assets/images/http forward direction-936cc21452de5fe344fdf7f0370f2242.png"},66201:function(e,n,t){n.Z=t.p+"assets/images/http reverse direction-95b2369e91406ad54760db3ee39fc25c.png"},67717:function(e,n,t){n.Z=t.p+"assets/images/nginx cache hit-88e49ff99e74b7a8c55cfc9fd1f685b3.png"},87839:function(e,n,t){n.Z=t.p+"assets/images/nginx cache-da3b36f038b15cf11ddd60784ee2e6ad.png"},3301:function(e,n,t){n.Z=t.p+"assets/images/nginx php-fpm page-7735fe5984ae8dcc3f8d32b10a1421c1.png"},94470:function(e,n,t){n.Z=t.p+"assets/images/nginx upstream-40ab8ee0b4ad1441adfd5acb0e5e716e.png"},4388:function(e,n,t){n.Z=t.p+"assets/images/simple nginx proxy-43b50391223204d80770530aa255e0ca.png"},57305:function(e,n,t){n.Z=t.p+"assets/images/simple nginx proxy1-1052682218712e02a33772ad619a3599.png"}}]);